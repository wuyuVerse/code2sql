# Code2SQL å†—ä½™å’Œæ–°å¢SQLå®Œæ•´ä¿®å¤æµç¨‹æ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

æœ¬æ–¹æ¡ˆæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„å†—ä½™å’Œæ–°å¢SQLä¿®å¤æµç¨‹ï¼ŒåŒ…æ‹¬æ£€æµ‹ã€éªŒè¯ã€ä¿®å¤ä¸‰ä¸ªé˜¶æ®µï¼Œèƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«å¹¶å¤„ç†ä»¥ä¸‹ä¸‰ç§ç±»å‹çš„SQLé—®é¢˜ï¼š

1. **å†—ä½™SQL**ï¼šç¡®è®¤å†—ä½™ååˆ é™¤
2. **é”™è¯¯æ–°å¢SQL**ï¼šæ— å­˜åœ¨å¿…è¦çš„æ–°å¢SQLï¼ŒéªŒè¯ååˆ é™¤
3. **ç¼ºå¤±SQL**ï¼šå¿…è¦ä½†ç¼ºå¤±çš„SQLï¼ŒéªŒè¯åæ·»åŠ 

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### é˜¶æ®µ1ï¼šæ£€æµ‹ä¸åˆ†æ
```
åŸå§‹æ•°æ®é›† â†’ ORMæŒ‡çº¹åˆ†æå™¨ â†’ å€™é€‰é¡¹ç”Ÿæˆ â†’ LLMéªŒè¯é˜Ÿåˆ—
                    â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   ä¸‰ç±»å€™é€‰é¡¹ç”Ÿæˆ   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å†—ä½™å€™é€‰é¡¹  â”‚ æ–°å¢æŒ‡çº¹å€™é€‰é¡¹â”‚  ç¼ºå¤±å€™é€‰é¡¹  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é˜¶æ®µ2ï¼šLLMéªŒè¯å†³ç­–
```
å€™é€‰é¡¹ â†’ åˆ†æ­¥éª¤LLMéªŒè¯ â†’ ä¿®å¤å»ºè®®ç”Ÿæˆ
```

| éªŒè¯ç±»å‹ | éªŒè¯ç›®æ ‡ | å†³ç­–é€»è¾‘ | è¾“å‡ºå†³ç­– |
|---------|---------|---------|---------|
| **å†—ä½™éªŒè¯** | æ˜¯å¦ç¡®å®å†—ä½™ï¼Ÿ | 60%ä»¥ä¸Šç¡®è®¤å†—ä½™ â†’ remove | `remove` / `keep` |
| **æ–°å¢éªŒè¯** | æ–°å¢æ˜¯å¦åˆç†ï¼Ÿ | 60%ä»¥ä¸Šç¡®è®¤åˆç† â†’ keep | `keep` / `remove` |
| **ç¼ºå¤±éªŒè¯** | ç¼ºå¤±æ˜¯å¦å¿…è¦ï¼Ÿ | 60%ä»¥ä¸Šç¡®è®¤å¿…è¦ â†’ add | `add` / `keep` |

### é˜¶æ®µ3ï¼šä¿®å¤åº”ç”¨
```
ä¿®å¤å»ºè®® â†’ æ•°æ®é›†ä¿®æ”¹ â†’ ç»Ÿè®¡è®°å½• â†’ å®Œæˆ
```

## ğŸ› ï¸ æŠ€æœ¯å®ç°è¯¦æƒ…

### 1. å€™é€‰é¡¹æ£€æµ‹ç®—æ³•

#### å‚è€ƒé›†åˆé€‰æ‹©ç­–ç•¥
```python
def _select_reference_set(orm_code, callers_data):
    """é€‰æ‹©æŒ‡çº¹æœ€å®Œæ•´çš„callerä½œä¸ºå‚è€ƒé›†åˆ"""
    # ä¼˜å…ˆçº§ï¼šæŒ‡çº¹æ•°é‡ > SQLè¦†ç›–åº¦
    best_caller = max(callers_data.keys(), key=lambda c: (
        len(caller_fingerprints[c]),      # æŒ‡çº¹æ•°é‡
        len(caller_sql_records[c])        # SQLè®°å½•æ•°é‡
    ))
    return best_caller
```

#### å€™é€‰é¡¹åˆ†ç±»é€»è¾‘
```python
# å†—ä½™æ£€æµ‹ï¼šcaller âŠ† reference
if caller_fingerprints.issubset(reference_fingerprints):
    generate_redundant_candidate()

# æ–°å¢æ£€æµ‹ï¼šcaller - reference â‰  âˆ…  
extra_fingerprints = caller_fingerprints - reference_fingerprints
if extra_fingerprints:
    generate_new_fingerprint_candidate()

# ç¼ºå¤±æ£€æµ‹ï¼šreference - caller â‰  âˆ…
missing_fingerprints = reference_fingerprints - caller_fingerprints  
if missing_fingerprints:
    generate_missing_candidate()
```

### 2. LLMéªŒè¯æµç¨‹

#### éªŒè¯æç¤ºè¯ä½“ç³»
1. **å†—ä½™éªŒè¯æç¤ºè¯**
   - è¾“å…¥ï¼šORMä»£ç  + ç›®æ ‡SQL + callerä¿¡æ¯
   - åˆ¤æ–­ï¼šè¯¥SQLåœ¨å½“å‰ä¸šåŠ¡åœºæ™¯ä¸‹æ˜¯å¦ç¡®å®å†—ä½™
   - è¾“å‡ºï¼š`æ˜¯ï¼Œå†—ä½™` / `å¦ï¼Œå¿…è¦`

2. **æ–°å¢éªŒè¯æç¤ºè¯**
   - è¾“å…¥ï¼šORMä»£ç  + æ–°å¢SQL + callerä¿¡æ¯
   - åˆ¤æ–­ï¼šè¯¥æ–°å¢SQLæ˜¯å¦æœ‰åˆç†çš„ä¸šåŠ¡éœ€æ±‚
   - è¾“å‡ºï¼š`åˆç†æ–°å¢` / `é”™è¯¯æ–°å¢`

3. **ç¼ºå¤±éªŒè¯æç¤ºè¯**
   - è¾“å…¥ï¼šORMä»£ç  + ç¼ºå¤±SQLç¤ºä¾‹ + callerä¿¡æ¯
   - åˆ¤æ–­ï¼šè¯¥calleræ˜¯å¦ç¡®å®éœ€è¦è¿™äº›ç¼ºå¤±çš„SQL
   - è¾“å‡ºï¼š`ç¡®å®ç¼ºå¤±` / `ä¸éœ€è¦`

#### å¹¶å‘éªŒè¯æœºåˆ¶
```python
async def validate_llm_candidates(candidates, max_concurrent=50):
    """é«˜å¹¶å‘LLMéªŒè¯"""
    semaphore = asyncio.Semaphore(max_concurrent)
    
    async def validate_with_semaphore(candidate):
        async with semaphore:
            return await _validate_single_candidate(candidate)
    
    tasks = [validate_with_semaphore(c) for c in candidates]
    return await asyncio.gather(*tasks, return_exceptions=True)
```

### 3. ä¿®å¤åº”ç”¨ç®—æ³•

#### ä¿®å¤æ˜ å°„æ„å»º
```python
# åˆ é™¤æ˜ å°„ï¼š(orm_code, caller) â†’ {sql_texts_to_remove}
remove_redundant_map = build_remove_map('remove_redundant')
remove_wrong_new_map = build_remove_map('remove_wrong_new')

# æ·»åŠ æ˜ å°„ï¼š(orm_code, caller) â†’ [sql_texts_to_add]
add_missing_map = build_add_map('add_missing')
```

#### SQLå¤„ç†é€»è¾‘
```python
def _process_sql_list(sql_list, key):
    """å¤„ç†SQLåˆ—è¡¨ï¼šåˆ é™¤æŒ‡å®šSQLï¼Œæ·»åŠ ç¼ºå¤±SQL"""
    remove_set = all_remove_map.get(key, set())
    add_list = add_missing_map.get(key, [])
    
    if isinstance(sql_list, str):
        # å•ä¸ªSQLå­—ç¬¦ä¸²å¤„ç†
        return handle_single_sql(sql_list, remove_set, add_list)
    elif isinstance(sql_list, list):
        # SQLåˆ—è¡¨å¤„ç†
        return handle_sql_list(sql_list, remove_set, add_list)
    elif isinstance(sql_list, dict) and sql_list.get("type") == "param_dependent":
        # param_dependentå¤„ç†
        return handle_param_dependent(sql_list, remove_set)
```

#### å¤æ‚SQLç»“æ„å¤„ç†
```python
def _process_param_dependent_sql(param_dependent_item, remove_set):
    """å¤„ç†param_dependentç±»å‹çš„SQLé¡¹"""
    cleaned_variants = []
    
    for variant in param_dependent_item.get("variants", []):
        if should_keep_variant(variant, remove_set):
            cleaned_variants.append(variant)
    
    return {"variants": cleaned_variants} if cleaned_variants else None
```

## ğŸ“Š ä¿®å¤ç­–ç•¥çŸ©é˜µ

### ä¸åŒSQLç±»å‹çš„å¤„ç†ç­–ç•¥

| SQLç±»å‹ | å†—ä½™å¤„ç† | æ–°å¢å¤„ç† | ç¼ºå¤±å¤„ç† |
|---------|---------|---------|---------|
| **å•ä¸ªå­—ç¬¦ä¸²** | åˆ é™¤â†’`<NO SQL GENERATE>` | åˆ é™¤â†’`<NO SQL GENERATE>` | æ·»åŠ åˆ°åˆ—è¡¨ |
| **ç®€å•åˆ—è¡¨** | ä»åˆ—è¡¨ä¸­åˆ é™¤ | ä»åˆ—è¡¨ä¸­åˆ é™¤ | æ·»åŠ åˆ°åˆ—è¡¨æœ«å°¾ |
| **param_dependent** | åˆ é™¤å¯¹åº”å˜ä½“ | åˆ é™¤å¯¹åº”å˜ä½“ | æ·»åŠ æ–°å˜ä½“ |
| **åµŒå¥—åˆ—è¡¨** | é€’å½’å¤„ç†æ¯ä¸ªå…ƒç´  | é€’å½’å¤„ç†æ¯ä¸ªå…ƒç´  | æ·»åŠ åˆ°é¡¶å±‚åˆ—è¡¨ |

### è¾¹ç•Œæƒ…å†µå¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ | ç»“æœ |
|------|---------|------|
| **æ‰€æœ‰SQLéƒ½è¢«åˆ é™¤** | è®¾ç½®ä¸º `<NO SQL GENERATE>` | ä¿ç•™è®°å½•ç»“æ„ |
| **åˆ é™¤åæ·»åŠ æ–°SQL** | å…ˆåˆ é™¤ï¼Œå†æ·»åŠ  | æ–°æ—§SQLå…±å­˜ |
| **param_dependentæ‰€æœ‰å˜ä½“åˆ é™¤** | åˆ é™¤æ•´ä¸ªå¯¹è±¡ | ä»åˆ—è¡¨ä¸­ç§»é™¤ |
| **åŸæœ¬å°±æ˜¯ç©ºSQL** | åªæ‰§è¡Œæ·»åŠ æ“ä½œ | å¡«å……ç¼ºå¤±å†…å®¹ |

## ğŸ¯ è´¨é‡ä¿è¯æœºåˆ¶

### 1. éªŒè¯ç½®ä¿¡åº¦æ§åˆ¶
- **60%é˜ˆå€¼è§„åˆ™**ï¼šéœ€è¦60%ä»¥ä¸Šçš„SQLé€šè¿‡éªŒè¯æ‰æ‰§è¡Œæ‰¹é‡æ“ä½œ
- **ä¿å®ˆåˆ é™¤ç­–ç•¥**ï¼šä¸ç¡®å®šæ—¶ä¼˜å…ˆä¿ç•™ï¼Œé¿å…è¯¯åˆ 
- **é”™è¯¯æ¢å¤æœºåˆ¶**ï¼šLLMéªŒè¯å¼‚å¸¸æ—¶ä¿å®ˆå¤„ç†

### 2. ä¿®å¤ç»Ÿè®¡è®°å½•
```python
ä¿®å¤ç»Ÿè®¡ï¼š
  - åˆ é™¤å†—ä½™SQL: 245 ä¸ª
  - åˆ é™¤é”™è¯¯æ–°å¢SQL: 67 ä¸ª  
  - æ·»åŠ ç¼ºå¤±SQL: 123 ä¸ª
  - ä¿®æ”¹è®°å½•æ•°: 89
```

### 3. å¯è¿½æº¯æ€§ä¿è¯
- **ä¿®å¤å‰åå¯¹æ¯”**ï¼šä¿å­˜ä¿®å¤å‰åçš„æ•°æ®å¿«ç…§
- **ä¿®å¤æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†è®°å½•æ¯ä¸ªä¿®å¤å†³ç­–çš„ä¾æ®
- **å›æ»šæ”¯æŒ**ï¼šæ”¯æŒåŸºäºä¿®å¤å»ºè®®çš„å›æ»šæ“ä½œ

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨æµç¨‹
```python
# 1. åŠ è½½æ•°æ®å¹¶æ¸…æ´—
workflow = WorkflowManager()
workflow.load_raw_dataset("datasets/claude_output")
cleaning_result = workflow.run_sql_cleaning("sql_cleaning_with_orm_analysis")

# 2. è¿è¡ŒéªŒè¯å¹¶åº”ç”¨ä¿®å¤
validation_result = await workflow.run_redundant_sql_validation(
    apply_fix=True,  # åº”ç”¨ä¿®å¤
    step_name="redundant_sql_validation"
)

# 3. æŸ¥çœ‹ä¿®å¤ç»Ÿè®¡
print(f"ä¿®å¤ç»Ÿè®¡ï¼š{validation_result['fix_recommendations_summary']}")
```

### é«˜çº§é…ç½®é€‰é¡¹
```python
# è‡ªå®šä¹‰å¹¶å‘æ•°å’ŒéªŒè¯é™åˆ¶
validator = RedundantSQLValidator(
    output_dir="custom_output",
    llm_server="v3"
)

validation_result = await validator.validate_llm_candidates(
    llm_candidates,
    max_concurrent=100  # è‡ªå®šä¹‰å¹¶å‘æ•°
)
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶å‘å¤„ç†ä¼˜åŒ–
- **å¼‚æ­¥LLMè°ƒç”¨**ï¼šæ”¯æŒæœ€å¤š100ä¸ªå¹¶å‘è¯·æ±‚
- **æ‰¹é‡å¤„ç†**ï¼šæ¯ç§ç±»å‹å€™é€‰é¡¹é™åˆ¶50ä¸ªï¼Œé¿å…è¿‡è½½
- **è¿›åº¦æ˜¾ç¤º**ï¼šå®æ—¶æ˜¾ç¤ºéªŒè¯è¿›åº¦

### 2. å†…å­˜ä¼˜åŒ–
- **æµå¼å¤„ç†**ï¼šå¤§æ–‡ä»¶åˆ†æ‰¹åŠ è½½å’Œå¤„ç†
- **ç¼“å­˜æœºåˆ¶**ï¼šSQLæŒ‡çº¹è®¡ç®—ç»“æœç¼“å­˜
- **åŠæ—¶æ¸…ç†**ï¼šå¤„ç†å®Œæˆåé‡Šæ”¾ä¸´æ—¶æ•°æ®

### 3. å‡†ç¡®æ€§ä¼˜åŒ–
- **ä¸Šä¸‹æ–‡é™åˆ¶**ï¼šORMä»£ç æˆªå–å‰2000å­—ç¬¦ï¼Œé¿å…tokenè¶…é™
- **é‡è¯•æœºåˆ¶**ï¼šLLMè°ƒç”¨å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
- **ç½®ä¿¡åº¦è°ƒæ•´**ï¼šæ ¹æ®å®é™…æ•ˆæœè°ƒæ•´60%é˜ˆå€¼

## ğŸ”§ æ‰©å±•æ¥å£

### è‡ªå®šä¹‰éªŒè¯å™¨
```python
class CustomSQLValidator(RedundantSQLValidator):
    async def _validate_custom_candidate(self, candidate):
        """è‡ªå®šä¹‰éªŒè¯é€»è¾‘"""
        # å®ç°ç‰¹å®šä¸šåŠ¡çš„éªŒè¯è§„åˆ™
        pass
```

### è‡ªå®šä¹‰ä¿®å¤ç­–ç•¥
```python
def custom_fix_strategy(sql_list, remove_set, add_list):
    """è‡ªå®šä¹‰ä¿®å¤ç­–ç•¥"""
    # å®ç°ç‰¹å®šçš„SQLä¿®å¤é€»è¾‘
    return modified_sql_list
```

## ğŸ“ æ€»ç»“

æœ¬æ–¹æ¡ˆæä¾›äº†ä¸€ä¸ªå®Œæ•´ã€å¯é ã€é«˜æ€§èƒ½çš„å†—ä½™å’Œæ–°å¢SQLä¿®å¤ç³»ç»Ÿï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### âœ… æ ¸å¿ƒä¼˜åŠ¿
1. **ä¸šåŠ¡è¯­ä¹‰é©±åŠ¨**ï¼šåŸºäºORMä»£ç ä¸Šä¸‹æ–‡çš„æ™ºèƒ½åˆ¤æ–­
2. **ä¸‰ç»´ä¿®å¤èƒ½åŠ›**ï¼šå†—ä½™åˆ é™¤ + é”™è¯¯æ–°å¢åˆ é™¤ + ç¼ºå¤±æ·»åŠ 
3. **é«˜å¹¶å‘å¤„ç†**ï¼šæ”¯æŒå¤§è§„æ¨¡æ•°æ®çš„å¿«é€ŸéªŒè¯
4. **ä¿å®ˆå®‰å…¨ç­–ç•¥**ï¼šä¸ç¡®å®šæ—¶ä¼˜å…ˆä¿ç•™ï¼Œé¿å…æ•°æ®æŸå¤±
5. **å®Œæ•´å¯è¿½æº¯**ï¼šè¯¦ç»†çš„ä¿®å¤è®°å½•å’Œç»Ÿè®¡ä¿¡æ¯

### ğŸ¯ é€‚ç”¨åœºæ™¯
- **å¤§è§„æ¨¡ä»£ç è¿ç§»**ï¼šè‡ªåŠ¨æ¸…ç†å†—ä½™å’Œé”™è¯¯çš„SQL
- **ä»£ç è´¨é‡ä¼˜åŒ–**ï¼šæå‡SQLä½¿ç”¨çš„ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§
- **æ•°æ®é›†æ¸…æ´—**ï¼šä¸ºæœºå™¨å­¦ä¹ å‡†å¤‡é«˜è´¨é‡çš„è®­ç»ƒæ•°æ®
- **ä»£ç é‡æ„æ”¯æŒ**ï¼šè¾…åŠ©è¯†åˆ«å’Œä¿®å¤SQLä½¿ç”¨é—®é¢˜

### ğŸ”® æœªæ¥æ‰©å±•
- **è§„åˆ™å¼•æ“é›†æˆ**ï¼šæ”¯æŒåŸºäºè§„åˆ™çš„è‡ªåŠ¨ä¿®å¤
- **æœºå™¨å­¦ä¹ ä¼˜åŒ–**ï¼šåŸºäºå†å²ä¿®å¤ç»“æœä¼˜åŒ–å†³ç­–ç®—æ³•  
- **å¯è§†åŒ–ç•Œé¢**ï¼šæä¾›å‹å¥½çš„ä¿®å¤è¿‡ç¨‹å¯è§†åŒ–
- **æ‰¹é‡æ“ä½œæ”¯æŒ**ï¼šæ”¯æŒå¤§è§„æ¨¡æ•°æ®é›†çš„åˆ†å¸ƒå¼å¤„ç† 