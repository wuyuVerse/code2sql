# 配置重试机制修复

## 问题描述

用户反馈配置文件中设置的重试次数为10，但实际运行时仍使用3次重试，导致格式验证重试次数不符合预期。

## 问题分析

### 1. 初步排查
- 配置文件`config/data_processing/workflow/workflow_config.yaml`中确实设置了`max_retries: 10`
- YAML文件能正确解析，`format_validation.max_retries`确实是10
- 但`WorkflowConfigManager`加载后`max_retries`仍然是3

### 2. 深入调试
通过逐步调试发现：
- `FormatValidationConfig`类本身能正确初始化，`max_retries`确实是10
- `WorkflowConfig`创建后，`format_validation.max_retries`也是10
- 问题在于`WorkflowConfigManager`的配置文件路径计算错误

### 3. 根本原因
**配置文件路径错误**：
- 系统在寻找：`/home/wuyu/code2sql/config/config/data_processing/workflow/workflow_config.yaml`
- 实际文件位置：`/home/wuyu/code2sql/config/data_processing/workflow/workflow_config.yaml`
- 路径中多了一个`config/`，导致文件未找到，使用默认配置

## 解决方案

### 1. 修复路径计算
**文件：`config/data_processing/workflow/workflow_config.py`**

**问题代码：**
```python
current_dir = Path(__file__).parent.parent.parent  # 错误：得到 /home/wuyu/code2sql/config
```

**修复代码：**
```python
current_dir = Path(__file__).parent.parent.parent.parent  # 正确：得到 /home/wuyu/code2sql
```

### 2. 优化配置加载
**文件：`config/data_processing/workflow/workflow_config.py`**

**改进：**
- 去掉`FormatValidationConfig`的默认值，强制必须从配置文件读取
- 使用`dict()`强制转换YAML对象为普通dict
- 分离`modules`字段处理，避免Pydantic嵌套类型问题

**修改前：**
```python
class FormatValidationConfig(BaseModel):
    max_retries: int = 3  # 默认值会覆盖配置文件
    retry_delay: float = 1.0
    enabled: bool = True
```

**修改后：**
```python
class FormatValidationConfig(BaseModel):
    max_retries: int  # 强制必须传入
    retry_delay: float
    enabled: bool
    modules: Dict[str, dict] = {}
```

## 修复结果

### 1. 配置加载验证
```bash
$ python test_cache_issue.py
1. 第一次获取配置:
   format_validation.max_retries: 10

2. 强制重新加载配置:
   format_validation.max_retries: 10

3. 再次获取配置:
   format_validation.max_retries: 10
```

### 2. 实际效果
- ✅ 配置文件中的`max_retries: 10`现在能正确读取
- ✅ 所有LLM调用都会使用10次重试，而不是默认的3次
- ✅ 格式验证重试机制按预期工作
- ✅ 配置集中管理，避免硬编码

## 技术细节

### 1. 路径计算逻辑
```python
# 当前文件位置：config/data_processing/workflow/workflow_config.py
# Path(__file__).parent.parent.parent.parent 解析过程：
# 1. __file__ = /home/wuyu/code2sql/config/data_processing/workflow/workflow_config.py
# 2. .parent = /home/wuyu/code2sql/config/data_processing/workflow
# 3. .parent = /home/wuyu/code2sql/config/data_processing
# 4. .parent = /home/wuyu/code2sql/config
# 5. .parent = /home/wuyu/code2sql  # 项目根目录
```

### 2. 配置加载流程
```python
# 1. 读取YAML文件
config_data = yaml.safe_load(f)

# 2. 提取格式验证配置
format_validation_settings = dict(workflow_settings.get('format_validation', {}))

# 3. 分离modules字段
modules = format_validation_settings.pop('modules', {})

# 4. 创建FormatValidationConfig
format_validation_config = FormatValidationConfig(**format_validation_settings)

# 5. 设置modules
format_validation_config.modules = modules
```

### 3. 重试机制集成
```python
# 在call_async_with_format_validation中
if max_retries is None:
    max_retries = format_config.get('max_retries', 3)  # 现在会读取到10
```

## 总结

✅ **问题解决**：配置文件路径错误导致使用默认配置，现已修复

✅ **配置生效**：`max_retries: 10`现在能正确读取和使用

✅ **重试机制**：所有LLM调用都会使用10次重试，符合用户预期

✅ **代码质量**：去掉默认值，强制配置文件完整性，提高代码健壮性

## 注意事项

1. **配置文件完整性**：现在配置文件必须包含所有必需字段，否则会报错
2. **路径依赖**：配置文件路径计算依赖于项目结构，如果项目结构调整需要相应修改
3. **向后兼容**：异常处理中仍提供默认值，确保在配置文件缺失时系统能正常运行

## 后续建议

1. 监控重试成功率，根据实际情况调整重试次数
2. 考虑添加配置验证，确保配置文件格式正确
3. 定期检查配置文件路径，确保项目结构调整后路径仍然正确 