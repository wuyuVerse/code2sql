# 动态SQL变体数量设计总结

## 设计目标
根据不同的场景和复杂度，动态生成不同数量的SQL变体，避免固定数量导致的资源浪费或不足。

## 11种场景与提示词模板对应关系

### 1. if-else+caller
- **场景描述**: Caller代码中包含if-else条件判断，根据不同的条件构建不同的filter参数传递给ORM方法
- **SQL变体提示词**: `if_else_variants`
- **Caller提示词**: `if_else_caller`
- **变体数量范围**: 3-8个

### 2. if-else+orm
- **场景描述**: ORM方法内部包含if-else条件判断，根据不同的分支使用不同的筛选条件构建SQL查询
- **SQL变体提示词**: `if_else_orm_variants`
- **Caller提示词**: `if_else_caller` (复用)
- **变体数量范围**: 4-10个

### 3. switch
- **场景描述**: ORM方法使用switch条件语句来根据不同的参数值或状态构建不同的SQL查询条件
- **SQL变体提示词**: `switch_variants`
- **Caller提示词**: `switch_caller`
- **变体数量范围**: 5-12个

### 4. dynamic_query
- **场景描述**: 处理动态传入的多个条件，生成多条条件结合的SQL查询
- **SQL变体提示词**: `dynamic_variants`
- **Caller提示词**: `dynamic_caller`
- **变体数量范围**: 6-15个

### 5. fixed_params
- **场景描述**: 固定条件查询，不需要条件判断，直接生成对应的SQL查询
- **SQL变体提示词**: `fixed_params_variants`
- **Caller提示词**: `fixed_params_caller`
- **变体数量范围**: 3-6个

### 6. complex_control
- **场景描述**: 复杂控制流，包含多层嵌套的if-else或switch结构
- **SQL变体提示词**: `complex_control_variants`
- **Caller提示词**: `complex_control_caller`
- **变体数量范围**: 8-20个

### 7. if-else+switch_mixed
- **场景描述**: ORM方法同时使用if-else和switch-case混合控制流，根据多个条件参数选择不同的数据库操作策略
- **SQL变体提示词**: `if_else_switch_mixed_variants`
- **Caller提示词**: `if_else_switch_mixed_caller`
- **变体数量范围**: 6-15个

### 8. conditional_chain
- **场景描述**: ORM方法通过连续的if-else条件判断逐步构建查询条件，每个条件都可能影响最终的SQL语句
- **SQL变体提示词**: `conditional_chain_variants`
- **Caller提示词**: `conditional_chain_caller`
- **变体数量范围**: 4-10个

### 9. multi_branch_transaction
- **场景描述**: ORM方法使用复杂的条件分支控制事务处理流程，不同分支执行不同的数据库操作组合
- **SQL变体提示词**: `multi_branch_transaction_variants`
- **Caller提示词**: `multi_branch_transaction_caller`
- **变体数量范围**: 8-18个

### 10. state_machine_branch
- **场景描述**: ORM方法基于对象状态使用switch-case实现状态机逻辑，每个状态对应特定的数据库操作序列
- **SQL变体提示词**: `state_machine_branch_variants`
- **Caller提示词**: `state_machine_branch_caller`
- **变体数量范围**: 6-14个

### 11. conditional_meta
- **场景描述**: ORM方法使用if-else条件分支的同时依赖元数据配置，根据配置和条件双重判断执行不同操作
- **SQL变体提示词**: `conditional_meta_variants`
- **Caller提示词**: `conditional_meta_caller`
- **变体数量范围**: 5-12个

## 复杂度级别配置

### simple (简单)
- **描述**: 简单查询，基本SELECT、WHERE、ORDER BY
- **变体数量范围**: 3-6个
- **适用场景**: fixed_params

### medium (中等)
- **描述**: 中等复杂度，包含JOIN、GROUP BY、HAVING等
- **变体数量范围**: 5-10个
- **适用场景**: if-else+caller, if-else+orm, switch, dynamic_query, conditional_chain, conditional_meta

### complex (复杂)
- **描述**: 复杂查询，包含子查询、窗口函数、复杂条件组合
- **变体数量范围**: 8-15个
- **适用场景**: complex_control, if-else+switch_mixed, multi_branch_transaction, state_machine_branch

## 动态数量计算逻辑

```python
def get_sql_variants_count(self, scenario: str, complexity: str) -> int:
    """获取指定场景和复杂度的SQL变体数量"""
    # 获取场景配置
    scenario_config = SCENARIO_SQL_VARIANTS.get(scenario, {"min": 3, "max": 8})
    complexity_config = COMPLEXITY_LEVELS.get(complexity, {"sql_variants": {"min": 3, "max": 6}})
    
    # 结合场景和复杂度的配置
    min_count = max(scenario_config["min"], complexity_config["sql_variants"]["min"])
    max_count = min(scenario_config["max"], complexity_config["sql_variants"]["max"])
    
    # 生成随机数量
    return random.randint(min_count, max_count)
```

## 逻辑复用说明

1. **Caller提示词复用**: `if-else+caller` 和 `if-else+orm` 都使用 `if_else_caller` 提示词，因为它们的Caller逻辑相似
2. **SQL变体提示词独立**: 每个场景都有独立的SQL变体提示词，确保生成的SQL变体符合场景特点
3. **场景判断精确化**: 使用精确的场景名称匹配，避免 `in` 操作符导致的误匹配

## 修复的问题

1. **场景判断逻辑**: 从 `"if-else" in scenario` 改为 `scenario == "if-else+caller"`
2. **控制流处理器**: 添加了所有11种场景的处理分支
3. **提示词模板**: 确保所有场景都有对应的提示词模板
4. **动态数量**: 根据场景和复杂度动态计算变体数量

## 测试验证

创建了 `test_dynamic_variants.py` 测试脚本，用于验证：
- 不同场景和复杂度的变体数量范围
- 实际生成过程的正确性
- 配置的有效性 