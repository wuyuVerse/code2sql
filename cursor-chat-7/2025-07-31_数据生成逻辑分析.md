# 2025-07-31 数据生成逻辑分析

## 对话概述

用户要求查看 `synthetic_data_generator` 模块的数据生成逻辑，我进行了全面的代码分析和架构梳理。

## 任务范围明确

### 分析目标
1. 核心生成器逻辑 (`generator.py`)
2. SQL生成相关逻辑 (`get_sql.py`)  
3. 配置和提示词管理 (`config.py`, `prompts.py`)
4. 整体工作流程和CLI接口

### 涉及文件
- `data_processing/synthetic_data_generator/generator.py` - 核心生成逻辑
- `data_processing/synthetic_data_generator/get_sql.py` - SQL生成和验证
- `config/data_processing/synthetic_data_generator/config.py` - 配置管理
- `config/data_processing/synthetic_data_generator/prompts.py` - 提示词模板
- `data_processing/synthetic_data_generator/cli.py` - 命令行接口
- `data_processing/synthetic_data_generator/example_usage.py` - 使用示例

## 核心架构分析

### 1. 数据生成器核心逻辑 (`generator.py`)

#### 主要类：`SyntheticDataGenerator`
- **初始化**：加载配置、LLM客户端、参考样例
- **核心方法**：
  - `generate_pack()` - 生成单个数据包（串行）
  - `generate_pack_parallel()` - 并行生成单个包
  - `generate_multiple_packs_parallel()` - 批量并行生成

#### 生成流程
1. **ORM代码生成**：根据场景选择专用提示词模板
2. **调用者代码生成**：为ORM方法生成调用者代码
3. **元数据生成**：生成相关的结构体定义等元数据
4. **数据验证**：验证生成数据的格式正确性

#### 场景支持
支持20种不同的ORM场景模式，包括：
- `对象var+chunk` - 依赖对象成员变量
- `caller+global variable` - 依赖外部全局变量
- `caller+chunk` - 需要调用者参数
- `mutual_exclusive_conditions` - 互斥条件处理
- `table_name_from_caller` - 表名从调用者传递
- 等等...

### 2. SQL生成逻辑 (`get_sql.py`)

#### 核心功能
- **SQL分析**：分析ORM代码生成对应的SQL语句
- **SQL验证**：验证生成的SQL正确性和完整性
- **SQL格式化**：标准化SQL输出格式
- **互斥条件处理**：特殊场景的SQL变体生成

#### 关键函数
- `analyze_mutual_exclusive_sql()` - 互斥条件SQL分析
- `verify_sql_async()` - 异步SQL验证
- `format_sql_async()` - 异步SQL格式化
- `validate_and_regenerate_sql()` - SQL验证和重新生成

#### 重试机制
- 使用指数退避重试策略
- 支持随机抖动避免惊群效应
- 最大重试次数和延迟时间可配置

### 3. 配置管理 (`config.py`)

#### 配置类：`SyntheticDataConfig`
- **LLM服务器配置**：支持多种LLM服务器
- **场景定义**：20种场景的详细描述
- **变量名词库**：丰富的变量名、表名、实体名等
- **生成参数**：温度、top_p、最大token数等

#### 变量名词库
包含多个业务领域的词汇：
- 电商领域：product_catalog, order_history等
- 金融领域：account_balances, transaction_logs等
- 社交媒体：user_profiles, social_posts等
- 内容管理：article_content, blog_posts等
- 等等...

### 4. 提示词模板 (`prompts.py`)

#### 主要模板
- `PROMPT_ORM` - 基础ORM代码生成
- `PROMPT_CALLER` - 调用者代码生成
- `PROMPT_META` - 元数据生成
- 场景专用模板：如`PROMPT_ORM_IF_ELSE_CALLER`等

#### 模板特点
- 支持场景特定的提示词
- 包含变量替换机制
- 强调JSON格式输出
- 提供参考样例支持

## 工作流程分析

### 1. 单包生成流程
```
1. 加载场景样例 → 2. 生成ORM代码 → 3. 生成调用者代码 → 4. 生成元数据 → 5. 验证数据格式
```

### 2. 并行生成流程
```
1. 创建任务队列 → 2. 启动多个worker → 3. 并行调用LLM → 4. 收集结果 → 5. 合并输出
```

### 3. SQL生成流程
```
1. 分析ORM代码 → 2. 生成初始SQL → 3. 验证SQL正确性 → 4. 格式化SQL → 5. 重新生成（如需要）
```

## 技术特点

### 1. 异步处理
- 使用`asyncio`进行异步LLM调用
- 支持并发控制（信号量）
- 线程安全的统计和日志输出

### 2. 错误处理
- 指数退避重试机制
- 详细的错误日志记录
- 数据验证和格式检查

### 3. 性能优化
- 并行处理支持
- 懒加载session管理
- 内存优化的数据处理

### 4. 可扩展性
- 模块化设计
- 配置驱动的场景支持
- 插件式的提示词模板

## 使用方式

### 命令行接口
```bash
# 基本使用
python -m data_processing.synthetic_data_generator.cli --scenario "单chunk" --count 5

# 并行模式
python -m data_processing.synthetic_data_generator.cli --parallel --workers 8 --count 10

# 查看支持场景
python -m data_processing.synthetic_data_generator.cli --list-scenarios
```

### 编程接口
```python
from config.data_processing.synthetic_data_generator.config import SyntheticDataConfig
from data_processing.synthetic_data_generator.generator import SyntheticDataGenerator

# 创建配置和生成器
config = SyntheticDataConfig(llm_server="v3")
generator = SyntheticDataGenerator(config)

# 生成数据包
pack = await generator.generate_pack("单chunk")
```

## 输出格式

生成的数据包格式与`full_scenario.json`完全一致：
```json
{
  "synthetic_scenario_method_name": {
    "scenario": "场景标签",
    "code_key": "方法名",
    "code_value": "完整的Go代码",
    "sql_pattern_cnt": 1,
    "callers": [...],
    "callees": [],
    "code_meta_data": [...]
  }
}
```

## 修改记录

### table_mapping_incomplete场景优化

根据用户反馈，对`table_mapping_incomplete`场景进行了以下优化：

#### 1. 配置描述更新
- **修改文件**：`config/data_processing/synthetic_data_generator/config.py`
- **更新内容**：完善了场景描述，明确指出必须使用const定义表名常量，并在ORM方法中使用`.Table(TableName)`明确指定表名，确保code_meta_data中包含表名常量定义

#### 2. ORM提示词优化
- **修改文件**：`config/data_processing/synthetic_data_generator/prompts.py`
- **更新内容**：
  - 完善了场景描述，强调必须使用const定义表名常量
  - 添加了关键要求：确保code_meta_data中包含表名常量定义
  - 强调结构体名和表名必须不同，避免模型错误地将结构体名当作表名

#### 3. Caller提示词优化
- **修改文件**：`config/data_processing/synthetic_data_generator/prompts.py`
- **更新内容**：
  - 添加了重要要求：调用者代码应该能够正确处理表名映射不完善的情况
  - 确保使用正确的表名常量

#### 4. 新增专用元数据提示词
- **新增文件**：`config/data_processing/synthetic_data_generator/prompts.py`
- **新增内容**：`PROMPT_META_TABLE_MAPPING_INCOMPLETE`
- **特点**：
  - 必须包含表名常量定义
  - 确保表名常量与结构体名不同
  - 明确区分结构体名和真实表名

#### 5. 生成器逻辑更新
- **修改文件**：`data_processing/synthetic_data_generator/generator.py`
- **更新内容**：
  - 为table_mapping_incomplete场景使用专门的元数据提示词
  - 在串行和并行版本中都添加了场景特定的元数据生成逻辑

#### 6. 模块导出更新
- **修改文件**：`config/data_processing/synthetic_data_generator/__init__.py`
- **更新内容**：添加了新的元数据提示词到导出列表

### 修改效果

通过这些修改，`table_mapping_incomplete`场景现在能够：

1. **明确区分结构体名和表名**：通过const定义表名常量
2. **确保code_meta_data包含表名定义**：专门的元数据提示词确保包含表名常量
3. **避免模型错误理解**：明确要求使用`.Table(TableName)`而不是依赖结构体名
4. **保持数据一致性**：ORM、Caller、Meta三部分都正确处理表名映射

## 总结

`synthetic_data_generator`模块是一个功能完整、架构清晰的合成数据生成系统，具有以下特点：

1. **模块化设计**：配置、提示词、生成逻辑分离
2. **场景丰富**：支持20种不同的ORM场景模式
3. **性能优化**：支持并行处理和异步调用
4. **错误处理**：完善的重试机制和数据验证
5. **易于使用**：提供CLI和编程接口
6. **可扩展性**：支持新场景和提示词的添加
7. **场景优化**：针对特定场景提供专门的提示词模板

该系统为AI训练提供了高质量的合成数据，是code2sql项目的重要组成部分。 