# 20250714 - 增强LLM响应解析和表名抽取规则

## 任务概述
根据用户提供的LLM输出内容，修改`parse_model_response`函数以适应LLM返回的各种格式，并更新表名和字段名抽取提示词规则。

## 主要修改内容

### 1. 增强 `utils/response_parser.py` 中的解析逻辑

#### 1.1 扩展SQL关键字列表
- **原有关键字**: `['SELECT', 'INSERT', 'UPDATE', 'DELETE', 'CREATE', 'DROP', 'ALTER', 'BEGIN', 'COMMIT', 'ROLLBACK']`
- **新增关键字**: 包含完整的SQL语句类型
  - DML (数据操作语言): `SELECT`, `INSERT`, `UPDATE`, `DELETE`, `MERGE`
  - DDL (数据定义语言): `CREATE`, `DROP`, `ALTER`, `TRUNCATE`, `RENAME`
  - DCL (数据控制语言): `GRANT`, `REVOKE`, `DENY`
  - TCL (事务控制语言): `BEGIN`, `COMMIT`, `ROLLBACK`, `SAVEPOINT`, `SET TRANSACTION`
  - 其他SQL语句: `USE`, `SHOW`, `DESCRIBE`, `DESC`, `EXPLAIN`, `ANALYZE`, `WITH`, `WITH RECURSIVE`, `UNION`, `UNION ALL`, `INTERSECT`, `EXCEPT`, `CALL`, `EXECUTE`, `PREPARE`, `DEALLOCATE`
  - 存储过程和函数: `PROCEDURE`, `FUNCTION`, `TRIGGER`, `EVENT`
  - 索引和约束: `INDEX`, `UNIQUE`, `PRIMARY`, `FOREIGN`, `CHECK`, `DEFAULT`
  - 视图: `VIEW`, `MATERIALIZED VIEW`
  - 其他: `LOCK`, `UNLOCK`, `FLUSH`, `RESET`, `SET`, `SHUTDOWN`

#### 1.2 增强 `parse_model_response` 函数
- **新增解析步骤**:
  1. 直接JSON解析
  2. 解析JSON代码块
  3. 解析任意代码块
  4. 截取首尾括号片段
  5. **新增**: 尝试提取SQL语句（以SQL关键字开头）
  6. **新增**: 尝试从文本中提取引号内的内容
  7. **新增**: 尝试提取方括号内的内容
  8. 返回原始字符串列表

#### 1.3 增强 `recursively_extract_sql` 函数
- **新增逻辑**: 
  - 检查字符串是否包含SQL关键字
  - 如果字符串以SQL关键字开头，直接添加
  - 如果字符串包含SQL关键字，尝试按行提取SQL语句
  - 如果没有提取到，将整个字符串作为SQL

### 2. 更新表名抽取提示词规则

#### 2.1 修改 `config/rl/qwen/llm_prompts.yaml`
- **新增详细的表名提取规则**:
  1. **优先级顺序**:
     - 优先使用元数据中的TableName函数
     - 检查配置文件中的表名映射
     - 检查代码中显式指定的表名
     - 推测表名规则
  2. **表名推测的具体规则**:
     - 使用驼峰命名法将结构体名称拆解成小写字母并用下划线分隔
     - **不要自动复数化**表名
     - 优先使用显式指定的表名
  3. **表名推测的边界情况**:
     - 如果表名完全无法推测，返回`<LACK INFORMATION>`并描述缺失信息
     - 如果表名已经显式给出，返回显式指定的表名
     - 如果表名由函数生成，根据上下文推测

#### 2.2 更新JSON输出格式
```json
{
    "tables": ["表名1", "表名2", ...],
    "extraction_method": "使用的提取方法",
    "notes": "提取过程中的重要说明或缺失信息"
}
```

### 3. 更新字段名抽取提示词规则

#### 3.1 新增详细的字段名提取规则
1. **优先级顺序**:
   - **优先使用结构体tag中的column标签**：
     - 检查结构体的字段定义是否包含`gorm:"column:字段名"`标签
     - 如果字段包含`gorm:"column:字段名"`标签，则使用该字段名作为SQL中的列名
   - **检查配置中的字段名映射**：
     - 查找元数据中的字段名映射，如常量、类型定义或配置文件
     - 配置可能出现在`conf`、`config`、`setting`等文件或变量中
     - 如果配置中定义了字段名映射，应优先使用这些映射
   - **直接显式字段名**：
     - 检查代码中是否直接写出了字段名，如`Where("user_id = ?", userId)`中的`user_id`
     - 如果代码中明确写出了字段名，应按原样使用该字段名
   - **推测字段名规则**：
     - 如果没有明确的字段名定义，按Go语言结构体字段名称推测字段名
     - 使用驼峰命名法将Go字段名拆解并转换为下划线形式（例如：`UserName` -> `user_name`）

2. **字段名推测的具体规则**:
   - **结构体tag中的column标签**优先级最高，应直接使用
   - **配置映射中的字段名映射**优先于推测
   - **直接显式写出的字段名**应按原样保留
   - 如果没有其他定义，按照驼峰转下划线规则推测字段名

3. **字段名推测的边界情况**:
   - **如果字段名无法推测**：
     - 如果无法根据任何规则推测字段名，返回`<LACK INFORMATION>`并描述缺失的信息
     - 如果能够推测出字段名但信息不完整，返回推测的字段名并标明缺失的信息
   - **如果字段名已显式指定**：
     - 返回显式指定的字段名，无需推测
   - **如果字段名通过配置映射生成**：
     - 根据配置文件或常量映射返回字段名

4. **特别注意**:
   - 直接在SQL语句中写出的字段名（如WHERE子句中的字段）应该按原样保留，不进行任何格式转换
   - 字段名的推测应尽量与Go语言的结构体字段名保持一致
   - 不要自行为字段名添加复数后缀

#### 3.2 更新字段名JSON输出格式
```json
{
    "columns": ["字段名1", "字段名2", ...],
    "extraction_method": "使用的提取方法（如：结构体tag/配置映射/显式指定/结构体推测/无法推测）",
    "notes": "提取过程中的重要说明或缺失信息"
}
```

### 4. 更新 `code2sql_reward.py` 中的LLM响应解析逻辑

#### 4.1 增强LLM响应解析
- **适配新的JSON格式**：
  - 解析 `extraction_method` 字段，了解提取方法
  - 解析 `notes` 字段，获取提取过程中的重要说明
  - 保持向后兼容，支持旧的JSON格式

- **增强错误处理**：
  - 当JSON解析失败时，使用增强的 `parse_model_response` 函数作为备选
  - 添加详细的调试信息，包括原始响应、JSON字符串、解析结果等
  - 提供多层级的错误处理机制

#### 4.2 更新结果数据结构
```python
result = {
    "tables": tables,
    "columns": columns,
    "table_extraction_method": extraction_method,
    "column_extraction_method": column_extraction_method,
    "table_extraction_notes": extraction_notes,
    "column_extraction_notes": column_extraction_notes
}
```

#### 4.3 增强对比分析功能
- **详细的对比信息**：
  - 显示LLM抽取的表名和字段名
  - 显示sqlglot解析的表名和字段名
  - 显示提取方法和重要说明
  - 计算交集、并集和一致性分数

- **增强的调试输出**：
  - 表名交集和并集统计
  - 字段名交集和并集统计
  - 权重配置信息
  - 综合分数计算过程

#### 4.4 修复data_source类型处理问题
- **支持字符串类型的data_source**：
  - 当data_source是字符串时，尝试从extra_info中获取ORM代码和元数据
  - 如果extra_info中没有ORM代码，将data_source字符串作为ORM代码使用
  - 保持对字典类型data_source的原有支持

- **增强错误处理**：
  - 对不支持的data_source类型提供明确的错误信息
  - 在无法获取ORM代码时提供合理的默认行为
  - 确保系统在各种data_source类型下都能正常运行

## 技术细节

### 解析逻辑增强
1. **SQL关键字检测**: 使用扩展的SQL关键字列表，能够识别更多类型的SQL语句
2. **多格式支持**: 支持纯SQL字符串、JSON格式、对象格式、混合格式等多种LLM返回格式
3. **容错处理**: 当无法解析为JSON时，尝试提取SQL语句或返回原始内容

### 表名提取规则
1. **优先级明确**: 按照TableName函数 → 配置文件映射 → 显式指定 → 结构体推测的顺序
2. **边界情况处理**: 对于无法推测的表名，提供明确的错误信息和推测说明
3. **格式标准化**: 统一使用驼峰转下划线的命名规则，避免自动复数化

### 字段名提取规则
1. **优先级明确**: 按照结构体tag → 配置映射 → 显式指定 → 结构体推测的顺序
2. **边界情况处理**: 对于无法推测的字段名，提供明确的错误信息和推测说明
3. **格式标准化**: 统一使用驼峰转下划线的命名规则，保持与Go结构体字段的一致性

## 使用方式

### 1. 解析LLM响应
```python
from utils.response_parser import parse_model_response, recursively_extract_sql

# 解析LLM响应
parsed = parse_model_response(llm_response)
sql_list = recursively_extract_sql(parsed)
```

### 2. 表名和字段名提取
- 配置文件中的提示词会自动按照新的规则进行表名和字段名提取
- 输出包含提取方法说明和重要注释

## 验证和测试
- 创建了测试脚本 `test_parse_response.py` 来验证各种LLM返回格式的解析
- 包含多种测试用例：纯SQL字符串、JSON格式、对象格式、混合格式等

## 注意事项
1. **SQL关键字扩展**: 新增了大量SQL关键字，确保能够识别各种SQL语句类型
2. **表名推测规则**: 严格按照优先级顺序进行表名提取，避免错误推测
3. **字段名推测规则**: 严格按照优先级顺序进行字段名提取，优先使用结构体tag和配置映射
4. **边界情况处理**: 对于无法确定的情况，提供明确的错误信息和推测说明
5. **向后兼容**: 保持原有解析逻辑不变，只是增强了功能

## 文件修改清单
1. `utils/response_parser.py` - 增强解析逻辑和SQL关键字列表
2. `config/rl/qwen/llm_prompts.yaml` - 更新表名和字段名抽取提示词规则
3. `model/rl/code2sql_reward.py` - 更新LLM响应解析逻辑，适配新的JSON格式
4. `test_parse_response.py` - 创建测试脚本（待完善）

## 后续工作
1. 完善测试脚本，添加更多测试用例
2. 验证新的解析逻辑在实际训练中的效果
3. 根据实际使用情况进一步优化解析规则 