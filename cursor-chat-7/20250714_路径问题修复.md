# 20250714 - 路径问题修复

## 问题描述

用户在运行训练脚本时遇到路径错误：
```
python3.10: can't open file '/home/wuyu/code2sql/model/rl/model/rl/run_verl_training.py': [Errno 2] No such file or directory
```

## 问题分析

1. **错误原因**：用户在 `model/rl` 目录下运行命令，但脚本路径写成了 `model/rl/model/rl/run_verl_training.py`，这是重复的路径
2. **根本原因**：训练脚本中的路径构建逻辑有问题，`Path(__file__).parents[2]` 在 `model/rl` 目录下会指向错误的路径

## 解决方案

### 1. 修复路径构建逻辑

修改 `model/rl/run_verl_training.py` 第150行附近的代码：

```python
# 修改前
config_path = str(Path(__file__).parents[2] / "config" / "rl" / "qwen" / args.config)

# 修改后
# 从当前脚本位置计算项目根目录
script_dir = Path(__file__).parent
project_root = script_dir.parent.parent  # 从 model/rl 回到项目根目录
config_path = str(project_root / "config" / "rl" / "qwen" / args.config)
```

### 2. 修复配置排除逻辑

修改 `model/rl/run_verl_training.py` 中的配置排除逻辑：

```python
# 修改前
for key, value in flat_config.items():
    if key not in excluded_keys:

# 修改后
for key, value in flat_config.items():
    # 检查是否应该排除这个键
    should_exclude = False
    for excluded_key in excluded_keys:
        if key == excluded_key or key.startswith(f"{excluded_key}."):
            should_exclude = True
            break
    
    if not should_exclude:
```

### 3. 修复数据文件路径问题

**问题**：配置文件中的相对路径导致实际路径错误
- 配置文件中写的是：`model/data/orm2sql_rl_data/orm2sql_rl_train.parquet`
- 实际运行时路径变成：`/home/wuyu/code2sql/model/rl/model/data/orm2sql_rl_data/orm2sql_rl_train.parquet`
- 而实际文件在：`/home/wuyu/code2sql/model/data/orm2sql_rl_data/orm2sql_rl_20250708_162812_train.parquet`

**解决方案**：
1. 将配置文件中的相对路径改为绝对路径
2. 修正文件名，使用实际存在的文件名

```yaml
# 修改前
data:
  train_files: "model/data/orm2sql_rl_data/orm2sql_rl_train.parquet"
  val_files: "model/data/orm2sql_rl_data/orm2sql_rl_val.parquet"

# 修改后
data:
  train_files: "/home/wuyu/code2sql/model/data/orm2sql_rl_data/orm2sql_rl_20250708_162812_train.parquet"
  val_files: "/home/wuyu/code2sql/model/data/orm2sql_rl_data/orm2sql_rl_20250708_162812_val.parquet"
```

### 4. 修复GPU配置问题

**问题**：配置中设置的GPU数量超过了实际可用的GPU数量
```
ValueError: Total available GPUs 8.0 is less than total desired GPUs 32
```

**解决方案**：
```yaml
# 修改前
trainer:
  n_gpus_per_node: 8
  nnodes: 4

# 修改后
trainer:
  n_gpus_per_node: 6  # 使用6个GPU (2,3,4,5,6,7号卡)
  nnodes: 1  # 单节点训练
```

### 5. 修复批次大小配置问题

**问题**：批次大小不能被GPU数量整除
```
AssertionError: real_train_batch_size (64) must be divisible by minimal possible batch size (6)
```

**解决方案**：
```yaml
# 修改前
data:
  train_batch_size: 64
actor_rollout_ref:
  actor:
    ppo_mini_batch_size: 64

# 修改后
data:
  train_batch_size: 60  # 调整为60，能被6整除
actor_rollout_ref:
  actor:
    ppo_mini_batch_size: 60  # 调整为60，与train_batch_size保持一致
```

### 6. 修复张量并行配置问题

**问题**：张量并行大小与GPU数量不匹配
```
AssertionError: rollout world_size: 6 is not divisible by infer_tp: 4
```

**解决方案**：
```yaml
# 修改前
actor_rollout_ref:
  rollout:
    tensor_model_parallel_size: 4

# 修改后
actor_rollout_ref:
  rollout:
    tensor_model_parallel_size: 2  # 调整为2，能被6整除
```

### 7. 修复缓存路径权限问题

**问题**：HuggingFace缓存路径权限不足
```
PermissionError: [Errno 13] Permission denied: '/data/local_disk3/dl_models/modules'
```

**解决方案**：设置缓存路径到有权限的目录
```yaml
environment:
  HF_MODULES_CACHE: "/home/wuyu/code2sql/saves/rl/hf_modules_cache"
  TRANSFORMERS_CACHE: "/home/wuyu/code2sql/saves/rl/transformers_cache"
  HF_HOME: "/home/wuyu/code2sql/saves/rl/huggingface"
```

### 8. 修复模型保存路径配置

**问题**：VERL框架不认识自定义的保存路径配置
```
Could not override 'trainer.save_dir'.
```

**解决方案**：使用VERL框架支持的标准配置
```yaml
trainer:
  default_local_dir: "/home/wuyu/code2sql/saves/rl/checkpoints"
```

### 9. 修复奖励函数参数问题

**问题**：自定义奖励函数不接受额外的参数
```
TypeError: code2sql_reward() got an unexpected keyword argument 'data_sources'
```

**解决方案**：添加 `**kwargs` 参数接受额外参数
```python
# 修改前
def code2sql_reward(data_source, solution_str, ground_truth, extra_info):

# 修改后
def code2sql_reward(data_source, solution_str, ground_truth, extra_info, **kwargs):
```

### 10. 验证修复效果

运行调试模式验证：
```bash
cd model/rl
python run_verl_training.py --config qwen2_14b_rf.yaml --debug
```

输出显示：
- 配置文件正确加载：`/home/wuyu/code2sql/config/rl/qwen/qwen2_14b_rf.yaml`
- 训练命令正确构建，所有路径都是绝对路径
- 调试模式正常退出

## 修改内容总结

### 修改的文件
- `model/rl/run_verl_training.py`：修复配置文件路径构建逻辑和配置排除逻辑
- `config/rl/qwen/qwen2_14b_rf.yaml`：修复数据文件路径、模型路径、GPU配置、批次大小、张量并行、缓存路径、模型保存路径
- `model/rl/code2sql_reward.py`：修复奖励函数参数问题

### 修改的具体内容
1. 将 `Path(__file__).parents[2]` 改为 `script_dir.parent.parent`
2. 添加了清晰的注释说明路径计算逻辑
3. 确保从 `model/rl` 目录运行时能正确找到项目根目录
4. 修复配置排除逻辑，支持排除所有以指定前缀开头的配置项
5. 将配置文件中的相对路径改为绝对路径
6. 修正数据文件名，使用实际存在的文件名
7. 调整GPU配置，使用6个GPU单节点训练
8. 调整批次大小，确保能被GPU数量整除
9. 调整张量并行大小，确保能被GPU数量整除
10. 设置缓存路径到有权限的目录
11. 使用VERL框架支持的标准保存路径配置
12. 修复奖励函数参数问题，添加 `**kwargs` 支持额外参数

## 使用方式

现在可以正常使用以下命令启动训练：

```bash
# 在 model/rl 目录下
python run_verl_training.py --config qwen2_14b_rf.yaml

# 或在项目根目录下
python model/rl/run_verl_training.py --config qwen2_14b_rf.yaml
```

## 技术要点

1. **路径计算**：使用 `Path(__file__).parent` 获取脚本所在目录，然后通过 `parent.parent` 回到项目根目录
2. **兼容性**：修复后的代码支持从不同目录运行脚本
3. **调试模式**：使用 `--debug` 参数可以预览构建的训练命令而不实际执行
4. **配置排除**：支持排除所有以指定前缀开头的配置项，避免传递给不支持的框架
5. **绝对路径**：使用绝对路径避免工作目录变化导致的路径错误
6. **GPU配置**：确保GPU数量、批次大小、张量并行大小相互兼容
7. **权限管理**：将缓存和保存路径设置到有权限的目录
8. **框架兼容**：使用VERL框架支持的标准配置项
9. **函数接口**：确保自定义函数接口与框架要求兼容

## 风险说明

- 修复仅涉及路径计算逻辑，不影响训练功能
- 保持了原有的配置加载和命令构建逻辑
- 向后兼容，不影响其他使用方式
- 所有路径都使用绝对路径，确保在不同工作目录下都能正确运行
- GPU配置已优化为适合当前硬件环境
- 所有缓存和保存路径都设置在用户有权限的目录下 