# 合成数据生成器架构分析

## 概述

合成数据生成器是一个用于自动生成**合成ORM数据包**的工具，这些数据包镜像真实提取样本的结构（如`full_scenario.json`中的样本）。该工具支持13种不同的ORM场景模式，能够生成高质量的Go语言ORM代码示例。

## 架构组件

### 1. 核心模块结构

```
data_processing/synthetic_data_generator/
├── __init__.py          # 模块初始化
├── generator.py         # 核心生成逻辑 (701行)
├── cli.py              # 命令行接口 (164行)
├── get_sql.py          # SQL生成和验证 (1020行)
├── example_usage.py    # 使用示例 (139行)
└── README.md           # 说明文档 (189行)

config/data_processing/synthetic_data_generator/
├── __init__.py         # 模块初始化
├── config.py           # 配置管理 (246行)
└── prompts.py          # 提示词模板 (528行)
```

### 2. 主要组件分析

#### 2.1 配置管理 (`config.py`)

**功能特点：**
- 支持13种ORM场景模式的定义和描述
- 提供丰富的变量名词库（表名、实体名、方法名等）
- 集成项目的LLM配置系统
- 支持自定义参数配置

**支持的场景：**
1. **对象var+chunk** - ORM方法仅依赖接收者对象的成员变量
2. **caller+global variable** - 依赖外部全局常量或变量
3. **caller+chunk** - 需要调用者传递的参数chunks
4. **caller的callee+caller** - 形成调用链的ORM方法
5. **单chunk** - 最基础的CRUD操作
6. **单chunk+meta(global var)** - 使用单一数据块和全局变量
7. **preload特殊函数** - 使用预加载功能优化关联查询
8. **association特殊函数** - 处理关联关系操作
9. **单chunk+meta(local var)** - 依赖方法内部的局部变量
10. **单chunk+meta(对象var)** - 依赖对象成员变量
11. **一度caller+chunk** - 一层调用关系
12. **二度caller+chunk** - 两层调用关系
13. **对象const+chunk** - 依赖对象常量成员变量

#### 2.2 核心生成器 (`generator.py`)

**核心功能：**
- 异步LLM调用支持
- 并行处理能力
- 数据验证和格式化
- 统计监控和错误处理

**主要方法：**
- `generate_pack()` - 生成单个数据包
- `generate_pack_parallel()` - 并行生成数据包
- `generate_multiple_packs_parallel()` - 批量并行生成
- `validate_pack()` - 验证生成的数据格式

#### 2.3 提示词模板 (`prompts.py`)

**模板类型：**
- `PROMPT_ORM` - 基础ORM代码生成
- `PROMPT_ORM_IF_ELSE_CALLER` - if-else场景专用
- `PROMPT_CALLER` - 调用者代码生成
- `PROMPT_META` - 元数据代码生成

**特点：**
- 结构化JSON输出格式
- 多样化的变量名生成
- 场景特定的代码要求
- 完整的Go代码生成

#### 2.4 SQL生成和验证 (`get_sql.py`)

**功能：**
- 从ORM代码中提取SQL语句
- SQL语句验证和格式化
- 支持多种SQL模式识别
- 指数退避重试机制

**处理流程：**
1. 分析阶段 - 提取SQL语句
2. 验证阶段 - 验证SQL正确性
3. 格式化阶段 - 标准化SQL格式

#### 2.5 命令行接口 (`cli.py`)

**支持的命令：**
```bash
# 基本使用
python -m data_processing.synthetic_data_generator.cli

# 指定场景生成
python -m data_processing.synthetic_data_generator.cli --scenario "单chunk" --count 5

# 并行模式
python -m data_processing.synthetic_data_generator.cli --parallel --workers 8 --count 10

# 验证数据
python -m data_processing.synthetic_data_generator.cli --validate --count 3

# 列出场景
python -m data_processing.synthetic_data_generator.cli --list-scenarios
```

## 数据流程

### 1. 输入数据
- **参考样例**：`datasets/full_scenario.json` (2646行)
- **配置参数**：LLM服务器、温度、token数等
- **场景选择**：13种预定义场景之一

### 2. 处理流程
1. **加载参考样例** - 从full_scenario.json加载真实样本
2. **场景匹配** - 根据场景标签找到对应样例
3. **LLM调用** - 使用提示词模板生成代码
4. **数据验证** - 验证生成数据的格式正确性
5. **并行处理** - 支持多线程并行生成

### 3. 输出格式
```json
{
  "synthetic_scenario_method_name": {
    "scenario": "场景标签",
    "code_key": "方法名",
    "code_value": "完整的Go代码",
    "sql_pattern_cnt": 1,
    "callers": [
      {
        "code_key": "调用者方法名",
        "code_value": "调用者代码"
      }
    ],
    "callees": [],
    "code_meta_data": [
      {
        "code_key": "结构体名",
        "code_value": "类型定义代码"
      }
    ]
  }
}
```

## 技术特点

### 1. 架构优势
- **模块化设计**：配置、提示词、生成逻辑分离
- **类型安全**：修复了原有的linter错误
- **异步支持**：使用aiohttp进行异步LLM调用
- **并行处理**：支持多线程并行生成

### 2. 性能优化
- **并行模式**：支持多worker并行处理
- **内存优化**：分批处理大量数据
- **重试机制**：指数退避重试失败的请求
- **统计监控**：实时显示生成进度和统计信息

### 3. 数据质量
- **格式验证**：自动验证生成数据的格式正确性
- **多样化生成**：使用丰富的变量名词库
- **场景匹配**：根据真实样例生成对应场景的代码
- **SQL提取**：自动从ORM代码中提取和验证SQL语句

## 与项目集成

### 1. 配置系统集成
- 使用项目的`config/llm/servers.yaml`配置
- 集成项目的LLMClient
- 支持环境变量配置API密钥

### 2. 工具链集成
- 使用项目的`utils.llm_client`
- 使用项目的`utils.format_validators`
- 遵循项目的代码风格和架构模式

### 3. 数据格式兼容
- 输出格式与`full_scenario.json`完全一致
- 支持现有的数据处理流程
- 可以直接用于模型训练和评估

## 使用场景

### 1. 数据扩充
- 为机器学习模型提供更多训练样本
- 补充特定场景的数据不足问题
- 生成多样化的ORM代码示例

### 2. 测试验证
- 验证SQL生成模型的准确性
- 测试不同场景下的代码生成能力
- 评估模型的泛化性能

### 3. 开发调试
- 快速生成测试用例
- 验证ORM代码的正确性
- 调试SQL生成逻辑

## 总结

合成数据生成器是一个设计精良的工具，具有以下特点：

1. **功能完整**：支持13种ORM场景，覆盖各种代码模式
2. **架构清晰**：模块化设计，易于维护和扩展
3. **性能优秀**：支持并行处理，提高生成效率
4. **质量可靠**：包含数据验证和错误处理机制
5. **易于使用**：提供友好的CLI接口和详细文档

该工具为ORM代码生成和SQL推断任务提供了高质量的数据支持，是项目中重要的数据处理组件。 