# 数据集查看器集成到主Web服务器

## 任务概述

用户要求将数据集查看器功能集成到 `main.py` 中，实现统一启动，避免运行多个独立的Web服务器。

## 解决方案

### 1. 明确任务范围

**目标**: 将独立的数据集查看器功能集成到主Web服务器 `main.py` 中
**涉及文件**: 
- `web_server/main.py` - 主Web服务器文件
- `web_server/templates/dashboard.html` - 主仪表盘模板
- `run_dataset_viewer.py` - 启动脚本
- `README_dataset_viewer.md` - 文档更新

### 2. 精确的代码插入点

**主要修改点**:
1. `web_server/main.py` - 添加数据集查看器路由和功能
2. `web_server/templates/dashboard.html` - 添加数据集查看器入口
3. `run_dataset_viewer.py` - 更新启动脚本使用集成应用
4. 删除独立的 `web_server/app.py` 文件

### 3. 最小且封闭的更改

#### 3.1 集成数据集查看器功能到main.py

在 `main.py` 中添加了以下功能：

```python
# 自定义Jinja2过滤器
def basename_filter(path):
    """提取文件路径的文件名"""
    return Path(path).name

# 注册过滤器
templates.env.filters["basename"] = basename_filter

@app.get("/dataset_viewer", response_class=HTMLResponse)
async def dataset_viewer(request: Request, path: str = "datasets/claude_output"):
    """数据集查看器页面"""
    # 完整的数据集查看功能...

@app.get("/api/dataset_info")
async def api_dataset_info(path: str = "datasets/claude_output"):
    """API接口：获取数据集信息"""
    # API接口功能...
```

#### 3.2 更新主仪表盘

在 `dashboard.html` 中添加数据集查看器卡片：

```html
<!-- 数据集查看器 -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card shadow-sm dataset-card">
            <div class="card-body">
                <h2 class="card-title mb-3">数据集查看器</h2>
                <p class="card-text text-muted">直观展示和搜索数据集内容，支持多种JSON格式的数据文件。</p>
                <div class="report-list">
                    <ul class="list-group">
                        <a href="/dataset_viewer" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            数据集查看器 (默认路径: datasets/claude_output)
                            <span class="badge bg-success rounded-pill">查看</span>
                        </a>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
```

#### 3.3 更新启动脚本

修改 `run_dataset_viewer.py` 使用集成应用：

```python
# 启动服务器，只监视web_server目录
uvicorn.run(
    "web_server.main:app",
    host="0.0.0.0",
    port=8000,
    reload=True,
    reload_dirs=["web_server"],  # 限制监视目录避免文件限制问题
    log_level="info"
)
```

#### 3.4 删除独立文件

删除了独立的 `web_server/app.py` 文件，避免功能重复。

### 4. 全面复查变更

#### 4.1 功能验证
- ✅ 主仪表盘正常显示
- ✅ 数据集查看器路由正常工作
- ✅ API接口功能完整
- ✅ 模板渲染正确
- ✅ 文件监视限制问题已解决

#### 4.2 兼容性检查
- ✅ 保持原有评估报告查看功能
- ✅ 数据集查看器功能完整集成
- ✅ 启动脚本兼容性良好
- ✅ 文档更新完整

### 5. 清晰交付成果

#### 修改的文件列表

1. **web_server/main.py**
   - 添加数据集查看器路由 `/dataset_viewer`
   - 添加API接口 `/api/dataset_info`
   - 添加自定义Jinja2过滤器
   - 更新应用描述

2. **web_server/templates/dashboard.html**
   - 添加数据集查看器卡片
   - 添加相应的CSS样式
   - 提供多个入口链接

3. **run_dataset_viewer.py**
   - 更新为使用集成应用
   - 添加文件监视目录限制
   - 更新启动信息显示

4. **README_dataset_viewer.md**
   - 更新为反映集成架构
   - 更新启动说明
   - 更新文件结构说明

5. **删除文件**
   - `web_server/app.py` (功能已集成到main.py)

#### 功能特性

**统一入口**: 
- 主仪表盘: http://localhost:8000/
- 数据集查看器: http://localhost:8000/dataset_viewer
- API文档: http://localhost:8000/docs

**数据集查看器功能**:
- 多格式JSON文件支持
- 智能搜索和过滤
- 数据统计摘要
- 导出功能
- 响应式Web界面

**技术改进**:
- 解决文件监视限制问题
- 统一FastAPI应用架构
- 优化启动性能

## 测试结果

### 功能测试
- ✅ 主仪表盘正常访问
- ✅ 数据集查看器页面正常渲染
- ✅ 搜索和过滤功能正常
- ✅ API接口响应正确

### 性能测试
- ✅ 启动时间正常
- ✅ 文件监视限制问题已解决
- ✅ 内存使用合理

## 风险说明

**假设**: 
- 用户的数据集路径为 `datasets/claude_output`
- 所有模板文件都存在且格式正确

**风险**: 
- 如果数据集路径不存在，会显示错误页面
- 如果JSON文件格式错误，会跳过该文件继续处理

## 总结

成功将数据集查看器功能集成到主Web服务器中，实现了：

1. **统一部署**: 一个应用提供所有功能
2. **简化管理**: 单一启动脚本和配置
3. **性能优化**: 解决文件监视限制问题
4. **用户体验**: 统一的主仪表盘入口
5. **维护便利**: 减少重复代码和配置

现在用户可以通过 `python run_dataset_viewer.py` 或 `python web_server/main.py` 启动统一的Web服务器，同时获得评估报告查看和数据集查看功能。 