# 修复训练模型保存路径问题

## 问题描述

在使用 `train_qwen3_ft.py` 脚本进行模型训练时，发现模型被错误地保存到了 `model/training/LLaMA-Factory/saves` 目录下，而不是项目根目录的 `saves` 目录。

问题原因：
- 训练脚本使用相对路径设置保存目录
- 执行训练时切换到了 LLaMA-Factory 目录
- 导致模型保存到了错误的位置

## 解决方案

修改 `train_qwen3_ft.py` 脚本，使用项目根目录的绝对路径来设置保存位置：

```python
# 修改前
base_output_dir = config.get("output_dir", "saves/qwen3-14b-ft")

# 修改后
base_output_dir = str(PROJECT_ROOT / "saves" / "qwen3-14b-ft")
```

## 改进效果

1. 保证模型始终保存在正确的位置（项目根目录的 saves 目录下）
2. 避免了工作目录切换导致的路径问题
3. 维护了项目的标准目录结构

## 磁盘空间问题分析

在检查磁盘使用情况时发现，主要的空间占用来源：
1. `/home/wuyu/qwen3-lora-finetune/LLaMA-Factory/saves`：398G（模型检查点和训练输出）
2. `/home/wuyu/.cache`：37G（缓存文件）
3. `/home/wuyu/code2sql`：20G（项目文件）

## 对于缺失SQL的"add"处理机制

在冗余SQL验证系统中，对于需要添加的缺失SQL，系统有以下处理流程：

### 1. 检测阶段
- 系统通过ORM SQL指纹分析检测出可能缺失的SQL模式
- 在 `fix_recommendations.json` 中生成 `add_missing` 类型的建议

### 2. LLM审核机制
在应用修复之前，系统会调用 `_llm_review_fix_sync` 方法对每个添加操作进行审核：

```python
review = self._llm_review_fix_sync(orm_code, caller, 'add', sql_text)
if review.get('accepted', True):
    add_missing_map[key].append(sql_text)
else:
    replacement = review.get('replacement', '')
    if replacement:
        add_missing_map[key].append(replacement)
```

### 3. 支持的添加格式
- **简单SQL字符串**：直接的SQL文本
- **param_dependent结构**：参数依赖的复杂SQL结构
- **结构化变体**：包含多种场景的SQL变体

### 4. 实际应用逻辑
- 如果原记录的 `sql_statement_list` 为 `'<NO SQL GENERATE>'`，则直接替换为缺失的SQL
- 如果已有SQL，则将缺失的SQL添加到现有列表中
- 支持单个字符串、列表、字典等多种SQL数据结构

### 5. 审核验证
每个添加操作都会通过LLM进行二次审核，确保：
- 添加的SQL确实是必要的
- SQL语法和业务逻辑正确
- 不会引入新的问题

这套机制确保了缺失SQL的添加既自动化又安全可靠。

## 工作流增强：添加NO SQL记录清理步骤

在关键词优先工作流中新增了一个清理步骤，用于删除所有包含 `<NO SQL GENERATE>` 的记录：

### 新增功能
1. **`remove_no_sql_records`方法**：
   - 自动识别和删除包含 `<NO SQL GENERATE>` 的记录
   - 支持字符串和列表两种格式的检测
   - 记录详细的删除统计信息

2. **工作流集成**：
   - 在SQL清洗步骤之后执行
   - 在冗余SQL验证之前执行
   - 确保后续处理只针对有效的SQL记录

3. **统计信息**：
   - 输入记录数
   - 删除记录数  
   - 保留记录数
   - 删除率
   - 输出文件路径

### 更新的工作流顺序
```
加载 → 关键词提取 → 记录剔除 → SQL清洗 → 删除NO SQL记录 → 冗余SQL验证 → 导出与摘要
```

这个增强确保了数据集的质量，只保留真正包含有效SQL的记录进行后续处理和训练。

## 相关文件

- 修改的文件：
  - `model/training/train_qwen3_ft.py`
  - `data_processing/workflow/workflow_manager.py`（新增`remove_no_sql_records`方法）
- 涉及的目录：
  - 项目根目录的 `saves/`
  - `model/training/LLaMA-Factory/`
- 缺失SQL处理相关代码：
  - `data_processing/workflow/workflow_manager.py`（`_apply_fix_recommendations`方法）
  - `data_processing/cleaning/redundant_sql_validator.py` 