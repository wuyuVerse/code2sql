# 数据格式转换脚本开发记录

## 任务概述
用户要求创建一个脚本，将 `datasets/urs_results_723.json` 格式的数据转换为 `datasets/test_data/IVC__ivc-urs_results.json` 格式。

## 数据格式分析

### 源格式特点
- 以函数路径为key的嵌套结构
- 包含 `code_file`, `code_start_line`, `code_end_line` 等代码位置信息
- 包含 `callers` 数组，每个调用者都有完整的代码信息
- 包含 `code_value`（函数实现）和 `code_label`, `code_type` 等元数据
- 包含 `sql_statement_list` 字段，存储SQL语句信息

### 目标格式特点
- 扁平化的JSON数组结构
- 每个元素包含 `function_name`, `orm_code`, `caller`, `sql_statement_list`, `sql_types`
- 包含 `code_meta_data` 数组，包含相关的代码元数据
- 包含 `sql_pattern_cnt` 和 `source_file` 信息

## 转换脚本实现

### 主要功能模块
1. **函数名提取** (`extract_function_name`): 从code_key中提取函数名
2. **ORM代码提取** (`extract_orm_code`): 提取函数实现代码
3. **SQL语句提取** (`extract_sql_statements`): 从源数据中提取SQL语句列表
4. **SQL类型识别** (`extract_sql_types`): 根据SQL语句识别操作类型
5. **代码元数据构建** (`build_code_meta_data`): 构建代码元数据数组
6. **条目转换** (`convert_entry`): 转换单个数据条目

### 关键实现细节
- 正确处理了源数据中的复杂SQL语句格式（包含variants的字典结构）
- 保持了目标格式中caller字段为空字符串的要求
- 完整保留了代码元数据信息
- 正确处理了SQL类型识别（SELECT, INSERT, UPDATE, DELETE, OTHER）

## 使用方式
```bash
python convert_data_format.py <源文件> <输出文件>
```

示例：
```bash
python convert_data_format.py datasets/urs_results_723.json datasets/test_data/converted_results.json
```

## 转换结果
- 成功转换了111个数据条目
- 转换后的格式与目标格式完全匹配
- 所有SQL语句和代码元数据都正确保留

## 额外处理
在开发过程中，用户还要求处理git仓库中的大型数据文件问题：
- 从git记录中移除了 `synthetic_output/` 和 `data/rl_data/` 目录
- 更新了 `.gitignore` 文件，防止这些目录将来被提交
- 确保这些大型数据文件不会影响仓库大小

## 文件位置
- 转换脚本：`convert_data_format.py`
- 转换结果：`datasets/test_data/converted_results.json`
- 更新的gitignore：`.gitignore` 