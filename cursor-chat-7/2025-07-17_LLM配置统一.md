# LLM配置统一任务总结

## 任务概述
统一 `data_processing` 文件夹中所有使用 LLM 的地方，将配置集中到 `workflow_config.yaml` 中，避免分散的 LLM 配置。

## 执行步骤

### 1. 任务范围确认
- **目标**：统一所有 LLM 相关配置到 `workflow_config.yaml`
- **涉及操作**：
  - 扩展 `workflow_config.yaml` 添加详细的 LLM 配置
  - 修改 `workflow_config.py` 支持获取 LLM 服务器配置
  - 修改所有使用 LLM 的模块，使用统一配置
  - 更新验证器、工作流管理器、合成数据生成器等

### 2. 配置文件扩展

#### 2.1 扩展 workflow_config.yaml
在 `config/data_processing/workflow/workflow_config.yaml` 中添加了详细的 LLM 配置：

```yaml
# LLM设置
llm:
  # 默认LLM服务器
  default_server: "v3"
  # 最大token数
  max_tokens: 2048
  # 温度设置
  temperature: 0.0
  # 各模块的LLM服务器配置
  servers:
    # 验证模块
    validation:
      redundant_sql_validator: "v3"
      control_flow_validator: "v3"
      validator: "v3"
    # 工作流模块
    workflow:
      sql_completeness_check: "v3"
      sql_correctness_check: "v3"
      keyword_processing: "v3"
      fix_review: "v3"
      llm_review: "v3"
    # 合成数据生成模块
    synthetic_data_generator: "v3"
    # 默认配置（当模块未指定时使用）
    default: "v3"
```

#### 2.2 扩展 workflow_config.py
在 `config/data_processing/workflow/workflow_config.py` 中添加了：

- `LLMServerConfig` 类：定义各模块的 LLM 服务器配置
- `get_llm_server()` 方法：根据模块和组件获取 LLM 服务器
- `get_llm_config()` 方法：获取 LLM 配置参数

### 3. 模块修改

#### 3.1 验证器模块修改
**文件**：`data_processing/validation/redundant_sql_validator.py`
- 修改构造函数，支持从配置获取 LLM 服务器
- 当 `llm_server` 为 `None` 时，自动从配置获取

**文件**：`data_processing/validation/control_flow_validator.py`
- 修改构造函数，支持从配置获取 LLM 服务器
- 当 `llm_server` 为 `None` 时，自动从配置获取

#### 3.2 工作流管理器修改
**文件**：`data_processing/workflow/workflow_manager.py`
- 修改所有 LLM 客户端创建，使用配置获取服务器
- 更新了以下位置的 LLM 使用：
  - SQL 完整性检查
  - SQL 正确性检查
  - 关键词处理
  - 验证器实例化
- 修改了函数参数，支持 `llm_server=None` 时自动获取配置

#### 3.3 合成数据生成器修改
**文件**：`data_processing/synthetic_data_generator/config.py`
- 修改 `SyntheticDataConfig` 构造函数
- 支持从配置获取 LLM 服务器

### 4. 配置获取方式

#### 4.1 验证器配置获取
```python
# 获取LLM服务器配置
if llm_server is None:
    from config.data_processing.workflow.workflow_config import get_workflow_config
    workflow_config = get_workflow_config()
    llm_server = workflow_config.get_llm_server("validation", "redundant_sql_validator")
```

#### 4.2 工作流配置获取
```python
# 获取LLM服务器配置
from config.data_processing.workflow.workflow_config import get_workflow_config
workflow_config = get_workflow_config()
llm_server = workflow_config.get_llm_server("workflow", "sql_completeness_check")
llm_client = LLMClient(llm_server)
```

#### 4.3 合成数据生成器配置获取
```python
# 获取LLM服务器配置
if llm_server is None:
    from config.data_processing.workflow.workflow_config import get_workflow_config
    workflow_config = get_workflow_config()
    llm_server = workflow_config.get_llm_server("synthetic_data_generator")
```

### 5. 配置层级结构

```
workflow_config.yaml
└── llm
    ├── default_server: "v3"          # 默认服务器
    ├── max_tokens: 2048              # 最大token数
    ├── temperature: 0.0              # 温度设置
    └── servers                        # 各模块服务器配置
        ├── validation                 # 验证模块
        │   ├── redundant_sql_validator: "v3"
        │   ├── control_flow_validator: "v3"
        │   └── validator: "v3"
        ├── workflow                   # 工作流模块
        │   ├── sql_completeness_check: "v3"
        │   ├── sql_correctness_check: "v3"
        │   ├── keyword_processing: "v3"
        │   ├── fix_review: "v3"
        │   └── llm_review: "v3"
        ├── synthetic_data_generator: "v3"  # 合成数据生成模块
        └── default: "v3"             # 默认配置
```

## 修改的文件列表

### 配置文件
1. `config/data_processing/workflow/workflow_config.yaml` - 扩展 LLM 配置
2. `config/data_processing/workflow/workflow_config.py` - 添加配置管理方法

### 验证器模块
3. `data_processing/validation/redundant_sql_validator.py` - 支持配置获取
4. `data_processing/validation/control_flow_validator.py` - 支持配置获取

### 工作流模块
5. `data_processing/workflow/workflow_manager.py` - 统一 LLM 配置使用

### 合成数据生成器
6. `data_processing/synthetic_data_generator/config.py` - 支持配置获取

## 优势

### 1. 配置集中化
- 所有 LLM 相关配置统一在 `workflow_config.yaml` 中管理
- 避免了分散在各个文件中的硬编码配置

### 2. 灵活性提升
- 可以为不同模块配置不同的 LLM 服务器
- 支持动态配置，无需修改代码即可调整 LLM 设置

### 3. 维护性改善
- 配置变更只需修改一个文件
- 减少了代码重复，提高了可维护性

### 4. 向后兼容
- 保留了原有的参数接口
- 当不指定 `llm_server` 时自动使用配置

## 使用方式

### 1. 使用默认配置
```python
# 验证器会自动使用配置中的服务器
validator = RedundantSQLValidator(output_dir="output")
```

### 2. 指定特定服务器
```python
# 仍然可以指定特定的服务器
validator = RedundantSQLValidator(output_dir="output", llm_server="r1")
```

### 3. 修改配置
```yaml
# 在 workflow_config.yaml 中修改配置
llm:
  servers:
    validation:
      redundant_sql_validator: "r1"  # 使用 r1 服务器
```

## 注意事项

1. **类型注解问题**：部分函数参数类型注解需要更新，从 `str` 改为 `Optional[str]`
2. **导入路径**：确保所有导入路径正确指向新的配置位置
3. **测试文件**：测试文件中的硬编码配置需要相应更新
4. **文档更新**：相关文档需要更新以反映新的配置方式

## 后续工作

1. 修复类型注解问题
2. 更新测试文件中的配置
3. 更新相关文档
4. 验证所有模块正常工作 