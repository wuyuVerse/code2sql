# 2025-07-15 关键词识别数据字段修改

## 问题描述

用户希望在关键词识别后的数据中，为所有记录都增加 `llm_keyword_analysis` 字段，即使某些记录没有匹配到关键词。

## 问题分析

### 原始逻辑
1. `_extract_keyword_data_with_llm` 方法会分析所有记录并添加 `llm_keyword_analysis` 字段
2. 但是只有匹配关键词的记录被保存到 `self.extracted_data`
3. 未匹配的记录被保存到单独的文件中
4. `merge_processed_data_back` 方法只合并匹配的记录，未匹配的记录没有 `llm_keyword_analysis` 字段

### 问题根源
- 当前逻辑中，`self.current_data` 在关键词提取后没有被更新
- 只有匹配的记录被保存到 `self.extracted_data`
- 未匹配的记录被保存到单独的文件中
- 最终导出时只包含 `self.current_data`，而 `self.current_data` 没有 `llm_keyword_analysis` 字段

## 修改方案

### 修改位置
- 文件：`data_processing/workflow/workflow_manager.py`
- 方法：`_extract_keyword_data_with_llm`

### 修改内容

#### 1. 更新 `self.current_data`
```python
# 修改前
self.extracted_data = results

# 修改后  
self.current_data = results
```

#### 2. 保持 `self.extracted_data` 用于后续处理
```python
# 保存匹配的记录（用于后续处理）
self.extracted_data = matched_records  # 只保留匹配的记录用于后续处理
```

#### 3. 更新注释说明
```python
# 所有记录都已经被处理并标记，更新当前数据
self.current_data = results
```

## 修改效果

### 修改前
- 只有匹配关键词的记录包含 `llm_keyword_analysis` 字段
- 未匹配的记录在最终导出时没有这个字段

### 修改后
- 所有记录都包含 `llm_keyword_analysis` 字段
- 匹配的记录：`has_special_keywords: true`
- 未匹配的记录：`has_special_keywords: false`
- 所有记录都有完整的分析信息

## 字段格式

所有记录现在都会包含以下格式的字段：

```json
{
  "llm_keyword_analysis": {
    "matched_keywords": [],
    "llm_response": "\"No\"",
    "analysis_timestamp": "2025-07-14T18:51:15.415070",
    "has_special_keywords": false
  }
}
```

## 兼容性

- ✅ 保持向后兼容性
- ✅ 不影响现有的工作流程
- ✅ 提高了数据处理的完整性
- ✅ 所有记录都有统一的数据结构

## 新发现的问题和解决方案

### 问题2：工作流程中的数据覆盖
在 `run_new_workflow` 函数中，发现了一个新问题：
1. 提取关键词数据（所有记录都被LLM分析并添加 `llm_keyword_analysis` 字段）
2. 分离关键词数据和非关键词数据
3. 对非关键词数据进行清洗（这会覆盖 `llm_keyword_analysis` 字段）

### 解决方案2
修改 `run_new_workflow` 函数中的步骤4：

```python
# 步骤 4: 对非关键词数据进行清洗（保留llm_keyword_analysis字段）
# 保存非关键词数据的llm_keyword_analysis字段
non_keyword_data_with_analysis = []
for rec in non_keyword_data:
    # 确保保留llm_keyword_analysis字段
    if 'llm_keyword_analysis' not in rec:
        rec['llm_keyword_analysis'] = {
            'matched_keywords': [],
            'llm_response': '"No"',
            'analysis_timestamp': datetime.now().isoformat(),
            'has_special_keywords': False
        }
    non_keyword_data_with_analysis.append(rec)

workflow.current_data = non_keyword_data_with_analysis
```

### 解决方案3
修改 `merge_processed_data_back` 方法，确保所有记录都有 `llm_keyword_analysis` 字段：

```python
else:
    # 如果不在提取数据中，保留原始记录并确保有llm_keyword_analysis字段
    if 'llm_keyword_analysis' not in original_record:
        original_record['llm_keyword_analysis'] = {
            'matched_keywords': [],
            'llm_response': '"No"',
            'analysis_timestamp': datetime.now().isoformat(),
            'has_special_keywords': False
        }
    merged_data.append(original_record)
```

## 总结

通过修改 `_extract_keyword_data_with_llm` 方法，现在所有记录都会包含 `llm_keyword_analysis` 字段，确保了数据的一致性和完整性。同时解决了工作流程中数据覆盖的问题，确保所有记录在最终导出时都有统一的字段结构。 