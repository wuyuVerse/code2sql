# SQLæ ¼å¼åˆ†æå’Œä¿®å¤é€»è¾‘éªŒè¯ - 2025-07-08

## ğŸ“‹ å®é™…SQLæ•°æ®æ ¼å¼

æ ¹æ®ç”¨æˆ·æä¾›çš„SQLæ ¼å¼ç¤ºä¾‹ï¼Œå®é™…çš„`sql_statement_list`ç»“æ„å¦‚ä¸‹ï¼š

```json
[
  "å›ºå®šçš„SQLè¯­å¥1",
  {
    "type": "param_dependent",
    "variants": [
      {"scenario": "åœºæ™¯1æè¿°", "sql": "å˜ä½“SQLè¯­å¥1"},
      {"scenario": "åœºæ™¯2æè¿°", "sql": "å˜ä½“SQLè¯­å¥2"}
    ]
  },
  "å›ºå®šçš„SQLè¯­å¥2"
]
```

## ğŸ” æ•°æ®ç»“æ„åˆ†æ

### 1. æ”¯æŒçš„SQLç±»å‹

| ç±»å‹ | ç»“æ„ | ç¤ºä¾‹ |
|------|------|------|
| **å›ºå®šSQL** | å­—ç¬¦ä¸² | `"SELECT * FROM users WHERE id = ?"` |
| **å‚æ•°ä¾èµ–SQL** | `param_dependent`å¯¹è±¡ | è§ä¸Šè¿°JSONç»“æ„ |
| **ç©ºSQL** | ç‰¹æ®Šå­—ç¬¦ä¸² | `"<NO SQL GENERATE>"` |

### 2. param_dependentè¯¦ç»†ç»“æ„

```json
{
  "type": "param_dependent",
  "variants": [
    {
      "scenario": "åœºæ™¯æè¿°æ–‡æœ¬",
      "sql": "å¯¹åº”åœºæ™¯çš„SQLè¯­å¥"
    }
  ]
}
```

**å…³é”®å­—æ®µ**ï¼š
- `type`: å›ºå®šå€¼ `"param_dependent"`
- `variants`: å˜ä½“æ•°ç»„
- `scenario`: åœºæ™¯æè¿°ï¼ˆå…ƒæ•°æ®ï¼‰
- `sql`: å®é™…æ‰§è¡Œçš„SQLè¯­å¥

## ğŸ”§ ä¿®å¤é€»è¾‘éªŒè¯

### 1. å­—ç¬¦ä¸²SQLå¤„ç† âœ…

```python
# è¾“å…¥: "SELECT * FROM users <REDUNDANT SQL>"
# åˆ é™¤é›†åˆ: {"SELECT * FROM users"}
# è¾“å‡º: "<NO SQL GENERATE>"

# è¾“å…¥: "SELECT * FROM users"  
# åˆ é™¤é›†åˆ: {}
# æ·»åŠ åˆ—è¡¨: ["INSERT INTO logs VALUES (?)"]
# è¾“å‡º: ["SELECT * FROM users", "INSERT INTO logs VALUES (?)"]
```

### 2. param_dependentå¤„ç† âœ…

#### åœºæ™¯1ï¼šéƒ¨åˆ†å˜ä½“åˆ é™¤
```python
# è¾“å…¥:
{
  "type": "param_dependent",
  "variants": [
    {"scenario": "åœºæ™¯1", "sql": "SELECT * FROM users <REDUNDANT SQL>"},
    {"scenario": "åœºæ™¯2", "sql": "SELECT * FROM orders"}
  ]
}

# åˆ é™¤é›†åˆ: {"SELECT * FROM users"}
# è¾“å‡º:
{
  "type": "param_dependent", 
  "variants": [
    {"scenario": "åœºæ™¯2", "sql": "SELECT * FROM orders"}
  ]
}
```

#### åœºæ™¯2ï¼šæ·»åŠ ç¼ºå¤±å˜ä½“
```python
# è¾“å…¥:
{
  "type": "param_dependent",
  "variants": [
    {"scenario": "åœºæ™¯1", "sql": "SELECT * FROM users"}
  ]
}

# æ·»åŠ åˆ—è¡¨: ["INSERT INTO audit_log VALUES (?)"]
# è¾“å‡º:
{
  "type": "param_dependent",
  "variants": [
    {"scenario": "åœºæ™¯1", "sql": "SELECT * FROM users"},
    {"scenario": "è¡¥å……çš„å¿…è¦SQL", "sql": "INSERT INTO audit_log VALUES (?)"}
  ]
}
```

#### åœºæ™¯3ï¼šå…¨éƒ¨å˜ä½“åˆ é™¤
```python
# è¾“å…¥:
{
  "type": "param_dependent",
  "variants": [
    {"scenario": "åœºæ™¯1", "sql": "SELECT * FROM users"},
    {"scenario": "åœºæ™¯2", "sql": "SELECT * FROM orders"}
  ]
}

# åˆ é™¤é›†åˆ: {"SELECT * FROM users", "SELECT * FROM orders"}
# è¾“å‡º: null (æ•´ä¸ªå¯¹è±¡è¢«åˆ é™¤)
```

### 3. æ··åˆåˆ—è¡¨å¤„ç† âœ…

```python
# è¾“å…¥:
[
  "SELECT * FROM users <REDUNDANT SQL>",
  "SELECT * FROM orders", 
  {
    "type": "param_dependent",
    "variants": [
      {"scenario": "æ›´æ–°åœºæ™¯", "sql": "UPDATE users SET status = ?"}
    ]
  }
]

# åˆ é™¤é›†åˆ: {"SELECT * FROM users"}
# æ·»åŠ åˆ—è¡¨: ["DELETE FROM temp_table"]
# è¾“å‡º:
[
  "SELECT * FROM orders",
  {
    "type": "param_dependent", 
    "variants": [
      {"scenario": "æ›´æ–°åœºæ™¯", "sql": "UPDATE users SET status = ?"}
    ]
  },
  "DELETE FROM temp_table"
]
```

## ğŸ¯ ä¿®å¤é€»è¾‘å…³é”®ç‚¹

### 1. ç±»å‹æ£€æŸ¥ä¸¥æ ¼æ€§
```python
def _process_dict_sql(self, sql_dict: Dict, remove_set: set, add_list: List) -> Optional[Dict]:
    if sql_dict.get("type") == "param_dependent":
        return self._process_param_dependent_sql(sql_dict, remove_set, add_list)
```

### 2. å˜ä½“çº§åˆ«ç²¾ç¡®å¤„ç†
```python
def _process_param_dependent_sql(self, param_dependent_item: Dict, remove_set: set, add_list: Optional[List] = None):
    for variant in variants:
        if isinstance(variant, dict) and "sql" in variant:
            variant_sql = variant["sql"]
            # æ£€æŸ¥å˜ä½“ä¸­çš„å…·ä½“SQLæ˜¯å¦éœ€è¦åˆ é™¤
            if isinstance(variant_sql, str):
                clean_sql = variant_sql.replace(' <REDUNDANT SQL>', '').strip()
                if clean_sql not in remove_set:
                    # ä¿ç•™è¯¥å˜ä½“
```

### 3. å…ƒæ•°æ®ä¿æŠ¤
```python
# ä¿ç•™scenarioç­‰å…ƒæ•°æ®å­—æ®µ
cleaned_variant = variant.copy()
cleaned_variant["sql"] = clean_sql
cleaned_variants.append(cleaned_variant)
```

### 4. è¾¹ç•Œæƒ…å†µå¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ | ç»“æœ |
|------|---------|------|
| æ‰€æœ‰å˜ä½“è¢«åˆ é™¤ | è¿”å›None | æ•´ä¸ªparam_dependentå¯¹è±¡ä»åˆ—è¡¨ä¸­ç§»é™¤ |
| éƒ¨åˆ†å˜ä½“åˆ é™¤ | ä¿ç•™æœªåˆ é™¤çš„å˜ä½“ | param_dependentå¯¹è±¡ç»§ç»­å­˜åœ¨ |
| æ·»åŠ æ–°å˜ä½“ | è¿½åŠ åˆ°variantsæ•°ç»„ | å¢åŠ æ–°çš„scenarioå’Œsql |
| scenarioå­—æ®µä¿æŠ¤ | å¤åˆ¶å®Œæ•´å˜ä½“å¯¹è±¡ | ä¿ç•™å…ƒæ•°æ®å®Œæ•´æ€§ |

## âœ… ç¬¦åˆæ€§éªŒè¯

### 1. æ•°æ®ç»“æ„å…¼å®¹æ€§
- âœ… æ”¯æŒå­—ç¬¦ä¸²SQL
- âœ… æ”¯æŒparam_dependentå¯¹è±¡
- âœ… æ”¯æŒæ··åˆæ•°ç»„ç»“æ„
- âœ… ä¿æŒJSONåºåˆ—åŒ–å…¼å®¹æ€§

### 2. ä¿®å¤æ“ä½œå®Œæ•´æ€§
- âœ… å†—ä½™SQLåˆ é™¤ï¼ˆremove_redundantï¼‰
- âœ… é”™è¯¯æ–°å¢SQLåˆ é™¤ï¼ˆremove_wrong_newï¼‰
- âœ… ç¼ºå¤±SQLæ·»åŠ ï¼ˆadd_missingï¼‰
- âœ… å…ƒæ•°æ®ä¿æŠ¤ï¼ˆscenarioå­—æ®µï¼‰

### 3. å®‰å…¨æ€§ä¿éšœ
- âœ… å¼‚å¸¸å¤„ç†å’Œé”™è¯¯æ¢å¤
- âœ… ç±»å‹æ£€æŸ¥å’Œè¾¹ç•Œä¿æŠ¤
- âœ… åŸå§‹æ•°æ®å¤‡ä»½é€»è¾‘
- âœ… ä¿®å¤ç»Ÿè®¡å’Œå¯è¿½æº¯æ€§

## ğŸ”§ ä¿®å¤é€»è¾‘ä»£ç ç‰‡æ®µ

```python
def _process_param_dependent_sql(self, param_dependent_item: Dict, remove_set: set, add_list: Optional[List] = None) -> Optional[Dict]:
    """å¤„ç†param_dependentç±»å‹çš„SQLé¡¹"""
    if not isinstance(param_dependent_item, dict) or param_dependent_item.get("type") != "param_dependent":
        return param_dependent_item
    
    cleaned_item = param_dependent_item.copy()
    cleaned_variants = []
    
    # å¤„ç†ç°æœ‰å˜ä½“
    variants = param_dependent_item.get("variants", [])
    for variant in variants:
        if isinstance(variant, dict) and "sql" in variant:
            variant_sql = variant["sql"]
            cleaned_variant = variant.copy()
            
            if isinstance(variant_sql, str):
                clean_sql = variant_sql.replace(' <REDUNDANT SQL>', '').strip()
                if clean_sql not in remove_set:
                    cleaned_variant["sql"] = clean_sql
                    cleaned_variants.append(cleaned_variant)
        else:
            # ä¿ç•™éSQLå˜ä½“ï¼ˆä¿æŠ¤å…ƒæ•°æ®ï¼‰
            cleaned_variants.append(variant)
    
    # æ·»åŠ ç¼ºå¤±çš„SQLå˜ä½“
    if add_list:
        for add_item in add_list:
            if isinstance(add_item, str):
                new_variant = {
                    "scenario": "è¡¥å……çš„å¿…è¦SQL",
                    "sql": add_item
                }
                cleaned_variants.append(new_variant)
    
    # è¿”å›æ¸…ç†åçš„å¯¹è±¡æˆ–None
    if cleaned_variants:
        cleaned_item["variants"] = cleaned_variants
        return cleaned_item
    else:
        return None  # æ‰€æœ‰å˜ä½“éƒ½è¢«åˆ é™¤
```

## ğŸ“Š æµ‹è¯•è¦†ç›–çŸ©é˜µ

| æµ‹è¯•åœºæ™¯ | è¾“å…¥ç±»å‹ | æ“ä½œç±»å‹ | é¢„æœŸç»“æœ | çŠ¶æ€ |
|---------|---------|----------|----------|------|
| å›ºå®šSQLåˆ é™¤ | å­—ç¬¦ä¸² | remove | `<NO SQL GENERATE>` | âœ… |
| å›ºå®šSQLä¿ç•™+æ·»åŠ  | å­—ç¬¦ä¸² | add | æ•°ç»„ | âœ… |
| param_dependentéƒ¨åˆ†åˆ é™¤ | å¯¹è±¡ | remove | å‡å°‘å˜ä½“ | âœ… |
| param_dependentå…¨åˆ é™¤ | å¯¹è±¡ | remove | null | âœ… |
| param_dependentæ·»åŠ  | å¯¹è±¡ | add | å¢åŠ å˜ä½“ | âœ… |
| æ··åˆåˆ—è¡¨å¤„ç† | æ•°ç»„ | æ··åˆ | ä¿®æ”¹åæ•°ç»„ | âœ… |
| ç©ºè¾“å…¥å¤„ç† | ç‰¹æ®Šå€¼ | add | å¡«å……æ•°æ® | âœ… |
| å¼‚å¸¸æƒ…å†µå¤„ç† | å„ç§ | å®¹é”™ | ä¿ç•™åŸå€¼ | âœ… |

## ğŸ¯ ç»“è®º

**ä¿®å¤é€»è¾‘å®Œå…¨ç¬¦åˆå®é™…SQLæ ¼å¼è¦æ±‚**ï¼š

1. **ç»“æ„å…¼å®¹æ€§**: å®Œç¾æ”¯æŒå­—ç¬¦ä¸²SQLå’Œparam_dependentå¯¹è±¡
2. **æ“ä½œå®Œæ•´æ€§**: è¦†ç›–æ‰€æœ‰ä¸‰ç§ä¿®å¤ç±»å‹ï¼ˆåˆ é™¤å†—ä½™ã€åˆ é™¤é”™è¯¯æ–°å¢ã€æ·»åŠ ç¼ºå¤±ï¼‰
3. **æ•°æ®å®‰å…¨æ€§**: ä¿æŠ¤å…ƒæ•°æ®ï¼Œæä¾›å¼‚å¸¸æ¢å¤ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
4. **å¯è¿½æº¯æ€§**: è¯¦ç»†çš„ä¿®å¤ç»Ÿè®¡å’Œæ—¥å¿—è®°å½•

**ç³»ç»Ÿå·²ç»å‡†å¤‡å¥½å¤„ç†å®é™…çš„Code2SQLæ•°æ®æ ¼å¼ï¼Œèƒ½å¤Ÿå®‰å…¨ã€å‡†ç¡®åœ°æ‰§è¡Œå¤æ‚çš„SQLä¿®å¤æ“ä½œã€‚** 