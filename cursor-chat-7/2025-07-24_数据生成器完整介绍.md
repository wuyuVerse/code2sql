# 数据生成器完整介绍

**日期**: 2025-07-24  
**主题**: 反向SQL生成器与合成数据生成器架构分析

## 概述

项目包含两个核心数据生成器，它们构成了一个完整的ORM到SQL的数据生成系统：

1. **合成数据生成器 (Synthetic Data Generator)** - 正向生成：从ORM代码生成SQL
2. **反向SQL生成器 (Reverse SQL Generator)** - 反向生成：从SQL生成ORM代码

## 第一个生成器：合成数据生成器

### 位置
```
data_processing/synthetic_data_generator/
├── __init__.py          # 模块初始化
├── generator.py         # 核心生成逻辑
├── cli.py              # 命令行接口
├── get_sql.py          # SQL提取和验证
├── example_usage.py    # 使用示例
└── README.md           # 详细文档
```

### 核心功能
- 🔄 **正向生成流程**：从ORM代码生成对应的SQL查询
- 🚀 **并行处理**：支持多线程并行生成，提高效率
- 🎯 **场景支持**：支持17种不同的ORM场景模式
- 📊 **统计监控**：实时显示生成进度和统计信息
- ✅ **数据验证**：自动验证生成数据的格式正确性
- 🔍 **SQL提取**：从生成的ORM代码中提取和验证SQL语句

### 支持的场景 (17种)
1. **对象var+chunk** - ORM方法仅依赖接收者对象的成员变量
2. **caller+global variable** - 依赖外部全局常量或变量
3. **caller+chunk** - 需要调用者传递的参数chunks
4. **caller的callee+caller** - 形成调用链的ORM方法
5. **单chunk** - 最基础的CRUD操作
6. **单chunk+meta(global var)** - 使用单一数据块和全局变量
7. **preload特殊函数** - 使用预加载功能优化关联查询
8. **association特殊函数** - 处理关联关系操作
9. **单chunk+meta(local var)** - 依赖方法内部的局部变量
10. **单chunk+meta(对象var)** - 依赖对象成员变量
11. **一度caller+chunk** - 一层调用关系
12. **二度caller+chunk** - 两层调用关系
13. **对象const+chunk** - 依赖对象常量成员变量
14. **switch** - 使用switch条件语句
15. **if-else+caller** - Caller代码中包含if-else条件判断
16. **if-else+orm** - ORM方法内部包含if-else条件判断
17. **no-where** - 需要外部传入部分where条件

### 主要组件

#### 1. SyntheticDataGenerator (generator.py)
- **核心生成类**：负责整个生成流程的协调
- **并行处理**：支持多线程并行生成
- **数据验证**：自动验证生成数据的格式正确性
- **统计监控**：实时显示生成进度和统计信息

#### 2. CLI接口 (cli.py)
- **命令行工具**：提供完整的命令行接口
- **参数配置**：支持多种参数配置
- **场景列表**：查看支持的场景列表
- **数据验证**：验证生成数据的选项

#### 3. SQL提取器 (get_sql.py)
- **SQL提取**：从生成的ORM代码中提取SQL语句
- **SQL验证**：验证SQL语句的正确性和完整性
- **格式化输出**：格式化SQL输出
- **批量处理**：支持批量处理和重试机制

### 使用方式

```bash
# 基本使用
python -m data_processing.synthetic_data_generator.cli

# 生成指定场景的数据
python -m data_processing.synthetic_data_generator.cli --scenario "单chunk" --count 5

# 并行模式生成
python -m data_processing.synthetic_data_generator.cli --parallel --workers 8 --count 10

# 查看支持的场景
python -m data_processing.synthetic_data_generator.cli --list-scenarios
```

## 第二个生成器：反向SQL生成器

### 位置
```
data_processing/reverse_sql_generator/
├── __init__.py              # 模块初始化
├── generator.py             # 核心生成逻辑
├── sql_generator.py         # SQL生成组件
├── orm_mapper.py           # ORM映射组件
├── caller_generator.py      # Caller生成组件
├── control_flow_processor.py # 控制流处理组件
├── case_integrator.py       # 案例整合组件
└── example_usage.py         # 使用示例
```

### 核心功能
- 🔄 **反向生成流程**：从SQL查询生成ORM和Caller代码
- 🎯 **控制流支持**：支持if-else、switch、dynamic等控制流场景
- 🔧 **模块化设计**：每个功能都有独立的组件
- ✅ **数据验证**：自动验证生成数据的格式正确性
- 🔄 **重试机制**：完善的错误重试和恢复机制

### 支持的场景
1. **if-else+caller** - Caller代码中包含if-else条件判断
2. **if-else+orm** - ORM方法内部包含if-else条件判断
3. **switch** - 使用switch条件语句
4. **dynamic_query** - 动态查询场景
5. **complex_control** - 复杂控制流场景
6. **if-else+switch_mixed** - if-else和switch混合场景
7. **conditional_chain** - 条件链式查询场景
8. **multi_branch_transaction** - 多分支事务处理场景
9. **state_machine_branch** - 状态机式分支场景
10. **conditional_meta** - 条件分支+meta场景
11. **fixed_params** - 固定参数场景

### 主要组件

#### 1. ReverseSQLGenerator (generator.py)
- **核心协调器**：协调整个反向生成流程
- **重试机制**：带指数退避的重试机制
- **失败处理**：记录和重试失败的案例
- **会话管理**：正确的aiohttp会话管理

#### 2. SQLGenerator (sql_generator.py)
- **SQL生成**：生成完整的SQL查询
- **变量替换**：使用随机变量名替换模板
- **格式验证**：验证生成的SQL格式

#### 3. ORMMapper (orm_mapper.py)
- **SQL到ORM映射**：将SQL转换为Go ORM代码
- **多分支支持**：支持多分支事务处理的特殊映射
- **数据验证**：验证ORM代码的格式

#### 4. CallerGenerator (caller_generator.py)
- **Caller生成**：生成调用者代码
- **控制流支持**：支持各种控制流的Caller生成
- **代码清理**：清理生成的代码格式

#### 5. ControlFlowProcessor (control_flow_processor.py)
- **控制流处理**：处理各种控制流场景
- **SQL变体生成**：生成不同分支的SQL变体
- **场景适配**：适配不同的控制流场景

#### 6. CaseIntegrator (case_integrator.py)
- **案例整合**：整合生成的各个组件
- **格式标准化**：标准化输出格式
- **数据验证**：验证完整案例的格式

### 使用方式

```python
# 基本使用
from data_processing.reverse_sql_generator.generator import ReverseSQLGenerator
from config.data_processing.reverse_sql_generator.config import ReverseSQLConfig

config = ReverseSQLConfig()
generator = ReverseSQLGenerator(config)

# 生成单个案例
case = await generator.generate_complete_case("if-else+caller", "simple")

# 批量生成
cases = await generator.generate_multiple_cases([
    ("if-else+caller", "simple"),
    ("switch", "medium"),
    ("dynamic_query", "complex")
], parallel=True, max_workers=4)

# 重试失败的案例
retry_results = await generator.retry_failed_cases()
```

## 两个生成器的关系

### 数据流向
```
合成数据生成器 (正向)
ORM代码 → SQL查询 → 数据验证 → 输出

反向SQL生成器 (反向)
SQL查询 → ORM代码 → Caller代码 → 控制流变体 → 输出
```

### 互补性
1. **正向生成**：从ORM代码生成SQL，用于训练模型理解ORM到SQL的映射
2. **反向生成**：从SQL生成ORM代码，用于训练模型理解SQL到ORM的映射
3. **数据增强**：两个生成器可以相互验证和增强数据质量

### 共同特点
- **模块化设计**：配置、提示词、生成逻辑分离
- **使用项目的LLMClient**：统一的LLM调用接口
- **类型安全**：完整的类型注解和错误处理
- **性能优化**：并行处理和内存优化
- **数据质量保证**：自动数据验证和格式标准化

## 技术架构

### 1. 模块化设计
```
配置层 (config/)
├── 服务器配置 (llm/servers.yaml)
├── 生成器配置 (data_processing/*/config.py)
└── 提示词模板 (data_processing/*/prompts.py)

核心层 (data_processing/)
├── 合成数据生成器 (synthetic_data_generator/)
└── 反向SQL生成器 (reverse_sql_generator/)

工具层 (utils/)
├── LLM客户端 (llm_client.py)
├── 格式验证器 (format_validators.py)
└── 其他工具函数
```

### 2. 性能优化
- **并行处理**：支持多线程/多进程并行生成
- **内存优化**：分批处理和内存管理
- **重试机制**：指数退避重试和错误恢复
- **会话管理**：正确的aiohttp会话生命周期管理

### 3. 数据质量保证
- **自动验证**：生成数据的格式和内容验证
- **统计监控**：实时显示生成进度和统计信息
- **错误处理**：详细的错误日志和异常处理
- **格式标准化**：确保输出格式的一致性

## 使用建议

### 1. 选择合适的生成器
- **需要ORM到SQL数据**：使用合成数据生成器
- **需要SQL到ORM数据**：使用反向SQL生成器
- **需要完整训练数据**：两个生成器结合使用

### 2. 性能优化
- **并行模式**：对于大量数据生成，使用并行模式
- **分批处理**：避免内存溢出，分批处理大量数据
- **重试机制**：利用内置的重试机制处理临时错误

### 3. 数据质量
- **验证输出**：始终验证生成数据的格式和内容
- **统计监控**：关注生成成功率和错误统计
- **失败重试**：使用重试工具处理失败的案例

## 总结

这两个数据生成器构成了一个完整的ORM-SQL双向数据生成系统：

1. **合成数据生成器**：专注于从ORM代码生成SQL查询，支持17种不同的ORM场景
2. **反向SQL生成器**：专注于从SQL查询生成ORM和Caller代码，支持11种控制流场景

两个生成器都具有：
- 完善的错误处理和重试机制
- 高效的并行处理能力
- 自动的数据验证和格式标准化
- 模块化的架构设计

这个系统为训练代码到SQL转换模型提供了丰富、高质量的训练数据，支持双向的数据生成和验证。 