# 代码清理问题修复总结

## 问题分析

### 1. 问题现象
**问题描述**: 生成的 `orm_code` 和 `caller` 前面仍然包含包导入部分，不符合预期格式。

**具体表现**:
```go
// 生成的orm_code包含：
"gorm.io/gorm"
"time"
)
func GetByCategory(db *gorm.DB, branchIDs []uint) ([]Vendor, error) {
    // 函数实现...
}

// 生成的caller包含：
"errors"
"gorm.io/gorm"
"time"
)
func MassModify(db *gorm.DB, branchIDs []uint) ([]Transaction, error) {
    // 函数实现...
}
```

### 2. 根本原因
- `clean_code` 函数的逻辑不完善
- 没有正确处理多行import块
- 没有正确处理package声明
- 没有正确处理结构体定义

## 修复方案

### 1. 改进clean_code函数

#### 1.1 添加import块处理
```python
# 处理import块
if line.startswith('import '):
    if '(' in line:
        in_import_block = True
    continue
elif in_import_block:
    if line == ')':
        in_import_block = False
    continue
```

#### 1.2 改进package声明处理
```python
# 跳过package声明
if line.startswith('package '):
    continue
```

#### 1.3 改进结构体定义处理
```python
# 跳过结构体定义
if line.startswith('type ') and 'struct' in line:
    in_struct = True
    continue
elif in_struct and line.startswith('}'):
    in_struct = False
    continue
elif in_struct:
    continue
```

#### 1.4 改进TableName方法处理
```python
# 跳过TableName方法
if 'func (' in line and 'TableName()' in line:
    skip_next = True
    continue
elif skip_next and line.startswith('}'):
    skip_next = False
    continue
elif skip_next:
    continue
```

### 2. 改进代码保留逻辑

#### 2.1 保留原始格式
```python
# 保留其他行（包括空行，但移除前导空格）
if not in_struct and not skip_next and not in_import_block:
    if original_line.strip():  # 非空行
        cleaned_lines.append(original_line)
    else:  # 空行
        cleaned_lines.append('')
```

#### 2.2 清理空行
```python
# 移除开头和结尾的空行
while cleaned_lines and not cleaned_lines[0].strip():
    cleaned_lines.pop(0)
while cleaned_lines and not cleaned_lines[-1].strip():
    cleaned_lines.pop()
```

## 修复效果

### 1. 清理前
```go
"gorm.io/gorm"
"time"
)
func GetByCategory(db *gorm.DB, branchIDs []uint) ([]Vendor, error) {
    var vendors []Vendor
    tx := db.Begin()
    // ... 函数实现
}
```

### 2. 清理后
```go
func GetByCategory(db *gorm.DB, branchIDs []uint) ([]Vendor, error) {
    var vendors []Vendor
    tx := db.Begin()
    // ... 函数实现
}
```

### 3. 验证结果
- **package声明**: 已移除
- **import块**: 已移除
- **结构体定义**: 已移除
- **TableName方法**: 已移除
- **函数定义**: 保留完整

## 技术细节

### 1. 状态管理
- `in_struct`: 跟踪是否在结构体定义内
- `skip_next`: 跟踪是否跳过TableName方法
- `in_import_block`: 跟踪是否在import块内

### 2. 处理逻辑
- **逐行处理**: 按行分析代码结构
- **状态跟踪**: 使用状态变量跟踪当前处理位置
- **条件判断**: 根据行内容决定是否保留

### 3. 格式保持
- **原始格式**: 保留原始代码的缩进和格式
- **空行处理**: 适当保留空行以保持可读性
- **边界清理**: 移除开头和结尾的多余空行

## 测试验证

### 1. 测试脚本
创建了 `test_code_cleaning.py` 脚本：
```bash
python test_code_cleaning.py
```

### 2. 测试内容
- **原始代码**: 包含package、import、struct的完整代码
- **清理后代码**: 只包含函数定义的代码
- **验证结果**: 检查是否完全移除了不需要的部分

### 3. 预期结果
- **ORM代码**: 只包含函数定义，不包含package、import、struct
- **Caller代码**: 只包含函数定义，不包含package、import、struct
- **格式正确**: 保持正确的Go代码格式

## 后续优化建议

1. **更精确的解析**: 使用AST解析器进行更精确的代码分析
2. **配置化清理**: 允许用户配置需要清理的代码部分
3. **格式验证**: 添加清理后代码的格式验证
4. **错误处理**: 改进清理过程中的错误处理
5. **性能优化**: 优化大代码块的清理性能 