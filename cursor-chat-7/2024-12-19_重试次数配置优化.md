# 重试次数配置优化

## 问题背景

用户发现当前的重试次数只有3次，对于复杂的LLM调用场景来说可能不够，特别是对于 `multi_branch_transaction` 等复杂场景，错误率较高。

## 优化方案

### 1. 增加重试次数
- **原始配置**: 所有组件都使用固定的3次重试
- **优化配置**: 增加到10次重试，提高成功率

### 2. 配置化管理
- **配置文件**: `config/data_processing/reverse_sql_generator/retry_config.yaml`
- **动态加载**: 从配置文件读取重试参数
- **灵活配置**: 支持不同场景的不同重试策略

### 3. 统一重试逻辑
修改了以下组件中的重试次数：
- ✅ `generator.py`: `generate_complete_case` 方法
- ✅ `sql_generator.py`: `generate_complete_sql` 和 `generate_sql_variants` 方法
- ✅ `orm_mapper.py`: `sql_to_orm` 方法
- ✅ `caller_generator.py`: `generate_caller` 方法

## 配置文件结构

```yaml
# config/data_processing/reverse_sql_generator/retry_config.yaml
retry_config:
  # 最大重试次数
  max_retries: 10
  
  # 重试间隔（秒）
  retry_delay: 2
  
  # 是否启用指数退避
  exponential_backoff: true
  
  # 最大重试延迟（秒）
  max_retry_delay: 30
  
  # 重试条件
  retry_conditions:
    - "网络错误"
    - "LLM响应超时"
    - "JSON解析失败"
    - "格式验证失败"
    - "空响应"
  
  # 不重试的条件
  no_retry_conditions:
    - "参数错误"
    - "配置错误"
    - "权限错误"
```

## 代码修改

### 1. 配置类修改
```python
class ReverseSQLConfig:
    def __init__(self, 
                 llm_server: str = None,
                 output_path: str = "reverse_sql_cases.json",
                 max_workers: int = 4,
                 temperature: float = 0.7,
                 top_p: float = 0.8,
                 max_tokens: int = 4096,
                 max_retries: int = None):  # 改为None，从配置文件读取
        # ...
        # 从配置文件读取重试配置
        if max_retries is None:
            self.max_retries = self._load_retry_config()
        else:
            self.max_retries = max_retries
    
    def _load_retry_config(self) -> int:
        """从配置文件加载重试配置"""
        try:
            import yaml
            import os
            
            current_dir = os.path.dirname(os.path.abspath(__file__))
            config_file = os.path.join(current_dir, "retry_config.yaml")
            
            if os.path.exists(config_file):
                with open(config_file, 'r', encoding='utf-8') as f:
                    config = yaml.safe_load(f)
                    return config.get('retry_config', {}).get('max_retries', 10)
            else:
                print(f"警告: 重试配置文件不存在: {config_file}")
                return 10
        except Exception as e:
            print(f"警告: 加载重试配置失败: {e}")
            return 10
```

### 2. 组件重试逻辑修改
```python
# 所有组件中的重试逻辑都改为：
max_retries = self.config.max_retries  # 从配置获取最大重试次数
```

## 预期效果

1. **提高成功率**: 从3次重试增加到10次，显著提高复杂场景的成功率
2. **配置灵活**: 可以通过修改YAML文件调整重试策略
3. **统一管理**: 所有组件的重试逻辑都从配置中读取
4. **错误处理**: 更好的错误分类和重试条件判断

## 测试验证

创建了专门的测试脚本 `test_multi_branch_transaction.py` 来验证：
- 重试次数是否正确应用
- 复杂场景的成功率是否提高
- 配置加载是否正常工作

## 后续优化

1. **指数退避**: 实现指数退避算法，避免频繁重试
2. **错误分类**: 根据错误类型决定是否重试
3. **监控统计**: 添加重试统计和成功率监控
4. **动态调整**: 根据历史成功率动态调整重试次数 