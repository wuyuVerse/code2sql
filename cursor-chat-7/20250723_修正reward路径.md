# Reward路径修正记录

## 问题描述
用户发现reward文件的路径配置不正确，当前配置为写入项目根目录下的`./reward_logs/`，但应该写入到`/home/wuyu/code2sql/model/rl/reward_logs/`目录。

## 问题定位
通过代码分析发现，问题出现在`model/rl/code2sql_reward_v2.py`文件中的`_build_default_dump_path()`函数：

```python
def _build_default_dump_path() -> str:
    """始终写入项目根目录下 ./reward_logs/，文件名含日期时间"""
    base_dir = "./reward_logs"  # 这里路径不正确
    # ...
```

## 解决方案
修改了`_build_default_dump_path()`函数，使用相对路径来定位正确的reward_logs目录：

### 修改前：
```python
def _build_default_dump_path() -> str:
    """始终写入项目根目录下 ./reward_logs/，文件名含日期时间"""
    base_dir = "./reward_logs"
    try:
        os.makedirs(base_dir, exist_ok=True)
    except Exception:
        pass  # 如果创建失败则继续使用当前工作目录
    ts = datetime.datetime.now().strftime("%Y%m%d_%H%M")
    return os.path.join(base_dir, f"reward_{ts}_v2.jsonl")
```

### 修改后：
```python
def _build_default_dump_path() -> str:
    """写入model/rl/reward_logs/目录，文件名含日期时间"""
    # 获取当前文件所在目录的reward_logs子目录
    current_dir = os.path.dirname(__file__)
    base_dir = os.path.join(current_dir, "reward_logs")
    try:
        os.makedirs(base_dir, exist_ok=True)
    except Exception:
        pass  # 如果创建失败则继续使用当前工作目录
    ts = datetime.datetime.now().strftime("%Y%m%d_%H%M")
    return os.path.join(base_dir, f"reward_{ts}_v2.jsonl")
```

## 关键改进
1. **使用`os.path.dirname(__file__)`**：获取当前文件所在目录
2. **相对路径定位**：通过`os.path.join(current_dir, "reward_logs")`定位到正确的reward_logs目录
3. **更新注释**：将注释从"项目根目录下"改为"model/rl/reward_logs/目录"

## 验证结果
通过测试确认修改后的路径配置正确：
```bash
python -c "import sys; sys.path.append('.'); from model.rl import code2sql_reward_v2; print('Reward file path:', code2sql_reward_v2.DEBUG_DUMP_FILE)"
```

输出：
```
Reward file path: /home/wuyu/code2sql/model/rl/reward_logs/reward_20250723_2122_v2.jsonl
```

## 目录结构确认
```
model/rl/reward_logs/
├── reward_20250721_2215_v2.jsonl  # 现有文件
└── reward_20250723_2122_v2.jsonl  # 新生成的文件
```

## 相关文件
- 修改的文件：`model/rl/code2sql_reward_v2.py`
- 目标目录：`model/rl/reward_logs/`
- 现有文件：`reward_20250721_2215_v2.jsonl` (83MB)

## 注意事项
- `composite_reward.py`中的路径配置保持不变，因为它是用于不同的评估系统
- 修改后的路径使用相对路径，更加灵活和可移植
- 确保了reward文件会正确写入到指定的目录结构中 