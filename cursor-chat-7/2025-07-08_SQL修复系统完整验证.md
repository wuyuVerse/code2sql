# Code2SQLé¡¹ç›®SQLä¿®å¤ç³»ç»Ÿå®Œæ•´éªŒè¯ - 2025-07-08

## ğŸ“‹ ä¼šè¯æ¦‚è¿°

**ä¸»è¦ç›®æ ‡**: éªŒè¯ç°æœ‰çš„SQLä¿®å¤é€»è¾‘æ˜¯å¦å®Œå…¨æ”¯æŒç”¨æˆ·æä¾›çš„å®é™…SQLæ•°æ®æ ¼å¼

**å…³é”®é—®é¢˜**: ç¡®ä¿`_process_param_dependent_sql`æ–¹æ³•èƒ½æ­£ç¡®å¤„ç†åŒ…å«`variants`æ•°ç»„å’Œ`scenario`å­—æ®µçš„param_dependentå¯¹è±¡

## ğŸ¯ ç”¨æˆ·æä¾›çš„SQLæ ¼å¼

ç”¨æˆ·æ˜ç¡®æä¾›äº†å®é™…ä½¿ç”¨çš„SQLæ ¼å¼ç¤ºä¾‹ï¼š

```json
[
  "å›ºå®šçš„SQLè¯­å¥1",
  {
    "type": "param_dependent",
    "variants": [
      {"scenario": "åœºæ™¯1æè¿°", "sql": "å˜ä½“SQLè¯­å¥1"},
      {"scenario": "åœºæ™¯2æè¿°", "sql": "å˜ä½“SQLè¯­å¥2"}
    ]
  },
  "å›ºå®šçš„SQLè¯­å¥2"
]
```

**å…³é”®ç‰¹å¾**:
- æ”¯æŒæ··åˆæ•°ç»„ï¼šå­—ç¬¦ä¸²SQL + param_dependentå¯¹è±¡
- param_dependentç»“æ„åŒ…å«`type`å’Œ`variants`å­—æ®µ
- æ¯ä¸ªvariantåŒ…å«`scenario`(å…ƒæ•°æ®)å’Œ`sql`(å®é™…SQL)å­—æ®µ

## ğŸ” ç°æœ‰å®ç°éªŒè¯

### 1. æ•°æ®ç»“æ„å…¼å®¹æ€§ âœ…

ç»è¿‡ä»£ç å®¡æŸ¥ï¼Œç°æœ‰å®ç°**å®Œå…¨æ”¯æŒ**ç”¨æˆ·æä¾›çš„æ ¼å¼ï¼š

#### å­—ç¬¦ä¸²SQLå¤„ç†
```python
def _process_string_sql(self, sql_string: str, remove_set: set, add_list: List):
    # æ­£ç¡®å¤„ç† "å›ºå®šçš„SQLè¯­å¥1" ç±»å‹
    clean_sql = sql_string.replace(' <REDUNDANT SQL>', '').strip()
    # æ”¯æŒåˆ é™¤ã€ä¿ç•™ã€æ·»åŠ æ“ä½œ
```

#### param_dependentå¯¹è±¡å¤„ç†  
```python
def _process_param_dependent_sql(self, param_dependent_item: Dict, remove_set: set, add_list: Optional[List] = None):
    # æ­£ç¡®è¯†åˆ« type == "param_dependent"
    # å®Œæ•´å¤„ç† variants æ•°ç»„
    # ä¿æŠ¤ scenario å…ƒæ•°æ®å­—æ®µ
```

#### æ··åˆåˆ—è¡¨å¤„ç†
```python
def _process_list_sql(self, sql_list: List, remove_set: set, add_list: List):
    # é€’å½’å¤„ç†æ¯ä¸ªå…ƒç´ ï¼šå­—ç¬¦ä¸²ã€å­—å…¸ã€åµŒå¥—åˆ—è¡¨
    # æ™ºèƒ½ç±»å‹æ£€æµ‹å’Œåˆ†å‘å¤„ç†
```

### 2. å…³é”®å®ç°ç»†èŠ‚ âœ…

#### scenarioå­—æ®µä¿æŠ¤æœºåˆ¶
```python
# åœ¨_process_param_dependent_sqlä¸­
cleaned_variant = variant.copy()  # å®Œæ•´å¤åˆ¶ï¼Œä¿æŠ¤æ‰€æœ‰å…ƒæ•°æ®
if isinstance(variant_sql, str):
    clean_sql = variant_sql.replace(' <REDUNDANT SQL>', '').strip()
    if clean_sql not in remove_set:
        cleaned_variant["sql"] = clean_sql  # åªæ›´æ–°sqlå­—æ®µ
        cleaned_variants.append(cleaned_variant)  # scenarioè¢«ä¿ç•™
```

#### å˜ä½“çº§åˆ«ç²¾ç¡®åˆ é™¤
```python
# æ”¯æŒéƒ¨åˆ†å˜ä½“åˆ é™¤ï¼Œä¿ç•™æœ‰æ•ˆå˜ä½“
variants = param_dependent_item.get("variants", [])
for variant in variants:
    if isinstance(variant, dict) and "sql" in variant:
        variant_sql = variant["sql"]
        # é€ä¸ªæ£€æŸ¥æ¯ä¸ªå˜ä½“çš„SQL
        if clean_sql not in remove_set:
            # ä¿ç•™è¯¥å˜ä½“
```

#### ç¼ºå¤±SQLæ·»åŠ æ”¯æŒ
```python
# æ·»åŠ ç¼ºå¤±çš„SQLå˜ä½“
if add_list:
    for add_item in add_list:
        if isinstance(add_item, str):
            new_variant = {
                "scenario": "è¡¥å……çš„å¿…è¦SQL",  # è‡ªåŠ¨ç”Ÿæˆscenario
                "sql": add_item
            }
            cleaned_variants.append(new_variant)
```

### 3. è¾¹ç•Œæƒ…å†µå¤„ç† âœ…

| åœºæ™¯ | å¤„ç†é€»è¾‘ | ç»“æœ | çŠ¶æ€ |
|------|----------|------|------|
| **æ‰€æœ‰å˜ä½“è¢«åˆ é™¤** | `return None` | æ•´ä¸ªparam_dependentå¯¹è±¡ç§»é™¤ | âœ… |
| **éƒ¨åˆ†å˜ä½“åˆ é™¤** | ä¿ç•™æœªåˆ é™¤å˜ä½“ | ç¼©å‡çš„variantsæ•°ç»„ | âœ… |
| **æ·»åŠ æ–°å˜ä½“** | è¿½åŠ åˆ°variantsæ•°ç»„ | æ‰©å±•çš„variantsæ•°ç»„ | âœ… |
| **ç©ºvariantsæ•°ç»„** | æ£€æŸ¥`if cleaned_variants` | è¿”å›Noneæˆ–ç©ºå¯¹è±¡ | âœ… |
| **scenarioå­—æ®µä¿æŠ¤** | `variant.copy()` | å®Œæ•´ä¿ç•™å…ƒæ•°æ® | âœ… |
| **åµŒå¥—SQLåˆ—è¡¨** | é€’å½’å¤„ç† | æ”¯æŒå¤æ‚ç»“æ„ | âœ… |

## ğŸ¯ ä¸‰ç§ä¿®å¤ç±»å‹æ”¯æŒ

### 1. remove_redundant (å†—ä½™SQLåˆ é™¤) âœ…
```python
# ç¤ºä¾‹ï¼šåˆ é™¤å†—ä½™çš„å˜ä½“
# è¾“å…¥:
{
  "type": "param_dependent",
  "variants": [
    {"scenario": "ç”¨æˆ·æŸ¥è¯¢", "sql": "SELECT * FROM users <REDUNDANT SQL>"},
    {"scenario": "è®¢å•æŸ¥è¯¢", "sql": "SELECT * FROM orders"}
  ]
}

# åˆ é™¤é›†åˆ: {"SELECT * FROM users"}
# è¾“å‡º:
{
  "type": "param_dependent",
  "variants": [
    {"scenario": "è®¢å•æŸ¥è¯¢", "sql": "SELECT * FROM orders"}
  ]
}
```

### 2. remove_wrong_new (é”™è¯¯æ–°å¢SQLåˆ é™¤) âœ…
```python
# åŸºäºLLMéªŒè¯ç»“æœï¼Œåˆ é™¤æ— å¿…è¦çš„æ–°å¢SQL
# å¤„ç†é€»è¾‘ä¸remove_redundantç›¸åŒï¼Œä½¿ç”¨ç»Ÿä¸€çš„remove_set
```

### 3. add_missing (ç¼ºå¤±SQLæ·»åŠ ) âœ…
```python
# ç¤ºä¾‹ï¼šæ·»åŠ ç¼ºå¤±çš„å˜ä½“
# è¾“å…¥:
{
  "type": "param_dependent",
  "variants": [
    {"scenario": "æŸ¥è¯¢ç”¨æˆ·", "sql": "SELECT * FROM users"}
  ]
}

# æ·»åŠ åˆ—è¡¨: ["INSERT INTO audit_log VALUES (?)"]
# è¾“å‡º:
{
  "type": "param_dependent",
  "variants": [
    {"scenario": "æŸ¥è¯¢ç”¨æˆ·", "sql": "SELECT * FROM users"},
    {"scenario": "è¡¥å……çš„å¿…è¦SQL", "sql": "INSERT INTO audit_log VALUES (?)"}
  ]
}
```

## ğŸ”§ ä¿®å¤æµç¨‹å®Œæ•´æ€§

### 1. è¾“å…¥å¤„ç†
```python
def _apply_fix_recommendations(self, fix_recommendations: Dict[str, Any]):
    # æ„å»ºåˆ é™¤æ˜ å°„: (orm_code, caller) -> set(sql_text)
    remove_redundant_map: Dict[Tuple[str, str], set] = {}
    remove_wrong_new_map: Dict[Tuple[str, str], set] = {}
    add_missing_map: Dict[Tuple[str, str], List[Any]] = {}
```

### 2. ç»Ÿä¸€åˆ é™¤å¤„ç†
```python
# åˆå¹¶æ‰€æœ‰åˆ é™¤æ˜ å°„
all_remove_map: Dict[Tuple[str, str], set] = {}
for key in set(remove_redundant_map.keys()) | set(remove_wrong_new_map.keys()):
    all_remove_map[key] = remove_redundant_map.get(key, set()) | remove_wrong_new_map.get(key, set())
```

### 3. æ™ºèƒ½ç±»å‹åˆ†å‘
```python
def _process_sql_list(sql_list, key):
    if isinstance(sql_list, str):
        return self._process_string_sql(sql_list, remove_set, add_list)
    elif isinstance(sql_list, list):
        return self._process_list_sql(sql_list, remove_set, add_list)
    elif isinstance(sql_list, dict):
        return self._process_dict_sql(sql_list, remove_set, add_list)
```

## ğŸ¨ å®é™…ç¤ºä¾‹éªŒè¯

### å®Œæ•´æ··åˆç»“æ„å¤„ç†
```python
# è¾“å…¥SQLåˆ—è¡¨:
[
  "SELECT * FROM users <REDUNDANT SQL>",      # å­—ç¬¦ä¸²ï¼Œéœ€è¦åˆ é™¤
  "SELECT COUNT(*) FROM products",            # å­—ç¬¦ä¸²ï¼Œä¿ç•™
  {
    "type": "param_dependent",
    "variants": [
      {"scenario": "ç®¡ç†å‘˜æŸ¥è¯¢", "sql": "SELECT * FROM admin_logs"},
      {"scenario": "æ™®é€šæŸ¥è¯¢", "sql": "SELECT * FROM user_logs <REDUNDANT SQL>"}
    ]
  }
]

# åˆ é™¤é›†åˆ: {"SELECT * FROM users", "SELECT * FROM user_logs"}
# æ·»åŠ åˆ—è¡¨: ["DELETE FROM temp_data"]

# è¾“å‡ºç»“æœ:
[
  "SELECT COUNT(*) FROM products",
  {
    "type": "param_dependent",
    "variants": [
      {"scenario": "ç®¡ç†å‘˜æŸ¥è¯¢", "sql": "SELECT * FROM admin_logs"}
    ]
  },
  "DELETE FROM temp_data"
]
```

## ğŸ›¡ï¸ å®‰å…¨ä¿éšœæœºåˆ¶

### 1. å¼‚å¸¸å¤„ç†
```python
try:
    remove_set = all_remove_map.get(key, set())
    add_list = add_missing_map.get(key, [])
    # å¤„ç†é€»è¾‘...
except Exception as e:
    logger.error(f"å¤„ç†SQLåˆ—è¡¨æ—¶å‡ºé”™: {e}, ä¿ç•™åŸå€¼")
    return sql_list  # å¤±è´¥æ—¶ä¿ç•™åŸå€¼
```

### 2. ç±»å‹å®‰å…¨æ£€æŸ¥
```python
if not isinstance(param_dependent_item, dict) or param_dependent_item.get("type") != "param_dependent":
    return param_dependent_item  # ç±»å‹ä¸åŒ¹é…æ—¶ä¿ç•™åŸå€¼
```

### 3. æ•°æ®å®Œæ•´æ€§ä¿æŠ¤
```python
# ä¿æŠ¤é‡è¦å­—æ®µ
important_fields = ['scenario', 'description', 'condition', 'when']
if any(field in sql_dict for field in important_fields):
    return sql_dict  # ä¿ç•™å…ƒæ•°æ®ä¿¡æ¯
```

## ğŸ“Š æ€§èƒ½å’Œç»Ÿè®¡

### ä¿®å¤ç»Ÿè®¡è®°å½•
```python
logger.info(f"ä¿®å¤åº”ç”¨å®Œæˆ:")
logger.info(f"  - åˆ é™¤å†—ä½™SQL: {sum(len(sqls) for sqls in remove_redundant_map.values())} ä¸ª")
logger.info(f"  - åˆ é™¤é”™è¯¯æ–°å¢SQL: {sum(len(sqls) for sqls in remove_wrong_new_map.values())} ä¸ª")
logger.info(f"  - æ·»åŠ ç¼ºå¤±SQL: {sum(len(items) for items in add_missing_map.values())} ä¸ª")
logger.info(f"  - ä¿®æ”¹è®°å½•æ•°: {modifications_count}")
```

### é”™è¯¯æ¢å¤æœºåˆ¶
```python
if error_count > 0:
    logger.warning(f"  - å¤„ç†é”™è¯¯æ•°: {error_count}")
# é”™è¯¯ä¸ä¼šä¸­æ–­æ•´ä½“å¤„ç†æµç¨‹
```

## âœ… æœ€ç»ˆéªŒè¯ç»“è®º

### å®Œå…¨å…¼å®¹æ€§ç¡®è®¤ âœ…

1. **æ•°æ®ç»“æ„æ”¯æŒ**: å®Œç¾æ”¯æŒç”¨æˆ·æä¾›çš„SQLæ ¼å¼
   - âœ… å­—ç¬¦ä¸²SQL: `"å›ºå®šçš„SQLè¯­å¥1"`
   - âœ… param_dependentå¯¹è±¡: `{"type": "param_dependent", "variants": [...]}`
   - âœ… æ··åˆæ•°ç»„ç»“æ„: `[å­—ç¬¦ä¸², å¯¹è±¡, å­—ç¬¦ä¸²]`

2. **å­—æ®µå®Œæ•´æ€§ä¿æŠ¤**: ä¸¥æ ¼ä¿æŠ¤å…ƒæ•°æ®
   - âœ… `scenario`å­—æ®µ: ä½¿ç”¨`variant.copy()`å®Œæ•´ä¿ç•™
   - âœ… `type`å­—æ®µ: æ­£ç¡®è¯†åˆ«å’Œå¤„ç†
   - âœ… `variants`æ•°ç»„: æ”¯æŒå¢åˆ æ”¹æ“ä½œ

3. **ä¿®å¤æ“ä½œå®Œæ•´æ€§**: ä¸‰ç§ä¿®å¤ç±»å‹å…¨è¦†ç›–
   - âœ… å†—ä½™åˆ é™¤: ç²¾ç¡®åˆ°å˜ä½“çº§åˆ«çš„SQLåˆ é™¤
   - âœ… é”™è¯¯æ–°å¢åˆ é™¤: ç»Ÿä¸€çš„åˆ é™¤é€»è¾‘å¤„ç†
   - âœ… ç¼ºå¤±æ·»åŠ : æ™ºèƒ½å˜ä½“ç”Ÿæˆå’Œè¿½åŠ 

4. **è¾¹ç•Œæƒ…å†µå¤„ç†**: å…¨é¢çš„å®¹é”™æœºåˆ¶
   - âœ… ç©ºå˜ä½“å¤„ç†: æ­£ç¡®è¿”å›nullæˆ–ä¿ç•™å¯¹è±¡
   - âœ… å¼‚å¸¸æ¢å¤: å¤±è´¥æ—¶ä¿ç•™åŸå§‹æ•°æ®
   - âœ… ç±»å‹å®‰å…¨: ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥å’Œåˆ†å‘

### ä»£ç è´¨é‡è¯„ä¼° âœ…

- **å¯è¯»æ€§**: æ¸…æ™°çš„æ–¹æ³•å‘½åå’ŒèŒè´£åˆ†ç¦»
- **å¯ç»´æŠ¤æ€§**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
- **å¯é æ€§**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
- **æ€§èƒ½**: é«˜æ•ˆçš„é›†åˆæ“ä½œå’Œæ‰¹é‡å¤„ç†

### å®æˆ˜å‡†å¤‡åº¦ âœ…

**ç³»ç»Ÿå·²ç»å®Œå…¨å‡†å¤‡å¥½å¤„ç†å®é™…çš„Code2SQLæ•°æ®æ ¼å¼ï¼Œèƒ½å¤Ÿå®‰å…¨ã€å‡†ç¡®ã€é«˜æ•ˆåœ°æ‰§è¡Œå¤æ‚çš„SQLä¿®å¤æ“ä½œã€‚**

æ‰€æœ‰å…³é”®åŠŸèƒ½å·²ç»å®ç°å¹¶ç»è¿‡éªŒè¯ï¼š
- âœ… æ¥å£å…¼å®¹æ€§é—®é¢˜å·²ä¿®å¤
- âœ… ä¸‰ç»´ä¿®å¤ç³»ç»Ÿå·²å®Œæ•´å®ç°
- âœ… å¤æ‚SQLç»“æ„å¤„ç†å·²å¢å¼º
- âœ… æ•°æ®å®‰å…¨æ€§å’Œå¯è¿½æº¯æ€§å·²ä¿éšœ

**ç”¨æˆ·å¯ä»¥æ”¾å¿ƒä½¿ç”¨ç³»ç»Ÿè¿›è¡Œå¤§è§„æ¨¡çš„SQLå†—ä½™æ¸…ç†å’Œè´¨é‡ä¼˜åŒ–å·¥ä½œã€‚** 