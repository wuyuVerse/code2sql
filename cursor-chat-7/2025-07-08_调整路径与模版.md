# 对话记录 - 调整路径与模板
## 摘要
用户希望：
1. 将 training_data_converter.py 中的 LLM 提示模板抽离到 config/training/data_conversion 目录下的独立文件。
2. 检查 qwen3_14b_ft.yaml 的 dataset_dir 是否指向正确的数据集目录（转换脚本生成的目录），若不一致需要修正。
## 计划
• 首先明确需求和目标，向用户确认后再进行代码修改。
• 如果获批，将执行以下步骤：
  1. 新建模板文件（例如 config/training/data_conversion/orm2sql_prompt.md），把提示词写进去。
  2. 修改 TrainingDataConverter：读取外部模板文件，替换硬编码字符串。
  3. 确认/修改 convert_to_training_format 输出目录与 YAML 中 dataset_dir 保持一致；或反向修改 YAML。
  4. 更新 qwen3_14b_ft.yaml 中的 dataset_dir 指向正确目录（如 model/data/orm2sql_training_data 或 model/datasets/orm2sql）。
• 最后回归测试，确保转换及训练脚本能够找到数据。

## 实施过程

### 1. 模板外置（已完成）
- 创建 `config/training/data_conversion/orm2sql_prompt_template.py`
- 定义 `PROMPT_TEMPLATE` 常量，包含完整的 ORM→SQL 提示词模板
- 修改 `training_data_converter.py` 导入外部模板并使用 `format()` 方法

### 2. 路径修正（已完成）
- 修改 `qwen3_14b_ft.yaml` 中 `dataset_dir` 为 `/home/wuyu/code2sql/model/data/orm2sql_training_data`
- 动态配置数据集名称和样本数，YAML 中设为占位符

### 3. 训练流程集成（已完成）
- 在 `train_qwen3_ft.py` 中集成自动数据转换
- 修复 Python 版本兼容性问题（>=3.10）
- 修复脚本路径问题，使用相对路径

### 4. DeepSpeed 配置修正（2025-07-08 15:15-15:20）
**问题1：** 训练启动时 DeepSpeed 配置文件路径错误
```
ValueError: Expected a string path to an existing deepspeed config...
Received: /home/wuyu/code2sql/model/LLaMA-Factory/examples/deepspeed/ds_z3_config.json
```

**解决方案1：** 
- 修改 `config/training/qwen/qwen3_14b_ft.yaml` 中的 `deepspeed` 路径
- 从绝对路径 `/home/wuyu/code2sql/model/LLaMA-Factory/examples/deepspeed/ds_z3_config.json`
- 改为相对路径 `examples/deepspeed/ds_z3_config.json`

**问题2：** 相对路径仍然无法找到，因为训练脚本工作目录不在 LLaMA-Factory 
```
ValueError: Expected a string path to an existing deepspeed config...
Received: examples/deepspeed/ds_z3_config.json
```

**解决方案2：**
- 修改 `train_qwen3_ft.py` 中的 subprocess.run() 调用
- 添加 `cwd=str(llamafactory_dir)` 参数，指定工作目录为 LLaMA-Factory 目录
- 确保 llamafactory-cli 在正确目录下执行，能找到相对路径的 DeepSpeed 配置

**问题3：** GPU4567 配置文件路径未同步更新（2025-07-08 15:25）
通过对比日志发现：
- GPU0123 训练成功：使用了正确的相对路径配置
- GPU4567 训练失败：`qwen3_14b_ft_gpu4567.yaml` 仍使用绝对路径

**解决方案3：**
- 同步修改 `config/training/qwen/qwen3_14b_ft_gpu4567.yaml`
- `deepspeed: examples/deepspeed/ds_z3_config.json`
- `dataset_dir: /home/wuyu/code2sql/model/data/orm2sql_training_data`
- 同时更新数据集配置为动态模式

### 5. 输出路径和 SwanLab 项目配置修正（2025-07-08 15:30）
**问题：**
- 模型输出目录使用了绝对路径，应该相对于 LLaMA-Factory 目录
- SwanLab 项目名称默认为 LLaMA-Factory，应该改为 code2sql

**解决方案：**
- 修改两个 YAML 配置文件中的 `output_dir` 为相对路径（如 `saves/qwen3-14b-orm2sql-ft`）
- 添加 `swanlab_project: code2sql` 配置项
- 更新 `train_qwen3_ft.py` 支持 SwanLab 项目名称传递
- 修正输出目录生成逻辑，使用配置文件中的基础路径

## 结果
✅ 提示词外置完成，便于维护和复用
✅ 数据集路径统一，自动化训练流程建立  
✅ DeepSpeed 配置路径修正，训练可正常启动
✅ 端到端自动化：`start_finetune.sh` → 数据转换 → 模型训练
