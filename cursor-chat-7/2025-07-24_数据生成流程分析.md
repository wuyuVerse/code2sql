# 数据生成流程分析总结

**日期**: 2025-07-24  
**主题**: 熟悉两个数据生成流程

## 概述

分析了项目中的两个数据生成流程，它们构成了一个完整的ORM到SQL的数据生成系统。

## 第一个流程：合成数据生成器 (Synthetic Data Generator)

### 位置
- `data_processing/synthetic_data_generator/`
- `config/data_processing/synthetic_data_generator/`

### 核心功能
- 生成13种不同场景的ORM数据包
- 支持并行处理，提高生成效率
- 自动验证生成数据的格式正确性
- 使用LLM生成Go语言ORM代码

### 主要组件

#### 1. generator.py - 核心生成逻辑
- `SyntheticDataGenerator`类：主要的生成器类
- 支持串行和并行生成模式
- 包含数据验证和统计功能
- 使用LLMClient进行API调用

#### 2. cli.py - 命令行接口
- 支持多种参数配置
- 提供场景列表查看功能
- 支持并行模式配置
- 包含数据验证选项

#### 3. config.py - 配置管理
- 场景定义和描述（17种场景）
- 变量名词库（表名、实体名、字段名等）
- `SyntheticDataConfig`类：配置管理类

#### 4. prompts.py - 提示词模板
- `PROMPT_ORM`：ORM代码生成提示词
- `PROMPT_CALLER`：调用者代码生成提示词
- `PROMPT_META`：元数据生成提示词
- 针对不同场景的专用提示词

### 支持的场景
1. **对象var+chunk** - ORM方法仅依赖接收者对象的成员变量
2. **caller+global variable** - 依赖外部全局常量或变量
3. **caller+chunk** - 需要调用者传递的参数chunks
4. **caller的callee+caller** - 形成调用链的ORM方法
5. **单chunk** - 最基础的CRUD操作
6. **单chunk+meta(global var)** - 使用单一数据块和全局变量
7. **preload特殊函数** - 使用预加载功能优化关联查询
8. **association特殊函数** - 处理关联关系操作
9. **单chunk+meta(local var)** - 依赖方法内部的局部变量
10. **单chunk+meta(对象var)** - 依赖对象成员变量
11. **一度caller+chunk** - 一层调用关系
12. **二度caller+chunk** - 两层调用关系
13. **对象const+chunk** - 依赖对象常量成员变量
14. **switch** - 使用switch条件语句
15. **if-else+caller** - Caller代码中包含if-else条件判断
16. **if-else+orm** - ORM方法内部包含if-else条件判断
17. **no-where** - 需要外部传入部分where条件

## 第二个流程：SQL提取和验证

### 位置
- `data_processing/synthetic_data_generator/get_sql.py`

### 核心功能
- 从生成的ORM代码中提取SQL语句
- 验证SQL语句的正确性和完整性
- 格式化SQL输出
- 支持批量处理和重试机制

### 主要特性

#### 1. 重试机制
- 指数退避重试机制
- 最大重试次数：10次
- 基础延迟：1秒，最大延迟：60秒
- 包含随机抖动避免惊群效应

#### 2. 中间结果管理
- 保存中间结果到临时文件
- 支持从断点恢复处理
- 分阶段处理：分析、验证、格式化

#### 3. 并发处理
- 支持高并发处理（默认80个并发）
- 使用信号量控制并发数量
- 异步处理提高效率

#### 4. SQL验证和分类
- SQL语句完整性验证
- SQL类型分类（SELECT、INSERT、UPDATE、DELETE等）
- 格式化和标准化输出

## 两个流程的关系

1. **第一个流程**负责生成ORM代码数据包
2. **第二个流程**负责从生成的ORM代码中提取和验证SQL语句
3. 两个流程可以串联使用，形成完整的数据生成管道

## 使用方式

### 基本使用
```bash
# 生成所有场景的数据
python -m data_processing.synthetic_data_generator.cli

# 生成指定场景的数据
python -m data_processing.synthetic_data_generator.cli --scenario "单chunk" --count 5

# 并行模式生成
python -m data_processing.synthetic_data_generator.cli --parallel --workers 8 --count 10
```

### SQL提取
```python
# 使用get_sql.py中的函数处理生成的JSON文件
await process_json_file_async(input_file, output_file, concurrency=80)
```

## 架构特点

### 1. 模块化设计
- 配置、提示词、生成逻辑分离
- 使用项目的LLMClient和配置系统
- 类型安全和错误处理

### 2. 性能优化
- 并行处理支持
- 内存优化和分批处理
- 自动重试和错误恢复

### 3. 数据质量保证
- 自动数据验证
- 格式标准化
- 统计监控和日志记录

## 总结

这两个数据生成流程构成了一个完整的ORM到SQL的数据生成系统，可以用于训练和测试代码到SQL的转换模型。系统具有良好的可扩展性、可维护性和性能表现。 