# 20250708 工作流并发设置优化

## 任务概述

今日主要完成了两个任务：
1. 创建新的关键词优先工作流
2. 解决测试脚本导入问题
3. 优化工作流并发设置

## 已完成的工作

### 1. 新增关键词优先工作流

在 `data_processing/workflow/workflow_manager.py` 中新增了 `run_keyword_first_workflow_from_raw_data` 函数：

**流程顺序：**
- 加载原始数据集 (`load_raw_dataset`)
- 提取关键词数据 (`extract_keyword_data`)
- 将提取的记录从数据集中剔除
- SQL清洗 (`run_sql_cleaning`)
- 运行冗余SQL验证并应用修复
- 导出最终数据和摘要

**关键特性：**
- 支持自定义关键词或使用默认GORM关键词
- 记录详细的处理步骤统计信息
- 完整的错误处理和日志记录

### 2. 创建配套测试脚本

新建了 `test_workflow_keyword_first.py` 测试脚本：
- 结构参考现有测试脚本
- 显示关键统计信息（提取率、清洗结果等）
- 统一的日志格式和错误处理

### 3. 解决测试脚本导入问题

修复了 `tests/test_llm_servers.py` 的导入问题：
- 修正导入路径：`config.llm_config` → `config.llm.llm_config`
- 添加项目根目录到Python路径
- 创建 `config/llm/__init__.py` 使其成为合法的Python包
- 修复 `LLMConfig` 类的配置文件路径问题，使用绝对路径

### 4. 优化并发设置和配置管理

**第一轮优化：**
将所有工作流中的并发数统一调整为 10：
- SQL完整性检查并发数：200 → 10
- SQL正确性检查并发数：200 → 10  
- 冗余SQL验证并发数：100 → 10

**第二轮优化：**
创建配置管理系统，并发数调整为 50：
- 新增 `config/data_clean/workflow_config.yaml` 配置文件
- 新增 `config/data_clean/workflow_config.py` 配置加载器
- 将并发数设置为 50，支持动态配置
- 支持按步骤类型分别配置不同的并发数

**修改位置：**
- `tag_lack_information_data` 方法：动态读取 sql_completeness_check 并发数
- `check_sql_correctness` 方法：动态读取 sql_correctness_check 并发数
- `run_redundant_sql_validation` 方法：动态读取 redundant_sql_validation 并发数
- 相关统计信息自动更新为实际使用的并发数

## 技术要点

### 路径处理优化
- 使用 `Path(__file__).parent.parent.parent` 获取项目根目录
- 对相对路径进行绝对路径转换，避免工作目录依赖问题

### 类型检查处理
- 使用 `# type: ignore[index]` 注释解决类型检查器的False Positive
- 通过条件判断确保空值安全

### 并发控制
- 统一使用较低的并发数（10）以避免API限制和服务器压力
- 保持异步处理的性能优势同时确保稳定性

## 文件变更总结

**新增文件：**
- `test_workflow_keyword_first.py` - 新工作流测试脚本
- `config/llm/__init__.py` - 包初始化文件
- `config/data_clean/workflow_config.yaml` - 工作流配置文件
- `config/data_clean/workflow_config.py` - 工作流配置加载器

**修改文件：**
- `data_processing/workflow/workflow_manager.py` - 新增关键词优先工作流 + 动态并发配置
- `tests/test_llm_servers.py` - 修正导入路径
- `config/llm/llm_config.py` - 修复配置文件路径问题

## 质量保证

- 所有变更都遵循最小改动原则
- 保持向下兼容性，现有接口不受影响
- 完整的错误处理和日志记录
- 类型安全和linter检查通过

## 下一步建议

1. 测试新工作流的完整执行流程
2. 验证并发设置在实际环境中的性能表现
3. 根据需要进一步优化并发参数
4. 考虑添加配置文件来统一管理并发设置 