# 分步骤冗余SQL验证提示词模板

# Step 1: 语法级等价检测
SYNTAX_EQUIVALENCE_PROMPT = """你是SQL分析专家，需要判断目标SQL是否与参考SQL在语法上等价。

目标SQL:
```sql
{target_sql}
```

参考SQL集合:
{reference_sqls}

任务：判断目标SQL是否与参考SQL集合中的任何一个在语法上等价（忽略空白、大小写、注释差异）。

请回答：
- 如果等价，回答"是"
- 如果不等价，回答"否"

只需要简单回答"是"或"否"，不需要解释。"""

# Step 2: 冗余SQL业务合理性检测
REDUNDANT_BUSINESS_VALIDATION_PROMPT = """你是Go+SQL分析专家，判断以下SQL在给定的业务上下文中是否确实冗余。

ORM代码上下文:
```go
{orm_code}
```

调用者(caller): {caller}
参考调用者: {reference_caller}

目标SQL:
```sql
{target_sql}
```

系统检测结果：此SQL的指纹被参考调用者的指纹集合完全包含，可能是冗余的。

请分析：
1. 考虑代码执行流程和业务逻辑，这个SQL在当前调用者"{caller}"的上下文中是否确实多余？
2. 还是虽然SQL功能相同，但在不同的业务场景或代码分支中都有其必要性？

如果确实冗余可以安全删除，请回答"是，冗余"；
如果不是冗余或不确定，请回答"否，保留"并简要说明原因。

注意：只有在明确确认SQL完全多余且删除不会影响业务逻辑时，才应该判断为冗余。"""

# Step 3: 新增指纹合理性检测
NEW_FINGERPRINT_VALIDATION_PROMPT = """你是Go+SQL分析专家，判断以下新增SQL指纹是否合理。

ORM代码上下文:
```go
{orm_code}
```

调用者(caller): {caller}
参考调用者: {reference_caller}

新增SQL:
```sql
{new_sql}
```

系统检测结果：此SQL的指纹在参考调用者中不存在，是一个新的SQL模式。

请分析：
1. 考虑代码执行路径，当前调用者"{caller}"是否真的能够生成这个SQL？
2. 这个新的SQL模式是否符合ORM代码的业务逻辑？
3. 还是这可能是代码分析错误或者不应该出现的SQL？

如果这是合理的新增SQL，请回答"合理新增"；
如果这是错误的SQL，请回答"错误SQL"并说明原因。

注意：重点关注代码路径的可达性和业务逻辑的合理性。"""

# Step 4: 缺失SQL必要性检测
MISSING_SQL_VALIDATION_PROMPT = """你是Go+SQL分析专家，判断以下缺失的SQL是否应该在当前调用者中生成。

ORM代码上下文:
```go
{orm_code}
```

调用者(caller): {caller}
参考调用者: {reference_caller}

缺失的SQL示例:
```sql
{missing_sql}
```

系统检测结果：参考调用者能生成此SQL，但当前调用者没有生成，可能是缺漏。

请分析：
1. 考虑代码执行路径，当前调用者"{caller}"是否应该也能生成这个SQL？
2. 还是由于业务逻辑差异，当前调用者确实不需要生成这个SQL？

如果确实应该生成但缺失了，请回答"确实缺失"；
如果由于业务逻辑不同而不需要生成，请回答"无需生成"并说明原因。

注意：重点关注不同调用者的业务场景差异。"""

# Step 0: 规则预过滤（简单差异检测）
RULE_BASED_FILTER_PROMPT = """你是SQL预处理专家，判断以下SQL差异是否为简单的格式差异。

SQL1:
```sql
{sql1}
```

SQL2:
```sql
{sql2}
```

请判断这两个SQL是否仅存在以下简单差异：
- 空白字符、换行符差异
- 大小写差异  
- 注释差异
- 表名/字段名的引号差异（如`table`与table）

如果仅存在上述简单差异，回答"格式差异"；
如果存在实质性语义差异，回答"语义差异"。

只需要简单回答，不需要详细解释。"""

# 保留原有的提示词作为备用
REDUNDANT_SQL_VALIDATION_PROMPT = """请判断以下SQL语句在给定的代码上下文中是否真的冗余。

SQL语句:
```sql
{clean_sql}
```

代码上下文信息:
- 函数名: {function_name}
- 调用者: {caller}
- ORM代码: {orm_code}

系统检测到此SQL的指纹在同一调用者中出现了多次，因此标记为可能冗余。

请分析：
1. 考虑到代码执行流程和业务逻辑，这个SQL是否确实是多余的重复？
2. 还是虽然SQL文本相同，但在不同的业务场景或代码分支中都有其必要性？

如果确实冗余可以安全删除，请回答"是，冗余"；如果不是冗余或不确定，请回答"否，保留"并简要说明原因。

注意：只有在明确确认SQL完全多余且删除不会影响业务逻辑时，才应该判断为冗余。"""

# 保留原有的解析验证提示词作为备用
REDUNDANT_SQL_PARSING_VALIDATION_PROMPT = """请验证以下SQL解析信息是否正确。

SQL语句:
```sql
{clean_sql}
```

系统解析结果:
- 语句类型: {stmt_type}
- WHERE子句涉及的列: {where_columns}

请判断系统解析结果是否准确。如果准确，请回答"是"；如果有错误，请回答"否，应该是..."并说明正确的解析结果。

注意：只需要验证语句类型和WHERE列的识别是否正确，不需要验证SQL语法正确性。""" 