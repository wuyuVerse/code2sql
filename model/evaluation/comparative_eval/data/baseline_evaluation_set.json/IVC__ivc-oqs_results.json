[
  {
    "function_name": "GetCodeInfo",
    "orm_code": "func (addr *Addr) GetCodeInfo(deviceIds []string, log *logger.IvcLog) (codeInfo []CodeInfo, err error) {\n\tvar CodeInfos []CodeInfo\n\treq := addr.Req\n\tif req.OwnerUin == req.SubUin {\n\t\tif err = base.GetInstance().IvcDriver().Clauses(SqlCommentClauses(req)...).Table(DeviceTAbel).Select(\"id,code\").Where(\"id IN (?) and app_id = ? and access_protocol = 2 \", deviceIds, req.AppId).Scan(&CodeInfos).Error; err != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[GetCodeInfo] GetCodeInfo by appid err:%v\", err))\n\t\t\treturn nil, err\n\t\t}\n\t} else {\n\t\tif err = base.GetInstance().IvcDriver().Clauses(SqlCommentClauses(req)...).Select(\"d.id,d.code\").Table(DeviceTAbel+\" as d \").Joins(\"INNER JOIN \"+IvcUserResource+\" as r on d.id = r.device_id\").\n\t\t\tWhere(\"d.id in (?) and r.sub_uin = ? and r.deleted_time is NULL and d.deleted_at is NULL and d.access_protocol = 2 \", deviceIds, req.SubUin).Scan(&CodeInfos).Error; err != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[GetCodeInfo] GetCodeInfo by subuin err:%v\", err))\n\t\t\treturn nil, err\n\t\t}\n\t}\n\treturn CodeInfos, nil\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "OwnerUin等于SubUin时的主账户查询",
            "sql": "SELECT id,code FROM ivc_device WHERE id IN (?, ?, ?) and app_id = ? and access_protocol = 2;"
          },
          {
            "scenario": "OwnerUin不等于SubUin时的子账户查询",
            "sql": "SELECT d.id,d.code FROM ivc_device as d INNER JOIN ivc_user_resource as r on d.id = r.device_id WHERE d.id in (?, ?, ?) and r.sub_uin = ? and r.deleted_time is NULL and d.deleted_at is NULL and d.access_protocol = 2;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/addr.go",
        "code_start_line": 9,
        "code_end_line": 9,
        "code_key": "base",
        "code_value": "oqs/internal/base",
        "code_label": null,
        "code_type": 4,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/addr.go",
        "code_start_line": 19,
        "code_end_line": 19,
        "code_key": "DeviceTAbel",
        "code_value": "const DeviceTAbel      = \"ivc_device\"",
        "code_label": 21,
        "code_type": 1,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/addr.go",
        "code_start_line": 46,
        "code_end_line": 46,
        "code_key": "CodeInfos",
        "code_value": "[]CodeInfo",
        "code_label": null,
        "code_type": 31,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/addr.go",
        "code_start_line": 31,
        "code_end_line": 34,
        "code_key": "CodeInfo",
        "code_value": "type CodeInfo struct {\n\tDeviceCode string `json:\"DeviceCode\" gorm:\"column:code\"`\n\tDeviceId   string `json:\"DeviceId\" gorm:\"column:id\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-oqs.json"
  },
  {
    "function_name": "GetDeviceAddrInfo",
    "orm_code": "func (addr *Addr) GetDeviceAddrInfo(CodeInfos []CodeInfo, DeviceIds []string, log *logger.IvcLog) (deviceAddrInfo []types.RemoteAddrInfo, err error) {\n\tdataMap := make(map[string]string)\n\trp := base.GetInstance().IvcRedis().Pipeline()\n\tdataCmd := make([]*redis.StringCmd, len(CodeInfos))\n\tfor i := range CodeInfos {\n\t\tHGetKey := fmt.Sprintf(SipRegister, CodeInfos[i].DeviceCode)\n\t\tdataCmd[i] = rp.HGet(context.TODO(), HGetKey, RemoteAddrField)\n\t}\n\n\t_, err = rp.Exec(context.TODO())\n\tif err != nil && err != redis.Nil {\n\t\tlog.ErrorV(fmt.Sprintf(\"[GetDeviceAddrInfo] GetDeviceAddrInfo err:%v\", err))\n\t\treturn nil, err\n\t}\n\tfor i := range CodeInfos {\n\t\tif dataCmd[i].Err() == nil {\n\t\t\tdataMap[CodeInfos[i].DeviceId] = strings.Split(dataCmd[i].Val(), \":\")[0]\n\t\t} else {\n\t\t\tdataMap[CodeInfos[i].DeviceId] = \"\"\n\t\t}\n\t}\n\tdeviceAddrInfo = make([]types.RemoteAddrInfo, 0, len(DeviceIds))\n\tfor _, v := range DeviceIds {\n\t\tif len(v) < 1 {\n\t\t\tcontinue\n\t\t}\n\t\tif _, ok := dataMap[v]; !ok {\n\t\t\tdeviceAddrInfo = append(deviceAddrInfo, types.RemoteAddrInfo{\n\t\t\t\tDeviceId: v,\n\t\t\t\tAddr:     \"\",\n\t\t\t})\n\t\t} else {\n\t\t\tdeviceAddrInfo = append(deviceAddrInfo, types.RemoteAddrInfo{\n\t\t\t\tDeviceId: v,\n\t\t\t\tAddr:     dataMap[v],\n\t\t\t})\n\t\t}\n\t}\n\treturn deviceAddrInfo, nil\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "NO_SQL_GENERATE",
        "variants": [
          {
            "scenario": "该代码使用Redis而非SQL数据库，通过Redis Pipeline执行HGET命令获取哈希字段值，不会生成任何SQL语句",
            "sql": ""
          }
        ]
      }
    ],
    "sql_types": [
      "NO_SQL_GENERATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/addr.go",
        "code_start_line": 64,
        "code_end_line": 64,
        "code_key": "rp",
        "code_value": "base.GetInstance().IvcRedis().Pipeline()",
        "code_label": null,
        "code_type": 35,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-oqs.json"
  },
  {
    "function_name": "findClusterMap",
    "orm_code": "func findClusterMap(req types.GeneralRequest) (map[string]string, error) {\n\tclusters := make([]Cluster, 0)\n\tClusterMap := make(map[string]string)\n\terr := base.GetInstance().IvcDriver().Clauses(SqlCommentClauses(req)...).Table(ClusterConfTable).Where(\"deleted_at is null\").Find(&clusters).Error\n\tif err != nil {\n\t\treturn ClusterMap, err\n\t}\n\tfor _, cluster := range clusters {\n\t\tClusterMap[cluster.ClusterId] = cluster.Region\n\t}\n\treturn ClusterMap, nil\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT id, name, region FROM ivc_cluster_conf WHERE deleted_at is null;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/cluster.go",
        "code_start_line": 10,
        "code_end_line": 10,
        "code_key": "base",
        "code_value": "oqs/internal/base",
        "code_label": null,
        "code_type": 4,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/cluster.go",
        "code_start_line": 19,
        "code_end_line": 19,
        "code_key": "ClusterConfTable",
        "code_value": "const ClusterConfTable      = \"ivc_cluster_conf\"",
        "code_label": 21,
        "code_type": 1,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/cluster.go",
        "code_start_line": 69,
        "code_end_line": 69,
        "code_key": "clusters",
        "code_value": "make([]Cluster, 0)",
        "code_label": null,
        "code_type": 35,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/cluster.go",
        "code_start_line": 24,
        "code_end_line": 28,
        "code_key": "Cluster",
        "code_value": "type Cluster struct {\n\tClusterId   string `json:\"ClusterId\" gorm:\"column:id\"`\n\tClusterName string `json:\"ClusterName\" gorm:\"column:name\"`\n\tRegion      string `json:\"Region\" gorm:\"column:region\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-oqs.json"
  },
  {
    "function_name": "findClusterMap",
    "orm_code": "func findClusterMap(req types.GeneralRequest) (map[string]string, error) {\n\tclusters := make([]Cluster, 0)\n\tClusterMap := make(map[string]string)\n\terr := base.GetInstance().IvcDriver().Clauses(SqlCommentClauses(req)...).Table(ClusterConfTable).Where(\"deleted_at is null\").Find(&clusters).Error\n\tif err != nil {\n\t\treturn ClusterMap, err\n\t}\n\tfor _, cluster := range clusters {\n\t\tClusterMap[cluster.ClusterId] = cluster.Region\n\t}\n\treturn ClusterMap, nil\n}",
    "caller": "func (c *Cluster) GetClusterIdRegionMap(req types.GeneralRequest, log *logger.IvcLog) (map[string]string, error) {\n\tresp := make(map[string]string)\n\tv, err := base.GetInstance().BillingRedis().Get(context.TODO(), fmt.Sprintf(ClusterConfStrKey)).Result()\n\tswitch err {\n\tcase nil:\n\t\terr = json.Unmarshal([]byte(v), &resp)\n\t\tif err != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[GetClusterIdRegionMap] read cache Unmarshal err:%v\", err))\n\t\t\treturn nil, err\n\t\t}\n\t\treturn resp, nil\n\n\tcase redis.Nil:\n\t\tresp, err := findClusterMap(req)\n\t\tif err != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[GetClusterIdRegionMap] findClusterMap read db err:%v\", err))\n\t\t\tif err == db.ErrRecordNotFound {\n\t\t\t\treturn nil, utils.RecordNotFoundError\n\t\t\t}\n\t\t\treturn nil, err\n\t\t}\n\t\tv, err := json.Marshal(resp)\n\t\tif err != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[GetClusterIdRegionMap] findClusterMap Marshal err:%v\", err))\n\t\t\treturn nil, err\n\t\t}\n\t\terr = base.GetInstance().BillingRedis().Set(context.TODO(), fmt.Sprintf(ClusterConfStrKey), string(v), clusterExpiredTimeout).Err()\n\t\tif err != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[GetClusterIdRegionMap] write cache err:%v\", err))\n\t\t\treturn nil, err\n\t\t}\n\t\treturn resp, nil\n\tdefault:\n\t\tlog.ErrorV(fmt.Sprintf(\"[GetClusterIdRegionMap] read cache err:%v\", err))\n\t\treturn nil, err\n\t}\n}",
    "sql_statement_list": [
      {
        "type": "LACK_INFORMATION",
        "variants": [
          {
            "scenario": "缺少ClusterConfTable变量定义和SqlCommentClauses函数实现，根据Cluster结构体和函数名推测",
            "sql": "SELECT * FROM cluster_conf WHERE deleted_at IS NULL;"
          }
        ]
      }
    ],
    "sql_statement": "根据代码分析，我需要先进行边界条件判断：\n\n**边界条件判断**：\n代码包含实际的数据库执行操作（Find方法），会生成SQL语句。\n\n**表名确定**：\n代码中通过 `.Table(ClusterConfTable)` 显式指定了表名，其中 `ClusterConfTable` 是一个变量。由于元数据中没有提供该变量的具体值，根据上下文和 `Cluster` 结构体推测表名为 `cluster_conf`。\n\n**调用者上下文约束**：\n调用者 `GetClusterIdRegionMap` 只在 Redis 缓存未命中（`redis.Nil`）的情况下调用 `findClusterMap` 函数，传入 `req types.GeneralRequest` 参数。\n\n**SQL分析**：\n\n由于缺少 `ClusterConfTable` 变量的具体定义和 `SqlCommentClauses` 函数的实现，但可以根据代码结构和命名推测SQL语句。\n\n```json\n[\n  {\n    \"type\": \"LACK_INFORMATION\", \n    \"variants\": [\n      {\n        \"scenario\": \"缺少ClusterConfTable变量定义和SqlCommentClauses函数实现，根据Cluster结构体和函数名推测\",\n        \"sql\": \"SELECT * FROM cluster_conf WHERE deleted_at IS NULL;\"\n      }\n    ]\n  }\n]\n```\n\n**执行路径分析**：\n\n该函数只有一条执行路径，会生成一条SELECT查询语句：\n\n1. **查询操作**：从集群配置表中查询所有未删除的记录\n   - 使用 `Table(ClusterConfTable)` 指定表名\n   - 添加 `WHERE deleted_at is null` 条件过滤软删除记录  \n   - 使用 `Find(&clusters)` 查询所有匹配记录到 `clusters` 切片中\n   - `SqlCommentClauses(req)` 可能添加SQL注释或额外子句，但不影响主要查询结构\n\n2. **SQL语句结构**：\n   - SELECT：查询所有字段（`*`）\n   - FROM：从集群配置表查询\n   - WHERE：只包含软删除过滤条件\n\n由于代码结构固定，无论传入什么参数，都会执行相同结构的SQL查询语句，只是可能在SQL注释或子句方面有所不同，但核心查询结构保持一致。",
    "verified_sql": "检查完成。原始分析正确识别了边界条件（信息缺失），但需要按照标准格式返回。验证结果：\n\n1. **边界条件验证**：确实缺少`ClusterConfTable`变量的具体定义和`SqlCommentClauses`函数的实现\n2. **推测SQL验证**：基于`Cluster`结构体和函数上下文的推测合理\n3. **调用者上下文验证**：只在Redis缓存未命中时调用，符合分析\n4. **SQL结构验证**：SELECT查询结构正确，包含软删除过滤条件\n\n```json\n[{\n  \"type\": \"LACK_INFORMATION\",\n  \"variants\": [{\n    \"scenario\": \"缺少ClusterConfTable变量定义和SqlCommentClauses函数实现，根据Cluster结构体和函数名推测\",\n    \"sql\": \"SELECT * FROM cluster_conf WHERE deleted_at IS NULL;\"\n  }]\n}]\n```",
    "sql_types": [
      "LACK_INFORMATION"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/cluster.go",
        "code_start_line": 10,
        "code_end_line": 10,
        "code_key": "base",
        "code_value": "oqs/internal/base",
        "code_label": null,
        "code_type": 4,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/cluster.go",
        "code_start_line": 19,
        "code_end_line": 19,
        "code_key": "ClusterConfTable",
        "code_value": "const ClusterConfTable      = \"ivc_cluster_conf\"",
        "code_label": 21,
        "code_type": 1,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/cluster.go",
        "code_start_line": 69,
        "code_end_line": 69,
        "code_key": "clusters",
        "code_value": "make([]Cluster, 0)",
        "code_label": null,
        "code_type": 35,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/cluster.go",
        "code_start_line": 24,
        "code_end_line": 28,
        "code_key": "Cluster",
        "code_value": "type Cluster struct {\n\tClusterId   string `json:\"ClusterId\" gorm:\"column:id\"`\n\tClusterName string `json:\"ClusterName\" gorm:\"column:name\"`\n\tRegion      string `json:\"Region\" gorm:\"column:region\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-oqs.json"
  },
  {
    "function_name": "FindChannelIdToClusterIdList",
    "orm_code": "func (v *Video) FindChannelIdToClusterIdList(req types.GeneralRequest, channelIds []string) ([]ChannelClusterInfo, error) {\n\tvar cc []ChannelClusterInfo\n\t/*\n\t   SELECT c.id as channel_id, d.cluster_id as cluster_id\n\t   FROM ivc_channel c LEFT JOIN ivc_device d ON c.device_id = d.id\n\t   WHERE d.deleted_at is null and c.deleted_at is null\n\t   and c.id IN (channel_id1, channel_id2, ... , channel_id10);\n\t*/\n\tquery := base.GetInstance().IvcDriver().Clauses(SqlCommentClauses(req)...).Table(\"ivc_channel c\").\n\t\tSelect(\"c.id as channel_id, d.cluster_id as cluster_id\").\n\t\tJoins(\"LEFT JOIN ivc_device d ON c.device_id = d.id\").\n\t\tWhere(\"d.deleted_at IS NULL AND c.deleted_at IS NULL\")\n\n\tif len(channelIds) > 0 {\n\t\tquery = query.Where(\"c.id IN (?)\", channelIds)\n\t}\n\n\terr := query.Scan(&cc).Error\n\tif err != nil {\n\t\tif err == db.ErrRecordNotFound {\n\t\t\treturn nil, utils.RecordNotFoundError\n\t\t}\n\t\treturn nil, err\n\t}\n\treturn cc, nil\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "channelIds为空或长度为0",
            "sql": "SELECT c.id as channel_id, d.cluster_id as cluster_id FROM ivc_channel c LEFT JOIN ivc_device d ON c.device_id = d.id WHERE d.deleted_at IS NULL AND c.deleted_at IS NULL;"
          },
          {
            "scenario": "channelIds包含一个或多个频道ID",
            "sql": "SELECT c.id as channel_id, d.cluster_id as cluster_id FROM ivc_channel c LEFT JOIN ivc_device d ON c.device_id = d.id WHERE d.deleted_at IS NULL AND c.deleted_at IS NULL AND c.id IN (?, ?, ?);"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/video.go",
        "code_start_line": 8,
        "code_end_line": 8,
        "code_key": "base",
        "code_value": "oqs/internal/base",
        "code_label": null,
        "code_type": 4,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/video.go",
        "code_start_line": 38,
        "code_end_line": 38,
        "code_key": "query",
        "code_value": "base.GetInstance().IvcDriver().Clauses(SqlCommentClauses(req)...).Table(\"ivc_channel c\").\n\t\tSelect(\"c.id as channel_id, d.cluster_id as cluster_id\").\n\t\tJoins(\"LEFT JOIN ivc_device d ON c.device_id = d.id\").\n\t\tWhere(\"d.deleted_at IS NULL AND c.deleted_at IS NULL\")",
        "code_label": null,
        "code_type": 35,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/video.go",
        "code_start_line": 31,
        "code_end_line": 31,
        "code_key": "cc",
        "code_value": "[]ChannelClusterInfo",
        "code_label": null,
        "code_type": 31,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/video.go",
        "code_start_line": 22,
        "code_end_line": 25,
        "code_key": "ChannelClusterInfo",
        "code_value": "type ChannelClusterInfo struct {\n\tChannelId string `json:\"ChannelId\" gorm:\"column:channel_id\"`\n\tClusterId string `json:\"ClusterId\" gorm:\"column:cluster_id\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-oqs.json"
  },
  {
    "function_name": "GetChannelInfo",
    "orm_code": "func (c *Channel) GetChannelInfo(DeviceId string, log *logger.IvcLog) ([]ChannelInfo, error) {\n\tvar channelInfo []ChannelInfo\n\tif err := base.GetInstance().IvcDriver().Clauses(SqlCommentClauses(c.Req)...).Table(ChannelConfTable).Select(\"id,code,device_code,device_id\").Where(\"device_id = ? AND deleted_at IS NULL\", DeviceId).Scan(&channelInfo).Error; err != nil {\n\t\tlog.ErrorV(fmt.Sprintf(\"[GetChannelInfo] GetChannelInfo err:%v\", err))\n\t\treturn nil, err\n\t}\n\treturn channelInfo, nil\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT id, code, device_code, device_id FROM ivc_channel WHERE device_id = ? AND deleted_at IS NULL;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/channels.go",
        "code_start_line": 10,
        "code_end_line": 10,
        "code_key": "base",
        "code_value": "oqs/internal/base",
        "code_label": null,
        "code_type": 4,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/channels.go",
        "code_start_line": 14,
        "code_end_line": 14,
        "code_key": "ChannelConfTable",
        "code_value": "const ChannelConfTable  = \"ivc_channel\"",
        "code_label": 21,
        "code_type": 1,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/channels.go",
        "code_start_line": 33,
        "code_end_line": 33,
        "code_key": "channelInfo",
        "code_value": "[]ChannelInfo",
        "code_label": null,
        "code_type": 31,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/channels.go",
        "code_start_line": 21,
        "code_end_line": 26,
        "code_key": "ChannelInfo",
        "code_value": "type ChannelInfo struct {\n\tId         string `json:\"Id\" gorm:\"column:id\"`\n\tCode       string `json:\"Code\" gorm:\"column:code\"`\n\tDeviceCode string `json:\"DeviceCode\" gorm:\"column:device_code\"`\n\tDeviceId   string `json:\"DeviceId\" gorm:\"column:device_id\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-oqs.json"
  },
  {
    "function_name": "IsExistDevicePermission",
    "orm_code": "func IsExistDevicePermission(DeviceId string, req *types.GeneralRequest, log *logger.IvcLog) (bool, error) {\n\tvar count int64\n\tif req.SubUin == req.OwnerUin {\n\t\tif err := base.GetInstance().IvcDriver().Clauses(SqlCommentClauses(*req)...).Table(DeviceTAbel).Where(\"id = ? and app_id = ? and deleted_at is null\", DeviceId, req.AppId).Count(&count).Error; err != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[IsPermissioned] IsPermissioned by appid err:%v\", err))\n\t\t\treturn false, err\n\t\t}\n\t\tif count > 0 {\n\t\t\treturn true, nil\n\t\t}\n\t\treturn false, nil\n\t} else {\n\t\tif err := base.GetInstance().IvcDriver().Clauses(SqlCommentClauses(*req)...).Table(IvcUserResource).Where(\"sub_uin = ? and device_id = ? and deleted_time is null\", req.SubUin, DeviceId).Count(&count).Error; err != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[IsPermissioned] IsPermissioned by subuin err:%v\", err))\n\t\t\treturn false, err\n\t\t}\n\t\tif count > 0 {\n\t\t\treturn true, nil\n\t\t}\n\t\treturn false, nil\n\t}\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "所有者权限检查 (req.SubUin == req.OwnerUin)",
            "sql": "SELECT count(*) FROM ivc_device WHERE id = ? AND app_id = ? AND deleted_at IS NULL;"
          },
          {
            "scenario": "子用户权限检查 (req.SubUin != req.OwnerUin)",
            "sql": "SELECT count(*) FROM ivc_user_resource WHERE sub_uin = ? AND device_id = ? AND deleted_time IS NULL;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/channels.go",
        "code_start_line": 10,
        "code_end_line": 10,
        "code_key": "base",
        "code_value": "oqs/internal/base",
        "code_label": null,
        "code_type": 4,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/addr.go",
        "code_start_line": 19,
        "code_end_line": 19,
        "code_key": "DeviceTAbel",
        "code_value": "const DeviceTAbel      = \"ivc_device\"",
        "code_label": 21,
        "code_type": 1,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/channels.go",
        "code_start_line": 107,
        "code_end_line": 107,
        "code_key": "count",
        "code_value": "int64",
        "code_label": null,
        "code_type": 31,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      },
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/addr.go",
        "code_start_line": 18,
        "code_end_line": 18,
        "code_key": "IvcUserResource",
        "code_value": "const IvcUserResource  = \"ivc_user_resource\"",
        "code_label": 21,
        "code_type": 1,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-oqs.json"
  },
  {
    "function_name": "GetMedia",
    "orm_code": "func GetMedia(channelInfo []ChannelInfo, log *logger.IvcLog) (*types.StreamStatsResponse, error) {\n\t//使用管道减少网络开销\n\tRedisPipe := base.GetInstance().IvcRedis().Pipeline()\n\tms := make(map[string]*redis.StringSliceCmd)\n\n\t//拼接查询根字符串，减少相同操作\n\tSessionbytesRoot := make([]byte, 0, 55)\n\tSessionkeyroot := fmt.Sprintf(SipRecordSession, channelInfo[0].DeviceCode)\n\tSessionbytesRoot = append(SessionbytesRoot, []byte(Sessionkeyroot)...)\n\n\t//根据通道编码查询取得所有会话id\n\tfor i := range channelInfo {\n\t\tms[channelInfo[i].Id] = RedisPipe.HKeys(context.TODO(), string(append(SessionbytesRoot, []byte(channelInfo[i].Code)...)))\n\t}\n\t_, err := RedisPipe.Exec(context.TODO())\n\tif err != nil && err != redis.Nil {\n\t\tlog.ErrorV(fmt.Sprintf(\"[GetMedia] GetSessions err:%v\", err))\n\t\treturn nil, err\n\t}\n\t//存储查询开流结果\n\tmb := make(map[string][]*redis.BoolCmd)\n\t//设置单次管道查询的最大数量\n\tvar LimitCount = 0\n\t//遍历每个通道查询通道下的所有开流情况\n\tfor i := range ms {\n\t\tbs := make([]*redis.BoolCmd, len(ms[i].Val())+1)\n\t\t//第一个是实时流开流情况\n\t\tbs[0] = RedisPipe.HExists(context.TODO(), fmt.Sprintf(StreamRecordKey, i), StreamRecordFiled)\n\t\tLimitCount += 1\n\t\t//拼接根字符串避免重复操作\n\t\tmediabytesRoot := make([]byte, 0, 95)\n\t\tmediakeyroot := fmt.Sprintf(StreamRecordKey+\"@\", i)\n\t\tmediabytesRoot = append(mediabytesRoot, []byte(mediakeyroot)...)\n\t\t//遍历每个会话查询开流情况，bs 的len比ms[i].Val()多1，所以不会出现数组越界\n\t\tfor j := range ms[i].Val() {\n\t\t\tbs[j+1] = RedisPipe.HExists(context.TODO(), string(append(mediabytesRoot, []byte(ms[i].Val()[j])...)), StreamRecordFiled)\n\t\t\tLimitCount += 1\n\t\t\t//单次管道查询数量大于limitOneTime则先执行一次查询再继续\n\t\t\tif LimitCount >= LimitOneTime {\n\t\t\t\t_, err = RedisPipe.Exec(context.TODO())\n\t\t\t\tif err != nil && err != redis.Nil {\n\t\t\t\t\tlog.ErrorV(fmt.Sprintf(\"[GetMedia] GetMedia err:%v\", err))\n\t\t\t\t\treturn nil, err\n\t\t\t\t}\n\t\t\t\tLimitCount = 0\n\t\t\t}\n\t\t}\n\t\tmb[i] = bs\n\t}\n\t//避免执行空查询\n\tif LimitCount > 0 {\n\t\t_, err = RedisPipe.Exec(context.TODO())\n\t\tif err != nil && err != redis.Nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[GetMedia] GetMedia err:%v\", err))\n\t\t\treturn nil, err\n\t\t}\n\t}\n\t//构建查询结果返回\n\tlist := make([]types.StreamStatsInfo, 0, len(channelInfo))\n\ttotalLive := 0\n\ttotalRecord := 0\n\tfor i := range mb {\n\t\tlive := 0\n\t\trecord := 0\n\t\t//获取实时流开流情况，对每个通道，都一定会有实时流开流情况，所以不会数组越界\n\t\tif mb[i][0].Val() {\n\t\t\tlive++\n\t\t}\n\t\t//获取录像流开流情况\n\t\tfor j := 1; j < len(mb[i]); j++ {\n\t\t\tif mb[i][j].Val() {\n\t\t\t\trecord++\n\t\t\t}\n\t\t}\n\t\t//将遍历结果添加到数组\n\t\tlist = append(list, types.StreamStatsInfo{ChannelId: i, Live: live, Record: record})\n\t\ttotalLive += live\n\t\ttotalRecord += record\n\t}\n\t//返回查询结果\n\treturn &types.StreamStatsResponse{\n\t\tTotalCount:      totalLive + totalRecord,\n\t\tLiveCount:       totalLive,\n\t\tRecordCount:     totalRecord,\n\t\tStreamStatsList: list,\n\t}, nil\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "NO_SQL_GENERATE",
        "variants": [
          {
            "scenario": "代码只包含Redis操作（Pipeline、HKeys、HExists等），没有任何SQL数据库操作或GORM相关的数据库执行方法",
            "sql": ""
          }
        ]
      }
    ],
    "sql_types": [
      "NO_SQL_GENERATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/aid-db/temp/aid-main/aid/risk_sql/code/scripts/IVC__ivc-oqs/internal/model/channels.go",
        "code_start_line": 131,
        "code_end_line": 131,
        "code_key": "RedisPipe",
        "code_value": "base.GetInstance().IvcRedis().Pipeline()",
        "code_label": null,
        "code_type": 35,
        "code_version": "e65444abb355509287b95241ad15d0109d46b999"
      }
    ],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-oqs.json"
  }
]