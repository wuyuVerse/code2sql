[
  {
    "function_name": "/Users/freedom/llms/singularity/internal/consumer_srv/domain/measure/repositories/cbs.go:22:32:QueryDiskInfoById",
    "orm_code": "func (cbsRepo *CbsBalanceRepo) QueryDiskInfoById(ctx context.Context, id string) (*ccdb.CCbs, error) {\n\tvar disk ccdb.CCbs\n\n\tresult := cbsRepo.DB.Where(\"cbsInstanceId = ?\", id).Find(&disk)\n\tif result.Error != nil {\n\t\treturn nil, result.Error\n\t} else if result.RowsAffected == 0 {\n\t\treturn nil, nil\n\t}\n\treturn &disk, nil\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT cbsId, appId, cbsInstanceId, cbsUuid, diskSize, diskType, lifeState, status, rollbacking, rollbackPercent, archType, assigned, attached, payMode, alias, autoRenewFlag, cbsSnap, cbsType, deadline, dealId, dealName, deviceId, dom0Ip, fsType, hostBlockSize, path, portable, projectId, qcloudZone, target, tranId, vmBlockSize, volumeType, zone, flag, encrypt, transactionId, isNewDisk, throughValue, iopsValue, deleteWithInstance, shareable, orderId, cdcId, migrating, migratePercent, encryptTime, snapshotSize, snapshotCount, insType, insId, insUuid, backupMode, deleteMode, backupQuota, backupCount, clusterGroupId, outpost_id, addTimeStamp, modTimeStamp FROM cCbs WHERE cbsInstanceId = ?;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 7,
        "code_end_line": 68,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tID                 int64     `gorm:\"column:cbsId;primaryKey\"`\n\tAppID              int64     `gorm:\"column:appId\"`\n\tAlias              string    `gorm:\"column:alias\"`\n\tAssigned           int       `gorm:\"column:assigned\"`\n\tAttached           int       `gorm:\"column:attached\"`\n\tAutoRenewFlag      int       `gorm:\"column:autoRenewFlag\"`\n\tCbsInstanceID      string    `gorm:\"column:cbsInstanceId;uniuq_index\"`\n\tCbsSnap            int       `gorm:\"column:cbsSnap\"`\n\tCbsType            string    `gorm:\"column:cbsType\"`\n\tCbsUuid            string    `gorm:\"column:cbsUuid\"`\n\tDeadline           time.Time `gorm:\"column:deadline\"`\n\tDealID             int       `gorm:\"column:dealId\"`\n\tDealName           string    `gorm:\"column:dealName\"`\n\tDeviceID           int64     `gorm:\"column:deviceId\"`\n\tDiskSize           int       `gorm:\"column:diskSize\"`\n\tDiskType           string    `gorm:\"column:diskType\"`\n\tDom0Ip             string    `gorm:\"column:dom0Ip\"`\n\tFsType             string    `gorm:\"column:fsType\"`\n\tHostBlockSize      int       `gorm:\"column:hostBlockSize\"`\n\tLifeState          string    `gorm:\"column:lifeState\"`\n\tPath               string    `gorm:\"column:path\"`\n\tPayMode            string    `gorm:\"column:payMode\"`\n\tPortable           int       `gorm:\"column:portable\"`\n\tProjectID          int       `gorm:\"column:projectId\"`\n\tQcloudZone         int       `gorm:\"column:qcloudZone\"`\n\tStatus             int       `gorm:\"column:status\"`\n\tTarget             string    `gorm:\"column:target\"`\n\tTranID             string    `gorm:\"column:tranId\"`\n\tVmBlockSize        int       `gorm:\"column:vmBlockSize\"`\n\tVolumeType         string    `gorm:\"column:volumeType\"`\n\tZone               int       `gorm:\"column:zone\"`\n\tRollbacking        int       `gorm:\"column:rollbacking;default:0\"`\n\tRollbackPercent    int       `gorm:\"column:rollbackPercent;default:0\"`\n\tArchType           string    `gorm:\"column:archType\"`\n\tFlag               int       `gorm:\"column:flag;default:0\"`\n\tEncrypt            string    `gorm:\"column:encrypt\"`\n\tTransactionID      string    `gorm:\"column:transactionId\"`\n\tIsNewDisk          int       `gorm:\"column:isNewDisk;default:0\"`\n\tThroughValue       int       `gorm:\"column:throughValue\"`\n\tIopsValue          int       `gorm:\"column:iopsValue\"`\n\tDeleteWithInstance int       `gorm:\"column:deleteWithInstance\"`\n\tShareable          int       `gorm:\"column:shareable\"`\n\tOrderID            string    `gorm:\"column:orderId\"`\n\tCdcID              string    `gorm:\"column:cdcId\"`\n\tMigrating          int       `gorm:\"column:migrating\"`\n\tMigratePercent     int       `gorm:\"column:migratePercent\"`\n\tEncryptTime        time.Time `gorm:\"column:encryptTime\"`\n\tSnapshotSize       int       `gorm:\"column:snapshotSize\"`\n\tSnapshotCount      int       `gorm:\"column:snapshotCount\"`\n\tInsType            string    `gorm:\"column:insType\"`\n\tInsID              string    `gorm:\"column:insId\"`\n\tInsUuid            string    `gorm:\"column:insUuid\"`\n\tBackupMode         int       `gorm:\"column:backupMode\"`\n\tDeleteMode         string    `gorm:\"column:deleteMode\"`\n\tBackupQuota        int       `gorm:\"column:backupQuota\"`\n\tBackupCount        int       `gorm:\"column:backupCount\"`\n\tClusterGroupId     string    `gorm:\"column:clusterGroupId\"`\n\tOutpostID          string    `gorm:\"column:outpost_id\"`\n\tCreatedAt          time.Time `gorm:\"column:addTimeStamp;type:time\"`\n\tUpdatedAt          time.Time `gorm:\"column:modTimeStamp;type:time\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 71,
        "code_end_line": 73,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/consumer_srv/domain/measure/repositories/cbs.go:22:32:QueryDiskInfoById",
    "orm_code": "func (cbsRepo *CbsBalanceRepo) QueryDiskInfoById(ctx context.Context, id string) (*ccdb.CCbs, error) {\n\tvar disk ccdb.CCbs\n\n\tresult := cbsRepo.DB.Where(\"cbsInstanceId = ?\", id).Find(&disk)\n\tif result.Error != nil {\n\t\treturn nil, result.Error\n\t} else if result.RowsAffected == 0 {\n\t\treturn nil, nil\n\t}\n\treturn &disk, nil\n}",
    "caller": "func (cbsSrv *CbsSrv) processSingleBalanceRecords(chargeItem *ChargeItem, beginBalanceRecord *ccdb.CCbsBalance, endBalanceRecord *ccdb.CCbsBalance, user *user.User, resourceId ResourceId) (stopCharge bool) {\n\tstopCharge = false\n\t// 资源欠费，不收取费用\n\tif beginBalanceRecord.OperationType == int(CbsOpArrearage) {\n\t\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(user.AppId)).Str(\"resourceId\", string(resourceId)).Msg(\"RESOURCE_ARREARAGE\")\n\t\treturn\n\t}\n\t// 资源退还。判断是否为预付费的性能突发场景\n\tif beginBalanceRecord.OperationType == int(CbsOpReturn) || beginBalanceRecord.OperationType == int(CbsOpConvert) {\n\t\t// 判断是否为预付费的性能突发场景.\n\t\t// 获取云盘信息。这里在循环中进行查询，但命中的应该不会很多，放在外层反而会导致每个云盘都被查询\n\t\tdisk, err := cbsSrv.diskRepo.QueryDiskInfoById(cbsSrv.ctx, string(resourceId))\n\t\tif err != nil || disk == nil {\n\t\t\tlogs.Error(cbsSrv.ctx).Err(err).Str(\"resourceId\", string(resourceId)).Msg(\"QUERY_CBS_RECORD_FAILED\")\n\t\t\t// TODO 这里先不返回资源的推量？\n\t\t\treturn true\n\t\t}\n\t\t// TODO 走diskLogical\n\t\tif disk.PayMode == \"prepay\" {\n\t\t\t// 性能突发场景，预付费用户退盘，退盘费用不计\n\t\t\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(user.AppId)).Str(\"resourceId\", string(resourceId)).Msg(\"MAYBE_CBS_WITH_BURST_PERFORMANCE\")\n\t\t\treturn\n\t\t}\n\t\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(user.AppId)).Str(\"resourceId\", string(resourceId)).Msg(\"CBS_HAS_RETURNED\")\n\t\treturn true\n\t}\n\n\t// 资源正常\n\tstartTime := beginBalanceRecord.LastBalanceTime\n\tendTime := endBalanceRecord.LastBalanceTime\n\tcurTime := startTime\n\tfor endTime.After(curTime) {\n\t\tcurHourEnd := time.Date(curTime.Year(), curTime.Month(), curTime.Day(), curTime.Hour(), 59, 59, 0, curTime.Location())\n\n\t\tvar config CCbsBalanceConfig\n\t\terr := json.Unmarshal([]byte(beginBalanceRecord.Config), &config)\n\t\tif err != nil {\n\t\t\tlogs.Error(cbsSrv.ctx).Err(err).Msg(\"PARSE_CONFIG_ERROR\")\n\t\t\treturn\n\t\t}\n\n\t\tcurEndTime := endTime\n\t\tcurStarTime := curTime\n\t\tif !endTime.After(curHourEnd) {\n\t\t\t// 同一周期\n\t\t\tcurTime = endTime.Add(time.Second)\n\t\t} else {\n\t\t\tcurEndTime = curHourEnd\n\t\t\tcurTime = curHourEnd.Add(time.Second)\n\t\t}\n\t\tsubItem := &SubItem{\n\t\t\tPid:       beginBalanceRecord.Pid,\n\t\t\tStartTime: curStarTime,\n\t\t\tEndTime:   curEndTime,\n\t\t\tProjectId: beginBalanceRecord.ProjectID,\n\t\t\tParams:    beginBalanceRecord.ResourceInfo,\n\t\t\tSubValueDetail: map[string]interface{}{\n\t\t\t\t// FIXME 性能突发场景待实现\n\t\t\t\t\"Size\":             config.Size,\n\t\t\t\t\"BackupPointQuota\": config.BackupPointQuota,\n\t\t\t},\n\t\t}\n\t\tchargeItem.Items = append(chargeItem.Items, subItem)\n\t}\n\treturn\n}",
    "sql_statement_list": [
      "SELECT cbsId, appId, cbsInstanceId, cbsUuid, diskSize, diskType, lifeState, status, rollbacking, rollbackPercent, archType, assigned, attached, payMode FROM cCbs WHERE cbsInstanceId = ?;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 7,
        "code_end_line": 68,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tID                 int64     `gorm:\"column:cbsId;primaryKey\"`\n\tAppID              int64     `gorm:\"column:appId\"`\n\tAlias              string    `gorm:\"column:alias\"`\n\tAssigned           int       `gorm:\"column:assigned\"`\n\tAttached           int       `gorm:\"column:attached\"`\n\tAutoRenewFlag      int       `gorm:\"column:autoRenewFlag\"`\n\tCbsInstanceID      string    `gorm:\"column:cbsInstanceId;uniuq_index\"`\n\tCbsSnap            int       `gorm:\"column:cbsSnap\"`\n\tCbsType            string    `gorm:\"column:cbsType\"`\n\tCbsUuid            string    `gorm:\"column:cbsUuid\"`\n\tDeadline           time.Time `gorm:\"column:deadline\"`\n\tDealID             int       `gorm:\"column:dealId\"`\n\tDealName           string    `gorm:\"column:dealName\"`\n\tDeviceID           int64     `gorm:\"column:deviceId\"`\n\tDiskSize           int       `gorm:\"column:diskSize\"`\n\tDiskType           string    `gorm:\"column:diskType\"`\n\tDom0Ip             string    `gorm:\"column:dom0Ip\"`\n\tFsType             string    `gorm:\"column:fsType\"`\n\tHostBlockSize      int       `gorm:\"column:hostBlockSize\"`\n\tLifeState          string    `gorm:\"column:lifeState\"`\n\tPath               string    `gorm:\"column:path\"`\n\tPayMode            string    `gorm:\"column:payMode\"`\n\tPortable           int       `gorm:\"column:portable\"`\n\tProjectID          int       `gorm:\"column:projectId\"`\n\tQcloudZone         int       `gorm:\"column:qcloudZone\"`\n\tStatus             int       `gorm:\"column:status\"`\n\tTarget             string    `gorm:\"column:target\"`\n\tTranID             string    `gorm:\"column:tranId\"`\n\tVmBlockSize        int       `gorm:\"column:vmBlockSize\"`\n\tVolumeType         string    `gorm:\"column:volumeType\"`\n\tZone               int       `gorm:\"column:zone\"`\n\tRollbacking        int       `gorm:\"column:rollbacking;default:0\"`\n\tRollbackPercent    int       `gorm:\"column:rollbackPercent;default:0\"`\n\tArchType           string    `gorm:\"column:archType\"`\n\tFlag               int       `gorm:\"column:flag;default:0\"`\n\tEncrypt            string    `gorm:\"column:encrypt\"`\n\tTransactionID      string    `gorm:\"column:transactionId\"`\n\tIsNewDisk          int       `gorm:\"column:isNewDisk;default:0\"`\n\tThroughValue       int       `gorm:\"column:throughValue\"`\n\tIopsValue          int       `gorm:\"column:iopsValue\"`\n\tDeleteWithInstance int       `gorm:\"column:deleteWithInstance\"`\n\tShareable          int       `gorm:\"column:shareable\"`\n\tOrderID            string    `gorm:\"column:orderId\"`\n\tCdcID              string    `gorm:\"column:cdcId\"`\n\tMigrating          int       `gorm:\"column:migrating\"`\n\tMigratePercent     int       `gorm:\"column:migratePercent\"`\n\tEncryptTime        time.Time `gorm:\"column:encryptTime\"`\n\tSnapshotSize       int       `gorm:\"column:snapshotSize\"`\n\tSnapshotCount      int       `gorm:\"column:snapshotCount\"`\n\tInsType            string    `gorm:\"column:insType\"`\n\tInsID              string    `gorm:\"column:insId\"`\n\tInsUuid            string    `gorm:\"column:insUuid\"`\n\tBackupMode         int       `gorm:\"column:backupMode\"`\n\tDeleteMode         string    `gorm:\"column:deleteMode\"`\n\tBackupQuota        int       `gorm:\"column:backupQuota\"`\n\tBackupCount        int       `gorm:\"column:backupCount\"`\n\tClusterGroupId     string    `gorm:\"column:clusterGroupId\"`\n\tOutpostID          string    `gorm:\"column:outpost_id\"`\n\tCreatedAt          time.Time `gorm:\"column:addTimeStamp;type:time\"`\n\tUpdatedAt          time.Time `gorm:\"column:modTimeStamp;type:time\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 71,
        "code_end_line": 73,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/consumer_srv/domain/measure/repositories/cbs.go:22:32:QueryDiskInfoById",
    "orm_code": "func (cbsRepo *CbsBalanceRepo) QueryDiskInfoById(ctx context.Context, id string) (*ccdb.CCbs, error) {\n\tvar disk ccdb.CCbs\n\n\tresult := cbsRepo.DB.Where(\"cbsInstanceId = ?\", id).Find(&disk)\n\tif result.Error != nil {\n\t\treturn nil, result.Error\n\t} else if result.RowsAffected == 0 {\n\t\treturn nil, nil\n\t}\n\treturn &disk, nil\n}",
    "caller": "func (cbsSrv *CbsSrv) processSingleBalanceRecords(chargeItem *ChargeItem, beginBalanceRecord *ccdb.CCbsBalance, endBalanceRecord *ccdb.CCbsBalance, user *user.User, resourceId ResourceId) (stopCharge bool) {\n\tstopCharge = false\n\t// 资源欠费，不收取费用\n\tif beginBalanceRecord.OperationType == int(CbsOpArrearage) {\n\t\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(user.AppId)).Str(\"resourceId\", string(resourceId)).Msg(\"RESOURCE_ARREARAGE\")\n\t\treturn\n\t}\n\t// 资源退还。判断是否为预付费的性能突发场景\n\tif beginBalanceRecord.OperationType == int(CbsOpReturn) || beginBalanceRecord.OperationType == int(CbsOpConvert) {\n\t\t// 判断是否为预付费的性能突发场景.\n\t\t// 获取云盘信息。这里在循环中进行查询，但命中的应该不会很多，放在外层反而会导致每个云盘都被查询\n\t\tdisk, err := cbsSrv.diskRepo.QueryDiskInfoById(cbsSrv.ctx, string(resourceId))\n\t\tif err != nil || disk == nil {\n\t\t\tlogs.Error(cbsSrv.ctx).Err(err).Str(\"resourceId\", string(resourceId)).Msg(\"QUERY_CBS_RECORD_FAILED\")\n\t\t\t// TODO 这里先不返回资源的推量？\n\t\t\treturn true\n\t\t}\n\t\t// TODO 走diskLogical\n\t\tif disk.PayMode == \"prepay\" {\n\t\t\t// 性能突发场景，预付费用户退盘，退盘费用不计\n\t\t\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(user.AppId)).Str(\"resourceId\", string(resourceId)).Msg(\"MAYBE_CBS_WITH_BURST_PERFORMANCE\")\n\t\t\treturn\n\t\t}\n\t\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(user.AppId)).Str(\"resourceId\", string(resourceId)).Msg(\"CBS_HAS_RETURNED\")\n\t\treturn true\n\t}\n\n\t// 资源正常\n\tstartTime := beginBalanceRecord.LastBalanceTime\n\tendTime := endBalanceRecord.LastBalanceTime\n\tcurTime := startTime\n\tfor endTime.After(curTime) {\n\t\tcurHourEnd := time.Date(curTime.Year(), curTime.Month(), curTime.Day(), curTime.Hour(), 59, 59, 0, curTime.Location())\n\n\t\tvar config CCbsBalanceConfig\n\t\terr := json.Unmarshal([]byte(beginBalanceRecord.Config), &config)\n\t\tif err != nil {\n\t\t\tlogs.Error(cbsSrv.ctx).Err(err).Msg(\"PARSE_CONFIG_ERROR\")\n\t\t\treturn\n\t\t}\n\n\t\tcurEndTime := endTime\n\t\tcurStarTime := curTime\n\t\tif !endTime.After(curHourEnd) {\n\t\t\t// 同一周期\n\t\t\tcurTime = endTime.Add(time.Second)\n\t\t} else {\n\t\t\tcurEndTime = curHourEnd\n\t\t\tcurTime = curHourEnd.Add(time.Second)\n\t\t}\n\t\tsubItem := &SubItem{\n\t\t\tPid:       beginBalanceRecord.Pid,\n\t\t\tStartTime: curStarTime,\n\t\t\tEndTime:   curEndTime,\n\t\t\tProjectId: beginBalanceRecord.ProjectID,\n\t\t\tParams:    beginBalanceRecord.ResourceInfo,\n\t\t\tSubValueDetail: map[string]interface{}{\n\t\t\t\t// FIXME 性能突发场景待实现\n\t\t\t\t\"Size\":             config.Size,\n\t\t\t\t\"BackupPointQuota\": config.BackupPointQuota,\n\t\t\t},\n\t\t}\n\t\tchargeItem.Items = append(chargeItem.Items, subItem)\n\t}\n\treturn\n}",
    "sql_statement_list": [
      "SELECT * FROM cCbs WHERE cbsInstanceId = ?;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 7,
        "code_end_line": 68,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tID                 int64     `gorm:\"column:cbsId;primaryKey\"`\n\tAppID              int64     `gorm:\"column:appId\"`\n\tAlias              string    `gorm:\"column:alias\"`\n\tAssigned           int       `gorm:\"column:assigned\"`\n\tAttached           int       `gorm:\"column:attached\"`\n\tAutoRenewFlag      int       `gorm:\"column:autoRenewFlag\"`\n\tCbsInstanceID      string    `gorm:\"column:cbsInstanceId;uniuq_index\"`\n\tCbsSnap            int       `gorm:\"column:cbsSnap\"`\n\tCbsType            string    `gorm:\"column:cbsType\"`\n\tCbsUuid            string    `gorm:\"column:cbsUuid\"`\n\tDeadline           time.Time `gorm:\"column:deadline\"`\n\tDealID             int       `gorm:\"column:dealId\"`\n\tDealName           string    `gorm:\"column:dealName\"`\n\tDeviceID           int64     `gorm:\"column:deviceId\"`\n\tDiskSize           int       `gorm:\"column:diskSize\"`\n\tDiskType           string    `gorm:\"column:diskType\"`\n\tDom0Ip             string    `gorm:\"column:dom0Ip\"`\n\tFsType             string    `gorm:\"column:fsType\"`\n\tHostBlockSize      int       `gorm:\"column:hostBlockSize\"`\n\tLifeState          string    `gorm:\"column:lifeState\"`\n\tPath               string    `gorm:\"column:path\"`\n\tPayMode            string    `gorm:\"column:payMode\"`\n\tPortable           int       `gorm:\"column:portable\"`\n\tProjectID          int       `gorm:\"column:projectId\"`\n\tQcloudZone         int       `gorm:\"column:qcloudZone\"`\n\tStatus             int       `gorm:\"column:status\"`\n\tTarget             string    `gorm:\"column:target\"`\n\tTranID             string    `gorm:\"column:tranId\"`\n\tVmBlockSize        int       `gorm:\"column:vmBlockSize\"`\n\tVolumeType         string    `gorm:\"column:volumeType\"`\n\tZone               int       `gorm:\"column:zone\"`\n\tRollbacking        int       `gorm:\"column:rollbacking;default:0\"`\n\tRollbackPercent    int       `gorm:\"column:rollbackPercent;default:0\"`\n\tArchType           string    `gorm:\"column:archType\"`\n\tFlag               int       `gorm:\"column:flag;default:0\"`\n\tEncrypt            string    `gorm:\"column:encrypt\"`\n\tTransactionID      string    `gorm:\"column:transactionId\"`\n\tIsNewDisk          int       `gorm:\"column:isNewDisk;default:0\"`\n\tThroughValue       int       `gorm:\"column:throughValue\"`\n\tIopsValue          int       `gorm:\"column:iopsValue\"`\n\tDeleteWithInstance int       `gorm:\"column:deleteWithInstance\"`\n\tShareable          int       `gorm:\"column:shareable\"`\n\tOrderID            string    `gorm:\"column:orderId\"`\n\tCdcID              string    `gorm:\"column:cdcId\"`\n\tMigrating          int       `gorm:\"column:migrating\"`\n\tMigratePercent     int       `gorm:\"column:migratePercent\"`\n\tEncryptTime        time.Time `gorm:\"column:encryptTime\"`\n\tSnapshotSize       int       `gorm:\"column:snapshotSize\"`\n\tSnapshotCount      int       `gorm:\"column:snapshotCount\"`\n\tInsType            string    `gorm:\"column:insType\"`\n\tInsID              string    `gorm:\"column:insId\"`\n\tInsUuid            string    `gorm:\"column:insUuid\"`\n\tBackupMode         int       `gorm:\"column:backupMode\"`\n\tDeleteMode         string    `gorm:\"column:deleteMode\"`\n\tBackupQuota        int       `gorm:\"column:backupQuota\"`\n\tBackupCount        int       `gorm:\"column:backupCount\"`\n\tClusterGroupId     string    `gorm:\"column:clusterGroupId\"`\n\tOutpostID          string    `gorm:\"column:outpost_id\"`\n\tCreatedAt          time.Time `gorm:\"column:addTimeStamp;type:time\"`\n\tUpdatedAt          time.Time `gorm:\"column:modTimeStamp;type:time\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 71,
        "code_end_line": 73,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/repositories/disk.go:15:29:QueryDiskInfoById",
    "orm_code": "func (d *DiskRepo) QueryDiskInfoById(ctx context.Context, id string) (*ccdb.CCbs, error) {\n\tvar disk ccdb.CCbs\n\n\tdb, err := d.getCCDBDb(ctx)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tresult := db.Where(\"cbsInstanceId = ?\", id).Find(&disk)\n\tif result.Error != nil {\n\t\treturn nil, result.Error\n\t} else if result.RowsAffected == 0 {\n\t\treturn nil, nil\n\t}\n\treturn &disk, nil\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT cbsId, appId, cbsInstanceId, cbsUuid, diskSize, diskType, lifeState, status, rollbacking, rollbackPercent, archType, assigned, attached, payMode, alias, autoRenewFlag, cbsSnap, cbsType, deadline, dealId, dealName, deviceId, dom0Ip, fsType, hostBlockSize, path, portable, projectId, qcloudZone, target, tranId, vmBlockSize, volumeType, zone, flag, encrypt, transactionId, isNewDisk, throughValue, iopsValue, deleteWithInstance, shareable, orderId, cdcId, migrating, migratePercent, encryptTime, snapshotSize, snapshotCount, insType, insId, insUuid, backupMode, deleteMode, backupQuota, backupCount, clusterGroupId, outpost_id, addTimeStamp, modTimeStamp FROM cCbs WHERE cbsInstanceId = ?;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 7,
        "code_end_line": 68,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tID                 int64     `gorm:\"column:cbsId;primaryKey\"`\n\tAppID              int64     `gorm:\"column:appId\"`\n\tAlias              string    `gorm:\"column:alias\"`\n\tAssigned           int       `gorm:\"column:assigned\"`\n\tAttached           int       `gorm:\"column:attached\"`\n\tAutoRenewFlag      int       `gorm:\"column:autoRenewFlag\"`\n\tCbsInstanceID      string    `gorm:\"column:cbsInstanceId;uniuq_index\"`\n\tCbsSnap            int       `gorm:\"column:cbsSnap\"`\n\tCbsType            string    `gorm:\"column:cbsType\"`\n\tCbsUuid            string    `gorm:\"column:cbsUuid\"`\n\tDeadline           time.Time `gorm:\"column:deadline\"`\n\tDealID             int       `gorm:\"column:dealId\"`\n\tDealName           string    `gorm:\"column:dealName\"`\n\tDeviceID           int64     `gorm:\"column:deviceId\"`\n\tDiskSize           int       `gorm:\"column:diskSize\"`\n\tDiskType           string    `gorm:\"column:diskType\"`\n\tDom0Ip             string    `gorm:\"column:dom0Ip\"`\n\tFsType             string    `gorm:\"column:fsType\"`\n\tHostBlockSize      int       `gorm:\"column:hostBlockSize\"`\n\tLifeState          string    `gorm:\"column:lifeState\"`\n\tPath               string    `gorm:\"column:path\"`\n\tPayMode            string    `gorm:\"column:payMode\"`\n\tPortable           int       `gorm:\"column:portable\"`\n\tProjectID          int       `gorm:\"column:projectId\"`\n\tQcloudZone         int       `gorm:\"column:qcloudZone\"`\n\tStatus             int       `gorm:\"column:status\"`\n\tTarget             string    `gorm:\"column:target\"`\n\tTranID             string    `gorm:\"column:tranId\"`\n\tVmBlockSize        int       `gorm:\"column:vmBlockSize\"`\n\tVolumeType         string    `gorm:\"column:volumeType\"`\n\tZone               int       `gorm:\"column:zone\"`\n\tRollbacking        int       `gorm:\"column:rollbacking;default:0\"`\n\tRollbackPercent    int       `gorm:\"column:rollbackPercent;default:0\"`\n\tArchType           string    `gorm:\"column:archType\"`\n\tFlag               int       `gorm:\"column:flag;default:0\"`\n\tEncrypt            string    `gorm:\"column:encrypt\"`\n\tTransactionID      string    `gorm:\"column:transactionId\"`\n\tIsNewDisk          int       `gorm:\"column:isNewDisk;default:0\"`\n\tThroughValue       int       `gorm:\"column:throughValue\"`\n\tIopsValue          int       `gorm:\"column:iopsValue\"`\n\tDeleteWithInstance int       `gorm:\"column:deleteWithInstance\"`\n\tShareable          int       `gorm:\"column:shareable\"`\n\tOrderID            string    `gorm:\"column:orderId\"`\n\tCdcID              string    `gorm:\"column:cdcId\"`\n\tMigrating          int       `gorm:\"column:migrating\"`\n\tMigratePercent     int       `gorm:\"column:migratePercent\"`\n\tEncryptTime        time.Time `gorm:\"column:encryptTime\"`\n\tSnapshotSize       int       `gorm:\"column:snapshotSize\"`\n\tSnapshotCount      int       `gorm:\"column:snapshotCount\"`\n\tInsType            string    `gorm:\"column:insType\"`\n\tInsID              string    `gorm:\"column:insId\"`\n\tInsUuid            string    `gorm:\"column:insUuid\"`\n\tBackupMode         int       `gorm:\"column:backupMode\"`\n\tDeleteMode         string    `gorm:\"column:deleteMode\"`\n\tBackupQuota        int       `gorm:\"column:backupQuota\"`\n\tBackupCount        int       `gorm:\"column:backupCount\"`\n\tClusterGroupId     string    `gorm:\"column:clusterGroupId\"`\n\tOutpostID          string    `gorm:\"column:outpost_id\"`\n\tCreatedAt          time.Time `gorm:\"column:addTimeStamp;type:time\"`\n\tUpdatedAt          time.Time `gorm:\"column:modTimeStamp;type:time\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 71,
        "code_end_line": 73,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/repositories/disk.go:15:29:QueryDiskInfoById",
    "orm_code": "func (d *DiskRepo) QueryDiskInfoById(ctx context.Context, id string) (*ccdb.CCbs, error) {\n\tvar disk ccdb.CCbs\n\n\tdb, err := d.getCCDBDb(ctx)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tresult := db.Where(\"cbsInstanceId = ?\", id).Find(&disk)\n\tif result.Error != nil {\n\t\treturn nil, result.Error\n\t} else if result.RowsAffected == 0 {\n\t\treturn nil, nil\n\t}\n\treturn &disk, nil\n}",
    "caller": "func (cbsSrv *CbsSrv) processSingleBalanceRecords(chargeItem *ChargeItem, beginBalanceRecord *ccdb.CCbsBalance, endBalanceRecord *ccdb.CCbsBalance, user *user.User, resourceId ResourceId) (stopCharge bool) {\n\tstopCharge = false\n\t// 资源欠费，不收取费用\n\tif beginBalanceRecord.OperationType == int(CbsOpArrearage) {\n\t\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(user.AppId)).Str(\"resourceId\", string(resourceId)).Msg(\"RESOURCE_ARREARAGE\")\n\t\treturn\n\t}\n\t// 资源退还。判断是否为预付费的性能突发场景\n\tif beginBalanceRecord.OperationType == int(CbsOpReturn) || beginBalanceRecord.OperationType == int(CbsOpConvert) {\n\t\t// 判断是否为预付费的性能突发场景.\n\t\t// 获取云盘信息。这里在循环中进行查询，但命中的应该不会很多，放在外层反而会导致每个云盘都被查询\n\t\tdisk, err := cbsSrv.diskRepo.QueryDiskInfoById(cbsSrv.ctx, string(resourceId))\n\t\tif err != nil || disk == nil {\n\t\t\tlogs.Error(cbsSrv.ctx).Err(err).Str(\"resourceId\", string(resourceId)).Msg(\"QUERY_CBS_RECORD_FAILED\")\n\t\t\t// TODO 这里先不返回资源的推量？\n\t\t\treturn true\n\t\t}\n\t\t// TODO 走diskLogical\n\t\tif disk.PayMode == \"prepay\" {\n\t\t\t// 性能突发场景，预付费用户退盘，退盘费用不计\n\t\t\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(user.AppId)).Str(\"resourceId\", string(resourceId)).Msg(\"MAYBE_CBS_WITH_BURST_PERFORMANCE\")\n\t\t\treturn\n\t\t}\n\t\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(user.AppId)).Str(\"resourceId\", string(resourceId)).Msg(\"CBS_HAS_RETURNED\")\n\t\treturn true\n\t}\n\n\t// 资源正常\n\tstartTime := beginBalanceRecord.LastBalanceTime\n\tendTime := endBalanceRecord.LastBalanceTime\n\tcurTime := startTime\n\tfor endTime.After(curTime) {\n\t\tcurHourEnd := time.Date(curTime.Year(), curTime.Month(), curTime.Day(), curTime.Hour(), 59, 59, 0, curTime.Location())\n\n\t\tvar config CCbsBalanceConfig\n\t\terr := json.Unmarshal([]byte(beginBalanceRecord.Config), &config)\n\t\tif err != nil {\n\t\t\tlogs.Error(cbsSrv.ctx).Err(err).Msg(\"PARSE_CONFIG_ERROR\")\n\t\t\treturn\n\t\t}\n\n\t\tcurEndTime := endTime\n\t\tcurStarTime := curTime\n\t\tif !endTime.After(curHourEnd) {\n\t\t\t// 同一周期\n\t\t\tcurTime = endTime.Add(time.Second)\n\t\t} else {\n\t\t\tcurEndTime = curHourEnd\n\t\t\tcurTime = curHourEnd.Add(time.Second)\n\t\t}\n\t\tsubItem := &SubItem{\n\t\t\tPid:       beginBalanceRecord.Pid,\n\t\t\tStartTime: curStarTime,\n\t\t\tEndTime:   curEndTime,\n\t\t\tProjectId: beginBalanceRecord.ProjectID,\n\t\t\tParams:    beginBalanceRecord.ResourceInfo,\n\t\t\tSubValueDetail: map[string]interface{}{\n\t\t\t\t// FIXME 性能突发场景待实现\n\t\t\t\t\"Size\":             config.Size,\n\t\t\t\t\"BackupPointQuota\": config.BackupPointQuota,\n\t\t\t},\n\t\t}\n\t\tchargeItem.Items = append(chargeItem.Items, subItem)\n\t}\n\treturn\n}",
    "sql_statement_list": [
      "SELECT cbsId, appId, cbsInstanceId, cbsUuid, diskSize, diskType, lifeState, status, rollbacking, rollbackPercent, archType, assigned, attached, payMode, alias, autoRenewFlag, cbsSnap, cbsType, deadline, dealId, dealName, deviceId, dom0Ip, fsType, hostBlockSize, path, portable, projectId, qcloudZone, target, tranId, vmBlockSize, volumeType, zone, flag, encrypt, transactionId, isNewDisk, throughValue, iopsValue, deleteWithInstance, shareable, orderId, cdcId, migrating, migratePercent, encryptTime, snapshotSize, snapshotCount, insType, insId, insUuid, backupMode, deleteMode, backupQuota, backupCount, clusterGroupId, outpost_id, addTimeStamp, modTimeStamp FROM cCbs WHERE cbsInstanceId = ?;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 7,
        "code_end_line": 68,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tID                 int64     `gorm:\"column:cbsId;primaryKey\"`\n\tAppID              int64     `gorm:\"column:appId\"`\n\tAlias              string    `gorm:\"column:alias\"`\n\tAssigned           int       `gorm:\"column:assigned\"`\n\tAttached           int       `gorm:\"column:attached\"`\n\tAutoRenewFlag      int       `gorm:\"column:autoRenewFlag\"`\n\tCbsInstanceID      string    `gorm:\"column:cbsInstanceId;uniuq_index\"`\n\tCbsSnap            int       `gorm:\"column:cbsSnap\"`\n\tCbsType            string    `gorm:\"column:cbsType\"`\n\tCbsUuid            string    `gorm:\"column:cbsUuid\"`\n\tDeadline           time.Time `gorm:\"column:deadline\"`\n\tDealID             int       `gorm:\"column:dealId\"`\n\tDealName           string    `gorm:\"column:dealName\"`\n\tDeviceID           int64     `gorm:\"column:deviceId\"`\n\tDiskSize           int       `gorm:\"column:diskSize\"`\n\tDiskType           string    `gorm:\"column:diskType\"`\n\tDom0Ip             string    `gorm:\"column:dom0Ip\"`\n\tFsType             string    `gorm:\"column:fsType\"`\n\tHostBlockSize      int       `gorm:\"column:hostBlockSize\"`\n\tLifeState          string    `gorm:\"column:lifeState\"`\n\tPath               string    `gorm:\"column:path\"`\n\tPayMode            string    `gorm:\"column:payMode\"`\n\tPortable           int       `gorm:\"column:portable\"`\n\tProjectID          int       `gorm:\"column:projectId\"`\n\tQcloudZone         int       `gorm:\"column:qcloudZone\"`\n\tStatus             int       `gorm:\"column:status\"`\n\tTarget             string    `gorm:\"column:target\"`\n\tTranID             string    `gorm:\"column:tranId\"`\n\tVmBlockSize        int       `gorm:\"column:vmBlockSize\"`\n\tVolumeType         string    `gorm:\"column:volumeType\"`\n\tZone               int       `gorm:\"column:zone\"`\n\tRollbacking        int       `gorm:\"column:rollbacking;default:0\"`\n\tRollbackPercent    int       `gorm:\"column:rollbackPercent;default:0\"`\n\tArchType           string    `gorm:\"column:archType\"`\n\tFlag               int       `gorm:\"column:flag;default:0\"`\n\tEncrypt            string    `gorm:\"column:encrypt\"`\n\tTransactionID      string    `gorm:\"column:transactionId\"`\n\tIsNewDisk          int       `gorm:\"column:isNewDisk;default:0\"`\n\tThroughValue       int       `gorm:\"column:throughValue\"`\n\tIopsValue          int       `gorm:\"column:iopsValue\"`\n\tDeleteWithInstance int       `gorm:\"column:deleteWithInstance\"`\n\tShareable          int       `gorm:\"column:shareable\"`\n\tOrderID            string    `gorm:\"column:orderId\"`\n\tCdcID              string    `gorm:\"column:cdcId\"`\n\tMigrating          int       `gorm:\"column:migrating\"`\n\tMigratePercent     int       `gorm:\"column:migratePercent\"`\n\tEncryptTime        time.Time `gorm:\"column:encryptTime\"`\n\tSnapshotSize       int       `gorm:\"column:snapshotSize\"`\n\tSnapshotCount      int       `gorm:\"column:snapshotCount\"`\n\tInsType            string    `gorm:\"column:insType\"`\n\tInsID              string    `gorm:\"column:insId\"`\n\tInsUuid            string    `gorm:\"column:insUuid\"`\n\tBackupMode         int       `gorm:\"column:backupMode\"`\n\tDeleteMode         string    `gorm:\"column:deleteMode\"`\n\tBackupQuota        int       `gorm:\"column:backupQuota\"`\n\tBackupCount        int       `gorm:\"column:backupCount\"`\n\tClusterGroupId     string    `gorm:\"column:clusterGroupId\"`\n\tOutpostID          string    `gorm:\"column:outpost_id\"`\n\tCreatedAt          time.Time `gorm:\"column:addTimeStamp;type:time\"`\n\tUpdatedAt          time.Time `gorm:\"column:modTimeStamp;type:time\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 71,
        "code_end_line": 73,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/repositories/disk.go:15:29:QueryDiskInfoById",
    "orm_code": "func (d *DiskRepo) QueryDiskInfoById(ctx context.Context, id string) (*ccdb.CCbs, error) {\n\tvar disk ccdb.CCbs\n\n\tdb, err := d.getCCDBDb(ctx)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tresult := db.Where(\"cbsInstanceId = ?\", id).Find(&disk)\n\tif result.Error != nil {\n\t\treturn nil, result.Error\n\t} else if result.RowsAffected == 0 {\n\t\treturn nil, nil\n\t}\n\treturn &disk, nil\n}",
    "caller": "func (cbsSrv *CbsSrv) processSingleBalanceRecords(chargeItem *ChargeItem, beginBalanceRecord *ccdb.CCbsBalance, endBalanceRecord *ccdb.CCbsBalance, user *user.User, resourceId ResourceId) (stopCharge bool) {\n\tstopCharge = false\n\t// 资源欠费，不收取费用\n\tif beginBalanceRecord.OperationType == int(CbsOpArrearage) {\n\t\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(user.AppId)).Str(\"resourceId\", string(resourceId)).Msg(\"RESOURCE_ARREARAGE\")\n\t\treturn\n\t}\n\t// 资源退还。判断是否为预付费的性能突发场景\n\tif beginBalanceRecord.OperationType == int(CbsOpReturn) || beginBalanceRecord.OperationType == int(CbsOpConvert) {\n\t\t// 判断是否为预付费的性能突发场景.\n\t\t// 获取云盘信息。这里在循环中进行查询，但命中的应该不会很多，放在外层反而会导致每个云盘都被查询\n\t\tdisk, err := cbsSrv.diskRepo.QueryDiskInfoById(cbsSrv.ctx, string(resourceId))\n\t\tif err != nil || disk == nil {\n\t\t\tlogs.Error(cbsSrv.ctx).Err(err).Str(\"resourceId\", string(resourceId)).Msg(\"QUERY_CBS_RECORD_FAILED\")\n\t\t\t// TODO 这里先不返回资源的推量？\n\t\t\treturn true\n\t\t}\n\t\t// TODO 走diskLogical\n\t\tif disk.PayMode == \"prepay\" {\n\t\t\t// 性能突发场景，预付费用户退盘，退盘费用不计\n\t\t\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(user.AppId)).Str(\"resourceId\", string(resourceId)).Msg(\"MAYBE_CBS_WITH_BURST_PERFORMANCE\")\n\t\t\treturn\n\t\t}\n\t\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(user.AppId)).Str(\"resourceId\", string(resourceId)).Msg(\"CBS_HAS_RETURNED\")\n\t\treturn true\n\t}\n\n\t// 资源正常\n\tstartTime := beginBalanceRecord.LastBalanceTime\n\tendTime := endBalanceRecord.LastBalanceTime\n\tcurTime := startTime\n\tfor endTime.After(curTime) {\n\t\tcurHourEnd := time.Date(curTime.Year(), curTime.Month(), curTime.Day(), curTime.Hour(), 59, 59, 0, curTime.Location())\n\n\t\tvar config CCbsBalanceConfig\n\t\terr := json.Unmarshal([]byte(beginBalanceRecord.Config), &config)\n\t\tif err != nil {\n\t\t\tlogs.Error(cbsSrv.ctx).Err(err).Msg(\"PARSE_CONFIG_ERROR\")\n\t\t\treturn\n\t\t}\n\n\t\tcurEndTime := endTime\n\t\tcurStarTime := curTime\n\t\tif !endTime.After(curHourEnd) {\n\t\t\t// 同一周期\n\t\t\tcurTime = endTime.Add(time.Second)\n\t\t} else {\n\t\t\tcurEndTime = curHourEnd\n\t\t\tcurTime = curHourEnd.Add(time.Second)\n\t\t}\n\t\tsubItem := &SubItem{\n\t\t\tPid:       beginBalanceRecord.Pid,\n\t\t\tStartTime: curStarTime,\n\t\t\tEndTime:   curEndTime,\n\t\t\tProjectId: beginBalanceRecord.ProjectID,\n\t\t\tParams:    beginBalanceRecord.ResourceInfo,\n\t\t\tSubValueDetail: map[string]interface{}{\n\t\t\t\t// FIXME 性能突发场景待实现\n\t\t\t\t\"Size\":             config.Size,\n\t\t\t\t\"BackupPointQuota\": config.BackupPointQuota,\n\t\t\t},\n\t\t}\n\t\tchargeItem.Items = append(chargeItem.Items, subItem)\n\t}\n\treturn\n}",
    "sql_statement_list": [
      "SELECT cbsId, appId, cbsInstanceId, cbsUuid, diskSize, diskType, lifeState, status, rollbacking, rollbackPercent, archType, assigned, attached, payMode, alias, autoRenewFlag, cbsSnap, cbsType, deadline, dealId, dealName, deviceId, dom0Ip, fsType, hostBlockSize, path, portable, projectId, qcloudZone, target, tranId, vmBlockSize, volumeType, zone, flag, encrypt, transactionId, isNewDisk, throughValue, iopsValue, deleteWithInstance, shareable, orderId, cdcId, migrating, migratePercent, encryptTime, snapshotSize, snapshotCount, insType, insId, insUuid, backupMode, deleteMode, backupQuota, backupCount, clusterGroupId, outpost_id, addTimeStamp, modTimeStamp FROM cCbs WHERE cbsInstanceId = ?;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 7,
        "code_end_line": 68,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tID                 int64     `gorm:\"column:cbsId;primaryKey\"`\n\tAppID              int64     `gorm:\"column:appId\"`\n\tAlias              string    `gorm:\"column:alias\"`\n\tAssigned           int       `gorm:\"column:assigned\"`\n\tAttached           int       `gorm:\"column:attached\"`\n\tAutoRenewFlag      int       `gorm:\"column:autoRenewFlag\"`\n\tCbsInstanceID      string    `gorm:\"column:cbsInstanceId;uniuq_index\"`\n\tCbsSnap            int       `gorm:\"column:cbsSnap\"`\n\tCbsType            string    `gorm:\"column:cbsType\"`\n\tCbsUuid            string    `gorm:\"column:cbsUuid\"`\n\tDeadline           time.Time `gorm:\"column:deadline\"`\n\tDealID             int       `gorm:\"column:dealId\"`\n\tDealName           string    `gorm:\"column:dealName\"`\n\tDeviceID           int64     `gorm:\"column:deviceId\"`\n\tDiskSize           int       `gorm:\"column:diskSize\"`\n\tDiskType           string    `gorm:\"column:diskType\"`\n\tDom0Ip             string    `gorm:\"column:dom0Ip\"`\n\tFsType             string    `gorm:\"column:fsType\"`\n\tHostBlockSize      int       `gorm:\"column:hostBlockSize\"`\n\tLifeState          string    `gorm:\"column:lifeState\"`\n\tPath               string    `gorm:\"column:path\"`\n\tPayMode            string    `gorm:\"column:payMode\"`\n\tPortable           int       `gorm:\"column:portable\"`\n\tProjectID          int       `gorm:\"column:projectId\"`\n\tQcloudZone         int       `gorm:\"column:qcloudZone\"`\n\tStatus             int       `gorm:\"column:status\"`\n\tTarget             string    `gorm:\"column:target\"`\n\tTranID             string    `gorm:\"column:tranId\"`\n\tVmBlockSize        int       `gorm:\"column:vmBlockSize\"`\n\tVolumeType         string    `gorm:\"column:volumeType\"`\n\tZone               int       `gorm:\"column:zone\"`\n\tRollbacking        int       `gorm:\"column:rollbacking;default:0\"`\n\tRollbackPercent    int       `gorm:\"column:rollbackPercent;default:0\"`\n\tArchType           string    `gorm:\"column:archType\"`\n\tFlag               int       `gorm:\"column:flag;default:0\"`\n\tEncrypt            string    `gorm:\"column:encrypt\"`\n\tTransactionID      string    `gorm:\"column:transactionId\"`\n\tIsNewDisk          int       `gorm:\"column:isNewDisk;default:0\"`\n\tThroughValue       int       `gorm:\"column:throughValue\"`\n\tIopsValue          int       `gorm:\"column:iopsValue\"`\n\tDeleteWithInstance int       `gorm:\"column:deleteWithInstance\"`\n\tShareable          int       `gorm:\"column:shareable\"`\n\tOrderID            string    `gorm:\"column:orderId\"`\n\tCdcID              string    `gorm:\"column:cdcId\"`\n\tMigrating          int       `gorm:\"column:migrating\"`\n\tMigratePercent     int       `gorm:\"column:migratePercent\"`\n\tEncryptTime        time.Time `gorm:\"column:encryptTime\"`\n\tSnapshotSize       int       `gorm:\"column:snapshotSize\"`\n\tSnapshotCount      int       `gorm:\"column:snapshotCount\"`\n\tInsType            string    `gorm:\"column:insType\"`\n\tInsID              string    `gorm:\"column:insId\"`\n\tInsUuid            string    `gorm:\"column:insUuid\"`\n\tBackupMode         int       `gorm:\"column:backupMode\"`\n\tDeleteMode         string    `gorm:\"column:deleteMode\"`\n\tBackupQuota        int       `gorm:\"column:backupQuota\"`\n\tBackupCount        int       `gorm:\"column:backupCount\"`\n\tClusterGroupId     string    `gorm:\"column:clusterGroupId\"`\n\tOutpostID          string    `gorm:\"column:outpost_id\"`\n\tCreatedAt          time.Time `gorm:\"column:addTimeStamp;type:time\"`\n\tUpdatedAt          time.Time `gorm:\"column:modTimeStamp;type:time\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 71,
        "code_end_line": 73,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/consumer_srv/domain/measure/repositories/base.go:48:65:UpdateResBalanceRecord",
    "orm_code": "func (repo *BalanceRepo) UpdateResBalanceRecord(ctx context.Context, appId int64, resourceId string, balanceUpdateDetails []*BalanceUpdateDetail, tableName string) error {\n\terr := repo.DB.Transaction(func(tx *gorm.DB) error {\n\t\tfor _, detail := range balanceUpdateDetails {\n\t\t\tupdateKVs := map[string]interface{}{\n\t\t\t\t\"status\":          detail.Status,\n\t\t\t\t\"lastBalanceTime\": detail.LastBalanceTime,\n\t\t\t}\n\t\t\tresult := tx.Table(tableName).\n\t\t\t\tWhere(\"appId = ? and resourceId = ? and id = ?\", appId, resourceId, detail.BalanceId).\n\t\t\t\tUpdates(updateKVs)\n\t\t\tif result.Error != nil {\n\t\t\t\treturn result.Error\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\treturn err\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "balanceUpdateDetails数组为空",
            "sql": ""
          },
          {
            "scenario": "balanceUpdateDetails数组包含元素时的UPDATE语句",
            "sql": "UPDATE ? SET status = ?, lastBalanceTime = ? WHERE appId = ? and resourceId = ? and id = ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/consumer_srv/domain/measure/repositories/base.go:48:65:UpdateResBalanceRecord",
    "orm_code": "func (repo *BalanceRepo) UpdateResBalanceRecord(ctx context.Context, appId int64, resourceId string, balanceUpdateDetails []*BalanceUpdateDetail, tableName string) error {\n\terr := repo.DB.Transaction(func(tx *gorm.DB) error {\n\t\tfor _, detail := range balanceUpdateDetails {\n\t\t\tupdateKVs := map[string]interface{}{\n\t\t\t\t\"status\":          detail.Status,\n\t\t\t\t\"lastBalanceTime\": detail.LastBalanceTime,\n\t\t\t}\n\t\t\tresult := tx.Table(tableName).\n\t\t\t\tWhere(\"appId = ? and resourceId = ? and id = ?\", appId, resourceId, detail.BalanceId).\n\t\t\t\tUpdates(updateKVs)\n\t\t\tif result.Error != nil {\n\t\t\t\treturn result.Error\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\treturn err\n}",
    "caller": "func (cbsSrv *CbsSrv) UpdateResBalanceRecords(appId user.AppId, chargeItem *ChargeItem) error {\n\n\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(appId)).\n\t\tStr(\"resourceId\", string(chargeItem.ResourceId)).Msg(\"UPDATE_CBS_BALANCE_RECORD\")\n\n\tvar err error\n\tdetails := make([]*repositories.BalanceUpdateDetail, 0)\n\tfor _, updateKV := range chargeItem.UpdateKVs {\n\t\tdetails = append(details, &repositories.BalanceUpdateDetail{\n\t\t\tBalanceId:       updateKV.Id,\n\t\t\tStatus:          updateKV.Status,\n\t\t\tLastBalanceTime: updateKV.LastBalanceTime,\n\t\t})\n\n\t}\n\n\terr = cbsSrv.balanceRepo.UpdateResBalanceRecord(\n\t\tcbsSrv.ctx,\n\t\tint64(appId),\n\t\tstring(chargeItem.ResourceId),\n\t\tdetails,\n\t\tcbsSrv.balanceRepo.GetBalanceTableName(),\n\t)\n\n\tif err != nil {\n\t\tlogs.Error(cbsSrv.ctx).Err(err).Uint64(\"appId\", uint64(chargeItem.AppId)).\n\t\t\tStr(\"resourceId\", string(chargeItem.ResourceId)).Msg(\"UPDATE_CBS_BALANCE_RECORD_FAILED\")\n\t}\n\n\treturn err\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "details数组包含1个元素",
            "sql": "UPDATE balance_records SET status = ?, lastBalanceTime = ? WHERE appId = ? AND resourceId = ? AND id = ?;"
          },
          {
            "scenario": "details数组包含多个元素时的每条UPDATE语句",
            "sql": "UPDATE balance_records SET status = ?, lastBalanceTime = ? WHERE appId = ? AND resourceId = ? AND id = ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/consumer_srv/domain/measure/repositories/base.go:48:65:UpdateResBalanceRecord",
    "orm_code": "func (repo *BalanceRepo) UpdateResBalanceRecord(ctx context.Context, appId int64, resourceId string, balanceUpdateDetails []*BalanceUpdateDetail, tableName string) error {\n\terr := repo.DB.Transaction(func(tx *gorm.DB) error {\n\t\tfor _, detail := range balanceUpdateDetails {\n\t\t\tupdateKVs := map[string]interface{}{\n\t\t\t\t\"status\":          detail.Status,\n\t\t\t\t\"lastBalanceTime\": detail.LastBalanceTime,\n\t\t\t}\n\t\t\tresult := tx.Table(tableName).\n\t\t\t\tWhere(\"appId = ? and resourceId = ? and id = ?\", appId, resourceId, detail.BalanceId).\n\t\t\t\tUpdates(updateKVs)\n\t\t\tif result.Error != nil {\n\t\t\t\treturn result.Error\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\treturn err\n}",
    "caller": "func (snapSrv *SnapSrv) UpdateResBalanceRecords(appId user.AppId, chargeItem *ChargeItem) error {\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/consumer_srv/domain/measure/repositories/base.go:48:65:UpdateResBalanceRecord",
    "orm_code": "func (repo *BalanceRepo) UpdateResBalanceRecord(ctx context.Context, appId int64, resourceId string, balanceUpdateDetails []*BalanceUpdateDetail, tableName string) error {\n\terr := repo.DB.Transaction(func(tx *gorm.DB) error {\n\t\tfor _, detail := range balanceUpdateDetails {\n\t\t\tupdateKVs := map[string]interface{}{\n\t\t\t\t\"status\":          detail.Status,\n\t\t\t\t\"lastBalanceTime\": detail.LastBalanceTime,\n\t\t\t}\n\t\t\tresult := tx.Table(tableName).\n\t\t\t\tWhere(\"appId = ? and resourceId = ? and id = ?\", appId, resourceId, detail.BalanceId).\n\t\t\t\tUpdates(updateKVs)\n\t\t\tif result.Error != nil {\n\t\t\t\treturn result.Error\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\treturn err\n}",
    "caller": "func (cbsSrv *CbsSrv) UpdateResBalanceRecords(appId user.AppId, chargeItem *ChargeItem) error {\n\n\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(appId)).\n\t\tStr(\"resourceId\", string(chargeItem.ResourceId)).Msg(\"UPDATE_CBS_BALANCE_RECORD\")\n\n\tvar err error\n\tdetails := make([]*BalanceUpdateDetail, 0)\n\tfor _, updateKV := range chargeItem.UpdateKVs {\n\t\tdetails = append(details, &BalanceUpdateDetail{\n\t\t\tBalanceId:       updateKV.Id,\n\t\t\tStatus:          updateKV.Status,\n\t\t\tLastBalanceTime: updateKV.LastBalanceTime,\n\t\t})\n\n\t}\n\n\terr = cbsSrv.measureRepo.UpdateResBalanceRecord(\n\t\tcbsSrv.ctx,\n\t\tint64(appId),\n\t\tstring(chargeItem.ResourceId),\n\t\tdetails,\n\t\tcbsSrv.measureRepo.GetBalanceTableName(),\n\t)\n\n\treturn err\n}",
    "sql_statement_list": [
      "UPDATE {tableName} SET status = ?, lastBalanceTime = ? WHERE appId = ? AND resourceId = ? AND id = ?;"
    ],
    "sql_types": [
      "UPDATE"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/repositories/measure.go:82:104:UpdateResBalanceRecord",
    "orm_code": "func (repo *MeasureRepo) UpdateResBalanceRecord(ctx context.Context, appId int64, resourceId string, balanceUpdateDetails []*measure.BalanceUpdateDetail, tableName string) error {\n\tdb, err := repo.getCCDBDb(ctx)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\terr = db.Transaction(func(tx *gorm.DB) error {\n\t\tfor _, detail := range balanceUpdateDetails {\n\t\t\tupdateKVs := map[string]interface{}{\n\t\t\t\t\"status\":          detail.Status,\n\t\t\t\t\"lastBalanceTime\": detail.LastBalanceTime,\n\t\t\t}\n\t\t\tresult := tx.Table(tableName).\n\t\t\t\tWhere(\"appId = ? and resourceId = ? and id = ?\", appId, resourceId, detail.BalanceId).\n\t\t\t\tUpdates(updateKVs)\n\t\t\tif result.Error != nil {\n\t\t\t\treturn result.Error\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\treturn err\n}",
    "caller": "",
    "sql_statement_list": [
      "UPDATE ? SET status = ?, lastBalanceTime = ? WHERE appId = ? AND resourceId = ? AND id = ?;"
    ],
    "sql_types": [
      "UPDATE"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/repositories/measure.go:82:104:UpdateResBalanceRecord",
    "orm_code": "func (repo *MeasureRepo) UpdateResBalanceRecord(ctx context.Context, appId int64, resourceId string, balanceUpdateDetails []*measure.BalanceUpdateDetail, tableName string) error {\n\tdb, err := repo.getCCDBDb(ctx)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\terr = db.Transaction(func(tx *gorm.DB) error {\n\t\tfor _, detail := range balanceUpdateDetails {\n\t\t\tupdateKVs := map[string]interface{}{\n\t\t\t\t\"status\":          detail.Status,\n\t\t\t\t\"lastBalanceTime\": detail.LastBalanceTime,\n\t\t\t}\n\t\t\tresult := tx.Table(tableName).\n\t\t\t\tWhere(\"appId = ? and resourceId = ? and id = ?\", appId, resourceId, detail.BalanceId).\n\t\t\t\tUpdates(updateKVs)\n\t\t\tif result.Error != nil {\n\t\t\t\treturn result.Error\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\treturn err\n}",
    "caller": "func (cbsSrv *CbsSrv) UpdateResBalanceRecords(appId user.AppId, chargeItem *ChargeItem) error {\n\n\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(appId)).\n\t\tStr(\"resourceId\", string(chargeItem.ResourceId)).Msg(\"UPDATE_CBS_BALANCE_RECORD\")\n\n\tvar err error\n\tdetails := make([]*repositories.BalanceUpdateDetail, 0)\n\tfor _, updateKV := range chargeItem.UpdateKVs {\n\t\tdetails = append(details, &repositories.BalanceUpdateDetail{\n\t\t\tBalanceId:       updateKV.Id,\n\t\t\tStatus:          updateKV.Status,\n\t\t\tLastBalanceTime: updateKV.LastBalanceTime,\n\t\t})\n\n\t}\n\n\terr = cbsSrv.balanceRepo.UpdateResBalanceRecord(\n\t\tcbsSrv.ctx,\n\t\tint64(appId),\n\t\tstring(chargeItem.ResourceId),\n\t\tdetails,\n\t\tcbsSrv.balanceRepo.GetBalanceTableName(),\n\t)\n\n\tif err != nil {\n\t\tlogs.Error(cbsSrv.ctx).Err(err).Uint64(\"appId\", uint64(chargeItem.AppId)).\n\t\t\tStr(\"resourceId\", string(chargeItem.ResourceId)).Msg(\"UPDATE_CBS_BALANCE_RECORD_FAILED\")\n\t}\n\n\treturn err\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "单个余额记录更新",
            "sql": "UPDATE {tableName} SET status = ?, lastBalanceTime = ? WHERE appId = ? AND resourceId = ? AND id = ?;"
          },
          {
            "scenario": "多个余额记录更新 - 第一条记录",
            "sql": "UPDATE {tableName} SET status = ?, lastBalanceTime = ? WHERE appId = ? AND resourceId = ? AND id = ?;"
          },
          {
            "scenario": "多个余额记录更新 - 第二条记录",
            "sql": "UPDATE {tableName} SET status = ?, lastBalanceTime = ? WHERE appId = ? AND resourceId = ? AND id = ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/repositories/measure.go:82:104:UpdateResBalanceRecord",
    "orm_code": "func (repo *MeasureRepo) UpdateResBalanceRecord(ctx context.Context, appId int64, resourceId string, balanceUpdateDetails []*measure.BalanceUpdateDetail, tableName string) error {\n\tdb, err := repo.getCCDBDb(ctx)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\terr = db.Transaction(func(tx *gorm.DB) error {\n\t\tfor _, detail := range balanceUpdateDetails {\n\t\t\tupdateKVs := map[string]interface{}{\n\t\t\t\t\"status\":          detail.Status,\n\t\t\t\t\"lastBalanceTime\": detail.LastBalanceTime,\n\t\t\t}\n\t\t\tresult := tx.Table(tableName).\n\t\t\t\tWhere(\"appId = ? and resourceId = ? and id = ?\", appId, resourceId, detail.BalanceId).\n\t\t\t\tUpdates(updateKVs)\n\t\t\tif result.Error != nil {\n\t\t\t\treturn result.Error\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\treturn err\n}",
    "caller": "func (snapSrv *SnapSrv) UpdateResBalanceRecords(appId user.AppId, chargeItem *ChargeItem) error {\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/repositories/measure.go:82:104:UpdateResBalanceRecord",
    "orm_code": "func (repo *MeasureRepo) UpdateResBalanceRecord(ctx context.Context, appId int64, resourceId string, balanceUpdateDetails []*measure.BalanceUpdateDetail, tableName string) error {\n\tdb, err := repo.getCCDBDb(ctx)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\terr = db.Transaction(func(tx *gorm.DB) error {\n\t\tfor _, detail := range balanceUpdateDetails {\n\t\t\tupdateKVs := map[string]interface{}{\n\t\t\t\t\"status\":          detail.Status,\n\t\t\t\t\"lastBalanceTime\": detail.LastBalanceTime,\n\t\t\t}\n\t\t\tresult := tx.Table(tableName).\n\t\t\t\tWhere(\"appId = ? and resourceId = ? and id = ?\", appId, resourceId, detail.BalanceId).\n\t\t\t\tUpdates(updateKVs)\n\t\t\tif result.Error != nil {\n\t\t\t\treturn result.Error\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\treturn err\n}",
    "caller": "func (cbsSrv *CbsSrv) UpdateResBalanceRecords(appId user.AppId, chargeItem *ChargeItem) error {\n\n\tlogs.Info(cbsSrv.ctx).Uint64(\"appId\", uint64(appId)).\n\t\tStr(\"resourceId\", string(chargeItem.ResourceId)).Msg(\"UPDATE_CBS_BALANCE_RECORD\")\n\n\tvar err error\n\tdetails := make([]*BalanceUpdateDetail, 0)\n\tfor _, updateKV := range chargeItem.UpdateKVs {\n\t\tdetails = append(details, &BalanceUpdateDetail{\n\t\t\tBalanceId:       updateKV.Id,\n\t\t\tStatus:          updateKV.Status,\n\t\t\tLastBalanceTime: updateKV.LastBalanceTime,\n\t\t})\n\n\t}\n\n\terr = cbsSrv.measureRepo.UpdateResBalanceRecord(\n\t\tcbsSrv.ctx,\n\t\tint64(appId),\n\t\tstring(chargeItem.ResourceId),\n\t\tdetails,\n\t\tcbsSrv.measureRepo.GetBalanceTableName(),\n\t)\n\n\treturn err\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "空数组情况",
            "sql": ""
          },
          {
            "scenario": "有更新记录情况",
            "sql": "UPDATE balance_records SET status = ?, lastBalanceTime = ? WHERE appId = ? AND resourceId = ? AND id = ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/repositories/disk.go:31:49:QueryRollbackingDiskList",
    "orm_code": "func (d *DiskRepo) QueryRollbackingDiskList(ctx context.Context) ([]*ccdb.CCbs, error) {\n\tvar diskList []*ccdb.CCbs\n\n\tdb, err := d.getCCDBDb(ctx)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tcond1 := db.Where(\"lifeState IN ?\", []ccdb.DiskLifeState{ccdb.DiskLifeStateNormal, ccdb.DiskLifeStateIsolated})\n\tcond2 := db.Where(\"lifeState = ?\", ccdb.DiskLifeStateConcealed).\n\t\tWhere(\"status IN ?\", []ccdb.DiskStatus{ccdb.DiskAttached, ccdb.DiskInited})\n\tquery := db.Where(\"rollbacking IN ?\", []ccdb.DiskRollbackType{ccdb.SameDiskRb, ccdb.DiffDiskRb, ccdb.FastRb})\n\tresult := query.Where(cond1.Or(cond2)).Find(&diskList)\n\n\tif result.Error != nil {\n\t\treturn nil, result.Error\n\t}\n\treturn diskList, nil\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT * FROM cCbs WHERE rollbacking IN (?, ?, ?) AND (lifeState IN (?, ?) OR (lifeState = ? AND status IN (?, ?)));"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 7,
        "code_end_line": 68,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tID                 int64     `gorm:\"column:cbsId;primaryKey\"`\n\tAppID              int64     `gorm:\"column:appId\"`\n\tAlias              string    `gorm:\"column:alias\"`\n\tAssigned           int       `gorm:\"column:assigned\"`\n\tAttached           int       `gorm:\"column:attached\"`\n\tAutoRenewFlag      int       `gorm:\"column:autoRenewFlag\"`\n\tCbsInstanceID      string    `gorm:\"column:cbsInstanceId;uniuq_index\"`\n\tCbsSnap            int       `gorm:\"column:cbsSnap\"`\n\tCbsType            string    `gorm:\"column:cbsType\"`\n\tCbsUuid            string    `gorm:\"column:cbsUuid\"`\n\tDeadline           time.Time `gorm:\"column:deadline\"`\n\tDealID             int       `gorm:\"column:dealId\"`\n\tDealName           string    `gorm:\"column:dealName\"`\n\tDeviceID           int64     `gorm:\"column:deviceId\"`\n\tDiskSize           int       `gorm:\"column:diskSize\"`\n\tDiskType           string    `gorm:\"column:diskType\"`\n\tDom0Ip             string    `gorm:\"column:dom0Ip\"`\n\tFsType             string    `gorm:\"column:fsType\"`\n\tHostBlockSize      int       `gorm:\"column:hostBlockSize\"`\n\tLifeState          string    `gorm:\"column:lifeState\"`\n\tPath               string    `gorm:\"column:path\"`\n\tPayMode            string    `gorm:\"column:payMode\"`\n\tPortable           int       `gorm:\"column:portable\"`\n\tProjectID          int       `gorm:\"column:projectId\"`\n\tQcloudZone         int       `gorm:\"column:qcloudZone\"`\n\tStatus             int       `gorm:\"column:status\"`\n\tTarget             string    `gorm:\"column:target\"`\n\tTranID             string    `gorm:\"column:tranId\"`\n\tVmBlockSize        int       `gorm:\"column:vmBlockSize\"`\n\tVolumeType         string    `gorm:\"column:volumeType\"`\n\tZone               int       `gorm:\"column:zone\"`\n\tRollbacking        int       `gorm:\"column:rollbacking;default:0\"`\n\tRollbackPercent    int       `gorm:\"column:rollbackPercent;default:0\"`\n\tArchType           string    `gorm:\"column:archType\"`\n\tFlag               int       `gorm:\"column:flag;default:0\"`\n\tEncrypt            string    `gorm:\"column:encrypt\"`\n\tTransactionID      string    `gorm:\"column:transactionId\"`\n\tIsNewDisk          int       `gorm:\"column:isNewDisk;default:0\"`\n\tThroughValue       int       `gorm:\"column:throughValue\"`\n\tIopsValue          int       `gorm:\"column:iopsValue\"`\n\tDeleteWithInstance int       `gorm:\"column:deleteWithInstance\"`\n\tShareable          int       `gorm:\"column:shareable\"`\n\tOrderID            string    `gorm:\"column:orderId\"`\n\tCdcID              string    `gorm:\"column:cdcId\"`\n\tMigrating          int       `gorm:\"column:migrating\"`\n\tMigratePercent     int       `gorm:\"column:migratePercent\"`\n\tEncryptTime        time.Time `gorm:\"column:encryptTime\"`\n\tSnapshotSize       int       `gorm:\"column:snapshotSize\"`\n\tSnapshotCount      int       `gorm:\"column:snapshotCount\"`\n\tInsType            string    `gorm:\"column:insType\"`\n\tInsID              string    `gorm:\"column:insId\"`\n\tInsUuid            string    `gorm:\"column:insUuid\"`\n\tBackupMode         int       `gorm:\"column:backupMode\"`\n\tDeleteMode         string    `gorm:\"column:deleteMode\"`\n\tBackupQuota        int       `gorm:\"column:backupQuota\"`\n\tBackupCount        int       `gorm:\"column:backupCount\"`\n\tClusterGroupId     string    `gorm:\"column:clusterGroupId\"`\n\tOutpostID          string    `gorm:\"column:outpost_id\"`\n\tCreatedAt          time.Time `gorm:\"column:addTimeStamp;type:time\"`\n\tUpdatedAt          time.Time `gorm:\"column:modTimeStamp;type:time\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 71,
        "code_end_line": 73,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/cbs_packing_srv/infra/types/names.go",
        "code_start_line": 10,
        "code_end_line": 10,
        "code_key": "DiskStatus",
        "code_value": "type DiskStatus uint8",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/repositories/disk.go:31:49:QueryRollbackingDiskList",
    "orm_code": "func (d *DiskRepo) QueryRollbackingDiskList(ctx context.Context) ([]*ccdb.CCbs, error) {\n\tvar diskList []*ccdb.CCbs\n\n\tdb, err := d.getCCDBDb(ctx)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tcond1 := db.Where(\"lifeState IN ?\", []ccdb.DiskLifeState{ccdb.DiskLifeStateNormal, ccdb.DiskLifeStateIsolated})\n\tcond2 := db.Where(\"lifeState = ?\", ccdb.DiskLifeStateConcealed).\n\t\tWhere(\"status IN ?\", []ccdb.DiskStatus{ccdb.DiskAttached, ccdb.DiskInited})\n\tquery := db.Where(\"rollbacking IN ?\", []ccdb.DiskRollbackType{ccdb.SameDiskRb, ccdb.DiffDiskRb, ccdb.FastRb})\n\tresult := query.Where(cond1.Or(cond2)).Find(&diskList)\n\n\tif result.Error != nil {\n\t\treturn nil, result.Error\n\t}\n\treturn diskList, nil\n}",
    "caller": "func (s *UpdateRollbackTaskScanner) getCCbsRollbackTask(ctx context.Context) error {\n\t// cCbs表回滚进度更新\n\tdiskRepo := registry.GetRegistry(ctx).AdapterRepos.DiskRepo.(adapter_interfaces.DiskInterface)\n\tdiskRollbackList, err := diskRepo.QueryRollbackingDiskList(ctx)\n\tif err != nil {\n\t\treturn err\n\t}\n\tfor _, diskRecord := range diskRollbackList {\n\t\tentity := &diskLogical.DiskEntity{\n\t\t\tDiskRecord: diskRecord,\n\t\t}\n\t\tdiskRollbackAgg := &diskLogical.DiskRollbackingTaskAggregate{\n\t\t\tDiskEntity:        entity,\n\t\t\tRollbackingEntity: nil,\n\t\t\tTaskName:          core.UpdateCCbsNormalRBTask,\n\t\t\tSubTaskName:       core.UpdateCCbsNormalRBTask,\n\t\t}\n\t\ts.resultChan <- diskRollbackAgg\n\t}\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT * FROM cCbs WHERE rollbacking IN (?, ?, ?) AND ((lifeState IN (?, ?)) OR (lifeState = ? AND status IN (?, ?)));"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/consumer_srv/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 52,
        "code_end_line": 67,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tCbsId              int64  `gorm:\"column:cbsId;primaryKey\"`\n\tAppId              int64  `gorm:\"column:appId\"`\n\tCbsInstanceId      string `gorm:\"column:cbsInstanceId\"`\n\tCbsUuid            string `gorm:\"column:cbsUuid\"`\n\tDiskSize           int    `gorm:\"column:diskSize\"`\n\tDiskType           string `gorm:\"column:diskType\"`\n\tLifeState          string `gorm:\"column:lifeState\"`\n\tStatus             int    `gorm:\"column:status\"`\n\tRollbacking        int    `gorm:\"column:rollbacking\"`\n\tRollbackingPercent int    `gorm:\"column:rollbackPercent\"`\n\tArchType           string `gorm:\"column:archType\"`\n\tAssigned           int    `gorm:\"column:assigned\"`\n\tAttached           int    `gorm:\"column:attached\"`\n\tPayMode            string `gorm:\"column:payMode\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/scheduler/internal/adapter/db/ccdb/model.go",
        "code_start_line": 69,
        "code_end_line": 71,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 7,
        "code_end_line": 68,
        "code_key": "CCbs",
        "code_value": "type CCbs struct {\n\tID                 int64     `gorm:\"column:cbsId;primaryKey\"`\n\tAppID              int64     `gorm:\"column:appId\"`\n\tAlias              string    `gorm:\"column:alias\"`\n\tAssigned           int       `gorm:\"column:assigned\"`\n\tAttached           int       `gorm:\"column:attached\"`\n\tAutoRenewFlag      int       `gorm:\"column:autoRenewFlag\"`\n\tCbsInstanceID      string    `gorm:\"column:cbsInstanceId;uniuq_index\"`\n\tCbsSnap            int       `gorm:\"column:cbsSnap\"`\n\tCbsType            string    `gorm:\"column:cbsType\"`\n\tCbsUuid            string    `gorm:\"column:cbsUuid\"`\n\tDeadline           time.Time `gorm:\"column:deadline\"`\n\tDealID             int       `gorm:\"column:dealId\"`\n\tDealName           string    `gorm:\"column:dealName\"`\n\tDeviceID           int64     `gorm:\"column:deviceId\"`\n\tDiskSize           int       `gorm:\"column:diskSize\"`\n\tDiskType           string    `gorm:\"column:diskType\"`\n\tDom0Ip             string    `gorm:\"column:dom0Ip\"`\n\tFsType             string    `gorm:\"column:fsType\"`\n\tHostBlockSize      int       `gorm:\"column:hostBlockSize\"`\n\tLifeState          string    `gorm:\"column:lifeState\"`\n\tPath               string    `gorm:\"column:path\"`\n\tPayMode            string    `gorm:\"column:payMode\"`\n\tPortable           int       `gorm:\"column:portable\"`\n\tProjectID          int       `gorm:\"column:projectId\"`\n\tQcloudZone         int       `gorm:\"column:qcloudZone\"`\n\tStatus             int       `gorm:\"column:status\"`\n\tTarget             string    `gorm:\"column:target\"`\n\tTranID             string    `gorm:\"column:tranId\"`\n\tVmBlockSize        int       `gorm:\"column:vmBlockSize\"`\n\tVolumeType         string    `gorm:\"column:volumeType\"`\n\tZone               int       `gorm:\"column:zone\"`\n\tRollbacking        int       `gorm:\"column:rollbacking;default:0\"`\n\tRollbackPercent    int       `gorm:\"column:rollbackPercent;default:0\"`\n\tArchType           string    `gorm:\"column:archType\"`\n\tFlag               int       `gorm:\"column:flag;default:0\"`\n\tEncrypt            string    `gorm:\"column:encrypt\"`\n\tTransactionID      string    `gorm:\"column:transactionId\"`\n\tIsNewDisk          int       `gorm:\"column:isNewDisk;default:0\"`\n\tThroughValue       int       `gorm:\"column:throughValue\"`\n\tIopsValue          int       `gorm:\"column:iopsValue\"`\n\tDeleteWithInstance int       `gorm:\"column:deleteWithInstance\"`\n\tShareable          int       `gorm:\"column:shareable\"`\n\tOrderID            string    `gorm:\"column:orderId\"`\n\tCdcID              string    `gorm:\"column:cdcId\"`\n\tMigrating          int       `gorm:\"column:migrating\"`\n\tMigratePercent     int       `gorm:\"column:migratePercent\"`\n\tEncryptTime        time.Time `gorm:\"column:encryptTime\"`\n\tSnapshotSize       int       `gorm:\"column:snapshotSize\"`\n\tSnapshotCount      int       `gorm:\"column:snapshotCount\"`\n\tInsType            string    `gorm:\"column:insType\"`\n\tInsID              string    `gorm:\"column:insId\"`\n\tInsUuid            string    `gorm:\"column:insUuid\"`\n\tBackupMode         int       `gorm:\"column:backupMode\"`\n\tDeleteMode         string    `gorm:\"column:deleteMode\"`\n\tBackupQuota        int       `gorm:\"column:backupQuota\"`\n\tBackupCount        int       `gorm:\"column:backupCount\"`\n\tClusterGroupId     string    `gorm:\"column:clusterGroupId\"`\n\tOutpostID          string    `gorm:\"column:outpost_id\"`\n\tCreatedAt          time.Time `gorm:\"column:addTimeStamp;type:time\"`\n\tUpdatedAt          time.Time `gorm:\"column:modTimeStamp;type:time\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/rdisk_master/adapters/db/ccdb/model.go",
        "code_start_line": 71,
        "code_end_line": 73,
        "code_key": "TableName",
        "code_value": "func (CCbs) TableName() string {\n\treturn \"cCbs\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      },
      {
        "code_file": "/Users/freedom/llms/singularity/internal/cbs_packing_srv/infra/types/names.go",
        "code_start_line": 10,
        "code_end_line": 10,
        "code_key": "DiskStatus",
        "code_value": "type DiskStatus uint8",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:528:552:Cleanup",
    "orm_code": "func (l *mysqlLocker) Cleanup(ctx context.Context, opts *dlock.CleanupOption) error {\n\t// Apply default options if not provided.\n\tif opts == nil {\n\t\topts = defaultCleanupOption\n\t} else {\n\t\tif opts.MaxCount <= 0 {\n\t\t\topts.MaxCount = defaultCleanupOption.MaxCount\n\t\t}\n\t\tif opts.TimeAfterExpire <= 0 {\n\t\t\topts.TimeAfterExpire = defaultCleanupOption.TimeAfterExpire\n\t\t}\n\t}\n\n\treturn l.db.Transaction(func(tx *gorm.DB) error {\n\t\t// The order is important, we need to make sure that delete order is the same as the obtain order.\n\t\t// Otherwise deadlock may happen.\n\t\tresult := tx.Exec(\"DELETE FROM \"+l.tableName+\" WHERE \"+l.lockNumsColumn+\" = 0 ORDER BY `\"+l.lockColumn+\"` ASC LIMIT ?\", opts.MaxCount)\n\t\tif result.Error != nil {\n\t\t\treturn result.Error\n\t\t}\n\t\tresult = tx.Exec(\"DELETE FROM \"+l.tableName+\" WHERE \"+l.expireColumn+\" < NOW() - INTERVAL ? SECOND ORDER BY `\"+l.lockColumn+\"` ASC LIMIT ?\", opts.TimeAfterExpire.Seconds(), opts.MaxCount)\n\t\treturn result.Error\n\n\t}, &sql.TxOptions{Isolation: sql.LevelRepeatableRead})\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "删除锁计数为0的记录",
            "sql": "DELETE FROM {tableName} WHERE {lockNumsColumn} = 0 ORDER BY `{lockColumn}` ASC LIMIT ?;"
          },
          {
            "scenario": "删除过期记录",
            "sql": "DELETE FROM {tableName} WHERE {expireColumn} < NOW() - INTERVAL ? SECOND ORDER BY `{lockColumn}` ASC LIMIT ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "查询锁信息",
            "sql": "SELECT `lock_name` AS name, `expire_time` AS expire, `lock_token` AS token, `lock_type` AS type, `lock_nums` AS nums FROM lock_table WHERE `lock_name` = ? AND `expire_time` > NOW() LIMIT 1;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (a *Convertor) Start(ctx context.Context) error {\n\t// 启动转换器\n\tfor _, scanner := range a.scanners {\n\t\tscanner := scanner\n\t\tgo func() {\n\t\t\ta.convertToTask(ctx, scanner)\n\t\t}()\n\t}\n\tlogs.Info(ctx).Msgf(\"Convertor Start Success\")\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *CbsMeasureReconciliationTaskScanner) Start(ctx context.Context) error {\n\tgo func() {\n\t\t//s.resultChan <- struct{}{}\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-s.stopChan:\n\t\t\t\tbreak\n\t\t\tcase <-time.After(s.scanInterval):\n\t\t\t\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\ts.resultChan <- struct{}{}\n\t\t\t\t//if s.taskExecutable() {\n\t\t\t\t//\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\t//\ts.resultChan <- struct{}{}\n\t\t\t\t//}\n\t\t\t}\n\t\t}\n\t}()\n\tlogs.Info(ctx).Int64(\"scanInterval\", int64(s.scanInterval)).Msgf(\"%s Start Success\", s.name)\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *SnapMeasureReconciliationTaskScanner) Start(ctx context.Context) error {\n\tgo func() {\n\t\ts.resultChan <- struct{}{}\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-s.stopChan:\n\t\t\t\tbreak\n\t\t\tcase <-time.After(s.scanInterval):\n\t\t\t\tif s.taskExecutable() {\n\t\t\t\t\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\t\ts.resultChan <- struct{}{}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}()\n\tlogs.Info(ctx).Int64(\"scanInterval\", int64(s.scanInterval)).Msgf(\"%s Start Success\", s.name)\n\treturn nil\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "查询指定key的锁信息（字段名和表名由运行时变量确定）",
            "sql": "SELECT `lock_column` AS name, `expire_column` AS expire, `token_column` AS token, `lock_type_column` AS type, `lock_nums_column` AS nums FROM table_name WHERE `lock_column` = ? AND `expire_column` > NOW() LIMIT 1;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *SnapComputeTaskScanner) Start(ctx context.Context) error {\n\tgo func() {\n\t\t//s.resultChan <- struct{}{}\n\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-s.stopChan:\n\t\t\t\tbreak\n\t\t\tcase <-time.After(s.scanInterval):\n\t\t\t\tif s.taskExecutable() {\n\t\t\t\t\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\t\ts.resultChan <- struct{}{}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}()\n\tlogs.Info(ctx).Int64(\"scanInterval\", int64(s.scanInterval)).Msgf(\"%s Start Success\", s.name)\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT `lock_column` AS name, `expire_column` AS expire, `token_column` AS token, `lock_type_column` AS type, `lock_nums_column` AS nums FROM table_name WHERE `lock_column` = ? AND `expire_column` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *CbsMeasureSendTaskScanner) Start(ctx context.Context) error {\n\tgo func() {\n\t\ts.resultChan <- struct{}{}\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-s.stopChan:\n\t\t\t\tbreak\n\t\t\tcase <-time.After(s.scanInterval):\n\t\t\t\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\ts.resultChan <- struct{}{}\n\t\t\t\t//if s.taskExecutable() {\n\t\t\t\t//\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\t//\ts.resultChan <- struct{}{}\n\t\t\t\t//}\n\t\t\t}\n\t\t}\n\t}()\n\tlogs.Info(ctx).Int64(\"scanInterval\", int64(s.scanInterval)).Msgf(\"%s Start Success\", s.name)\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *CbsValidAppIdFetchTaskScanner) Start(ctx context.Context) error {\n\tgo func() {\n\t\ts.resultChan <- struct{}{}\n\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-s.stopChan:\n\t\t\t\tbreak\n\t\t\tcase <-time.After(s.scanInterval):\n\t\t\t\tif s.taskExecutable() {\n\t\t\t\t\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\t\ts.resultChan <- struct{}{}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}()\n\tlogs.Info(ctx).Int64(\"scanInterval\", int64(s.scanInterval)).Msgf(\"%s Start Success\", s.name)\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT `{lockColumn}` AS name, `{expireColumn}` AS expire, `{tokenColumn}` AS token, `{lockTypeColumn}` AS type, `{lockNumsColumn}` AS nums FROM {tableName} WHERE `{lockColumn}` = ? AND `{expireColumn}` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *SnapCalculateCostLocallyTaskScanner) Start(ctx context.Context) error {\n\t//s.resultChan <- struct{}{}\n\n\tgo func() {\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-s.stopChan:\n\t\t\t\tbreak\n\t\t\tcase <-time.After(s.scanInterval):\n\t\t\t\tif s.taskExecutable() {\n\t\t\t\t\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\t\ts.resultChan <- struct{}{}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}()\n\tlogs.Info(ctx).Int64(\"scanInterval\", int64(s.scanInterval)).Msgf(\"%s Start Success\", s.name)\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT `lock_name` AS name, `expire_time` AS expire, `token` AS token, `lock_type` AS type, `lock_nums` AS nums FROM distributed_locks WHERE `lock_name` = ? AND `expire_time` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *UpdateCreateTaskScanner) Start(ctx context.Context) error {\n\tgo func() {\n\t\trunning := true\n\t\tfor running {\n\t\t\tselect {\n\t\t\tcase <-s.stopChan:\n\t\t\t\trunning = false\n\t\t\tdefault:\n\t\t\t\terr := s.FullScan(ctx)\n\t\t\t\tif err != nil {\n\t\t\t\t\tlogs.Fatal(ctx).Msgf(\"%s full scan failed!\\n\", s.name)\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t\ttime.Sleep(s.scanInterval)\n\t\t}\n\t}()\n\tlogs.Info(ctx).Msgf(\"%s Start Success\", s.name)\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT `lock_name` AS name, `expire_time` AS expire, `token` AS token, `lock_type` AS type, `lock_nums` AS nums FROM lock_table WHERE `lock_name` = ? AND `expire_time` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *SnapMeasureSendTaskScanner) Start(ctx context.Context) error {\n\tgo func() {\n\t\t//s.resultChan <- struct{}{}\n\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-s.stopChan:\n\t\t\t\tbreak\n\t\t\tcase <-time.After(s.scanInterval):\n\t\t\t\tif s.taskExecutable() {\n\t\t\t\t\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\t\ts.resultChan <- struct{}{}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}()\n\tlogs.Info(ctx).Int64(\"scanInterval\", int64(s.scanInterval)).Msgf(\"%s Start Success\", s.name)\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT `lock_name` AS name, `expire_time` AS expire, `token` AS token, `lock_type` AS type, `lock_nums` AS nums FROM distributed_locks WHERE `lock_name` = ? AND `expire_time` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *RepushUserBillingTaskScanner) Start(ctx context.Context) error {\n\tgo func() {\n\t\ts.resultChan <- struct{}{}\n\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-s.stopChan:\n\t\t\t\tbreak\n\t\t\tcase <-time.After(s.scanInterval):\n\t\t\t\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\ts.resultChan <- struct{}{}\n\t\t\t\t//if s.taskExecutable() {\n\t\t\t\t//\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\t//\ts.resultChan <- struct{}{}\n\t\t\t\t//}\n\t\t\t}\n\t\t}\n\t}()\n\tlogs.Info(ctx).Int64(\"scanInterval\", int64(s.scanInterval)).Msgf(\"%s Start Success\", s.name)\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT `lock_column` AS name, `expire_column` AS expire, `token_column` AS token, `lock_type_column` AS type, `lock_nums_column` AS nums FROM table_name WHERE `lock_column` = ? AND `expire_column` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *UpdateRollbackTaskScanner) Start(ctx context.Context) error {\n\tgo func() {\n\t\trunning := true\n\t\tfor running {\n\t\t\tselect {\n\t\t\tcase <-s.stopChan:\n\t\t\t\trunning = false\n\t\t\tdefault:\n\t\t\t\terr := s.FullScan(ctx)\n\t\t\t\tif err != nil {\n\t\t\t\t\tlogs.Fatal(ctx).Msgf(\"%s full scan failed!\\n\", s.name)\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t\ttime.Sleep(s.scanInterval)\n\t\t}\n\t}()\n\tlogs.Info(ctx).Msgf(\"%s Start Success\", s.name)\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT `lock_name` AS name, `expire_time` AS expire, `lock_token` AS token, `lock_type` AS type, `lock_nums` AS nums FROM distributed_locks WHERE `lock_name` = ? AND `expire_time` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *SnapValidAppIdFetchTaskScanner) Start(ctx context.Context) error {\n\t//s.resultChan <- struct{}{}\n\tgo func() {\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-s.stopChan:\n\t\t\t\tbreak\n\t\t\tcase <-time.After(s.scanInterval):\n\t\t\t\tif s.taskExecutable() {\n\t\t\t\t\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\t\ts.resultChan <- struct{}{}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}()\n\tlogs.Info(ctx).Int64(\"scanInterval\", int64(s.scanInterval)).Msgf(\"%s Start Success\", s.name)\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT `lock_name` AS name, `expire_time` AS expire, `token` AS token, `lock_type` AS type, `lock_nums` AS nums FROM distributed_locks WHERE `lock_name` = ? AND `expire_time` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *CbsBillComputeTaskScanner) Start(ctx context.Context) error {\n\tgo func() {\n\t\ts.resultChan <- struct{}{}\n\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-s.stopChan:\n\t\t\t\tbreak\n\t\t\tcase <-time.After(s.scanInterval):\n\t\t\t\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\ts.resultChan <- struct{}{}\n\t\t\t\t//if s.taskExecutable() {\n\t\t\t\t//\tlogs.Info(ctx).Str(\"taskName\", s.name).Msg(\"ADD_NEW_TASK\")\n\t\t\t\t//\ts.resultChan <- struct{}{}\n\t\t\t\t//}\n\t\t\t}\n\t\t}\n\t}()\n\tlogs.Info(ctx).Int64(\"scanInterval\", int64(s.scanInterval)).Msgf(\"%s Start Success\", s.name)\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT `lock_name` AS name, `expire_time` AS expire, `token` AS token, `lock_type` AS type, `lock_nums` AS nums FROM distributed_locks WHERE `lock_name` = ? AND `expire_time` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (m *PipelineManager) Start(ctx context.Context) error {\n\tfor region, pipeline := range m.Pipelines {\n\t\tregionCtx := context.WithValue(ctx, \"region\", region)\n\t\tif err := pipeline.Start(regionCtx); err != nil {\n\t\t\treturn err\n\t\t}\n\t}\n\treturn nil\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "动态表名和字段名配置",
            "sql": "SELECT `lock_column_name` AS name, `expire_column_name` AS expire, `token_column_name` AS token, `lock_type_column_name` AS type, `lock_nums_column_name` AS nums FROM table_name WHERE `lock_column_name` = ? AND `expire_column_name` > NOW() LIMIT 1;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (app *NebulaApp) Start(ctx context.Context) error {\n\tif err := app.pipelineManager.Start(ctx); err != nil {\n\t\treturn err\n\t}\n\treturn <-app.stopChan\n}",
    "sql_statement_list": [
      "SELECT `{lockColumn}` AS name, `{expireColumn}` AS expire, `{tokenColumn}` AS token, `{lockTypeColumn}` AS type, `{lockNumsColumn}` AS nums FROM {tableName} WHERE `{lockColumn}` = ? AND `{expireColumn}` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (p *RegionPipeline) Start(ctx context.Context) error {\n\tregion := ctx.Value(\"region\").(string)\n\tscannerLogCtx := initLogger(ctx, region, \"scanner.log\")\n\tfor _, scanner := range p.scanners {\n\t\tsingleCtx := logs.AddDefaultMessage(scannerLogCtx, \"name\", scanner.GetName())\n\t\terr := scanner.Start(singleCtx)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\tinitMetric(scanner, region, \"scanner\", scanner.GetName())\n\t}\n\n\tconvertorLogCtx := initLogger(ctx, region, \"convertor.log\")\n\terr := p.convertor.Start(convertorLogCtx)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\t// start scheduler\n\tschedulerLogCtx := initLogger(ctx, region, \"scheduler.log\")\n\terr = p.scheduler.Start(schedulerLogCtx)\n\tif err != nil {\n\t\treturn err\n\t}\n\tinitMetric(p.scheduler, region, \"scheduler\", \"scheduler\")\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT `lock_column` AS name, `expire_column` AS expire, `token_column` AS token, `lock_type_column` AS type, `lock_nums_column` AS nums FROM table_name WHERE `lock_column` = ? AND `expire_column` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (sc *Scheduler) Start(ctx context.Context) error {\n\tgo sc.mainLoop(ctx)\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT `lock_column` AS name, `expire_column` AS expire, `token_column` AS token, `lock_type_column` AS type, `lock_nums_column` AS nums FROM table_name WHERE `lock_column` = ? AND `expire_column` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (s *scheduler) Start(ctx context.Context) error {\n\twg := sync.WaitGroup{}\n\trunning := true\n\tgo s.haManager.Start(ctx)\n\tdefer s.haManager.Close(ctx)\n\tfor {\n\t\tselect {\n\t\tcase taskName := <-s.eventChan:\n\t\t\twg.Add(1)\n\t\t\tgo func(name string) {\n\t\t\t\tdefer wg.Done()\n\t\t\t\tif task, ok := s.loads[name]; ok {\n\n\t\t\t\t\tif s.isMaster {\n\t\t\t\t\t\t_ctx := logs.With(ctx).Str(\"seqId\", uuid.New().String()).Str(\"taskName\", name).Logger().WithContext(ctx)\n\t\t\t\t\t\ttask.Work(_ctx)\n\t\t\t\t\t}\n\n\t\t\t\t\ttriggerTime := time.Now().Add(task.Interval())\n\t\t\t\t\tfor {\n\t\t\t\t\t\tif !running {\n\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif time.Now().After(triggerTime) {\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttime.Sleep(time.Second)\n\t\t\t\t\t}\n\t\t\t\t\ts.eventChan <- name\n\t\t\t\t}\n\t\t\t}(taskName)\n\t\tcase <-s.stopChan:\n\t\t\trunning = false\n\t\t\twg.Wait()\n\t\t\treturn nil\n\t\t}\n\t}\n}",
    "sql_statement_list": [
      "SELECT `{lockColumn}` AS name, `{expireColumn}` AS expire, `{tokenColumn}` AS token, `{lockTypeColumn}` AS type, `{lockNumsColumn}` AS nums FROM {tableName} WHERE `{lockColumn}` = ? AND `{expireColumn}` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (m *haManagerImpl) Start(ctx context.Context) {\n\tm.keepRunning = true\n\tm.ctx = ctx\n\tvar (\n\t\tmyIdentity            = m.delegate.GetIdentity()                                    // 当前节点的业务标识\n\t\tmyKey                 = fmt.Sprintf(\"easyhaMaster/%s\", url.PathEscape(m.namespace)) // 分布式锁的key\n\t\tmyToken               = m.encodeToken(myIdentity)                                   // 分布式锁 Token，包含业务标识和随机信息\n\t\tmyLock                dlock.Lock                                                    // 获取到的分布式锁, 用于刷新和释放\n\t\tcurrentMasterIdentity string                                                        // 当前 master 的业务标识，如果为空则是还未获取过当前 master\n\t)\n\n\t// Start slave loop.\n\tfor m.keepRunning {\n\t\t// Try observe the master lock first.\n\t\tif view, err := m.locker.Observe(ctx, myKey); err != nil {\n\t\t\tm.logger.Info().Err(err).Str(\"key\", myKey).Msg(\"failed to observe current master lock\")\n\t\t\t// Failed to observe the master lock, try to  obtain the lock.\n\t\t\tmyLock, err = m.locker.Obtain(ctx, dlock.NewWriteLockKey(myKey), m.lockExpired, &dlock.Option{Token: myToken})\n\t\t\tif err == nil {\n\t\t\t\t// Successfully obtained the lock.\n\t\t\t\tbreak\n\t\t\t}\n\t\t} else {\n\t\t\tnewIdentity, err := m.decodeToken(view.Token)\n\t\t\tif err != nil {\n\t\t\t\tm.logger.Warn().Err(err).Str(\"token\", view.Token).Msg(\"failed to decode token\")\n\t\t\t} else if currentMasterIdentity == \"\" {\n\t\t\t\t// First time to observe the master.\n\t\t\t\tcurrentMasterIdentity = newIdentity\n\t\t\t\tif err := m.delegate.OnBecomeSlave(ctx, currentMasterIdentity); err != nil {\n\t\t\t\t\tm.logger.Fatal().Err(err).Msg(\"failed to handle become slave, force quit for safety\")\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t} else if currentMasterIdentity != newIdentity {\n\t\t\t\t// Master changed. Need update.\n\t\t\t\tcurrentMasterIdentity = newIdentity\n\t\t\t\tif err := m.delegate.OnSwitchMaster(ctx, currentMasterIdentity); err != nil {\n\t\t\t\t\tm.logger.Fatal().Err(err).Msg(\"failed to handle switch master, force quit for safety\")\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\ttime.Sleep(m.checkInterval)\n\t}\n\n\tif myLock == nil {\n\t\tm.logger.Fatal().Msg(\"myLock is nil, found bug, force quit for safety\")\n\t\treturn\n\t}\n\n\t// I am the master now.\n\tif err := m.delegate.OnBecomeMaster(ctx); err != nil {\n\t\tmyLock.Release(ctx)\n\t\tm.logger.Fatal().Err(err).Msg(\"failed to handle become master, force quit for safety\")\n\t\treturn\n\t}\n\n\tdefer func() {\n\t\tmyLock.Release(ctx)\n\t\tif err := m.delegate.OnLostMaster(ctx); err != nil {\n\t\t\tm.logger.Fatal().Err(err).Msg(\"failed to handle lost master, force quit for safety\")\n\t\t}\n\t}()\n\n\t// Start the master loop.\n\tfor m.keepRunning {\n\t\ttime.Sleep(m.checkInterval)\n\t\tif err := myLock.Refresh(ctx, m.lockExpired); err != nil {\n\t\t\tbreak\n\t\t}\n\t}\n}",
    "sql_statement_list": [
      "SELECT `lock_column` AS name, `expire_column` AS expire, `token_column` AS token, `lock_type_column` AS type, `lock_nums_column` AS nums FROM table_name WHERE `lock_column` = ? AND `expire_column` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:555:588:Observe",
    "orm_code": "func (l *mysqlLocker) Observe(ctx context.Context, key string) (*dlock.LockView, error) {\n\n\tvar view dlock.LockView\n\tvar result struct {\n\t\tName   string\n\t\tExpire time.Time\n\t\tToken  string\n\t\tNums   int\n\t\tType   int\n\t}\n\n\terr := l.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.lockColumn+\"` AS name, `\"+l.expireColumn+\"` AS expire, `\"+l.tokenColumn+\"` AS token, `\"+l.lockTypeColumn+\"` AS type, `\"+l.lockNumsColumn+\"` AS nums FROM \"+l.tableName+\" WHERE `\"+l.lockColumn+\"` = ? AND `\"+l.expireColumn+\"` > NOW() LIMIT 1\", key).Scan(&result)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tif result.Name == \"\" {\n\t\treturn nil, errors.Errorf(\"lock not found for key %s\", key)\n\t}\n\n\tview.Key = result.Name\n\tview.TTL = time.Until(result.Expire)\n\tview.Token = result.Token\n\tview.Nums = result.Nums\n\tview.Type = dlock.LockType(result.Type)\n\n\treturn &view, nil\n}",
    "caller": "func (sc *Scheduler) deleteFinishTask(ctx context.Context, task interfaces.Task) {\n\tsubTaskName := task.GetSubTaskName()\n\tif _, ok := sc.metrics.taskExecuteCountMap[subTaskName]; !ok {\n\t\tsc.metrics.taskExecuteCountMap[subTaskName], _ = initHistogramVec(subTaskName).GetMetricWith(sc.metrics.labels)\n\t}\n\tsc.metrics.taskExecuteCountMap[subTaskName].Observe(float64(task.GetExecuteCounts()))\n\tsc.taskMap.Delete(task.GetTaskId())\n}",
    "sql_statement_list": [
      "SELECT `lock_column` AS name, `expire_column` AS expire, `token_column` AS token, `lock_type_column` AS type, `lock_nums_column` AS nums FROM table_name WHERE `lock_column` = ? AND `expire_column` > NOW() LIMIT 1;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/freedom/llms/singularity/pkg/dlock/dlock.go",
        "code_start_line": 153,
        "code_end_line": 159,
        "code_key": "LockView",
        "code_value": "type LockView struct {\n\tKey   string        // Key 是锁的键\n\tToken string        // Token 是锁的唯一令牌\n\tType  LockType      // Type 是锁的类型\n\tNums  int           // Nums 是持有锁的协程数（读锁）\n\tTTL   time.Duration // TTL 是锁的剩余时间\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7a6ce9d47c30a5bf582db3b759442d236a89c6c6"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:719:737:TTLs",
    "orm_code": "func (l *mysqlLock) TTLs(ctx context.Context) ([]time.Duration, error) {\n\tkeysKey := dlock.LockKeySlice(l.keys).GetKeys()\n\tvar expirations []time.Time\n\tvar results []time.Duration\n\terr := l.locker.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.locker.expireColumn+\"` AS `expiration` FROM \"+l.locker.tableName+\" WHERE `\"+l.locker.lockColumn+\"` = ?\", keysKey).Scan(&expirations)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tfor _, expiration := range expirations {\n\t\tresults = append(results, time.Until(expiration))\n\t}\n\treturn results, nil\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "动态表名和字段名的锁过期时间查询",
            "sql": "SELECT `expire_column` AS `expiration` FROM lock_table WHERE `lock_column` = ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:740:753:Num",
    "orm_code": "func (l *mysqlLock) Num(ctx context.Context) (int, error) {\n\tvar results int\n\terr := l.locker.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.locker.lockNumsColumn+\"` AS `num` FROM \"+l.locker.tableName+\" WHERE `\"+l.locker.lockColumn+\"` IN (?)\", l.keys[0].Key).Scan(&results)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn -1, err\n\t}\n\treturn results, nil\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT `lockNumsColumn` AS `num` FROM tableName WHERE `lockColumn` IN (?);",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "单个键值查询",
            "sql": "SELECT `lockNumsColumn` AS `num` FROM tableName WHERE `lockColumn` IN ('key_value');"
          },
          {
            "scenario": "多个键值查询",
            "sql": "SELECT `lockNumsColumn` AS `num` FROM tableName WHERE `lockColumn` IN ('key1', 'key2', 'key3');"
          }
        ]
      }
    ],
    "sql_types": [
      "SELECT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/freedom/llms/singularity/pkg/dlock/mysql/dlock.go:756:770:Nums",
    "orm_code": "func (l *mysqlLock) Nums(ctx context.Context) ([]int, error) {\n\tkeysKey := dlock.LockKeySlice(l.keys).GetKeys()\n\tvar results []int\n\terr := l.locker.db.Transaction(func(tx *gorm.DB) error {\n\t\top := tx.Raw(\"SELECT `\"+l.locker.lockNumsColumn+\"` AS `num` FROM \"+l.locker.tableName+\" WHERE `\"+l.locker.lockColumn+\"` IN (?)\", keysKey).Scan(&results)\n\t\tif op.Error != nil {\n\t\t\treturn op.Error\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn results, nil\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "单个锁键查询",
            "sql": "SELECT `lock_nums_column` AS `num` FROM table_name WHERE `lock_column` IN (?);"
          },
          {
            "scenario": "多个锁键查询",
            "sql": "SELECT `lock_nums_column` AS `num` FROM table_name WHERE `lock_column` IN (?, ?, ?);"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/5-28-cbs.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/CHAI__libradb-ha/library/orm/transaction.go:10:32:DoTransaction",
    "orm_code": "func DoTransaction(conn *gorm.DB, fn func(conn *gorm.DB) error) error {\n\tdefer func() {\n\t\tif errs := recover(); errs != nil {\n\t\t\tconn.Rollback()\n\t\t\tpanic(errs)\n\t\t}\n\t}()\n\n\t//参数校验\n\tif conn == nil {\n\t\treturn cdb_errors.InternalInnerCommonErrorErr.GenByArgs(\"DoTransaction conn is nil\")\n\t}\n\n\t//开启事务\n\tconn.Begin()\n\tif err := fn(conn); err != nil {\n\t\tconn.Rollback()\n\t\treturn cdb_errors.InternalInnerCommonErrorErr.GenByArgs(\"begin transaction err\")\n\t}\n\tconn.Commit()\n\n\treturn nil\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/CHAI__libradb-ha.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/data/policy_repo.go:243:284:DeleteAlarmPolicy",
    "orm_code": "func (repo *AlarmPolicyRepo) DeleteAlarmPolicy(ctx context.Context, appId int64, policyId string) error {\n\tclause := utils.SetSQLComment(ctx, utils.UpdateKey)\n\n\tdate := time.Now().Format(utils.DateTimeFormat)\n\terr := repo.db.Transaction(func(tx *gorm.DB) error {\n\t\t// 1.删除告警资源\n\t\tif err := tx.Clauses(clause).Table(model.AlarmPolicyTableName).\n\t\t\tWhere(\"app_id = ? AND id = ? AND deleted_at IS NULL\", appId, policyId).\n\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\"deleted_at\": date,\n\t\t\t}).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]delete alarm policy failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t// 2.删除告警资源\n\t\tif err := tx.Clauses(clause).Table(model.AlarmResourceTableName).\n\t\t\tWhere(\"policy_id = ? AND deleted_at IS NULL\", policyId).\n\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\"deleted_at\": date,\n\t\t\t}).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]delete alarm policy resource failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t// 3.删除告警通知子用户\n\t\tif err := tx.Clauses(clause).Table(model.NotifySubUserTableName).\n\t\t\tWhere(\"policy_id = ? AND deleted_at IS NULL\", policyId).\n\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\"deleted_at\": date,\n\t\t\t}).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]delete alarm policy notify sub user failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}",
    "caller": "",
    "sql_statement_list": [
      "UPDATE alarm_policy SET deleted_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;",
      "UPDATE alarm_resource SET deleted_at = ? WHERE policy_id = ? AND deleted_at IS NULL;",
      "UPDATE notify_sub_user SET deleted_at = ? WHERE policy_id = ? AND deleted_at IS NULL;"
    ],
    "sql_types": [
      "UPDATE",
      "UPDATE",
      "UPDATE"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-event-alarm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/data/policy_repo.go:243:284:DeleteAlarmPolicy",
    "orm_code": "func (repo *AlarmPolicyRepo) DeleteAlarmPolicy(ctx context.Context, appId int64, policyId string) error {\n\tclause := utils.SetSQLComment(ctx, utils.UpdateKey)\n\n\tdate := time.Now().Format(utils.DateTimeFormat)\n\terr := repo.db.Transaction(func(tx *gorm.DB) error {\n\t\t// 1.删除告警资源\n\t\tif err := tx.Clauses(clause).Table(model.AlarmPolicyTableName).\n\t\t\tWhere(\"app_id = ? AND id = ? AND deleted_at IS NULL\", appId, policyId).\n\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\"deleted_at\": date,\n\t\t\t}).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]delete alarm policy failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t// 2.删除告警资源\n\t\tif err := tx.Clauses(clause).Table(model.AlarmResourceTableName).\n\t\t\tWhere(\"policy_id = ? AND deleted_at IS NULL\", policyId).\n\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\"deleted_at\": date,\n\t\t\t}).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]delete alarm policy resource failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t// 3.删除告警通知子用户\n\t\tif err := tx.Clauses(clause).Table(model.NotifySubUserTableName).\n\t\t\tWhere(\"policy_id = ? AND deleted_at IS NULL\", policyId).\n\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\"deleted_at\": date,\n\t\t\t}).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]delete alarm policy notify sub user failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}",
    "caller": "func DeleteAlarmPolicyHandler(svcCtx *svc.ServiceContext) http.HandlerFunc {\n\treturn func(w http.ResponseWriter, r *http.Request) {\n\t\tlog := base.GetIVCLogger(r)\n\n\t\tvar req types.DeleteAlarmPolicyRequest\n\t\tif err := httpx.Parse(r, &req); err != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[handler]Parse DeleteAlarmPolicyRequest failed.error:%v\", err))\n\t\t\tresponse := base.BuildParamErrorResponse(r)\n\t\t\thttpx.OkJson(w, &response)\n\n\t\t\treturn\n\t\t}\n\n\t\tdefer func() {\n\t\t\tif err := recover(); err != nil {\n\t\t\t\tlog.ErrorV(fmt.Sprintf(\"DeleteAlarmPolicyHandler panic.error: %v\", string(debug.Stack())))\n\t\t\t\tresponse := base.BuildPanicErrorResponse(r)\n\t\t\t\thttpx.OkJson(w, &response)\n\t\t\t\treturn\n\t\t\t}\n\t\t}()\n\n\t\tl := policy.NewDeleteAlarmPolicyLogic(r.Context(), svcCtx)\n\t\tresp, err := l.DeleteAlarmPolicy(&req, log)\n\t\tif err != nil {\n\t\t\thttpx.Error(w, err)\n\t\t} else {\n\t\t\thttpx.OkJson(w, resp)\n\t\t}\n\t}\n}",
    "sql_statement_list": [
      "UPDATE alarm_policy SET deleted_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;",
      "UPDATE alarm_resource SET deleted_at = ? WHERE policy_id = ? AND deleted_at IS NULL;",
      "UPDATE notify_sub_user SET deleted_at = ? WHERE policy_id = ? AND deleted_at IS NULL;"
    ],
    "sql_types": [
      "UPDATE",
      "UPDATE",
      "UPDATE"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-event-alarm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/data/policy_repo.go:243:284:DeleteAlarmPolicy",
    "orm_code": "func (repo *AlarmPolicyRepo) DeleteAlarmPolicy(ctx context.Context, appId int64, policyId string) error {\n\tclause := utils.SetSQLComment(ctx, utils.UpdateKey)\n\n\tdate := time.Now().Format(utils.DateTimeFormat)\n\terr := repo.db.Transaction(func(tx *gorm.DB) error {\n\t\t// 1.删除告警资源\n\t\tif err := tx.Clauses(clause).Table(model.AlarmPolicyTableName).\n\t\t\tWhere(\"app_id = ? AND id = ? AND deleted_at IS NULL\", appId, policyId).\n\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\"deleted_at\": date,\n\t\t\t}).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]delete alarm policy failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t// 2.删除告警资源\n\t\tif err := tx.Clauses(clause).Table(model.AlarmResourceTableName).\n\t\t\tWhere(\"policy_id = ? AND deleted_at IS NULL\", policyId).\n\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\"deleted_at\": date,\n\t\t\t}).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]delete alarm policy resource failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t// 3.删除告警通知子用户\n\t\tif err := tx.Clauses(clause).Table(model.NotifySubUserTableName).\n\t\t\tWhere(\"policy_id = ? AND deleted_at IS NULL\", policyId).\n\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\"deleted_at\": date,\n\t\t\t}).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]delete alarm policy notify sub user failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}",
    "caller": "func deleteAlarmPolicy(ctx context.Context, req *types.DeleteAlarmPolicyRequest, log *logger.IvcLog) error {\n\tredisClient := conf.GetRedisClient()\n\tkey := utils.GeneratePolicyKey(req.PolicyId)\n\n\trepo, err := data.NewAlarmPolicyRepo(log)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\t// 1.检查告警策略是否存在\n\tvar status int\n\tstatus, err = checkPolicyStatus(ctx, req.AppId, req.PolicyId, key, redisClient, repo)\n\tif err != nil {\n\t\treturn err\n\t}\n\tif status == 1 {\n\t\treturn ierror.OpenAlarmPolicyNotAllowChangeError\n\t}\n\t// 2.删除告警策略\n\t// 删缓存\n\t_, err = redisClient.Del(ctx, key).Result()\n\tif err != nil {\n\t\tlog.ErrorV(fmt.Sprintf(\"[logic]delete alarm policy from redis failed.key:%s, error:%v\", key, err))\n\t}\n\t// 删数据\n\tif err = repo.DeleteAlarmPolicy(ctx, req.AppId, req.PolicyId); err != nil {\n\t\treturn err\n\t}\n\t// 删缓存\n\t_, err = redisClient.Del(ctx, key).Result()\n\tif err != nil {\n\t\tlog.ErrorV(fmt.Sprintf(\"[logic]delete alarm policy from redis failed.key:%s, error:%v\", key, err))\n\t}\n\n\treturn nil\n}",
    "sql_statement_list": [
      "UPDATE alarm_policy_table_name SET deleted_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;",
      "UPDATE alarm_resource_table_name SET deleted_at = ? WHERE policy_id = ? AND deleted_at IS NULL;",
      "UPDATE notify_sub_user_table_name SET deleted_at = ? WHERE policy_id = ? AND deleted_at IS NULL;"
    ],
    "sql_types": [
      "UPDATE",
      "UPDATE",
      "UPDATE"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-event-alarm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/data/policy_repo.go:149:222:UpdateAlarmPolicy",
    "orm_code": "func (repo *AlarmPolicyRepo) UpdateAlarmPolicy(ctx context.Context, appId int64,\n\tpolicyId string, fields map[string]interface{}, subUserInfo *model.SubUserInfo) error {\n\tinsertClause := utils.SetSQLComment(ctx, utils.InsertKey)\n\tupdateClause := utils.SetSQLComment(ctx, utils.UpdateKey)\n\tnow := time.Now().Format(utils.DateTimeFormat)\n\tfields[\"updated_at\"] = now\n\n\terr := repo.db.Transaction(func(tx *gorm.DB) error {\n\t\tif subUserInfo != nil {\n\t\t\t// 添加新的通知子用户\n\t\t\tif len(subUserInfo.AddUsers) != 0 {\n\t\t\t\tif err := repo.db.Clauses(insertClause).Table(model.NotifySubUserTableName).\n\t\t\t\t\tCreate(subUserInfo.AddUsers).\n\t\t\t\t\tError; err != nil {\n\t\t\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]add new notify sub user failed, err: %v\", err))\n\t\t\t\t\ttx.Rollback()\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\t// 更新通知子用户\n\t\t\tif len(subUserInfo.UpdateUsers) != 0 {\n\t\t\t\tfor _, subUser := range subUserInfo.UpdateUsers {\n\t\t\t\t\tif err := tx.Clauses(updateClause).Table(model.NotifySubUserTableName).\n\t\t\t\t\t\tWhere(\"policy_id = ? AND sub_uin = ?\", policyId, subUser.SubUin).\n\t\t\t\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\t\t\t\"name\":       subUser.Name,\n\t\t\t\t\t\t\t\"phone\":      subUser.Phone,\n\t\t\t\t\t\t\t\"email\":      subUser.Email,\n\t\t\t\t\t\t\t\"updated_at\": now,\n\t\t\t\t\t\t\t\"deleted_at\": nil,\n\t\t\t\t\t\t}).\n\t\t\t\t\t\tError; err != nil {\n\t\t\t\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]update old notify sub user failed, err: %v\", err))\n\t\t\t\t\t\ttx.Rollback()\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t// 删除之前的通知子用户\n\t\t\tif len(subUserInfo.DeleteUserUins) != 0 {\n\t\t\t\tif err := tx.Clauses(updateClause).Table(model.NotifySubUserTableName).\n\t\t\t\t\tWhere(\"policy_id = ? AND sub_uin IN (?)\", policyId, subUserInfo.DeleteUserUins).\n\t\t\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\t\t\"updated_at\": now,\n\t\t\t\t\t\t\"deleted_at\": now,\n\t\t\t\t\t}).\n\t\t\t\t\tError; err != nil {\n\t\t\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]delete old notify sub user failed, err: %v\", err))\n\t\t\t\t\ttx.Rollback()\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\n\t\t// 更新告警策略\n\t\tif err := tx.Clauses(updateClause).Table(model.AlarmPolicyTableName).\n\t\t\tWhere(\"app_id = ? AND id = ? AND deleted_at IS NULL\", appId, policyId).\n\t\t\tUpdates(fields).\n\t\t\tError; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]create alarm policy failed, err: %v\", err))\n\t\t\ttx.Rollback()\n\t\t\treturn err\n\t\t}\n\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "添加新通知子用户",
            "sql": "INSERT INTO notify_sub_user (policy_id, sub_uin, name, phone, email, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?);"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "更新通知子用户",
            "sql": "UPDATE notify_sub_user SET name = ?, phone = ?, email = ?, updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "软删除通知子用户",
            "sql": "UPDATE notify_sub_user SET updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin IN (?);"
          }
        ]
      },
      "UPDATE alarm_policy SET updated_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;"
    ],
    "sql_types": [
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT",
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/sub_user_info.go",
        "code_start_line": 3,
        "code_end_line": 7,
        "code_key": "SubUserInfo",
        "code_value": "type SubUserInfo struct {\n\tAddUsers       []*NotifySubUser\n\tUpdateUsers    []*NotifySubUser\n\tDeleteUserUins []string\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      }
    ],
    "sql_pattern_cnt": 9,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-event-alarm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/data/policy_repo.go:149:222:UpdateAlarmPolicy",
    "orm_code": "func (repo *AlarmPolicyRepo) UpdateAlarmPolicy(ctx context.Context, appId int64,\n\tpolicyId string, fields map[string]interface{}, subUserInfo *model.SubUserInfo) error {\n\tinsertClause := utils.SetSQLComment(ctx, utils.InsertKey)\n\tupdateClause := utils.SetSQLComment(ctx, utils.UpdateKey)\n\tnow := time.Now().Format(utils.DateTimeFormat)\n\tfields[\"updated_at\"] = now\n\n\terr := repo.db.Transaction(func(tx *gorm.DB) error {\n\t\tif subUserInfo != nil {\n\t\t\t// 添加新的通知子用户\n\t\t\tif len(subUserInfo.AddUsers) != 0 {\n\t\t\t\tif err := repo.db.Clauses(insertClause).Table(model.NotifySubUserTableName).\n\t\t\t\t\tCreate(subUserInfo.AddUsers).\n\t\t\t\t\tError; err != nil {\n\t\t\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]add new notify sub user failed, err: %v\", err))\n\t\t\t\t\ttx.Rollback()\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\t// 更新通知子用户\n\t\t\tif len(subUserInfo.UpdateUsers) != 0 {\n\t\t\t\tfor _, subUser := range subUserInfo.UpdateUsers {\n\t\t\t\t\tif err := tx.Clauses(updateClause).Table(model.NotifySubUserTableName).\n\t\t\t\t\t\tWhere(\"policy_id = ? AND sub_uin = ?\", policyId, subUser.SubUin).\n\t\t\t\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\t\t\t\"name\":       subUser.Name,\n\t\t\t\t\t\t\t\"phone\":      subUser.Phone,\n\t\t\t\t\t\t\t\"email\":      subUser.Email,\n\t\t\t\t\t\t\t\"updated_at\": now,\n\t\t\t\t\t\t\t\"deleted_at\": nil,\n\t\t\t\t\t\t}).\n\t\t\t\t\t\tError; err != nil {\n\t\t\t\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]update old notify sub user failed, err: %v\", err))\n\t\t\t\t\t\ttx.Rollback()\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t// 删除之前的通知子用户\n\t\t\tif len(subUserInfo.DeleteUserUins) != 0 {\n\t\t\t\tif err := tx.Clauses(updateClause).Table(model.NotifySubUserTableName).\n\t\t\t\t\tWhere(\"policy_id = ? AND sub_uin IN (?)\", policyId, subUserInfo.DeleteUserUins).\n\t\t\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\t\t\"updated_at\": now,\n\t\t\t\t\t\t\"deleted_at\": now,\n\t\t\t\t\t}).\n\t\t\t\t\tError; err != nil {\n\t\t\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]delete old notify sub user failed, err: %v\", err))\n\t\t\t\t\ttx.Rollback()\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\n\t\t// 更新告警策略\n\t\tif err := tx.Clauses(updateClause).Table(model.AlarmPolicyTableName).\n\t\t\tWhere(\"app_id = ? AND id = ? AND deleted_at IS NULL\", appId, policyId).\n\t\t\tUpdates(fields).\n\t\t\tError; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]create alarm policy failed, err: %v\", err))\n\t\t\ttx.Rollback()\n\t\t\treturn err\n\t\t}\n\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}",
    "caller": "func UpdateAlarmPolicyHandler(svcCtx *svc.ServiceContext) http.HandlerFunc {\n\treturn func(w http.ResponseWriter, r *http.Request) {\n\t\tlog := base.GetIVCLogger(r)\n\n\t\tvar req types.UpdateAlarmPolicyRequest\n\t\tif err := httpx.Parse(r, &req); err != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[handler]Parse UpdateAlarmPolicyRequest failed.error:%v\", err))\n\t\t\tresponse := base.BuildParamErrorResponse(r)\n\t\t\thttpx.OkJson(w, &response)\n\n\t\t\treturn\n\t\t}\n\n\t\tdefer func() {\n\t\t\tif err := recover(); err != nil {\n\t\t\t\tlog.ErrorV(fmt.Sprintf(\"UpdateAlarmPolicyHandler panic.error: %v\", string(debug.Stack())))\n\t\t\t\tresponse := base.BuildPanicErrorResponse(r)\n\t\t\t\thttpx.OkJson(w, &response)\n\t\t\t\treturn\n\t\t\t}\n\t\t}()\n\n\t\tl := policy.NewUpdateAlarmPolicyLogic(r.Context(), svcCtx)\n\t\tresp, err := l.UpdateAlarmPolicy(&req, log)\n\t\tif err != nil {\n\t\t\thttpx.Error(w, err)\n\t\t} else {\n\t\t\thttpx.OkJson(w, resp)\n\t\t}\n\t}\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "subUserInfo为nil或所有操作数组为空",
            "sql": "UPDATE alarm_policy SET updated_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;"
          },
          {
            "scenario": "仅包含AddUsers操作",
            "sql": "INSERT INTO notify_sub_user (policy_id, sub_uin, name, phone, email, created_at, updated_at, deleted_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?);"
          },
          {
            "scenario": "仅包含UpdateUsers操作",
            "sql": "UPDATE notify_sub_user SET name = ?, phone = ?, email = ?, updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin = ?;"
          },
          {
            "scenario": "仅包含DeleteUserUins操作",
            "sql": "UPDATE notify_sub_user SET updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin IN (?);"
          },
          {
            "scenario": "包含AddUsers和UpdateUsers操作",
            "sql": "INSERT INTO notify_sub_user (policy_id, sub_uin, name, phone, email, created_at, updated_at, deleted_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?);"
          },
          {
            "scenario": "包含AddUsers和DeleteUserUins操作",
            "sql": "INSERT INTO notify_sub_user (policy_id, sub_uin, name, phone, email, created_at, updated_at, deleted_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?);"
          },
          {
            "scenario": "包含UpdateUsers和DeleteUserUins操作",
            "sql": "UPDATE notify_sub_user SET name = ?, phone = ?, email = ?, updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin = ?;"
          },
          {
            "scenario": "包含所有三种操作",
            "sql": "INSERT INTO notify_sub_user (policy_id, sub_uin, name, phone, email, created_at, updated_at, deleted_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?);"
          }
        ]
      },
      "UPDATE notify_sub_user SET name = ?, phone = ?, email = ?, updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin = ?;",
      "UPDATE notify_sub_user SET updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin IN (?);",
      "UPDATE alarm_policy SET updated_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;"
    ],
    "sql_types": [
      "PARAM_DEPENDENT",
      "UPDATE",
      "UPDATE",
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/sub_user_info.go",
        "code_start_line": 3,
        "code_end_line": 7,
        "code_key": "SubUserInfo",
        "code_value": "type SubUserInfo struct {\n\tAddUsers       []*NotifySubUser\n\tUpdateUsers    []*NotifySubUser\n\tDeleteUserUins []string\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      }
    ],
    "sql_pattern_cnt": 9,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-event-alarm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/data/policy_repo.go:149:222:UpdateAlarmPolicy",
    "orm_code": "func (repo *AlarmPolicyRepo) UpdateAlarmPolicy(ctx context.Context, appId int64,\n\tpolicyId string, fields map[string]interface{}, subUserInfo *model.SubUserInfo) error {\n\tinsertClause := utils.SetSQLComment(ctx, utils.InsertKey)\n\tupdateClause := utils.SetSQLComment(ctx, utils.UpdateKey)\n\tnow := time.Now().Format(utils.DateTimeFormat)\n\tfields[\"updated_at\"] = now\n\n\terr := repo.db.Transaction(func(tx *gorm.DB) error {\n\t\tif subUserInfo != nil {\n\t\t\t// 添加新的通知子用户\n\t\t\tif len(subUserInfo.AddUsers) != 0 {\n\t\t\t\tif err := repo.db.Clauses(insertClause).Table(model.NotifySubUserTableName).\n\t\t\t\t\tCreate(subUserInfo.AddUsers).\n\t\t\t\t\tError; err != nil {\n\t\t\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]add new notify sub user failed, err: %v\", err))\n\t\t\t\t\ttx.Rollback()\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\t// 更新通知子用户\n\t\t\tif len(subUserInfo.UpdateUsers) != 0 {\n\t\t\t\tfor _, subUser := range subUserInfo.UpdateUsers {\n\t\t\t\t\tif err := tx.Clauses(updateClause).Table(model.NotifySubUserTableName).\n\t\t\t\t\t\tWhere(\"policy_id = ? AND sub_uin = ?\", policyId, subUser.SubUin).\n\t\t\t\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\t\t\t\"name\":       subUser.Name,\n\t\t\t\t\t\t\t\"phone\":      subUser.Phone,\n\t\t\t\t\t\t\t\"email\":      subUser.Email,\n\t\t\t\t\t\t\t\"updated_at\": now,\n\t\t\t\t\t\t\t\"deleted_at\": nil,\n\t\t\t\t\t\t}).\n\t\t\t\t\t\tError; err != nil {\n\t\t\t\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]update old notify sub user failed, err: %v\", err))\n\t\t\t\t\t\ttx.Rollback()\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t// 删除之前的通知子用户\n\t\t\tif len(subUserInfo.DeleteUserUins) != 0 {\n\t\t\t\tif err := tx.Clauses(updateClause).Table(model.NotifySubUserTableName).\n\t\t\t\t\tWhere(\"policy_id = ? AND sub_uin IN (?)\", policyId, subUserInfo.DeleteUserUins).\n\t\t\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\t\t\"updated_at\": now,\n\t\t\t\t\t\t\"deleted_at\": now,\n\t\t\t\t\t}).\n\t\t\t\t\tError; err != nil {\n\t\t\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]delete old notify sub user failed, err: %v\", err))\n\t\t\t\t\ttx.Rollback()\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\n\t\t// 更新告警策略\n\t\tif err := tx.Clauses(updateClause).Table(model.AlarmPolicyTableName).\n\t\t\tWhere(\"app_id = ? AND id = ? AND deleted_at IS NULL\", appId, policyId).\n\t\t\tUpdates(fields).\n\t\t\tError; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]create alarm policy failed, err: %v\", err))\n\t\t\ttx.Rollback()\n\t\t\treturn err\n\t\t}\n\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}",
    "caller": "func updateAlarmPolicy(ctx context.Context, req *types.UpdateAlarmPolicyRequest, log *logger.IvcLog) (*model.AlarmPolicyInfo, error) {\n\tredisClient := conf.GetRedisClient()\n\tkey := utils.GeneratePolicyKey(req.PolicyId)\n\n\trepo, err := data.NewAlarmPolicyRepo(log)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\t// 1.检查告警策略是否存在\n\toldPolicyInfo, err1 := repo.GetAlarmPolicyInfo(ctx, req.AppId, req.PolicyId)\n\tif err1 != nil {\n\t\treturn nil, err1\n\t}\n\tif oldPolicyInfo.Policy.Status == utils.AlarmStatusOn {\n\t\treturn nil, ierror.OpenAlarmPolicyNotAllowChangeError\n\t}\n\t// 还需要获取存在过的子用户信息\n\tsubUserRepo, err3 := data.NewNotifySubUserRepo(log)\n\tif err3 != nil {\n\t\treturn nil, err3\n\t}\n\toldSubUsers, err4 := subUserRepo.GetSubUsersByPolicyId(ctx, req.PolicyId)\n\tif err4 != nil {\n\t\treturn nil, err4\n\t}\n\toldPolicyInfo.SubUsers = oldSubUsers\n\n\t// 2.更新并保存告警策略\n\t// 2.1 构建新的告警策略信息\n\tupdateFields, subUserInfo, err2 := buildUpdateAlarmPolicyFields(ctx, req, oldPolicyInfo, log)\n\tif err2 != nil {\n\t\treturn nil, err2\n\t}\n\t// 2.2 更新告警策略\n\t// 删除缓存\n\t_, err = redisClient.Del(ctx, key).Result()\n\tif err != nil {\n\t\tlog.ErrorV(fmt.Sprintf(\"[logic]updateAlarmPolicy delete redis alarm policy info failed.key:%v,error:%v\", key, err))\n\t\treturn nil, err\n\t}\n\t// 更新数据库\n\terr = repo.UpdateAlarmPolicy(ctx, req.AppId, req.PolicyId, updateFields, subUserInfo)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\t// 删除缓存\n\t_, err = redisClient.Del(ctx, key).Result()\n\tif err != nil {\n\t\tlog.ErrorV(fmt.Sprintf(\"[logic]updateAlarmPolicy delete redis alarm policy info failed.key:%v,error:%v\", key, err))\n\t\treturn nil, err\n\t}\n\t// 3.查询告警策略\n\tpolicyInfo, err4 := repo.GetAlarmPolicyInfo(ctx, req.AppId, req.PolicyId)\n\tif err4 != nil {\n\t\treturn nil, err4\n\t}\n\n\treturn policyInfo, nil\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "subUserInfo为nil或所有操作列表都为空",
            "sql": "UPDATE alarm_policy SET updated_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;"
          },
          {
            "scenario": "只有AddUsers操作",
            "sql": "INSERT INTO notify_sub_user (policy_id, sub_uin, name, phone, email, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?); UPDATE alarm_policy SET updated_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;"
          },
          {
            "scenario": "只有UpdateUsers操作",
            "sql": "UPDATE notify_sub_user SET name = ?, phone = ?, email = ?, updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin = ?; UPDATE alarm_policy SET updated_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;"
          },
          {
            "scenario": "只有DeleteUserUins操作",
            "sql": "UPDATE notify_sub_user SET updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin IN (?); UPDATE alarm_policy SET updated_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;"
          },
          {
            "scenario": "AddUsers和UpdateUsers操作",
            "sql": "INSERT INTO notify_sub_user (policy_id, sub_uin, name, phone, email, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?); UPDATE notify_sub_user SET name = ?, phone = ?, email = ?, updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin = ?; UPDATE alarm_policy SET updated_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;"
          },
          {
            "scenario": "AddUsers和DeleteUserUins操作",
            "sql": "INSERT INTO notify_sub_user (policy_id, sub_uin, name, phone, email, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?); UPDATE notify_sub_user SET updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin IN (?); UPDATE alarm_policy SET updated_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;"
          },
          {
            "scenario": "UpdateUsers和DeleteUserUins操作",
            "sql": "UPDATE notify_sub_user SET name = ?, phone = ?, email = ?, updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin = ?; UPDATE notify_sub_user SET updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin IN (?); UPDATE alarm_policy SET updated_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;"
          },
          {
            "scenario": "AddUsers、UpdateUsers和DeleteUserUins完整操作",
            "sql": "INSERT INTO notify_sub_user (policy_id, sub_uin, name, phone, email, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?); UPDATE notify_sub_user SET name = ?, phone = ?, email = ?, updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin = ?; UPDATE notify_sub_user SET updated_at = ?, deleted_at = ? WHERE policy_id = ? AND sub_uin IN (?); UPDATE alarm_policy SET updated_at = ? WHERE app_id = ? AND id = ? AND deleted_at IS NULL;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/sub_user_info.go",
        "code_start_line": 3,
        "code_end_line": 7,
        "code_key": "SubUserInfo",
        "code_value": "type SubUserInfo struct {\n\tAddUsers       []*NotifySubUser\n\tUpdateUsers    []*NotifySubUser\n\tDeleteUserUins []string\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      }
    ],
    "sql_pattern_cnt": 9,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-event-alarm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/data/policy_repo.go:36:70:AddAlarmPolicy",
    "orm_code": "func (repo *AlarmPolicyRepo) AddAlarmPolicy(ctx context.Context, policyInfo *model.AlarmPolicyInfo) error {\n\tclause := utils.SetSQLComment(ctx, utils.InsertKey)\n\n\terr := repo.db.Transaction(func(tx *gorm.DB) error {\n\t\t// 创建告警策略\n\t\tif err := tx.Clauses(clause).Create(policyInfo.Policy).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]create alarm policy failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t// 创建告警策略的资源\n\t\t//for _, resource := range policyInfo.Resources {\n\t\tif err := tx.Clauses(clause).CreateInBatches(policyInfo.Resources, 2000).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]create alarm policy resource failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t//}\n\t\t// 创建告警策略的通知人\n\t\tif len(policyInfo.SubUsers) != 0 {\n\t\t\t//for _, subUser := range policyInfo.SubUsers {\n\t\t\tif err := tx.Clauses(clause).CreateInBatches(policyInfo.SubUsers, 100).Error; err != nil {\n\t\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]create alarm policy sub user failed, err: %v\", err))\n\t\t\t\treturn err\n\t\t\t}\n\t\t\t//}\n\t\t}\n\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}",
    "caller": "",
    "sql_statement_list": [
      "INSERT INTO `alarm_policy` VALUES (?);",
      "INSERT INTO `alarm_resource` VALUES (?);",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "当SubUsers不为空时",
            "sql": "INSERT INTO `notify_sub_user` VALUES (?);"
          },
          {
            "scenario": "当SubUsers为空时",
            "sql": ""
          }
        ]
      }
    ],
    "sql_types": [
      "INSERT",
      "INSERT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/policy_info.go",
        "code_start_line": 4,
        "code_end_line": 8,
        "code_key": "AlarmPolicyInfo",
        "code_value": "type AlarmPolicyInfo struct {\n\tPolicy    *AlarmPolicy\n\tResources []*AlarmResource\n\tSubUsers  []*NotifySubUser\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-event-alarm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/data/policy_repo.go:36:70:AddAlarmPolicy",
    "orm_code": "func (repo *AlarmPolicyRepo) AddAlarmPolicy(ctx context.Context, policyInfo *model.AlarmPolicyInfo) error {\n\tclause := utils.SetSQLComment(ctx, utils.InsertKey)\n\n\terr := repo.db.Transaction(func(tx *gorm.DB) error {\n\t\t// 创建告警策略\n\t\tif err := tx.Clauses(clause).Create(policyInfo.Policy).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]create alarm policy failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t// 创建告警策略的资源\n\t\t//for _, resource := range policyInfo.Resources {\n\t\tif err := tx.Clauses(clause).CreateInBatches(policyInfo.Resources, 2000).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]create alarm policy resource failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t//}\n\t\t// 创建告警策略的通知人\n\t\tif len(policyInfo.SubUsers) != 0 {\n\t\t\t//for _, subUser := range policyInfo.SubUsers {\n\t\t\tif err := tx.Clauses(clause).CreateInBatches(policyInfo.SubUsers, 100).Error; err != nil {\n\t\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]create alarm policy sub user failed, err: %v\", err))\n\t\t\t\treturn err\n\t\t\t}\n\t\t\t//}\n\t\t}\n\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}",
    "caller": "func AddAlarmPolicyHandler(svcCtx *svc.ServiceContext) http.HandlerFunc {\n\treturn func(w http.ResponseWriter, r *http.Request) {\n\t\tlog := base.GetIVCLogger(r)\n\n\t\tvar req types.AddAlarmPolicyRequest\n\t\tif err := httpx.Parse(r, &req); err != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[handler]Parse AddAlarmPolicyRequest failed.error:%v\", err))\n\t\t\tresponse := base.BuildParamErrorResponse(r)\n\t\t\thttpx.OkJson(w, &response)\n\n\t\t\treturn\n\t\t}\n\n\t\tdefer func() {\n\t\t\tif err := recover(); err != nil {\n\t\t\t\tlog.ErrorV(fmt.Sprintf(\"AddAlarmPolicyHandler panic.error: %v\", string(debug.Stack())))\n\t\t\t\tresponse := base.BuildPanicErrorResponse(r)\n\t\t\t\thttpx.OkJson(w, &response)\n\t\t\t\treturn\n\t\t\t}\n\t\t}()\n\n\t\tl := policy.NewAddAlarmPolicyLogic(r.Context(), svcCtx)\n\t\tresp, err := l.AddAlarmPolicy(&req, log)\n\t\tif err != nil {\n\t\t\thttpx.Error(w, err)\n\t\t} else {\n\t\t\thttpx.OkJson(w, resp)\n\t\t}\n\t}\n}",
    "sql_statement_list": [
      "INSERT INTO `alarm_policy` (`id`, `name`, `description`, `status`, `created_at`, `updated_at`) VALUES (?, ?, ?, ?, ?, ?);",
      "INSERT INTO `alarm_resource` (`id`, `policy_id`, `resource_type`, `resource_id`, `created_at`, `updated_at`) VALUES (?, ?, ?, ?, ?, ?), (?, ?, ?, ?, ?, ?), (?, ?, ?, ?, ?, ?);",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "SubUsers不为空时执行",
            "sql": "INSERT INTO `notify_sub_user` (`id`, `policy_id`, `user_id`, `notify_type`, `created_at`, `updated_at`) VALUES (?, ?, ?, ?, ?, ?), (?, ?, ?, ?, ?, ?);"
          }
        ]
      }
    ],
    "sql_types": [
      "INSERT",
      "INSERT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/policy_info.go",
        "code_start_line": 4,
        "code_end_line": 8,
        "code_key": "AlarmPolicyInfo",
        "code_value": "type AlarmPolicyInfo struct {\n\tPolicy    *AlarmPolicy\n\tResources []*AlarmResource\n\tSubUsers  []*NotifySubUser\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-event-alarm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/data/policy_repo.go:36:70:AddAlarmPolicy",
    "orm_code": "func (repo *AlarmPolicyRepo) AddAlarmPolicy(ctx context.Context, policyInfo *model.AlarmPolicyInfo) error {\n\tclause := utils.SetSQLComment(ctx, utils.InsertKey)\n\n\terr := repo.db.Transaction(func(tx *gorm.DB) error {\n\t\t// 创建告警策略\n\t\tif err := tx.Clauses(clause).Create(policyInfo.Policy).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]create alarm policy failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t// 创建告警策略的资源\n\t\t//for _, resource := range policyInfo.Resources {\n\t\tif err := tx.Clauses(clause).CreateInBatches(policyInfo.Resources, 2000).Error; err != nil {\n\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]create alarm policy resource failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t//}\n\t\t// 创建告警策略的通知人\n\t\tif len(policyInfo.SubUsers) != 0 {\n\t\t\t//for _, subUser := range policyInfo.SubUsers {\n\t\t\tif err := tx.Clauses(clause).CreateInBatches(policyInfo.SubUsers, 100).Error; err != nil {\n\t\t\t\trepo.log.ErrorV(fmt.Sprintf(\"[repo]create alarm policy sub user failed, err: %v\", err))\n\t\t\t\treturn err\n\t\t\t}\n\t\t\t//}\n\t\t}\n\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}",
    "caller": "func addAlarmPolicy(ctx context.Context, req *types.AddAlarmPolicyRequest, log *logger.IvcLog) (*model.AlarmPolicyInfo, error) {\n\t// 1.检查传入资源ID是否存在\n\terr := checkResource(ctx, req.AppId, req.Resource, log)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\t// 2.检查通知的用户是否存在\n\tvar subUsers []*model.NotifySubUser\n\tif req.UserNotify != nil {\n\t\tsubUsers, err = checkNotifyUsers(ctx, req.AppId, req.OwnerUin, req.RequestId, req.UserNotify.NotifyUinLists, log)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t}\n\t// 3.单用户限制创建100个告警策略\n\trepo, err1 := data2.NewAlarmPolicyRepo(log)\n\tif err1 != nil {\n\t\treturn nil, err1\n\t}\n\tcount, err := repo.GetUserAlarmPolicyCount(ctx, req.AppId)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\tlog.InfoV(fmt.Sprintf(\"[logic]addAlarmPolicy:user alarm policy count:%d\", count))\n\tif count >= utils.MaxUserAlarmPolicyCount {\n\t\treturn nil, ierror.AlarmPolicyCountExceedError\n\t}\n\t// 构建告警策略信息\n\tpolicyInfo := buildPolicyInfo(req, subUsers)\n\t// 3.保存策略信息\n\tif err = repo.AddAlarmPolicy(ctx, policyInfo); err != nil {\n\t\treturn nil, err\n\t}\n\tlog.InfoV(\"[logic]addAlarmPolicy success\")\n\n\tutils.SafeGo(func() {\n\t\tkey := utils.GeneratePolicyKey(policyInfo.Policy.Id)\n\t\tdata, err2 := json.Marshal(policyInfo)\n\t\tif err2 != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[logic]Marshal alarm policy failed.error:%v\", err2))\n\t\t\treturn\n\t\t}\n\t\tredisClient := conf.GetRedisClient()\n\t\tif err = redisClient.Set(ctx, key, data, 10*time.Minute).Err(); err != nil {\n\t\t\tlog.ErrorV(fmt.Sprintf(\"[logic]set alarm policy to redis failed.error:%v\", err))\n\t\t\treturn\n\t\t}\n\t})\n\n\treturn policyInfo, nil\n}",
    "sql_statement_list": [
      "INSERT INTO `alarm_policy` VALUES (?);",
      "INSERT INTO `alarm_resource` VALUES (?), (?), (?);",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "有通知用户时(len(policyInfo.SubUsers) != 0)",
            "sql": "INSERT INTO `notify_sub_user` VALUES (?), (?);"
          }
        ]
      }
    ],
    "sql_types": [
      "INSERT",
      "INSERT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/policy_info.go",
        "code_start_line": 4,
        "code_end_line": 8,
        "code_key": "AlarmPolicyInfo",
        "code_value": "type AlarmPolicyInfo struct {\n\tPolicy    *AlarmPolicy\n\tResources []*AlarmResource\n\tSubUsers  []*NotifySubUser\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-event-alarm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/data/notify_info_repo.go:54:82:CreateNotifyInfo",
    "orm_code": "func (repo *NotifyInfoRepo) CreateNotifyInfo(ctx context.Context, notify *model.AlarmNotify, notes []*model.AlarmNotifyNote) error {\n\tclause := utils.SetSQLComment(ctx, utils.InsertKey)\n\n\terr := repo.db.Transaction(func(tx *gorm.DB) error {\n\t\t// 创建通知信息\n\t\tif err := tx.Clauses(clause).Table(model.AlarmNotifyTableName).\n\t\t\tCreate(notify).\n\t\t\tError; err != nil {\n\t\t\trepo.log.Error(fmt.Sprintf(\"[repo]add alarm notify failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t// 创建通知信息备注\n\t\tif len(notes) != 0 {\n\t\t\tif err := tx.Clauses(clause).Table(model.AlarmNotifyNoteTableName).\n\t\t\t\tCreate(notes).\n\t\t\t\tError; err != nil {\n\t\t\t\trepo.log.Error(fmt.Sprintf(\"[repo]add alarm notify note failed, err: %v\", err))\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}",
    "caller": "",
    "sql_statement_list": [
      "INSERT INTO alarm_notify (id, policy_id, event_id, event_type, notify_type, notify_message, notice_timestamp, app_id, owner_uin, sub_uin) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?);",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "当notes切片不为空时执行",
            "sql": "INSERT INTO alarm_notify_note (id, notify_id, sub_uin, name, desc, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?);"
          }
        ]
      }
    ],
    "sql_types": [
      "INSERT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/ivc_alarm_notify.go",
        "code_start_line": 7,
        "code_end_line": 18,
        "code_key": "AlarmNotify",
        "code_value": "type AlarmNotify struct {\n\tId              string `gorm:\"column:id\" json:\"id\"`\n\tPolicyId        string `gorm:\"column:policy_id\" json:\"policy_id\"`\n\tEventId         string `gorm:\"column:event_id\" json:\"event_id\"`\n\tEventType       string `gorm:\"column:event_type\" json:\"event_type\"`\n\tNotifyType      int    `gorm:\"column:notify_type\" json:\"notify_type\"`\n\tNotifyMessage   string `gorm:\"column:notify_message\" json:\"notify_message\"`\n\tNoticeTimestamp int64  `gorm:\"column:notice_timestamp\" json:\"notice_timestamp\"`\n\tAppId           int64  `gorm:\"column:app_id\" json:\"app_id\"`\n\tOwnerUin        string `gorm:\"column:owner_uin\" json:\"owner_uin\"`\n\tSubUin          string `gorm:\"column:sub_uin\" json:\"sub_uin\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/ivc_alarm_notify.go",
        "code_start_line": 20,
        "code_end_line": 22,
        "code_key": "TableName",
        "code_value": "func (an *AlarmNotify) TableName() string {\n\treturn AlarmNotifyTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/ivc_alarm_notify_note.go",
        "code_start_line": 9,
        "code_end_line": 17,
        "code_key": "AlarmNotifyNote",
        "code_value": "type AlarmNotifyNote struct {\n\tId        string    `gorm:\"column:id\" json:\"id\"`\n\tNotifyId  string    `gorm:\"column:notify_id\" json:\"notify_id\"`\n\tSubUin    string    `gorm:\"column:sub_uin\" json:\"sub_uin\"`\n\tName      string    `gorm:\"column:name\" json:\"name\"`\n\tDesc      string    `gorm:\"column:desc\" json:\"desc\"`\n\tCreatedAt time.Time `gorm:\"column:created_at\" json:\"created_at,string\"`\n\tUpdatedAt time.Time `gorm:\"column:updated_at\" json:\"updated_at,string\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/ivc_alarm_notify_note.go",
        "code_start_line": 19,
        "code_end_line": 21,
        "code_key": "TableName",
        "code_value": "func (an *AlarmNotifyNote) TableName() string {\n\treturn AlarmNotifyNoteTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      }
    ],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-event-alarm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/data/notify_info_repo.go:54:82:CreateNotifyInfo",
    "orm_code": "func (repo *NotifyInfoRepo) CreateNotifyInfo(ctx context.Context, notify *model.AlarmNotify, notes []*model.AlarmNotifyNote) error {\n\tclause := utils.SetSQLComment(ctx, utils.InsertKey)\n\n\terr := repo.db.Transaction(func(tx *gorm.DB) error {\n\t\t// 创建通知信息\n\t\tif err := tx.Clauses(clause).Table(model.AlarmNotifyTableName).\n\t\t\tCreate(notify).\n\t\t\tError; err != nil {\n\t\t\trepo.log.Error(fmt.Sprintf(\"[repo]add alarm notify failed, err: %v\", err))\n\t\t\treturn err\n\t\t}\n\t\t// 创建通知信息备注\n\t\tif len(notes) != 0 {\n\t\t\tif err := tx.Clauses(clause).Table(model.AlarmNotifyNoteTableName).\n\t\t\t\tCreate(notes).\n\t\t\t\tError; err != nil {\n\t\t\t\trepo.log.Error(fmt.Sprintf(\"[repo]add alarm notify note failed, err: %v\", err))\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}",
    "caller": "func NotifyUser(ctx context.Context, now time.Time, event *model.AlarmEvent, policy *model.AlarmPolicy, message string, log *zap.Logger) error {\n\t// 1.查询通知子用户\n\tvar subUINs []int\n\tvar subUsers []*model.NotifySubUser\n\tvar notifyTimes []*types.NotifyTime\n\tif policy.NoticeType != model.CallbackNotify { // 查询子用户信息\n\t\trepo, err := data.NewNotifySubUserRepo(nil)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\tsubUsers, err = repo.GetSubUsersByPolicyId(ctx, policy.Id)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\n\t\tfor _, subUser := range subUsers {\n\t\t\tsubUin, _ := strconv.Atoi(subUser.SubUin)\n\t\t\tsubUINs = append(subUINs, subUin)\n\t\t}\n\t\t// 这里需要注意可能会失败\n\t\t_ = json.Unmarshal([]byte(policy.NoticeTimes), &notifyTimes)\n\t}\n\tlog.Info(fmt.Sprintf(\"[NotifyUser]subUser: %v, policy.NoticeType: %v\", subUINs, policy.NoticeType))\n\t// 2.通知用户\n\tnotifyType := 0\n\tswitch policy.NoticeType {\n\tcase model.EmailNotify, model.PhoneNotify, model.AllUserNotify: // 发送用户通知\n\t\tif types.IsTimeValid(now, notifyTimes) {\n\t\t\tlog.Info(\"[NotifyUser]need push user notify\")\n\t\t\treq := notify.BuildSendUserNotifyRequest(policy.NoticeType, policy.OwnerUin, subUINs, message)\n\t\t\tlog.Info(fmt.Sprintf(\"user notify req: %#v\", req))\n\t\t\tlogId, err := notify.SendUserNotify(req, log)\n\t\t\tif err != nil {\n\t\t\t\tlog.Error(fmt.Sprintf(\"[NotifyUser]send user notify failed.error:%v\", err))\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif err = notify.QuerySentResult(logId, log); err != nil {\n\t\t\t\tlog.Error(fmt.Sprintf(\"[NotifyUser]query sent result failed.error:%v\", err))\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tlog.Info(\"[NotifyUser]user notify success\")\n\t\t\tnotifyType = policy.NoticeType\n\t\t} else {\n\t\t\tlog.Error(\"[NotifyUser]user notify failed.time not valid\")\n\t\t\tsubUsers = []*model.NotifySubUser{} // 通知用户为空\n\t\t}\n\tcase model.CallbackNotify: // 发送用户回调通知\n\t\tif err := notify.SendUserCallbackNotify(policy, message, log); err != nil {\n\t\t\tlog.Error(fmt.Sprintf(\"[NotifyUser]send user callback notify failed.error:%v\", err))\n\t\t\treturn err\n\t\t}\n\t\tlog.Info(\"[NotifyUser]callback notify success\")\n\t\tnotifyType = policy.NoticeType\n\tcase model.ALLNotify, model.EmailCallbackNotify, model.PhoneCallbackNotify: // 发送用户通知和回调通知\n\t\t// 发送用户通知\n\t\tif types.IsTimeValid(now, notifyTimes) {\n\t\t\tlog.Info(\"[NotifyUser]need push user notify\")\n\t\t\treq := notify.BuildSendUserNotifyRequest(policy.NoticeType, policy.OwnerUin, subUINs, message)\n\t\t\tlog.Info(fmt.Sprintf(\"user notify req: %#v\", req))\n\t\t\tlogId, err := notify.SendUserNotify(req, log)\n\t\t\tif err != nil {\n\t\t\t\tlog.Error(fmt.Sprintf(\"[NotifyUser]send user notify failed.error:%v\", err))\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif err = notify.QuerySentResult(logId, log); err != nil {\n\t\t\t\tlog.Error(fmt.Sprintf(\"[NotifyUser]query sent result failed.error:%v\", err))\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tlog.Info(\"[NotifyUser]user notify success\")\n\t\t\tnotifyType = policy.NoticeType\n\t\t} else {\n\t\t\tsubUsers = []*model.NotifySubUser{} // 通知用户为空\n\t\t}\n\t\t// 发送用户回调通知\n\t\tif err := notify.SendUserCallbackNotify(policy, message, log); err != nil {\n\t\t\tlog.Error(fmt.Sprintf(\"[NotifyUser]send user callback notify failed.error:%v\", err))\n\t\t\tswitch policy.NoticeType {\n\t\t\tcase model.EmailCallbackNotify:\n\t\t\t\tnotifyType = model.EmailNotify\n\t\t\tcase model.PhoneCallbackNotify:\n\t\t\t\tnotifyType = model.PhoneNotify\n\t\t\tcase model.ALLNotify:\n\t\t\t\tnotifyType = model.AllUserNotify\n\t\t\t}\n\t\t}\n\t\tif notifyType == 0 {\n\t\t\tnotifyType = model.CallbackNotify\n\t\t}\n\tdefault:\n\t\tlog.Error(fmt.Sprintf(\"[NotifyUser]not support notify type(%v)\", policy.NoticeType))\n\t\treturn nil\n\t}\n\t//3.保存通知记录\n\teventType := model.BackendSubEventTypeMap[event.EventType]\n\tn := &model.AlarmNotify{\n\t\tId:              utils.GenerateNotifyId(),\n\t\tPolicyId:        policy.Id,\n\t\tEventId:         event.Id,\n\t\tEventType:       eventType,\n\t\tNotifyType:      notifyType,\n\t\tNotifyMessage:   message,\n\t\tNoticeTimestamp: time.Now().Unix(),\n\t\tAppId:           policy.AppId,\n\t\tOwnerUin:        policy.OwnerUin,\n\t\tSubUin:          policy.SubUin,\n\t}\n\n\tvar notifyNotes []*model.AlarmNotifyNote\n\tfor _, subUser := range subUsers {\n\t\tnotifyNote := &model.AlarmNotifyNote{\n\t\t\tId:        utils.GenerateNotifyNoteId(),\n\t\t\tNotifyId:  n.Id,\n\t\t\tSubUin:    subUser.SubUin,\n\t\t\tName:      subUser.Name,\n\t\t\tDesc:      \"\",\n\t\t\tCreatedAt: time.Now(),\n\t\t\tUpdatedAt: time.Now(),\n\t\t}\n\t\tnotifyNotes = append(notifyNotes, notifyNote)\n\t}\n\tdb := conf.GetDBEngine()\n\tnotifyInfoRepo := data.NewNotifyInfoRepo(db, log)\n\n\tif err := notifyInfoRepo.CreateNotifyInfo(ctx, n, notifyNotes); err != nil {\n\t\tlog.Error(fmt.Sprintf(\"[NotifyUser]create notify info failed.error:%v\", err))\n\t\treturn err\n\t}\n\tlog.Info(\"[NotifyUser]create notify info success\")\n\n\treturn nil\n}",
    "sql_statement_list": [
      "INSERT INTO alarm_notify_table_name (id, policy_id, event_id, event_type, notify_type, notify_message, notice_timestamp, app_id, owner_uin, sub_uin) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?);",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "当notifyNotes切片非空时执行",
            "sql": "INSERT INTO alarm_notify_note_table_name (id, notify_id, sub_uin, name, desc, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?);"
          }
        ]
      }
    ],
    "sql_types": [
      "INSERT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/ivc_alarm_notify.go",
        "code_start_line": 7,
        "code_end_line": 18,
        "code_key": "AlarmNotify",
        "code_value": "type AlarmNotify struct {\n\tId              string `gorm:\"column:id\" json:\"id\"`\n\tPolicyId        string `gorm:\"column:policy_id\" json:\"policy_id\"`\n\tEventId         string `gorm:\"column:event_id\" json:\"event_id\"`\n\tEventType       string `gorm:\"column:event_type\" json:\"event_type\"`\n\tNotifyType      int    `gorm:\"column:notify_type\" json:\"notify_type\"`\n\tNotifyMessage   string `gorm:\"column:notify_message\" json:\"notify_message\"`\n\tNoticeTimestamp int64  `gorm:\"column:notice_timestamp\" json:\"notice_timestamp\"`\n\tAppId           int64  `gorm:\"column:app_id\" json:\"app_id\"`\n\tOwnerUin        string `gorm:\"column:owner_uin\" json:\"owner_uin\"`\n\tSubUin          string `gorm:\"column:sub_uin\" json:\"sub_uin\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/ivc_alarm_notify.go",
        "code_start_line": 20,
        "code_end_line": 22,
        "code_key": "TableName",
        "code_value": "func (an *AlarmNotify) TableName() string {\n\treturn AlarmNotifyTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/ivc_alarm_notify_note.go",
        "code_start_line": 9,
        "code_end_line": 17,
        "code_key": "AlarmNotifyNote",
        "code_value": "type AlarmNotifyNote struct {\n\tId        string    `gorm:\"column:id\" json:\"id\"`\n\tNotifyId  string    `gorm:\"column:notify_id\" json:\"notify_id\"`\n\tSubUin    string    `gorm:\"column:sub_uin\" json:\"sub_uin\"`\n\tName      string    `gorm:\"column:name\" json:\"name\"`\n\tDesc      string    `gorm:\"column:desc\" json:\"desc\"`\n\tCreatedAt time.Time `gorm:\"column:created_at\" json:\"created_at,string\"`\n\tUpdatedAt time.Time `gorm:\"column:updated_at\" json:\"updated_at,string\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/IVC__ivc-event-alarm/internal/model/ivc_alarm_notify_note.go",
        "code_start_line": 19,
        "code_end_line": 21,
        "code_key": "TableName",
        "code_value": "func (an *AlarmNotifyNote) TableName() string {\n\treturn AlarmNotifyNoteTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "7209c4e5504bbebecf9342146fe04eb69898fb45"
      }
    ],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/ivc_temp/IVC__ivc-event-alarm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp-alarm-transfer/events.go:302:340:removeWorkloadFromEvent",
    "orm_code": "func removeWorkloadFromEvent(alarm EventAlarmInfo) error {\n\tdb, err := getDBInstance(dbTkexAlarmRw)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn db.Transaction(func(tx *gorm.DB) error {\n\t\tvar records []EventAlarmRecord\n\t\terr := tx.Where(\"clusterid = ? AND namespace = ? AND workloadkind = ? AND workloadname = ?\",\n\t\t\talarm.ClusterID, alarm.Namespace, alarm.WorkloadKind, alarm.WorkloadName).Find(&records).Error\n\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\n\t\terr = tx.Where(\"clusterid = ? AND namespace = ? AND workloadkind = ? AND workloadname = ?\",\n\t\t\talarm.ClusterID, alarm.Namespace, alarm.WorkloadKind, alarm.WorkloadName).Delete(&EventAlarmRecord{}).Error\n\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\n\t\tfor _, record := range records {\n\t\t\tvar count int64\n\t\t\terr = tx.Model(&EventAlarmRecord{}).Where(\"eventAlarmSettingID = ?\", record.EventAlarmSettingID).Count(&count).Error\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\n\t\t\tif count == 0 {\n\t\t\t\terr = tx.Where(\"eventAlarmSettingID = ?\", record.EventAlarmSettingID).Delete(&EventAlarmSetting{}).Error\n\t\t\t\tif err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT id, recordsid, eventAlarmSettingID, alarmobjectstype, clusterid, namespace, workloadkind, workloadname, kind, reason, insertTime, updateTime, threshold FROM t_event_alarm_records WHERE clusterid = ? AND namespace = ? AND workloadkind = ? AND workloadname = ?;",
      "DELETE FROM t_event_alarm_records WHERE clusterid = ? AND namespace = ? AND workloadkind = ? AND workloadname = ?;",
      "SELECT count(*) FROM t_event_alarm_records WHERE eventAlarmSettingID = ?;",
      "DELETE FROM t_event_alarm_setting WHERE eventAlarmSettingID = ?;"
    ],
    "sql_types": [
      "SELECT",
      "DELETE",
      "SELECT",
      "DELETE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp-alarm-transfer/events.go",
        "code_start_line": 50,
        "code_end_line": 64,
        "code_key": "EventAlarmRecord",
        "code_value": "type EventAlarmRecord struct {\n\tID                  uint   `gorm:\"primaryKey;column:id\"`\n\tRecordsID           string `gorm:\"column:recordsid\"`\n\tEventAlarmSettingID string `gorm:\"foreignKey:eventAlarmSettingID;column:eventAlarmSettingID\"`\n\tAlarmObjectsType    string `gorm:\"column:alarmobjectstype\"`\n\tClusterID           string `gorm:\"column:clusterid\"`\n\tNamespace           string `gorm:\"column:namespace\"`\n\tWorkloadKind        string `gorm:\"column:workloadkind\"`\n\tWorkloadName        string `gorm:\"column:workloadname\"`\n\tKind                string `gorm:\"column:kind\"`\n\tReason              string `gorm:\"column:reason\"`\n\tInsertTime          int64  `gorm:\"column:insertTime\"`\n\tUpdateTime          int64  `gorm:\"column:updateTime\"`\n\tThreshold           int    `gorm:\"column:threshold\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "c3c88315ac47c6cc734f53e5b91dfbd63a6259d3"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp-alarm-transfer/events.go",
        "code_start_line": 81,
        "code_end_line": 83,
        "code_key": "TableName",
        "code_value": "func (EventAlarmRecord) TableName() string {\n\treturn \"t_event_alarm_records\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "c3c88315ac47c6cc734f53e5b91dfbd63a6259d3"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp-alarm-transfer/events.go",
        "code_start_line": 66,
        "code_end_line": 75,
        "code_key": "EventAlarmSetting",
        "code_value": "type EventAlarmSetting struct {\n\tEventAlarmSettingID string `gorm:\"primaryKey;column:eventAlarmSettingID\"`\n\tEventAlarmName      string `gorm:\"column:eventalarmname\"`\n\tProjectID           string `gorm:\"column:projectID\"`\n\tInsertTime          int64  `gorm:\"column:insertTime\"`\n\tUpdateTime          int64  `gorm:\"column:updateTime\"`\n\tAlarmReceiver       string `gorm:\"column:alarmreceiver\"`\n\tAlarmMethod         string `gorm:\"column:alarm_method\"`\n\tWecomBotWebhook     string `gorm:\"column:wecombotwebhook\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "c3c88315ac47c6cc734f53e5b91dfbd63a6259d3"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp-alarm-transfer/events.go",
        "code_start_line": 77,
        "code_end_line": 79,
        "code_key": "TableName",
        "code_value": "func (EventAlarmSetting) TableName() string {\n\treturn \"t_event_alarm_setting\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "c3c88315ac47c6cc734f53e5b91dfbd63a6259d3"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp-alarm-transfer/events.go",
        "code_start_line": 39,
        "code_end_line": 48,
        "code_key": "EventAlarmInfo",
        "code_value": "type EventAlarmInfo struct {\n\tClusterID    string\n\tNamespace    string\n\tWorkloadKind string\n\tProjectID    string\n\tWorkloadName string\n\tKind         string\n\tReasons      []string\n\tSetting      EventAlarmSetting\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "c3c88315ac47c6cc734f53e5b91dfbd63a6259d3"
      }
    ],
    "sql_pattern_cnt": 5,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp-alarm-transfer.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp-alarm-transfer/events.go:302:340:removeWorkloadFromEvent",
    "orm_code": "func removeWorkloadFromEvent(alarm EventAlarmInfo) error {\n\tdb, err := getDBInstance(dbTkexAlarmRw)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn db.Transaction(func(tx *gorm.DB) error {\n\t\tvar records []EventAlarmRecord\n\t\terr := tx.Where(\"clusterid = ? AND namespace = ? AND workloadkind = ? AND workloadname = ?\",\n\t\t\talarm.ClusterID, alarm.Namespace, alarm.WorkloadKind, alarm.WorkloadName).Find(&records).Error\n\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\n\t\terr = tx.Where(\"clusterid = ? AND namespace = ? AND workloadkind = ? AND workloadname = ?\",\n\t\t\talarm.ClusterID, alarm.Namespace, alarm.WorkloadKind, alarm.WorkloadName).Delete(&EventAlarmRecord{}).Error\n\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\n\t\tfor _, record := range records {\n\t\t\tvar count int64\n\t\t\terr = tx.Model(&EventAlarmRecord{}).Where(\"eventAlarmSettingID = ?\", record.EventAlarmSettingID).Count(&count).Error\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\n\t\t\tif count == 0 {\n\t\t\t\terr = tx.Where(\"eventAlarmSettingID = ?\", record.EventAlarmSettingID).Delete(&EventAlarmSetting{}).Error\n\t\t\t\tif err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n}",
    "caller": "func syncEventSetting(alarm EventAlarmInfo) error {\n\t// Do nothing in blacklists\n\tif inBlackProjects(alarm.ProjectID) {\n\t\treturn nil\n\t}\n\n\tmigration, err := getMigrationCRD(alarm.ClusterID, alarm.Namespace, alarm.WorkloadKind, alarm.WorkloadName)\n\tif err != nil || migration == nil {\n\t\tklog.Warningf(\"Cannot get migration for %+v, %v\", alarm, err)\n\t\treturn errors.New(\"no migration crd\")\n\t}\n\tcampInfo := migration.Status.CampInfo\n\tif campInfo == nil {\n\t\treturn errors.New(\"no migration camp info\")\n\t}\n\tif !allowMigration(alarm.ProjectID) {\n\t\treturn errors.New(\"project not allowed\")\n\t}\n\n\tphase := migration.Status.Phase\n\tvar campPolicyID string\n\tif needCampAlarmCreated(phase) {\n\t\tklog.Infof(\"Camp Info %+v\", campInfo)\n\t\tcampPolicyID, err = getOrCreateEventPolicy(campInfo, alarm)\n\t\tif err != nil {\n\t\t\tklog.Errorf(\"Cannot create or get event policy for %+v, %v\", campInfo, err)\n\t\t\treturn err\n\t\t}\n\n\t}\n\tif len(campPolicyID) > 0 {\n\t\tenableAlarmPolicy(campInfo, campPolicyID, needCampAlarmEnabled(phase))\n\t\tif err == nil {\n\t\t\tklog.Infof(\"Synced event alarm policy %s for %+v\", campPolicyID, campInfo)\n\t\t} else {\n\t\t\treturn err\n\t\t}\n\t}\n\n\tif needTKExAlarmDisabled(phase) {\n\t\tklog.Infof(\"%+v has been take over, remove workload from tkex event policy\", alarm)\n\t\tremoveWorkloadFromEvent(alarm)\n\t}\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT * FROM t_event_alarm_records WHERE clusterid = ? AND namespace = ? AND workloadkind = ? AND workloadname = ?;",
      "DELETE FROM t_event_alarm_records WHERE clusterid = ? AND namespace = ? AND workloadkind = ? AND workloadname = ?;",
      "SELECT count(*) FROM t_event_alarm_records WHERE eventAlarmSettingID = ?;",
      "DELETE FROM t_event_alarm_setting WHERE eventAlarmSettingID = ?;"
    ],
    "sql_types": [
      "SELECT",
      "DELETE",
      "SELECT",
      "DELETE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp-alarm-transfer/events.go",
        "code_start_line": 50,
        "code_end_line": 64,
        "code_key": "EventAlarmRecord",
        "code_value": "type EventAlarmRecord struct {\n\tID                  uint   `gorm:\"primaryKey;column:id\"`\n\tRecordsID           string `gorm:\"column:recordsid\"`\n\tEventAlarmSettingID string `gorm:\"foreignKey:eventAlarmSettingID;column:eventAlarmSettingID\"`\n\tAlarmObjectsType    string `gorm:\"column:alarmobjectstype\"`\n\tClusterID           string `gorm:\"column:clusterid\"`\n\tNamespace           string `gorm:\"column:namespace\"`\n\tWorkloadKind        string `gorm:\"column:workloadkind\"`\n\tWorkloadName        string `gorm:\"column:workloadname\"`\n\tKind                string `gorm:\"column:kind\"`\n\tReason              string `gorm:\"column:reason\"`\n\tInsertTime          int64  `gorm:\"column:insertTime\"`\n\tUpdateTime          int64  `gorm:\"column:updateTime\"`\n\tThreshold           int    `gorm:\"column:threshold\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "c3c88315ac47c6cc734f53e5b91dfbd63a6259d3"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp-alarm-transfer/events.go",
        "code_start_line": 81,
        "code_end_line": 83,
        "code_key": "TableName",
        "code_value": "func (EventAlarmRecord) TableName() string {\n\treturn \"t_event_alarm_records\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "c3c88315ac47c6cc734f53e5b91dfbd63a6259d3"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp-alarm-transfer/events.go",
        "code_start_line": 66,
        "code_end_line": 75,
        "code_key": "EventAlarmSetting",
        "code_value": "type EventAlarmSetting struct {\n\tEventAlarmSettingID string `gorm:\"primaryKey;column:eventAlarmSettingID\"`\n\tEventAlarmName      string `gorm:\"column:eventalarmname\"`\n\tProjectID           string `gorm:\"column:projectID\"`\n\tInsertTime          int64  `gorm:\"column:insertTime\"`\n\tUpdateTime          int64  `gorm:\"column:updateTime\"`\n\tAlarmReceiver       string `gorm:\"column:alarmreceiver\"`\n\tAlarmMethod         string `gorm:\"column:alarm_method\"`\n\tWecomBotWebhook     string `gorm:\"column:wecombotwebhook\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "c3c88315ac47c6cc734f53e5b91dfbd63a6259d3"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp-alarm-transfer/events.go",
        "code_start_line": 77,
        "code_end_line": 79,
        "code_key": "TableName",
        "code_value": "func (EventAlarmSetting) TableName() string {\n\treturn \"t_event_alarm_setting\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "c3c88315ac47c6cc734f53e5b91dfbd63a6259d3"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp-alarm-transfer/events.go",
        "code_start_line": 39,
        "code_end_line": 48,
        "code_key": "EventAlarmInfo",
        "code_value": "type EventAlarmInfo struct {\n\tClusterID    string\n\tNamespace    string\n\tWorkloadKind string\n\tProjectID    string\n\tWorkloadName string\n\tKind         string\n\tReasons      []string\n\tSetting      EventAlarmSetting\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "c3c88315ac47c6cc734f53e5b91dfbd63a6259d3"
      }
    ],
    "sql_pattern_cnt": 5,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp-alarm-transfer.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:53:99:Create",
    "orm_code": "func (r *REST) Create(ctx context.Context, obj runtime.Object, createValidation rest.ValidateObjectFunc, options *metav1.CreateOptions) (runtime.Object, error) {\n\tprj, ok := obj.(*core.Project)\n\tif !ok {\n\t\treturn nil, fmt.Errorf(\"failed to get project resources\")\n\t}\n\n\tif errs := validation.ValidateProject(prj); len(errs) > 0 {\n\t\treturn nil, errs.ToAggregate()\n\t}\n\tanno := (v1alpha1.Annotation)(prj.GetAnnotations())\n\tm := anno.GetUserMeta()\n\n\tp := model.Project{\n\t\tProjectID:    sqldb.NewColumn(prj.Name),\n\t\tOrganization: sqldb.NewColumn(anno.GetOrgnization()),\n\t\tNamedObjectMeta: model.NamedObjectMeta{\n\t\t\tDescription: sqldb.NewColumn(prj.Spec.Description),\n\t\t\tDisplayName: sqldb.NewColumn(prj.Spec.DisplayName),\n\t\t},\n\t\tUserMeta: model.UserMeta{\n\t\t\tOwnerUserID: sqldb.NewColumn(m.OwnerUserID),\n\t\t\tTenantID:    sqldb.NewColumn(m.TenantID),\n\t\t\tUserID:      sqldb.NewColumn(m.UserID),\n\t\t},\n\t}\n\n\tvar (\n\t\tnewObj runtime.Object\n\t\terr    error\n\t)\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tif err := repository.Projects.Create(ctx, &p); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err := createAuthzInfo(ctx, prj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, err = r.Store.Create(ctx, obj, createValidation, options); err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, err\n\t}\n\n\treturn newObj, nil\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:53:99:Create",
    "orm_code": "func (r *REST) Create(ctx context.Context, obj runtime.Object, createValidation rest.ValidateObjectFunc, options *metav1.CreateOptions) (runtime.Object, error) {\n\tprj, ok := obj.(*core.Project)\n\tif !ok {\n\t\treturn nil, fmt.Errorf(\"failed to get project resources\")\n\t}\n\n\tif errs := validation.ValidateProject(prj); len(errs) > 0 {\n\t\treturn nil, errs.ToAggregate()\n\t}\n\tanno := (v1alpha1.Annotation)(prj.GetAnnotations())\n\tm := anno.GetUserMeta()\n\n\tp := model.Project{\n\t\tProjectID:    sqldb.NewColumn(prj.Name),\n\t\tOrganization: sqldb.NewColumn(anno.GetOrgnization()),\n\t\tNamedObjectMeta: model.NamedObjectMeta{\n\t\t\tDescription: sqldb.NewColumn(prj.Spec.Description),\n\t\t\tDisplayName: sqldb.NewColumn(prj.Spec.DisplayName),\n\t\t},\n\t\tUserMeta: model.UserMeta{\n\t\t\tOwnerUserID: sqldb.NewColumn(m.OwnerUserID),\n\t\t\tTenantID:    sqldb.NewColumn(m.TenantID),\n\t\t\tUserID:      sqldb.NewColumn(m.UserID),\n\t\t},\n\t}\n\n\tvar (\n\t\tnewObj runtime.Object\n\t\terr    error\n\t)\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tif err := repository.Projects.Create(ctx, &p); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err := createAuthzInfo(ctx, prj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, err = r.Store.Create(ctx, obj, createValidation, options); err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, err\n\t}\n\n\treturn newObj, nil\n}",
    "caller": "func registerCRD(client *apiextensionsclientset.Clientset, file string) (err error) {\n\ttargetCRD := new(apiextensionsv1.CustomResourceDefinition)\n\n\tdefer func() {\n\t\tlog.WithName(\"tad\").Info(\"register crd done\", \"file\", file, \"name\", targetCRD.Name, \"error\", err)\n\t}()\n\n\tdata, err := os.ReadFile(file)\n\tif err != nil {\n\t\treturn err\n\t}\n\terr = runtime.DecodeInto(apiextensionsscheme.Codecs.UniversalDecoder(), data, targetCRD)\n\n\tcrd, err := client.ApiextensionsV1().CustomResourceDefinitions().Get(context.TODO(), targetCRD.Name, metav1.GetOptions{})\n\tif err != nil {\n\t\tif !apierrors.IsNotFound(err) {\n\t\t\treturn err\n\t\t}\n\t\t_, err = client.ApiextensionsV1().CustomResourceDefinitions().Create(context.TODO(), targetCRD, metav1.CreateOptions{})\n\t\treturn err\n\t}\n\n\ttargetCRD.ResourceVersion = crd.ResourceVersion\n\t_, err = client.ApiextensionsV1().CustomResourceDefinitions().Update(context.TODO(), targetCRD, metav1.UpdateOptions{})\n\n\treturn err\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:53:99:Create",
    "orm_code": "func (r *REST) Create(ctx context.Context, obj runtime.Object, createValidation rest.ValidateObjectFunc, options *metav1.CreateOptions) (runtime.Object, error) {\n\tprj, ok := obj.(*core.Project)\n\tif !ok {\n\t\treturn nil, fmt.Errorf(\"failed to get project resources\")\n\t}\n\n\tif errs := validation.ValidateProject(prj); len(errs) > 0 {\n\t\treturn nil, errs.ToAggregate()\n\t}\n\tanno := (v1alpha1.Annotation)(prj.GetAnnotations())\n\tm := anno.GetUserMeta()\n\n\tp := model.Project{\n\t\tProjectID:    sqldb.NewColumn(prj.Name),\n\t\tOrganization: sqldb.NewColumn(anno.GetOrgnization()),\n\t\tNamedObjectMeta: model.NamedObjectMeta{\n\t\t\tDescription: sqldb.NewColumn(prj.Spec.Description),\n\t\t\tDisplayName: sqldb.NewColumn(prj.Spec.DisplayName),\n\t\t},\n\t\tUserMeta: model.UserMeta{\n\t\t\tOwnerUserID: sqldb.NewColumn(m.OwnerUserID),\n\t\t\tTenantID:    sqldb.NewColumn(m.TenantID),\n\t\t\tUserID:      sqldb.NewColumn(m.UserID),\n\t\t},\n\t}\n\n\tvar (\n\t\tnewObj runtime.Object\n\t\terr    error\n\t)\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tif err := repository.Projects.Create(ctx, &p); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err := createAuthzInfo(ctx, prj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, err = r.Store.Create(ctx, obj, createValidation, options); err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, err\n\t}\n\n\treturn newObj, nil\n}",
    "caller": "func (r *REST) Create(ctx context.Context, obj runtime.Object, createValidation rest.ValidateObjectFunc, options *metav1.CreateOptions) (runtime.Object, error) {\n\tprj, ok := obj.(*core.Project)\n\tif !ok {\n\t\treturn nil, fmt.Errorf(\"failed to get project resources\")\n\t}\n\n\tif errs := validation.ValidateProject(prj); len(errs) > 0 {\n\t\treturn nil, errs.ToAggregate()\n\t}\n\tanno := (v1alpha1.Annotation)(prj.GetAnnotations())\n\tm := anno.GetUserMeta()\n\n\tp := model.Project{\n\t\tProjectID:    sqldb.NewColumn(prj.Name),\n\t\tOrganization: sqldb.NewColumn(anno.GetOrgnization()),\n\t\tNamedObjectMeta: model.NamedObjectMeta{\n\t\t\tDescription: sqldb.NewColumn(prj.Spec.Description),\n\t\t\tDisplayName: sqldb.NewColumn(prj.Spec.DisplayName),\n\t\t},\n\t\tUserMeta: model.UserMeta{\n\t\t\tOwnerUserID: sqldb.NewColumn(m.OwnerUserID),\n\t\t\tTenantID:    sqldb.NewColumn(m.TenantID),\n\t\t\tUserID:      sqldb.NewColumn(m.UserID),\n\t\t},\n\t}\n\n\tvar (\n\t\tnewObj runtime.Object\n\t\terr    error\n\t)\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tif err := repository.Projects.Create(ctx, &p); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err := createAuthzInfo(ctx, prj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, err = r.Store.Create(ctx, obj, createValidation, options); err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, err\n\t}\n\n\treturn newObj, nil\n}",
    "sql_statement_list": [
      "INSERT INTO project (project_id, organization, description, display_name, owner_user_id, tenant_id, user_id) VALUES (?, ?, ?, ?, ?, ?, ?);"
    ],
    "sql_types": [
      "INSERT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:53:99:Create",
    "orm_code": "func (r *REST) Create(ctx context.Context, obj runtime.Object, createValidation rest.ValidateObjectFunc, options *metav1.CreateOptions) (runtime.Object, error) {\n\tprj, ok := obj.(*core.Project)\n\tif !ok {\n\t\treturn nil, fmt.Errorf(\"failed to get project resources\")\n\t}\n\n\tif errs := validation.ValidateProject(prj); len(errs) > 0 {\n\t\treturn nil, errs.ToAggregate()\n\t}\n\tanno := (v1alpha1.Annotation)(prj.GetAnnotations())\n\tm := anno.GetUserMeta()\n\n\tp := model.Project{\n\t\tProjectID:    sqldb.NewColumn(prj.Name),\n\t\tOrganization: sqldb.NewColumn(anno.GetOrgnization()),\n\t\tNamedObjectMeta: model.NamedObjectMeta{\n\t\t\tDescription: sqldb.NewColumn(prj.Spec.Description),\n\t\t\tDisplayName: sqldb.NewColumn(prj.Spec.DisplayName),\n\t\t},\n\t\tUserMeta: model.UserMeta{\n\t\t\tOwnerUserID: sqldb.NewColumn(m.OwnerUserID),\n\t\t\tTenantID:    sqldb.NewColumn(m.TenantID),\n\t\t\tUserID:      sqldb.NewColumn(m.UserID),\n\t\t},\n\t}\n\n\tvar (\n\t\tnewObj runtime.Object\n\t\terr    error\n\t)\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tif err := repository.Projects.Create(ctx, &p); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err := createAuthzInfo(ctx, prj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, err = r.Store.Create(ctx, obj, createValidation, options); err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, err\n\t}\n\n\treturn newObj, nil\n}",
    "caller": "func createRoles(ctx context.Context, prj *core.Project) error {\n\troles := buildRoleModels(prj)\n\tfor _, role := range roles {\n\t\tif err := repository.Roles.Create(ctx, role); err != nil {\n\t\t\treturn err\n\t\t}\n\t}\n\treturn nil\n}",
    "sql_statement_list": [
      "INSERT INTO project (project_id, organization, description, display_name, owner_user_id, tenant_id, user_id) VALUES (?, ?, ?, ?, ?, ?, ?);"
    ],
    "sql_types": [
      "INSERT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:53:99:Create",
    "orm_code": "func (r *REST) Create(ctx context.Context, obj runtime.Object, createValidation rest.ValidateObjectFunc, options *metav1.CreateOptions) (runtime.Object, error) {\n\tprj, ok := obj.(*core.Project)\n\tif !ok {\n\t\treturn nil, fmt.Errorf(\"failed to get project resources\")\n\t}\n\n\tif errs := validation.ValidateProject(prj); len(errs) > 0 {\n\t\treturn nil, errs.ToAggregate()\n\t}\n\tanno := (v1alpha1.Annotation)(prj.GetAnnotations())\n\tm := anno.GetUserMeta()\n\n\tp := model.Project{\n\t\tProjectID:    sqldb.NewColumn(prj.Name),\n\t\tOrganization: sqldb.NewColumn(anno.GetOrgnization()),\n\t\tNamedObjectMeta: model.NamedObjectMeta{\n\t\t\tDescription: sqldb.NewColumn(prj.Spec.Description),\n\t\t\tDisplayName: sqldb.NewColumn(prj.Spec.DisplayName),\n\t\t},\n\t\tUserMeta: model.UserMeta{\n\t\t\tOwnerUserID: sqldb.NewColumn(m.OwnerUserID),\n\t\t\tTenantID:    sqldb.NewColumn(m.TenantID),\n\t\t\tUserID:      sqldb.NewColumn(m.UserID),\n\t\t},\n\t}\n\n\tvar (\n\t\tnewObj runtime.Object\n\t\terr    error\n\t)\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tif err := repository.Projects.Create(ctx, &p); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err := createAuthzInfo(ctx, prj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, err = r.Store.Create(ctx, obj, createValidation, options); err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, err\n\t}\n\n\treturn newObj, nil\n}",
    "caller": "func createRoleBinding(ctx context.Context, roleName, userID, userName string) error {\n\troleBinding := &model.RoleBinding{\n\t\tUserID:   sqldb.NewColumn(userID),\n\t\tRoleName: sqldb.NewColumn(roleName),\n\t\tUserName: sqldb.NewColumn(userName),\n\t}\n\treturn repository.RoleBindings.Create(ctx, roleBinding)\n}",
    "sql_statement_list": [
      "INSERT INTO projects (project_id, organization, description, display_name, owner_user_id, tenant_id, user_id) VALUES (?, ?, ?, ?, ?, ?, ?);"
    ],
    "sql_types": [
      "INSERT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:101:131:Delete",
    "orm_code": "func (r *REST) Delete(ctx context.Context, id string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n\tobj, err := r.Get(ctx, id, &metav1.GetOptions{})\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\tprj, ok := obj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, errors.New(\"failed to convert runtime.Object to project\")\n\t}\n\tvar newObj runtime.Object\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tvar (\n\t\t\terr error\n\t\t\tok  bool\n\t\t)\n\t\tif err = repository.DeleteProject(ctx, id); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err = deleteAuthzInfo(ctx, prj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, ok, err = r.Store.Delete(ctx, id, deleteValidation, options); err != nil || !ok {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, false, err\n\t}\n\n\treturn newObj, true, nil\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:101:131:Delete",
    "orm_code": "func (r *REST) Delete(ctx context.Context, id string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n\tobj, err := r.Get(ctx, id, &metav1.GetOptions{})\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\tprj, ok := obj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, errors.New(\"failed to convert runtime.Object to project\")\n\t}\n\tvar newObj runtime.Object\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tvar (\n\t\t\terr error\n\t\t\tok  bool\n\t\t)\n\t\tif err = repository.DeleteProject(ctx, id); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err = deleteAuthzInfo(ctx, prj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, ok, err = r.Store.Delete(ctx, id, deleteValidation, options); err != nil || !ok {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, false, err\n\t}\n\n\treturn newObj, true, nil\n}",
    "caller": "func makeAPIServiceAvailableHealthCheck(name string, apiServices []*v1.APIService, apiServiceInformer informers.APIServiceInformer) healthz.HealthChecker {\n\t// Track the auto-registered API services that have not been observed to be available yet\n\tpendingServiceNamesLock := &sync.RWMutex{}\n\tpendingServiceNames := sets.NewString()\n\tfor _, service := range apiServices {\n\t\tpendingServiceNames.Insert(service.Name)\n\t}\n\n\t// When an APIService in the list is seen as available, remove it from the pending list\n\thandleAPIServiceChange := func(service *v1.APIService) {\n\t\tpendingServiceNamesLock.Lock()\n\t\tdefer pendingServiceNamesLock.Unlock()\n\t\tif !pendingServiceNames.Has(service.Name) {\n\t\t\treturn\n\t\t}\n\t\tif v1helper.IsAPIServiceConditionTrue(service, v1.Available) {\n\t\t\tpendingServiceNames.Delete(service.Name)\n\t\t}\n\t}\n\n\t// Watch add/update events for APIServices\n\tapiServiceInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{\n\t\tAddFunc:    func(obj interface{}) { handleAPIServiceChange(obj.(*v1.APIService)) },\n\t\tUpdateFunc: func(old, new interface{}) { handleAPIServiceChange(new.(*v1.APIService)) },\n\t})\n\n\t// Don't return healthy until the pending list is empty\n\treturn healthz.NamedCheck(name, func(r *http.Request) error {\n\t\tpendingServiceNamesLock.RLock()\n\t\tdefer pendingServiceNamesLock.RUnlock()\n\t\tif pendingServiceNames.Len() > 0 {\n\t\t\treturn fmt.Errorf(\"missing APIService: %v\", pendingServiceNames.List())\n\t\t}\n\t\treturn nil\n\t})\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:101:131:Delete",
    "orm_code": "func (r *REST) Delete(ctx context.Context, id string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n\tobj, err := r.Get(ctx, id, &metav1.GetOptions{})\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\tprj, ok := obj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, errors.New(\"failed to convert runtime.Object to project\")\n\t}\n\tvar newObj runtime.Object\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tvar (\n\t\t\terr error\n\t\t\tok  bool\n\t\t)\n\t\tif err = repository.DeleteProject(ctx, id); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err = deleteAuthzInfo(ctx, prj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, ok, err = r.Store.Delete(ctx, id, deleteValidation, options); err != nil || !ok {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, false, err\n\t}\n\n\treturn newObj, true, nil\n}",
    "caller": "func (r *REST) Delete(ctx context.Context, id string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n\tobj, err := r.Get(ctx, id, &metav1.GetOptions{})\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\tprj, ok := obj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, errors.New(\"failed to convert runtime.Object to project\")\n\t}\n\tvar newObj runtime.Object\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tvar (\n\t\t\terr error\n\t\t\tok  bool\n\t\t)\n\t\tif err = repository.DeleteProject(ctx, id); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err = deleteAuthzInfo(ctx, prj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, ok, err = r.Store.Delete(ctx, id, deleteValidation, options); err != nil || !ok {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, false, err\n\t}\n\n\treturn newObj, true, nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:101:131:Delete",
    "orm_code": "func (r *REST) Delete(ctx context.Context, id string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n\tobj, err := r.Get(ctx, id, &metav1.GetOptions{})\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\tprj, ok := obj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, errors.New(\"failed to convert runtime.Object to project\")\n\t}\n\tvar newObj runtime.Object\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tvar (\n\t\t\terr error\n\t\t\tok  bool\n\t\t)\n\t\tif err = repository.DeleteProject(ctx, id); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err = deleteAuthzInfo(ctx, prj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, ok, err = r.Store.Delete(ctx, id, deleteValidation, options); err != nil || !ok {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, false, err\n\t}\n\n\treturn newObj, true, nil\n}",
    "caller": "func updateAuthzInfo(ctx context.Context, new, old *core.Project) error {\n\tdiffs := diffUsers(new.Spec.Users, old.Spec.Users)\n\tfor _, role := range presetRoles {\n\t\tdiff := diffs[role]\n\t\troleName := genRoleName(new.Name, role)\n\t\tfor _, user := range diff.usersAdd {\n\t\t\tif err := createRoleBinding(ctx, roleName, user.UserID, user.Name); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\tif len(diff.usersDel) > 0 {\n\t\t\tcols := repository.RoleBindings.Columns\n\t\t\tif err := repository.RoleBindings.Delete(ctx, sqldb.FilterOptions{\n\t\t\t\tOpOptions: []sqldb.OpQueryOption{sqldb.NewEqualOption(cols.RoleName, roleName)},\n\t\t\t\tInOptions: []sqldb.RangeQueryOption{\n\t\t\t\t\t{\n\t\t\t\t\t\tColumn: cols.UserID,\n\t\t\t\t\t\tValues: lo.ToAnySlice(diff.usersDel),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t}); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t}\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:101:131:Delete",
    "orm_code": "func (r *REST) Delete(ctx context.Context, id string, deleteValidation rest.ValidateObjectFunc, options *metav1.DeleteOptions) (runtime.Object, bool, error) {\n\tobj, err := r.Get(ctx, id, &metav1.GetOptions{})\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\tprj, ok := obj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, errors.New(\"failed to convert runtime.Object to project\")\n\t}\n\tvar newObj runtime.Object\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tvar (\n\t\t\terr error\n\t\t\tok  bool\n\t\t)\n\t\tif err = repository.DeleteProject(ctx, id); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err = deleteAuthzInfo(ctx, prj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, ok, err = r.Store.Delete(ctx, id, deleteValidation, options); err != nil || !ok {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, false, err\n\t}\n\n\treturn newObj, true, nil\n}",
    "caller": "func deleteAuthzInfo(ctx context.Context, prj *core.Project) error {\n\tvar (\n\t\tpresetRoleNames  = lo.Map(presetRoles, func(r core.Role, _ int) any { return genRoleName(prj.Name, r) })\n\t\troleBindingQuery = sqldb.FilterOptions{\n\t\t\tInOptions: []sqldb.RangeQueryOption{\n\t\t\t\t{\n\t\t\t\t\tColumn: repository.RoleBindings.Columns.RoleName,\n\t\t\t\t\tValues: presetRoleNames,\n\t\t\t\t},\n\t\t\t},\n\t\t}\n\t\troleQuery = sqldb.FilterOptions{\n\t\t\tInOptions: []sqldb.RangeQueryOption{\n\t\t\t\t{\n\t\t\t\t\tColumn: repository.Roles.Columns.Name,\n\t\t\t\t\tValues: presetRoleNames,\n\t\t\t\t},\n\t\t\t},\n\t\t}\n\t)\n\tif err := repository.RoleBindings.Delete(ctx, roleBindingQuery); err != nil {\n\t\treturn err\n\t}\n\tif err := repository.Roles.Delete(ctx, roleQuery); err != nil {\n\t\treturn err\n\t}\n\treturn nil\n}",
    "sql_statement_list": [
      "DELETE FROM role_bindings WHERE role_name IN (?, ?, ?, ?, ?, ?, ?, ?);",
      "DELETE FROM roles WHERE name IN (?, ?, ?, ?, ?, ?, ?, ?);"
    ],
    "sql_types": [
      "DELETE",
      "DELETE"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:133:201:Update",
    "orm_code": "func (r *REST) Update(ctx context.Context, name string,\n\tobjInfo rest.UpdatedObjectInfo,\n\tcreateValidation rest.ValidateObjectFunc,\n\tupdateValidation rest.ValidateObjectUpdateFunc,\n\tforceAllowCreate bool, options *metav1.UpdateOptions) (runtime.Object, bool, error) {\n\toldObj, err := r.Get(ctx, name, &metav1.GetOptions{})\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\tnewObj, err := objInfo.UpdatedObject(ctx, oldObj)\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\n\tnewPrj, ok := newObj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, fmt.Errorf(\"failed to convert runtime.Object to project\")\n\t}\n\n\tif errs := validation.ValidateProject(newPrj); len(errs) > 0 {\n\t\treturn nil, false, errs.ToAggregate()\n\t}\n\n\toldPrj, ok := oldObj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, fmt.Errorf(\"failed to convert runtime.Object to project\")\n\t}\n\n\tif !newPrj.DeletionTimestamp.IsZero() {\n\t\treturn r.Update(ctx, name, objInfo, createValidation,\n\t\t\tupdateValidation, forceAllowCreate, options)\n\t}\n\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tcols := repository.Projects.Columns\n\t\topts := []sqldb.OpQueryOption{\n\t\t\tsqldb.NewEqualOption(cols.ProjectID, newPrj.Name),\n\t\t}\n\t\tupdateOpts := []sqldb.UpdateOption{\n\t\t\t{\n\t\t\t\tColumn: cols.Description,\n\t\t\t\tValue:  newPrj.Spec.Description,\n\t\t\t},\n\t\t\t{\n\t\t\t\tColumn: cols.DisplayName,\n\t\t\t\tValue:  newPrj.Spec.DisplayName,\n\t\t\t},\n\t\t\t{\n\t\t\t\tColumn: cols.Organization,\n\t\t\t\tValue:  (v1alpha1.Annotation)(newPrj.GetAnnotations()).GetOrgnization(),\n\t\t\t},\n\t\t}\n\t\tif _, err = repository.Projects.Update(ctx, sqldb.FilterOptions{OpOptions: opts}, updateOpts); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err = updateAuthzInfo(ctx, newPrj, oldPrj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, ok, err = r.Store.Update(ctx, name, objInfo, createValidation,\n\t\t\tupdateValidation, forceAllowCreate, options); err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, false, err\n\t}\n\n\treturn newObj, true, nil\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:133:201:Update",
    "orm_code": "func (r *REST) Update(ctx context.Context, name string,\n\tobjInfo rest.UpdatedObjectInfo,\n\tcreateValidation rest.ValidateObjectFunc,\n\tupdateValidation rest.ValidateObjectUpdateFunc,\n\tforceAllowCreate bool, options *metav1.UpdateOptions) (runtime.Object, bool, error) {\n\toldObj, err := r.Get(ctx, name, &metav1.GetOptions{})\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\tnewObj, err := objInfo.UpdatedObject(ctx, oldObj)\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\n\tnewPrj, ok := newObj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, fmt.Errorf(\"failed to convert runtime.Object to project\")\n\t}\n\n\tif errs := validation.ValidateProject(newPrj); len(errs) > 0 {\n\t\treturn nil, false, errs.ToAggregate()\n\t}\n\n\toldPrj, ok := oldObj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, fmt.Errorf(\"failed to convert runtime.Object to project\")\n\t}\n\n\tif !newPrj.DeletionTimestamp.IsZero() {\n\t\treturn r.Update(ctx, name, objInfo, createValidation,\n\t\t\tupdateValidation, forceAllowCreate, options)\n\t}\n\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tcols := repository.Projects.Columns\n\t\topts := []sqldb.OpQueryOption{\n\t\t\tsqldb.NewEqualOption(cols.ProjectID, newPrj.Name),\n\t\t}\n\t\tupdateOpts := []sqldb.UpdateOption{\n\t\t\t{\n\t\t\t\tColumn: cols.Description,\n\t\t\t\tValue:  newPrj.Spec.Description,\n\t\t\t},\n\t\t\t{\n\t\t\t\tColumn: cols.DisplayName,\n\t\t\t\tValue:  newPrj.Spec.DisplayName,\n\t\t\t},\n\t\t\t{\n\t\t\t\tColumn: cols.Organization,\n\t\t\t\tValue:  (v1alpha1.Annotation)(newPrj.GetAnnotations()).GetOrgnization(),\n\t\t\t},\n\t\t}\n\t\tif _, err = repository.Projects.Update(ctx, sqldb.FilterOptions{OpOptions: opts}, updateOpts); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err = updateAuthzInfo(ctx, newPrj, oldPrj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, ok, err = r.Store.Update(ctx, name, objInfo, createValidation,\n\t\t\tupdateValidation, forceAllowCreate, options); err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, false, err\n\t}\n\n\treturn newObj, true, nil\n}",
    "caller": "func registerCRD(client *apiextensionsclientset.Clientset, file string) (err error) {\n\ttargetCRD := new(apiextensionsv1.CustomResourceDefinition)\n\n\tdefer func() {\n\t\tlog.WithName(\"tad\").Info(\"register crd done\", \"file\", file, \"name\", targetCRD.Name, \"error\", err)\n\t}()\n\n\tdata, err := os.ReadFile(file)\n\tif err != nil {\n\t\treturn err\n\t}\n\terr = runtime.DecodeInto(apiextensionsscheme.Codecs.UniversalDecoder(), data, targetCRD)\n\n\tcrd, err := client.ApiextensionsV1().CustomResourceDefinitions().Get(context.TODO(), targetCRD.Name, metav1.GetOptions{})\n\tif err != nil {\n\t\tif !apierrors.IsNotFound(err) {\n\t\t\treturn err\n\t\t}\n\t\t_, err = client.ApiextensionsV1().CustomResourceDefinitions().Create(context.TODO(), targetCRD, metav1.CreateOptions{})\n\t\treturn err\n\t}\n\n\ttargetCRD.ResourceVersion = crd.ResourceVersion\n\t_, err = client.ApiextensionsV1().CustomResourceDefinitions().Update(context.TODO(), targetCRD, metav1.UpdateOptions{})\n\n\treturn err\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:133:201:Update",
    "orm_code": "func (r *REST) Update(ctx context.Context, name string,\n\tobjInfo rest.UpdatedObjectInfo,\n\tcreateValidation rest.ValidateObjectFunc,\n\tupdateValidation rest.ValidateObjectUpdateFunc,\n\tforceAllowCreate bool, options *metav1.UpdateOptions) (runtime.Object, bool, error) {\n\toldObj, err := r.Get(ctx, name, &metav1.GetOptions{})\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\tnewObj, err := objInfo.UpdatedObject(ctx, oldObj)\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\n\tnewPrj, ok := newObj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, fmt.Errorf(\"failed to convert runtime.Object to project\")\n\t}\n\n\tif errs := validation.ValidateProject(newPrj); len(errs) > 0 {\n\t\treturn nil, false, errs.ToAggregate()\n\t}\n\n\toldPrj, ok := oldObj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, fmt.Errorf(\"failed to convert runtime.Object to project\")\n\t}\n\n\tif !newPrj.DeletionTimestamp.IsZero() {\n\t\treturn r.Update(ctx, name, objInfo, createValidation,\n\t\t\tupdateValidation, forceAllowCreate, options)\n\t}\n\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tcols := repository.Projects.Columns\n\t\topts := []sqldb.OpQueryOption{\n\t\t\tsqldb.NewEqualOption(cols.ProjectID, newPrj.Name),\n\t\t}\n\t\tupdateOpts := []sqldb.UpdateOption{\n\t\t\t{\n\t\t\t\tColumn: cols.Description,\n\t\t\t\tValue:  newPrj.Spec.Description,\n\t\t\t},\n\t\t\t{\n\t\t\t\tColumn: cols.DisplayName,\n\t\t\t\tValue:  newPrj.Spec.DisplayName,\n\t\t\t},\n\t\t\t{\n\t\t\t\tColumn: cols.Organization,\n\t\t\t\tValue:  (v1alpha1.Annotation)(newPrj.GetAnnotations()).GetOrgnization(),\n\t\t\t},\n\t\t}\n\t\tif _, err = repository.Projects.Update(ctx, sqldb.FilterOptions{OpOptions: opts}, updateOpts); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err = updateAuthzInfo(ctx, newPrj, oldPrj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, ok, err = r.Store.Update(ctx, name, objInfo, createValidation,\n\t\t\tupdateValidation, forceAllowCreate, options); err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, false, err\n\t}\n\n\treturn newObj, true, nil\n}",
    "caller": "func (c *Controller) sync(ctx context.Context, project *v1alpha1.Project) (err error) {\n\tspan, ctx := jaeger.StartSpanFromContext(ctx)\n\tdefer span.Finish()\n\n\tspan.SetTag(\"project\", project.Name)\n\n\tspan.LogKV(\"project\", jaeger.JSON(project))\n\n\tlogger := log.FromContext(ctx)\n\n\tctx = c.initContext(ctx, project)\n\n\tdefer func() {\n\t\tif s := recover(); s != nil {\n\t\t\tif stack := concurrent.GetPanicStackTrace(s); stack != \"\" {\n\t\t\t\terr = errors.New(stack)\n\n\t\t\t\treq := (&alarm.Request{\n\t\t\t\t\tObjType: \"module\",\n\t\t\t\t\tObjName: c.name,\n\t\t\t\t\tRegion:  \"region\",\n\t\t\t\t\tObjID:   project.Name,\n\t\t\t\t\tContent: \"Panic\",\n\t\t\t\t}).WithLabels(\"jaeger\", jaeger.QueryURL(jaeger.WithTags(\"project\", project.Name))).\n\t\t\t\t\tWithValues(\"Stack\", stack)\n\t\t\t\tif err := alarm.Send(req); err != nil {\n\t\t\t\t\tc.log.Error(err, \"send alarm error\")\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif err != nil {\n\t\t\tproject.Status.State = v1alpha1.StateFailed\n\t\t\tproject.Status.Error = err.Error()\n\n\t\t\tjaeger.LogError(span, err)\n\t\t} else {\n\t\t\tproject.Status.State = v1alpha1.StateReconciled\n\t\t\tproject.Status.Error = \"\"\n\t\t}\n\n\t\tproject.Status.LastSyncTime = metav1.Now()\n\t\t_, err1 := c.ProjectsGetter.Projects().Update(context.Background(), project, metav1.UpdateOptions{})\n\t\tif err1 != nil {\n\t\t\tlogger.Error(err1, \"update project error\")\n\t\t}\n\t}()\n\n\tk8s.AddFinalizer(project, v1alpha1.ProjectFinalizer)\n\n\tif !project.DeletionTimestamp.IsZero() {\n\t\tlogger.Info(\"Delete project doing\")\n\t\terr = c.delete(ctx, project)\n\t\tif err != nil {\n\t\t\tlogger.Error(err, \"Delete project error\")\n\t\t} else {\n\t\t\tlogger.Info(\"Delete project success\")\n\t\t}\n\n\t\treturn err\n\t}\n\n\tfor _, f := range c.syncHandlers {\n\t\terr1 := func() error {\n\t\t\tspan, ctx := jaeger.StartSpanFromContext(ctx, jaeger.WithOperationName(f.Name()))\n\t\t\tdefer span.Finish()\n\n\t\t\terr := f(ctx, project)\n\t\t\tcondition := project.Status.GetConditionOrDefault(v1alpha1.ConditionType(f.Name()))\n\t\t\tif err != nil {\n\t\t\t\tcondition.Status = v1alpha1.ConditionFalse\n\t\t\t\tcondition.Message = err.Error()\n\t\t\t} else {\n\t\t\t\tcondition.Status = v1alpha1.ConditionTrue\n\t\t\t\tcondition.Message = \"\"\n\t\t\t}\n\t\t\tproject.Status.SetCondition(*condition)\n\n\t\t\treturn err\n\t\t}()\n\t\tif errors.Is(err1, context.DeadlineExceeded) {\n\t\t\terr = fmt.Errorf(\"%s timeout(%s): %w\", f.Name(), config.Get().Controllers.Project.SyncTimeout, err1)\n\t\t\tbreak\n\t\t}\n\t\tif err1 != nil {\n\t\t\terr = multierror.Append(err, err1)\n\t\t}\n\t}\n\n\treturn err\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__camp/pkg/registry/core/project/storage/storage.go:133:201:Update",
    "orm_code": "func (r *REST) Update(ctx context.Context, name string,\n\tobjInfo rest.UpdatedObjectInfo,\n\tcreateValidation rest.ValidateObjectFunc,\n\tupdateValidation rest.ValidateObjectUpdateFunc,\n\tforceAllowCreate bool, options *metav1.UpdateOptions) (runtime.Object, bool, error) {\n\toldObj, err := r.Get(ctx, name, &metav1.GetOptions{})\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\tnewObj, err := objInfo.UpdatedObject(ctx, oldObj)\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\n\tnewPrj, ok := newObj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, fmt.Errorf(\"failed to convert runtime.Object to project\")\n\t}\n\n\tif errs := validation.ValidateProject(newPrj); len(errs) > 0 {\n\t\treturn nil, false, errs.ToAggregate()\n\t}\n\n\toldPrj, ok := oldObj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, fmt.Errorf(\"failed to convert runtime.Object to project\")\n\t}\n\n\tif !newPrj.DeletionTimestamp.IsZero() {\n\t\treturn r.Update(ctx, name, objInfo, createValidation,\n\t\t\tupdateValidation, forceAllowCreate, options)\n\t}\n\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tcols := repository.Projects.Columns\n\t\topts := []sqldb.OpQueryOption{\n\t\t\tsqldb.NewEqualOption(cols.ProjectID, newPrj.Name),\n\t\t}\n\t\tupdateOpts := []sqldb.UpdateOption{\n\t\t\t{\n\t\t\t\tColumn: cols.Description,\n\t\t\t\tValue:  newPrj.Spec.Description,\n\t\t\t},\n\t\t\t{\n\t\t\t\tColumn: cols.DisplayName,\n\t\t\t\tValue:  newPrj.Spec.DisplayName,\n\t\t\t},\n\t\t\t{\n\t\t\t\tColumn: cols.Organization,\n\t\t\t\tValue:  (v1alpha1.Annotation)(newPrj.GetAnnotations()).GetOrgnization(),\n\t\t\t},\n\t\t}\n\t\tif _, err = repository.Projects.Update(ctx, sqldb.FilterOptions{OpOptions: opts}, updateOpts); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err = updateAuthzInfo(ctx, newPrj, oldPrj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, ok, err = r.Store.Update(ctx, name, objInfo, createValidation,\n\t\t\tupdateValidation, forceAllowCreate, options); err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, false, err\n\t}\n\n\treturn newObj, true, nil\n}",
    "caller": "func (r *REST) Update(ctx context.Context, name string,\n\tobjInfo rest.UpdatedObjectInfo,\n\tcreateValidation rest.ValidateObjectFunc,\n\tupdateValidation rest.ValidateObjectUpdateFunc,\n\tforceAllowCreate bool, options *metav1.UpdateOptions) (runtime.Object, bool, error) {\n\toldObj, err := r.Get(ctx, name, &metav1.GetOptions{})\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\tnewObj, err := objInfo.UpdatedObject(ctx, oldObj)\n\tif err != nil {\n\t\treturn nil, false, err\n\t}\n\n\tnewPrj, ok := newObj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, fmt.Errorf(\"failed to convert runtime.Object to project\")\n\t}\n\n\tif errs := validation.ValidateProject(newPrj); len(errs) > 0 {\n\t\treturn nil, false, errs.ToAggregate()\n\t}\n\n\toldPrj, ok := oldObj.(*core.Project)\n\tif !ok {\n\t\treturn nil, false, fmt.Errorf(\"failed to convert runtime.Object to project\")\n\t}\n\n\tif !newPrj.DeletionTimestamp.IsZero() {\n\t\treturn r.Update(ctx, name, objInfo, createValidation,\n\t\t\tupdateValidation, forceAllowCreate, options)\n\t}\n\n\tif err := repository.Transaction(ctx, func(ctx context.Context) error {\n\t\tcols := repository.Projects.Columns\n\t\topts := []sqldb.OpQueryOption{\n\t\t\tsqldb.NewEqualOption(cols.ProjectID, newPrj.Name),\n\t\t}\n\t\tupdateOpts := []sqldb.UpdateOption{\n\t\t\t{\n\t\t\t\tColumn: cols.Description,\n\t\t\t\tValue:  newPrj.Spec.Description,\n\t\t\t},\n\t\t\t{\n\t\t\t\tColumn: cols.DisplayName,\n\t\t\t\tValue:  newPrj.Spec.DisplayName,\n\t\t\t},\n\t\t\t{\n\t\t\t\tColumn: cols.Organization,\n\t\t\t\tValue:  (v1alpha1.Annotation)(newPrj.GetAnnotations()).GetOrgnization(),\n\t\t\t},\n\t\t}\n\t\tif _, err = repository.Projects.Update(ctx, sqldb.FilterOptions{OpOptions: opts}, updateOpts); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif err = updateAuthzInfo(ctx, newPrj, oldPrj); err != nil {\n\t\t\treturn err\n\t\t}\n\t\tif newObj, ok, err = r.Store.Update(ctx, name, objInfo, createValidation,\n\t\t\tupdateValidation, forceAllowCreate, options); err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn nil, false, err\n\t}\n\n\treturn newObj, true, nil\n}",
    "sql_statement_list": [
      "UPDATE projects SET description = ?, display_name = ?, organization = ? WHERE project_id = ?;"
    ],
    "sql_types": [
      "UPDATE"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__camp.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__crd-sync-controller/pkg/controller/controllerrevision/controllerrevision_controller.go:230:269:createResourceWithLimit",
    "orm_code": "func (c *Controller) createResourceWithLimit(ctx context.Context, cr *appv1.ControllerRevision) (time.Duration, error) {\n\tvar resource k8s.ControllerRevision\n\terr := c.convertResourceToModel(ctx, cr, &resource)\n\tif err != nil {\n\t\treturn 0, err\n\t}\n\tif err = checkResource(&resource); err != nil {\n\t\tklog.FromContext(ctx).Error(err, \"check resource\", cr.GetName())\n\t\treturn 0, nil\n\t}\n\n\treturn 0, c.cacheDB.Unscoped().WithContext(ctx).Transaction(func(tx *gorm.DB) error {\n\t\tvar count int64\n\t\tcondition := map[string]interface{}{\n\t\t\t\"Namespace\":     resource.Namespace,\n\t\t\t\"ProjectID\":     resource.ProjectID,\n\t\t\t\"ApplicationID\": resource.ApplicationID,\n\t\t\t\"InstanceID\":    resource.InstanceID,\n\t\t\t\"ClusterID\":     c.clusterID,\n\t\t}\n\t\tif err := tx.WithContext(ctx).\n\t\t\tModel(&k8s.ControllerRevision{}).\n\t\t\tWhere(condition).\n\t\t\tCount(&count).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\n\t\tif count >= maxItemCount {\n\t\t\t// 删除超出 maxItemCount 的所有旧记录\n\t\t\tif err := tx.WithContext(ctx).\n\t\t\t\tWhere(condition).\n\t\t\t\tLimit(int(count - maxItemCount + 1)).\n\t\t\t\tDelete(&k8s.ControllerRevision{}).Error; err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\n\t\treturn tx.Create(&resource).Error\n\t})\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT count(*) FROM `controller_revision` WHERE `Namespace` = ? AND `ProjectID` = ? AND `ApplicationID` = ? AND `InstanceID` = ? AND `ClusterID` = ? AND `controller_revision`.`DeletedAt` IS NULL;",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "记录数超过限制时删除多余记录",
            "sql": "DELETE FROM `controller_revision` WHERE `Namespace` = ? AND `ProjectID` = ? AND `ApplicationID` = ? AND `InstanceID` = ? AND `ClusterID` = ? LIMIT ?;"
          },
          {
            "scenario": "记录数未超过限制时跳过删除",
            "sql": ""
          }
        ]
      },
      "INSERT INTO `controller_revision` (`APPID`,`TenantID`,`UID`,`Name`,`Namespace`,`EnvironmentName`,`ResourceVersion`,`ProjectID`,`ApplicationID`,`InstanceID`,`ApplicationName`,`Revision`,`Hash`,`Labels`,`Annotations`,`Images`,`ClusterID`,`Raw`,`CreatedAt`,`UpdatedAt`,`DeletedAt`) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);"
    ],
    "sql_types": [
      "SELECT",
      "PARAM_DEPENDENT",
      "INSERT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__crd-sync-controller/internal/models/k8s/controllerrevision.go",
        "code_start_line": 10,
        "code_end_line": 33,
        "code_key": "ControllerRevision",
        "code_value": "type ControllerRevision struct {\n\tID              uint64            `gorm:\"primaryKey;autoIncrement;column:ID\"`\n\tAPPID           string            `gorm:\"size:20;not null;column:APPID\"`\n\tTenantID        string            `gorm:\"size:20;not null;column:TenantID\"`\n\tUID             string            `gorm:\"size:255;not null;column:UID\"`\n\tName            string            `gorm:\"size:255;not null;column:Name\"`\n\tNamespace       string            `gorm:\"size:125;not null;column:Namespace\"`\n\tEnvironmentName string            `gorm:\"size:255;not null;column:EnvironmentName\"`\n\tResourceVersion uint64            `gorm:\"column:ResourceVersion\" json:\"ResourceVersion\"`\n\tProjectID       string            `gorm:\"size:20;not null;column:ProjectID\"`\n\tApplicationID   string            `gorm:\"size:20;not null;column:ApplicationID\"`\n\tInstanceID      string            `gorm:\"size:20;not null;column:InstanceID\"`\n\tApplicationName string            `gorm:\"size:255;not null;column:ApplicationName\"`\n\tRevision        string            `gorm:\"size:20;not null;column:Revision\"`\n\tHash            string            `gorm:\"size:20;not null;column:Hash\"`\n\tLabels          map[string]string `gorm:\"not null;serializer:json;column:Labels\" json:\"Labels\"`\n\tAnnotations     map[string]string `gorm:\"not null;serializer:json;column:Annotations\" json:\"Annotations\"`\n\tImages          []string          `gorm:\"not null;serializer:json;column:Images\" json:\"Images\"`\n\tClusterID       string            `gorm:\"size:20;not null;column:ClusterID\"`\n\tRaw             any               `gorm:\"not null;serializer:json;column:Raw\" json:\"Raw\"`\n\tCreatedAt       time.Time         `gorm:\"<-:false\" json:\"CreatedAt\"`\n\tUpdatedAt       time.Time         `gorm:\"<-:false\" json:\"UpdatedAt\"`\n\tDeletedAt       gorm.DeletedAt    `gorm:\"index;column:DeletedAt\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "219f66bf03f5cae3fbde6291b0e43a9c5857ce90"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__crd-sync-controller.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__crd-sync-controller/pkg/controller/controllerrevision/controllerrevision_controller.go:230:269:createResourceWithLimit",
    "orm_code": "func (c *Controller) createResourceWithLimit(ctx context.Context, cr *appv1.ControllerRevision) (time.Duration, error) {\n\tvar resource k8s.ControllerRevision\n\terr := c.convertResourceToModel(ctx, cr, &resource)\n\tif err != nil {\n\t\treturn 0, err\n\t}\n\tif err = checkResource(&resource); err != nil {\n\t\tklog.FromContext(ctx).Error(err, \"check resource\", cr.GetName())\n\t\treturn 0, nil\n\t}\n\n\treturn 0, c.cacheDB.Unscoped().WithContext(ctx).Transaction(func(tx *gorm.DB) error {\n\t\tvar count int64\n\t\tcondition := map[string]interface{}{\n\t\t\t\"Namespace\":     resource.Namespace,\n\t\t\t\"ProjectID\":     resource.ProjectID,\n\t\t\t\"ApplicationID\": resource.ApplicationID,\n\t\t\t\"InstanceID\":    resource.InstanceID,\n\t\t\t\"ClusterID\":     c.clusterID,\n\t\t}\n\t\tif err := tx.WithContext(ctx).\n\t\t\tModel(&k8s.ControllerRevision{}).\n\t\t\tWhere(condition).\n\t\t\tCount(&count).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\n\t\tif count >= maxItemCount {\n\t\t\t// 删除超出 maxItemCount 的所有旧记录\n\t\t\tif err := tx.WithContext(ctx).\n\t\t\t\tWhere(condition).\n\t\t\t\tLimit(int(count - maxItemCount + 1)).\n\t\t\t\tDelete(&k8s.ControllerRevision{}).Error; err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\n\t\treturn tx.Create(&resource).Error\n\t})\n}",
    "caller": "func (c *Controller) createOrUpdate(ctx context.Context,\n\tkey string, cr *appv1.ControllerRevision) (time.Duration, error) {\n\tctxLogger := klog.FromContext(ctx)\n\tvar resource k8s.ControllerRevision\n\terr := c.cacheDB.Unscoped().WithContext(ctx).\n\t\tSelect(\"ID\", \"Name\", \"Namespace\", \"ClusterID\", \"ResourceVersion\").\n\t\tWhere(\"Name = ? AND Namespace = ? AND ClusterID = ?\", cr.GetName(), cr.GetNamespace(), c.clusterID).\n\t\tFirst(&resource).Error\n\tif err != nil {\n\t\tif errors.Is(err, gorm.ErrRecordNotFound) {\n\t\t\tctxLogger.Info(\"Creating new resource\", \"crd\", key)\n\t\t\treturn c.createResourceWithLimit(ctx, cr)\n\t\t}\n\t\treturn 0, err\n\t}\n\tresourceVersion, err := strconv.ParseUint(cr.GetResourceVersion(), 10, 64)\n\tif err != nil {\n\t\tresourceVersion = 0\n\t}\n\tif resource.ResourceVersion == resourceVersion {\n\t\treturn 0, nil\n\t}\n\tresource.ResourceVersion = resourceVersion\n\tctxLogger.Info(\"Update resource\", \"crd\", key)\n\treturn c.updateResource(ctx, cr, &resource)\n}",
    "sql_statement_list": [
      "SELECT count(*) FROM `controller_revisions` WHERE `Namespace` = ? AND `ProjectID` = ? AND `ApplicationID` = ? AND `InstanceID` = ? AND `ClusterID` = ?;",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "记录数超出限制时执行删除",
            "sql": "DELETE FROM `controller_revisions` WHERE `Namespace` = ? AND `ProjectID` = ? AND `ApplicationID` = ? AND `InstanceID` = ? AND `ClusterID` = ? LIMIT ?;"
          },
          {
            "scenario": "记录数未超限制时跳过删除",
            "sql": ""
          }
        ]
      },
      "INSERT INTO `controller_revisions` (`APPID`,`TenantID`,`UID`,`Name`,`Namespace`,`EnvironmentName`,`ResourceVersion`,`ProjectID`,`ApplicationID`,`InstanceID`,`ApplicationName`,`Revision`,`Hash`,`Labels`,`Annotations`,`Images`,`ClusterID`,`Raw`,`CreatedAt`,`UpdatedAt`,`DeletedAt`) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);"
    ],
    "sql_types": [
      "SELECT",
      "PARAM_DEPENDENT",
      "INSERT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__crd-sync-controller/internal/models/k8s/controllerrevision.go",
        "code_start_line": 10,
        "code_end_line": 33,
        "code_key": "ControllerRevision",
        "code_value": "type ControllerRevision struct {\n\tID              uint64            `gorm:\"primaryKey;autoIncrement;column:ID\"`\n\tAPPID           string            `gorm:\"size:20;not null;column:APPID\"`\n\tTenantID        string            `gorm:\"size:20;not null;column:TenantID\"`\n\tUID             string            `gorm:\"size:255;not null;column:UID\"`\n\tName            string            `gorm:\"size:255;not null;column:Name\"`\n\tNamespace       string            `gorm:\"size:125;not null;column:Namespace\"`\n\tEnvironmentName string            `gorm:\"size:255;not null;column:EnvironmentName\"`\n\tResourceVersion uint64            `gorm:\"column:ResourceVersion\" json:\"ResourceVersion\"`\n\tProjectID       string            `gorm:\"size:20;not null;column:ProjectID\"`\n\tApplicationID   string            `gorm:\"size:20;not null;column:ApplicationID\"`\n\tInstanceID      string            `gorm:\"size:20;not null;column:InstanceID\"`\n\tApplicationName string            `gorm:\"size:255;not null;column:ApplicationName\"`\n\tRevision        string            `gorm:\"size:20;not null;column:Revision\"`\n\tHash            string            `gorm:\"size:20;not null;column:Hash\"`\n\tLabels          map[string]string `gorm:\"not null;serializer:json;column:Labels\" json:\"Labels\"`\n\tAnnotations     map[string]string `gorm:\"not null;serializer:json;column:Annotations\" json:\"Annotations\"`\n\tImages          []string          `gorm:\"not null;serializer:json;column:Images\" json:\"Images\"`\n\tClusterID       string            `gorm:\"size:20;not null;column:ClusterID\"`\n\tRaw             any               `gorm:\"not null;serializer:json;column:Raw\" json:\"Raw\"`\n\tCreatedAt       time.Time         `gorm:\"<-:false\" json:\"CreatedAt\"`\n\tUpdatedAt       time.Time         `gorm:\"<-:false\" json:\"UpdatedAt\"`\n\tDeletedAt       gorm.DeletedAt    `gorm:\"index;column:DeletedAt\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "219f66bf03f5cae3fbde6291b0e43a9c5857ce90"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__crd-sync-controller.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__eks-machinetype-config/pkg/db/db.go:387:433:updateEksTKExConfigBatches",
    "orm_code": "func (dbm *dbManager) updateEksTKExConfigBatches(db *gorm.DB, items []EksTKExPoolConfig) error {\n\tvar rowsAffected int\n\tbatchSize := 500\n\tconcurrence := 10\n\tupdate := func(s, e int) error {\n\t\treturn db.Transaction(func(tx *gorm.DB) error {\n\t\t\tfor index := s; index < e; index++ {\n\t\t\t\tif err := tx.Model(&EksTKExPoolConfig{}).Where(\"id=?\", items[index].ID).\n\t\t\t\t\tUpdates(map[string]interface{}{\"ifs\": items[index].InstanceTypes}).Error; err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn nil\n\t\t})\n\t}\n\tch := make(chan [2]int, concurrence)\n\tvar latestErr error\n\twg := sync.WaitGroup{}\n\tfor i := 0; i < concurrence; i++ {\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tdefer wg.Done()\n\t\t\tfor {\n\t\t\t\tselect {\n\t\t\t\tcase t := <-ch:\n\t\t\t\t\tif err := update(t[0], t[1]); err != nil {\n\t\t\t\t\t\tlatestErr = err\n\t\t\t\t\t} else {\n\t\t\t\t\t\trowsAffected += t[1] - t[0]\n\t\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t}\n\tfor i := 0; i < len(items); i += batchSize {\n\t\ts := i\n\t\te := i + batchSize\n\t\tif e > len(items) {\n\t\t\te = len(items)\n\t\t}\n\t\tch <- [2]int{s, e}\n\t}\n\twg.Wait()\n\treturn latestErr\n}",
    "caller": "",
    "sql_statement_list": [
      "BEGIN;",
      "UPDATE tkex_pool_config SET ifs = ? WHERE id = ?;",
      "COMMIT;"
    ],
    "sql_types": [
      "OTHER",
      "UPDATE",
      "OTHER"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__eks-machinetype-config/pkg/db/db.go",
        "code_start_line": 30,
        "code_end_line": 39,
        "code_key": "EksTKExPoolConfig",
        "code_value": "type EksTKExPoolConfig struct {\n\tID            int64  `gorm:\"column:id\" json:\"id\"`\n\tAppID         string `gorm:\"column:appId\" json:\"appId\"`\n\tClusterID     string `gorm:\"column:clusterId\" json:\"clusterId\"`\n\tNamespace     string `gorm:\"column:namespace\" json:\"namespace\"`\n\tKindName      string `gorm:\"column:kindName\" json:\"kindName\"`\n\tWorkloadName  string `gorm:\"column:workloadName\" json:\"workloadName\"`\n\tPool          string `gorm:\"column:pool\" json:\"pool\"`\n\tInstanceTypes string `gorm:\"column:ifs\" json:\"ifs\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "3850568e8ab675aa289962d265afc11551c4fc56"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__eks-machinetype-config/pkg/db/db.go",
        "code_start_line": 47,
        "code_end_line": 49,
        "code_key": "TableName",
        "code_value": "func (EksTKExPoolConfig) TableName() string {\n\treturn \"tkex_pool_config\" // nolint\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "3850568e8ab675aa289962d265afc11551c4fc56"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__eks-machinetype-config.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__eks-machinetype-config/pkg/db/db.go:387:433:updateEksTKExConfigBatches",
    "orm_code": "func (dbm *dbManager) updateEksTKExConfigBatches(db *gorm.DB, items []EksTKExPoolConfig) error {\n\tvar rowsAffected int\n\tbatchSize := 500\n\tconcurrence := 10\n\tupdate := func(s, e int) error {\n\t\treturn db.Transaction(func(tx *gorm.DB) error {\n\t\t\tfor index := s; index < e; index++ {\n\t\t\t\tif err := tx.Model(&EksTKExPoolConfig{}).Where(\"id=?\", items[index].ID).\n\t\t\t\t\tUpdates(map[string]interface{}{\"ifs\": items[index].InstanceTypes}).Error; err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn nil\n\t\t})\n\t}\n\tch := make(chan [2]int, concurrence)\n\tvar latestErr error\n\twg := sync.WaitGroup{}\n\tfor i := 0; i < concurrence; i++ {\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tdefer wg.Done()\n\t\t\tfor {\n\t\t\t\tselect {\n\t\t\t\tcase t := <-ch:\n\t\t\t\t\tif err := update(t[0], t[1]); err != nil {\n\t\t\t\t\t\tlatestErr = err\n\t\t\t\t\t} else {\n\t\t\t\t\t\trowsAffected += t[1] - t[0]\n\t\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t}\n\tfor i := 0; i < len(items); i += batchSize {\n\t\ts := i\n\t\te := i + batchSize\n\t\tif e > len(items) {\n\t\t\te = len(items)\n\t\t}\n\t\tch <- [2]int{s, e}\n\t}\n\twg.Wait()\n\treturn latestErr\n}",
    "caller": "func (dbm *dbManager) UpdateEksTKExConfig(region string, items []EksTKExPoolConfig) error {\n\t//if len(items) == 0 {\n\t//\treturn nil\n\t//}\n\t//db := dbm.getEksRegionDB(region)\n\t//if db == nil {\n\t//\treturn fmt.Errorf(\"get eks %s db fail\", region)\n\t//}\n\t//\n\t//for _, item := range items {\n\t//\tif err := db.Model(&EksTKExPoolConfig{}).Where(\"id = ?\", item.ID).\n\t//\t\tUpdates(map[string]interface{}{\"ifs\": item.InstanceTypes}).Error; err != nil {\n\t//\t\treturn fmt.Errorf(\"UpdateEksTKExConfig id:%d err:%v\", item.ID, err)\n\t//\t}\n\t//}\n\t//return nil\n\tif len(items) == 0 {\n\t\treturn nil\n\t}\n\tdb := dbm.getEksRegionDB(region)\n\tif db == nil {\n\t\treturn fmt.Errorf(\"get eks %s db fail\", region)\n\t}\n\treturn dbm.updateEksTKExConfigBatches(db, items)\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "批量更新操作 - 每个item生成一条UPDATE语句",
            "sql": "UPDATE `tkex_pool_config` SET `ifs`=? WHERE id=?;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__eks-machinetype-config/pkg/db/db.go",
        "code_start_line": 30,
        "code_end_line": 39,
        "code_key": "EksTKExPoolConfig",
        "code_value": "type EksTKExPoolConfig struct {\n\tID            int64  `gorm:\"column:id\" json:\"id\"`\n\tAppID         string `gorm:\"column:appId\" json:\"appId\"`\n\tClusterID     string `gorm:\"column:clusterId\" json:\"clusterId\"`\n\tNamespace     string `gorm:\"column:namespace\" json:\"namespace\"`\n\tKindName      string `gorm:\"column:kindName\" json:\"kindName\"`\n\tWorkloadName  string `gorm:\"column:workloadName\" json:\"workloadName\"`\n\tPool          string `gorm:\"column:pool\" json:\"pool\"`\n\tInstanceTypes string `gorm:\"column:ifs\" json:\"ifs\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "3850568e8ab675aa289962d265afc11551c4fc56"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__eks-machinetype-config/pkg/db/db.go",
        "code_start_line": 47,
        "code_end_line": 49,
        "code_key": "TableName",
        "code_value": "func (EksTKExPoolConfig) TableName() string {\n\treturn \"tkex_pool_config\" // nolint\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "3850568e8ab675aa289962d265afc11551c4fc56"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__eks-machinetype-config.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/cache/cache.go:33:55:fetchQueryParam",
    "orm_code": "func (c *MySQLCache) fetchQueryParam() {\n\tconn, err := db.NewDb()\n\tif err != nil {\n\t\treturn\n\t}\n\tret := make(map[string]*model.GrafanaQueryParam)\n\tif err := conn.Transaction(func(tx *gorm.DB) error {\n\t\tqueries := make([]*model.GrafanaQueryParam, 0)\n\t\tdefer monitor.AddHttpRequestTotal(\"MySQL\")\n\t\tif err := tx.Model(&model.GrafanaQueryParam{}).Find(&queries).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor _, query := range queries {\n\t\t\tret[query.ParamName] = query\n\t\t}\n\t\treturn nil\n\t}); err == nil {\n\t\tc.pLock.Lock()\n\t\tdefer c.pLock.Unlock()\n\t\tc.paramCache = ret\n\t\tlogger.Infof(\"Fetch query param data.\\n\")\n\t}\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT param_name, grafana_variable_name, from_query, dashboard_id, regex, check_auth FROM t_query_param;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 16,
        "code_end_line": 23,
        "code_key": "GrafanaQueryParam",
        "code_value": "type GrafanaQueryParam struct {\n\tParamName           string `gorm:\"column:param_name\"` // 唯一\n\tGrafanaVariableName string `gorm:\"column:grafana_variable_name\"`\n\tFromQuery           bool   `gorm:\"column:from_query\"`\n\tDashboardId         string `gorm:\"column:dashboard_id\"`\n\tRegex               string `gorm:\"column:regex\"`\n\tCheckAuth           bool   `gorm:\"column:check_auth\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 35,
        "code_end_line": 37,
        "code_key": "TableName",
        "code_value": "func (GrafanaQueryParam) TableName() string {\n\treturn \"t_query_param\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__grafana-gateway.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/cache/cache.go:33:55:fetchQueryParam",
    "orm_code": "func (c *MySQLCache) fetchQueryParam() {\n\tconn, err := db.NewDb()\n\tif err != nil {\n\t\treturn\n\t}\n\tret := make(map[string]*model.GrafanaQueryParam)\n\tif err := conn.Transaction(func(tx *gorm.DB) error {\n\t\tqueries := make([]*model.GrafanaQueryParam, 0)\n\t\tdefer monitor.AddHttpRequestTotal(\"MySQL\")\n\t\tif err := tx.Model(&model.GrafanaQueryParam{}).Find(&queries).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor _, query := range queries {\n\t\t\tret[query.ParamName] = query\n\t\t}\n\t\treturn nil\n\t}); err == nil {\n\t\tc.pLock.Lock()\n\t\tdefer c.pLock.Unlock()\n\t\tc.paramCache = ret\n\t\tlogger.Infof(\"Fetch query param data.\\n\")\n\t}\n}",
    "caller": "func GetCache() *MySQLCache {\n\tcacheOnce.Do(func() {\n\t\tdb.RedisClient().SRem(context.Background(), FetchLatestDashboardRedisKey, podName) // 确保init cache时能够fetch dashboard and queries\n\t\tc := &MySQLCache{}\n\t\tc.fetchQueryParam()\n\t\tc.fetchDashboardAndGrafanaQuery()\n\t\tgo func() {\n\t\t\tt := time.NewTicker(60 * time.Minute)\n\t\t\tfor range t.C {\n\t\t\t\tc.fetchQueryParam()\n\t\t\t}\n\t\t}()\n\t\tgo func() {\n\t\t\tt := time.NewTicker(1 * time.Minute)\n\t\t\tfor range t.C {\n\t\t\t\tif exist, err := db.RedisClient().SIsMember(context.Background(), FetchLatestDashboardRedisKey, podName).Result(); err == nil && !exist {\n\t\t\t\t\tc.fetchDashboardAndGrafanaQuery()\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t\tcache = c\n\t})\n\treturn cache\n}",
    "sql_statement_list": [
      "SELECT param_name, grafana_variable_name, from_query, dashboard_id, regex, check_auth FROM t_query_param;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 16,
        "code_end_line": 23,
        "code_key": "GrafanaQueryParam",
        "code_value": "type GrafanaQueryParam struct {\n\tParamName           string `gorm:\"column:param_name\"` // 唯一\n\tGrafanaVariableName string `gorm:\"column:grafana_variable_name\"`\n\tFromQuery           bool   `gorm:\"column:from_query\"`\n\tDashboardId         string `gorm:\"column:dashboard_id\"`\n\tRegex               string `gorm:\"column:regex\"`\n\tCheckAuth           bool   `gorm:\"column:check_auth\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 35,
        "code_end_line": 37,
        "code_key": "TableName",
        "code_value": "func (GrafanaQueryParam) TableName() string {\n\treturn \"t_query_param\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__grafana-gateway.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/cache/cache.go:33:55:fetchQueryParam",
    "orm_code": "func (c *MySQLCache) fetchQueryParam() {\n\tconn, err := db.NewDb()\n\tif err != nil {\n\t\treturn\n\t}\n\tret := make(map[string]*model.GrafanaQueryParam)\n\tif err := conn.Transaction(func(tx *gorm.DB) error {\n\t\tqueries := make([]*model.GrafanaQueryParam, 0)\n\t\tdefer monitor.AddHttpRequestTotal(\"MySQL\")\n\t\tif err := tx.Model(&model.GrafanaQueryParam{}).Find(&queries).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor _, query := range queries {\n\t\t\tret[query.ParamName] = query\n\t\t}\n\t\treturn nil\n\t}); err == nil {\n\t\tc.pLock.Lock()\n\t\tdefer c.pLock.Unlock()\n\t\tc.paramCache = ret\n\t\tlogger.Infof(\"Fetch query param data.\\n\")\n\t}\n}",
    "caller": "func FetchCache(init bool) {\n\tc := GetCache()\n\tif !init {\n\t\t// 强制刷盘\n\t\tdb.RedisClient().SRem(context.Background(), FetchLatestDashboardRedisKey, podName)\n\t\tc.fetchQueryParam()\n\t\tc.fetchDashboardAndGrafanaQuery()\n\t}\n}",
    "sql_statement_list": [
      "SELECT param_name, grafana_variable_name, from_query, dashboard_id, regex, check_auth FROM t_query_param;"
    ],
    "sql_types": [
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 16,
        "code_end_line": 23,
        "code_key": "GrafanaQueryParam",
        "code_value": "type GrafanaQueryParam struct {\n\tParamName           string `gorm:\"column:param_name\"` // 唯一\n\tGrafanaVariableName string `gorm:\"column:grafana_variable_name\"`\n\tFromQuery           bool   `gorm:\"column:from_query\"`\n\tDashboardId         string `gorm:\"column:dashboard_id\"`\n\tRegex               string `gorm:\"column:regex\"`\n\tCheckAuth           bool   `gorm:\"column:check_auth\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 35,
        "code_end_line": 37,
        "code_key": "TableName",
        "code_value": "func (GrafanaQueryParam) TableName() string {\n\treturn \"t_query_param\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__grafana-gateway.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/cache/cache.go:83:120:fetchDashboardAndGrafanaQuery",
    "orm_code": "func (c *MySQLCache) fetchDashboardAndGrafanaQuery() {\n\tc.qLock.Lock()\n\tdefer c.qLock.Unlock()\n\t// double check\n\tif res, err := db.RedisClient().SIsMember(context.Background(), FetchLatestDashboardRedisKey, podName).Result(); err == nil && res {\n\t\treturn\n\t}\n\tconn, err := db.NewDb()\n\tif err != nil {\n\t\treturn\n\t}\n\tdashboardMap := make(map[string]*model.GrafanaDashboard)\n\tgrafanaQueryMap := make(map[string]*model.GrafanaQuery)\n\tif err := conn.Transaction(func(tx *gorm.DB) error {\n\t\tdashboards := make([]*model.GrafanaDashboard, 0)\n\t\tdefer monitor.AddHttpRequestTotal(\"MySQL\")\n\t\tif err := tx.Model(&model.GrafanaDashboard{}).Find(&dashboards).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor _, dashboard := range dashboards {\n\t\t\tdashboardMap[dashboard.DashboardId] = dashboard\n\t\t\tgrafanaQueries := make([]*model.GrafanaQuery, 0)\n\t\t\tif err := tx.Model(&model.GrafanaQuery{}).Where(\"dashboard_version = ? and dashboard_id = ?\", dashboard.CurrentVersion, dashboard.DashboardId).Find(&grafanaQueries).Error; err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\t// (query_id,dashboard_version)是唯一的\n\t\t\tfor _, grafanaQuery := range grafanaQueries {\n\t\t\t\tgrafanaQueryMap[grafanaQuery.QueryId] = grafanaQuery\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t}); err == nil {\n\t\tc.dashBoardCache = dashboardMap\n\t\tc.queryCache = grafanaQueryMap\n\t\tdb.RedisClient().SAdd(context.Background(), FetchLatestDashboardRedisKey, podName)\n\t\tlogger.Infof(\"Fetch grafana dashboard and query param data.\\n\")\n\t}\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT dashboard_id, abbreviation, current_version FROM t_grafana_dashboard;",
      "SELECT query_id, dashboard_id, dashboard_version, datasource_id, query_type, query_text, params, multi_value_param, var_query_name, series_label_name FROM t_grafana_query WHERE dashboard_version = ? AND dashboard_id = ?;"
    ],
    "sql_types": [
      "SELECT",
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 25,
        "code_end_line": 29,
        "code_key": "GrafanaDashboard",
        "code_value": "type GrafanaDashboard struct {\n\tDashboardId    string `gorm:\"column:dashboard_id\"`\n\tAbbreviation   string `gorm:\"column:abbreviation\"`\n\tCurrentVersion int    `gorm:\"column:current_version\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 39,
        "code_end_line": 41,
        "code_key": "TableName",
        "code_value": "func (GrafanaDashboard) TableName() string {\n\treturn \"t_grafana_dashboard\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 3,
        "code_end_line": 14,
        "code_key": "GrafanaQuery",
        "code_value": "type GrafanaQuery struct {\n\tQueryId          string `gorm:\"column:query_id\"`\n\tDashboardId      string `gorm:\"column:dashboard_id\"`\n\tDashboardVersion int    `gorm:\"column:dashboard_version\"` // (query_id, dashboard_version)唯一\n\tDatasourceId     int    `gorm:\"column:datasource_id\"`\n\tQueryType        string `gorm:\"column:query_type\"`\n\tQueryText        string `gorm:\"column:query_text\"`\n\tParams           string `gorm:\"column:params\"`\n\tMultiValueParam  string `gorm:\"column:multi_value_param\"` // 匹配参数的单值还是多值(于Params一一对应, 格式1;1;0)\n\tVarQueryName     string `gorm:\"column:var_query_name\"`    // 如果是grafana参数查询(来自query接口和series接口)，这个参数的名称, 为空则代表不是\n\tSeriesLabelName  string `gorm:\"column:series_label_name\"` // 当为series类型的grafana_variable查询，该查询所要保存的是哪个Label的值(此时VarQueryName一定不为空)\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (GrafanaQuery) TableName() string {\n\treturn \"t_grafana_query\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      }
    ],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__grafana-gateway.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/cache/cache.go:83:120:fetchDashboardAndGrafanaQuery",
    "orm_code": "func (c *MySQLCache) fetchDashboardAndGrafanaQuery() {\n\tc.qLock.Lock()\n\tdefer c.qLock.Unlock()\n\t// double check\n\tif res, err := db.RedisClient().SIsMember(context.Background(), FetchLatestDashboardRedisKey, podName).Result(); err == nil && res {\n\t\treturn\n\t}\n\tconn, err := db.NewDb()\n\tif err != nil {\n\t\treturn\n\t}\n\tdashboardMap := make(map[string]*model.GrafanaDashboard)\n\tgrafanaQueryMap := make(map[string]*model.GrafanaQuery)\n\tif err := conn.Transaction(func(tx *gorm.DB) error {\n\t\tdashboards := make([]*model.GrafanaDashboard, 0)\n\t\tdefer monitor.AddHttpRequestTotal(\"MySQL\")\n\t\tif err := tx.Model(&model.GrafanaDashboard{}).Find(&dashboards).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor _, dashboard := range dashboards {\n\t\t\tdashboardMap[dashboard.DashboardId] = dashboard\n\t\t\tgrafanaQueries := make([]*model.GrafanaQuery, 0)\n\t\t\tif err := tx.Model(&model.GrafanaQuery{}).Where(\"dashboard_version = ? and dashboard_id = ?\", dashboard.CurrentVersion, dashboard.DashboardId).Find(&grafanaQueries).Error; err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\t// (query_id,dashboard_version)是唯一的\n\t\t\tfor _, grafanaQuery := range grafanaQueries {\n\t\t\t\tgrafanaQueryMap[grafanaQuery.QueryId] = grafanaQuery\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t}); err == nil {\n\t\tc.dashBoardCache = dashboardMap\n\t\tc.queryCache = grafanaQueryMap\n\t\tdb.RedisClient().SAdd(context.Background(), FetchLatestDashboardRedisKey, podName)\n\t\tlogger.Infof(\"Fetch grafana dashboard and query param data.\\n\")\n\t}\n}",
    "caller": "func (c *MySQLCache) GetGrafanaQuery(queryId string) *model.GrafanaQuery {\n\tif res := c.getFromQueryCache(queryId); res != nil {\n\t\treturn res\n\t}\n\tc.fetchDashboardAndGrafanaQuery()\n\treturn c.getFromQueryCache(queryId)\n}",
    "sql_statement_list": [
      "SELECT dashboard_id, abbreviation, current_version FROM t_grafana_dashboard;",
      "SELECT query_id, dashboard_id, dashboard_version, datasource_id, query_type, query_text, params, multi_value_param, var_query_name, series_label_name FROM t_grafana_query WHERE dashboard_version = ? AND dashboard_id = ?;"
    ],
    "sql_types": [
      "SELECT",
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 25,
        "code_end_line": 29,
        "code_key": "GrafanaDashboard",
        "code_value": "type GrafanaDashboard struct {\n\tDashboardId    string `gorm:\"column:dashboard_id\"`\n\tAbbreviation   string `gorm:\"column:abbreviation\"`\n\tCurrentVersion int    `gorm:\"column:current_version\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 39,
        "code_end_line": 41,
        "code_key": "TableName",
        "code_value": "func (GrafanaDashboard) TableName() string {\n\treturn \"t_grafana_dashboard\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 3,
        "code_end_line": 14,
        "code_key": "GrafanaQuery",
        "code_value": "type GrafanaQuery struct {\n\tQueryId          string `gorm:\"column:query_id\"`\n\tDashboardId      string `gorm:\"column:dashboard_id\"`\n\tDashboardVersion int    `gorm:\"column:dashboard_version\"` // (query_id, dashboard_version)唯一\n\tDatasourceId     int    `gorm:\"column:datasource_id\"`\n\tQueryType        string `gorm:\"column:query_type\"`\n\tQueryText        string `gorm:\"column:query_text\"`\n\tParams           string `gorm:\"column:params\"`\n\tMultiValueParam  string `gorm:\"column:multi_value_param\"` // 匹配参数的单值还是多值(于Params一一对应, 格式1;1;0)\n\tVarQueryName     string `gorm:\"column:var_query_name\"`    // 如果是grafana参数查询(来自query接口和series接口)，这个参数的名称, 为空则代表不是\n\tSeriesLabelName  string `gorm:\"column:series_label_name\"` // 当为series类型的grafana_variable查询，该查询所要保存的是哪个Label的值(此时VarQueryName一定不为空)\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (GrafanaQuery) TableName() string {\n\treturn \"t_grafana_query\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      }
    ],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__grafana-gateway.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/cache/cache.go:83:120:fetchDashboardAndGrafanaQuery",
    "orm_code": "func (c *MySQLCache) fetchDashboardAndGrafanaQuery() {\n\tc.qLock.Lock()\n\tdefer c.qLock.Unlock()\n\t// double check\n\tif res, err := db.RedisClient().SIsMember(context.Background(), FetchLatestDashboardRedisKey, podName).Result(); err == nil && res {\n\t\treturn\n\t}\n\tconn, err := db.NewDb()\n\tif err != nil {\n\t\treturn\n\t}\n\tdashboardMap := make(map[string]*model.GrafanaDashboard)\n\tgrafanaQueryMap := make(map[string]*model.GrafanaQuery)\n\tif err := conn.Transaction(func(tx *gorm.DB) error {\n\t\tdashboards := make([]*model.GrafanaDashboard, 0)\n\t\tdefer monitor.AddHttpRequestTotal(\"MySQL\")\n\t\tif err := tx.Model(&model.GrafanaDashboard{}).Find(&dashboards).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor _, dashboard := range dashboards {\n\t\t\tdashboardMap[dashboard.DashboardId] = dashboard\n\t\t\tgrafanaQueries := make([]*model.GrafanaQuery, 0)\n\t\t\tif err := tx.Model(&model.GrafanaQuery{}).Where(\"dashboard_version = ? and dashboard_id = ?\", dashboard.CurrentVersion, dashboard.DashboardId).Find(&grafanaQueries).Error; err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\t// (query_id,dashboard_version)是唯一的\n\t\t\tfor _, grafanaQuery := range grafanaQueries {\n\t\t\t\tgrafanaQueryMap[grafanaQuery.QueryId] = grafanaQuery\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t}); err == nil {\n\t\tc.dashBoardCache = dashboardMap\n\t\tc.queryCache = grafanaQueryMap\n\t\tdb.RedisClient().SAdd(context.Background(), FetchLatestDashboardRedisKey, podName)\n\t\tlogger.Infof(\"Fetch grafana dashboard and query param data.\\n\")\n\t}\n}",
    "caller": "func (c *MySQLCache) GetGrafanaDashboard(dashboardId string) *model.GrafanaDashboard {\n\tif res := c.getFromDashboardCache(dashboardId); res != nil {\n\t\treturn res\n\t}\n\tc.fetchDashboardAndGrafanaQuery()\n\treturn c.getFromDashboardCache(dashboardId)\n}",
    "sql_statement_list": [
      "SELECT dashboard_id, abbreviation, current_version FROM t_grafana_dashboard;",
      "SELECT query_id, dashboard_id, dashboard_version, datasource_id, query_type, query_text, params, multi_value_param, var_query_name, series_label_name FROM t_grafana_query WHERE dashboard_version = ? AND dashboard_id = ?;"
    ],
    "sql_types": [
      "SELECT",
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 25,
        "code_end_line": 29,
        "code_key": "GrafanaDashboard",
        "code_value": "type GrafanaDashboard struct {\n\tDashboardId    string `gorm:\"column:dashboard_id\"`\n\tAbbreviation   string `gorm:\"column:abbreviation\"`\n\tCurrentVersion int    `gorm:\"column:current_version\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 39,
        "code_end_line": 41,
        "code_key": "TableName",
        "code_value": "func (GrafanaDashboard) TableName() string {\n\treturn \"t_grafana_dashboard\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 3,
        "code_end_line": 14,
        "code_key": "GrafanaQuery",
        "code_value": "type GrafanaQuery struct {\n\tQueryId          string `gorm:\"column:query_id\"`\n\tDashboardId      string `gorm:\"column:dashboard_id\"`\n\tDashboardVersion int    `gorm:\"column:dashboard_version\"` // (query_id, dashboard_version)唯一\n\tDatasourceId     int    `gorm:\"column:datasource_id\"`\n\tQueryType        string `gorm:\"column:query_type\"`\n\tQueryText        string `gorm:\"column:query_text\"`\n\tParams           string `gorm:\"column:params\"`\n\tMultiValueParam  string `gorm:\"column:multi_value_param\"` // 匹配参数的单值还是多值(于Params一一对应, 格式1;1;0)\n\tVarQueryName     string `gorm:\"column:var_query_name\"`    // 如果是grafana参数查询(来自query接口和series接口)，这个参数的名称, 为空则代表不是\n\tSeriesLabelName  string `gorm:\"column:series_label_name\"` // 当为series类型的grafana_variable查询，该查询所要保存的是哪个Label的值(此时VarQueryName一定不为空)\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (GrafanaQuery) TableName() string {\n\treturn \"t_grafana_query\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      }
    ],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__grafana-gateway.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/cache/cache.go:83:120:fetchDashboardAndGrafanaQuery",
    "orm_code": "func (c *MySQLCache) fetchDashboardAndGrafanaQuery() {\n\tc.qLock.Lock()\n\tdefer c.qLock.Unlock()\n\t// double check\n\tif res, err := db.RedisClient().SIsMember(context.Background(), FetchLatestDashboardRedisKey, podName).Result(); err == nil && res {\n\t\treturn\n\t}\n\tconn, err := db.NewDb()\n\tif err != nil {\n\t\treturn\n\t}\n\tdashboardMap := make(map[string]*model.GrafanaDashboard)\n\tgrafanaQueryMap := make(map[string]*model.GrafanaQuery)\n\tif err := conn.Transaction(func(tx *gorm.DB) error {\n\t\tdashboards := make([]*model.GrafanaDashboard, 0)\n\t\tdefer monitor.AddHttpRequestTotal(\"MySQL\")\n\t\tif err := tx.Model(&model.GrafanaDashboard{}).Find(&dashboards).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor _, dashboard := range dashboards {\n\t\t\tdashboardMap[dashboard.DashboardId] = dashboard\n\t\t\tgrafanaQueries := make([]*model.GrafanaQuery, 0)\n\t\t\tif err := tx.Model(&model.GrafanaQuery{}).Where(\"dashboard_version = ? and dashboard_id = ?\", dashboard.CurrentVersion, dashboard.DashboardId).Find(&grafanaQueries).Error; err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\t// (query_id,dashboard_version)是唯一的\n\t\t\tfor _, grafanaQuery := range grafanaQueries {\n\t\t\t\tgrafanaQueryMap[grafanaQuery.QueryId] = grafanaQuery\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t}); err == nil {\n\t\tc.dashBoardCache = dashboardMap\n\t\tc.queryCache = grafanaQueryMap\n\t\tdb.RedisClient().SAdd(context.Background(), FetchLatestDashboardRedisKey, podName)\n\t\tlogger.Infof(\"Fetch grafana dashboard and query param data.\\n\")\n\t}\n}",
    "caller": "func GetCache() *MySQLCache {\n\tcacheOnce.Do(func() {\n\t\tdb.RedisClient().SRem(context.Background(), FetchLatestDashboardRedisKey, podName) // 确保init cache时能够fetch dashboard and queries\n\t\tc := &MySQLCache{}\n\t\tc.fetchQueryParam()\n\t\tc.fetchDashboardAndGrafanaQuery()\n\t\tgo func() {\n\t\t\tt := time.NewTicker(60 * time.Minute)\n\t\t\tfor range t.C {\n\t\t\t\tc.fetchQueryParam()\n\t\t\t}\n\t\t}()\n\t\tgo func() {\n\t\t\tt := time.NewTicker(1 * time.Minute)\n\t\t\tfor range t.C {\n\t\t\t\tif exist, err := db.RedisClient().SIsMember(context.Background(), FetchLatestDashboardRedisKey, podName).Result(); err == nil && !exist {\n\t\t\t\t\tc.fetchDashboardAndGrafanaQuery()\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t\tcache = c\n\t})\n\treturn cache\n}",
    "sql_statement_list": [
      "SELECT dashboard_id, abbreviation, current_version FROM t_grafana_dashboard;",
      "SELECT query_id, dashboard_id, dashboard_version, datasource_id, query_type, query_text, params, multi_value_param, var_query_name, series_label_name FROM t_grafana_query WHERE dashboard_version = ? AND dashboard_id = ?;"
    ],
    "sql_types": [
      "SELECT",
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 25,
        "code_end_line": 29,
        "code_key": "GrafanaDashboard",
        "code_value": "type GrafanaDashboard struct {\n\tDashboardId    string `gorm:\"column:dashboard_id\"`\n\tAbbreviation   string `gorm:\"column:abbreviation\"`\n\tCurrentVersion int    `gorm:\"column:current_version\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 39,
        "code_end_line": 41,
        "code_key": "TableName",
        "code_value": "func (GrafanaDashboard) TableName() string {\n\treturn \"t_grafana_dashboard\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 3,
        "code_end_line": 14,
        "code_key": "GrafanaQuery",
        "code_value": "type GrafanaQuery struct {\n\tQueryId          string `gorm:\"column:query_id\"`\n\tDashboardId      string `gorm:\"column:dashboard_id\"`\n\tDashboardVersion int    `gorm:\"column:dashboard_version\"` // (query_id, dashboard_version)唯一\n\tDatasourceId     int    `gorm:\"column:datasource_id\"`\n\tQueryType        string `gorm:\"column:query_type\"`\n\tQueryText        string `gorm:\"column:query_text\"`\n\tParams           string `gorm:\"column:params\"`\n\tMultiValueParam  string `gorm:\"column:multi_value_param\"` // 匹配参数的单值还是多值(于Params一一对应, 格式1;1;0)\n\tVarQueryName     string `gorm:\"column:var_query_name\"`    // 如果是grafana参数查询(来自query接口和series接口)，这个参数的名称, 为空则代表不是\n\tSeriesLabelName  string `gorm:\"column:series_label_name\"` // 当为series类型的grafana_variable查询，该查询所要保存的是哪个Label的值(此时VarQueryName一定不为空)\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (GrafanaQuery) TableName() string {\n\treturn \"t_grafana_query\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      }
    ],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__grafana-gateway.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/cache/cache.go:83:120:fetchDashboardAndGrafanaQuery",
    "orm_code": "func (c *MySQLCache) fetchDashboardAndGrafanaQuery() {\n\tc.qLock.Lock()\n\tdefer c.qLock.Unlock()\n\t// double check\n\tif res, err := db.RedisClient().SIsMember(context.Background(), FetchLatestDashboardRedisKey, podName).Result(); err == nil && res {\n\t\treturn\n\t}\n\tconn, err := db.NewDb()\n\tif err != nil {\n\t\treturn\n\t}\n\tdashboardMap := make(map[string]*model.GrafanaDashboard)\n\tgrafanaQueryMap := make(map[string]*model.GrafanaQuery)\n\tif err := conn.Transaction(func(tx *gorm.DB) error {\n\t\tdashboards := make([]*model.GrafanaDashboard, 0)\n\t\tdefer monitor.AddHttpRequestTotal(\"MySQL\")\n\t\tif err := tx.Model(&model.GrafanaDashboard{}).Find(&dashboards).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor _, dashboard := range dashboards {\n\t\t\tdashboardMap[dashboard.DashboardId] = dashboard\n\t\t\tgrafanaQueries := make([]*model.GrafanaQuery, 0)\n\t\t\tif err := tx.Model(&model.GrafanaQuery{}).Where(\"dashboard_version = ? and dashboard_id = ?\", dashboard.CurrentVersion, dashboard.DashboardId).Find(&grafanaQueries).Error; err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\t// (query_id,dashboard_version)是唯一的\n\t\t\tfor _, grafanaQuery := range grafanaQueries {\n\t\t\t\tgrafanaQueryMap[grafanaQuery.QueryId] = grafanaQuery\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t}); err == nil {\n\t\tc.dashBoardCache = dashboardMap\n\t\tc.queryCache = grafanaQueryMap\n\t\tdb.RedisClient().SAdd(context.Background(), FetchLatestDashboardRedisKey, podName)\n\t\tlogger.Infof(\"Fetch grafana dashboard and query param data.\\n\")\n\t}\n}",
    "caller": "func FetchCache(init bool) {\n\tc := GetCache()\n\tif !init {\n\t\t// 强制刷盘\n\t\tdb.RedisClient().SRem(context.Background(), FetchLatestDashboardRedisKey, podName)\n\t\tc.fetchQueryParam()\n\t\tc.fetchDashboardAndGrafanaQuery()\n\t}\n}",
    "sql_statement_list": [
      "SELECT `dashboard_id`,`abbreviation`,`current_version` FROM `t_grafana_dashboard`;",
      "SELECT `query_id`,`dashboard_id`,`dashboard_version`,`datasource_id`,`query_type`,`query_text`,`params`,`multi_value_param`,`var_query_name`,`series_label_name` FROM `t_grafana_query` WHERE dashboard_version = ? AND dashboard_id = ?;"
    ],
    "sql_types": [
      "SELECT",
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 25,
        "code_end_line": 29,
        "code_key": "GrafanaDashboard",
        "code_value": "type GrafanaDashboard struct {\n\tDashboardId    string `gorm:\"column:dashboard_id\"`\n\tAbbreviation   string `gorm:\"column:abbreviation\"`\n\tCurrentVersion int    `gorm:\"column:current_version\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 39,
        "code_end_line": 41,
        "code_key": "TableName",
        "code_value": "func (GrafanaDashboard) TableName() string {\n\treturn \"t_grafana_dashboard\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 3,
        "code_end_line": 14,
        "code_key": "GrafanaQuery",
        "code_value": "type GrafanaQuery struct {\n\tQueryId          string `gorm:\"column:query_id\"`\n\tDashboardId      string `gorm:\"column:dashboard_id\"`\n\tDashboardVersion int    `gorm:\"column:dashboard_version\"` // (query_id, dashboard_version)唯一\n\tDatasourceId     int    `gorm:\"column:datasource_id\"`\n\tQueryType        string `gorm:\"column:query_type\"`\n\tQueryText        string `gorm:\"column:query_text\"`\n\tParams           string `gorm:\"column:params\"`\n\tMultiValueParam  string `gorm:\"column:multi_value_param\"` // 匹配参数的单值还是多值(于Params一一对应, 格式1;1;0)\n\tVarQueryName     string `gorm:\"column:var_query_name\"`    // 如果是grafana参数查询(来自query接口和series接口)，这个参数的名称, 为空则代表不是\n\tSeriesLabelName  string `gorm:\"column:series_label_name\"` // 当为series类型的grafana_variable查询，该查询所要保存的是哪个Label的值(此时VarQueryName一定不为空)\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (GrafanaQuery) TableName() string {\n\treturn \"t_grafana_query\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      }
    ],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__grafana-gateway.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/service/adminResponse.go:91:120:saveGrafanaQueriesToDB",
    "orm_code": "func saveGrafanaQueriesToDB(grafanaQueriesToSave []*model.GrafanaQuery, grafanaDashBoardToSave *model.GrafanaDashboard) error {\n\tstartTime := time.Now()\n\tdefer metricHandleTime(\"saveGrafanaQueriesToDB\", startTime)\n\tdatabase, err := db.NewDb()\n\tif err != nil {\n\t\treturn err\n\t}\n\tif err = database.Transaction(func(tx *gorm.DB) error {\n\t\t// V1.4.0 update param queries\n\t\tparamQueries := getParamsByDashboardID(tx, grafanaDashBoardToSave.DashboardId)\n\t\tfor _, paramQuery := range paramQueries {\n\t\t\tparamQuery.DashboardVersion = grafanaDashBoardToSave.CurrentVersion\n\t\t\tgrafanaQueriesToSave = append(grafanaQueriesToSave, paramQuery)\n\t\t}\n\t\tfor _, grafanaQuery := range grafanaQueriesToSave {\n\t\t\tif err = tx.Model(&model.GrafanaQuery{}).Save(grafanaQuery).Error; err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\tif err = tx.Model(&model.GrafanaDashboard{}).Where(\"dashboard_id = ?\",\n\t\t\tgrafanaDashBoardToSave.DashboardId).Updates(grafanaDashBoardToSave).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn err\n\t}\n\tnoticeUserGrafanaGateway()\n\treturn nil\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT * FROM t_grafana_query WHERE dashboard_id = ?;",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "当记录不存在时执行INSERT",
            "sql": "INSERT INTO t_grafana_query (query_id, dashboard_id, dashboard_version, datasource_id, query_type, query_text, params, multi_value_param, var_query_name, series_label_name) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?);"
          },
          {
            "scenario": "当记录已存在时执行UPDATE",
            "sql": "UPDATE t_grafana_query SET dashboard_id = ?, dashboard_version = ?, datasource_id = ?, query_type = ?, query_text = ?, params = ?, multi_value_param = ?, var_query_name = ?, series_label_name = ? WHERE query_id = ?;"
          }
        ]
      },
      "UPDATE t_grafana_dashboard SET abbreviation = ?, current_version = ? WHERE dashboard_id = ?;"
    ],
    "sql_types": [
      "SELECT",
      "PARAM_DEPENDENT",
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 3,
        "code_end_line": 14,
        "code_key": "GrafanaQuery",
        "code_value": "type GrafanaQuery struct {\n\tQueryId          string `gorm:\"column:query_id\"`\n\tDashboardId      string `gorm:\"column:dashboard_id\"`\n\tDashboardVersion int    `gorm:\"column:dashboard_version\"` // (query_id, dashboard_version)唯一\n\tDatasourceId     int    `gorm:\"column:datasource_id\"`\n\tQueryType        string `gorm:\"column:query_type\"`\n\tQueryText        string `gorm:\"column:query_text\"`\n\tParams           string `gorm:\"column:params\"`\n\tMultiValueParam  string `gorm:\"column:multi_value_param\"` // 匹配参数的单值还是多值(于Params一一对应, 格式1;1;0)\n\tVarQueryName     string `gorm:\"column:var_query_name\"`    // 如果是grafana参数查询(来自query接口和series接口)，这个参数的名称, 为空则代表不是\n\tSeriesLabelName  string `gorm:\"column:series_label_name\"` // 当为series类型的grafana_variable查询，该查询所要保存的是哪个Label的值(此时VarQueryName一定不为空)\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (GrafanaQuery) TableName() string {\n\treturn \"t_grafana_query\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 25,
        "code_end_line": 29,
        "code_key": "GrafanaDashboard",
        "code_value": "type GrafanaDashboard struct {\n\tDashboardId    string `gorm:\"column:dashboard_id\"`\n\tAbbreviation   string `gorm:\"column:abbreviation\"`\n\tCurrentVersion int    `gorm:\"column:current_version\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 39,
        "code_end_line": 41,
        "code_key": "TableName",
        "code_value": "func (GrafanaDashboard) TableName() string {\n\treturn \"t_grafana_dashboard\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      }
    ],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__grafana-gateway.json",
    "matched_keywords": [
      "Transaction",
      "save"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/service/adminResponse.go:91:120:saveGrafanaQueriesToDB",
    "orm_code": "func saveGrafanaQueriesToDB(grafanaQueriesToSave []*model.GrafanaQuery, grafanaDashBoardToSave *model.GrafanaDashboard) error {\n\tstartTime := time.Now()\n\tdefer metricHandleTime(\"saveGrafanaQueriesToDB\", startTime)\n\tdatabase, err := db.NewDb()\n\tif err != nil {\n\t\treturn err\n\t}\n\tif err = database.Transaction(func(tx *gorm.DB) error {\n\t\t// V1.4.0 update param queries\n\t\tparamQueries := getParamsByDashboardID(tx, grafanaDashBoardToSave.DashboardId)\n\t\tfor _, paramQuery := range paramQueries {\n\t\t\tparamQuery.DashboardVersion = grafanaDashBoardToSave.CurrentVersion\n\t\t\tgrafanaQueriesToSave = append(grafanaQueriesToSave, paramQuery)\n\t\t}\n\t\tfor _, grafanaQuery := range grafanaQueriesToSave {\n\t\t\tif err = tx.Model(&model.GrafanaQuery{}).Save(grafanaQuery).Error; err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\tif err = tx.Model(&model.GrafanaDashboard{}).Where(\"dashboard_id = ?\",\n\t\t\tgrafanaDashBoardToSave.DashboardId).Updates(grafanaDashBoardToSave).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn err\n\t}\n\tnoticeUserGrafanaGateway()\n\treturn nil\n}",
    "caller": "func saveGrafanaQueries(response *http.Response) error {\n\tstartTime := time.Now()\n\tdefer metricHandleTime(\"saveGrafanaQueries\", startTime)\n\tresponseBytes, err := readResponseBody(response)\n\tif err != nil {\n\t\treturn err\n\t}\n\tvar responseJsonMap map[string]any\n\tif err := json.Unmarshal(responseBytes, &responseJsonMap); err != nil {\n\t\treturn err\n\t}\n\tdefer writeBackResponseBody(response, responseBytes)\n\t// 确保grafana侧保存成功后，再执行DB save操作\n\tif responseJsonMap[\"status\"].(string) == \"success\" {\n\t\trequestID := response.Request.Header.Get(RequestIDHeader)\n\t\tif value, ok := globalGrafanaQueriesMap.Load(requestID); ok {\n\t\t\tdefer globalGrafanaQueriesMap.Delete(requestID)\n\t\t\tgrafanaQueriesToSave, valid := value.([]*model.GrafanaQuery)\n\t\t\tdashboardId := responseJsonMap[\"uid\"].(string)\n\t\t\tif !valid {\n\t\t\t\treturn errors.New(fmt.Sprintf(\"can not transform grafana queries to slice of GrafanaQuery\"))\n\t\t\t}\n\t\t\tcurrentVersion := getPositiveIntegerFromJsonMap(responseJsonMap, \"version\")\n\t\t\tif currentVersion == -1 {\n\t\t\t\treturn errors.New(\"can not get target version in response json map\")\n\t\t\t}\n\t\t\tgrafanaDashBoardToSave := &model.GrafanaDashboard{\n\t\t\t\tDashboardId:    dashboardId,\n\t\t\t\tCurrentVersion: currentVersion,\n\t\t\t}\n\t\t\tfor _, grafanaQuery := range grafanaQueriesToSave {\n\t\t\t\tgrafanaQuery.DashboardVersion = grafanaDashBoardToSave.CurrentVersion\n\t\t\t}\n\t\t\tif err := saveGrafanaQueriesToDB(grafanaQueriesToSave, grafanaDashBoardToSave); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tlogger.Infof(\"RequestID: %s, save grafanaQueries and dashboard to database success.\\n\", requestID)\n\t\t\treturn nil\n\t\t} else {\n\t\t\treturn errors.New(fmt.Sprintf(\"can not find grafana queries in global map of requestID %s\", requestID))\n\t\t}\n\t}\n\tcache.FetchCache(false)\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT query_id, dashboard_id, dashboard_version, datasource_id, query_type, query_text, params, multi_value_param, var_query_name, series_label_name FROM t_grafana_query WHERE dashboard_id = ?;",
      "INSERT INTO t_grafana_query (query_id, dashboard_id, dashboard_version, datasource_id, query_type, query_text, params, multi_value_param, var_query_name, series_label_name) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?);",
      "UPDATE t_grafana_dashboard SET current_version = ? WHERE dashboard_id = ?;"
    ],
    "sql_types": [
      "SELECT",
      "INSERT",
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 3,
        "code_end_line": 14,
        "code_key": "GrafanaQuery",
        "code_value": "type GrafanaQuery struct {\n\tQueryId          string `gorm:\"column:query_id\"`\n\tDashboardId      string `gorm:\"column:dashboard_id\"`\n\tDashboardVersion int    `gorm:\"column:dashboard_version\"` // (query_id, dashboard_version)唯一\n\tDatasourceId     int    `gorm:\"column:datasource_id\"`\n\tQueryType        string `gorm:\"column:query_type\"`\n\tQueryText        string `gorm:\"column:query_text\"`\n\tParams           string `gorm:\"column:params\"`\n\tMultiValueParam  string `gorm:\"column:multi_value_param\"` // 匹配参数的单值还是多值(于Params一一对应, 格式1;1;0)\n\tVarQueryName     string `gorm:\"column:var_query_name\"`    // 如果是grafana参数查询(来自query接口和series接口)，这个参数的名称, 为空则代表不是\n\tSeriesLabelName  string `gorm:\"column:series_label_name\"` // 当为series类型的grafana_variable查询，该查询所要保存的是哪个Label的值(此时VarQueryName一定不为空)\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (GrafanaQuery) TableName() string {\n\treturn \"t_grafana_query\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 25,
        "code_end_line": 29,
        "code_key": "GrafanaDashboard",
        "code_value": "type GrafanaDashboard struct {\n\tDashboardId    string `gorm:\"column:dashboard_id\"`\n\tAbbreviation   string `gorm:\"column:abbreviation\"`\n\tCurrentVersion int    `gorm:\"column:current_version\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 39,
        "code_end_line": 41,
        "code_key": "TableName",
        "code_value": "func (GrafanaDashboard) TableName() string {\n\treturn \"t_grafana_dashboard\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      }
    ],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__grafana-gateway.json",
    "matched_keywords": [
      "Transaction",
      "save"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/service/adminResponse.go:157:199:doRestoreGrafanaDashboardToDB",
    "orm_code": "func doRestoreGrafanaDashboardToDB(restoreVersion int, responseJsonMap map[string]any) error {\n\tstartTime := time.Now()\n\tdefer metricHandleTime(\"doRestoreGrafanaDashboardToDB\", startTime)\n\tdashBoardId := responseJsonMap[\"uid\"].(string)\n\ttargetVersion := getPositiveIntegerFromJsonMap(responseJsonMap, \"version\")\n\tif targetVersion == -1 {\n\t\treturn errors.New(fmt.Sprintf(\"can not get target version in response json map\"))\n\t}\n\tgrafanaDashboard, err := getGrafanaDashboardById(dashBoardId)\n\t// restore不可能是新面板\n\tif err != nil || grafanaDashboard == nil {\n\t\treturn errors.New(fmt.Sprintf(\"can not find grafana dashboard, err: %s\", err.Error()))\n\t}\n\tgrafanaDashboard.CurrentVersion = targetVersion\n\tdatabase, err := db.NewDb()\n\tif err != nil {\n\t\treturn err\n\t}\n\tif err := database.Transaction(func(tx *gorm.DB) error {\n\t\trollbackQueries := make([]*model.GrafanaQuery, 0)\n\t\t// param也同时restore\n\t\tif err := tx.Model(&model.GrafanaQuery{}).Where(\"dashboard_id = ? and dashboard_version = ?\",\n\t\t\tgrafanaDashboard.DashboardId, restoreVersion).Find(&rollbackQueries).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor _, rq := range rollbackQueries {\n\t\t\trq.DashboardVersion = targetVersion\n\t\t\tif err := tx.Model(&model.GrafanaQuery{}).Save(rq).Error; err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\tif err := tx.Model(&model.GrafanaDashboard{}).Where(\"dashboard_id = ?\",\n\t\t\tgrafanaDashboard.DashboardId).Updates(grafanaDashboard).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn err\n\t}\n\tlogger.Infof(\"Rollback dashboard success, rollback version: %d, target version: %d\", restoreVersion, targetVersion)\n\tnoticeUserGrafanaGateway()\n\treturn nil\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT query_id, dashboard_id, dashboard_version, datasource_id, query_type, query_text, params, multi_value_param, var_query_name, series_label_name FROM t_grafana_query WHERE dashboard_id = ? AND dashboard_version = ?;",
      "UPDATE t_grafana_query SET query_id=?, dashboard_id=?, dashboard_version=?, datasource_id=?, query_type=?, query_text=?, params=?, multi_value_param=?, var_query_name=?, series_label_name=? WHERE query_id = ?;",
      "UPDATE t_grafana_dashboard SET dashboard_id=?, abbreviation=?, current_version=? WHERE dashboard_id = ?;"
    ],
    "sql_types": [
      "SELECT",
      "UPDATE",
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 3,
        "code_end_line": 14,
        "code_key": "GrafanaQuery",
        "code_value": "type GrafanaQuery struct {\n\tQueryId          string `gorm:\"column:query_id\"`\n\tDashboardId      string `gorm:\"column:dashboard_id\"`\n\tDashboardVersion int    `gorm:\"column:dashboard_version\"` // (query_id, dashboard_version)唯一\n\tDatasourceId     int    `gorm:\"column:datasource_id\"`\n\tQueryType        string `gorm:\"column:query_type\"`\n\tQueryText        string `gorm:\"column:query_text\"`\n\tParams           string `gorm:\"column:params\"`\n\tMultiValueParam  string `gorm:\"column:multi_value_param\"` // 匹配参数的单值还是多值(于Params一一对应, 格式1;1;0)\n\tVarQueryName     string `gorm:\"column:var_query_name\"`    // 如果是grafana参数查询(来自query接口和series接口)，这个参数的名称, 为空则代表不是\n\tSeriesLabelName  string `gorm:\"column:series_label_name\"` // 当为series类型的grafana_variable查询，该查询所要保存的是哪个Label的值(此时VarQueryName一定不为空)\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (GrafanaQuery) TableName() string {\n\treturn \"t_grafana_query\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 25,
        "code_end_line": 29,
        "code_key": "GrafanaDashboard",
        "code_value": "type GrafanaDashboard struct {\n\tDashboardId    string `gorm:\"column:dashboard_id\"`\n\tAbbreviation   string `gorm:\"column:abbreviation\"`\n\tCurrentVersion int    `gorm:\"column:current_version\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 39,
        "code_end_line": 41,
        "code_key": "TableName",
        "code_value": "func (GrafanaDashboard) TableName() string {\n\treturn \"t_grafana_dashboard\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__grafana-gateway.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/service/adminResponse.go:157:199:doRestoreGrafanaDashboardToDB",
    "orm_code": "func doRestoreGrafanaDashboardToDB(restoreVersion int, responseJsonMap map[string]any) error {\n\tstartTime := time.Now()\n\tdefer metricHandleTime(\"doRestoreGrafanaDashboardToDB\", startTime)\n\tdashBoardId := responseJsonMap[\"uid\"].(string)\n\ttargetVersion := getPositiveIntegerFromJsonMap(responseJsonMap, \"version\")\n\tif targetVersion == -1 {\n\t\treturn errors.New(fmt.Sprintf(\"can not get target version in response json map\"))\n\t}\n\tgrafanaDashboard, err := getGrafanaDashboardById(dashBoardId)\n\t// restore不可能是新面板\n\tif err != nil || grafanaDashboard == nil {\n\t\treturn errors.New(fmt.Sprintf(\"can not find grafana dashboard, err: %s\", err.Error()))\n\t}\n\tgrafanaDashboard.CurrentVersion = targetVersion\n\tdatabase, err := db.NewDb()\n\tif err != nil {\n\t\treturn err\n\t}\n\tif err := database.Transaction(func(tx *gorm.DB) error {\n\t\trollbackQueries := make([]*model.GrafanaQuery, 0)\n\t\t// param也同时restore\n\t\tif err := tx.Model(&model.GrafanaQuery{}).Where(\"dashboard_id = ? and dashboard_version = ?\",\n\t\t\tgrafanaDashboard.DashboardId, restoreVersion).Find(&rollbackQueries).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor _, rq := range rollbackQueries {\n\t\t\trq.DashboardVersion = targetVersion\n\t\t\tif err := tx.Model(&model.GrafanaQuery{}).Save(rq).Error; err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\tif err := tx.Model(&model.GrafanaDashboard{}).Where(\"dashboard_id = ?\",\n\t\t\tgrafanaDashboard.DashboardId).Updates(grafanaDashboard).Error; err != nil {\n\t\t\treturn err\n\t\t}\n\t\treturn nil\n\t}); err != nil {\n\t\treturn err\n\t}\n\tlogger.Infof(\"Rollback dashboard success, rollback version: %d, target version: %d\", restoreVersion, targetVersion)\n\tnoticeUserGrafanaGateway()\n\treturn nil\n}",
    "caller": "func restoreGrafanaDashboard(response *http.Response) error {\n\tstartTime := time.Now()\n\tdefer metricHandleTime(\"restoreGrafanaDashboard\", startTime)\n\tresponseBytes, err := readResponseBody(response)\n\tif err != nil {\n\t\treturn err\n\t}\n\tvar responseJsonMap map[string]any\n\tif err := json.Unmarshal(responseBytes, &responseJsonMap); err != nil {\n\t\treturn err\n\t}\n\tdefer writeBackResponseBody(response, responseBytes)\n\t// grafana restore 逻辑：会生成一个新的版本号,该版本的配置由待回滚的版本复制而来\n\trestoreVersion := response.Request.Header.Get(restoreVersionHeader)\n\tif restoreVersionNumber, err := strconv.Atoi(restoreVersion); err != nil {\n\t\treturn errors.New(fmt.Sprintf(\"invalid restore version found in request header 'X-Restore-Version': %s\", restoreVersion))\n\t} else if err := doRestoreGrafanaDashboardToDB(restoreVersionNumber, responseJsonMap); err != nil {\n\t\treturn err\n\t}\n\tcache.FetchCache(false)\n\treturn nil\n}",
    "sql_statement_list": [
      "SELECT query_id, dashboard_id, dashboard_version, datasource_id, query_type, query_text, params, multi_value_param, var_query_name, series_label_name FROM t_grafana_query WHERE dashboard_id = ? AND dashboard_version = ?;",
      "UPDATE t_grafana_query SET query_id = ?, dashboard_id = ?, dashboard_version = ?, datasource_id = ?, query_type = ?, query_text = ?, params = ?, multi_value_param = ?, var_query_name = ?, series_label_name = ? WHERE query_id = ? AND dashboard_version = ?;",
      "UPDATE t_grafana_dashboard SET abbreviation = ?, current_version = ? WHERE dashboard_id = ?;"
    ],
    "sql_types": [
      "SELECT",
      "UPDATE",
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 3,
        "code_end_line": 14,
        "code_key": "GrafanaQuery",
        "code_value": "type GrafanaQuery struct {\n\tQueryId          string `gorm:\"column:query_id\"`\n\tDashboardId      string `gorm:\"column:dashboard_id\"`\n\tDashboardVersion int    `gorm:\"column:dashboard_version\"` // (query_id, dashboard_version)唯一\n\tDatasourceId     int    `gorm:\"column:datasource_id\"`\n\tQueryType        string `gorm:\"column:query_type\"`\n\tQueryText        string `gorm:\"column:query_text\"`\n\tParams           string `gorm:\"column:params\"`\n\tMultiValueParam  string `gorm:\"column:multi_value_param\"` // 匹配参数的单值还是多值(于Params一一对应, 格式1;1;0)\n\tVarQueryName     string `gorm:\"column:var_query_name\"`    // 如果是grafana参数查询(来自query接口和series接口)，这个参数的名称, 为空则代表不是\n\tSeriesLabelName  string `gorm:\"column:series_label_name\"` // 当为series类型的grafana_variable查询，该查询所要保存的是哪个Label的值(此时VarQueryName一定不为空)\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (GrafanaQuery) TableName() string {\n\treturn \"t_grafana_query\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 25,
        "code_end_line": 29,
        "code_key": "GrafanaDashboard",
        "code_value": "type GrafanaDashboard struct {\n\tDashboardId    string `gorm:\"column:dashboard_id\"`\n\tAbbreviation   string `gorm:\"column:abbreviation\"`\n\tCurrentVersion int    `gorm:\"column:current_version\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/KAMP__grafana-gateway/pkg/model/model.go",
        "code_start_line": 39,
        "code_end_line": 41,
        "code_key": "TableName",
        "code_value": "func (GrafanaDashboard) TableName() string {\n\treturn \"t_grafana_dashboard\"\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "06a7792aa6c293c8b02f754cda592ffbdaa3af62"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/KAMP__grafana-gateway.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__dbjoin/pkg/table.go:277:328:update",
    "orm_code": "func (t *Table) update(rows []Row, updateChangeMap []map[string]interface{}, batchSize, updateConcurrence int) error {\n\tupdate := func(s, e int) error {\n\t\treturn t.db.Transaction(func(tx *gorm.DB) error {\n\t\t\tfor index := s; index < e; index++ {\n\t\t\t\t//updateMap := make(map[string]interface{})\n\t\t\t\t//for k, v := range rows[index] {\n\t\t\t\t//\tupdateMap[k] = v\n\t\t\t\t//}\n\t\t\t\tklog.Infof(\"update map:%v wehre:%s\", updateChangeMap[index], rows[index].WhereString(t.UniqColumes))\n\t\t\t\tif err := tx.Table(t.TableName).Where(rows[index].WhereString(t.UniqColumes)).\n\t\t\t\t\tUpdates(updateChangeMap[index]).Error; err != nil {\n\t\t\t\t\tklog.Infof(\"err:%v\\n\", err)\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn nil\n\t\t})\n\t}\n\tvar rowsAffected int\n\tch := make(chan [2]int, updateConcurrence)\n\tvar latestErr error\n\twg := sync.WaitGroup{}\n\tfor i := 0; i < updateConcurrence; i++ {\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tdefer wg.Done()\n\t\t\tfor {\n\t\t\t\tselect {\n\t\t\t\tcase t := <-ch:\n\t\t\t\t\tif err := update(t[0], t[1]); err != nil {\n\t\t\t\t\t\tlatestErr = err\n\t\t\t\t\t} else {\n\t\t\t\t\t\trowsAffected += t[1] - t[0]\n\t\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t}\n\tfor i := 0; i < len(rows); i += batchSize {\n\t\ts := i\n\t\te := i + batchSize\n\t\tif e > len(rows) {\n\t\t\te = len(rows)\n\t\t}\n\t\tch <- [2]int{s, e}\n\t}\n\twg.Wait()\n\treturn latestErr\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "单字段唯一键",
            "sql": "UPDATE table_name SET column1 = ? WHERE unique_col = ?;"
          },
          {
            "scenario": "双字段复合唯一键",
            "sql": "UPDATE table_name SET column1 = ? WHERE unique_col1 = ? AND unique_col2 = ?;"
          },
          {
            "scenario": "三字段复合唯一键",
            "sql": "UPDATE table_name SET column1 = ? WHERE unique_col1 = ? AND unique_col2 = ? AND unique_col3 = ?;"
          },
          {
            "scenario": "四字段或更多复合唯一键",
            "sql": "UPDATE table_name SET column1 = ? WHERE unique_col1 = ? AND unique_col2 = ? AND unique_col3 = ? AND unique_col4 = ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__dbjoin/pkg/table.go",
        "code_start_line": 87,
        "code_end_line": 97,
        "code_key": "Table",
        "code_value": "type Table struct {\n\tName        string   `json:\"name\"`\n\tTableName   string   `json:\"tableName\"`\n\tColumns     []string `json:\"columns\"`\n\tUniqColumes []string `json:\"unique_key\"`\n\tRowSql      string   `json:\"rowSql\"`\n\tWhere       string   `json:\"where\"`\n\tdata        []Row    `json:\"-\"`\n\tdb          *gorm.DB `json:\"-\"`\n\tloadTime    time.Time\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "33069d36d98b86d42c800d29503dc22a301ba3a1"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__dbjoin/pkg/table.go",
        "code_start_line": 13,
        "code_end_line": 13,
        "code_key": "Row",
        "code_value": "type Row map[string]interface{}",
        "code_label": null,
        "code_type": 3,
        "code_version": "33069d36d98b86d42c800d29503dc22a301ba3a1"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__dbjoin.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__dbjoin/pkg/table.go:277:328:update",
    "orm_code": "func (t *Table) update(rows []Row, updateChangeMap []map[string]interface{}, batchSize, updateConcurrence int) error {\n\tupdate := func(s, e int) error {\n\t\treturn t.db.Transaction(func(tx *gorm.DB) error {\n\t\t\tfor index := s; index < e; index++ {\n\t\t\t\t//updateMap := make(map[string]interface{})\n\t\t\t\t//for k, v := range rows[index] {\n\t\t\t\t//\tupdateMap[k] = v\n\t\t\t\t//}\n\t\t\t\tklog.Infof(\"update map:%v wehre:%s\", updateChangeMap[index], rows[index].WhereString(t.UniqColumes))\n\t\t\t\tif err := tx.Table(t.TableName).Where(rows[index].WhereString(t.UniqColumes)).\n\t\t\t\t\tUpdates(updateChangeMap[index]).Error; err != nil {\n\t\t\t\t\tklog.Infof(\"err:%v\\n\", err)\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn nil\n\t\t})\n\t}\n\tvar rowsAffected int\n\tch := make(chan [2]int, updateConcurrence)\n\tvar latestErr error\n\twg := sync.WaitGroup{}\n\tfor i := 0; i < updateConcurrence; i++ {\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tdefer wg.Done()\n\t\t\tfor {\n\t\t\t\tselect {\n\t\t\t\tcase t := <-ch:\n\t\t\t\t\tif err := update(t[0], t[1]); err != nil {\n\t\t\t\t\t\tlatestErr = err\n\t\t\t\t\t} else {\n\t\t\t\t\t\trowsAffected += t[1] - t[0]\n\t\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t}\n\tfor i := 0; i < len(rows); i += batchSize {\n\t\ts := i\n\t\te := i + batchSize\n\t\tif e > len(rows) {\n\t\t\te = len(rows)\n\t\t}\n\t\tch <- [2]int{s, e}\n\t}\n\twg.Wait()\n\treturn latestErr\n}",
    "caller": "func (t *Table) update(rows []Row, updateChangeMap []map[string]interface{}, batchSize, updateConcurrence int) error {\n\tupdate := func(s, e int) error {\n\t\treturn t.db.Transaction(func(tx *gorm.DB) error {\n\t\t\tfor index := s; index < e; index++ {\n\t\t\t\t//updateMap := make(map[string]interface{})\n\t\t\t\t//for k, v := range rows[index] {\n\t\t\t\t//\tupdateMap[k] = v\n\t\t\t\t//}\n\t\t\t\tklog.Infof(\"update map:%v wehre:%s\", updateChangeMap[index], rows[index].WhereString(t.UniqColumes))\n\t\t\t\tif err := tx.Table(t.TableName).Where(rows[index].WhereString(t.UniqColumes)).\n\t\t\t\t\tUpdates(updateChangeMap[index]).Error; err != nil {\n\t\t\t\t\tklog.Infof(\"err:%v\\n\", err)\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn nil\n\t\t})\n\t}\n\tvar rowsAffected int\n\tch := make(chan [2]int, updateConcurrence)\n\tvar latestErr error\n\twg := sync.WaitGroup{}\n\tfor i := 0; i < updateConcurrence; i++ {\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tdefer wg.Done()\n\t\t\tfor {\n\t\t\t\tselect {\n\t\t\t\tcase t := <-ch:\n\t\t\t\t\tif err := update(t[0], t[1]); err != nil {\n\t\t\t\t\t\tlatestErr = err\n\t\t\t\t\t} else {\n\t\t\t\t\t\trowsAffected += t[1] - t[0]\n\t\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t}\n\tfor i := 0; i < len(rows); i += batchSize {\n\t\ts := i\n\t\te := i + batchSize\n\t\tif e > len(rows) {\n\t\t\te = len(rows)\n\t\t}\n\t\tch <- [2]int{s, e}\n\t}\n\twg.Wait()\n\treturn latestErr\n}",
    "sql_statement_list": [
      "BEGIN;",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "单字段更新单条件",
            "sql": "UPDATE {table_name} SET field1 = ? WHERE unique_col = ?;"
          },
          {
            "scenario": "多字段更新单条件",
            "sql": "UPDATE {table_name} SET field1 = ?, field2 = ?, field3 = ? WHERE unique_col = ?;"
          },
          {
            "scenario": "单字段更新多条件",
            "sql": "UPDATE {table_name} SET field1 = ? WHERE unique_col1 = ? AND unique_col2 = ?;"
          },
          {
            "scenario": "多字段更新多条件",
            "sql": "UPDATE {table_name} SET field1 = ?, field2 = ?, field3 = ? WHERE unique_col1 = ? AND unique_col2 = ? AND unique_col3 = ?;"
          }
        ]
      },
      "COMMIT;"
    ],
    "sql_types": [
      "OTHER",
      "PARAM_DEPENDENT",
      "OTHER"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__dbjoin/pkg/table.go",
        "code_start_line": 87,
        "code_end_line": 97,
        "code_key": "Table",
        "code_value": "type Table struct {\n\tName        string   `json:\"name\"`\n\tTableName   string   `json:\"tableName\"`\n\tColumns     []string `json:\"columns\"`\n\tUniqColumes []string `json:\"unique_key\"`\n\tRowSql      string   `json:\"rowSql\"`\n\tWhere       string   `json:\"where\"`\n\tdata        []Row    `json:\"-\"`\n\tdb          *gorm.DB `json:\"-\"`\n\tloadTime    time.Time\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "33069d36d98b86d42c800d29503dc22a301ba3a1"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__dbjoin/pkg/table.go",
        "code_start_line": 13,
        "code_end_line": 13,
        "code_key": "Row",
        "code_value": "type Row map[string]interface{}",
        "code_label": null,
        "code_type": 3,
        "code_version": "33069d36d98b86d42c800d29503dc22a301ba3a1"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__dbjoin.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__dbjoin/pkg/table.go:277:328:update",
    "orm_code": "func (t *Table) update(rows []Row, updateChangeMap []map[string]interface{}, batchSize, updateConcurrence int) error {\n\tupdate := func(s, e int) error {\n\t\treturn t.db.Transaction(func(tx *gorm.DB) error {\n\t\t\tfor index := s; index < e; index++ {\n\t\t\t\t//updateMap := make(map[string]interface{})\n\t\t\t\t//for k, v := range rows[index] {\n\t\t\t\t//\tupdateMap[k] = v\n\t\t\t\t//}\n\t\t\t\tklog.Infof(\"update map:%v wehre:%s\", updateChangeMap[index], rows[index].WhereString(t.UniqColumes))\n\t\t\t\tif err := tx.Table(t.TableName).Where(rows[index].WhereString(t.UniqColumes)).\n\t\t\t\t\tUpdates(updateChangeMap[index]).Error; err != nil {\n\t\t\t\t\tklog.Infof(\"err:%v\\n\", err)\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn nil\n\t\t})\n\t}\n\tvar rowsAffected int\n\tch := make(chan [2]int, updateConcurrence)\n\tvar latestErr error\n\twg := sync.WaitGroup{}\n\tfor i := 0; i < updateConcurrence; i++ {\n\t\twg.Add(1)\n\t\tgo func() {\n\t\t\tdefer wg.Done()\n\t\t\tfor {\n\t\t\t\tselect {\n\t\t\t\tcase t := <-ch:\n\t\t\t\t\tif err := update(t[0], t[1]); err != nil {\n\t\t\t\t\t\tlatestErr = err\n\t\t\t\t\t} else {\n\t\t\t\t\t\trowsAffected += t[1] - t[0]\n\t\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t}\n\tfor i := 0; i < len(rows); i += batchSize {\n\t\ts := i\n\t\te := i + batchSize\n\t\tif e > len(rows) {\n\t\t\te = len(rows)\n\t\t}\n\t\tch <- [2]int{s, e}\n\t}\n\twg.Wait()\n\treturn latestErr\n}",
    "caller": "func (t *Table) UpdateTable(data []Row) error {\n\t//t.LoadAllColumns()\n\tt.Load(0)\n\tadds, updates, deletes, updateChangeMap := getDiff(t.data, data, t.UniqColumes)\n\tklog.Infof(\"UpdateTable %s adds:%d, updates:%d, deletes:%d\\n\", t.TableName, len(adds), len(updates), len(deletes))\n\tif errAdd := t.Insert(adds); errAdd != nil {\n\t\treturn errAdd\n\t}\n\tif errUpdate := t.update(updates, updateChangeMap, 100, 10); errUpdate != nil {\n\t\treturn errUpdate\n\t}\n\treturn t.Delete(deletes)\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "单行更新场景",
            "sql": "BEGIN; UPDATE table_name SET column1 = ?, column2 = ? WHERE unique_column1 = ? AND unique_column2 = ?; COMMIT;"
          },
          {
            "scenario": "多行更新场景",
            "sql": "BEGIN; UPDATE table_name SET column1 = ?, column2 = ? WHERE unique_column1 = ? AND unique_column2 = ?; UPDATE table_name SET column3 = ?, column4 = ? WHERE unique_column1 = ? AND unique_column2 = ?; UPDATE table_name SET column5 = ?, column6 = ? WHERE unique_column1 = ? AND unique_column2 = ?; COMMIT;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__dbjoin/pkg/table.go",
        "code_start_line": 87,
        "code_end_line": 97,
        "code_key": "Table",
        "code_value": "type Table struct {\n\tName        string   `json:\"name\"`\n\tTableName   string   `json:\"tableName\"`\n\tColumns     []string `json:\"columns\"`\n\tUniqColumes []string `json:\"unique_key\"`\n\tRowSql      string   `json:\"rowSql\"`\n\tWhere       string   `json:\"where\"`\n\tdata        []Row    `json:\"-\"`\n\tdb          *gorm.DB `json:\"-\"`\n\tloadTime    time.Time\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "33069d36d98b86d42c800d29503dc22a301ba3a1"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__dbjoin/pkg/table.go",
        "code_start_line": 13,
        "code_end_line": 13,
        "code_key": "Row",
        "code_value": "type Row map[string]interface{}",
        "code_label": null,
        "code_type": 3,
        "code_version": "33069d36d98b86d42c800d29503dc22a301ba3a1"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__dbjoin.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_delete.go:9:15:init",
    "orm_code": "func init() {\n\tDefaultCallback.Delete().Register(\"gorm:begin_transaction\", beginTransactionCallback)\n\tDefaultCallback.Delete().Register(\"gorm:before_delete\", beforeDeleteCallback)\n\tDefaultCallback.Delete().Register(\"gorm:delete\", deleteCallback)\n\tDefaultCallback.Delete().Register(\"gorm:after_delete\", afterDeleteCallback)\n\tDefaultCallback.Delete().Register(\"gorm:commit_or_rollback_transaction\", commitOrRollbackTransactionCallback)\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 5,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_update.go:11:21:init",
    "orm_code": "func init() {\n\tDefaultCallback.Update().Register(\"gorm:assign_updating_attributes\", assignUpdatingAttributesCallback)\n\tDefaultCallback.Update().Register(\"gorm:begin_transaction\", beginTransactionCallback)\n\tDefaultCallback.Update().Register(\"gorm:before_update\", beforeUpdateCallback)\n\tDefaultCallback.Update().Register(\"gorm:save_before_associations\", saveBeforeAssociationsCallback)\n\tDefaultCallback.Update().Register(\"gorm:update_time_stamp\", updateTimeStampForUpdateCallback)\n\tDefaultCallback.Update().Register(\"gorm:update\", updateCallback)\n\tDefaultCallback.Update().Register(\"gorm:save_after_associations\", saveAfterAssociationsCallback)\n\tDefaultCallback.Update().Register(\"gorm:after_update\", afterUpdateCallback)\n\tDefaultCallback.Update().Register(\"gorm:commit_or_rollback_transaction\", commitOrRollbackTransactionCallback)\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 9,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction",
      "Association",
      "save"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_create.go:9:19:init",
    "orm_code": "func init() {\n\tDefaultCallback.Create().Register(\"gorm:begin_transaction\", beginTransactionCallback)\n\tDefaultCallback.Create().Register(\"gorm:before_create\", beforeCreateCallback)\n\tDefaultCallback.Create().Register(\"gorm:save_before_associations\", saveBeforeAssociationsCallback)\n\tDefaultCallback.Create().Register(\"gorm:update_time_stamp\", updateTimeStampForCreateCallback)\n\tDefaultCallback.Create().Register(\"gorm:create\", createCallback)\n\tDefaultCallback.Create().Register(\"gorm:force_reload_after_create\", forceReloadAfterCreateCallback)\n\tDefaultCallback.Create().Register(\"gorm:save_after_associations\", saveAfterAssociationsCallback)\n\tDefaultCallback.Create().Register(\"gorm:after_create\", afterCreateCallback)\n\tDefaultCallback.Create().Register(\"gorm:commit_or_rollback_transaction\", commitOrRollbackTransactionCallback)\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 9,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction",
      "Association",
      "save"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go:8:10:beginTransactionCallback",
    "orm_code": "func beginTransactionCallback(scope *Scope) {\n\tscope.Begin()\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 16,
        "code_end_line": 27,
        "code_key": "Scope",
        "code_value": "type Scope struct {\n\tSearch          *search\n\tValue           interface{}\n\tSQL             string\n\tSQLVars         []interface{}\n\tdb              *DB\n\tinstanceID      string\n\tprimaryKeyField *Field\n\tskipLeft        bool\n\tfields          *[]*Field\n\tselectAttrs     *[]string\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 314,
        "code_end_line": 328,
        "code_key": "TableName",
        "code_value": "func (scope *Scope) TableName() string {\n\tif scope.Search != nil && len(scope.Search.tableName) > 0 {\n\t\treturn scope.Search.tableName\n\t}\n\n\tif tabler, ok := scope.Value.(tabler); ok {\n\t\treturn tabler.TableName()\n\t}\n\n\tif tabler, ok := scope.Value.(dbTabler); ok {\n\t\treturn tabler.TableName(scope.db)\n\t}\n\n\treturn scope.GetModelStruct().TableName(scope.db.Model(scope.Value))\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/join_table_handler.go",
        "code_start_line": 87,
        "code_end_line": 87,
        "code_key": "scope",
        "code_value": "scope := db.NewScope(source)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/join_table_handler.go",
        "code_start_line": 106,
        "code_end_line": 106,
        "code_key": "scope",
        "code_value": "var scope        = db.NewScope(\"\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/join_table_handler.go",
        "code_start_line": 146,
        "code_end_line": 146,
        "code_key": "scope",
        "code_value": "var scope        = db.NewScope(nil)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/join_table_handler.go",
        "code_start_line": 165,
        "code_end_line": 165,
        "code_key": "scope",
        "code_value": "var scope           = db.NewScope(source)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/association.go",
        "code_start_line": 43,
        "code_end_line": 43,
        "code_key": "scope",
        "code_value": "var scope        = association.scope",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/association.go",
        "code_start_line": 137,
        "code_end_line": 137,
        "code_key": "scope",
        "code_value": "var scope        = association.scope",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/association.go",
        "code_start_line": 265,
        "code_end_line": 265,
        "code_key": "scope",
        "code_value": "var scope        = association.scope",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/association.go",
        "code_start_line": 303,
        "code_end_line": 303,
        "code_key": "scope",
        "code_value": "var scope        = association.scope",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 209,
        "code_end_line": 209,
        "code_key": "scope",
        "code_value": "scope := &Scope{db: dbClone, Value: value}",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 220,
        "code_end_line": 220,
        "code_key": "scope",
        "code_value": "scope := s.NewScope(s.Value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 229,
        "code_end_line": 229,
        "code_key": "scope",
        "code_value": "scope := s.NewScope(s.Value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 383,
        "code_end_line": 383,
        "code_key": "scope",
        "code_value": "var scope        = s.NewScope(result)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 472,
        "code_end_line": 472,
        "code_key": "scope",
        "code_value": "scope := s.NewScope(value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 485,
        "code_end_line": 485,
        "code_key": "scope",
        "code_value": "scope := s.NewScope(value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 503,
        "code_end_line": 503,
        "code_key": "scope",
        "code_value": "scope := s.NewScope(nil)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 673,
        "code_end_line": 673,
        "code_key": "scope",
        "code_value": "var scope     = s.NewScope(value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 699,
        "code_end_line": 699,
        "code_key": "scope",
        "code_value": "scope := s.NewScope(s.Value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 706,
        "code_end_line": 706,
        "code_key": "scope",
        "code_value": "scope := s.NewScope(s.Value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 713,
        "code_end_line": 713,
        "code_key": "scope",
        "code_value": "scope := s.Unscoped().NewScope(s.Value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 720,
        "code_end_line": 720,
        "code_key": "scope",
        "code_value": "scope := s.Unscoped().NewScope(s.Value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 727,
        "code_end_line": 727,
        "code_key": "scope",
        "code_value": "scope := s.NewScope(s.Value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 735,
        "code_end_line": 735,
        "code_key": "scope",
        "code_value": "scope := s.NewScope(s.Value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 743,
        "code_end_line": 743,
        "code_key": "scope",
        "code_value": "scope := s.clone().NewScope(s.Value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 751,
        "code_end_line": 751,
        "code_key": "scope",
        "code_value": "var scope = s.Set(\"gorm:association:source\", s.Value).NewScope(s.Value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 795,
        "code_end_line": 795,
        "code_key": "scope",
        "code_value": "scope := s.NewScope(source)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 43,
        "code_end_line": 43,
        "code_key": "tabler",
        "code_value": "tabler, ok := reflect.New(s.ModelType).Interface().(tabler)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 319,
        "code_end_line": 319,
        "code_key": "tabler",
        "code_value": "tabler, ok := scope.Value.(tabler)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 323,
        "code_end_line": 323,
        "code_key": "tabler",
        "code_value": "tabler, ok := scope.Value.(dbTabler)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_delete.go",
        "code_start_line": 32,
        "code_end_line": 32,
        "code_key": "ok",
        "code_value": "str, ok := scope.Get(\"gorm:delete_option\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_update.go",
        "code_start_line": 25,
        "code_end_line": 25,
        "code_key": "ok",
        "code_value": "attrs, ok := scope.InstanceGet(\"gorm:update_interface\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_update.go",
        "code_start_line": 40,
        "code_end_line": 40,
        "code_key": "ok",
        "code_value": "_, ok := scope.Get(\"gorm:update_column\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_update.go",
        "code_start_line": 52,
        "code_end_line": 52,
        "code_key": "ok",
        "code_value": "_, ok := scope.Get(\"gorm:update_column\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_update.go",
        "code_start_line": 62,
        "code_end_line": 62,
        "code_key": "ok",
        "code_value": "updateAttrs, ok := scope.InstanceGet(\"gorm:update_attrs\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_update.go",
        "code_start_line": 84,
        "code_end_line": 84,
        "code_key": "ok",
        "code_value": "foreignField, ok := scope.FieldByName(foreignKey)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_update.go",
        "code_start_line": 95,
        "code_end_line": 95,
        "code_key": "ok",
        "code_value": "str, ok := scope.Get(\"gorm:update_option\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_update.go",
        "code_start_line": 113,
        "code_end_line": 113,
        "code_key": "ok",
        "code_value": "_, ok := scope.Get(\"gorm:update_column\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 18,
        "code_end_line": 18,
        "code_key": "ok",
        "code_value": "v, ok := value.(bool)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 22,
        "code_end_line": 22,
        "code_key": "ok",
        "code_value": "v, ok := value.(string)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 34,
        "code_end_line": 34,
        "code_key": "ok",
        "code_value": "value, ok := scope.Get(\"gorm:save_associations\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 38,
        "code_end_line": 38,
        "code_key": "ok",
        "code_value": "value, ok := field.TagSettingsGet(\"SAVE_ASSOCIATIONS\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 44,
        "code_end_line": 44,
        "code_key": "ok",
        "code_value": "value, ok := scope.Get(\"gorm:association_autoupdate\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 46,
        "code_end_line": 46,
        "code_key": "ok",
        "code_value": "value, ok := field.TagSettingsGet(\"ASSOCIATION_AUTOUPDATE\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 50,
        "code_end_line": 50,
        "code_key": "ok",
        "code_value": "value, ok := scope.Get(\"gorm:association_autocreate\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 52,
        "code_end_line": 52,
        "code_key": "ok",
        "code_value": "value, ok := field.TagSettingsGet(\"ASSOCIATION_AUTOCREATE\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 56,
        "code_end_line": 56,
        "code_key": "ok",
        "code_value": "value, ok := scope.Get(\"gorm:association_save_reference\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 58,
        "code_end_line": 58,
        "code_key": "ok",
        "code_value": "value, ok := field.TagSettingsGet(\"ASSOCIATION_SAVE_REFERENCE\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 88,
        "code_end_line": 88,
        "code_key": "ok",
        "code_value": "foreignField, ok := scope.New(fieldValue).FieldByName(associationForeignName)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 116,
        "code_end_line": 116,
        "code_key": "ok",
        "code_value": "f, ok := scope.FieldByName(associationForeignName)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_save.go",
        "code_start_line": 149,
        "code_end_line": 149,
        "code_key": "ok",
        "code_value": "f, ok := scope.FieldByName(associationForeignName)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_query_preload.go",
        "code_start_line": 17,
        "code_end_line": 17,
        "code_key": "ok",
        "code_value": "ap, ok := scope.Get(\"gorm:auto_preload\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_query_preload.go",
        "code_start_line": 20,
        "code_end_line": 20,
        "code_key": "ok",
        "code_value": "apb, ok := ap.(bool)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_query_preload.go",
        "code_start_line": 103,
        "code_end_line": 103,
        "code_key": "ok",
        "code_value": "val, ok := field.TagSettingsGet(\"PRELOAD\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_query_preload.go",
        "code_start_line": 123,
        "code_end_line": 123,
        "code_key": "ok",
        "code_value": "scopes, ok := condition.(func(*DB) *DB)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_query_preload.go",
        "code_start_line": 227,
        "code_end_line": 227,
        "code_key": "ok",
        "code_value": "results, ok := preloadMap[toString(objectRealValue)]",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_query_preload.go",
        "code_start_line": 379,
        "code_end_line": 379,
        "code_key": "ok",
        "code_value": "field, ok := scope.FieldByName(dbName)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/field.go",
        "code_start_line": 28,
        "code_end_line": 28,
        "code_key": "ok",
        "code_value": "reflectValue, ok := value.(reflect.Value)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/field.go",
        "code_start_line": 47,
        "code_end_line": 47,
        "code_key": "ok",
        "code_value": "scanner, ok := fieldValue.Addr().Interface().(sql.Scanner)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/field.go",
        "code_start_line": 49,
        "code_end_line": 49,
        "code_key": "ok",
        "code_value": "valuer, ok := v.(driver.Valuer)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_create.go",
        "code_start_line": 36,
        "code_end_line": 36,
        "code_key": "ok",
        "code_value": "createdAtField, ok := scope.FieldByName(\"CreatedAt\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_create.go",
        "code_start_line": 42,
        "code_end_line": 42,
        "code_key": "ok",
        "code_value": "updatedAtField, ok := scope.FieldByName(\"UpdatedAt\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_create.go",
        "code_start_line": 72,
        "code_end_line": 72,
        "code_key": "ok",
        "code_value": "foreignField, ok := scope.FieldByName(foreignKey)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_create.go",
        "code_start_line": 89,
        "code_end_line": 89,
        "code_key": "ok",
        "code_value": "str, ok := scope.Get(\"gorm:insert_option\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_create.go",
        "code_start_line": 92,
        "code_end_line": 92,
        "code_key": "ok",
        "code_value": "str, ok := scope.Get(\"gorm:insert_modifier\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_create.go",
        "code_start_line": 178,
        "code_end_line": 178,
        "code_key": "ok",
        "code_value": "blankColumnsWithDefaultValue, ok := scope.InstanceGet(\"gorm:blank_columns_with_default_value\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_row_query.go",
        "code_start_line": 24,
        "code_end_line": 24,
        "code_key": "ok",
        "code_value": "result, ok := scope.InstanceGet(\"row_query_result\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_row_query.go",
        "code_start_line": 27,
        "code_end_line": 27,
        "code_key": "ok",
        "code_value": "str, ok := scope.Get(\"gorm:query_hint\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_row_query.go",
        "code_start_line": 31,
        "code_end_line": 31,
        "code_key": "ok",
        "code_value": "rowResult, ok := result.(*RowQueryResult)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_row_query.go",
        "code_start_line": 33,
        "code_end_line": 33,
        "code_key": "ok",
        "code_value": "rowsResult, ok := result.(*RowsQueryResult)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect_common.go",
        "code_start_line": 44,
        "code_end_line": 44,
        "code_key": "ok",
        "code_value": "value, ok := field.TagSettingsGet(\"AUTO_INCREMENT\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect_common.go",
        "code_start_line": 78,
        "code_end_line": 78,
        "code_key": "ok",
        "code_value": "_, ok := dataValue.Interface().(time.Time)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect_common.go",
        "code_start_line": 82,
        "code_end_line": 82,
        "code_key": "ok",
        "code_value": "_, ok := dataValue.Interface().([]byte)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/logger.go",
        "code_start_line": 60,
        "code_end_line": 60,
        "code_key": "ok",
        "code_value": "t, ok := value.(time.Time)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/logger.go",
        "code_start_line": 66,
        "code_end_line": 66,
        "code_key": "ok",
        "code_value": "b, ok := value.([]byte)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/logger.go",
        "code_start_line": 72,
        "code_end_line": 72,
        "code_key": "ok",
        "code_value": "r, ok := value.(driver.Valuer)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/join_table_handler.go",
        "code_start_line": 93,
        "code_end_line": 93,
        "code_key": "ok",
        "code_value": "field, ok := scope.FieldByName(foreignKey.AssociationDBName)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/join_table_handler.go",
        "code_start_line": 183,
        "code_end_line": 183,
        "code_key": "ok",
        "code_value": "field, ok := scope.FieldByName(foreignKey.AssociationDBName)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect_sqlite3.go",
        "code_start_line": 53,
        "code_end_line": 53,
        "code_key": "ok",
        "code_value": "_, ok := dataValue.Interface().(time.Time)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect_mysql.go",
        "code_start_line": 38,
        "code_end_line": 38,
        "code_key": "ok",
        "code_value": "_, ok := field.TagSettingsGet(\"AUTO_INCREMENT\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect_mysql.go",
        "code_start_line": 99,
        "code_end_line": 99,
        "code_key": "ok",
        "code_value": "_, ok := dataValue.Interface().(time.Time)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect_mysql.go",
        "code_start_line": 101,
        "code_end_line": 101,
        "code_key": "ok",
        "code_value": "p, ok := field.TagSettingsGet(\"PRECISION\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect_mysql.go",
        "code_start_line": 105,
        "code_end_line": 105,
        "code_key": "ok",
        "code_value": "_, ok := field.TagSettings[\"NOT NULL\"]",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect_postgres.go",
        "code_start_line": 52,
        "code_end_line": 52,
        "code_key": "ok",
        "code_value": "_, ok := field.TagSettingsGet(\"SIZE\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect_postgres.go",
        "code_start_line": 62,
        "code_end_line": 62,
        "code_key": "ok",
        "code_value": "_, ok := dataValue.Interface().(time.Time)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect_postgres.go",
        "code_start_line": 145,
        "code_end_line": 145,
        "code_key": "ok",
        "code_value": "_, ok := value.Interface().(json.RawMessage)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect.go",
        "code_start_line": 63,
        "code_end_line": 63,
        "code_key": "ok",
        "code_value": "value, ok := dialectsMap[name]",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect.go",
        "code_start_line": 101,
        "code_end_line": 103,
        "code_key": "ok",
        "code_value": "gormDataType, ok := fieldValue.Interface().(interface {\n\t\tGormDataType(Dialect) string\n\t})",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect.go",
        "code_start_line": 120,
        "code_end_line": 120,
        "code_key": "ok",
        "code_value": "num, ok := field.TagSettingsGet(\"SIZE\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect.go",
        "code_start_line": 130,
        "code_end_line": 130,
        "code_key": "ok",
        "code_value": "value, ok := field.TagSettingsGet(\"DEFAULT\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/dialect.go",
        "code_start_line": 134,
        "code_end_line": 134,
        "code_key": "ok",
        "code_value": "value, ok := field.TagSettingsGet(\"COMMENT\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/search.go",
        "code_start_line": 151,
        "code_end_line": 151,
        "code_key": "ok",
        "code_value": "val, ok := query.(*SqlExpr)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/utils.go",
        "code_start_line": 120,
        "code_end_line": 120,
        "code_key": "ok",
        "code_value": "_, file, line, ok := runtime.Caller(i)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/utils.go",
        "code_start_line": 149,
        "code_end_line": 149,
        "code_key": "ok",
        "code_value": "str, ok := attrs[0].(string)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/utils.go",
        "code_start_line": 153,
        "code_end_line": 153,
        "code_key": "ok",
        "code_value": "attr, ok := attrs[0].(map[string]interface{})",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/utils.go",
        "code_start_line": 157,
        "code_end_line": 157,
        "code_key": "ok",
        "code_value": "attr, ok := attrs[0].(interface{})",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/utils.go",
        "code_start_line": 169,
        "code_end_line": 169,
        "code_key": "ok",
        "code_value": "values, ok := str.([]interface{})",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/utils.go",
        "code_start_line": 175,
        "code_end_line": 175,
        "code_key": "ok",
        "code_value": "bytes, ok := str.([]byte)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/utils.go",
        "code_start_line": 211,
        "code_end_line": 211,
        "code_key": "ok",
        "code_value": "r, ok := result.(driver.Valuer)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/association.go",
        "code_start_line": 76,
        "code_end_line": 76,
        "code_key": "ok",
        "code_value": "field, ok := associationScope.FieldByName(dbName)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/association.go",
        "code_start_line": 102,
        "code_end_line": 102,
        "code_key": "ok",
        "code_value": "field, ok := scope.FieldByName(dbName)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/association.go",
        "code_start_line": 117,
        "code_end_line": 117,
        "code_key": "ok",
        "code_value": "field, ok := scope.FieldByName(relationship.AssociationForeignFieldNames[idx])",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/association.go",
        "code_start_line": 157,
        "code_end_line": 157,
        "code_key": "ok",
        "code_value": "field, ok := scope.FieldByName(relationship.ForeignFieldNames[idx])",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/association.go",
        "code_start_line": 166,
        "code_end_line": 166,
        "code_key": "ok",
        "code_value": "field, ok := associationScope.FieldByName(associationDBName)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 43,
        "code_end_line": 43,
        "code_key": "ok",
        "code_value": "tabler, ok := reflect.New(s.ModelType).Interface().(tabler)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 89,
        "code_end_line": 89,
        "code_key": "ok",
        "code_value": "val, ok := sf.TagSettings[key]",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 187,
        "code_end_line": 187,
        "code_key": "ok",
        "code_value": "value, ok := modelStructsMap.Load(hashKey)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 205,
        "code_end_line": 205,
        "code_key": "ok",
        "code_value": "_, ok := field.TagSettingsGet(\"-\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 208,
        "code_end_line": 208,
        "code_key": "ok",
        "code_value": "_, ok := field.TagSettingsGet(\"PRIMARY_KEY\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 213,
        "code_end_line": 213,
        "code_key": "ok",
        "code_value": "_, ok := field.TagSettingsGet(\"DEFAULT\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 217,
        "code_end_line": 217,
        "code_key": "ok",
        "code_value": "_, ok := field.TagSettingsGet(\"AUTO_INCREMENT\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 233,
        "code_end_line": 233,
        "code_key": "ok",
        "code_value": "_, ok := field.TagSettingsGet(key)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 242,
        "code_end_line": 242,
        "code_key": "ok",
        "code_value": "_, ok := field.TagSettingsGet(\"EMBEDDED\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 247,
        "code_end_line": 247,
        "code_key": "ok",
        "code_value": "prefix, ok := field.TagSettingsGet(\"EMBEDDED_PREFIX\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 252,
        "code_end_line": 252,
        "code_key": "ok",
        "code_value": "_, ok := subField.TagSettingsGet(\"PRIMARY_KEY\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 260,
        "code_end_line": 260,
        "code_key": "ok",
        "code_value": "joinTableHandler, ok := subField.Relationship.JoinTableHandler.(*JoinTableHandler)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 348,
        "code_end_line": 348,
        "code_key": "ok",
        "code_value": "field, ok := toScope.FieldByName(name)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 382,
        "code_end_line": 382,
        "code_key": "ok",
        "code_value": "value, ok := field.TagSettingsGet(\"POLYMORPHIC_VALUE\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 486,
        "code_end_line": 486,
        "code_key": "ok",
        "code_value": "value, ok := field.TagSettingsGet(\"POLYMORPHIC_VALUE\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/model_struct.go",
        "code_start_line": 631,
        "code_end_line": 631,
        "code_key": "ok",
        "code_value": "value, ok := field.TagSettingsGet(\"COLUMN\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_query.go",
        "code_start_line": 35,
        "code_end_line": 35,
        "code_key": "ok",
        "code_value": "orderBy, ok := scope.Get(\"gorm:order_by_primary_key\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_query.go",
        "code_start_line": 41,
        "code_end_line": 41,
        "code_key": "ok",
        "code_value": "value, ok := scope.Get(\"gorm:query_destination\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/callback_query.go",
        "code_start_line": 64,
        "code_end_line": 64,
        "code_key": "ok",
        "code_value": "str, ok := scope.Get(\"gorm:query_hint\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 166,
        "code_end_line": 166,
        "code_key": "ok",
        "code_value": "field, ok := scope.FieldByName(\"id\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 210,
        "code_end_line": 210,
        "code_key": "ok",
        "code_value": "attrs, ok := scope.InstanceGet(\"gorm:update_attrs\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 215,
        "code_end_line": 215,
        "code_key": "ok",
        "code_value": "field, ok := column.(*Field)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 218,
        "code_end_line": 218,
        "code_key": "ok",
        "code_value": "name, ok := column.(string)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 260,
        "code_end_line": 260,
        "code_key": "ok",
        "code_value": "expr, ok := value.(*SqlExpr)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 285,
        "code_end_line": 285,
        "code_key": "ok",
        "code_value": "str, ok := value.(string)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 287,
        "code_end_line": 287,
        "code_key": "ok",
        "code_value": "strs, ok := value.([]string)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 289,
        "code_end_line": 289,
        "code_key": "ok",
        "code_value": "strs, ok := value.([]interface{})",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 319,
        "code_end_line": 319,
        "code_key": "ok",
        "code_value": "tabler, ok := scope.Value.(tabler)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 323,
        "code_end_line": 323,
        "code_key": "ok",
        "code_value": "tabler, ok := scope.Value.(dbTabler)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 404,
        "code_end_line": 404,
        "code_key": "ok",
        "code_value": "db, ok := scope.SQLDB().(sqlDb)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 415,
        "code_end_line": 415,
        "code_key": "ok",
        "code_value": "_, ok := scope.InstanceGet(\"gorm:started_transaction\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 416,
        "code_end_line": 416,
        "code_key": "ok",
        "code_value": "db, ok := scope.db.db.(sqlTx)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 490,
        "code_end_line": 490,
        "code_key": "ok",
        "code_value": "idx, ok := selectedColumnsMap[column]",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 609,
        "code_end_line": 609,
        "code_key": "ok",
        "code_value": "scanner, ok := interface{}(arg).(driver.Valuer)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 612,
        "code_end_line": 612,
        "code_key": "ok",
        "code_value": "b, ok := arg.([]byte)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 614,
        "code_end_line": 614,
        "code_key": "ok",
        "code_value": "as, ok := arg.([][]interface{})",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 640,
        "code_end_line": 640,
        "code_key": "ok",
        "code_value": "valuer, ok := interface{}(arg).(driver.Valuer)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 688,
        "code_end_line": 688,
        "code_key": "ok",
        "code_value": "valuer, ok := interface{}(arg).(driver.Valuer)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 786,
        "code_end_line": 786,
        "code_key": "ok",
        "code_value": "str, ok := order.(string)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 788,
        "code_end_line": 788,
        "code_key": "ok",
        "code_value": "expr, ok := order.(*SqlExpr)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 850,
        "code_end_line": 850,
        "code_key": "ok",
        "code_value": "str, ok := scope.Get(\"gorm:query_option\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 866,
        "code_end_line": 866,
        "code_key": "ok",
        "code_value": "db, ok := scope.db.db.(sqlTx)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 920,
        "code_end_line": 920,
        "code_key": "ok",
        "code_value": "field, ok := scope.FieldByName(key)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 922,
        "code_end_line": 922,
        "code_key": "ok",
        "code_value": "_, ok := value.(*SqlExpr)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 1001,
        "code_end_line": 1001,
        "code_key": "ok",
        "code_value": "query, ok := scope.Search.selects[\"query\"]",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 1022,
        "code_end_line": 1022,
        "code_key": "ok",
        "code_value": "query, ok := scope.Search.selects[\"query\"]",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 1093,
        "code_end_line": 1093,
        "code_key": "ok",
        "code_value": "field, ok := scope.FieldByName(foreignKey)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 1100,
        "code_end_line": 1100,
        "code_key": "ok",
        "code_value": "field, ok := scope.FieldByName(relationship.AssociationForeignDBNames[idx])",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 1128,
        "code_end_line": 1128,
        "code_key": "ok",
        "code_value": "tableOptions, ok := scope.Get(\"gorm:table_options\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 1144,
        "code_end_line": 1144,
        "code_key": "ok",
        "code_value": "field, ok := scope.FieldByName(fieldName)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 1155,
        "code_end_line": 1155,
        "code_key": "ok",
        "code_value": "field, ok := toScope.FieldByName(fieldName)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 1294,
        "code_end_line": 1294,
        "code_key": "ok",
        "code_value": "name, ok := field.TagSettingsGet(\"INDEX\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 1306,
        "code_end_line": 1306,
        "code_key": "ok",
        "code_value": "name, ok := field.TagSettingsGet(\"UNIQUE_INDEX\")",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/scope.go",
        "code_start_line": 1390,
        "code_end_line": 1390,
        "code_key": "ok",
        "code_value": "fieldStruct, ok := scope.GetModelStruct().ModelType.FieldByName(column)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 99,
        "code_end_line": 99,
        "code_key": "ok",
        "code_value": "d, ok := dbSQL.(*sql.DB)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 121,
        "code_end_line": 121,
        "code_key": "ok",
        "code_value": "db, ok := s.parent.db.(closer)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 130,
        "code_end_line": 130,
        "code_key": "ok",
        "code_value": "db, ok := s.db.(*sql.DB)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 538,
        "code_end_line": 538,
        "code_key": "ok",
        "code_value": "_, ok := s.db.(*sql.Tx)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 569,
        "code_end_line": 569,
        "code_key": "ok",
        "code_value": "db, ok := c.db.(sqlDb)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 584,
        "code_end_line": 584,
        "code_key": "ok",
        "code_value": "db, ok := s.db.(sqlTx)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 595,
        "code_end_line": 595,
        "code_key": "ok",
        "code_value": "db, ok := s.db.(sqlTx)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 609,
        "code_end_line": 609,
        "code_key": "ok",
        "code_value": "db, ok := s.db.(sqlTx)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 650,
        "code_end_line": 650,
        "code_key": "ok",
        "code_value": "tableName, ok := value.(string)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 677,
        "code_end_line": 677,
        "code_key": "ok",
        "code_value": "name, ok := value.(string)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 756,
        "code_end_line": 756,
        "code_key": "ok",
        "code_value": "field, ok := scope.FieldByName(column)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 835,
        "code_end_line": 835,
        "code_key": "ok",
        "code_value": "errs, ok := s.Error.(Errors)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/errors.go",
        "code_start_line": 26,
        "code_end_line": 26,
        "code_key": "ok",
        "code_value": "errs, ok := err.(Errors)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/errors.go",
        "code_start_line": 48,
        "code_end_line": 48,
        "code_key": "ok",
        "code_value": "errors, ok := err.(Errors)",
        "code_label": null,
        "code_type": 1,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "save",
      "Association",
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go:536:559:Transaction",
    "orm_code": "func (s *DB) Transaction(fc func(tx *DB) error) (err error) {\n\n\tif _, ok := s.db.(*sql.Tx); ok {\n\t\treturn fc(s)\n\t}\n\n\tpanicked := true\n\ttx := s.Begin()\n\tdefer func() {\n\t\t// Make sure to rollback when panic, Block error or Commit error\n\t\tif panicked || err != nil {\n\t\t\ttx.Rollback()\n\t\t}\n\t}()\n\n\terr = fc(tx)\n\n\tif err == nil {\n\t\terr = tx.Commit().Error\n\t}\n\n\tpanicked = false\n\treturn\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go",
        "code_start_line": 15,
        "code_end_line": 37,
        "code_key": "DB",
        "code_value": "type DB struct {\n\tsync.RWMutex\n\tValue        interface{}\n\tError        error\n\tRowsAffected int64\n\n\t// single db\n\tdb                SQLCommon\n\tblockGlobalUpdate bool\n\tlogMode           logModeValue\n\tlogger            logger\n\tsearch            *search\n\tvalues            sync.Map\n\n\t// global db\n\tparent        *DB\n\tcallbacks     *Callback\n\tdialect       Dialect\n\tsingularTable bool\n\n\t// function to be used to override the creating of a new timestamp\n\tnowFuncOverride func() time.Time\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go:582:590:Commit",
    "orm_code": "func (s *DB) Commit() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\ts.AddError(db.Commit())\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/interface.go",
        "code_start_line": 21,
        "code_end_line": 24,
        "code_key": "sqlTx",
        "code_value": "type sqlTx interface {\n\tCommit() error\n\tRollback() error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go:582:590:Commit",
    "orm_code": "func (s *DB) Commit() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\ts.AddError(db.Commit())\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "caller": "func (scope *Scope) CommitOrRollback() *Scope {\n\tif _, ok := scope.InstanceGet(\"gorm:started_transaction\"); ok {\n\t\tif db, ok := scope.db.db.(sqlTx); ok {\n\t\t\tif scope.HasError() {\n\t\t\t\tdb.Rollback()\n\t\t\t} else {\n\t\t\t\tscope.Err(db.Commit())\n\t\t\t}\n\t\t\tscope.db.db = scope.db.parent.db\n\t\t}\n\t}\n\treturn scope\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/interface.go",
        "code_start_line": 21,
        "code_end_line": 24,
        "code_key": "sqlTx",
        "code_value": "type sqlTx interface {\n\tCommit() error\n\tRollback() error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go:582:590:Commit",
    "orm_code": "func (s *DB) Commit() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\ts.AddError(db.Commit())\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "caller": "func (s *DB) Transaction(fc func(tx *DB) error) (err error) {\n\n\tif _, ok := s.db.(*sql.Tx); ok {\n\t\treturn fc(s)\n\t}\n\n\tpanicked := true\n\ttx := s.Begin()\n\tdefer func() {\n\t\t// Make sure to rollback when panic, Block error or Commit error\n\t\tif panicked || err != nil {\n\t\t\ttx.Rollback()\n\t\t}\n\t}()\n\n\terr = fc(tx)\n\n\tif err == nil {\n\t\terr = tx.Commit().Error\n\t}\n\n\tpanicked = false\n\treturn\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/interface.go",
        "code_start_line": 21,
        "code_end_line": 24,
        "code_key": "sqlTx",
        "code_value": "type sqlTx interface {\n\tCommit() error\n\tRollback() error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go:582:590:Commit",
    "orm_code": "func (s *DB) Commit() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\ts.AddError(db.Commit())\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "caller": "func (s *DB) Commit() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\ts.AddError(db.Commit())\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/interface.go",
        "code_start_line": 21,
        "code_end_line": 24,
        "code_key": "sqlTx",
        "code_value": "type sqlTx interface {\n\tCommit() error\n\tRollback() error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go:593:603:Rollback",
    "orm_code": "func (s *DB) Rollback() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\tif err := db.Rollback(); err != nil && err != sql.ErrTxDone {\n\t\t\ts.AddError(err)\n\t\t}\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "caller": "",
    "sql_statement_list": [
      "您好！我已经准备好帮您将SQL语句分析结果格式化为标准JSON格式。\n\n但是我注意到您提供的\"需要格式化的内容\"部分是空的（显示为[]）。\n\n请您提供需要格式化的SQL语句内容，我会按照您指定的格式要求将其转换为标准JSON格式。\n\n格式要求我已理解：\n- 输出SQL语句数组\n- 固定SQL用字符串表示\n- 变化SQL用对象表示（包含type和variants）\n- 移除非SQL内容\n- 所有SQL以分号结尾\n- 返回纯JSON格式\n\n请提供具体的SQL内容，我立即为您格式化。;"
    ],
    "sql_types": [
      "OTHER"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/interface.go",
        "code_start_line": 21,
        "code_end_line": 24,
        "code_key": "sqlTx",
        "code_value": "type sqlTx interface {\n\tCommit() error\n\tRollback() error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go:593:603:Rollback",
    "orm_code": "func (s *DB) Rollback() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\tif err := db.Rollback(); err != nil && err != sql.ErrTxDone {\n\t\t\ts.AddError(err)\n\t\t}\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "caller": "func (scope *Scope) CommitOrRollback() *Scope {\n\tif _, ok := scope.InstanceGet(\"gorm:started_transaction\"); ok {\n\t\tif db, ok := scope.db.db.(sqlTx); ok {\n\t\t\tif scope.HasError() {\n\t\t\t\tdb.Rollback()\n\t\t\t} else {\n\t\t\t\tscope.Err(db.Commit())\n\t\t\t}\n\t\t\tscope.db.db = scope.db.parent.db\n\t\t}\n\t}\n\treturn scope\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/interface.go",
        "code_start_line": 21,
        "code_end_line": 24,
        "code_key": "sqlTx",
        "code_value": "type sqlTx interface {\n\tCommit() error\n\tRollback() error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go:593:603:Rollback",
    "orm_code": "func (s *DB) Rollback() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\tif err := db.Rollback(); err != nil && err != sql.ErrTxDone {\n\t\t\ts.AddError(err)\n\t\t}\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "caller": "func (scope *Scope) callCallbacks(funcs []*func(s *Scope)) *Scope {\n\tdefer func() {\n\t\tif err := recover(); err != nil {\n\t\t\tif db, ok := scope.db.db.(sqlTx); ok {\n\t\t\t\tdb.Rollback()\n\t\t\t}\n\t\t\tpanic(err)\n\t\t}\n\t}()\n\tfor _, f := range funcs {\n\t\t(*f)(scope)\n\t\tif scope.skipLeft {\n\t\t\tbreak\n\t\t}\n\t}\n\treturn scope\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/interface.go",
        "code_start_line": 21,
        "code_end_line": 24,
        "code_key": "sqlTx",
        "code_value": "type sqlTx interface {\n\tCommit() error\n\tRollback() error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go:593:603:Rollback",
    "orm_code": "func (s *DB) Rollback() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\tif err := db.Rollback(); err != nil && err != sql.ErrTxDone {\n\t\t\ts.AddError(err)\n\t\t}\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "caller": "func (s *DB) Transaction(fc func(tx *DB) error) (err error) {\n\n\tif _, ok := s.db.(*sql.Tx); ok {\n\t\treturn fc(s)\n\t}\n\n\tpanicked := true\n\ttx := s.Begin()\n\tdefer func() {\n\t\t// Make sure to rollback when panic, Block error or Commit error\n\t\tif panicked || err != nil {\n\t\t\ttx.Rollback()\n\t\t}\n\t}()\n\n\terr = fc(tx)\n\n\tif err == nil {\n\t\terr = tx.Commit().Error\n\t}\n\n\tpanicked = false\n\treturn\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/interface.go",
        "code_start_line": 21,
        "code_end_line": 24,
        "code_key": "sqlTx",
        "code_value": "type sqlTx interface {\n\tCommit() error\n\tRollback() error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go:593:603:Rollback",
    "orm_code": "func (s *DB) Rollback() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\tif err := db.Rollback(); err != nil && err != sql.ErrTxDone {\n\t\t\ts.AddError(err)\n\t\t}\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "caller": "func (s *DB) Rollback() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\tif err := db.Rollback(); err != nil && err != sql.ErrTxDone {\n\t\t\ts.AddError(err)\n\t\t}\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/interface.go",
        "code_start_line": 21,
        "code_end_line": 24,
        "code_key": "sqlTx",
        "code_value": "type sqlTx interface {\n\tCommit() error\n\tRollback() error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go:593:603:Rollback",
    "orm_code": "func (s *DB) Rollback() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\tif err := db.Rollback(); err != nil && err != sql.ErrTxDone {\n\t\t\ts.AddError(err)\n\t\t}\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "caller": "func (s *DB) RollbackUnlessCommitted() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\terr := db.Rollback()\n\t\t// Ignore the error indicating that the transaction has already\n\t\t// been committed.\n\t\tif err != sql.ErrTxDone {\n\t\t\ts.AddError(err)\n\t\t}\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/interface.go",
        "code_start_line": 21,
        "code_end_line": 24,
        "code_key": "sqlTx",
        "code_value": "type sqlTx interface {\n\tCommit() error\n\tRollback() error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/main.go:607:620:RollbackUnlessCommitted",
    "orm_code": "func (s *DB) RollbackUnlessCommitted() *DB {\n\tvar emptySQLTx *sql.Tx\n\tif db, ok := s.db.(sqlTx); ok && db != nil && db != emptySQLTx {\n\t\terr := db.Rollback()\n\t\t// Ignore the error indicating that the transaction has already\n\t\t// been committed.\n\t\tif err != sql.ErrTxDone {\n\t\t\ts.AddError(err)\n\t\t}\n\t} else {\n\t\ts.AddError(ErrInvalidTransaction)\n\t}\n\treturn s\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/STKE__jinzhu-gorm/interface.go",
        "code_start_line": 21,
        "code_end_line": 24,
        "code_key": "sqlTx",
        "code_value": "type sqlTx interface {\n\tCommit() error\n\tRollback() error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "4cbeee4734fbad8fd1c6216ff93a20ace0fb9d5b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/STKE__jinzhu-gorm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go:39:133:CreateProjectConfig",
    "orm_code": "func (c *ProjectConfig) CreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam,\n\tscope string, serviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (\n\t*protocol.ProjectConfig, error) {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tfor _, resource := range projectConfig.Resources {\n\t\t\t// basic\n\t\t\tvar getInstancesActionBytes []byte\n\t\t\tif resource != nil &&\n\t\t\t\tresource.GetInstancesAction != nil &&\n\t\t\t\tresource.GetInstancesAction.Version != \"\" && resource.GetInstancesAction.Action != \"\" {\n\t\t\t\tif getInstancesActionBytes, err = json.Marshal(resource.GetInstancesAction); err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\tbillingProductCode := resource.BillingProductCode\n\t\t\tif billingProductCode == \"\" && resource.AccessType == entity.ACCESSTYPE_LOCAL {\n\t\t\t\tbillingProductCode = \"p_\" + resource.ServiceType + strings.ToLower(resource.ResourceType)\n\t\t\t}\n\t\t\tif _, err = createProductBasicInfoInTx(tx, &entity.ProductBasicInfo{\n\t\t\t\tProduct:            projectConfig.ProductCode,\n\t\t\t\tProductCode:        billingProductCode,\n\t\t\t\tServiceType:        resource.ServiceType,\n\t\t\t\tResourceType:       resource.ResourceType,\n\t\t\t\tAccessType:         resource.AccessType,\n\t\t\t\tGetInstancesAction: string(getInstancesActionBytes),\n\t\t\t\tPermissionUser:     projectConfig.UserId,\n\t\t\t\tVersion:            projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:           projectConfig.Platform,\n\t\t\t\tCreatorName:        projectConfig.UserId,\n\t\t\t\tUpdateName:         projectConfig.UserId,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tfor _, subscription := range resource.Subscriptions {\n\t\t\t\t// subscription\n\t\t\t\tnewSubscription := &entity.ProductSubscription{\n\t\t\t\t\tServiceType:  resource.ServiceType,\n\t\t\t\t\tProduct:      projectConfig.ProductCode,\n\t\t\t\t\tResourceType: resource.ResourceType,\n\t\t\t\t\tServiceID:    subscription.ServiceID,\n\t\t\t\t\tGitUrl:       subscription.GitUrl,\n\t\t\t\t\tVersion:      projectConfig.ReleaseVersion,\n\t\t\t\t\tPlatform:     projectConfig.Platform,\n\t\t\t\t}\n\t\t\t\t// 极光本地直接保存serviceid，特定环境需要根据pajero解析serviceid拿到endpoint\n\t\t\t\tif pajeroAddr != \"\" {\n\t\t\t\t\t// 只添加在pajero中能查到地址的serviceid\n\t\t\t\t\tif details, ok := serviceID2Detail[subscription.ServiceID]; ok {\n\t\t\t\t\t\tfor _, detail := range details {\n\t\t\t\t\t\t\tnewSubscription.Name = strings.Join([]string{projectConfig.ProductCode,\n\t\t\t\t\t\t\t\tresource.ServiceType, resource.ResourceType, detail.Region}, \"-\")\n\t\t\t\t\t\t\tnewSubscription.Endpoint = detail.Endpoint\n\t\t\t\t\t\t\tnewSubscription.Region = detail.Region\n\t\t\t\t\t\t\tif _, err = createProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif _, err = createProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// policytemplate\n\t\tfor _, policyTemplate := range projectConfig.PolicyTemplates {\n\t\t\tvar descriptionBytes []byte\n\t\t\tif descriptionBytes, err = json.Marshal(policyTemplate.PolicyTemplateDescI18n); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tdescription, _ := policyTemplate.PolicyTemplateDescI18n[utils.LanguageZhCN]\n\t\t\tvar policyTemplateDocBytes []byte\n\t\t\tif policyTemplateDocBytes, err = json.Marshal(policyTemplate.PolicyTemplateDoc); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif _, err = createProductPolicyTemplateInTx(tx, &entity.ProductPolicyTemplate{\n\t\t\t\tProduct:           projectConfig.ProductCode,\n\t\t\t\tPolicyTplName:     policyTemplate.PolicyTemplateName,\n\t\t\t\tPrefixInCam:       prefixInCam + policyTemplate.PolicyTemplateName,\n\t\t\t\tDescription:       description,\n\t\t\t\tPolicyDocTpl:      string(policyTemplateDocBytes),\n\t\t\t\tScope:             scope,\n\t\t\t\tRemark:            string(descriptionBytes),\n\t\t\t\tPolicyTplDescI18n: string(descriptionBytes),\n\t\t\t\tVersion:           projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:          projectConfig.Platform,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t\treturn\n\t})\n\treturn projectConfig, err\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "单个resource(1个subscription)，单个policyTemplate，无pajeroAddr",
            "sql": "INSERT INTO ProductBasicInfoTable (product, product_code, service_type, resource_type, access_type, get_instances_action, permission_user, version, platform, creator_name, update_name, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);"
          },
          {
            "scenario": "多个resources，多个subscriptions，多个policyTemplates的情况",
            "sql": "INSERT INTO ProductBasicInfoTable (product, product_code, service_type, resource_type, access_type, get_instances_action, permission_user, version, platform, creator_name, update_name, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "无pajeroAddr的subscription插入",
            "sql": "INSERT INTO ProductSubscriptionTable (service_type, product, resource_type, service_id, git_url, version, platform, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?);"
          },
          {
            "scenario": "有pajeroAddr且serviceID存在于映射中的subscription插入",
            "sql": "INSERT INTO ProductSubscriptionTable (name, service_type, product, resource_type, service_id, git_url, endpoint, region, version, platform, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "单个policyTemplate插入",
            "sql": "INSERT INTO ProductPolicyTemplateTable (product, policy_tpl_name, prefix_in_cam, description, policy_doc_tpl, scope, remark, policy_tpl_desc_i18n, version, platform, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);"
          },
          {
            "scenario": "多个policyTemplates插入",
            "sql": "INSERT INTO ProductPolicyTemplateTable (product, policy_tpl_name, prefix_in_cam, description, policy_doc_tpl, scope, remark, policy_tpl_desc_i18n, version, platform, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/basicinfo.go",
        "code_start_line": 10,
        "code_end_line": 17,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo interface {\n\tListProductBasicInfos(ctx context.Context, filter entity.Filter) ([]*entity.ProductBasicInfo, int64, error)\n\tCreateProductBasicInfo(ctx context.Context, productBasicInfo *entity.ProductBasicInfo) (*entity.ProductBasicInfo, error)\n\tModifyProductBasicInfo(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductBasicInfo(ctx context.Context, filter entity.Filter) (*entity.ProductBasicInfo, error)\n\tDeleteProductBasicInfo(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 21,
        "code_end_line": 39,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tID                 uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt          time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt          time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct            string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_product;column:product;type:varchar(32);default:null\"`\n\tProductCode        string    `gorm:\"index:idx_code;column:product_code;type:varchar(32);default:null\"`\n\tServiceType        string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_service;column:service_type;type:varchar(32);default:null\"`\n\tResourceType       string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_resource_type;column:resource_type;type:varchar(32);default:null\"`\n\tAccessType         string    `gorm:\"index:idx_access_type;column:access_type;type:varchar(32);default:null\"`\n\tPermissionUser     string    `gorm:\"column:permission_user;type:text;default:null\"`\n\tGetInstancesAction string    `gorm:\"column:get_instances_action;type:text;default:null\"`\n\tVersion            string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform           string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tState              int       `gorm:\"column:state;type:tinyint(4);default:0\"` // 0 未合流，1 已合流\n\tSnapshotId         string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen             int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n\tCreatorName        string    `gorm:\"column:creator_name;type:varchar(128);default:null\"`\n\tUpdateName         string    `gorm:\"column:update_name;type:varchar(128);default:null\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 42,
        "code_end_line": 44,
        "code_key": "TableName",
        "code_value": "func (r *ProductBasicInfo) TableName() string {\n\treturn ProductBasicInfoTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/basicinfo.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/subscription.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription interface {\n\tListProductSubscriptions(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductSubscription, int64, error)\n\tCreateProductSubscription(ctx context.Context,\n\t\tproductSubscription *entity.ProductSubscription) (*entity.ProductSubscription, error)\n\n\tGetProductSubscription(ctx context.Context, filter entity.Filter) (*entity.ProductSubscription, error)\n\tDeleteProductSubscription(ctx context.Context, filter entity.Filter) error\n\tModifyProductSubscription(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 11,
        "code_end_line": 28,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription struct {\n\tID             uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt      time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt      time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tName           string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:name;type:varchar(32);default:null\"`\n\tServiceType    string    `gorm:\"column:service_type;type:text;default:null\"`\n\tRegion         string    `gorm:\"column:region;type:varchar(16);default:null\"`\n\tResourcePrefix string    `gorm:\"column:resource_prefix;type:varchar(16);default:null\"`\n\tEndpoint       string    `gorm:\"column:endpoint;type:varchar(256);default:null\"`\n\tProduct        string    `gorm:\"column:product;type:varchar(32);default:null\"`\n\tResourceType   string    `gorm:\"column:resource_type;type:varchar(32);default:null\"`\n\tServiceID      string    `gorm:\"column:service_id;type:varchar(1024);default:null\"`\n\tGitUrl         string    `gorm:\"column:git_url;type:varchar(4096);default:null\"`\n\tVersion        string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform       string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId     string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen         int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (r *ProductSubscription) TableName() string {\n\treturn ProductSubscriptionTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/policytemplate.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate interface {\n\tListProductPolicyTemplates(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductPolicyTemplate, int64, error)\n\tCreateProductPolicyTemplate(ctx context.Context,\n\t\tpolicyTemplate *entity.ProductPolicyTemplate) (*entity.ProductPolicyTemplate, error)\n\tModifyProductPolicyTemplate(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductPolicyTemplate(ctx context.Context, filter entity.Filter) (*entity.ProductPolicyTemplate, error)\n\tDeleteProductPolicyTemplate(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 13,
        "code_end_line": 29,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tID                uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt         time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt         time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct           string    `gorm:\"column:product;type:varchar(16);default:null\"`\n\tPolicyTplName     string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:policy_tpl_name;type:varchar(200);default:null\"`\n\tPrefixInCam       string    `gorm:\"column:prefix_in_cam;type:varchar(128);default:null\"`\n\tDescription       string    `gorm:\"column:description;type:varchar(512);default:null\"`\n\tPolicyDocTpl      string    `gorm:\"column:policy_doc_tpl;type:text;default:null\"`\n\tScope             string    `gorm:\"column:scope;type:varchar(16);default:null\"`\n\tRemark            string    `gorm:\"column:remark;type:text;default:null\"`\n\tPolicyTplDescI18n string    `gorm:\"column:policy_tpl_desc_i18n;type:text;default:null\"`\n\tVersion           string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform          string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId        string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen            int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 32,
        "code_end_line": 34,
        "code_key": "TableName",
        "code_value": "func (r *ProductPolicyTemplate) TableName() string {\n\treturn ProductPolicyTemplateTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/policytemplate.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/service/projectconfig.go",
        "code_start_line": 16,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tbasicInfoStore      repository.ProductBasicInfo\n\tpolicyTemplateStore repository.ProductPolicyTemplate\n\tsubscriptionStore   repository.ProductSubscription\n\tprojectConfigStore  repository.ProjectConfig\n\tcfg                 *config.Config\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/projectconfig.go",
        "code_start_line": 11,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig interface {\n\tCreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tCreateProjectConfigSnapshot(ctx context.Context,\n\t\tversion, platform string, productCode2SnapshotId map[string]string) error\n\n\tGetProjectConfig(ctx context.Context, filter entity.Filter) (*protocol.ProjectConfig, error)\n\tListProjectConfigs(ctx context.Context, filter entity.Filter) ([]*protocol.ProjectConfig, int64, error)\n\tDeleteProjectConfig(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go",
        "code_start_line": 25,
        "code_end_line": 27,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/pkg/protocol/projectconfig.go",
        "code_start_line": 71,
        "code_end_line": 76,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tYunapiBaseParam\n\tProductCode     string                `json:\"ProductCode\" validate:\"required\"`\n\tResources       []*ResourceItem       `json:\"Resources\" validate:\"required\"`\n\tPolicyTemplates []*PolicyTemplateItem `json:\"PolicyTemplates\" validate:\"required\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 36,
        "code_end_line": 39,
        "code_key": "ServceIDDetail",
        "code_value": "type ServceIDDetail struct {\n\tRegion   string `json:\"Region\"`\n\tEndpoint string `json:\"Endpoint\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/api__project.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go:39:133:CreateProjectConfig",
    "orm_code": "func (c *ProjectConfig) CreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam,\n\tscope string, serviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (\n\t*protocol.ProjectConfig, error) {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tfor _, resource := range projectConfig.Resources {\n\t\t\t// basic\n\t\t\tvar getInstancesActionBytes []byte\n\t\t\tif resource != nil &&\n\t\t\t\tresource.GetInstancesAction != nil &&\n\t\t\t\tresource.GetInstancesAction.Version != \"\" && resource.GetInstancesAction.Action != \"\" {\n\t\t\t\tif getInstancesActionBytes, err = json.Marshal(resource.GetInstancesAction); err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\tbillingProductCode := resource.BillingProductCode\n\t\t\tif billingProductCode == \"\" && resource.AccessType == entity.ACCESSTYPE_LOCAL {\n\t\t\t\tbillingProductCode = \"p_\" + resource.ServiceType + strings.ToLower(resource.ResourceType)\n\t\t\t}\n\t\t\tif _, err = createProductBasicInfoInTx(tx, &entity.ProductBasicInfo{\n\t\t\t\tProduct:            projectConfig.ProductCode,\n\t\t\t\tProductCode:        billingProductCode,\n\t\t\t\tServiceType:        resource.ServiceType,\n\t\t\t\tResourceType:       resource.ResourceType,\n\t\t\t\tAccessType:         resource.AccessType,\n\t\t\t\tGetInstancesAction: string(getInstancesActionBytes),\n\t\t\t\tPermissionUser:     projectConfig.UserId,\n\t\t\t\tVersion:            projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:           projectConfig.Platform,\n\t\t\t\tCreatorName:        projectConfig.UserId,\n\t\t\t\tUpdateName:         projectConfig.UserId,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tfor _, subscription := range resource.Subscriptions {\n\t\t\t\t// subscription\n\t\t\t\tnewSubscription := &entity.ProductSubscription{\n\t\t\t\t\tServiceType:  resource.ServiceType,\n\t\t\t\t\tProduct:      projectConfig.ProductCode,\n\t\t\t\t\tResourceType: resource.ResourceType,\n\t\t\t\t\tServiceID:    subscription.ServiceID,\n\t\t\t\t\tGitUrl:       subscription.GitUrl,\n\t\t\t\t\tVersion:      projectConfig.ReleaseVersion,\n\t\t\t\t\tPlatform:     projectConfig.Platform,\n\t\t\t\t}\n\t\t\t\t// 极光本地直接保存serviceid，特定环境需要根据pajero解析serviceid拿到endpoint\n\t\t\t\tif pajeroAddr != \"\" {\n\t\t\t\t\t// 只添加在pajero中能查到地址的serviceid\n\t\t\t\t\tif details, ok := serviceID2Detail[subscription.ServiceID]; ok {\n\t\t\t\t\t\tfor _, detail := range details {\n\t\t\t\t\t\t\tnewSubscription.Name = strings.Join([]string{projectConfig.ProductCode,\n\t\t\t\t\t\t\t\tresource.ServiceType, resource.ResourceType, detail.Region}, \"-\")\n\t\t\t\t\t\t\tnewSubscription.Endpoint = detail.Endpoint\n\t\t\t\t\t\t\tnewSubscription.Region = detail.Region\n\t\t\t\t\t\t\tif _, err = createProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif _, err = createProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// policytemplate\n\t\tfor _, policyTemplate := range projectConfig.PolicyTemplates {\n\t\t\tvar descriptionBytes []byte\n\t\t\tif descriptionBytes, err = json.Marshal(policyTemplate.PolicyTemplateDescI18n); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tdescription, _ := policyTemplate.PolicyTemplateDescI18n[utils.LanguageZhCN]\n\t\t\tvar policyTemplateDocBytes []byte\n\t\t\tif policyTemplateDocBytes, err = json.Marshal(policyTemplate.PolicyTemplateDoc); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif _, err = createProductPolicyTemplateInTx(tx, &entity.ProductPolicyTemplate{\n\t\t\t\tProduct:           projectConfig.ProductCode,\n\t\t\t\tPolicyTplName:     policyTemplate.PolicyTemplateName,\n\t\t\t\tPrefixInCam:       prefixInCam + policyTemplate.PolicyTemplateName,\n\t\t\t\tDescription:       description,\n\t\t\t\tPolicyDocTpl:      string(policyTemplateDocBytes),\n\t\t\t\tScope:             scope,\n\t\t\t\tRemark:            string(descriptionBytes),\n\t\t\t\tPolicyTplDescI18n: string(descriptionBytes),\n\t\t\t\tVersion:           projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:          projectConfig.Platform,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t\treturn\n\t})\n\treturn projectConfig, err\n}",
    "caller": "func (p *ProjectConfigApp) CreateProjectConfig(ctx context.Context, param *tcenterapi.BaseParam,\n\trequest *CreateProjectConfigAPI3Req) (*CreateProjectConfigAPI3Res, *tcenterapi.APIError) {\n\t_, err := p.projectConfigSrv.CreateProjectConfig(ctx, request.ProjectConfig)\n\tif err != nil {\n\t\treturn nil, utils.GetApiError(err)\n\t}\n\treturn &CreateProjectConfigAPI3Res{}, nil\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "单个Resource单个Subscription无pajeroAddr",
            "sql": "INSERT INTO ProductBasicInfoTable (created_at, updated_at, product, product_code, service_type, resource_type, access_type, get_instances_action, permission_user, version, platform, state, snapshot_id, is_seen, creator_name, update_name) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, '', 1, ?, ?);"
          },
          {
            "scenario": "多个Resource",
            "sql": "INSERT INTO ProductBasicInfoTable (created_at, updated_at, product, product_code, service_type, resource_type, access_type, get_instances_action, permission_user, version, platform, state, snapshot_id, is_seen, creator_name, update_name) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, '', 1, ?, ?); INSERT INTO ProductBasicInfoTable (created_at, updated_at, product, product_code, service_type, resource_type, access_type, get_instances_action, permission_user, version, platform, state, snapshot_id, is_seen, creator_name, update_name) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, '', 1, ?, ?);"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "无pajeroAddr时的Subscription插入",
            "sql": "INSERT INTO ProductSubscriptionTable (created_at, updated_at, name, service_type, region, resource_prefix, endpoint, product, resource_type, service_id, git_url, version, platform, snapshot_id, is_seen) VALUES (?, ?, '', ?, '', '', '', ?, ?, ?, ?, ?, ?, '', 1);"
          },
          {
            "scenario": "有pajeroAddr且serviceID存在于映射中",
            "sql": "INSERT INTO ProductSubscriptionTable (created_at, updated_at, name, service_type, region, resource_prefix, endpoint, product, resource_type, service_id, git_url, version, platform, snapshot_id, is_seen) VALUES (?, ?, ?, ?, ?, '', ?, ?, ?, ?, ?, ?, ?, '', 1);"
          },
          {
            "scenario": "多个Subscription或多个Region",
            "sql": "INSERT INTO ProductSubscriptionTable (created_at, updated_at, name, service_type, region, resource_prefix, endpoint, product, resource_type, service_id, git_url, version, platform, snapshot_id, is_seen) VALUES (?, ?, ?, ?, ?, '', ?, ?, ?, ?, ?, ?, ?, '', 1); INSERT INTO ProductSubscriptionTable (created_at, updated_at, name, service_type, region, resource_prefix, endpoint, product, resource_type, service_id, git_url, version, platform, snapshot_id, is_seen) VALUES (?, ?, ?, ?, ?, '', ?, ?, ?, ?, ?, ?, ?, '', 1);"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "单个PolicyTemplate",
            "sql": "INSERT INTO ProductPolicyTemplateTable (created_at, updated_at, product, policy_tpl_name, prefix_in_cam, description, policy_doc_tpl, scope, remark, policy_tpl_desc_i18n, version, platform, snapshot_id, is_seen) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, '', 1);"
          },
          {
            "scenario": "多个PolicyTemplate",
            "sql": "INSERT INTO ProductPolicyTemplateTable (created_at, updated_at, product, policy_tpl_name, prefix_in_cam, description, policy_doc_tpl, scope, remark, policy_tpl_desc_i18n, version, platform, snapshot_id, is_seen) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, '', 1); INSERT INTO ProductPolicyTemplateTable (created_at, updated_at, product, policy_tpl_name, prefix_in_cam, description, policy_doc_tpl, scope, remark, policy_tpl_desc_i18n, version, platform, snapshot_id, is_seen) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, '', 1);"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/basicinfo.go",
        "code_start_line": 10,
        "code_end_line": 17,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo interface {\n\tListProductBasicInfos(ctx context.Context, filter entity.Filter) ([]*entity.ProductBasicInfo, int64, error)\n\tCreateProductBasicInfo(ctx context.Context, productBasicInfo *entity.ProductBasicInfo) (*entity.ProductBasicInfo, error)\n\tModifyProductBasicInfo(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductBasicInfo(ctx context.Context, filter entity.Filter) (*entity.ProductBasicInfo, error)\n\tDeleteProductBasicInfo(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 21,
        "code_end_line": 39,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tID                 uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt          time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt          time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct            string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_product;column:product;type:varchar(32);default:null\"`\n\tProductCode        string    `gorm:\"index:idx_code;column:product_code;type:varchar(32);default:null\"`\n\tServiceType        string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_service;column:service_type;type:varchar(32);default:null\"`\n\tResourceType       string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_resource_type;column:resource_type;type:varchar(32);default:null\"`\n\tAccessType         string    `gorm:\"index:idx_access_type;column:access_type;type:varchar(32);default:null\"`\n\tPermissionUser     string    `gorm:\"column:permission_user;type:text;default:null\"`\n\tGetInstancesAction string    `gorm:\"column:get_instances_action;type:text;default:null\"`\n\tVersion            string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform           string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tState              int       `gorm:\"column:state;type:tinyint(4);default:0\"` // 0 未合流，1 已合流\n\tSnapshotId         string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen             int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n\tCreatorName        string    `gorm:\"column:creator_name;type:varchar(128);default:null\"`\n\tUpdateName         string    `gorm:\"column:update_name;type:varchar(128);default:null\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 42,
        "code_end_line": 44,
        "code_key": "TableName",
        "code_value": "func (r *ProductBasicInfo) TableName() string {\n\treturn ProductBasicInfoTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/basicinfo.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/subscription.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription interface {\n\tListProductSubscriptions(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductSubscription, int64, error)\n\tCreateProductSubscription(ctx context.Context,\n\t\tproductSubscription *entity.ProductSubscription) (*entity.ProductSubscription, error)\n\n\tGetProductSubscription(ctx context.Context, filter entity.Filter) (*entity.ProductSubscription, error)\n\tDeleteProductSubscription(ctx context.Context, filter entity.Filter) error\n\tModifyProductSubscription(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 11,
        "code_end_line": 28,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription struct {\n\tID             uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt      time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt      time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tName           string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:name;type:varchar(32);default:null\"`\n\tServiceType    string    `gorm:\"column:service_type;type:text;default:null\"`\n\tRegion         string    `gorm:\"column:region;type:varchar(16);default:null\"`\n\tResourcePrefix string    `gorm:\"column:resource_prefix;type:varchar(16);default:null\"`\n\tEndpoint       string    `gorm:\"column:endpoint;type:varchar(256);default:null\"`\n\tProduct        string    `gorm:\"column:product;type:varchar(32);default:null\"`\n\tResourceType   string    `gorm:\"column:resource_type;type:varchar(32);default:null\"`\n\tServiceID      string    `gorm:\"column:service_id;type:varchar(1024);default:null\"`\n\tGitUrl         string    `gorm:\"column:git_url;type:varchar(4096);default:null\"`\n\tVersion        string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform       string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId     string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen         int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (r *ProductSubscription) TableName() string {\n\treturn ProductSubscriptionTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/policytemplate.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate interface {\n\tListProductPolicyTemplates(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductPolicyTemplate, int64, error)\n\tCreateProductPolicyTemplate(ctx context.Context,\n\t\tpolicyTemplate *entity.ProductPolicyTemplate) (*entity.ProductPolicyTemplate, error)\n\tModifyProductPolicyTemplate(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductPolicyTemplate(ctx context.Context, filter entity.Filter) (*entity.ProductPolicyTemplate, error)\n\tDeleteProductPolicyTemplate(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 13,
        "code_end_line": 29,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tID                uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt         time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt         time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct           string    `gorm:\"column:product;type:varchar(16);default:null\"`\n\tPolicyTplName     string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:policy_tpl_name;type:varchar(200);default:null\"`\n\tPrefixInCam       string    `gorm:\"column:prefix_in_cam;type:varchar(128);default:null\"`\n\tDescription       string    `gorm:\"column:description;type:varchar(512);default:null\"`\n\tPolicyDocTpl      string    `gorm:\"column:policy_doc_tpl;type:text;default:null\"`\n\tScope             string    `gorm:\"column:scope;type:varchar(16);default:null\"`\n\tRemark            string    `gorm:\"column:remark;type:text;default:null\"`\n\tPolicyTplDescI18n string    `gorm:\"column:policy_tpl_desc_i18n;type:text;default:null\"`\n\tVersion           string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform          string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId        string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen            int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 32,
        "code_end_line": 34,
        "code_key": "TableName",
        "code_value": "func (r *ProductPolicyTemplate) TableName() string {\n\treturn ProductPolicyTemplateTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/policytemplate.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/service/projectconfig.go",
        "code_start_line": 16,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tbasicInfoStore      repository.ProductBasicInfo\n\tpolicyTemplateStore repository.ProductPolicyTemplate\n\tsubscriptionStore   repository.ProductSubscription\n\tprojectConfigStore  repository.ProjectConfig\n\tcfg                 *config.Config\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/projectconfig.go",
        "code_start_line": 11,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig interface {\n\tCreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tCreateProjectConfigSnapshot(ctx context.Context,\n\t\tversion, platform string, productCode2SnapshotId map[string]string) error\n\n\tGetProjectConfig(ctx context.Context, filter entity.Filter) (*protocol.ProjectConfig, error)\n\tListProjectConfigs(ctx context.Context, filter entity.Filter) ([]*protocol.ProjectConfig, int64, error)\n\tDeleteProjectConfig(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go",
        "code_start_line": 25,
        "code_end_line": 27,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/pkg/protocol/projectconfig.go",
        "code_start_line": 71,
        "code_end_line": 76,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tYunapiBaseParam\n\tProductCode     string                `json:\"ProductCode\" validate:\"required\"`\n\tResources       []*ResourceItem       `json:\"Resources\" validate:\"required\"`\n\tPolicyTemplates []*PolicyTemplateItem `json:\"PolicyTemplates\" validate:\"required\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 36,
        "code_end_line": 39,
        "code_key": "ServceIDDetail",
        "code_value": "type ServceIDDetail struct {\n\tRegion   string `json:\"Region\"`\n\tEndpoint string `json:\"Endpoint\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/api__project.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go:39:133:CreateProjectConfig",
    "orm_code": "func (c *ProjectConfig) CreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam,\n\tscope string, serviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (\n\t*protocol.ProjectConfig, error) {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tfor _, resource := range projectConfig.Resources {\n\t\t\t// basic\n\t\t\tvar getInstancesActionBytes []byte\n\t\t\tif resource != nil &&\n\t\t\t\tresource.GetInstancesAction != nil &&\n\t\t\t\tresource.GetInstancesAction.Version != \"\" && resource.GetInstancesAction.Action != \"\" {\n\t\t\t\tif getInstancesActionBytes, err = json.Marshal(resource.GetInstancesAction); err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\tbillingProductCode := resource.BillingProductCode\n\t\t\tif billingProductCode == \"\" && resource.AccessType == entity.ACCESSTYPE_LOCAL {\n\t\t\t\tbillingProductCode = \"p_\" + resource.ServiceType + strings.ToLower(resource.ResourceType)\n\t\t\t}\n\t\t\tif _, err = createProductBasicInfoInTx(tx, &entity.ProductBasicInfo{\n\t\t\t\tProduct:            projectConfig.ProductCode,\n\t\t\t\tProductCode:        billingProductCode,\n\t\t\t\tServiceType:        resource.ServiceType,\n\t\t\t\tResourceType:       resource.ResourceType,\n\t\t\t\tAccessType:         resource.AccessType,\n\t\t\t\tGetInstancesAction: string(getInstancesActionBytes),\n\t\t\t\tPermissionUser:     projectConfig.UserId,\n\t\t\t\tVersion:            projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:           projectConfig.Platform,\n\t\t\t\tCreatorName:        projectConfig.UserId,\n\t\t\t\tUpdateName:         projectConfig.UserId,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tfor _, subscription := range resource.Subscriptions {\n\t\t\t\t// subscription\n\t\t\t\tnewSubscription := &entity.ProductSubscription{\n\t\t\t\t\tServiceType:  resource.ServiceType,\n\t\t\t\t\tProduct:      projectConfig.ProductCode,\n\t\t\t\t\tResourceType: resource.ResourceType,\n\t\t\t\t\tServiceID:    subscription.ServiceID,\n\t\t\t\t\tGitUrl:       subscription.GitUrl,\n\t\t\t\t\tVersion:      projectConfig.ReleaseVersion,\n\t\t\t\t\tPlatform:     projectConfig.Platform,\n\t\t\t\t}\n\t\t\t\t// 极光本地直接保存serviceid，特定环境需要根据pajero解析serviceid拿到endpoint\n\t\t\t\tif pajeroAddr != \"\" {\n\t\t\t\t\t// 只添加在pajero中能查到地址的serviceid\n\t\t\t\t\tif details, ok := serviceID2Detail[subscription.ServiceID]; ok {\n\t\t\t\t\t\tfor _, detail := range details {\n\t\t\t\t\t\t\tnewSubscription.Name = strings.Join([]string{projectConfig.ProductCode,\n\t\t\t\t\t\t\t\tresource.ServiceType, resource.ResourceType, detail.Region}, \"-\")\n\t\t\t\t\t\t\tnewSubscription.Endpoint = detail.Endpoint\n\t\t\t\t\t\t\tnewSubscription.Region = detail.Region\n\t\t\t\t\t\t\tif _, err = createProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif _, err = createProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// policytemplate\n\t\tfor _, policyTemplate := range projectConfig.PolicyTemplates {\n\t\t\tvar descriptionBytes []byte\n\t\t\tif descriptionBytes, err = json.Marshal(policyTemplate.PolicyTemplateDescI18n); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tdescription, _ := policyTemplate.PolicyTemplateDescI18n[utils.LanguageZhCN]\n\t\t\tvar policyTemplateDocBytes []byte\n\t\t\tif policyTemplateDocBytes, err = json.Marshal(policyTemplate.PolicyTemplateDoc); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif _, err = createProductPolicyTemplateInTx(tx, &entity.ProductPolicyTemplate{\n\t\t\t\tProduct:           projectConfig.ProductCode,\n\t\t\t\tPolicyTplName:     policyTemplate.PolicyTemplateName,\n\t\t\t\tPrefixInCam:       prefixInCam + policyTemplate.PolicyTemplateName,\n\t\t\t\tDescription:       description,\n\t\t\t\tPolicyDocTpl:      string(policyTemplateDocBytes),\n\t\t\t\tScope:             scope,\n\t\t\t\tRemark:            string(descriptionBytes),\n\t\t\t\tPolicyTplDescI18n: string(descriptionBytes),\n\t\t\t\tVersion:           projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:          projectConfig.Platform,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t\treturn\n\t})\n\treturn projectConfig, err\n}",
    "caller": "func (p *ProjectConfig) CreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig) (\n\t*protocol.ProjectConfig, error) {\n\t_, cnt, err := p.basicInfoStore.ListProductBasicInfos(ctx,\n\t\tentity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform, projectConfig.ProductCode, \"\"))\n\tif err != nil {\n\t\treturn nil, err\n\t} else if cnt > 0 {\n\t\treturn nil, utils.ErrProductConfigExist\n\t}\n\tserviceID2Detail := make(map[string][]entity.ServceIDDetail)\n\t// 极光本地直接保存serviceid，特定环境需要根据pajero解析serviceid拿到endpoint\n\tif p.cfg.Apps.ProjectConfig.PajeroAddr != \"\" {\n\t\tserviceID2Detail, err = parseServiceIDFromPajero(ctx, p.cfg, projectConfig)\n\t\tif err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t}\n\tres, err := p.projectConfigStore.CreateProjectConfig(ctx, projectConfig, p.cfg.Apps.ProjectConfig.PrefixInCam,\n\t\tp.cfg.Apps.ProjectConfig.Scope, serviceID2Detail, p.cfg.Apps.ProjectConfig.PajeroAddr)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn res, nil\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "pajeroAddr为空或serviceID存在于pajero中",
            "sql": "INSERT INTO ProductBasicInfoTable (created_at, updated_at, product, product_code, service_type, resource_type, access_type, get_instances_action, permission_user, version, platform, creator_name, update_name, state, snapshot_id, is_seen) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?, 1);"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "pajeroAddr为空",
            "sql": "INSERT INTO ProductSubscriptionTable (created_at, updated_at, name, service_type, region, resource_prefix, endpoint, product, resource_type, service_id, git_url, version, platform, snapshot_id, is_seen) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 1);"
          },
          {
            "scenario": "pajeroAddr不为空且serviceID存在于pajero中",
            "sql": "INSERT INTO ProductSubscriptionTable (created_at, updated_at, name, service_type, region, resource_prefix, endpoint, product, resource_type, service_id, git_url, version, platform, snapshot_id, is_seen) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 1);"
          }
        ]
      },
      "INSERT INTO ProductPolicyTemplateTable (created_at, updated_at, product, policy_tpl_name, prefix_in_cam, description, policy_doc_tpl, scope, remark, policy_tpl_desc_i18n, version, platform, snapshot_id, is_seen) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 1);"
    ],
    "sql_types": [
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT",
      "INSERT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/basicinfo.go",
        "code_start_line": 10,
        "code_end_line": 17,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo interface {\n\tListProductBasicInfos(ctx context.Context, filter entity.Filter) ([]*entity.ProductBasicInfo, int64, error)\n\tCreateProductBasicInfo(ctx context.Context, productBasicInfo *entity.ProductBasicInfo) (*entity.ProductBasicInfo, error)\n\tModifyProductBasicInfo(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductBasicInfo(ctx context.Context, filter entity.Filter) (*entity.ProductBasicInfo, error)\n\tDeleteProductBasicInfo(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 21,
        "code_end_line": 39,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tID                 uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt          time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt          time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct            string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_product;column:product;type:varchar(32);default:null\"`\n\tProductCode        string    `gorm:\"index:idx_code;column:product_code;type:varchar(32);default:null\"`\n\tServiceType        string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_service;column:service_type;type:varchar(32);default:null\"`\n\tResourceType       string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_resource_type;column:resource_type;type:varchar(32);default:null\"`\n\tAccessType         string    `gorm:\"index:idx_access_type;column:access_type;type:varchar(32);default:null\"`\n\tPermissionUser     string    `gorm:\"column:permission_user;type:text;default:null\"`\n\tGetInstancesAction string    `gorm:\"column:get_instances_action;type:text;default:null\"`\n\tVersion            string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform           string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tState              int       `gorm:\"column:state;type:tinyint(4);default:0\"` // 0 未合流，1 已合流\n\tSnapshotId         string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen             int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n\tCreatorName        string    `gorm:\"column:creator_name;type:varchar(128);default:null\"`\n\tUpdateName         string    `gorm:\"column:update_name;type:varchar(128);default:null\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 42,
        "code_end_line": 44,
        "code_key": "TableName",
        "code_value": "func (r *ProductBasicInfo) TableName() string {\n\treturn ProductBasicInfoTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/basicinfo.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/subscription.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription interface {\n\tListProductSubscriptions(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductSubscription, int64, error)\n\tCreateProductSubscription(ctx context.Context,\n\t\tproductSubscription *entity.ProductSubscription) (*entity.ProductSubscription, error)\n\n\tGetProductSubscription(ctx context.Context, filter entity.Filter) (*entity.ProductSubscription, error)\n\tDeleteProductSubscription(ctx context.Context, filter entity.Filter) error\n\tModifyProductSubscription(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 11,
        "code_end_line": 28,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription struct {\n\tID             uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt      time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt      time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tName           string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:name;type:varchar(32);default:null\"`\n\tServiceType    string    `gorm:\"column:service_type;type:text;default:null\"`\n\tRegion         string    `gorm:\"column:region;type:varchar(16);default:null\"`\n\tResourcePrefix string    `gorm:\"column:resource_prefix;type:varchar(16);default:null\"`\n\tEndpoint       string    `gorm:\"column:endpoint;type:varchar(256);default:null\"`\n\tProduct        string    `gorm:\"column:product;type:varchar(32);default:null\"`\n\tResourceType   string    `gorm:\"column:resource_type;type:varchar(32);default:null\"`\n\tServiceID      string    `gorm:\"column:service_id;type:varchar(1024);default:null\"`\n\tGitUrl         string    `gorm:\"column:git_url;type:varchar(4096);default:null\"`\n\tVersion        string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform       string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId     string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen         int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (r *ProductSubscription) TableName() string {\n\treturn ProductSubscriptionTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/policytemplate.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate interface {\n\tListProductPolicyTemplates(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductPolicyTemplate, int64, error)\n\tCreateProductPolicyTemplate(ctx context.Context,\n\t\tpolicyTemplate *entity.ProductPolicyTemplate) (*entity.ProductPolicyTemplate, error)\n\tModifyProductPolicyTemplate(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductPolicyTemplate(ctx context.Context, filter entity.Filter) (*entity.ProductPolicyTemplate, error)\n\tDeleteProductPolicyTemplate(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 13,
        "code_end_line": 29,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tID                uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt         time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt         time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct           string    `gorm:\"column:product;type:varchar(16);default:null\"`\n\tPolicyTplName     string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:policy_tpl_name;type:varchar(200);default:null\"`\n\tPrefixInCam       string    `gorm:\"column:prefix_in_cam;type:varchar(128);default:null\"`\n\tDescription       string    `gorm:\"column:description;type:varchar(512);default:null\"`\n\tPolicyDocTpl      string    `gorm:\"column:policy_doc_tpl;type:text;default:null\"`\n\tScope             string    `gorm:\"column:scope;type:varchar(16);default:null\"`\n\tRemark            string    `gorm:\"column:remark;type:text;default:null\"`\n\tPolicyTplDescI18n string    `gorm:\"column:policy_tpl_desc_i18n;type:text;default:null\"`\n\tVersion           string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform          string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId        string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen            int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 32,
        "code_end_line": 34,
        "code_key": "TableName",
        "code_value": "func (r *ProductPolicyTemplate) TableName() string {\n\treturn ProductPolicyTemplateTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/policytemplate.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/service/projectconfig.go",
        "code_start_line": 16,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tbasicInfoStore      repository.ProductBasicInfo\n\tpolicyTemplateStore repository.ProductPolicyTemplate\n\tsubscriptionStore   repository.ProductSubscription\n\tprojectConfigStore  repository.ProjectConfig\n\tcfg                 *config.Config\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/projectconfig.go",
        "code_start_line": 11,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig interface {\n\tCreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tCreateProjectConfigSnapshot(ctx context.Context,\n\t\tversion, platform string, productCode2SnapshotId map[string]string) error\n\n\tGetProjectConfig(ctx context.Context, filter entity.Filter) (*protocol.ProjectConfig, error)\n\tListProjectConfigs(ctx context.Context, filter entity.Filter) ([]*protocol.ProjectConfig, int64, error)\n\tDeleteProjectConfig(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go",
        "code_start_line": 25,
        "code_end_line": 27,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/pkg/protocol/projectconfig.go",
        "code_start_line": 71,
        "code_end_line": 76,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tYunapiBaseParam\n\tProductCode     string                `json:\"ProductCode\" validate:\"required\"`\n\tResources       []*ResourceItem       `json:\"Resources\" validate:\"required\"`\n\tPolicyTemplates []*PolicyTemplateItem `json:\"PolicyTemplates\" validate:\"required\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 36,
        "code_end_line": 39,
        "code_key": "ServceIDDetail",
        "code_value": "type ServceIDDetail struct {\n\tRegion   string `json:\"Region\"`\n\tEndpoint string `json:\"Endpoint\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/api__project.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go:39:133:CreateProjectConfig",
    "orm_code": "func (c *ProjectConfig) CreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam,\n\tscope string, serviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (\n\t*protocol.ProjectConfig, error) {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tfor _, resource := range projectConfig.Resources {\n\t\t\t// basic\n\t\t\tvar getInstancesActionBytes []byte\n\t\t\tif resource != nil &&\n\t\t\t\tresource.GetInstancesAction != nil &&\n\t\t\t\tresource.GetInstancesAction.Version != \"\" && resource.GetInstancesAction.Action != \"\" {\n\t\t\t\tif getInstancesActionBytes, err = json.Marshal(resource.GetInstancesAction); err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\tbillingProductCode := resource.BillingProductCode\n\t\t\tif billingProductCode == \"\" && resource.AccessType == entity.ACCESSTYPE_LOCAL {\n\t\t\t\tbillingProductCode = \"p_\" + resource.ServiceType + strings.ToLower(resource.ResourceType)\n\t\t\t}\n\t\t\tif _, err = createProductBasicInfoInTx(tx, &entity.ProductBasicInfo{\n\t\t\t\tProduct:            projectConfig.ProductCode,\n\t\t\t\tProductCode:        billingProductCode,\n\t\t\t\tServiceType:        resource.ServiceType,\n\t\t\t\tResourceType:       resource.ResourceType,\n\t\t\t\tAccessType:         resource.AccessType,\n\t\t\t\tGetInstancesAction: string(getInstancesActionBytes),\n\t\t\t\tPermissionUser:     projectConfig.UserId,\n\t\t\t\tVersion:            projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:           projectConfig.Platform,\n\t\t\t\tCreatorName:        projectConfig.UserId,\n\t\t\t\tUpdateName:         projectConfig.UserId,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tfor _, subscription := range resource.Subscriptions {\n\t\t\t\t// subscription\n\t\t\t\tnewSubscription := &entity.ProductSubscription{\n\t\t\t\t\tServiceType:  resource.ServiceType,\n\t\t\t\t\tProduct:      projectConfig.ProductCode,\n\t\t\t\t\tResourceType: resource.ResourceType,\n\t\t\t\t\tServiceID:    subscription.ServiceID,\n\t\t\t\t\tGitUrl:       subscription.GitUrl,\n\t\t\t\t\tVersion:      projectConfig.ReleaseVersion,\n\t\t\t\t\tPlatform:     projectConfig.Platform,\n\t\t\t\t}\n\t\t\t\t// 极光本地直接保存serviceid，特定环境需要根据pajero解析serviceid拿到endpoint\n\t\t\t\tif pajeroAddr != \"\" {\n\t\t\t\t\t// 只添加在pajero中能查到地址的serviceid\n\t\t\t\t\tif details, ok := serviceID2Detail[subscription.ServiceID]; ok {\n\t\t\t\t\t\tfor _, detail := range details {\n\t\t\t\t\t\t\tnewSubscription.Name = strings.Join([]string{projectConfig.ProductCode,\n\t\t\t\t\t\t\t\tresource.ServiceType, resource.ResourceType, detail.Region}, \"-\")\n\t\t\t\t\t\t\tnewSubscription.Endpoint = detail.Endpoint\n\t\t\t\t\t\t\tnewSubscription.Region = detail.Region\n\t\t\t\t\t\t\tif _, err = createProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif _, err = createProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// policytemplate\n\t\tfor _, policyTemplate := range projectConfig.PolicyTemplates {\n\t\t\tvar descriptionBytes []byte\n\t\t\tif descriptionBytes, err = json.Marshal(policyTemplate.PolicyTemplateDescI18n); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tdescription, _ := policyTemplate.PolicyTemplateDescI18n[utils.LanguageZhCN]\n\t\t\tvar policyTemplateDocBytes []byte\n\t\t\tif policyTemplateDocBytes, err = json.Marshal(policyTemplate.PolicyTemplateDoc); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif _, err = createProductPolicyTemplateInTx(tx, &entity.ProductPolicyTemplate{\n\t\t\t\tProduct:           projectConfig.ProductCode,\n\t\t\t\tPolicyTplName:     policyTemplate.PolicyTemplateName,\n\t\t\t\tPrefixInCam:       prefixInCam + policyTemplate.PolicyTemplateName,\n\t\t\t\tDescription:       description,\n\t\t\t\tPolicyDocTpl:      string(policyTemplateDocBytes),\n\t\t\t\tScope:             scope,\n\t\t\t\tRemark:            string(descriptionBytes),\n\t\t\t\tPolicyTplDescI18n: string(descriptionBytes),\n\t\t\t\tVersion:           projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:          projectConfig.Platform,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t\treturn\n\t})\n\treturn projectConfig, err\n}",
    "caller": "func (c *ProjectConfig) CreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam,\n\tscope string, serviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (\n\t*protocol.ProjectConfig, error) {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tfor _, resource := range projectConfig.Resources {\n\t\t\t// basic\n\t\t\tvar getInstancesActionBytes []byte\n\t\t\tif resource != nil &&\n\t\t\t\tresource.GetInstancesAction != nil &&\n\t\t\t\tresource.GetInstancesAction.Version != \"\" && resource.GetInstancesAction.Action != \"\" {\n\t\t\t\tif getInstancesActionBytes, err = json.Marshal(resource.GetInstancesAction); err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\tbillingProductCode := resource.BillingProductCode\n\t\t\tif billingProductCode == \"\" && resource.AccessType == entity.ACCESSTYPE_LOCAL {\n\t\t\t\tbillingProductCode = \"p_\" + resource.ServiceType + strings.ToLower(resource.ResourceType)\n\t\t\t}\n\t\t\tif _, err = createProductBasicInfoInTx(tx, &entity.ProductBasicInfo{\n\t\t\t\tProduct:            projectConfig.ProductCode,\n\t\t\t\tProductCode:        billingProductCode,\n\t\t\t\tServiceType:        resource.ServiceType,\n\t\t\t\tResourceType:       resource.ResourceType,\n\t\t\t\tAccessType:         resource.AccessType,\n\t\t\t\tGetInstancesAction: string(getInstancesActionBytes),\n\t\t\t\tPermissionUser:     projectConfig.UserId,\n\t\t\t\tVersion:            projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:           projectConfig.Platform,\n\t\t\t\tCreatorName:        projectConfig.UserId,\n\t\t\t\tUpdateName:         projectConfig.UserId,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tfor _, subscription := range resource.Subscriptions {\n\t\t\t\t// subscription\n\t\t\t\tnewSubscription := &entity.ProductSubscription{\n\t\t\t\t\tServiceType:  resource.ServiceType,\n\t\t\t\t\tProduct:      projectConfig.ProductCode,\n\t\t\t\t\tResourceType: resource.ResourceType,\n\t\t\t\t\tServiceID:    subscription.ServiceID,\n\t\t\t\t\tGitUrl:       subscription.GitUrl,\n\t\t\t\t\tVersion:      projectConfig.ReleaseVersion,\n\t\t\t\t\tPlatform:     projectConfig.Platform,\n\t\t\t\t}\n\t\t\t\t// 极光本地直接保存serviceid，特定环境需要根据pajero解析serviceid拿到endpoint\n\t\t\t\tif pajeroAddr != \"\" {\n\t\t\t\t\t// 只添加在pajero中能查到地址的serviceid\n\t\t\t\t\tif details, ok := serviceID2Detail[subscription.ServiceID]; ok {\n\t\t\t\t\t\tfor _, detail := range details {\n\t\t\t\t\t\t\tnewSubscription.Name = strings.Join([]string{projectConfig.ProductCode,\n\t\t\t\t\t\t\t\tresource.ServiceType, resource.ResourceType, detail.Region}, \"-\")\n\t\t\t\t\t\t\tnewSubscription.Endpoint = detail.Endpoint\n\t\t\t\t\t\t\tnewSubscription.Region = detail.Region\n\t\t\t\t\t\t\tif _, err = createProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif _, err = createProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// policytemplate\n\t\tfor _, policyTemplate := range projectConfig.PolicyTemplates {\n\t\t\tvar descriptionBytes []byte\n\t\t\tif descriptionBytes, err = json.Marshal(policyTemplate.PolicyTemplateDescI18n); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tdescription, _ := policyTemplate.PolicyTemplateDescI18n[utils.LanguageZhCN]\n\t\t\tvar policyTemplateDocBytes []byte\n\t\t\tif policyTemplateDocBytes, err = json.Marshal(policyTemplate.PolicyTemplateDoc); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif _, err = createProductPolicyTemplateInTx(tx, &entity.ProductPolicyTemplate{\n\t\t\t\tProduct:           projectConfig.ProductCode,\n\t\t\t\tPolicyTplName:     policyTemplate.PolicyTemplateName,\n\t\t\t\tPrefixInCam:       prefixInCam + policyTemplate.PolicyTemplateName,\n\t\t\t\tDescription:       description,\n\t\t\t\tPolicyDocTpl:      string(policyTemplateDocBytes),\n\t\t\t\tScope:             scope,\n\t\t\t\tRemark:            string(descriptionBytes),\n\t\t\t\tPolicyTplDescI18n: string(descriptionBytes),\n\t\t\t\tVersion:           projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:          projectConfig.Platform,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t\treturn\n\t})\n\treturn projectConfig, err\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/basicinfo.go",
        "code_start_line": 10,
        "code_end_line": 17,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo interface {\n\tListProductBasicInfos(ctx context.Context, filter entity.Filter) ([]*entity.ProductBasicInfo, int64, error)\n\tCreateProductBasicInfo(ctx context.Context, productBasicInfo *entity.ProductBasicInfo) (*entity.ProductBasicInfo, error)\n\tModifyProductBasicInfo(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductBasicInfo(ctx context.Context, filter entity.Filter) (*entity.ProductBasicInfo, error)\n\tDeleteProductBasicInfo(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 21,
        "code_end_line": 39,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tID                 uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt          time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt          time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct            string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_product;column:product;type:varchar(32);default:null\"`\n\tProductCode        string    `gorm:\"index:idx_code;column:product_code;type:varchar(32);default:null\"`\n\tServiceType        string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_service;column:service_type;type:varchar(32);default:null\"`\n\tResourceType       string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_resource_type;column:resource_type;type:varchar(32);default:null\"`\n\tAccessType         string    `gorm:\"index:idx_access_type;column:access_type;type:varchar(32);default:null\"`\n\tPermissionUser     string    `gorm:\"column:permission_user;type:text;default:null\"`\n\tGetInstancesAction string    `gorm:\"column:get_instances_action;type:text;default:null\"`\n\tVersion            string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform           string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tState              int       `gorm:\"column:state;type:tinyint(4);default:0\"` // 0 未合流，1 已合流\n\tSnapshotId         string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen             int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n\tCreatorName        string    `gorm:\"column:creator_name;type:varchar(128);default:null\"`\n\tUpdateName         string    `gorm:\"column:update_name;type:varchar(128);default:null\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 42,
        "code_end_line": 44,
        "code_key": "TableName",
        "code_value": "func (r *ProductBasicInfo) TableName() string {\n\treturn ProductBasicInfoTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/basicinfo.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/subscription.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription interface {\n\tListProductSubscriptions(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductSubscription, int64, error)\n\tCreateProductSubscription(ctx context.Context,\n\t\tproductSubscription *entity.ProductSubscription) (*entity.ProductSubscription, error)\n\n\tGetProductSubscription(ctx context.Context, filter entity.Filter) (*entity.ProductSubscription, error)\n\tDeleteProductSubscription(ctx context.Context, filter entity.Filter) error\n\tModifyProductSubscription(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 11,
        "code_end_line": 28,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription struct {\n\tID             uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt      time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt      time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tName           string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:name;type:varchar(32);default:null\"`\n\tServiceType    string    `gorm:\"column:service_type;type:text;default:null\"`\n\tRegion         string    `gorm:\"column:region;type:varchar(16);default:null\"`\n\tResourcePrefix string    `gorm:\"column:resource_prefix;type:varchar(16);default:null\"`\n\tEndpoint       string    `gorm:\"column:endpoint;type:varchar(256);default:null\"`\n\tProduct        string    `gorm:\"column:product;type:varchar(32);default:null\"`\n\tResourceType   string    `gorm:\"column:resource_type;type:varchar(32);default:null\"`\n\tServiceID      string    `gorm:\"column:service_id;type:varchar(1024);default:null\"`\n\tGitUrl         string    `gorm:\"column:git_url;type:varchar(4096);default:null\"`\n\tVersion        string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform       string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId     string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen         int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (r *ProductSubscription) TableName() string {\n\treturn ProductSubscriptionTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/policytemplate.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate interface {\n\tListProductPolicyTemplates(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductPolicyTemplate, int64, error)\n\tCreateProductPolicyTemplate(ctx context.Context,\n\t\tpolicyTemplate *entity.ProductPolicyTemplate) (*entity.ProductPolicyTemplate, error)\n\tModifyProductPolicyTemplate(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductPolicyTemplate(ctx context.Context, filter entity.Filter) (*entity.ProductPolicyTemplate, error)\n\tDeleteProductPolicyTemplate(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 13,
        "code_end_line": 29,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tID                uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt         time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt         time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct           string    `gorm:\"column:product;type:varchar(16);default:null\"`\n\tPolicyTplName     string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:policy_tpl_name;type:varchar(200);default:null\"`\n\tPrefixInCam       string    `gorm:\"column:prefix_in_cam;type:varchar(128);default:null\"`\n\tDescription       string    `gorm:\"column:description;type:varchar(512);default:null\"`\n\tPolicyDocTpl      string    `gorm:\"column:policy_doc_tpl;type:text;default:null\"`\n\tScope             string    `gorm:\"column:scope;type:varchar(16);default:null\"`\n\tRemark            string    `gorm:\"column:remark;type:text;default:null\"`\n\tPolicyTplDescI18n string    `gorm:\"column:policy_tpl_desc_i18n;type:text;default:null\"`\n\tVersion           string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform          string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId        string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen            int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 32,
        "code_end_line": 34,
        "code_key": "TableName",
        "code_value": "func (r *ProductPolicyTemplate) TableName() string {\n\treturn ProductPolicyTemplateTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/policytemplate.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/service/projectconfig.go",
        "code_start_line": 16,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tbasicInfoStore      repository.ProductBasicInfo\n\tpolicyTemplateStore repository.ProductPolicyTemplate\n\tsubscriptionStore   repository.ProductSubscription\n\tprojectConfigStore  repository.ProjectConfig\n\tcfg                 *config.Config\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/projectconfig.go",
        "code_start_line": 11,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig interface {\n\tCreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tCreateProjectConfigSnapshot(ctx context.Context,\n\t\tversion, platform string, productCode2SnapshotId map[string]string) error\n\n\tGetProjectConfig(ctx context.Context, filter entity.Filter) (*protocol.ProjectConfig, error)\n\tListProjectConfigs(ctx context.Context, filter entity.Filter) ([]*protocol.ProjectConfig, int64, error)\n\tDeleteProjectConfig(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go",
        "code_start_line": 25,
        "code_end_line": 27,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/pkg/protocol/projectconfig.go",
        "code_start_line": 71,
        "code_end_line": 76,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tYunapiBaseParam\n\tProductCode     string                `json:\"ProductCode\" validate:\"required\"`\n\tResources       []*ResourceItem       `json:\"Resources\" validate:\"required\"`\n\tPolicyTemplates []*PolicyTemplateItem `json:\"PolicyTemplates\" validate:\"required\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 36,
        "code_end_line": 39,
        "code_key": "ServceIDDetail",
        "code_value": "type ServceIDDetail struct {\n\tRegion   string `json:\"Region\"`\n\tEndpoint string `json:\"Endpoint\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/api__project.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go:140:270:ModifyProjectConfig",
    "orm_code": "func (c *ProjectConfig) ModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam,\n\tscope string, serviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (\n\t*protocol.ProjectConfig, error) {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tvar productBasicInfo *entity.ProductBasicInfo\n\t\tvar validProductBasicInfoIds []uint\n\t\tvar productSubscription *entity.ProductSubscription\n\t\tvar validProductSubscriptionIds []uint\n\t\tfor _, resource := range projectConfig.Resources {\n\t\t\t// basic\n\t\t\tvar getInstancesActionBytes []byte\n\t\t\tif resource != nil &&\n\t\t\t\tresource.GetInstancesAction != nil &&\n\t\t\t\tresource.GetInstancesAction.Version != \"\" && resource.GetInstancesAction.Action != \"\" {\n\t\t\t\tif getInstancesActionBytes, err = json.Marshal(resource.GetInstancesAction); err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\tbillingProductCode := resource.BillingProductCode\n\t\t\tif billingProductCode == \"\" && resource.AccessType == entity.ACCESSTYPE_LOCAL {\n\t\t\t\tbillingProductCode = \"p_\" + resource.ServiceType + strings.ToLower(resource.ResourceType)\n\t\t\t}\n\t\t\tif productBasicInfo, err = modifyProductBasicInfoInTx(tx, &entity.ProductBasicInfo{\n\t\t\t\tProduct:            projectConfig.ProductCode,\n\t\t\t\tProductCode:        billingProductCode,\n\t\t\t\tServiceType:        resource.ServiceType,\n\t\t\t\tResourceType:       resource.ResourceType,\n\t\t\t\tAccessType:         resource.AccessType,\n\t\t\t\tGetInstancesAction: string(getInstancesActionBytes),\n\t\t\t\tVersion:            projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:           projectConfig.Platform,\n\t\t\t\tState:              entity.STATE_DEV,\n\t\t\t\tUpdateName:         projectConfig.UserId,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tvalidProductBasicInfoIds = append(validProductBasicInfoIds, productBasicInfo.ID)\n\t\t\tfor _, subscription := range resource.Subscriptions {\n\t\t\t\t// subscription\n\t\t\t\tnewSubscription := &entity.ProductSubscription{\n\t\t\t\t\tServiceType:  resource.ServiceType,\n\t\t\t\t\tProduct:      projectConfig.ProductCode,\n\t\t\t\t\tResourceType: resource.ResourceType,\n\t\t\t\t\tServiceID:    subscription.ServiceID,\n\t\t\t\t\tGitUrl:       subscription.GitUrl,\n\t\t\t\t\tVersion:      projectConfig.ReleaseVersion,\n\t\t\t\t\tPlatform:     projectConfig.Platform,\n\t\t\t\t}\n\t\t\t\t// 极光本地直接保存serviceid，特定环境需要根据pajero解析serviceid拿到endpoint\n\t\t\t\tif pajeroAddr != \"\" {\n\t\t\t\t\t// 只添加在pajero中能查到地址的serviceid\n\t\t\t\t\tif details, ok := serviceID2Detail[subscription.ServiceID]; ok {\n\t\t\t\t\t\tfor _, detail := range details {\n\t\t\t\t\t\t\tnewSubscription.Name = strings.Join([]string{projectConfig.ProductCode,\n\t\t\t\t\t\t\t\tresource.ServiceType, resource.ResourceType, detail.Region}, \"-\")\n\t\t\t\t\t\t\tnewSubscription.Endpoint = detail.Endpoint\n\t\t\t\t\t\t\tnewSubscription.Region = detail.Region\n\t\t\t\t\t\t\tif productSubscription, err = modifyProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tvalidProductSubscriptionIds = append(validProductSubscriptionIds, productSubscription.ID)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif productSubscription, err = modifyProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\tvalidProductSubscriptionIds = append(validProductSubscriptionIds, productSubscription.ID)\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\t\t// 可重入清理\n\t\tfilter := entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductBasicInfoIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductBasicInfoIds\n\t\t}\n\t\tif err = deleteProductBasicInfoInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\tfilter = entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductSubscriptionIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductSubscriptionIds\n\t\t}\n\t\tif err = deleteProductSubscriptionInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\tvar productPolicyTemplate *entity.ProductPolicyTemplate\n\t\tvar validProductPolicyTemplateIds []uint\n\t\t// policytemplate\n\t\tfor _, policyTemplate := range projectConfig.PolicyTemplates {\n\t\t\tvar descriptionBytes []byte\n\t\t\tif descriptionBytes, err = json.Marshal(policyTemplate.PolicyTemplateDescI18n); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tdescription, _ := policyTemplate.PolicyTemplateDescI18n[utils.LanguageZhCN]\n\t\t\tvar policyTemplateDocBytes []byte\n\t\t\tif policyTemplateDocBytes, err = json.Marshal(policyTemplate.PolicyTemplateDoc); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif productPolicyTemplate, err = modifyProductPolicyTemplateInTx(tx, &entity.ProductPolicyTemplate{\n\t\t\t\tProduct:           projectConfig.ProductCode,\n\t\t\t\tPolicyTplName:     policyTemplate.PolicyTemplateName,\n\t\t\t\tPrefixInCam:       prefixInCam + policyTemplate.PolicyTemplateName,\n\t\t\t\tDescription:       description,\n\t\t\t\tPolicyDocTpl:      string(policyTemplateDocBytes),\n\t\t\t\tScope:             scope,\n\t\t\t\tRemark:            string(descriptionBytes),\n\t\t\t\tPolicyTplDescI18n: string(descriptionBytes),\n\t\t\t\tVersion:           projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:          projectConfig.Platform,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tvalidProductPolicyTemplateIds = append(validProductPolicyTemplateIds, productPolicyTemplate.ID)\n\t\t}\n\t\t// 可重入清理\n\t\tfilter = entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductPolicyTemplateIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductPolicyTemplateIds\n\t\t}\n\t\tif err = deleteProductPolicyTemplatInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\treturn\n\t})\n\treturn projectConfig, err\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/basicinfo.go",
        "code_start_line": 10,
        "code_end_line": 17,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo interface {\n\tListProductBasicInfos(ctx context.Context, filter entity.Filter) ([]*entity.ProductBasicInfo, int64, error)\n\tCreateProductBasicInfo(ctx context.Context, productBasicInfo *entity.ProductBasicInfo) (*entity.ProductBasicInfo, error)\n\tModifyProductBasicInfo(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductBasicInfo(ctx context.Context, filter entity.Filter) (*entity.ProductBasicInfo, error)\n\tDeleteProductBasicInfo(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 21,
        "code_end_line": 39,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tID                 uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt          time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt          time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct            string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_product;column:product;type:varchar(32);default:null\"`\n\tProductCode        string    `gorm:\"index:idx_code;column:product_code;type:varchar(32);default:null\"`\n\tServiceType        string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_service;column:service_type;type:varchar(32);default:null\"`\n\tResourceType       string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_resource_type;column:resource_type;type:varchar(32);default:null\"`\n\tAccessType         string    `gorm:\"index:idx_access_type;column:access_type;type:varchar(32);default:null\"`\n\tPermissionUser     string    `gorm:\"column:permission_user;type:text;default:null\"`\n\tGetInstancesAction string    `gorm:\"column:get_instances_action;type:text;default:null\"`\n\tVersion            string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform           string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tState              int       `gorm:\"column:state;type:tinyint(4);default:0\"` // 0 未合流，1 已合流\n\tSnapshotId         string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen             int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n\tCreatorName        string    `gorm:\"column:creator_name;type:varchar(128);default:null\"`\n\tUpdateName         string    `gorm:\"column:update_name;type:varchar(128);default:null\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 42,
        "code_end_line": 44,
        "code_key": "TableName",
        "code_value": "func (r *ProductBasicInfo) TableName() string {\n\treturn ProductBasicInfoTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/basicinfo.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/subscription.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription interface {\n\tListProductSubscriptions(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductSubscription, int64, error)\n\tCreateProductSubscription(ctx context.Context,\n\t\tproductSubscription *entity.ProductSubscription) (*entity.ProductSubscription, error)\n\n\tGetProductSubscription(ctx context.Context, filter entity.Filter) (*entity.ProductSubscription, error)\n\tDeleteProductSubscription(ctx context.Context, filter entity.Filter) error\n\tModifyProductSubscription(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 11,
        "code_end_line": 28,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription struct {\n\tID             uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt      time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt      time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tName           string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:name;type:varchar(32);default:null\"`\n\tServiceType    string    `gorm:\"column:service_type;type:text;default:null\"`\n\tRegion         string    `gorm:\"column:region;type:varchar(16);default:null\"`\n\tResourcePrefix string    `gorm:\"column:resource_prefix;type:varchar(16);default:null\"`\n\tEndpoint       string    `gorm:\"column:endpoint;type:varchar(256);default:null\"`\n\tProduct        string    `gorm:\"column:product;type:varchar(32);default:null\"`\n\tResourceType   string    `gorm:\"column:resource_type;type:varchar(32);default:null\"`\n\tServiceID      string    `gorm:\"column:service_id;type:varchar(1024);default:null\"`\n\tGitUrl         string    `gorm:\"column:git_url;type:varchar(4096);default:null\"`\n\tVersion        string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform       string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId     string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen         int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (r *ProductSubscription) TableName() string {\n\treturn ProductSubscriptionTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/policytemplate.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate interface {\n\tListProductPolicyTemplates(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductPolicyTemplate, int64, error)\n\tCreateProductPolicyTemplate(ctx context.Context,\n\t\tpolicyTemplate *entity.ProductPolicyTemplate) (*entity.ProductPolicyTemplate, error)\n\tModifyProductPolicyTemplate(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductPolicyTemplate(ctx context.Context, filter entity.Filter) (*entity.ProductPolicyTemplate, error)\n\tDeleteProductPolicyTemplate(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 13,
        "code_end_line": 29,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tID                uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt         time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt         time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct           string    `gorm:\"column:product;type:varchar(16);default:null\"`\n\tPolicyTplName     string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:policy_tpl_name;type:varchar(200);default:null\"`\n\tPrefixInCam       string    `gorm:\"column:prefix_in_cam;type:varchar(128);default:null\"`\n\tDescription       string    `gorm:\"column:description;type:varchar(512);default:null\"`\n\tPolicyDocTpl      string    `gorm:\"column:policy_doc_tpl;type:text;default:null\"`\n\tScope             string    `gorm:\"column:scope;type:varchar(16);default:null\"`\n\tRemark            string    `gorm:\"column:remark;type:text;default:null\"`\n\tPolicyTplDescI18n string    `gorm:\"column:policy_tpl_desc_i18n;type:text;default:null\"`\n\tVersion           string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform          string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId        string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen            int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 32,
        "code_end_line": 34,
        "code_key": "TableName",
        "code_value": "func (r *ProductPolicyTemplate) TableName() string {\n\treturn ProductPolicyTemplateTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/policytemplate.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/service/projectconfig.go",
        "code_start_line": 16,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tbasicInfoStore      repository.ProductBasicInfo\n\tpolicyTemplateStore repository.ProductPolicyTemplate\n\tsubscriptionStore   repository.ProductSubscription\n\tprojectConfigStore  repository.ProjectConfig\n\tcfg                 *config.Config\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/projectconfig.go",
        "code_start_line": 11,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig interface {\n\tCreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tCreateProjectConfigSnapshot(ctx context.Context,\n\t\tversion, platform string, productCode2SnapshotId map[string]string) error\n\n\tGetProjectConfig(ctx context.Context, filter entity.Filter) (*protocol.ProjectConfig, error)\n\tListProjectConfigs(ctx context.Context, filter entity.Filter) ([]*protocol.ProjectConfig, int64, error)\n\tDeleteProjectConfig(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go",
        "code_start_line": 25,
        "code_end_line": 27,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/pkg/protocol/projectconfig.go",
        "code_start_line": 71,
        "code_end_line": 76,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tYunapiBaseParam\n\tProductCode     string                `json:\"ProductCode\" validate:\"required\"`\n\tResources       []*ResourceItem       `json:\"Resources\" validate:\"required\"`\n\tPolicyTemplates []*PolicyTemplateItem `json:\"PolicyTemplates\" validate:\"required\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 36,
        "code_end_line": 39,
        "code_key": "ServceIDDetail",
        "code_value": "type ServceIDDetail struct {\n\tRegion   string `json:\"Region\"`\n\tEndpoint string `json:\"Endpoint\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/api__project.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go:140:270:ModifyProjectConfig",
    "orm_code": "func (c *ProjectConfig) ModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam,\n\tscope string, serviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (\n\t*protocol.ProjectConfig, error) {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tvar productBasicInfo *entity.ProductBasicInfo\n\t\tvar validProductBasicInfoIds []uint\n\t\tvar productSubscription *entity.ProductSubscription\n\t\tvar validProductSubscriptionIds []uint\n\t\tfor _, resource := range projectConfig.Resources {\n\t\t\t// basic\n\t\t\tvar getInstancesActionBytes []byte\n\t\t\tif resource != nil &&\n\t\t\t\tresource.GetInstancesAction != nil &&\n\t\t\t\tresource.GetInstancesAction.Version != \"\" && resource.GetInstancesAction.Action != \"\" {\n\t\t\t\tif getInstancesActionBytes, err = json.Marshal(resource.GetInstancesAction); err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\tbillingProductCode := resource.BillingProductCode\n\t\t\tif billingProductCode == \"\" && resource.AccessType == entity.ACCESSTYPE_LOCAL {\n\t\t\t\tbillingProductCode = \"p_\" + resource.ServiceType + strings.ToLower(resource.ResourceType)\n\t\t\t}\n\t\t\tif productBasicInfo, err = modifyProductBasicInfoInTx(tx, &entity.ProductBasicInfo{\n\t\t\t\tProduct:            projectConfig.ProductCode,\n\t\t\t\tProductCode:        billingProductCode,\n\t\t\t\tServiceType:        resource.ServiceType,\n\t\t\t\tResourceType:       resource.ResourceType,\n\t\t\t\tAccessType:         resource.AccessType,\n\t\t\t\tGetInstancesAction: string(getInstancesActionBytes),\n\t\t\t\tVersion:            projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:           projectConfig.Platform,\n\t\t\t\tState:              entity.STATE_DEV,\n\t\t\t\tUpdateName:         projectConfig.UserId,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tvalidProductBasicInfoIds = append(validProductBasicInfoIds, productBasicInfo.ID)\n\t\t\tfor _, subscription := range resource.Subscriptions {\n\t\t\t\t// subscription\n\t\t\t\tnewSubscription := &entity.ProductSubscription{\n\t\t\t\t\tServiceType:  resource.ServiceType,\n\t\t\t\t\tProduct:      projectConfig.ProductCode,\n\t\t\t\t\tResourceType: resource.ResourceType,\n\t\t\t\t\tServiceID:    subscription.ServiceID,\n\t\t\t\t\tGitUrl:       subscription.GitUrl,\n\t\t\t\t\tVersion:      projectConfig.ReleaseVersion,\n\t\t\t\t\tPlatform:     projectConfig.Platform,\n\t\t\t\t}\n\t\t\t\t// 极光本地直接保存serviceid，特定环境需要根据pajero解析serviceid拿到endpoint\n\t\t\t\tif pajeroAddr != \"\" {\n\t\t\t\t\t// 只添加在pajero中能查到地址的serviceid\n\t\t\t\t\tif details, ok := serviceID2Detail[subscription.ServiceID]; ok {\n\t\t\t\t\t\tfor _, detail := range details {\n\t\t\t\t\t\t\tnewSubscription.Name = strings.Join([]string{projectConfig.ProductCode,\n\t\t\t\t\t\t\t\tresource.ServiceType, resource.ResourceType, detail.Region}, \"-\")\n\t\t\t\t\t\t\tnewSubscription.Endpoint = detail.Endpoint\n\t\t\t\t\t\t\tnewSubscription.Region = detail.Region\n\t\t\t\t\t\t\tif productSubscription, err = modifyProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tvalidProductSubscriptionIds = append(validProductSubscriptionIds, productSubscription.ID)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif productSubscription, err = modifyProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\tvalidProductSubscriptionIds = append(validProductSubscriptionIds, productSubscription.ID)\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\t\t// 可重入清理\n\t\tfilter := entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductBasicInfoIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductBasicInfoIds\n\t\t}\n\t\tif err = deleteProductBasicInfoInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\tfilter = entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductSubscriptionIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductSubscriptionIds\n\t\t}\n\t\tif err = deleteProductSubscriptionInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\tvar productPolicyTemplate *entity.ProductPolicyTemplate\n\t\tvar validProductPolicyTemplateIds []uint\n\t\t// policytemplate\n\t\tfor _, policyTemplate := range projectConfig.PolicyTemplates {\n\t\t\tvar descriptionBytes []byte\n\t\t\tif descriptionBytes, err = json.Marshal(policyTemplate.PolicyTemplateDescI18n); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tdescription, _ := policyTemplate.PolicyTemplateDescI18n[utils.LanguageZhCN]\n\t\t\tvar policyTemplateDocBytes []byte\n\t\t\tif policyTemplateDocBytes, err = json.Marshal(policyTemplate.PolicyTemplateDoc); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif productPolicyTemplate, err = modifyProductPolicyTemplateInTx(tx, &entity.ProductPolicyTemplate{\n\t\t\t\tProduct:           projectConfig.ProductCode,\n\t\t\t\tPolicyTplName:     policyTemplate.PolicyTemplateName,\n\t\t\t\tPrefixInCam:       prefixInCam + policyTemplate.PolicyTemplateName,\n\t\t\t\tDescription:       description,\n\t\t\t\tPolicyDocTpl:      string(policyTemplateDocBytes),\n\t\t\t\tScope:             scope,\n\t\t\t\tRemark:            string(descriptionBytes),\n\t\t\t\tPolicyTplDescI18n: string(descriptionBytes),\n\t\t\t\tVersion:           projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:          projectConfig.Platform,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tvalidProductPolicyTemplateIds = append(validProductPolicyTemplateIds, productPolicyTemplate.ID)\n\t\t}\n\t\t// 可重入清理\n\t\tfilter = entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductPolicyTemplateIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductPolicyTemplateIds\n\t\t}\n\t\tif err = deleteProductPolicyTemplatInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\treturn\n\t})\n\treturn projectConfig, err\n}",
    "caller": "func (p *ProjectConfigApp) ModifyProjectConfig(ctx context.Context, param *tcenterapi.BaseParam,\n\trequest *ModifyProjectConfigAPI3Req) (*ModifyProjectConfigAPI3Res, *tcenterapi.APIError) {\n\t_, err := p.projectConfigSrv.ModifyProjectConfig(ctx, request.ProjectConfig)\n\tif err != nil {\n\t\treturn nil, utils.GetApiError(err)\n\t}\n\treturn &ModifyProjectConfigAPI3Res{}, nil\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "有资源配置时修改ProductBasicInfo",
            "sql": "INSERT INTO product_basic_info (product, product_code, service_type, resource_type, access_type, get_instances_action, version, platform, state, update_name, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE product_code = ?, service_type = ?, resource_type = ?, access_type = ?, get_instances_action = ?, version = ?, platform = ?, state = ?, update_name = ?, updated_at = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "有订阅配置时修改ProductSubscription",
            "sql": "INSERT INTO product_subscription (service_type, product, resource_type, service_id, git_url, version, platform, name, endpoint, region, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE service_type = ?, product = ?, resource_type = ?, service_id = ?, git_url = ?, version = ?, platform = ?, name = ?, endpoint = ?, region = ?, updated_at = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "有有效ProductBasicInfo时删除无效记录",
            "sql": "DELETE FROM product_basic_info WHERE version = ? AND platform = ? AND product = ? AND id NOT IN (?);"
          },
          {
            "scenario": "无有效ProductBasicInfo时删除所有记录",
            "sql": "DELETE FROM product_basic_info WHERE version = ? AND platform = ? AND product = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "有有效ProductSubscription时删除无效记录",
            "sql": "DELETE FROM product_subscription WHERE version = ? AND platform = ? AND product = ? AND id NOT IN (?);"
          },
          {
            "scenario": "无有效ProductSubscription时删除所有记录",
            "sql": "DELETE FROM product_subscription WHERE version = ? AND platform = ? AND product = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "有策略模板时修改ProductPolicyTemplate",
            "sql": "INSERT INTO product_policy_template (product, policy_tpl_name, prefix_in_cam, description, policy_doc_tpl, scope, remark, policy_tpl_desc_i18n, version, platform, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE product = ?, policy_tpl_name = ?, prefix_in_cam = ?, description = ?, policy_doc_tpl = ?, scope = ?, remark = ?, policy_tpl_desc_i18n = ?, version = ?, platform = ?, updated_at = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "有有效ProductPolicyTemplate时删除无效记录",
            "sql": "DELETE FROM product_policy_template WHERE version = ? AND platform = ? AND product = ? AND id NOT IN (?);"
          },
          {
            "scenario": "无有效ProductPolicyTemplate时删除所有记录",
            "sql": "DELETE FROM product_policy_template WHERE version = ? AND platform = ? AND product = ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/basicinfo.go",
        "code_start_line": 10,
        "code_end_line": 17,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo interface {\n\tListProductBasicInfos(ctx context.Context, filter entity.Filter) ([]*entity.ProductBasicInfo, int64, error)\n\tCreateProductBasicInfo(ctx context.Context, productBasicInfo *entity.ProductBasicInfo) (*entity.ProductBasicInfo, error)\n\tModifyProductBasicInfo(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductBasicInfo(ctx context.Context, filter entity.Filter) (*entity.ProductBasicInfo, error)\n\tDeleteProductBasicInfo(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 21,
        "code_end_line": 39,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tID                 uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt          time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt          time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct            string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_product;column:product;type:varchar(32);default:null\"`\n\tProductCode        string    `gorm:\"index:idx_code;column:product_code;type:varchar(32);default:null\"`\n\tServiceType        string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_service;column:service_type;type:varchar(32);default:null\"`\n\tResourceType       string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_resource_type;column:resource_type;type:varchar(32);default:null\"`\n\tAccessType         string    `gorm:\"index:idx_access_type;column:access_type;type:varchar(32);default:null\"`\n\tPermissionUser     string    `gorm:\"column:permission_user;type:text;default:null\"`\n\tGetInstancesAction string    `gorm:\"column:get_instances_action;type:text;default:null\"`\n\tVersion            string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform           string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tState              int       `gorm:\"column:state;type:tinyint(4);default:0\"` // 0 未合流，1 已合流\n\tSnapshotId         string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen             int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n\tCreatorName        string    `gorm:\"column:creator_name;type:varchar(128);default:null\"`\n\tUpdateName         string    `gorm:\"column:update_name;type:varchar(128);default:null\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 42,
        "code_end_line": 44,
        "code_key": "TableName",
        "code_value": "func (r *ProductBasicInfo) TableName() string {\n\treturn ProductBasicInfoTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/basicinfo.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/subscription.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription interface {\n\tListProductSubscriptions(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductSubscription, int64, error)\n\tCreateProductSubscription(ctx context.Context,\n\t\tproductSubscription *entity.ProductSubscription) (*entity.ProductSubscription, error)\n\n\tGetProductSubscription(ctx context.Context, filter entity.Filter) (*entity.ProductSubscription, error)\n\tDeleteProductSubscription(ctx context.Context, filter entity.Filter) error\n\tModifyProductSubscription(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 11,
        "code_end_line": 28,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription struct {\n\tID             uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt      time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt      time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tName           string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:name;type:varchar(32);default:null\"`\n\tServiceType    string    `gorm:\"column:service_type;type:text;default:null\"`\n\tRegion         string    `gorm:\"column:region;type:varchar(16);default:null\"`\n\tResourcePrefix string    `gorm:\"column:resource_prefix;type:varchar(16);default:null\"`\n\tEndpoint       string    `gorm:\"column:endpoint;type:varchar(256);default:null\"`\n\tProduct        string    `gorm:\"column:product;type:varchar(32);default:null\"`\n\tResourceType   string    `gorm:\"column:resource_type;type:varchar(32);default:null\"`\n\tServiceID      string    `gorm:\"column:service_id;type:varchar(1024);default:null\"`\n\tGitUrl         string    `gorm:\"column:git_url;type:varchar(4096);default:null\"`\n\tVersion        string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform       string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId     string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen         int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (r *ProductSubscription) TableName() string {\n\treturn ProductSubscriptionTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/policytemplate.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate interface {\n\tListProductPolicyTemplates(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductPolicyTemplate, int64, error)\n\tCreateProductPolicyTemplate(ctx context.Context,\n\t\tpolicyTemplate *entity.ProductPolicyTemplate) (*entity.ProductPolicyTemplate, error)\n\tModifyProductPolicyTemplate(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductPolicyTemplate(ctx context.Context, filter entity.Filter) (*entity.ProductPolicyTemplate, error)\n\tDeleteProductPolicyTemplate(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 13,
        "code_end_line": 29,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tID                uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt         time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt         time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct           string    `gorm:\"column:product;type:varchar(16);default:null\"`\n\tPolicyTplName     string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:policy_tpl_name;type:varchar(200);default:null\"`\n\tPrefixInCam       string    `gorm:\"column:prefix_in_cam;type:varchar(128);default:null\"`\n\tDescription       string    `gorm:\"column:description;type:varchar(512);default:null\"`\n\tPolicyDocTpl      string    `gorm:\"column:policy_doc_tpl;type:text;default:null\"`\n\tScope             string    `gorm:\"column:scope;type:varchar(16);default:null\"`\n\tRemark            string    `gorm:\"column:remark;type:text;default:null\"`\n\tPolicyTplDescI18n string    `gorm:\"column:policy_tpl_desc_i18n;type:text;default:null\"`\n\tVersion           string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform          string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId        string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen            int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 32,
        "code_end_line": 34,
        "code_key": "TableName",
        "code_value": "func (r *ProductPolicyTemplate) TableName() string {\n\treturn ProductPolicyTemplateTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/policytemplate.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/service/projectconfig.go",
        "code_start_line": 16,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tbasicInfoStore      repository.ProductBasicInfo\n\tpolicyTemplateStore repository.ProductPolicyTemplate\n\tsubscriptionStore   repository.ProductSubscription\n\tprojectConfigStore  repository.ProjectConfig\n\tcfg                 *config.Config\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/projectconfig.go",
        "code_start_line": 11,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig interface {\n\tCreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tCreateProjectConfigSnapshot(ctx context.Context,\n\t\tversion, platform string, productCode2SnapshotId map[string]string) error\n\n\tGetProjectConfig(ctx context.Context, filter entity.Filter) (*protocol.ProjectConfig, error)\n\tListProjectConfigs(ctx context.Context, filter entity.Filter) ([]*protocol.ProjectConfig, int64, error)\n\tDeleteProjectConfig(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go",
        "code_start_line": 25,
        "code_end_line": 27,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/pkg/protocol/projectconfig.go",
        "code_start_line": 71,
        "code_end_line": 76,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tYunapiBaseParam\n\tProductCode     string                `json:\"ProductCode\" validate:\"required\"`\n\tResources       []*ResourceItem       `json:\"Resources\" validate:\"required\"`\n\tPolicyTemplates []*PolicyTemplateItem `json:\"PolicyTemplates\" validate:\"required\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 36,
        "code_end_line": 39,
        "code_key": "ServceIDDetail",
        "code_value": "type ServceIDDetail struct {\n\tRegion   string `json:\"Region\"`\n\tEndpoint string `json:\"Endpoint\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/api__project.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go:140:270:ModifyProjectConfig",
    "orm_code": "func (c *ProjectConfig) ModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam,\n\tscope string, serviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (\n\t*protocol.ProjectConfig, error) {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tvar productBasicInfo *entity.ProductBasicInfo\n\t\tvar validProductBasicInfoIds []uint\n\t\tvar productSubscription *entity.ProductSubscription\n\t\tvar validProductSubscriptionIds []uint\n\t\tfor _, resource := range projectConfig.Resources {\n\t\t\t// basic\n\t\t\tvar getInstancesActionBytes []byte\n\t\t\tif resource != nil &&\n\t\t\t\tresource.GetInstancesAction != nil &&\n\t\t\t\tresource.GetInstancesAction.Version != \"\" && resource.GetInstancesAction.Action != \"\" {\n\t\t\t\tif getInstancesActionBytes, err = json.Marshal(resource.GetInstancesAction); err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\tbillingProductCode := resource.BillingProductCode\n\t\t\tif billingProductCode == \"\" && resource.AccessType == entity.ACCESSTYPE_LOCAL {\n\t\t\t\tbillingProductCode = \"p_\" + resource.ServiceType + strings.ToLower(resource.ResourceType)\n\t\t\t}\n\t\t\tif productBasicInfo, err = modifyProductBasicInfoInTx(tx, &entity.ProductBasicInfo{\n\t\t\t\tProduct:            projectConfig.ProductCode,\n\t\t\t\tProductCode:        billingProductCode,\n\t\t\t\tServiceType:        resource.ServiceType,\n\t\t\t\tResourceType:       resource.ResourceType,\n\t\t\t\tAccessType:         resource.AccessType,\n\t\t\t\tGetInstancesAction: string(getInstancesActionBytes),\n\t\t\t\tVersion:            projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:           projectConfig.Platform,\n\t\t\t\tState:              entity.STATE_DEV,\n\t\t\t\tUpdateName:         projectConfig.UserId,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tvalidProductBasicInfoIds = append(validProductBasicInfoIds, productBasicInfo.ID)\n\t\t\tfor _, subscription := range resource.Subscriptions {\n\t\t\t\t// subscription\n\t\t\t\tnewSubscription := &entity.ProductSubscription{\n\t\t\t\t\tServiceType:  resource.ServiceType,\n\t\t\t\t\tProduct:      projectConfig.ProductCode,\n\t\t\t\t\tResourceType: resource.ResourceType,\n\t\t\t\t\tServiceID:    subscription.ServiceID,\n\t\t\t\t\tGitUrl:       subscription.GitUrl,\n\t\t\t\t\tVersion:      projectConfig.ReleaseVersion,\n\t\t\t\t\tPlatform:     projectConfig.Platform,\n\t\t\t\t}\n\t\t\t\t// 极光本地直接保存serviceid，特定环境需要根据pajero解析serviceid拿到endpoint\n\t\t\t\tif pajeroAddr != \"\" {\n\t\t\t\t\t// 只添加在pajero中能查到地址的serviceid\n\t\t\t\t\tif details, ok := serviceID2Detail[subscription.ServiceID]; ok {\n\t\t\t\t\t\tfor _, detail := range details {\n\t\t\t\t\t\t\tnewSubscription.Name = strings.Join([]string{projectConfig.ProductCode,\n\t\t\t\t\t\t\t\tresource.ServiceType, resource.ResourceType, detail.Region}, \"-\")\n\t\t\t\t\t\t\tnewSubscription.Endpoint = detail.Endpoint\n\t\t\t\t\t\t\tnewSubscription.Region = detail.Region\n\t\t\t\t\t\t\tif productSubscription, err = modifyProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tvalidProductSubscriptionIds = append(validProductSubscriptionIds, productSubscription.ID)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif productSubscription, err = modifyProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\tvalidProductSubscriptionIds = append(validProductSubscriptionIds, productSubscription.ID)\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\t\t// 可重入清理\n\t\tfilter := entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductBasicInfoIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductBasicInfoIds\n\t\t}\n\t\tif err = deleteProductBasicInfoInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\tfilter = entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductSubscriptionIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductSubscriptionIds\n\t\t}\n\t\tif err = deleteProductSubscriptionInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\tvar productPolicyTemplate *entity.ProductPolicyTemplate\n\t\tvar validProductPolicyTemplateIds []uint\n\t\t// policytemplate\n\t\tfor _, policyTemplate := range projectConfig.PolicyTemplates {\n\t\t\tvar descriptionBytes []byte\n\t\t\tif descriptionBytes, err = json.Marshal(policyTemplate.PolicyTemplateDescI18n); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tdescription, _ := policyTemplate.PolicyTemplateDescI18n[utils.LanguageZhCN]\n\t\t\tvar policyTemplateDocBytes []byte\n\t\t\tif policyTemplateDocBytes, err = json.Marshal(policyTemplate.PolicyTemplateDoc); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif productPolicyTemplate, err = modifyProductPolicyTemplateInTx(tx, &entity.ProductPolicyTemplate{\n\t\t\t\tProduct:           projectConfig.ProductCode,\n\t\t\t\tPolicyTplName:     policyTemplate.PolicyTemplateName,\n\t\t\t\tPrefixInCam:       prefixInCam + policyTemplate.PolicyTemplateName,\n\t\t\t\tDescription:       description,\n\t\t\t\tPolicyDocTpl:      string(policyTemplateDocBytes),\n\t\t\t\tScope:             scope,\n\t\t\t\tRemark:            string(descriptionBytes),\n\t\t\t\tPolicyTplDescI18n: string(descriptionBytes),\n\t\t\t\tVersion:           projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:          projectConfig.Platform,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tvalidProductPolicyTemplateIds = append(validProductPolicyTemplateIds, productPolicyTemplate.ID)\n\t\t}\n\t\t// 可重入清理\n\t\tfilter = entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductPolicyTemplateIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductPolicyTemplateIds\n\t\t}\n\t\tif err = deleteProductPolicyTemplatInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\treturn\n\t})\n\treturn projectConfig, err\n}",
    "caller": "func (p *ProjectConfig) ModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig) (\n\t*protocol.ProjectConfig, error) {\n\t_, cnt, err := p.basicInfoStore.ListProductBasicInfos(ctx,\n\t\tentity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform, projectConfig.ProductCode, \"\"))\n\tif err != nil {\n\t\treturn nil, err\n\t} else if cnt == 0 {\n\t\treturn nil, utils.ErrProductConfigNotExist\n\t}\n\tserviceID2Detail := make(map[string][]entity.ServceIDDetail)\n\t// 极光本地直接保存serviceid，特定环境需要根据pajero解析serviceid拿到endpoint\n\tif p.cfg.Apps.ProjectConfig.PajeroAddr != \"\" {\n\t\tif serviceID2Detail, err = parseServiceIDFromPajero(ctx, p.cfg, projectConfig); err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t}\n\tres, err := p.projectConfigStore.ModifyProjectConfig(ctx, projectConfig, p.cfg.Apps.ProjectConfig.PrefixInCam,\n\t\tp.cfg.Apps.ProjectConfig.Scope, serviceID2Detail, p.cfg.Apps.ProjectConfig.PajeroAddr)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn res, nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/basicinfo.go",
        "code_start_line": 10,
        "code_end_line": 17,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo interface {\n\tListProductBasicInfos(ctx context.Context, filter entity.Filter) ([]*entity.ProductBasicInfo, int64, error)\n\tCreateProductBasicInfo(ctx context.Context, productBasicInfo *entity.ProductBasicInfo) (*entity.ProductBasicInfo, error)\n\tModifyProductBasicInfo(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductBasicInfo(ctx context.Context, filter entity.Filter) (*entity.ProductBasicInfo, error)\n\tDeleteProductBasicInfo(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 21,
        "code_end_line": 39,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tID                 uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt          time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt          time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct            string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_product;column:product;type:varchar(32);default:null\"`\n\tProductCode        string    `gorm:\"index:idx_code;column:product_code;type:varchar(32);default:null\"`\n\tServiceType        string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_service;column:service_type;type:varchar(32);default:null\"`\n\tResourceType       string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_resource_type;column:resource_type;type:varchar(32);default:null\"`\n\tAccessType         string    `gorm:\"index:idx_access_type;column:access_type;type:varchar(32);default:null\"`\n\tPermissionUser     string    `gorm:\"column:permission_user;type:text;default:null\"`\n\tGetInstancesAction string    `gorm:\"column:get_instances_action;type:text;default:null\"`\n\tVersion            string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform           string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tState              int       `gorm:\"column:state;type:tinyint(4);default:0\"` // 0 未合流，1 已合流\n\tSnapshotId         string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen             int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n\tCreatorName        string    `gorm:\"column:creator_name;type:varchar(128);default:null\"`\n\tUpdateName         string    `gorm:\"column:update_name;type:varchar(128);default:null\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 42,
        "code_end_line": 44,
        "code_key": "TableName",
        "code_value": "func (r *ProductBasicInfo) TableName() string {\n\treturn ProductBasicInfoTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/basicinfo.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/subscription.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription interface {\n\tListProductSubscriptions(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductSubscription, int64, error)\n\tCreateProductSubscription(ctx context.Context,\n\t\tproductSubscription *entity.ProductSubscription) (*entity.ProductSubscription, error)\n\n\tGetProductSubscription(ctx context.Context, filter entity.Filter) (*entity.ProductSubscription, error)\n\tDeleteProductSubscription(ctx context.Context, filter entity.Filter) error\n\tModifyProductSubscription(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 11,
        "code_end_line": 28,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription struct {\n\tID             uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt      time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt      time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tName           string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:name;type:varchar(32);default:null\"`\n\tServiceType    string    `gorm:\"column:service_type;type:text;default:null\"`\n\tRegion         string    `gorm:\"column:region;type:varchar(16);default:null\"`\n\tResourcePrefix string    `gorm:\"column:resource_prefix;type:varchar(16);default:null\"`\n\tEndpoint       string    `gorm:\"column:endpoint;type:varchar(256);default:null\"`\n\tProduct        string    `gorm:\"column:product;type:varchar(32);default:null\"`\n\tResourceType   string    `gorm:\"column:resource_type;type:varchar(32);default:null\"`\n\tServiceID      string    `gorm:\"column:service_id;type:varchar(1024);default:null\"`\n\tGitUrl         string    `gorm:\"column:git_url;type:varchar(4096);default:null\"`\n\tVersion        string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform       string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId     string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen         int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (r *ProductSubscription) TableName() string {\n\treturn ProductSubscriptionTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/policytemplate.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate interface {\n\tListProductPolicyTemplates(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductPolicyTemplate, int64, error)\n\tCreateProductPolicyTemplate(ctx context.Context,\n\t\tpolicyTemplate *entity.ProductPolicyTemplate) (*entity.ProductPolicyTemplate, error)\n\tModifyProductPolicyTemplate(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductPolicyTemplate(ctx context.Context, filter entity.Filter) (*entity.ProductPolicyTemplate, error)\n\tDeleteProductPolicyTemplate(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 13,
        "code_end_line": 29,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tID                uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt         time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt         time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct           string    `gorm:\"column:product;type:varchar(16);default:null\"`\n\tPolicyTplName     string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:policy_tpl_name;type:varchar(200);default:null\"`\n\tPrefixInCam       string    `gorm:\"column:prefix_in_cam;type:varchar(128);default:null\"`\n\tDescription       string    `gorm:\"column:description;type:varchar(512);default:null\"`\n\tPolicyDocTpl      string    `gorm:\"column:policy_doc_tpl;type:text;default:null\"`\n\tScope             string    `gorm:\"column:scope;type:varchar(16);default:null\"`\n\tRemark            string    `gorm:\"column:remark;type:text;default:null\"`\n\tPolicyTplDescI18n string    `gorm:\"column:policy_tpl_desc_i18n;type:text;default:null\"`\n\tVersion           string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform          string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId        string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen            int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 32,
        "code_end_line": 34,
        "code_key": "TableName",
        "code_value": "func (r *ProductPolicyTemplate) TableName() string {\n\treturn ProductPolicyTemplateTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/policytemplate.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/service/projectconfig.go",
        "code_start_line": 16,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tbasicInfoStore      repository.ProductBasicInfo\n\tpolicyTemplateStore repository.ProductPolicyTemplate\n\tsubscriptionStore   repository.ProductSubscription\n\tprojectConfigStore  repository.ProjectConfig\n\tcfg                 *config.Config\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/projectconfig.go",
        "code_start_line": 11,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig interface {\n\tCreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tCreateProjectConfigSnapshot(ctx context.Context,\n\t\tversion, platform string, productCode2SnapshotId map[string]string) error\n\n\tGetProjectConfig(ctx context.Context, filter entity.Filter) (*protocol.ProjectConfig, error)\n\tListProjectConfigs(ctx context.Context, filter entity.Filter) ([]*protocol.ProjectConfig, int64, error)\n\tDeleteProjectConfig(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go",
        "code_start_line": 25,
        "code_end_line": 27,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/pkg/protocol/projectconfig.go",
        "code_start_line": 71,
        "code_end_line": 76,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tYunapiBaseParam\n\tProductCode     string                `json:\"ProductCode\" validate:\"required\"`\n\tResources       []*ResourceItem       `json:\"Resources\" validate:\"required\"`\n\tPolicyTemplates []*PolicyTemplateItem `json:\"PolicyTemplates\" validate:\"required\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 36,
        "code_end_line": 39,
        "code_key": "ServceIDDetail",
        "code_value": "type ServceIDDetail struct {\n\tRegion   string `json:\"Region\"`\n\tEndpoint string `json:\"Endpoint\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/api__project.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go:140:270:ModifyProjectConfig",
    "orm_code": "func (c *ProjectConfig) ModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam,\n\tscope string, serviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (\n\t*protocol.ProjectConfig, error) {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tvar productBasicInfo *entity.ProductBasicInfo\n\t\tvar validProductBasicInfoIds []uint\n\t\tvar productSubscription *entity.ProductSubscription\n\t\tvar validProductSubscriptionIds []uint\n\t\tfor _, resource := range projectConfig.Resources {\n\t\t\t// basic\n\t\t\tvar getInstancesActionBytes []byte\n\t\t\tif resource != nil &&\n\t\t\t\tresource.GetInstancesAction != nil &&\n\t\t\t\tresource.GetInstancesAction.Version != \"\" && resource.GetInstancesAction.Action != \"\" {\n\t\t\t\tif getInstancesActionBytes, err = json.Marshal(resource.GetInstancesAction); err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\tbillingProductCode := resource.BillingProductCode\n\t\t\tif billingProductCode == \"\" && resource.AccessType == entity.ACCESSTYPE_LOCAL {\n\t\t\t\tbillingProductCode = \"p_\" + resource.ServiceType + strings.ToLower(resource.ResourceType)\n\t\t\t}\n\t\t\tif productBasicInfo, err = modifyProductBasicInfoInTx(tx, &entity.ProductBasicInfo{\n\t\t\t\tProduct:            projectConfig.ProductCode,\n\t\t\t\tProductCode:        billingProductCode,\n\t\t\t\tServiceType:        resource.ServiceType,\n\t\t\t\tResourceType:       resource.ResourceType,\n\t\t\t\tAccessType:         resource.AccessType,\n\t\t\t\tGetInstancesAction: string(getInstancesActionBytes),\n\t\t\t\tVersion:            projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:           projectConfig.Platform,\n\t\t\t\tState:              entity.STATE_DEV,\n\t\t\t\tUpdateName:         projectConfig.UserId,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tvalidProductBasicInfoIds = append(validProductBasicInfoIds, productBasicInfo.ID)\n\t\t\tfor _, subscription := range resource.Subscriptions {\n\t\t\t\t// subscription\n\t\t\t\tnewSubscription := &entity.ProductSubscription{\n\t\t\t\t\tServiceType:  resource.ServiceType,\n\t\t\t\t\tProduct:      projectConfig.ProductCode,\n\t\t\t\t\tResourceType: resource.ResourceType,\n\t\t\t\t\tServiceID:    subscription.ServiceID,\n\t\t\t\t\tGitUrl:       subscription.GitUrl,\n\t\t\t\t\tVersion:      projectConfig.ReleaseVersion,\n\t\t\t\t\tPlatform:     projectConfig.Platform,\n\t\t\t\t}\n\t\t\t\t// 极光本地直接保存serviceid，特定环境需要根据pajero解析serviceid拿到endpoint\n\t\t\t\tif pajeroAddr != \"\" {\n\t\t\t\t\t// 只添加在pajero中能查到地址的serviceid\n\t\t\t\t\tif details, ok := serviceID2Detail[subscription.ServiceID]; ok {\n\t\t\t\t\t\tfor _, detail := range details {\n\t\t\t\t\t\t\tnewSubscription.Name = strings.Join([]string{projectConfig.ProductCode,\n\t\t\t\t\t\t\t\tresource.ServiceType, resource.ResourceType, detail.Region}, \"-\")\n\t\t\t\t\t\t\tnewSubscription.Endpoint = detail.Endpoint\n\t\t\t\t\t\t\tnewSubscription.Region = detail.Region\n\t\t\t\t\t\t\tif productSubscription, err = modifyProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tvalidProductSubscriptionIds = append(validProductSubscriptionIds, productSubscription.ID)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif productSubscription, err = modifyProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\tvalidProductSubscriptionIds = append(validProductSubscriptionIds, productSubscription.ID)\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\t\t// 可重入清理\n\t\tfilter := entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductBasicInfoIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductBasicInfoIds\n\t\t}\n\t\tif err = deleteProductBasicInfoInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\tfilter = entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductSubscriptionIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductSubscriptionIds\n\t\t}\n\t\tif err = deleteProductSubscriptionInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\tvar productPolicyTemplate *entity.ProductPolicyTemplate\n\t\tvar validProductPolicyTemplateIds []uint\n\t\t// policytemplate\n\t\tfor _, policyTemplate := range projectConfig.PolicyTemplates {\n\t\t\tvar descriptionBytes []byte\n\t\t\tif descriptionBytes, err = json.Marshal(policyTemplate.PolicyTemplateDescI18n); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tdescription, _ := policyTemplate.PolicyTemplateDescI18n[utils.LanguageZhCN]\n\t\t\tvar policyTemplateDocBytes []byte\n\t\t\tif policyTemplateDocBytes, err = json.Marshal(policyTemplate.PolicyTemplateDoc); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif productPolicyTemplate, err = modifyProductPolicyTemplateInTx(tx, &entity.ProductPolicyTemplate{\n\t\t\t\tProduct:           projectConfig.ProductCode,\n\t\t\t\tPolicyTplName:     policyTemplate.PolicyTemplateName,\n\t\t\t\tPrefixInCam:       prefixInCam + policyTemplate.PolicyTemplateName,\n\t\t\t\tDescription:       description,\n\t\t\t\tPolicyDocTpl:      string(policyTemplateDocBytes),\n\t\t\t\tScope:             scope,\n\t\t\t\tRemark:            string(descriptionBytes),\n\t\t\t\tPolicyTplDescI18n: string(descriptionBytes),\n\t\t\t\tVersion:           projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:          projectConfig.Platform,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tvalidProductPolicyTemplateIds = append(validProductPolicyTemplateIds, productPolicyTemplate.ID)\n\t\t}\n\t\t// 可重入清理\n\t\tfilter = entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductPolicyTemplateIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductPolicyTemplateIds\n\t\t}\n\t\tif err = deleteProductPolicyTemplatInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\treturn\n\t})\n\treturn projectConfig, err\n}",
    "caller": "func (c *ProjectConfig) ModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam,\n\tscope string, serviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (\n\t*protocol.ProjectConfig, error) {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tvar productBasicInfo *entity.ProductBasicInfo\n\t\tvar validProductBasicInfoIds []uint\n\t\tvar productSubscription *entity.ProductSubscription\n\t\tvar validProductSubscriptionIds []uint\n\t\tfor _, resource := range projectConfig.Resources {\n\t\t\t// basic\n\t\t\tvar getInstancesActionBytes []byte\n\t\t\tif resource != nil &&\n\t\t\t\tresource.GetInstancesAction != nil &&\n\t\t\t\tresource.GetInstancesAction.Version != \"\" && resource.GetInstancesAction.Action != \"\" {\n\t\t\t\tif getInstancesActionBytes, err = json.Marshal(resource.GetInstancesAction); err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t\tbillingProductCode := resource.BillingProductCode\n\t\t\tif billingProductCode == \"\" && resource.AccessType == entity.ACCESSTYPE_LOCAL {\n\t\t\t\tbillingProductCode = \"p_\" + resource.ServiceType + strings.ToLower(resource.ResourceType)\n\t\t\t}\n\t\t\tif productBasicInfo, err = modifyProductBasicInfoInTx(tx, &entity.ProductBasicInfo{\n\t\t\t\tProduct:            projectConfig.ProductCode,\n\t\t\t\tProductCode:        billingProductCode,\n\t\t\t\tServiceType:        resource.ServiceType,\n\t\t\t\tResourceType:       resource.ResourceType,\n\t\t\t\tAccessType:         resource.AccessType,\n\t\t\t\tGetInstancesAction: string(getInstancesActionBytes),\n\t\t\t\tVersion:            projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:           projectConfig.Platform,\n\t\t\t\tState:              entity.STATE_DEV,\n\t\t\t\tUpdateName:         projectConfig.UserId,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tvalidProductBasicInfoIds = append(validProductBasicInfoIds, productBasicInfo.ID)\n\t\t\tfor _, subscription := range resource.Subscriptions {\n\t\t\t\t// subscription\n\t\t\t\tnewSubscription := &entity.ProductSubscription{\n\t\t\t\t\tServiceType:  resource.ServiceType,\n\t\t\t\t\tProduct:      projectConfig.ProductCode,\n\t\t\t\t\tResourceType: resource.ResourceType,\n\t\t\t\t\tServiceID:    subscription.ServiceID,\n\t\t\t\t\tGitUrl:       subscription.GitUrl,\n\t\t\t\t\tVersion:      projectConfig.ReleaseVersion,\n\t\t\t\t\tPlatform:     projectConfig.Platform,\n\t\t\t\t}\n\t\t\t\t// 极光本地直接保存serviceid，特定环境需要根据pajero解析serviceid拿到endpoint\n\t\t\t\tif pajeroAddr != \"\" {\n\t\t\t\t\t// 只添加在pajero中能查到地址的serviceid\n\t\t\t\t\tif details, ok := serviceID2Detail[subscription.ServiceID]; ok {\n\t\t\t\t\t\tfor _, detail := range details {\n\t\t\t\t\t\t\tnewSubscription.Name = strings.Join([]string{projectConfig.ProductCode,\n\t\t\t\t\t\t\t\tresource.ServiceType, resource.ResourceType, detail.Region}, \"-\")\n\t\t\t\t\t\t\tnewSubscription.Endpoint = detail.Endpoint\n\t\t\t\t\t\t\tnewSubscription.Region = detail.Region\n\t\t\t\t\t\t\tif productSubscription, err = modifyProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tvalidProductSubscriptionIds = append(validProductSubscriptionIds, productSubscription.ID)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif productSubscription, err = modifyProductSubscriptionInTx(tx, newSubscription); err != nil {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\tvalidProductSubscriptionIds = append(validProductSubscriptionIds, productSubscription.ID)\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\t\t// 可重入清理\n\t\tfilter := entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductBasicInfoIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductBasicInfoIds\n\t\t}\n\t\tif err = deleteProductBasicInfoInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\tfilter = entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductSubscriptionIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductSubscriptionIds\n\t\t}\n\t\tif err = deleteProductSubscriptionInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\tvar productPolicyTemplate *entity.ProductPolicyTemplate\n\t\tvar validProductPolicyTemplateIds []uint\n\t\t// policytemplate\n\t\tfor _, policyTemplate := range projectConfig.PolicyTemplates {\n\t\t\tvar descriptionBytes []byte\n\t\t\tif descriptionBytes, err = json.Marshal(policyTemplate.PolicyTemplateDescI18n); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tdescription, _ := policyTemplate.PolicyTemplateDescI18n[utils.LanguageZhCN]\n\t\t\tvar policyTemplateDocBytes []byte\n\t\t\tif policyTemplateDocBytes, err = json.Marshal(policyTemplate.PolicyTemplateDoc); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif productPolicyTemplate, err = modifyProductPolicyTemplateInTx(tx, &entity.ProductPolicyTemplate{\n\t\t\t\tProduct:           projectConfig.ProductCode,\n\t\t\t\tPolicyTplName:     policyTemplate.PolicyTemplateName,\n\t\t\t\tPrefixInCam:       prefixInCam + policyTemplate.PolicyTemplateName,\n\t\t\t\tDescription:       description,\n\t\t\t\tPolicyDocTpl:      string(policyTemplateDocBytes),\n\t\t\t\tScope:             scope,\n\t\t\t\tRemark:            string(descriptionBytes),\n\t\t\t\tPolicyTplDescI18n: string(descriptionBytes),\n\t\t\t\tVersion:           projectConfig.ReleaseVersion,\n\t\t\t\tPlatform:          projectConfig.Platform,\n\t\t\t}); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tvalidProductPolicyTemplateIds = append(validProductPolicyTemplateIds, productPolicyTemplate.ID)\n\t\t}\n\t\t// 可重入清理\n\t\tfilter = entity.BuildCommonFilter(projectConfig.ReleaseVersion, projectConfig.Platform,\n\t\t\tprojectConfig.ProductCode, \"\")\n\t\tif len(validProductPolicyTemplateIds) > 0 {\n\t\t\tfilter[\"id\"+entity.PostfixNOTIN] = validProductPolicyTemplateIds\n\t\t}\n\t\tif err = deleteProductPolicyTemplatInTx(tx, filter); err != nil {\n\t\t\treturn\n\t\t}\n\t\treturn\n\t})\n\treturn projectConfig, err\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/basicinfo.go",
        "code_start_line": 10,
        "code_end_line": 17,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo interface {\n\tListProductBasicInfos(ctx context.Context, filter entity.Filter) ([]*entity.ProductBasicInfo, int64, error)\n\tCreateProductBasicInfo(ctx context.Context, productBasicInfo *entity.ProductBasicInfo) (*entity.ProductBasicInfo, error)\n\tModifyProductBasicInfo(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductBasicInfo(ctx context.Context, filter entity.Filter) (*entity.ProductBasicInfo, error)\n\tDeleteProductBasicInfo(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 21,
        "code_end_line": 39,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tID                 uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt          time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt          time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct            string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_product;column:product;type:varchar(32);default:null\"`\n\tProductCode        string    `gorm:\"index:idx_code;column:product_code;type:varchar(32);default:null\"`\n\tServiceType        string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_service;column:service_type;type:varchar(32);default:null\"`\n\tResourceType       string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;index:idx_resource_type;column:resource_type;type:varchar(32);default:null\"`\n\tAccessType         string    `gorm:\"index:idx_access_type;column:access_type;type:varchar(32);default:null\"`\n\tPermissionUser     string    `gorm:\"column:permission_user;type:text;default:null\"`\n\tGetInstancesAction string    `gorm:\"column:get_instances_action;type:text;default:null\"`\n\tVersion            string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform           string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tState              int       `gorm:\"column:state;type:tinyint(4);default:0\"` // 0 未合流，1 已合流\n\tSnapshotId         string    `gorm:\"uniqueIndex:uk_product_servicetype_resourcetype_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen             int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n\tCreatorName        string    `gorm:\"column:creator_name;type:varchar(128);default:null\"`\n\tUpdateName         string    `gorm:\"column:update_name;type:varchar(128);default:null\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/basicinfo.go",
        "code_start_line": 42,
        "code_end_line": 44,
        "code_key": "TableName",
        "code_value": "func (r *ProductBasicInfo) TableName() string {\n\treturn ProductBasicInfoTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/basicinfo.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductBasicInfo",
        "code_value": "type ProductBasicInfo struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/subscription.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription interface {\n\tListProductSubscriptions(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductSubscription, int64, error)\n\tCreateProductSubscription(ctx context.Context,\n\t\tproductSubscription *entity.ProductSubscription) (*entity.ProductSubscription, error)\n\n\tGetProductSubscription(ctx context.Context, filter entity.Filter) (*entity.ProductSubscription, error)\n\tDeleteProductSubscription(ctx context.Context, filter entity.Filter) error\n\tModifyProductSubscription(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 11,
        "code_end_line": 28,
        "code_key": "ProductSubscription",
        "code_value": "type ProductSubscription struct {\n\tID             uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt      time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt      time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tName           string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:name;type:varchar(32);default:null\"`\n\tServiceType    string    `gorm:\"column:service_type;type:text;default:null\"`\n\tRegion         string    `gorm:\"column:region;type:varchar(16);default:null\"`\n\tResourcePrefix string    `gorm:\"column:resource_prefix;type:varchar(16);default:null\"`\n\tEndpoint       string    `gorm:\"column:endpoint;type:varchar(256);default:null\"`\n\tProduct        string    `gorm:\"column:product;type:varchar(32);default:null\"`\n\tResourceType   string    `gorm:\"column:resource_type;type:varchar(32);default:null\"`\n\tServiceID      string    `gorm:\"column:service_id;type:varchar(1024);default:null\"`\n\tGitUrl         string    `gorm:\"column:git_url;type:varchar(4096);default:null\"`\n\tVersion        string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform       string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId     string    `gorm:\"uniqueIndex:uk_name_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen         int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 31,
        "code_end_line": 33,
        "code_key": "TableName",
        "code_value": "func (r *ProductSubscription) TableName() string {\n\treturn ProductSubscriptionTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/policytemplate.go",
        "code_start_line": 10,
        "code_end_line": 19,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate interface {\n\tListProductPolicyTemplates(ctx context.Context,\n\t\tfilter entity.Filter) ([]*entity.ProductPolicyTemplate, int64, error)\n\tCreateProductPolicyTemplate(ctx context.Context,\n\t\tpolicyTemplate *entity.ProductPolicyTemplate) (*entity.ProductPolicyTemplate, error)\n\tModifyProductPolicyTemplate(ctx context.Context, filter entity.Filter, updateField entity.UpdateField) error\n\n\tGetProductPolicyTemplate(ctx context.Context, filter entity.Filter) (*entity.ProductPolicyTemplate, error)\n\tDeleteProductPolicyTemplate(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 13,
        "code_end_line": 29,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tID                uint      `gorm:\"primaryKey;column:id\"`\n\tCreatedAt         time.Time `gorm:\"column:created_at;type:datetime;default:null\"`\n\tUpdatedAt         time.Time `gorm:\"column:updated_at;type:datetime;default:null\"`\n\tProduct           string    `gorm:\"column:product;type:varchar(16);default:null\"`\n\tPolicyTplName     string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:policy_tpl_name;type:varchar(200);default:null\"`\n\tPrefixInCam       string    `gorm:\"column:prefix_in_cam;type:varchar(128);default:null\"`\n\tDescription       string    `gorm:\"column:description;type:varchar(512);default:null\"`\n\tPolicyDocTpl      string    `gorm:\"column:policy_doc_tpl;type:text;default:null\"`\n\tScope             string    `gorm:\"column:scope;type:varchar(16);default:null\"`\n\tRemark            string    `gorm:\"column:remark;type:text;default:null\"`\n\tPolicyTplDescI18n string    `gorm:\"column:policy_tpl_desc_i18n;type:text;default:null\"`\n\tVersion           string    `gorm:\"column:version;type:varchar(128);default:null\"`\n\tPlatform          string    `gorm:\"column:platform;type:varchar(128);default:null\"`\n\tSnapshotId        string    `gorm:\"uniqueIndex:uk_tplname_snapshotid;column:snapshot_id;type:varchar(128);default:null\"`\n\tIsSeen            int       `gorm:\"column:is_seen;type:tinyint(4);default:1\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/policytemplate.go",
        "code_start_line": 32,
        "code_end_line": 34,
        "code_key": "TableName",
        "code_value": "func (r *ProductPolicyTemplate) TableName() string {\n\treturn ProductPolicyTemplateTable\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/policytemplate.go",
        "code_start_line": 23,
        "code_end_line": 25,
        "code_key": "ProductPolicyTemplate",
        "code_value": "type ProductPolicyTemplate struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/service/projectconfig.go",
        "code_start_line": 16,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tbasicInfoStore      repository.ProductBasicInfo\n\tpolicyTemplateStore repository.ProductPolicyTemplate\n\tsubscriptionStore   repository.ProductSubscription\n\tprojectConfigStore  repository.ProjectConfig\n\tcfg                 *config.Config\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/repository/projectconfig.go",
        "code_start_line": 11,
        "code_end_line": 22,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig interface {\n\tCreateProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tModifyProjectConfig(ctx context.Context, projectConfig *protocol.ProjectConfig, prefixInCam, scope string,\n\t\tserviceID2Detail map[string][]entity.ServceIDDetail, pajeroAddr string) (*protocol.ProjectConfig, error)\n\tCreateProjectConfigSnapshot(ctx context.Context,\n\t\tversion, platform string, productCode2SnapshotId map[string]string) error\n\n\tGetProjectConfig(ctx context.Context, filter entity.Filter) (*protocol.ProjectConfig, error)\n\tListProjectConfigs(ctx context.Context, filter entity.Filter) ([]*protocol.ProjectConfig, int64, error)\n\tDeleteProjectConfig(ctx context.Context, filter entity.Filter) error\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go",
        "code_start_line": 25,
        "code_end_line": 27,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tdb *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/pkg/protocol/projectconfig.go",
        "code_start_line": 71,
        "code_end_line": 76,
        "code_key": "ProjectConfig",
        "code_value": "type ProjectConfig struct {\n\tYunapiBaseParam\n\tProductCode     string                `json:\"ProductCode\" validate:\"required\"`\n\tResources       []*ResourceItem       `json:\"Resources\" validate:\"required\"`\n\tPolicyTemplates []*PolicyTemplateItem `json:\"PolicyTemplates\" validate:\"required\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/internal/domain/entity/subscription.go",
        "code_start_line": 36,
        "code_end_line": 39,
        "code_key": "ServceIDDetail",
        "code_value": "type ServceIDDetail struct {\n\tRegion   string `json:\"Region\"`\n\tEndpoint string `json:\"Endpoint\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "ad0488ec48231ebdd98251011710ad83f21fa42b"
      }
    ],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/api__project.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go:273:291:CreateProjectConfigSnapshot",
    "orm_code": "func (c *ProjectConfig) CreateProjectConfigSnapshot(ctx context.Context,\n\tversion, platform string, productCode2SnapshotId map[string]string) error {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tfor productCode, snapshotId := range productCode2SnapshotId {\n\t\t\tif err = createProductBasicInfoSnapshotInTx(tx, version, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif err = createProductSubscriptionSnapshotInTx(tx, version, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif err = createProductPolicyTemplateSnapshotInTx(tx,\n\t\t\t\tversion, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t\treturn\n\t})\n\treturn err\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/api__project.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go:273:291:CreateProjectConfigSnapshot",
    "orm_code": "func (c *ProjectConfig) CreateProjectConfigSnapshot(ctx context.Context,\n\tversion, platform string, productCode2SnapshotId map[string]string) error {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tfor productCode, snapshotId := range productCode2SnapshotId {\n\t\t\tif err = createProductBasicInfoSnapshotInTx(tx, version, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif err = createProductSubscriptionSnapshotInTx(tx, version, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif err = createProductPolicyTemplateSnapshotInTx(tx,\n\t\t\t\tversion, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t\treturn\n\t})\n\treturn err\n}",
    "caller": "func (p *ProjectConfigApp) CreateProjectConfigSnapshot(ctx context.Context, param *tcenterapi.BaseParam,\n\trequest *CreateProjectConfigSnapshotAPI3Req) (*CreateProjectConfigSnapshotAPI3Res, *tcenterapi.APIError) {\n\tif err := p.projectConfigSrv.CreateProjectConfigSnapshot(ctx, request.ReleaseVersion, request.Platform,\n\t\trequest.ProductCode2SnapshotId); err != nil {\n\t\treturn nil, utils.GetApiError(err)\n\t}\n\treturn &CreateProjectConfigSnapshotAPI3Res{}, nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/api__project.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go:273:291:CreateProjectConfigSnapshot",
    "orm_code": "func (c *ProjectConfig) CreateProjectConfigSnapshot(ctx context.Context,\n\tversion, platform string, productCode2SnapshotId map[string]string) error {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tfor productCode, snapshotId := range productCode2SnapshotId {\n\t\t\tif err = createProductBasicInfoSnapshotInTx(tx, version, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif err = createProductSubscriptionSnapshotInTx(tx, version, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif err = createProductPolicyTemplateSnapshotInTx(tx,\n\t\t\t\tversion, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t\treturn\n\t})\n\treturn err\n}",
    "caller": "func (p *ProjectConfig) CreateProjectConfigSnapshot(ctx context.Context,\n\tversion, platform string, productCode2SnapshotId map[string]string) error {\n\treturn p.projectConfigStore.CreateProjectConfigSnapshot(ctx, version, platform, productCode2SnapshotId)\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/api__project.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/api__project/infrastructure/store/projectconfig.go:273:291:CreateProjectConfigSnapshot",
    "orm_code": "func (c *ProjectConfig) CreateProjectConfigSnapshot(ctx context.Context,\n\tversion, platform string, productCode2SnapshotId map[string]string) error {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tfor productCode, snapshotId := range productCode2SnapshotId {\n\t\t\tif err = createProductBasicInfoSnapshotInTx(tx, version, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif err = createProductSubscriptionSnapshotInTx(tx, version, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif err = createProductPolicyTemplateSnapshotInTx(tx,\n\t\t\t\tversion, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t\treturn\n\t})\n\treturn err\n}",
    "caller": "func (c *ProjectConfig) CreateProjectConfigSnapshot(ctx context.Context,\n\tversion, platform string, productCode2SnapshotId map[string]string) error {\n\terr := c.db.WithContext(ctx).Transaction(func(tx *gorm.DB) (err error) {\n\t\tfor productCode, snapshotId := range productCode2SnapshotId {\n\t\t\tif err = createProductBasicInfoSnapshotInTx(tx, version, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif err = createProductSubscriptionSnapshotInTx(tx, version, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif err = createProductPolicyTemplateSnapshotInTx(tx,\n\t\t\t\tversion, platform, productCode, snapshotId); err != nil {\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t\treturn\n\t})\n\treturn err\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/api__project.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/austincheng__flowdriver_pg/postgresql_as_mq/message.go:28:70:GetBatchMsg",
    "orm_code": "func GetBatchMsg(ctx context.Context, owner string, expSeconds int64, batchSize int64, renewInterval int64) (msgList []Message, err error) {\n\n\tdefer func() {\n\t\tif errs := recover(); errs != nil {\n\t\t\tqlog.QErrorF(ctx, \"batch get msg error: %+v\", errs)\n\t\t\terr = errors.New(fmt.Sprintf(\"%+v\", errs))\n\t\t}\n\t}()\n\n\tmsgList = make([]Message, 0)\n\n\terr = GetTxManager().DoTransaction(ctx, func(ctx context.Context, db *gorm.DB) error {\n\t\texpTime := time.Now().Add(-1 * time.Duration(renewInterval) * time.Second).Format(common.DEFAULT_TIME_FORMAT)\n\n\t\tquerySql := \"select * from \" + TABLE_MYSQL_MQ + \" where owner is NULL or \\\"expTime\\\" <= ? limit ? for update \"\n\t\tif err = db.Raw(querySql, expTime, batchSize).Scan(&msgList).Error; err != nil {\n\t\t\tif err == gorm.ErrRecordNotFound {\n\t\t\t\treturn nil\n\t\t\t}\n\t\t\treturn errors.Trace(err)\n\t\t}\n\n\t\tmsgIdList := make([]int64, 0)\n\t\tfor i, msg := range msgList {\n\t\t\tmsgList[i].Owner = &owner\n\t\t\tmsgIdList = append(msgIdList, *msg.Id)\n\t\t}\n\n\t\tupdateSql := \"update \" + TABLE_MYSQL_MQ + \" set owner=? , \\\"expTime\\\" = ? where id in (?)\"\n\t\tif err = db.Exec(updateSql, owner,\n\t\t\ttime.Now().Add(time.Duration(expSeconds) * time.Second).Format(common.DEFAULT_TIME_FORMAT), msgIdList).Error; err != nil {\n\t\t\treturn errors.Trace(err)\n\t\t}\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\treturn make([]Message, 0), err\n\t}\n\n\treturn msgList, nil\n\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT * FROM TABLE_MYSQL_MQ WHERE owner IS NULL OR \"expTime\" <= ? LIMIT ? FOR UPDATE;",
      "UPDATE TABLE_MYSQL_MQ SET owner=?, \"expTime\"=? WHERE id IN (?);"
    ],
    "sql_types": [
      "SELECT",
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/austincheng__flowdriver_pg/postgresql_as_mq/message.go",
        "code_start_line": 20,
        "code_end_line": 26,
        "code_key": "Message",
        "code_value": "type Message struct {\n\tId         *int64  `gorm:\"column:id\"`\n\tOwner      *string `gorm:\"column:owner\"`\n\tExpTime    *string `gorm:\"column:expTime\"`\n\tCreateTime *string `gorm:\"column:createTime\"`\n\tMsg        *string `gorm:\"column:msg\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "c1ee825a44d2c5c6a3db80a58149c96d7eb62f76"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/austincheng__flowdriver_pg.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/austincheng__flowdriver_pg/postgresql_as_mq/message.go:28:70:GetBatchMsg",
    "orm_code": "func GetBatchMsg(ctx context.Context, owner string, expSeconds int64, batchSize int64, renewInterval int64) (msgList []Message, err error) {\n\n\tdefer func() {\n\t\tif errs := recover(); errs != nil {\n\t\t\tqlog.QErrorF(ctx, \"batch get msg error: %+v\", errs)\n\t\t\terr = errors.New(fmt.Sprintf(\"%+v\", errs))\n\t\t}\n\t}()\n\n\tmsgList = make([]Message, 0)\n\n\terr = GetTxManager().DoTransaction(ctx, func(ctx context.Context, db *gorm.DB) error {\n\t\texpTime := time.Now().Add(-1 * time.Duration(renewInterval) * time.Second).Format(common.DEFAULT_TIME_FORMAT)\n\n\t\tquerySql := \"select * from \" + TABLE_MYSQL_MQ + \" where owner is NULL or \\\"expTime\\\" <= ? limit ? for update \"\n\t\tif err = db.Raw(querySql, expTime, batchSize).Scan(&msgList).Error; err != nil {\n\t\t\tif err == gorm.ErrRecordNotFound {\n\t\t\t\treturn nil\n\t\t\t}\n\t\t\treturn errors.Trace(err)\n\t\t}\n\n\t\tmsgIdList := make([]int64, 0)\n\t\tfor i, msg := range msgList {\n\t\t\tmsgList[i].Owner = &owner\n\t\t\tmsgIdList = append(msgIdList, *msg.Id)\n\t\t}\n\n\t\tupdateSql := \"update \" + TABLE_MYSQL_MQ + \" set owner=? , \\\"expTime\\\" = ? where id in (?)\"\n\t\tif err = db.Exec(updateSql, owner,\n\t\t\ttime.Now().Add(time.Duration(expSeconds) * time.Second).Format(common.DEFAULT_TIME_FORMAT), msgIdList).Error; err != nil {\n\t\t\treturn errors.Trace(err)\n\t\t}\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\treturn make([]Message, 0), err\n\t}\n\n\treturn msgList, nil\n\n}",
    "caller": "func (c *mysqlMqClient) Dequeue(ctx context.Context) (msgList []Message, err error) {\n\n\tmsgList, err = GetBatchMsg(ctx, c.name, c.expSeconds, c.batchMsgSize, renewInterval)\n\tif err != nil {\n\t\treturn nil, errors.Trace(err)\n\t}\n\treturn msgList, err\n}",
    "sql_statement_list": [
      "SELECT * FROM TABLE_MYSQL_MQ WHERE owner IS NULL OR expTime <= ? LIMIT ? FOR UPDATE;",
      "UPDATE TABLE_MYSQL_MQ SET owner = ?, expTime = ? WHERE id IN (?);"
    ],
    "sql_types": [
      "SELECT",
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/austincheng__flowdriver_pg/postgresql_as_mq/message.go",
        "code_start_line": 20,
        "code_end_line": 26,
        "code_key": "Message",
        "code_value": "type Message struct {\n\tId         *int64  `gorm:\"column:id\"`\n\tOwner      *string `gorm:\"column:owner\"`\n\tExpTime    *string `gorm:\"column:expTime\"`\n\tCreateTime *string `gorm:\"column:createTime\"`\n\tMsg        *string `gorm:\"column:msg\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "c1ee825a44d2c5c6a3db80a58149c96d7eb62f76"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/austincheng__flowdriver_pg.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/blockchain_develop_platform__tbdp_develop_web/ctrl/cloudapi/subscribe/add_chain_subscribe.go:80:162:Process",
    "orm_code": "func (h *AddChainSubscribeHandler) Process() {\n\tdefer func() {\n\t\tutil.CreateAuditLogByChainSubscribe(h.Req.AppId, \"AddChainSubscribe\", h.Req.ChainId,\n\t\t\th.GetError() == nil, h.Req, h.Resp)\n\t}()\n\t// 调用同步服务，先确认链的联通性，并拿到链的信息\n\th.Req.Action = client.DescribeChainInfoBySubscribeConfig\n\tchainData, err := client.DescribeChainInfo(h.Req)\n\tif err != nil {\n\t\t// 如果不要求强制创建，则直接返回\n\t\tif !common.Conf.IsForceCreate {\n\t\t\th.SetError(apicomm.ErrCodeInvokeSynError, seelog.Errorf(\"DescribeChainInfoBySubscribeConfig failed, \"+\n\t\t\t\t\"err: %s\", err.Error()))\n\t\t\treturn\n\t\t} else {\n\t\t\t_ = seelog.Errorf(\"DescribeChainInfoBySubscribeConfig failed, err: %s\", err.Error())\n\t\t}\n\t}\n\tif chainData != nil {\n\t\th.ChainUid = chainData.ChainUid\n\t\th.ChainId = chainData.ChainId\n\t\th.Version = chainData.Version\n\t\th.Consensus = chainData.Consensus\n\t\th.Hash = chainData.Hash\n\t\th.ContractTypes = strings.Join(chainData.ContractTypes, \",\")\n\t\th.BlockInterval = int64(chainData.BlockInterval)\n\t\th.BlockSize = int64(chainData.BlockSize)\n\t\th.TxTimeout = int64(chainData.TxTimeout)\n\t\tseelog.Infof(\"DescribeChainInfoBySubscribeConfig success, chainInfo: %v\", chainData)\n\t}\n\terr = db.DB.Transaction(func(tx *gorm.DB) error {\n\t\t// 查看是否存在该链信息，如果有，则复用链的 info_id，否则新建\n\t\tchainInfo, innerErr := db.ChainInfoNsp.FindOneByChainIdAndUid(tx, h.Req.ChainId, h.ChainUid)\n\t\tif innerErr != nil {\n\t\t\treturn seelog.Errorf(\"FindOneByChainIdAndUid failed, err: %s\", innerErr.Error())\n\t\t}\n\t\tif chainInfo == nil {\n\t\t\tchainInfo, innerErr = db.ChainInfoNsp.CreateChainInfo(tx, h.ChainUid, h.ChainId, h.Version,\n\t\t\t\th.Consensus, h.Hash, h.ContractTypes, h.BlockInterval, h.BlockSize, h.TxTimeout)\n\t\t\tif innerErr != nil {\n\t\t\t\treturn seelog.Errorf(\"CreateChainInfo failed, err: %s\", innerErr.Error())\n\t\t\t}\n\t\t}\n\t\t// 检查是否订阅了同一条链\n\t\tsubscribe, innerErr := db.SubscribeNsp.FindOneByAppIdAndChainInfoId(tx, h.Req.AppId, chainInfo.Id)\n\t\tif innerErr != nil {\n\t\t\treturn seelog.Errorf(\"FindOneByAppIdAndChainInfoId failed, err: %s\",\n\t\t\t\tinnerErr.Error())\n\t\t}\n\t\tif subscribe != nil {\n\t\t\treturn seelog.Errorf(\"chain %s has been subscribed\", h.Req.ChainId)\n\t\t}\n\t\t// 插入订阅信息, authType-身份模式，为预留字段，默认 0\n\t\tsubscribe, innerErr = db.SubscribeNsp.CreateSubscribe(tx, h.Req.AppId, h.Req.OrgUniqueId, h.Req.OrgUniqueId,\n\t\t\th.Req.ChainId, h.ChainId, \"\", chainInfo.Id, 0, h.Req.RootCrt, h.Req.UserTLSCrt, h.Req.UserTLSKey,\n\t\t\th.Req.UserSignCrt, h.Req.UserSignKey, apicomm.SubscribeStatusProcessing)\n\t\tif innerErr != nil {\n\t\t\treturn seelog.Errorf(\"CreateSubscribe failed, err: %s\", innerErr.Error())\n\t\t}\n\t\th.Resp.SubscribeId = subscribe.Id\n\t\t// 插入被订阅的节点信息\n\t\tfor _, node := range h.Req.ChainSubscribeNodeList {\n\t\t\tvar subNode *db.SubscribeNodeModel\n\t\t\tsubNode, innerErr = db.SubscribeNodeNsp.CreateSubscribeNode(tx, subscribe.Id, chainInfo.Id, node.HostName,\n\t\t\t\tnode.NodeAddress, node.NodePort, 10, 1, h.Req.RootCrt)\n\t\t\tif innerErr != nil {\n\t\t\t\treturn seelog.Errorf(\"CreateSubscribeNode failed, err: %s\", innerErr.Error())\n\t\t\t}\n\t\t\tseelog.Infof(\"CreateSubscribeNode success: %v\", subNode)\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\th.SetError(apicomm.ErrCodeInvalidReq, seelog.Errorf(\"CreateSubscribe failed, err: %s\", err.Error()))\n\t\treturn\n\t}\n\t// 触发更新订阅状态\n\terr = client.ModifyChainSDK(h.Resp.SubscribeId)\n\tif err != nil {\n\t\t// 更新失败打印一下日志\n\t\t_ = seelog.Errorf(\"CreateSubscribe failed, err: %s\", err.Error())\n\t}\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/blockchain_develop_platform__tbdp_develop_web.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/blockchain_develop_platform__tbdp_develop_web/ctrl/cloudapi/subscribe/add_chain_subscribe.go:80:162:Process",
    "orm_code": "func (h *AddChainSubscribeHandler) Process() {\n\tdefer func() {\n\t\tutil.CreateAuditLogByChainSubscribe(h.Req.AppId, \"AddChainSubscribe\", h.Req.ChainId,\n\t\t\th.GetError() == nil, h.Req, h.Resp)\n\t}()\n\t// 调用同步服务，先确认链的联通性，并拿到链的信息\n\th.Req.Action = client.DescribeChainInfoBySubscribeConfig\n\tchainData, err := client.DescribeChainInfo(h.Req)\n\tif err != nil {\n\t\t// 如果不要求强制创建，则直接返回\n\t\tif !common.Conf.IsForceCreate {\n\t\t\th.SetError(apicomm.ErrCodeInvokeSynError, seelog.Errorf(\"DescribeChainInfoBySubscribeConfig failed, \"+\n\t\t\t\t\"err: %s\", err.Error()))\n\t\t\treturn\n\t\t} else {\n\t\t\t_ = seelog.Errorf(\"DescribeChainInfoBySubscribeConfig failed, err: %s\", err.Error())\n\t\t}\n\t}\n\tif chainData != nil {\n\t\th.ChainUid = chainData.ChainUid\n\t\th.ChainId = chainData.ChainId\n\t\th.Version = chainData.Version\n\t\th.Consensus = chainData.Consensus\n\t\th.Hash = chainData.Hash\n\t\th.ContractTypes = strings.Join(chainData.ContractTypes, \",\")\n\t\th.BlockInterval = int64(chainData.BlockInterval)\n\t\th.BlockSize = int64(chainData.BlockSize)\n\t\th.TxTimeout = int64(chainData.TxTimeout)\n\t\tseelog.Infof(\"DescribeChainInfoBySubscribeConfig success, chainInfo: %v\", chainData)\n\t}\n\terr = db.DB.Transaction(func(tx *gorm.DB) error {\n\t\t// 查看是否存在该链信息，如果有，则复用链的 info_id，否则新建\n\t\tchainInfo, innerErr := db.ChainInfoNsp.FindOneByChainIdAndUid(tx, h.Req.ChainId, h.ChainUid)\n\t\tif innerErr != nil {\n\t\t\treturn seelog.Errorf(\"FindOneByChainIdAndUid failed, err: %s\", innerErr.Error())\n\t\t}\n\t\tif chainInfo == nil {\n\t\t\tchainInfo, innerErr = db.ChainInfoNsp.CreateChainInfo(tx, h.ChainUid, h.ChainId, h.Version,\n\t\t\t\th.Consensus, h.Hash, h.ContractTypes, h.BlockInterval, h.BlockSize, h.TxTimeout)\n\t\t\tif innerErr != nil {\n\t\t\t\treturn seelog.Errorf(\"CreateChainInfo failed, err: %s\", innerErr.Error())\n\t\t\t}\n\t\t}\n\t\t// 检查是否订阅了同一条链\n\t\tsubscribe, innerErr := db.SubscribeNsp.FindOneByAppIdAndChainInfoId(tx, h.Req.AppId, chainInfo.Id)\n\t\tif innerErr != nil {\n\t\t\treturn seelog.Errorf(\"FindOneByAppIdAndChainInfoId failed, err: %s\",\n\t\t\t\tinnerErr.Error())\n\t\t}\n\t\tif subscribe != nil {\n\t\t\treturn seelog.Errorf(\"chain %s has been subscribed\", h.Req.ChainId)\n\t\t}\n\t\t// 插入订阅信息, authType-身份模式，为预留字段，默认 0\n\t\tsubscribe, innerErr = db.SubscribeNsp.CreateSubscribe(tx, h.Req.AppId, h.Req.OrgUniqueId, h.Req.OrgUniqueId,\n\t\t\th.Req.ChainId, h.ChainId, \"\", chainInfo.Id, 0, h.Req.RootCrt, h.Req.UserTLSCrt, h.Req.UserTLSKey,\n\t\t\th.Req.UserSignCrt, h.Req.UserSignKey, apicomm.SubscribeStatusProcessing)\n\t\tif innerErr != nil {\n\t\t\treturn seelog.Errorf(\"CreateSubscribe failed, err: %s\", innerErr.Error())\n\t\t}\n\t\th.Resp.SubscribeId = subscribe.Id\n\t\t// 插入被订阅的节点信息\n\t\tfor _, node := range h.Req.ChainSubscribeNodeList {\n\t\t\tvar subNode *db.SubscribeNodeModel\n\t\t\tsubNode, innerErr = db.SubscribeNodeNsp.CreateSubscribeNode(tx, subscribe.Id, chainInfo.Id, node.HostName,\n\t\t\t\tnode.NodeAddress, node.NodePort, 10, 1, h.Req.RootCrt)\n\t\t\tif innerErr != nil {\n\t\t\t\treturn seelog.Errorf(\"CreateSubscribeNode failed, err: %s\", innerErr.Error())\n\t\t\t}\n\t\t\tseelog.Infof(\"CreateSubscribeNode success: %v\", subNode)\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\th.SetError(apicomm.ErrCodeInvalidReq, seelog.Errorf(\"CreateSubscribe failed, err: %s\", err.Error()))\n\t\treturn\n\t}\n\t// 触发更新订阅状态\n\terr = client.ModifyChainSDK(h.Resp.SubscribeId)\n\tif err != nil {\n\t\t// 更新失败打印一下日志\n\t\t_ = seelog.Errorf(\"CreateSubscribe failed, err: %s\", err.Error())\n\t}\n}",
    "caller": "func Run(handler ReqHandlerInterface, c *gin.Context) {\n\tif handler.BindReq(c); handler.GetError() != nil {\n\t\treturn\n\t}\n\tif handler.AfterBindReq(); handler.GetError() != nil {\n\t\treturn\n\t}\n\thandler.Process()\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/blockchain_develop_platform__tbdp_develop_web.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/blockchain_develop_platform__tbdp_develop_web/ctrl/cloudapi/subscribe/modify_chain_subscribe.go:106:159:Process",
    "orm_code": "func (h *ModifyChainSubscribeHandler) Process() {\n\tdefer func() {\n\t\tutil.CreateAuditLogByChainSubscribe(h.Req.AppId, \"ModifyChainSubscribe\", h.SubscribeModel.ChainName,\n\t\t\th.GetError() == nil, h.Req, h.Resp)\n\t}()\n\th.SubscribeModel.RootCrt = h.Req.RootCrt\n\th.SubscribeModel.UserSignCrt = h.Req.UserSignCrt\n\th.SubscribeModel.UserSignKey = h.Req.UserSignKey\n\th.SubscribeModel.UserTlsCrt = h.Req.UserTLSCrt\n\th.SubscribeModel.UserTlsKey = h.Req.UserTLSKey\n\th.SubscribeModel.Status = apicomm.SubscribeStatusProcessing\n\terr := db.DB.Transaction(func(tx *gorm.DB) error {\n\t\tif h.SubscribeModel.OrgId != h.Req.OrgUniqueId {\n\t\t\th.SubscribeModel.OrgId = h.Req.OrgUniqueId\n\t\t}\n\t\t// 更新订阅状态\n\t\terr := tx.Save(h.SubscribeModel).Error\n\t\tif err != nil {\n\t\t\treturn seelog.Errorf(\"Save SubscribeModel failed, err: %s\", err.Error())\n\t\t}\n\t\t// 更新链信息\n\t\terr = tx.Save(h.ChainInfoModel).Error\n\t\tif err != nil {\n\t\t\treturn seelog.Errorf(\"Save ChainInfoModel failed, err: %s\", err.Error())\n\t\t}\n\n\t\t// 处理订阅节点，先删除，再插入\n\t\terr = db.SubscribeNodeNsp.DeleteBySubscribeId(tx, h.SubscribeModel.Id)\n\t\tif err != nil {\n\t\t\treturn seelog.Errorf(\"DeleteBySubscribeId failed, err: %s\", err.Error())\n\t\t}\n\t\t// 插入被订阅的节点信息\n\t\tfor _, node := range h.Req.ChainSubscribeNodeList {\n\t\t\tvar subNode *db.SubscribeNodeModel\n\t\t\tsubNode, err = db.SubscribeNodeNsp.CreateSubscribeNode(tx, h.SubscribeModel.Id,\n\t\t\t\th.SubscribeModel.ChainInfoId, node.HostName, node.NodeAddress, node.NodePort, 10, 1, h.Req.RootCrt)\n\t\t\tif err != nil {\n\t\t\t\treturn seelog.Errorf(\"CreateSubscribeNode failed, err: %s\", err.Error())\n\t\t\t}\n\t\t\tseelog.Infof(\"CreateSubscribeNode success: %v\", subNode)\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\th.SetError(apicomm.ErrCodeInvalidReq, err)\n\t\treturn\n\t}\n\t// 触发更新订阅状态\n\terr = client.ModifyChainSDK(h.Req.SubscribeId)\n\tif err != nil {\n\t\t// 更新失败打印一下日志\n\t\t_ = seelog.Errorf(\"ModifySubscribe failed, err: %s\", err.Error())\n\t}\n}",
    "caller": "",
    "sql_statement_list": [
      "UPDATE `subscribe_model` SET `root_crt`=?, `user_sign_crt`=?, `user_sign_key`=?, `user_tls_crt`=?, `user_tls_key`=?, `status`=?, `org_id`=?, `updated_at`=? WHERE `id` = ?;",
      "UPDATE `chain_info_model` SET `updated_at`=? WHERE `id` = ?;",
      "DELETE FROM `subscribe_node_model` WHERE subscribe_id = ?;",
      "INSERT INTO `subscribe_node_model` (`subscribe_id`, `chain_info_id`, `host_name`, `node_address`, `node_port`, `created_at`, `updated_at`) VALUES (?, ?, ?, ?, ?, ?, ?);"
    ],
    "sql_types": [
      "UPDATE",
      "UPDATE",
      "DELETE",
      "INSERT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/blockchain_develop_platform__tbdp_develop_web.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/blockchain_develop_platform__tbdp_develop_web/ctrl/cloudapi/subscribe/modify_chain_subscribe.go:106:159:Process",
    "orm_code": "func (h *ModifyChainSubscribeHandler) Process() {\n\tdefer func() {\n\t\tutil.CreateAuditLogByChainSubscribe(h.Req.AppId, \"ModifyChainSubscribe\", h.SubscribeModel.ChainName,\n\t\t\th.GetError() == nil, h.Req, h.Resp)\n\t}()\n\th.SubscribeModel.RootCrt = h.Req.RootCrt\n\th.SubscribeModel.UserSignCrt = h.Req.UserSignCrt\n\th.SubscribeModel.UserSignKey = h.Req.UserSignKey\n\th.SubscribeModel.UserTlsCrt = h.Req.UserTLSCrt\n\th.SubscribeModel.UserTlsKey = h.Req.UserTLSKey\n\th.SubscribeModel.Status = apicomm.SubscribeStatusProcessing\n\terr := db.DB.Transaction(func(tx *gorm.DB) error {\n\t\tif h.SubscribeModel.OrgId != h.Req.OrgUniqueId {\n\t\t\th.SubscribeModel.OrgId = h.Req.OrgUniqueId\n\t\t}\n\t\t// 更新订阅状态\n\t\terr := tx.Save(h.SubscribeModel).Error\n\t\tif err != nil {\n\t\t\treturn seelog.Errorf(\"Save SubscribeModel failed, err: %s\", err.Error())\n\t\t}\n\t\t// 更新链信息\n\t\terr = tx.Save(h.ChainInfoModel).Error\n\t\tif err != nil {\n\t\t\treturn seelog.Errorf(\"Save ChainInfoModel failed, err: %s\", err.Error())\n\t\t}\n\n\t\t// 处理订阅节点，先删除，再插入\n\t\terr = db.SubscribeNodeNsp.DeleteBySubscribeId(tx, h.SubscribeModel.Id)\n\t\tif err != nil {\n\t\t\treturn seelog.Errorf(\"DeleteBySubscribeId failed, err: %s\", err.Error())\n\t\t}\n\t\t// 插入被订阅的节点信息\n\t\tfor _, node := range h.Req.ChainSubscribeNodeList {\n\t\t\tvar subNode *db.SubscribeNodeModel\n\t\t\tsubNode, err = db.SubscribeNodeNsp.CreateSubscribeNode(tx, h.SubscribeModel.Id,\n\t\t\t\th.SubscribeModel.ChainInfoId, node.HostName, node.NodeAddress, node.NodePort, 10, 1, h.Req.RootCrt)\n\t\t\tif err != nil {\n\t\t\t\treturn seelog.Errorf(\"CreateSubscribeNode failed, err: %s\", err.Error())\n\t\t\t}\n\t\t\tseelog.Infof(\"CreateSubscribeNode success: %v\", subNode)\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\th.SetError(apicomm.ErrCodeInvalidReq, err)\n\t\treturn\n\t}\n\t// 触发更新订阅状态\n\terr = client.ModifyChainSDK(h.Req.SubscribeId)\n\tif err != nil {\n\t\t// 更新失败打印一下日志\n\t\t_ = seelog.Errorf(\"ModifySubscribe failed, err: %s\", err.Error())\n\t}\n}",
    "caller": "func Run(handler ReqHandlerInterface, c *gin.Context) {\n\tif handler.BindReq(c); handler.GetError() != nil {\n\t\treturn\n\t}\n\tif handler.AfterBindReq(); handler.GetError() != nil {\n\t\treturn\n\t}\n\thandler.Process()\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "OrgId需要更新时",
            "sql": "UPDATE subscribe_model SET root_crt = ?, user_sign_crt = ?, user_sign_key = ?, user_tls_crt = ?, user_tls_key = ?, status = ?, org_id = ?, updated_at = ? WHERE id = ?;"
          },
          {
            "scenario": "OrgId不需要更新时",
            "sql": "UPDATE subscribe_model SET root_crt = ?, user_sign_crt = ?, user_sign_key = ?, user_tls_crt = ?, user_tls_key = ?, status = ?, updated_at = ? WHERE id = ?;"
          }
        ]
      },
      "UPDATE chain_info_model SET updated_at = ? WHERE id = ?;",
      "DELETE FROM subscribe_node_model WHERE subscribe_id = ?;"
    ],
    "sql_types": [
      "PARAM_DEPENDENT",
      "UPDATE",
      "DELETE"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 3,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/blockchain_develop_platform__tbdp_develop_web.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/blockchain_develop_platform__tbdp_sync_service/crontask/org_info_task.go:21:111:pullOrgsForChain",
    "orm_code": "func pullOrgsForChain(uid string, c *client.Client) {\n\tchainInfoDb := &db.ChainInfoModel{\n\t\tChainUid: uid,\n\t}\n\tchainInfo, err := chainInfoDb.FindOneByChainUid(db.DB)\n\tif err != nil {\n\t\tseelog.Errorf(\"get chain info error: %+v\\n\", err)\n\t\treturn\n\t}\n\t// 获取链配置\n\tcc, err := c.GetChainConfig()\n\tif err != nil {\n\t\tseelog.Errorf(\"pull chain %s config error: %+v\\n\", uid, err)\n\t\treturn\n\t}\n\tnewOrgs := make(map[string]*db.OrgInfoModel)\n\tfor _, org := range cc.TrustRoots {\n\t\torgInfo := &db.OrgInfoModel{\n\t\t\tChainInfoId: chainInfo.Id,\n\t\t\tOrgId:       org.OrgId,\n\t\t}\n\t\ttx := &db.ChainTransactionModel{\n\t\t\tChainInfoId: chainInfo.Id,\n\t\t\tSender:      org.OrgId,\n\t\t}\n\t\ttxCount, err := tx.GetTxCountBySender(db.DB)\n\t\tif err != nil {\n\t\t\tseelog.Errorf(\"get chain %s org %s tx count error: %+v\\n\", uid, org.OrgId, err)\n\t\t\torgInfo.OrgTxCount = 0\n\t\t} else {\n\t\t\torgInfo.OrgTxCount = txCount\n\t\t}\n\t\tnewOrgs[org.OrgId] = orgInfo\n\t}\n\n\torgInfo := &db.OrgInfoModel{\n\t\tChainInfoId: chainInfo.Id,\n\t}\n\tallOrgs, err := orgInfo.GetOrgInfosByChainInfoId(db.DB)\n\tif err != nil {\n\t\tseelog.Errorf(\"get chain %s org info error: %+v\\n\", uid, err)\n\t\treturn\n\t}\n\toldOrgs := make(map[string]*db.OrgInfoModel)\n\tfor _, org := range allOrgs {\n\t\toldOrgs[org.OrgId] = org\n\t}\n\n\tfor _, org := range newOrgs {\n\t\tdelete(oldOrgs, org.OrgId)\n\t}\n\n\terr = db.DB.Transaction(func(tx *gorm.DB) error {\n\t\t// 删除链上已经不存在的节点\n\t\tfor _, n := range oldOrgs {\n\t\t\terr := n.Delete(tx)\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\t// 创建链上的新组织\n\t\tfor _, n := range newOrgs {\n\t\t\ten, err := n.GetOrgInfoByOrgIdAndUid(tx)\n\t\t\tif err != nil {\n\t\t\t\tif gorm.IsRecordNotFoundError(err) {\n\t\t\t\t\tseelog.Infof(\"create new org %+v\\n\", n)\n\t\t\t\t\terr := n.Create(tx)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tseelog.Errorf(\"get chain org error: %+v\\n\", err)\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif en.Id != 0 {\n\t\t\t\t\tseelog.Infof(\"update org %+v\\n\", n)\n\t\t\t\t\terr := n.Update(tx)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\tseelog.Errorf(\"update chain %s org info error: %+v\\n\", uid, err)\n\t\treturn\n\t}\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT * FROM chain_info WHERE chain_uid = ? LIMIT 1;",
      "SELECT count(*) FROM chain_transaction WHERE chain_info_id = ? AND sender = ?;",
      "SELECT * FROM org_info WHERE chain_info_id = ?;",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "删除不存在的组织",
            "sql": "DELETE FROM org_info WHERE id = ?;"
          },
          {
            "scenario": "查询组织是否存在",
            "sql": "SELECT * FROM org_info WHERE org_id = ? AND chain_info_id = ? LIMIT 1;"
          },
          {
            "scenario": "创建新组织",
            "sql": "INSERT INTO org_info (chain_info_id, org_id, org_tx_count) VALUES (?, ?, ?);"
          },
          {
            "scenario": "更新现有组织",
            "sql": "UPDATE org_info SET org_tx_count = ? WHERE id = ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "SELECT",
      "SELECT",
      "SELECT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/blockchain_develop_platform__tbdp_sync_service/chainmaker/client/client.go",
        "code_start_line": 24,
        "code_end_line": 35,
        "code_key": "Client",
        "code_value": "type Client struct {\n\tclient *cmc.ChainClient\n\n\tOrgName       string\n\tChainName     string\n\tOrgCACertList []string\n\tUserTLSCrt    string\n\tUserTLSKey    string\n\tUserSignCrt   string\n\tUserSignKey   string\n\tChainNodeList []*ChainNode\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "bf5f6594090fe15099b7ad5086fcd16e32138132"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/blockchain_develop_platform__tbdp_sync_service.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/blockchain_develop_platform__tbdp_sync_service/crontask/org_info_task.go:21:111:pullOrgsForChain",
    "orm_code": "func pullOrgsForChain(uid string, c *client.Client) {\n\tchainInfoDb := &db.ChainInfoModel{\n\t\tChainUid: uid,\n\t}\n\tchainInfo, err := chainInfoDb.FindOneByChainUid(db.DB)\n\tif err != nil {\n\t\tseelog.Errorf(\"get chain info error: %+v\\n\", err)\n\t\treturn\n\t}\n\t// 获取链配置\n\tcc, err := c.GetChainConfig()\n\tif err != nil {\n\t\tseelog.Errorf(\"pull chain %s config error: %+v\\n\", uid, err)\n\t\treturn\n\t}\n\tnewOrgs := make(map[string]*db.OrgInfoModel)\n\tfor _, org := range cc.TrustRoots {\n\t\torgInfo := &db.OrgInfoModel{\n\t\t\tChainInfoId: chainInfo.Id,\n\t\t\tOrgId:       org.OrgId,\n\t\t}\n\t\ttx := &db.ChainTransactionModel{\n\t\t\tChainInfoId: chainInfo.Id,\n\t\t\tSender:      org.OrgId,\n\t\t}\n\t\ttxCount, err := tx.GetTxCountBySender(db.DB)\n\t\tif err != nil {\n\t\t\tseelog.Errorf(\"get chain %s org %s tx count error: %+v\\n\", uid, org.OrgId, err)\n\t\t\torgInfo.OrgTxCount = 0\n\t\t} else {\n\t\t\torgInfo.OrgTxCount = txCount\n\t\t}\n\t\tnewOrgs[org.OrgId] = orgInfo\n\t}\n\n\torgInfo := &db.OrgInfoModel{\n\t\tChainInfoId: chainInfo.Id,\n\t}\n\tallOrgs, err := orgInfo.GetOrgInfosByChainInfoId(db.DB)\n\tif err != nil {\n\t\tseelog.Errorf(\"get chain %s org info error: %+v\\n\", uid, err)\n\t\treturn\n\t}\n\toldOrgs := make(map[string]*db.OrgInfoModel)\n\tfor _, org := range allOrgs {\n\t\toldOrgs[org.OrgId] = org\n\t}\n\n\tfor _, org := range newOrgs {\n\t\tdelete(oldOrgs, org.OrgId)\n\t}\n\n\terr = db.DB.Transaction(func(tx *gorm.DB) error {\n\t\t// 删除链上已经不存在的节点\n\t\tfor _, n := range oldOrgs {\n\t\t\terr := n.Delete(tx)\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\t// 创建链上的新组织\n\t\tfor _, n := range newOrgs {\n\t\t\ten, err := n.GetOrgInfoByOrgIdAndUid(tx)\n\t\t\tif err != nil {\n\t\t\t\tif gorm.IsRecordNotFoundError(err) {\n\t\t\t\t\tseelog.Infof(\"create new org %+v\\n\", n)\n\t\t\t\t\terr := n.Create(tx)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tseelog.Errorf(\"get chain org error: %+v\\n\", err)\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif en.Id != 0 {\n\t\t\t\t\tseelog.Infof(\"update org %+v\\n\", n)\n\t\t\t\t\terr := n.Update(tx)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\tif err != nil {\n\t\tseelog.Errorf(\"update chain %s org info error: %+v\\n\", uid, err)\n\t\treturn\n\t}\n}",
    "caller": "func getOrgInfo() {\n\tseelog.Info(\"get chain begin\")\n\tfor uid, client := range chain.GetCmcClients() {\n\t\tpullOrgsForChain(uid, client)\n\t}\n\tseelog.Info(\"get chain end\")\n}",
    "sql_statement_list": [
      "SELECT * FROM chain_info WHERE chain_uid = ? LIMIT 1;",
      "SELECT COUNT(*) FROM chain_transaction WHERE chain_info_id = ? AND sender = ?;",
      "SELECT * FROM org_info WHERE chain_info_id = ?;",
      "DELETE FROM org_info WHERE id = ?;",
      "SELECT * FROM org_info WHERE org_id = ? AND chain_info_id = ? LIMIT 1;",
      "INSERT INTO org_info (chain_info_id, org_id, org_tx_count) VALUES (?, ?, ?);",
      "UPDATE org_info SET org_tx_count = ? WHERE id = ?;"
    ],
    "sql_types": [
      "SELECT",
      "SELECT",
      "SELECT",
      "DELETE",
      "SELECT",
      "INSERT",
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/blockchain_develop_platform__tbdp_sync_service/chainmaker/client/client.go",
        "code_start_line": 24,
        "code_end_line": 35,
        "code_key": "Client",
        "code_value": "type Client struct {\n\tclient *cmc.ChainClient\n\n\tOrgName       string\n\tChainName     string\n\tOrgCACertList []string\n\tUserTLSCrt    string\n\tUserTLSKey    string\n\tUserSignCrt   string\n\tUserSignKey   string\n\tChainNodeList []*ChainNode\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "bf5f6594090fe15099b7ad5086fcd16e32138132"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/blockchain_develop_platform__tbdp_sync_service.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/blockchain_develop_platform__tbdp_sync_service/crontask/chain_node_task.go:195:297:updateNodes",
    "orm_code": "func updateNodes(newNodes map[string]*db.ChainNodeModel, newConsensusNodes map[string]*db.ChainConsensusNodeModel,\n\tchainInfo *db.ChainInfoModel, subId int64) {\n\tseelog.Infof(\"update nodes, chain info: %+v\\n\", chainInfo)\n\toldNodes := make(map[string]*db.ChainNodeModel)\n\toldConsensusNodes := make(map[string]*db.ChainConsensusNodeModel)\n\tchainNode := &db.ChainNodeModel{\n\t\tChainInfoId: chainInfo.Id,\n\t\tSubscribeId: subId,\n\t}\n\tallNodes, err := chainNode.GetChainNodesBySubscribeIdAndChainInfoId(db.DB)\n\tif err != nil {\n\t\tseelog.Errorf(\"get chain nodes error: %+v\\n\", err)\n\t\treturn\n\t}\n\tseelog.Infof(\"old nodes, length: %d\\n\", len(oldNodes))\n\tfor _, n := range allNodes {\n\t\toldNodes[n.NodeId] = n\n\t}\n\tchainConsensusNode := &db.ChainConsensusNodeModel{\n\t\tChainInfoId: chainInfo.Id,\n\t}\n\tallConsensusNodes, err := chainConsensusNode.GetChainConsensusNodesByChainInfoId(db.DB)\n\tif err != nil {\n\t\tseelog.Errorf(\"get chain consensus nodes error: %+v\\n\", err)\n\t\treturn\n\t}\n\tseelog.Infof(\"old consensus nodes, length: %d\\n\", len(oldConsensusNodes))\n\tfor _, n := range allConsensusNodes {\n\t\toldConsensusNodes[n.NodeId] = n\n\t}\n\tfor _, n := range newNodes {\n\t\t// 如果 Node 在数据库中存在，则移除\n\t\tif _, ok := oldNodes[n.NodeId]; ok {\n\t\t\tseelog.Infof(\"delete old node %+v\\n\", n)\n\t\t\tdelete(oldNodes, n.NodeId)\n\t\t}\n\t}\n\n\tfor _, n := range newConsensusNodes {\n\t\t// 如果共识 Node 在数据库中存在，则移除\n\t\tif _, ok := oldConsensusNodes[n.NodeId]; ok {\n\t\t\tseelog.Infof(\"delete old consensus node %+v\\n\", n)\n\t\t\tdelete(oldConsensusNodes, n.NodeId)\n\t\t\tdelete(newConsensusNodes, n.NodeId)\n\t\t}\n\t}\n\n\tseelog.Infof(\"final new nodes: %d, new consensus nodes: %d\\n\", len(newNodes), len(newConsensusNodes))\n\terr = db.DB.Transaction(func(tx *gorm.DB) error {\n\t\t// 删除链上已经不存在的节点\n\t\tfor _, n := range oldNodes {\n\t\t\tseelog.Infof(\"delete old node %+v\\n\", n)\n\t\t\terr := n.Delete(tx)\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\t// 删除链上已经不存在的共识节点\n\t\tfor _, n := range oldConsensusNodes {\n\t\t\tseelog.Infof(\"delete old consensus node %+v\\n\", n)\n\t\t\terr := n.Delete(tx)\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\n\t\tfor _, n := range newNodes {\n\t\t\ten, err := n.GetChainNodeByNodeIdAndSubscribeId(tx)\n\t\t\tif err != nil {\n\t\t\t\tif gorm.IsRecordNotFoundError(err) {\n\t\t\t\t\tseelog.Infof(\"create new node %+v\\n\", n)\n\t\t\t\t\terr := n.Create(tx)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tseelog.Errorf(\"get chain node error: %+v\\n\", err)\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif en.Id != 0 {\n\t\t\t\t\tseelog.Infof(\"update node %+v\\n\", n)\n\t\t\t\t\terr := n.Update(tx)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfor _, n := range newConsensusNodes {\n\t\t\tseelog.Infof(\"create new consensus node %+v\\n\", n)\n\t\t\terr := n.Create(tx)\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\tseelog.Errorf(\"update nodes error: %+v\\n\", err)\n\t}\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT * FROM chain_node WHERE chain_info_id = ? AND subscribe_id = ?;",
      "SELECT * FROM chain_consensus_node WHERE chain_info_id = ?;",
      "DELETE FROM chain_node WHERE id = ?;",
      "DELETE FROM chain_consensus_node WHERE id = ?;",
      "SELECT * FROM chain_node WHERE node_id = ? AND subscribe_id = ?;",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "当节点不存在时创建新节点",
            "sql": "INSERT INTO chain_node (chain_info_id, subscribe_id, node_id) VALUES (?, ?, ?);"
          },
          {
            "scenario": "当节点存在且ID不为0时更新节点",
            "sql": "UPDATE chain_node SET chain_info_id = ?, subscribe_id = ?, node_id = ? WHERE id = ?;"
          }
        ]
      },
      "INSERT INTO chain_consensus_node (chain_info_id, node_id) VALUES (?, ?);"
    ],
    "sql_types": [
      "SELECT",
      "SELECT",
      "DELETE",
      "DELETE",
      "SELECT",
      "PARAM_DEPENDENT",
      "INSERT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 6,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/blockchain_develop_platform__tbdp_sync_service.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/blockchain_develop_platform__tbdp_sync_service/crontask/chain_node_task.go:195:297:updateNodes",
    "orm_code": "func updateNodes(newNodes map[string]*db.ChainNodeModel, newConsensusNodes map[string]*db.ChainConsensusNodeModel,\n\tchainInfo *db.ChainInfoModel, subId int64) {\n\tseelog.Infof(\"update nodes, chain info: %+v\\n\", chainInfo)\n\toldNodes := make(map[string]*db.ChainNodeModel)\n\toldConsensusNodes := make(map[string]*db.ChainConsensusNodeModel)\n\tchainNode := &db.ChainNodeModel{\n\t\tChainInfoId: chainInfo.Id,\n\t\tSubscribeId: subId,\n\t}\n\tallNodes, err := chainNode.GetChainNodesBySubscribeIdAndChainInfoId(db.DB)\n\tif err != nil {\n\t\tseelog.Errorf(\"get chain nodes error: %+v\\n\", err)\n\t\treturn\n\t}\n\tseelog.Infof(\"old nodes, length: %d\\n\", len(oldNodes))\n\tfor _, n := range allNodes {\n\t\toldNodes[n.NodeId] = n\n\t}\n\tchainConsensusNode := &db.ChainConsensusNodeModel{\n\t\tChainInfoId: chainInfo.Id,\n\t}\n\tallConsensusNodes, err := chainConsensusNode.GetChainConsensusNodesByChainInfoId(db.DB)\n\tif err != nil {\n\t\tseelog.Errorf(\"get chain consensus nodes error: %+v\\n\", err)\n\t\treturn\n\t}\n\tseelog.Infof(\"old consensus nodes, length: %d\\n\", len(oldConsensusNodes))\n\tfor _, n := range allConsensusNodes {\n\t\toldConsensusNodes[n.NodeId] = n\n\t}\n\tfor _, n := range newNodes {\n\t\t// 如果 Node 在数据库中存在，则移除\n\t\tif _, ok := oldNodes[n.NodeId]; ok {\n\t\t\tseelog.Infof(\"delete old node %+v\\n\", n)\n\t\t\tdelete(oldNodes, n.NodeId)\n\t\t}\n\t}\n\n\tfor _, n := range newConsensusNodes {\n\t\t// 如果共识 Node 在数据库中存在，则移除\n\t\tif _, ok := oldConsensusNodes[n.NodeId]; ok {\n\t\t\tseelog.Infof(\"delete old consensus node %+v\\n\", n)\n\t\t\tdelete(oldConsensusNodes, n.NodeId)\n\t\t\tdelete(newConsensusNodes, n.NodeId)\n\t\t}\n\t}\n\n\tseelog.Infof(\"final new nodes: %d, new consensus nodes: %d\\n\", len(newNodes), len(newConsensusNodes))\n\terr = db.DB.Transaction(func(tx *gorm.DB) error {\n\t\t// 删除链上已经不存在的节点\n\t\tfor _, n := range oldNodes {\n\t\t\tseelog.Infof(\"delete old node %+v\\n\", n)\n\t\t\terr := n.Delete(tx)\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\t// 删除链上已经不存在的共识节点\n\t\tfor _, n := range oldConsensusNodes {\n\t\t\tseelog.Infof(\"delete old consensus node %+v\\n\", n)\n\t\t\terr := n.Delete(tx)\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\n\t\tfor _, n := range newNodes {\n\t\t\ten, err := n.GetChainNodeByNodeIdAndSubscribeId(tx)\n\t\t\tif err != nil {\n\t\t\t\tif gorm.IsRecordNotFoundError(err) {\n\t\t\t\t\tseelog.Infof(\"create new node %+v\\n\", n)\n\t\t\t\t\terr := n.Create(tx)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tseelog.Errorf(\"get chain node error: %+v\\n\", err)\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif en.Id != 0 {\n\t\t\t\t\tseelog.Infof(\"update node %+v\\n\", n)\n\t\t\t\t\terr := n.Update(tx)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfor _, n := range newConsensusNodes {\n\t\t\tseelog.Infof(\"create new consensus node %+v\\n\", n)\n\t\t\terr := n.Create(tx)\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\n\tif err != nil {\n\t\tseelog.Errorf(\"update nodes error: %+v\\n\", err)\n\t}\n}",
    "caller": "func pullNodesForChain(id string, c *client.Client) {\n\tids := strings.Split(id, \"_\")\n\tif len(ids) != 2 {\n\t\tseelog.Errorf(\"get subid and chain uid %s error\\n\", id)\n\t\treturn\n\t}\n\tuid := ids[1]\n\tsid, err := strconv.ParseInt(ids[0], 10, 64)\n\tif err != nil {\n\t\tseelog.Errorf(\"parse chain id error: %+v\\n\", err)\n\t\treturn\n\t}\n\n\tchainInfoDb := &db.ChainInfoModel{\n\t\tChainUid: uid,\n\t}\n\tchainInfo, err := chainInfoDb.FindOneByChainUid(db.DB)\n\tseelog.Infof(\"chain %s, chain db info: %+v\\n\", uid, chainInfo)\n\tif err != nil {\n\t\tseelog.Errorf(\"get chain info error: %+v\\n\", err)\n\t\treturn\n\t}\n\n\tsubscribeInfo := &db.SubscribeModel{}\n\tsubscribeInfo, err = subscribeInfo.FindBySubscribeId(db.DB, sid)\n\tif err != nil {\n\t\tseelog.Errorf(\"get subscribe info error: %+v\\n\", err)\n\t\treturn\n\t}\n\n\t// 获取链信息\n\tbegin := time.Now()\n\tci, err := c.GetChainInfo()\n\tseelog.Infof(\"chain %s, chain info: %+v\\n\", uid, ci)\n\tif err != nil {\n\t\tseelog.Errorf(\"pull chain %s info error: %+v\\n\", uid, err)\n\t\terr = subscribeInfo.SetSubscribeStatusAndLatency(db.DB, db.SubscribeStatusError, 0)\n\t\tif err != nil {\n\t\t\tseelog.Errorf(\"update subscribe info error: %+v\\n\", err)\n\t\t}\n\t\treturn\n\t}\n\tend := time.Now()\n\n\t// 更新订阅的状态和延迟\n\tlatency := end.Sub(begin).Milliseconds()\n\terr = subscribeInfo.SetSubscribeStatusAndLatency(db.DB, db.SubscribeStatusRunning, latency)\n\tif err != nil {\n\t\tseelog.Errorf(\"update subscribe info error: %+v\\n\", err)\n\t\treturn\n\t}\n\n\t// 获取链配置\n\tcc, err := c.GetChainConfig()\n\tseelog.Infof(\"chain %s, chain config: %+v\\n\", uid, cc)\n\tif err != nil {\n\t\tseelog.Errorf(\"pull chain %s config error: %+v\\n\", uid, err)\n\t\treturn\n\t}\n\n\t// 统计共识节点和对应的 orgId\n\tconsensusNodes := make(map[string]string)\n\tfor _, org := range cc.Consensus.Nodes {\n\t\tseelog.Infof(\"chain %s, consensus node: %+v\\n\", uid, org)\n\t\tfor _, n := range org.NodeId {\n\t\t\tconsensusNodes[n] = org.OrgId\n\t\t}\n\t}\n\n\t// 获取当前所有的节点，包括共识节点和非共识节点\n\tnewNodes := make(map[string]*db.ChainNodeModel)\n\tnewConsensusNodes := make(map[string]*db.ChainConsensusNodeModel)\n\n\t// 整理所有的节点信息\n\tformatNodes(ci, uid, sid, chainInfo, newNodes, newConsensusNodes, consensusNodes)\n\tseelog.Infof(\"chain %s, new nodes: %d, new consensus nodes: %d\\n\", uid, len(newNodes), len(newConsensusNodes))\n\n\t// 更新数据库中节点\n\tupdateNodes(newNodes, newConsensusNodes, chainInfo, sid)\n}",
    "sql_statement_list": [
      "SELECT * FROM chain_node_model WHERE chain_info_id = ? AND subscribe_id = ?;",
      "SELECT * FROM chain_consensus_node_model WHERE chain_info_id = ?;",
      "DELETE FROM chain_node_model WHERE id = ?;",
      "DELETE FROM chain_consensus_node_model WHERE id = ?;",
      "SELECT * FROM chain_node_model WHERE node_id = ? AND subscribe_id = ?;",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "创建新普通节点",
            "sql": "INSERT INTO chain_node_model (chain_info_id, subscribe_id, node_id) VALUES (?, ?, ?);"
          },
          {
            "scenario": "更新现有普通节点",
            "sql": "UPDATE chain_node_model SET chain_info_id = ?, subscribe_id = ?, node_id = ? WHERE id = ?;"
          },
          {
            "scenario": "创建新共识节点",
            "sql": "INSERT INTO chain_consensus_node_model (chain_info_id, node_id) VALUES (?, ?);"
          }
        ]
      }
    ],
    "sql_types": [
      "SELECT",
      "SELECT",
      "DELETE",
      "DELETE",
      "SELECT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 6,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/blockchain_develop_platform__tbdp_sync_service.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/blockchain_develop_platform__tbdp_sync_service/chainmaker/chain/parser.go:123:156:saveData",
    "orm_code": "func saveData(bm *db.ChainBlockModel, txms []*db.ChainTransactionModel, cms []*db.ChainContractModel) error {\n\treturn db.DB.Transaction(func(tx *gorm.DB) error {\n\t\terr := bm.CreateBlock(tx)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor _, t := range txms {\n\t\t\terr = t.CreateTx(tx)\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\tfor _, c := range cms {\n\t\t\tif c.ContractVersion == \"\" {\n\t\t\t\t// 冻结、解冻、废止合约时，合约版本为空时，此时无需创建合约数据，更新合约状态即可\n\t\t\t\terr = c.UpdateContractStatus(tx, c.ChainInfoId, c.ContractName, c.ContractStatus)\n\t\t\t\tif err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// 创建、升级合约时，合约版本不为空时，废弃之前的合约数据，创建一条新的合约数据\n\t\t\t\terr = c.SetContractInvalid(tx, c.ChainInfoId, c.ContractName)\n\t\t\t\tif err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t\terr = c.CreateContract(tx)\n\t\t\t\tif err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/blockchain_develop_platform__tbdp_sync_service.json",
    "matched_keywords": [
      "Transaction",
      "save"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/blockchain_develop_platform__tbdp_sync_service/chainmaker/chain/parser.go:123:156:saveData",
    "orm_code": "func saveData(bm *db.ChainBlockModel, txms []*db.ChainTransactionModel, cms []*db.ChainContractModel) error {\n\treturn db.DB.Transaction(func(tx *gorm.DB) error {\n\t\terr := bm.CreateBlock(tx)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t\tfor _, t := range txms {\n\t\t\terr = t.CreateTx(tx)\n\t\t\tif err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\t\t}\n\t\tfor _, c := range cms {\n\t\t\tif c.ContractVersion == \"\" {\n\t\t\t\t// 冻结、解冻、废止合约时，合约版本为空时，此时无需创建合约数据，更新合约状态即可\n\t\t\t\terr = c.UpdateContractStatus(tx, c.ChainInfoId, c.ContractName, c.ContractStatus)\n\t\t\t\tif err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// 创建、升级合约时，合约版本不为空时，废弃之前的合约数据，创建一条新的合约数据\n\t\t\t\terr = c.SetContractInvalid(tx, c.ChainInfoId, c.ContractName)\n\t\t\t\tif err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t\terr = c.CreateContract(tx)\n\t\t\t\tif err != nil {\n\t\t\t\t\treturn err\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n}",
    "caller": "func GetBlock(cmc *client.Client, blockHeight uint64, chainUid string, chainInfoId int64) uint64 {\n\tfmt.Println(\"get block invoke\")\n\tblock, err := cmc.GetBlockByHeight(blockHeight)\n\tif err != nil {\n\t\t// seelog.Errorf(\"get block error: %+v\\n\", err)\n\t\treturn blockHeight\n\t}\n\tblockm, err := convertBlock(block, chainUid, chainInfoId)\n\tif err != nil {\n\t\tseelog.Errorf(\"convert block error: %+v\\n\", err)\n\t\treturn blockHeight\n\t}\n\n\ttxms, cms, err := convertTxAndContracts(block, chainUid, chainInfoId)\n\tif err != nil {\n\t\tseelog.Errorf(\"convert tx or contract error: %+v\\n\", err)\n\t\treturn blockHeight\n\t}\n\n\terr = saveData(blockm, txms, cms)\n\tif err != nil {\n\t\tseelog.Errorf(\"save data error: %+v\\n\", err)\n\t\treturn blockHeight\n\t}\n\t// 开始拉取下一个区块\n\treturn blockHeight + 1\n}",
    "sql_statement_list": [
      "INSERT INTO chain_block (chain_info_id, block_height, block_hash, prev_block_hash, timestamp, tx_count) VALUES (?, ?, ?, ?, ?, ?);",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "单个交易的插入",
            "sql": "INSERT INTO chain_transaction (chain_info_id, block_height, tx_id, tx_hash, tx_type, timestamp) VALUES (?, ?, ?, ?, ?, ?);"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "合约版本为空时更新合约状态",
            "sql": "UPDATE chain_contract SET contract_status = ? WHERE chain_info_id = ? AND contract_name = ?;"
          },
          {
            "scenario": "合约版本不为空时废弃旧合约",
            "sql": "UPDATE chain_contract SET is_valid = 0 WHERE chain_info_id = ? AND contract_name = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "合约版本不为空时创建新合约",
            "sql": "INSERT INTO chain_contract (chain_info_id, contract_name, contract_version, contract_status, is_valid) VALUES (?, ?, ?, ?, ?);"
          }
        ]
      }
    ],
    "sql_types": [
      "INSERT",
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [],
    "sql_pattern_cnt": 1,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/blockchain_develop_platform__tbdp_sync_service.json",
    "matched_keywords": [
      "Transaction",
      "save"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/common__dao_orm/transaction_template.go:20:78:doTransaction",
    "orm_code": "func (this *transactionTemplate) doTransaction(ctx context.Context, fn func(context.Context, *gorm.DB) error) (err error) {\n\n\tdefer func() {\n\t\tpc, _, _, ok := runtime.Caller(stackSkip + 1)\n\t\tif !ok {\n\t\t\terr = eorm.AccessRuntimeStackError.GenWithStackByArgs(ctx)\n\t\t\treturn\n\t\t}\n\t\tcurEntry := runtime.FuncForPC(pc).Entry()\n\n\t\tvar e error\n\t\tvar tpId string\n\t\tif tpId, e = this.manager.getTransactionTemplateId(ctx, curEntry); e != nil {\n\t\t\terr = errors.Trace(e)\n\t\t}\n\t\ttmpl, _ := this.manager.transactionPool.Load(tpId)\n\t\ttpl, _ := tmpl.(*transactionTemplate)\n\t\tif tpl != nil {\n\n\t\t\tthis.manager.transactionPool.Delete(this.transactionEntry)\n\n\t\t\tif err != nil && this.db != nil {\n\t\t\t\tthis.db.Rollback()\n\t\t\t}\n\n\t\t\tif err == nil && this.db != nil {\n\t\t\t\te = this.db.Commit().Error\n\t\t\t}\n\n\t\t\tif e != nil {\n\t\t\t\terr = eorm.TransactionCommitError.GenWithStackByArgs(ctx)\n\t\t\t}\n\t\t}\n\t}()\n\n\tif this.db == nil {\n\t\t//this.db = gormtrace.DBwithCtx(ctx, this.manager.db).BeginTx(ctx, nil)\n\t\tthis.db = this.manager.db.WithContext(ctx).Begin()\n\n\t\tif this.db.Error != nil {\n\t\t\tqlog.QErrorF(ctx, \"[transactionTemplate] BeginTx error: %+v\", this.db.Error)\n\t\t\terr = eorm.TransactionBeginError.GenWithStackByArgs(ctx)\n\t\t\treturn err\n\t\t}\n\t}\n\n\tdefer func() {\n\t\tif coverErr := recover(); coverErr != nil {\n\t\t\terr = eorm.DBOperationActionError.GenWithStackByArgs(ctx)\n\t\t}\n\t}()\n\n\tif err = fn(ctx, this.db); err != nil {\n\t\tqlog.QErrorF(ctx, \"[transactionTemplate] DoTransaction call biz error,msg: %+v\", err)\n\t\terr = errors.Trace(err)\n\t\treturn err\n\t}\n\treturn err\n}",
    "caller": "",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/common__dao_orm/transaction_template.go",
        "code_start_line": 14,
        "code_end_line": 18,
        "code_key": "transactionTemplate",
        "code_value": "type transactionTemplate struct {\n\ttransactionEntry string\n\tmanager          *TransactionManager\n\tdb               *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "b37d4341dbf0b3fe83a45a94cd42267dbdbe88f4"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/common__dao_orm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/common__dao_orm/transaction_template.go:20:78:doTransaction",
    "orm_code": "func (this *transactionTemplate) doTransaction(ctx context.Context, fn func(context.Context, *gorm.DB) error) (err error) {\n\n\tdefer func() {\n\t\tpc, _, _, ok := runtime.Caller(stackSkip + 1)\n\t\tif !ok {\n\t\t\terr = eorm.AccessRuntimeStackError.GenWithStackByArgs(ctx)\n\t\t\treturn\n\t\t}\n\t\tcurEntry := runtime.FuncForPC(pc).Entry()\n\n\t\tvar e error\n\t\tvar tpId string\n\t\tif tpId, e = this.manager.getTransactionTemplateId(ctx, curEntry); e != nil {\n\t\t\terr = errors.Trace(e)\n\t\t}\n\t\ttmpl, _ := this.manager.transactionPool.Load(tpId)\n\t\ttpl, _ := tmpl.(*transactionTemplate)\n\t\tif tpl != nil {\n\n\t\t\tthis.manager.transactionPool.Delete(this.transactionEntry)\n\n\t\t\tif err != nil && this.db != nil {\n\t\t\t\tthis.db.Rollback()\n\t\t\t}\n\n\t\t\tif err == nil && this.db != nil {\n\t\t\t\te = this.db.Commit().Error\n\t\t\t}\n\n\t\t\tif e != nil {\n\t\t\t\terr = eorm.TransactionCommitError.GenWithStackByArgs(ctx)\n\t\t\t}\n\t\t}\n\t}()\n\n\tif this.db == nil {\n\t\t//this.db = gormtrace.DBwithCtx(ctx, this.manager.db).BeginTx(ctx, nil)\n\t\tthis.db = this.manager.db.WithContext(ctx).Begin()\n\n\t\tif this.db.Error != nil {\n\t\t\tqlog.QErrorF(ctx, \"[transactionTemplate] BeginTx error: %+v\", this.db.Error)\n\t\t\terr = eorm.TransactionBeginError.GenWithStackByArgs(ctx)\n\t\t\treturn err\n\t\t}\n\t}\n\n\tdefer func() {\n\t\tif coverErr := recover(); coverErr != nil {\n\t\t\terr = eorm.DBOperationActionError.GenWithStackByArgs(ctx)\n\t\t}\n\t}()\n\n\tif err = fn(ctx, this.db); err != nil {\n\t\tqlog.QErrorF(ctx, \"[transactionTemplate] DoTransaction call biz error,msg: %+v\", err)\n\t\terr = errors.Trace(err)\n\t\treturn err\n\t}\n\treturn err\n}",
    "caller": "func (this *TransactionManager) DoTransaction(ctx context.Context, fn func(context.Context, *gorm.DB) error) error {\n\n\tvar err error\n\tvar template *transactionTemplate\n\n\tif template, err = this.getTransactionTemplate(ctx); err != nil {\n\t\treturn errors.Trace(err)\n\t}\n\n\tif err = template.doTransaction(ctx, fn); err != nil {\n\t\treturn errors.Trace(err)\n\t}\n\n\treturn err\n}",
    "sql_statement_list": [
      "BEGIN;",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "事务执行成功",
            "sql": "COMMIT;"
          },
          {
            "scenario": "事务执行失败或发生错误",
            "sql": "ROLLBACK;"
          }
        ]
      }
    ],
    "sql_types": [
      "OTHER",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/common__dao_orm/transaction_template.go",
        "code_start_line": 14,
        "code_end_line": 18,
        "code_key": "transactionTemplate",
        "code_value": "type transactionTemplate struct {\n\ttransactionEntry string\n\tmanager          *TransactionManager\n\tdb               *gorm.DB\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "b37d4341dbf0b3fe83a45a94cd42267dbdbe88f4"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/common__dao_orm.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/handlers/v1/task.go:286:357:UpdateTaskStatusApproval",
    "orm_code": "func (h *Handler) UpdateTaskStatusApproval(ctx *gin.Context) (interface{}, error) {\n\tvar (\n\t\tcReq  = new(model.ScheduledChangeTaskStatusInput)\n\t\tentry = glog.WithContext(ctx)\n\t)\n\n\tentry.Debugf(\"Raw cReq: %+v\", cReq)\n\trspErr := basic.Transfer(cReq, ctx)\n\tif rspErr != nil {\n\t\tentry.Error(rspErr.Error())\n\t\treturn nil, api.NewError(api.InvalidParameter, rspErr.Error())\n\t}\n\n\toutRes, err := task.TaskInstance().GetTaskOne(ctx, model.ScheduledTaskGetOneInput{\n\t\tName: cReq.Name,\n\t})\n\tif err != nil {\n\t\t// 记录日志\n\t\tentry.Error(err.Error())\n\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\n\t}\n\n\t// TODO: validate user has access to the product\n\tswitch cReq.Status {\n\t// 审核 init -> audit\n\tcase consts.ScheduledTaskStatusAudit:\n\t\tif outRes.Status != consts.ScheduledTaskStatusInit {\n\t\t\t// audit 前置条件是 init 状态\n\t\t\terr = fmt.Errorf(\"Audit pre status need init \")\n\t\t\tentry.Error(err.Error())\n\t\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t\t}\n\t\tif err := h.db.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\tUpdate(\"status\", cReq.Status).Error; err != nil {\n\t\t\tentry.Error(err)\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\tcase consts.ScheduledTaskStatusRefuse:\n\t\tif outRes.Status != consts.ScheduledTaskStatusInit {\n\t\t\t// refuse 前置条件是 init 状态\n\t\t\terr = fmt.Errorf(\"Audit pre status need init \")\n\t\t\tentry.Error(err.Error())\n\t\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t\t}\n\t\tif err = h.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\t\tif err := tx.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\t\tUpdate(\"status\", cReq.Status).Error; err != nil {\n\t\t\t\tentry.Error(err)\n\t\t\t\treturn err\n\t\t\t}\n\t\t\tif err := tx.Model(&dao.ScheduledSubTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\t\tUpdate(\"is_lock\", consts.SubTaskUnLock).Error; err != nil {\n\t\t\t\tentry.Error(err)\n\t\t\t\treturn err\n\t\t\t}\n\t\t\treturn nil\n\t\t}); err != nil {\n\n\t\t\tentry.Error(err.Error())\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\tdefault:\n\t\terr = fmt.Errorf(\"no support operation \")\n\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t}\n\n\treturn &model.ScheduledChangeTaskStatusOutput{\n\t\tStatus: cReq.Status,\n\t}, nil\n\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "审核状态更新 - cReq.Status为ScheduledTaskStatusAudit时",
            "sql": "UPDATE scheduled_task SET status = ? WHERE name = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "拒绝状态更新 - cReq.Status为ScheduledTaskStatusRefuse时的第一条SQL",
            "sql": "UPDATE scheduled_task SET status = ? WHERE name = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "拒绝状态更新 - cReq.Status为ScheduledTaskStatusRefuse时的第二条SQL",
            "sql": "UPDATE scheduled_sub_task SET is_lock = ? WHERE name = ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 91,
        "code_end_line": 95,
        "code_key": "ScheduledChangeTaskStatusInput",
        "code_value": "type ScheduledChangeTaskStatusInput struct {\n\tName          string `dc:\"任务名称\"`\n\tStatus        string `dc:\"修改到状态\"`\n\tProductRegion string `dc:\"区域\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 69,
        "code_end_line": 73,
        "code_key": "ScheduledTaskGetOneInput",
        "code_value": "type ScheduledTaskGetOneInput struct {\n\tProduct       string `dc:\"业务产品\"`\n\tName          string `dc:\"任务名称\"`\n\tProductRegion string `dc:\"区域\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 6,
        "code_end_line": 25,
        "code_key": "ScheduledTask",
        "code_value": "type ScheduledTask struct {\n\tId              uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tProduct         string     `db:\"column:product\" json:\"Product\" description:\"业务产品\"`\n\tBizSpec         string     `db:\"column:biz_spec\" json:\"BizSpec\" description:\"留给不同平台业务自行解释\"`\n\tRegion          string     `db:\"column:region\" json:\"Region\" description:\"业务所在区\"`\n\tName            string     `db:\"column:name\" json:\"Name\" description:\"任务名称(唯一自动生成)\"`\n\tType            string     `db:\"column:type\" json:\"Type\" description:\"任务类型(UpgradeImage)\"`\n\tParams          string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tBrief           string     `db:\"column:brief\" json:\"Brief\" description:\"任务描述\"`\n\tStatus          string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Terminating,Succeeded,Failed,Error)\"`\n\tBatchNum        uint       `db:\"column:batch_num\" json:\"BatchNum\" description:\"单批次并发限制\"`\n\tTotalSubTask    uint       `db:\"column:total_sub_task\" json:\"TotalSubTask\" description:\"子任务总数\"`\n\tErrorAbort      bool       `db:\"column:error_abort\" json:\"ErrorAbort\" description:\"是否报错中止\"`\n\tCreateTime      *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime      *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tCreator         string     `db:\"column:creator\" json:\"Creator\" description:\"创建者\"`\n\tTaskNameByInput string     `db:\"column:task_name_by_input\" json:\"TaskNameByInput\" description:\"用户输入的名字\"`\n\tZiYanURL        string     `db:\"column:zi_yan_url\" json:\"ZiYanURL\" description:\"自研审批链接\"`\n\tNotifyType      uint       `db:\"column:notify_type\" json:\"NotifyType\" description:\"任务通知类型\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 28,
        "code_end_line": 28,
        "code_key": "TableName",
        "code_value": "func (ScheduledTask) TableName() string { return \"scheduled_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 30,
        "code_end_line": 42,
        "code_key": "ScheduledSubTask",
        "code_value": "type ScheduledSubTask struct {\n\tId         uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tName       string     `db:\"column:name\" json:\"Name\" description:\"任务名称\"`\n\tParams     string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tInstanceId string     `db:\"column:instance_id\" json:\"InstanceId\" description:\"实例Id\"`\n\tTaskId     string     `db:\"column:task_id\" json:\"TaskId\" description:\"Workflow子任务ID\"`\n\tBatchOrder uint64     `db:\"column:batch_order\" json:\"BatchOrder\" description:\"属于哪一个批次\"`\n\tRollback   string     `db:\"column:rollback\" json:\"RollBack\" description:\"任务回滚的参数\"`\n\tStatus     string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Suspending,Suspended,Terminating,Stopping,Succeeded,Failed,Error)\"`\n\tCreateTime *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tIsLock     uint       `db:\"column:is_lock\" json:\"IsLock\" description:\"是否锁定资源\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 45,
        "code_end_line": 45,
        "code_key": "TableName",
        "code_value": "func (ScheduledSubTask) TableName() string { return \"scheduled_sub_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 98,
        "code_end_line": 100,
        "code_key": "ScheduledChangeTaskStatusOutput",
        "code_value": "type ScheduledChangeTaskStatusOutput struct {\n\tStatus string `dc:\"运行状态\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/qtty/model/kube_config.go",
        "code_start_line": 22,
        "code_end_line": 25,
        "code_key": "Context",
        "code_value": "type Context struct {\n\tName    string      `json:\"name\" yaml:\"name\"`\n\tContext ContextItem `json:\"context\" yaml:\"context\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/csig_tdmq__moss.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/handlers/v1/task.go:360:583:ModifyTaskStatus",
    "orm_code": "func (h *Handler) ModifyTaskStatus(ctx *gin.Context) (interface{}, error) {\n\tvar (\n\t\tcReq  = new(model.ScheduledChangeTaskStatusInput)\n\t\tentry = glog.WithContext(ctx)\n\t)\n\n\tentry.Debugf(\"Raw cReq: %+v\", cReq)\n\trspErr := basic.Transfer(cReq, ctx)\n\tif rspErr != nil {\n\t\tentry.Error(rspErr.Error())\n\t\treturn nil, api.NewError(api.InvalidParameter, rspErr.Error())\n\t}\n\n\toutTaskDetailInfoRes, err := task.TaskInstance().GetTaskOne(ctx, model.ScheduledTaskGetOneInput{\n\t\tName: cReq.Name,\n\t})\n\tif err != nil {\n\t\t// 记录日志\n\t\tentry.Error(err.Error())\n\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\n\t}\n\n\t// TODO: validate user has access to the product\n\tswitch cReq.Status {\n\n\t// 启动 audit -> ready\n\tcase consts.ScheduledTaskStatusReady:\n\t\tif outTaskDetailInfoRes.Status != consts.ScheduledTaskStatusAudit {\n\t\t\t// Ready 前置条件是 audit 状态\n\t\t\terr = fmt.Errorf(\"Ready  pre status need   audit \")\n\t\t\tentry.Error(err.Error())\n\t\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t\t}\n\t\tif err := h.db.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\tUpdate(\"status\", cReq.Status).Error; err != nil {\n\t\t\tentry.Error(err)\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\t// 暂停 pause -> running 批次启动操作\n\tcase consts.ScheduledTaskStatusRunning:\n\t\t// 启动，或者从暂停状态恢复（批次启动）\n\t\tswitch outTaskDetailInfoRes.Status {\n\t\tcase consts.ScheduledTaskStatusPause:\n\t\t\toutRes, err := task.TaskInstance().GetSubTaskList(ctx, model.ScheduledSubTaskGetListInput{\n\t\t\t\tName:    cReq.Name,\n\t\t\t\tOrderBy: \"batch_order\",\n\t\t\t})\n\t\t\tif err != nil {\n\t\t\t\tentry.Error(err.Error())\n\t\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t\t}\n\n\t\t\tbatchNum := uint64(0)\n\t\t\tfor _, subTask := range outRes.SubTaskSet {\n\t\t\t\tif subTask.Status == consts.ScheduledTaskStatusPause {\n\t\t\t\t\tbatchNum = subTask.BatchOrder\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif err = h.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\t\t\t// 修改主任务状态\n\t\t\t\torm := tx.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusRunning)\n\t\t\t\tif orm.Error != nil {\n\t\t\t\t\treturn orm.Error\n\t\t\t\t}\n\n\t\t\t\t{\n\t\t\t\t\tvar subTaskList []dao.ScheduledSubTask\n\t\t\t\t\torm = tx.Model(dao.ScheduledSubTask{}).\n\t\t\t\t\t\tWhere(\"name = ? and batch_order = ? \", cReq.Name, batchNum).Find(&subTaskList)\n\t\t\t\t\tif orm.Error != nil {\n\t\t\t\t\t\treturn orm.Error\n\t\t\t\t\t}\n\n\t\t\t\t\ttask.ReportCalendar(outTaskDetailInfoRes.ScheduledTask, subTaskList, zhiyan.CalendarOperationStart,\n\t\t\t\t\t\tzhiyan.CalendarStatusIgnore, task.GetUserID(ctx))\n\t\t\t\t}\n\t\t\t\t// 修改对应批次子任务状态\n\t\t\t\torm = tx.Model(&dao.ScheduledSubTask{}).Where(\"name = ? and batch_order = ? and status != ?\", cReq.Name, batchNum, consts.ScheduledTaskStatusSucceeded).\n\t\t\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\t\t\"create_time\": time.Now(),\n\t\t\t\t\t\t\"status\":      consts.ScheduledTaskStatusPending,\n\t\t\t\t\t})\n\n\t\t\t\tif orm.Error != nil {\n\t\t\t\t\treturn orm.Error\n\t\t\t\t}\n\n\t\t\t\treturn nil\n\n\t\t\t}); err != nil {\n\t\t\t\tentry.Error(err.Error())\n\t\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t\t}\n\n\t\tcase consts.ScheduledTaskStatusReady:\n\t\t\tif err = h.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\t\t\t// 修改主任务状态\n\t\t\t\torm := tx.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusPending) // 修改对应批次子任务状态\n\t\t\t\tif orm.Error != nil {\n\t\t\t\t\treturn orm.Error\n\t\t\t\t}\n\t\t\t\torm = tx.Model(&dao.ScheduledSubTask{}).Where(\"name = ? and batch_order = ? \", cReq.Name, 1).\n\t\t\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusPending)\n\t\t\t\tif orm.Error != nil {\n\t\t\t\t\treturn orm.Error\n\t\t\t\t}\n\t\t\t\treturn nil\n\t\t\t}); err != nil {\n\t\t\t\tentry.Error(err.Error())\n\t\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t\t}\n\n\t\tcase consts.ScheduledTaskStatusAudit:\n\t\t\tif err = h.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\t\t\t// 修改主任务状态\n\t\t\t\torm := tx.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusPending) // 修改对应批次子任务状态\n\t\t\t\tif orm.Error != nil {\n\t\t\t\t\treturn orm.Error\n\t\t\t\t}\n\n\t\t\t\t// 上报智研日历\n\t\t\t\t{\n\t\t\t\t\tvar subTaskList []dao.ScheduledSubTask\n\n\t\t\t\t\torm = tx.Model(dao.ScheduledSubTask{}).Where(\"name = ? and batch_order = ? \", cReq.Name, 1).Find(&subTaskList)\n\t\t\t\t\tif orm.Error != nil {\n\t\t\t\t\t\treturn orm.Error\n\t\t\t\t\t}\n\t\t\t\t\ttask.ReportCalendar(outTaskDetailInfoRes.ScheduledTask, subTaskList, zhiyan.CalendarOperationStart, zhiyan.CalendarStatusIgnore, task.GetUserID(ctx))\n\t\t\t\t}\n\n\t\t\t\torm = tx.Model(&dao.ScheduledSubTask{}).Where(\"name = ? and batch_order = ? \", cReq.Name, 1).\n\t\t\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusPending)\n\t\t\t\tif orm.Error != nil {\n\t\t\t\t\treturn orm.Error\n\t\t\t\t}\n\t\t\t\treturn nil\n\t\t\t}); err != nil {\n\t\t\t\tentry.Error(err.Error())\n\t\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t\t}\n\t\tdefault:\n\t\t\t// Pause 前置条件是 run 状态\n\t\t\terr = fmt.Errorf(\"%s status can not changed to running\", outTaskDetailInfoRes.Status)\n\t\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\n\t\t}\n\n\t// 暂停 running -> pause\n\tcase consts.ScheduledTaskStatusPause:\n\t\t// 进入暂停状态，批次启动\n\t\tif outTaskDetailInfoRes.Status != consts.ScheduledTaskStatusRunning {\n\t\t\t// Pause 前置条件是 run 状态\n\t\t\terr = fmt.Errorf(\"only running task can be paused\")\n\t\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t\t}\n\t\tif err := h.db.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusPausing).Error; err != nil {\n\t\t\tentry.Error(err)\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\n\t// 终止任务\n\tcase consts.ScheduledTaskStatusTerminated:\n\t\tif outTaskDetailInfoRes.Status != consts.ScheduledTaskStatusRunning &&\n\t\t\toutTaskDetailInfoRes.Status != consts.ScheduledTaskStatusPause &&\n\t\t\toutTaskDetailInfoRes.Status != consts.ScheduledTaskStatusInit &&\n\t\t\toutTaskDetailInfoRes.Status != consts.ScheduledTaskStatusAudit {\n\n\t\t\terr = errors.New(\"only running/pause/init/audit task can be terminated\")\n\t\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t\t}\n\n\t\terr := task.TaskInstance().TerminateTask(ctx, model.ScheduledTaskOperateInput{\n\t\t\tName: cReq.Name,\n\t\t})\n\t\tif err != nil {\n\t\t\tentry.Error(err.Error())\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\n\t\t// 解锁 pause 状态的资源锁\n\t\tif err := h.db.Model(&dao.ScheduledSubTask{}).Where(\"name = ?\", cReq.Name).Where(\"status = ?\", consts.ScheduledTaskStatusPause).\n\t\t\tUpdate(\"is_lock\", consts.SubTaskUnLock).Error; err != nil {\n\t\t\tentry.Error(err)\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\n\t// 重试 failed -> retrying\n\tcase consts.ScheduledTaskStatusRetry:\n\t\tif outTaskDetailInfoRes.Status != consts.ScheduledTaskStatusFailed {\n\t\t\t// Retry 前置条件是 failed 状态\n\t\t\terr = errors.New(\"only failed task can be retried\")\n\t\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t\t}\n\n\t\terr := task.TaskInstance().RetryTask(ctx, model.ScheduledSubTaskOperateInput{\n\t\t\tName: cReq.Name,\n\t\t})\n\t\tif err != nil {\n\t\t\tentry.Error(err.Error())\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\n\t\tif err := h.db.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusRetrying).Error; err != nil {\n\t\t\tentry.Error(err)\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\tdefault:\n\t\terr = fmt.Errorf(\"invalid operation: \" + cReq.Status)\n\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t}\n\n\treturn &model.ScheduledChangeTaskStatusOutput{\n\t\tStatus: cReq.Status,\n\t}, nil\n}",
    "caller": "",
    "sql_statement_list": [
      "UPDATE scheduled_task SET status = ? WHERE name = ?;",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "Running status from Pause - transaction with subtask operations",
            "sql": "UPDATE scheduled_task SET status = ? WHERE name = ?; SELECT id, name, params, instance_id, task_id, batch_order, rollback, status, create_time, update_time, is_lock FROM scheduled_sub_task WHERE name = ? AND batch_order = ?; UPDATE scheduled_sub_task SET create_time = ?, status = ? WHERE name = ? AND batch_order = ? AND status != ?;"
          },
          {
            "scenario": "Running status from Ready - transaction with basic subtask update",
            "sql": "UPDATE scheduled_task SET status = ? WHERE name = ?; UPDATE scheduled_sub_task SET status = ? WHERE name = ? AND batch_order = ?;"
          },
          {
            "scenario": "Running status from Audit - transaction with subtask query and update",
            "sql": "UPDATE scheduled_task SET status = ? WHERE name = ?; SELECT id, name, params, instance_id, task_id, batch_order, rollback, status, create_time, update_time, is_lock FROM scheduled_sub_task WHERE name = ? AND batch_order = ?; UPDATE scheduled_sub_task SET status = ? WHERE name = ? AND batch_order = ?;"
          }
        ]
      },
      "UPDATE scheduled_task SET status = ? WHERE name = ?;",
      "UPDATE scheduled_sub_task SET is_lock = ? WHERE name = ? AND status = ?;",
      "UPDATE scheduled_task SET status = ? WHERE name = ?;"
    ],
    "sql_types": [
      "UPDATE",
      "PARAM_DEPENDENT",
      "UPDATE",
      "UPDATE",
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 91,
        "code_end_line": 95,
        "code_key": "ScheduledChangeTaskStatusInput",
        "code_value": "type ScheduledChangeTaskStatusInput struct {\n\tName          string `dc:\"任务名称\"`\n\tStatus        string `dc:\"修改到状态\"`\n\tProductRegion string `dc:\"区域\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 69,
        "code_end_line": 73,
        "code_key": "ScheduledTaskGetOneInput",
        "code_value": "type ScheduledTaskGetOneInput struct {\n\tProduct       string `dc:\"业务产品\"`\n\tName          string `dc:\"任务名称\"`\n\tProductRegion string `dc:\"区域\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 6,
        "code_end_line": 25,
        "code_key": "ScheduledTask",
        "code_value": "type ScheduledTask struct {\n\tId              uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tProduct         string     `db:\"column:product\" json:\"Product\" description:\"业务产品\"`\n\tBizSpec         string     `db:\"column:biz_spec\" json:\"BizSpec\" description:\"留给不同平台业务自行解释\"`\n\tRegion          string     `db:\"column:region\" json:\"Region\" description:\"业务所在区\"`\n\tName            string     `db:\"column:name\" json:\"Name\" description:\"任务名称(唯一自动生成)\"`\n\tType            string     `db:\"column:type\" json:\"Type\" description:\"任务类型(UpgradeImage)\"`\n\tParams          string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tBrief           string     `db:\"column:brief\" json:\"Brief\" description:\"任务描述\"`\n\tStatus          string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Terminating,Succeeded,Failed,Error)\"`\n\tBatchNum        uint       `db:\"column:batch_num\" json:\"BatchNum\" description:\"单批次并发限制\"`\n\tTotalSubTask    uint       `db:\"column:total_sub_task\" json:\"TotalSubTask\" description:\"子任务总数\"`\n\tErrorAbort      bool       `db:\"column:error_abort\" json:\"ErrorAbort\" description:\"是否报错中止\"`\n\tCreateTime      *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime      *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tCreator         string     `db:\"column:creator\" json:\"Creator\" description:\"创建者\"`\n\tTaskNameByInput string     `db:\"column:task_name_by_input\" json:\"TaskNameByInput\" description:\"用户输入的名字\"`\n\tZiYanURL        string     `db:\"column:zi_yan_url\" json:\"ZiYanURL\" description:\"自研审批链接\"`\n\tNotifyType      uint       `db:\"column:notify_type\" json:\"NotifyType\" description:\"任务通知类型\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 28,
        "code_end_line": 28,
        "code_key": "TableName",
        "code_value": "func (ScheduledTask) TableName() string { return \"scheduled_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 136,
        "code_end_line": 149,
        "code_key": "ScheduledSubTaskGetListInput",
        "code_value": "type ScheduledSubTaskGetListInput struct {\n\n\t// TODO 将下面的转换\n\tFilters []basic.Filter\n\n\tProduct        string   `dc:\"业务产品\"`\n\tProductRegion  string   `dc:\"区域\"`\n\tName           string   `dc:\"任务名称\"`\n\tStatuses       []string `dc:\"运行状态\"`\n\tInstanceId     string   `dc:\"模糊搜索:实例Id\"`\n\tOrderBy        string   `dc:\"排序字段\"`\n\tOrderDirection string   `dc:\"排序方式\"`\n\tCommonPaginationInput\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 30,
        "code_end_line": 42,
        "code_key": "ScheduledSubTask",
        "code_value": "type ScheduledSubTask struct {\n\tId         uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tName       string     `db:\"column:name\" json:\"Name\" description:\"任务名称\"`\n\tParams     string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tInstanceId string     `db:\"column:instance_id\" json:\"InstanceId\" description:\"实例Id\"`\n\tTaskId     string     `db:\"column:task_id\" json:\"TaskId\" description:\"Workflow子任务ID\"`\n\tBatchOrder uint64     `db:\"column:batch_order\" json:\"BatchOrder\" description:\"属于哪一个批次\"`\n\tRollback   string     `db:\"column:rollback\" json:\"RollBack\" description:\"任务回滚的参数\"`\n\tStatus     string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Suspending,Suspended,Terminating,Stopping,Succeeded,Failed,Error)\"`\n\tCreateTime *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tIsLock     uint       `db:\"column:is_lock\" json:\"IsLock\" description:\"是否锁定资源\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 45,
        "code_end_line": 45,
        "code_key": "TableName",
        "code_value": "func (ScheduledSubTask) TableName() string { return \"scheduled_sub_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 152,
        "code_end_line": 154,
        "code_key": "ScheduledTaskOperateInput",
        "code_value": "type ScheduledTaskOperateInput struct {\n\tName string `dc:\"任务名称\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 163,
        "code_end_line": 167,
        "code_key": "ScheduledSubTaskOperateInput",
        "code_value": "type ScheduledSubTaskOperateInput struct {\n\tName       string `dc:\"任务名称\"`\n\tSubTaskId  uint64 `dc:\"子任务Id\"`\n\tInstanceId string `dc:\"实例ID\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 98,
        "code_end_line": 100,
        "code_key": "ScheduledChangeTaskStatusOutput",
        "code_value": "type ScheduledChangeTaskStatusOutput struct {\n\tStatus string `dc:\"运行状态\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/qtty/model/kube_config.go",
        "code_start_line": 22,
        "code_end_line": 25,
        "code_key": "Context",
        "code_value": "type Context struct {\n\tName    string      `json:\"name\" yaml:\"name\"`\n\tContext ContextItem `json:\"context\" yaml:\"context\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      }
    ],
    "sql_pattern_cnt": 15,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/csig_tdmq__moss.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/zhiyan/task.go:282:372:SyncZhiyanTask",
    "orm_code": "func SyncZhiyanTask(ctxin context.Context) {\n\turl := config.ConfigInstance().ZhiyanOpenAPIURL\n\ttoken := config.ConfigInstance().ZhiyanOpenAPIToken\n\n\tids := make([]int64, 0)\n\tscheduledTaskList := make([]entity.ScheduledTask, 0)\n\tif err := dao.DBInstance().Model(entity.ScheduledTask{}).Where(\"status = ?\", consts.ScheduledTaskStatusInit).\n\t\tFind(&scheduledTaskList).Error; err != nil {\n\t\tglog.Error(err.Error())\n\t\treturn\n\t}\n\n\tziyan2TaskListMap := make(map[string][]string, 0)\n\tfor _, t := range scheduledTaskList {\n\t\tif t.ZiYanURL == \"\" || isNumeric(t.ZiYanURL) == false {\n\t\t\tcontinue\n\t\t}\n\t\tids = append(ids, gconv.Int64((t.ZiYanURL)))\n\n\t\tif v, ok := ziyan2TaskListMap[t.ZiYanURL]; ok {\n\t\t\tziyan2TaskListMap[t.ZiYanURL] = append(v, t.Name)\n\t\t} else {\n\t\t\tziyan2TaskListMap[t.ZiYanURL] = []string{t.Name}\n\t\t}\n\t}\n\n\tif len(ids) == 0 {\n\t\treturn\n\t}\n\n\tctx := gctx.New()\n\t// 构建请求数据\n\tpayload := NewQueryOrderRequest()\n\tpayload.Id = ids\n\n\tjsonData := gjson.New(payload).MustToJsonString()\n\tglog.Info(\"Request Zhiyan Task Body:\", jsonData)\n\t// 发送请求\n\tclient.SetHeader(\"token\", token)\n\tresp, err := client.Post(ctx, url, jsonData)\n\tif err != nil {\n\t\tglog.Error(\"Error sending request:\", err)\n\t\treturn\n\t}\n\tdefer resp.Close()\n\n\t// 读取响应体\n\tbody := resp.ReadAll()\n\tglog.Info(\"Zhiyan Task Response :\", string(body))\n\n\t// 解析响应体\n\tresponse := NewQueryOrderResponse()\n\terr = gjson.New(body).Scan(&response)\n\tif err != nil {\n\t\tglog.Errorf(\"Error parsing response JSON:\", string(body))\n\t\treturn\n\t}\n\n\t// 处理响应\n\tif response.Code == 0 {\n\t\tglog.Info(\"Request Zhiyan Task successful\")\n\t\tfor _, task := range response.Data.Item {\n\t\t\tif task.Status == int64(StatusApproved) {\n\t\t\t\tif err := dao.DBInstance().Model(entity.ScheduledTask{}).Where(\"name in ? and zi_yan_url = ?\", ziyan2TaskListMap[fmt.Sprintf(\"%v\", task.Id)], fmt.Sprintf(\"%v\", task.Id)).Update(\"status\", consts.ScheduledTaskStatusAudit).Error; err != nil {\n\t\t\t\t\tglog.Error(err.Error())\n\t\t\t\t}\n\t\t\t} else if task.Status == int64(StatusRejected) {\n\t\t\t\tif err = dao.DBInstance().Transaction(func(tx *gorm.DB) (err error) {\n\t\t\t\t\tif err := tx.Model(&entity.ScheduledTask{}).Where(\"name in ? and zi_yan_url = ?\", ziyan2TaskListMap[fmt.Sprintf(\"%v\", task.Id)], fmt.Sprintf(\"%v\", task.Id)).\n\t\t\t\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusRefuse).Error; err != nil {\n\t\t\t\t\t\tglog.Error(err)\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t\tif err := tx.Model(&entity.ScheduledSubTask{}).Where(\"name = ?\", ziyan2TaskListMap[fmt.Sprintf(\"%v\", task.Id)]).\n\t\t\t\t\t\tUpdate(\"is_lock\", consts.SubTaskUnLock).Error; err != nil {\n\t\t\t\t\t\tglog.Error(err)\n\t\t\t\t\t\treturn err\n\t\t\t\t\t}\n\t\t\t\t\treturn nil\n\t\t\t\t}); err != nil {\n\t\t\t\t\tglog.Error(err.Error())\n\t\t\t\t}\n\t\t\t} else if task.Status == int64(StatusCanceled) {\n\n\t\t\t}\n\n\t\t}\n\t} else {\n\t\tglog.Errorf(\"Request Zhiyan Task failed with code: %d, message: %v\\n\", response.Code, response.Msg)\n\t}\n}",
    "caller": "",
    "sql_statement_list": [
      "SELECT * FROM scheduled_task WHERE status = ?;",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "智研任务状态为已批准时更新计划任务状态",
            "sql": "UPDATE scheduled_task SET status = ? WHERE name IN (?) AND zi_yan_url = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "智研任务状态为已拒绝时在事务中更新计划任务状态",
            "sql": "UPDATE scheduled_task SET status = ? WHERE name IN (?) AND zi_yan_url = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "智研任务状态为已拒绝时在事务中更新子任务锁定状态",
            "sql": "UPDATE scheduled_sub_task SET is_lock = ? WHERE name = ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "SELECT",
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 6,
        "code_end_line": 25,
        "code_key": "ScheduledTask",
        "code_value": "type ScheduledTask struct {\n\tId              uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tProduct         string     `db:\"column:product\" json:\"Product\" description:\"业务产品\"`\n\tBizSpec         string     `db:\"column:biz_spec\" json:\"BizSpec\" description:\"留给不同平台业务自行解释\"`\n\tRegion          string     `db:\"column:region\" json:\"Region\" description:\"业务所在区\"`\n\tName            string     `db:\"column:name\" json:\"Name\" description:\"任务名称(唯一自动生成)\"`\n\tType            string     `db:\"column:type\" json:\"Type\" description:\"任务类型(UpgradeImage)\"`\n\tParams          string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tBrief           string     `db:\"column:brief\" json:\"Brief\" description:\"任务描述\"`\n\tStatus          string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Terminating,Succeeded,Failed,Error)\"`\n\tBatchNum        uint       `db:\"column:batch_num\" json:\"BatchNum\" description:\"单批次并发限制\"`\n\tTotalSubTask    uint       `db:\"column:total_sub_task\" json:\"TotalSubTask\" description:\"子任务总数\"`\n\tErrorAbort      bool       `db:\"column:error_abort\" json:\"ErrorAbort\" description:\"是否报错中止\"`\n\tCreateTime      *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime      *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tCreator         string     `db:\"column:creator\" json:\"Creator\" description:\"创建者\"`\n\tTaskNameByInput string     `db:\"column:task_name_by_input\" json:\"TaskNameByInput\" description:\"用户输入的名字\"`\n\tZiYanURL        string     `db:\"column:zi_yan_url\" json:\"ZiYanURL\" description:\"自研审批链接\"`\n\tNotifyType      uint       `db:\"column:notify_type\" json:\"NotifyType\" description:\"任务通知类型\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 28,
        "code_end_line": 28,
        "code_key": "TableName",
        "code_value": "func (ScheduledTask) TableName() string { return \"scheduled_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 30,
        "code_end_line": 42,
        "code_key": "ScheduledSubTask",
        "code_value": "type ScheduledSubTask struct {\n\tId         uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tName       string     `db:\"column:name\" json:\"Name\" description:\"任务名称\"`\n\tParams     string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tInstanceId string     `db:\"column:instance_id\" json:\"InstanceId\" description:\"实例Id\"`\n\tTaskId     string     `db:\"column:task_id\" json:\"TaskId\" description:\"Workflow子任务ID\"`\n\tBatchOrder uint64     `db:\"column:batch_order\" json:\"BatchOrder\" description:\"属于哪一个批次\"`\n\tRollback   string     `db:\"column:rollback\" json:\"RollBack\" description:\"任务回滚的参数\"`\n\tStatus     string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Suspending,Suspended,Terminating,Stopping,Succeeded,Failed,Error)\"`\n\tCreateTime *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tIsLock     uint       `db:\"column:is_lock\" json:\"IsLock\" description:\"是否锁定资源\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 45,
        "code_end_line": 45,
        "code_key": "TableName",
        "code_value": "func (ScheduledSubTask) TableName() string { return \"scheduled_sub_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/qtty/model/kube_config.go",
        "code_start_line": 22,
        "code_end_line": 25,
        "code_key": "Context",
        "code_value": "type Context struct {\n\tName    string      `json:\"name\" yaml:\"name\"`\n\tContext ContextItem `json:\"context\" yaml:\"context\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      }
    ],
    "sql_pattern_cnt": 6,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/csig_tdmq__moss.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/task.go:81:211:Register",
    "orm_code": "func (s *sScheduledTask) Register(ctx *gin.Context, in model.ScheduledTaskRegisterInput) (taskName string, err error) {\n\tproductService := product.GetServiceInstance()\n\tpf, err := productService.GetProductPlatformCached(in.Product, in.Region)\n\tif err != nil {\n\t\treturn \"\", err\n\t}\n\tcreator := in.Creator\n\tif creator == \"\" {\n\t\tcreator = GetUserID(ctx)\n\t}\n\n\tnow := time.Now()\n\ttask := entity.ScheduledTask{\n\t\tProduct:         in.Product,\n\t\tRegion:          in.Region,\n\t\tBizSpec:         in.BizSpec,\n\t\tName:            \"\",\n\t\tType:            in.Type,\n\t\tParams:          in.Params,\n\t\tBrief:           in.Brief,\n\t\tStatus:          consts.ScheduledTaskStatusInit, // 等待审核\n\t\tBatchNum:        in.BatchNum,\n\t\tErrorAbort:      in.ErrorAbort,\n\t\tTotalSubTask:    uint(len(in.InstanceIds)),\n\t\tCreateTime:      &now,\n\t\tUpdateTime:      &now,\n\t\tCreator:         creator,\n\t\tTaskNameByInput: in.TaskNameByInput,\n\t\tZiYanURL:        in.ZiYanURL,\n\t\tNotifyType:      in.NotifyType,\n\t}\n\n\tvar outSubTaskRes = &model.ScheduledTaskRollBackOutput{}\n\toutSubTaskRes.SubTaskSet = make([]entity.ScheduledSubTask, 0)\n\n\t// BizSpec 适配不同平台及特殊逻辑的钩子，升级回滚场景下传递的是需要回滚的任务名称\n\tif in.BizSpec != \"\" {\n\t\toutSubTaskRes, err = handlers.TaskApiServiceInstance(pf).\n\t\t\tBizSpecCallBack(ctx,\n\t\t\t\tmodel.ScheduledTaskRollBackInput{\n\t\t\t\t\tTaskInfo:    task,\n\t\t\t\t\tInstanceIds: in.InstanceIds,\n\t\t\t\t})\n\n\t\tif err != nil {\n\t\t\tmsg := fmt.Sprintf(\"BizSpecCallBack Error : %s\", err.Error())\n\t\t\talarm.ReportAlarm(\"BizSpecCallBack Error\", \"\", msg)\n\t\t\treturn \"\", err\n\t\t}\n\t}\n\n\terr = s.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\tscheduledTask := task\n\t\tif errTx := tx.Create(&scheduledTask).Error; errTx != nil {\n\t\t\tglog.Error(errTx.Error())\n\t\t\treturn errTx\n\t\t}\n\t\tlastInsertId := scheduledTask.Id\n\t\ttaskName = fmt.Sprintf(\"%s-%d\", in.Type, lastInsertId)\n\n\t\tif errTx := tx.Model(&entity.ScheduledTask{}).\n\t\t\tWhere(\"id = ? \", lastInsertId).\n\t\t\tUpdate(\"name\", taskName).Error; errTx != nil {\n\t\t\tglog.Error(errTx.Error())\n\t\t\treturn errTx\n\t\t}\n\n\t\trollbackMap := make(map[string]string)\n\t\tif outSubTaskRes != nil && len(outSubTaskRes.SubTaskSet) > 0 {\n\t\t\tin.InstanceIds = make(map[string]uint64, 0)\n\t\t\tfor _, v := range outSubTaskRes.SubTaskSet {\n\t\t\t\tin.InstanceIds[v.InstanceId] = v.BatchOrder\n\t\t\t\trollbackMap[v.InstanceId] = v.Rollback\n\t\t\t}\n\t\t\tif errTx := tx.Model(&entity.ScheduledTask{}).\n\t\t\t\tWhere(\"id = ? \", lastInsertId).\n\t\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\t\"total_sub_task\": len(outSubTaskRes.SubTaskSet),\n\t\t\t\t\t\"notify_type\":    outSubTaskRes.OriginTaskInfo.NotifyType,\n\t\t\t\t\t\"batch_num\":      outSubTaskRes.OriginTaskInfo.BatchNum,\n\t\t\t\t}).Error; errTx != nil {\n\t\t\t\tglog.Error(errTx.Error())\n\t\t\t\treturn errTx\n\t\t\t}\n\t\t}\n\n\t\tif len(in.InstanceIds) > 0 {\n\t\t\tidList := make([]string, 0)\n\t\t\tfor k, _ := range in.InstanceIds {\n\t\t\t\tidList = append(idList, k)\n\t\t\t}\n\t\t\tif err := s.checkSubTaskLocked(idList); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\n\t\t\tsubTaskList := make([]*entity.ScheduledSubTask, 0)\n\t\t\tfor instanceId, BatchOrder := range in.InstanceIds {\n\t\t\t\trollback := \"\"\n\t\t\t\tparams := in.Params\n\t\t\t\tif len(rollbackMap) > 0 {\n\t\t\t\t\tif v, ok := rollbackMap[instanceId]; ok {\n\t\t\t\t\t\trollback = v\n\t\t\t\t\t\tparams = v\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tsubTaskList = append(subTaskList, &entity.ScheduledSubTask{\n\t\t\t\t\tName:       taskName,\n\t\t\t\t\tParams:     params,\n\t\t\t\t\tRollback:   rollback,\n\t\t\t\t\tInstanceId: instanceId,\n\t\t\t\t\tTaskId:     \"\",\n\t\t\t\t\tStatus:     consts.ScheduledTaskStatusPause, // 等待批启动\n\t\t\t\t\tBatchOrder: BatchOrder,\n\t\t\t\t\tIsLock:     consts.SubTaskLock,\n\t\t\t\t\tCreateTime: &now,\n\t\t\t\t\tUpdateTime: &now,\n\t\t\t\t})\n\t\t\t}\n\t\t\tif errTx := tx.Model(&entity.ScheduledSubTask{}).Create(&subTaskList).Error; errTx != nil {\n\t\t\t\tglog.Error(errTx.Error())\n\t\t\t\treturn errTx\n\t\t\t}\n\t\t} else {\n\t\t\treturn fmt.Errorf(\"need InstanceIds\")\n\t\t}\n\n\t\treturn nil\n\t})\n\n\treturn\n}",
    "caller": "",
    "sql_statement_list": [
      "INSERT INTO `scheduled_task` (`product`,`region`,`biz_spec`,`name`,`type`,`params`,`brief`,`status`,`batch_num`,`error_abort`,`total_sub_task`,`create_time`,`update_time`,`creator`,`task_name_by_input`,`zi_yan_url`,`notify_type`) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);",
      "UPDATE `scheduled_task` SET `name`=? WHERE id = ?;",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "当BizSpec回调返回SubTaskSet数据时",
            "sql": "UPDATE `scheduled_task` SET `batch_num`=?,`notify_type`=?,`total_sub_task`=? WHERE id = ?;"
          }
        ]
      },
      "INSERT INTO `scheduled_sub_task` (`name`,`params`,`rollback`,`instance_id`,`task_id`,`status`,`batch_order`,`is_lock`,`create_time`,`update_time`) VALUES (?,?,?,?,?,?,?,?,?,?);",
      "INSERT INTO `scheduled_sub_task` (`name`,`params`,`rollback`,`instance_id`,`task_id`,`status`,`batch_order`,`is_lock`,`create_time`,`update_time`) VALUES (?,?,?,?,?,?,?,?,?,?);"
    ],
    "sql_types": [
      "INSERT",
      "UPDATE",
      "PARAM_DEPENDENT",
      "INSERT",
      "INSERT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 6,
        "code_end_line": 25,
        "code_key": "ScheduledTask",
        "code_value": "type ScheduledTask struct {\n\tId              uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tProduct         string     `db:\"column:product\" json:\"Product\" description:\"业务产品\"`\n\tBizSpec         string     `db:\"column:biz_spec\" json:\"BizSpec\" description:\"留给不同平台业务自行解释\"`\n\tRegion          string     `db:\"column:region\" json:\"Region\" description:\"业务所在区\"`\n\tName            string     `db:\"column:name\" json:\"Name\" description:\"任务名称(唯一自动生成)\"`\n\tType            string     `db:\"column:type\" json:\"Type\" description:\"任务类型(UpgradeImage)\"`\n\tParams          string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tBrief           string     `db:\"column:brief\" json:\"Brief\" description:\"任务描述\"`\n\tStatus          string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Terminating,Succeeded,Failed,Error)\"`\n\tBatchNum        uint       `db:\"column:batch_num\" json:\"BatchNum\" description:\"单批次并发限制\"`\n\tTotalSubTask    uint       `db:\"column:total_sub_task\" json:\"TotalSubTask\" description:\"子任务总数\"`\n\tErrorAbort      bool       `db:\"column:error_abort\" json:\"ErrorAbort\" description:\"是否报错中止\"`\n\tCreateTime      *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime      *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tCreator         string     `db:\"column:creator\" json:\"Creator\" description:\"创建者\"`\n\tTaskNameByInput string     `db:\"column:task_name_by_input\" json:\"TaskNameByInput\" description:\"用户输入的名字\"`\n\tZiYanURL        string     `db:\"column:zi_yan_url\" json:\"ZiYanURL\" description:\"自研审批链接\"`\n\tNotifyType      uint       `db:\"column:notify_type\" json:\"NotifyType\" description:\"任务通知类型\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 28,
        "code_end_line": 28,
        "code_key": "TableName",
        "code_value": "func (ScheduledTask) TableName() string { return \"scheduled_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 119,
        "code_end_line": 122,
        "code_key": "ScheduledTaskRollBackOutput",
        "code_value": "type ScheduledTaskRollBackOutput struct {\n\tSubTaskSet     []entity.ScheduledSubTask `dc:\"子任务数据\"`\n\tOriginTaskInfo entity.ScheduledTask      `dc:\"回滚前的主任务数据\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 30,
        "code_end_line": 42,
        "code_key": "ScheduledSubTask",
        "code_value": "type ScheduledSubTask struct {\n\tId         uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tName       string     `db:\"column:name\" json:\"Name\" description:\"任务名称\"`\n\tParams     string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tInstanceId string     `db:\"column:instance_id\" json:\"InstanceId\" description:\"实例Id\"`\n\tTaskId     string     `db:\"column:task_id\" json:\"TaskId\" description:\"Workflow子任务ID\"`\n\tBatchOrder uint64     `db:\"column:batch_order\" json:\"BatchOrder\" description:\"属于哪一个批次\"`\n\tRollback   string     `db:\"column:rollback\" json:\"RollBack\" description:\"任务回滚的参数\"`\n\tStatus     string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Suspending,Suspended,Terminating,Stopping,Succeeded,Failed,Error)\"`\n\tCreateTime *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tIsLock     uint       `db:\"column:is_lock\" json:\"IsLock\" description:\"是否锁定资源\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 45,
        "code_end_line": 45,
        "code_key": "TableName",
        "code_value": "func (ScheduledSubTask) TableName() string { return \"scheduled_sub_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 113,
        "code_end_line": 116,
        "code_key": "ScheduledTaskRollBackInput",
        "code_value": "type ScheduledTaskRollBackInput struct {\n\tTaskInfo    entity.ScheduledTask\n\tInstanceIds map[string]uint64 `dc:\"实例Id对应的批次信息\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/qtty/model/kube_config.go",
        "code_start_line": 22,
        "code_end_line": 25,
        "code_key": "Context",
        "code_value": "type Context struct {\n\tName    string      `json:\"name\" yaml:\"name\"`\n\tContext ContextItem `json:\"context\" yaml:\"context\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 31,
        "code_end_line": 46,
        "code_key": "ScheduledTaskRegisterInput",
        "code_value": "type ScheduledTaskRegisterInput struct {\n\tType    string `dc:\"任务类型(UpgradeImage)\"`\n\tProduct string `dc:\"业务产品\"`\n\tRegion  string `dc:\"区域\"`\n\t// BizSpec 适配不同平台及特殊逻辑的钩子，升级回滚场景下传递的是需要回滚的任务名称\n\tBizSpec         string            `dc:\"所属各个业务特性信息\"`\n\tInstanceIds     map[string]uint64 `dc:\"实例Id对应的批次信息\"`\n\tParams          string            `dc:\"任务参数，不同的任务类型参数格式不同\"`\n\tBrief           string            `dc:\"任务描述\"`\n\tBatchNum        uint              `dc:\"每次批量启动子任务数量\"`\n\tErrorAbort      bool              `dc:\"是否报错中止\"`\n\tCreator         string            `dc:\"创建者\"`\n\tTaskNameByInput string            `dc:\"用户输入的名字\"`\n\tZiYanURL        string            `dc:\"自研审批链接\"`\n\tNotifyType      uint              `dc:\"任务通知类型\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      }
    ],
    "sql_pattern_cnt": 5,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/csig_tdmq__moss.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/task.go:81:211:Register",
    "orm_code": "func (s *sScheduledTask) Register(ctx *gin.Context, in model.ScheduledTaskRegisterInput) (taskName string, err error) {\n\tproductService := product.GetServiceInstance()\n\tpf, err := productService.GetProductPlatformCached(in.Product, in.Region)\n\tif err != nil {\n\t\treturn \"\", err\n\t}\n\tcreator := in.Creator\n\tif creator == \"\" {\n\t\tcreator = GetUserID(ctx)\n\t}\n\n\tnow := time.Now()\n\ttask := entity.ScheduledTask{\n\t\tProduct:         in.Product,\n\t\tRegion:          in.Region,\n\t\tBizSpec:         in.BizSpec,\n\t\tName:            \"\",\n\t\tType:            in.Type,\n\t\tParams:          in.Params,\n\t\tBrief:           in.Brief,\n\t\tStatus:          consts.ScheduledTaskStatusInit, // 等待审核\n\t\tBatchNum:        in.BatchNum,\n\t\tErrorAbort:      in.ErrorAbort,\n\t\tTotalSubTask:    uint(len(in.InstanceIds)),\n\t\tCreateTime:      &now,\n\t\tUpdateTime:      &now,\n\t\tCreator:         creator,\n\t\tTaskNameByInput: in.TaskNameByInput,\n\t\tZiYanURL:        in.ZiYanURL,\n\t\tNotifyType:      in.NotifyType,\n\t}\n\n\tvar outSubTaskRes = &model.ScheduledTaskRollBackOutput{}\n\toutSubTaskRes.SubTaskSet = make([]entity.ScheduledSubTask, 0)\n\n\t// BizSpec 适配不同平台及特殊逻辑的钩子，升级回滚场景下传递的是需要回滚的任务名称\n\tif in.BizSpec != \"\" {\n\t\toutSubTaskRes, err = handlers.TaskApiServiceInstance(pf).\n\t\t\tBizSpecCallBack(ctx,\n\t\t\t\tmodel.ScheduledTaskRollBackInput{\n\t\t\t\t\tTaskInfo:    task,\n\t\t\t\t\tInstanceIds: in.InstanceIds,\n\t\t\t\t})\n\n\t\tif err != nil {\n\t\t\tmsg := fmt.Sprintf(\"BizSpecCallBack Error : %s\", err.Error())\n\t\t\talarm.ReportAlarm(\"BizSpecCallBack Error\", \"\", msg)\n\t\t\treturn \"\", err\n\t\t}\n\t}\n\n\terr = s.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\tscheduledTask := task\n\t\tif errTx := tx.Create(&scheduledTask).Error; errTx != nil {\n\t\t\tglog.Error(errTx.Error())\n\t\t\treturn errTx\n\t\t}\n\t\tlastInsertId := scheduledTask.Id\n\t\ttaskName = fmt.Sprintf(\"%s-%d\", in.Type, lastInsertId)\n\n\t\tif errTx := tx.Model(&entity.ScheduledTask{}).\n\t\t\tWhere(\"id = ? \", lastInsertId).\n\t\t\tUpdate(\"name\", taskName).Error; errTx != nil {\n\t\t\tglog.Error(errTx.Error())\n\t\t\treturn errTx\n\t\t}\n\n\t\trollbackMap := make(map[string]string)\n\t\tif outSubTaskRes != nil && len(outSubTaskRes.SubTaskSet) > 0 {\n\t\t\tin.InstanceIds = make(map[string]uint64, 0)\n\t\t\tfor _, v := range outSubTaskRes.SubTaskSet {\n\t\t\t\tin.InstanceIds[v.InstanceId] = v.BatchOrder\n\t\t\t\trollbackMap[v.InstanceId] = v.Rollback\n\t\t\t}\n\t\t\tif errTx := tx.Model(&entity.ScheduledTask{}).\n\t\t\t\tWhere(\"id = ? \", lastInsertId).\n\t\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\t\"total_sub_task\": len(outSubTaskRes.SubTaskSet),\n\t\t\t\t\t\"notify_type\":    outSubTaskRes.OriginTaskInfo.NotifyType,\n\t\t\t\t\t\"batch_num\":      outSubTaskRes.OriginTaskInfo.BatchNum,\n\t\t\t\t}).Error; errTx != nil {\n\t\t\t\tglog.Error(errTx.Error())\n\t\t\t\treturn errTx\n\t\t\t}\n\t\t}\n\n\t\tif len(in.InstanceIds) > 0 {\n\t\t\tidList := make([]string, 0)\n\t\t\tfor k, _ := range in.InstanceIds {\n\t\t\t\tidList = append(idList, k)\n\t\t\t}\n\t\t\tif err := s.checkSubTaskLocked(idList); err != nil {\n\t\t\t\treturn err\n\t\t\t}\n\n\t\t\tsubTaskList := make([]*entity.ScheduledSubTask, 0)\n\t\t\tfor instanceId, BatchOrder := range in.InstanceIds {\n\t\t\t\trollback := \"\"\n\t\t\t\tparams := in.Params\n\t\t\t\tif len(rollbackMap) > 0 {\n\t\t\t\t\tif v, ok := rollbackMap[instanceId]; ok {\n\t\t\t\t\t\trollback = v\n\t\t\t\t\t\tparams = v\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tsubTaskList = append(subTaskList, &entity.ScheduledSubTask{\n\t\t\t\t\tName:       taskName,\n\t\t\t\t\tParams:     params,\n\t\t\t\t\tRollback:   rollback,\n\t\t\t\t\tInstanceId: instanceId,\n\t\t\t\t\tTaskId:     \"\",\n\t\t\t\t\tStatus:     consts.ScheduledTaskStatusPause, // 等待批启动\n\t\t\t\t\tBatchOrder: BatchOrder,\n\t\t\t\t\tIsLock:     consts.SubTaskLock,\n\t\t\t\t\tCreateTime: &now,\n\t\t\t\t\tUpdateTime: &now,\n\t\t\t\t})\n\t\t\t}\n\t\t\tif errTx := tx.Model(&entity.ScheduledSubTask{}).Create(&subTaskList).Error; errTx != nil {\n\t\t\t\tglog.Error(errTx.Error())\n\t\t\t\treturn errTx\n\t\t\t}\n\t\t} else {\n\t\t\treturn fmt.Errorf(\"need InstanceIds\")\n\t\t}\n\n\t\treturn nil\n\t})\n\n\treturn\n}",
    "caller": "func (h *Handler) CreateUpgradeImageTask(ctx *gin.Context) (interface{}, error) {\n\tvar (\n\t\tcReq  = new(model.UpgradeImageReq)\n\t\tentry = glog.WithContext(ctx)\n\t)\n\n\tentry.Debugf(\"Raw cReq: %+v\", cReq)\n\trspErr := basic.Transfer(cReq, ctx)\n\tif rspErr != nil {\n\n\t\tentry.Error(rspErr.Error())\n\t\treturn nil, api.NewError(api.InvalidParameter, rspErr.Error())\n\t}\n\n\t// TODO: validate user has access to the product\n\n\t// check image\n\tfor _, v := range cReq.ImageInfo.Images {\n\t\timage := v.ContainerImage\n\t\tregex := `^[a-zA-Z0-9\\/_\\-\\.]+:?[a-zA-Z0-9_\\-.]+$`\n\t\tmatch, _ := regexp.MatchString(regex, image)\n\t\tif match == false {\n\t\t\treturn nil, api.NewError(api.InvalidParameter, fmt.Sprintf(\"container %s has Invalid image %s\", v.ContainerName, v.ContainerImage))\n\t\t}\n\n\t\t// we do not allow to update khaos biz container for now\n\t\t// if v.ContainerName == khaos.KhaosBizContainerName {\n\t\t// \treturn nil, api.NewError(api.InvalidParameter, fmt.Sprintf(\"container %s is not allowed to be updated\", v.ContainerName))\n\t\t// }\n\t}\n\n\tids := make(map[string]uint64, 0)\n\tfor _, v := range cReq.InstanceIds {\n\t\tif v.InstanceId == \"\" || v.BatchOrder == 0 {\n\t\t\tif cReq.BizSpec != \"\" {\n\t\t\t\tcontinue\n\t\t\t} else {\n\t\t\t\treturn nil, api.NewError(api.InvalidParameter, fmt.Sprintf(\"Batch %d has Invalid empty InstanceId\", v.BatchOrder))\n\t\t\t}\n\t\t}\n\t\tids[v.InstanceId] = v.BatchOrder\n\t}\n\tjs, err := json.Marshal(cReq.ImageInfo)\n\tif err != nil {\n\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t}\n\n\terrorAbort := true\n\tif cReq.ErrorAbort != nil {\n\t\terrorAbort = *cReq.ErrorAbort\n\t}\n\n\ttaskType := consts.ScheduledTaskTypeUpgradeImage\n\tif cReq.BizSpec != \"\" {\n\t\ttaskType = consts.ScheduledTaskTypeRollbackImage\n\t}\n\n\toutRes, err := task.TaskInstance().Register(ctx, model.ScheduledTaskRegisterInput{\n\t\tType:        taskType,\n\t\tProduct:     cReq.Product,\n\t\tBizSpec:     cReq.BizSpec,\n\t\tRegion:      cReq.ProductRegion,\n\t\tInstanceIds: ids,\n\t\tParams:      string(js),\n\t\tBrief:       cReq.Brief,\n\t\tBatchNum:    cReq.BatchNum,\n\t\tErrorAbort:  errorAbort,\n\t\t// Creator:         cReq.RequestUser,\n\t\tTaskNameByInput: cReq.TaskNameByInput,\n\t\tZiYanURL:        cReq.ZiYanURL,\n\t\tNotifyType:      cReq.NotifyType,\n\t})\n\n\tif err != nil {\n\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t}\n\n\treturn &model.UpgradeImageRes{\n\t\tName: outRes,\n\t}, nil\n}",
    "sql_statement_list": [
      "INSERT INTO `scheduled_task` (`product`,`region`,`biz_spec`,`name`,`type`,`params`,`brief`,`status`,`batch_num`,`error_abort`,`total_sub_task`,`create_time`,`update_time`,`creator`,`task_name_by_input`,`zi_yan_url`,`notify_type`) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);",
      "UPDATE `scheduled_task` SET `name`=? WHERE id = ?;",
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "当BizSpec不为空且有回滚子任务数据时",
            "sql": "UPDATE `scheduled_task` SET `batch_num`=?,`notify_type`=?,`total_sub_task`=? WHERE id = ?;"
          }
        ]
      },
      "SELECT * FROM `scheduled_sub_task` WHERE instance_id IN (?,?,?) AND is_lock = ?;",
      "INSERT INTO `scheduled_sub_task` (`name`,`params`,`rollback`,`instance_id`,`task_id`,`status`,`batch_order`,`is_lock`,`create_time`,`update_time`) VALUES (?,?,?,?,?,?,?,?,?,?),(?,?,?,?,?,?,?,?,?,?);"
    ],
    "sql_types": [
      "INSERT",
      "UPDATE",
      "PARAM_DEPENDENT",
      "SELECT",
      "INSERT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 6,
        "code_end_line": 25,
        "code_key": "ScheduledTask",
        "code_value": "type ScheduledTask struct {\n\tId              uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tProduct         string     `db:\"column:product\" json:\"Product\" description:\"业务产品\"`\n\tBizSpec         string     `db:\"column:biz_spec\" json:\"BizSpec\" description:\"留给不同平台业务自行解释\"`\n\tRegion          string     `db:\"column:region\" json:\"Region\" description:\"业务所在区\"`\n\tName            string     `db:\"column:name\" json:\"Name\" description:\"任务名称(唯一自动生成)\"`\n\tType            string     `db:\"column:type\" json:\"Type\" description:\"任务类型(UpgradeImage)\"`\n\tParams          string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tBrief           string     `db:\"column:brief\" json:\"Brief\" description:\"任务描述\"`\n\tStatus          string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Terminating,Succeeded,Failed,Error)\"`\n\tBatchNum        uint       `db:\"column:batch_num\" json:\"BatchNum\" description:\"单批次并发限制\"`\n\tTotalSubTask    uint       `db:\"column:total_sub_task\" json:\"TotalSubTask\" description:\"子任务总数\"`\n\tErrorAbort      bool       `db:\"column:error_abort\" json:\"ErrorAbort\" description:\"是否报错中止\"`\n\tCreateTime      *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime      *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tCreator         string     `db:\"column:creator\" json:\"Creator\" description:\"创建者\"`\n\tTaskNameByInput string     `db:\"column:task_name_by_input\" json:\"TaskNameByInput\" description:\"用户输入的名字\"`\n\tZiYanURL        string     `db:\"column:zi_yan_url\" json:\"ZiYanURL\" description:\"自研审批链接\"`\n\tNotifyType      uint       `db:\"column:notify_type\" json:\"NotifyType\" description:\"任务通知类型\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 28,
        "code_end_line": 28,
        "code_key": "TableName",
        "code_value": "func (ScheduledTask) TableName() string { return \"scheduled_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 119,
        "code_end_line": 122,
        "code_key": "ScheduledTaskRollBackOutput",
        "code_value": "type ScheduledTaskRollBackOutput struct {\n\tSubTaskSet     []entity.ScheduledSubTask `dc:\"子任务数据\"`\n\tOriginTaskInfo entity.ScheduledTask      `dc:\"回滚前的主任务数据\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 30,
        "code_end_line": 42,
        "code_key": "ScheduledSubTask",
        "code_value": "type ScheduledSubTask struct {\n\tId         uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tName       string     `db:\"column:name\" json:\"Name\" description:\"任务名称\"`\n\tParams     string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tInstanceId string     `db:\"column:instance_id\" json:\"InstanceId\" description:\"实例Id\"`\n\tTaskId     string     `db:\"column:task_id\" json:\"TaskId\" description:\"Workflow子任务ID\"`\n\tBatchOrder uint64     `db:\"column:batch_order\" json:\"BatchOrder\" description:\"属于哪一个批次\"`\n\tRollback   string     `db:\"column:rollback\" json:\"RollBack\" description:\"任务回滚的参数\"`\n\tStatus     string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Suspending,Suspended,Terminating,Stopping,Succeeded,Failed,Error)\"`\n\tCreateTime *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tIsLock     uint       `db:\"column:is_lock\" json:\"IsLock\" description:\"是否锁定资源\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 45,
        "code_end_line": 45,
        "code_key": "TableName",
        "code_value": "func (ScheduledSubTask) TableName() string { return \"scheduled_sub_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 113,
        "code_end_line": 116,
        "code_key": "ScheduledTaskRollBackInput",
        "code_value": "type ScheduledTaskRollBackInput struct {\n\tTaskInfo    entity.ScheduledTask\n\tInstanceIds map[string]uint64 `dc:\"实例Id对应的批次信息\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/qtty/model/kube_config.go",
        "code_start_line": 22,
        "code_end_line": 25,
        "code_key": "Context",
        "code_value": "type Context struct {\n\tName    string      `json:\"name\" yaml:\"name\"`\n\tContext ContextItem `json:\"context\" yaml:\"context\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 31,
        "code_end_line": 46,
        "code_key": "ScheduledTaskRegisterInput",
        "code_value": "type ScheduledTaskRegisterInput struct {\n\tType    string `dc:\"任务类型(UpgradeImage)\"`\n\tProduct string `dc:\"业务产品\"`\n\tRegion  string `dc:\"区域\"`\n\t// BizSpec 适配不同平台及特殊逻辑的钩子，升级回滚场景下传递的是需要回滚的任务名称\n\tBizSpec         string            `dc:\"所属各个业务特性信息\"`\n\tInstanceIds     map[string]uint64 `dc:\"实例Id对应的批次信息\"`\n\tParams          string            `dc:\"任务参数，不同的任务类型参数格式不同\"`\n\tBrief           string            `dc:\"任务描述\"`\n\tBatchNum        uint              `dc:\"每次批量启动子任务数量\"`\n\tErrorAbort      bool              `dc:\"是否报错中止\"`\n\tCreator         string            `dc:\"创建者\"`\n\tTaskNameByInput string            `dc:\"用户输入的名字\"`\n\tZiYanURL        string            `dc:\"自研审批链接\"`\n\tNotifyType      uint              `dc:\"任务通知类型\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      }
    ],
    "sql_pattern_cnt": 5,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/csig_tdmq__moss.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/task.go:366:418:TerminateTask",
    "orm_code": "func (s *sScheduledTask) TerminateTask(ctx *gin.Context, in model.ScheduledTaskOperateInput) (err error) {\n\n\tentry := glog.WithContext(ctx)\n\terr = s.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\ttx.Model(&entity.ScheduledTask{}).Where(\" name = ? \", in.Name).Update(\"status\", consts.ScheduledTaskStatusTerminating)\n\t\treturn tx.Error\n\t})\n\n\ttask, err := s.GetTaskOne(ctx, model.ScheduledTaskGetOneInput{\n\t\tName: in.Name,\n\t})\n\tif err != nil {\n\t\treturn\n\t}\n\n\toutSubTask, err := s.GetSubTaskList(ctx, model.ScheduledSubTaskGetListInput{\n\t\tName: in.Name,\n\t\tStatuses: []string{ // 只处理 running  pending 状态\n\t\t\tconsts.ScheduledTaskStatusRunning,\n\t\t\tconsts.ScheduledTaskStatusPending,\n\t\t},\n\t})\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 同一批任务属于一个平台\n\tproductService := product.GetServiceInstance()\n\tpf, err := productService.GetProductPlatformCached(task.Product, task.Region)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tfor _, subTask := range outSubTask.SubTaskSet {\n\t\tif subTask.TaskId == \"\" {\n\t\t\tcontinue\n\t\t}\n\n\t\tgo func(st entity.ScheduledSubTask) {\n\t\t\tentry.Infof(\"Terminating subtask: %d\", st.Id)\n\t\t\tif err := handlers.TaskApiServiceInstance(pf).TerminateTask(ctx, model.ScheduledSubTaskOperateInput{\n\t\t\t\tSubTaskId: st.Id,\n\t\t\t}); err != nil {\n\t\t\t\tmsg := fmt.Sprintf(\"TerminateTask Error : %s\", err.Error())\n\t\t\t\talarm.ReportAlarm(\"TerminateTask Error\", \"\", msg)\n\t\t\t}\n\t\t}(subTask)\n\n\t\ttime.Sleep(time.Microsecond * 50)\n\t}\n\n\treturn\n}",
    "caller": "",
    "sql_statement_list": [
      "UPDATE `scheduled_task` SET `status` = ? WHERE name = ?;"
    ],
    "sql_types": [
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 6,
        "code_end_line": 25,
        "code_key": "ScheduledTask",
        "code_value": "type ScheduledTask struct {\n\tId              uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tProduct         string     `db:\"column:product\" json:\"Product\" description:\"业务产品\"`\n\tBizSpec         string     `db:\"column:biz_spec\" json:\"BizSpec\" description:\"留给不同平台业务自行解释\"`\n\tRegion          string     `db:\"column:region\" json:\"Region\" description:\"业务所在区\"`\n\tName            string     `db:\"column:name\" json:\"Name\" description:\"任务名称(唯一自动生成)\"`\n\tType            string     `db:\"column:type\" json:\"Type\" description:\"任务类型(UpgradeImage)\"`\n\tParams          string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tBrief           string     `db:\"column:brief\" json:\"Brief\" description:\"任务描述\"`\n\tStatus          string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Terminating,Succeeded,Failed,Error)\"`\n\tBatchNum        uint       `db:\"column:batch_num\" json:\"BatchNum\" description:\"单批次并发限制\"`\n\tTotalSubTask    uint       `db:\"column:total_sub_task\" json:\"TotalSubTask\" description:\"子任务总数\"`\n\tErrorAbort      bool       `db:\"column:error_abort\" json:\"ErrorAbort\" description:\"是否报错中止\"`\n\tCreateTime      *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime      *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tCreator         string     `db:\"column:creator\" json:\"Creator\" description:\"创建者\"`\n\tTaskNameByInput string     `db:\"column:task_name_by_input\" json:\"TaskNameByInput\" description:\"用户输入的名字\"`\n\tZiYanURL        string     `db:\"column:zi_yan_url\" json:\"ZiYanURL\" description:\"自研审批链接\"`\n\tNotifyType      uint       `db:\"column:notify_type\" json:\"NotifyType\" description:\"任务通知类型\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 28,
        "code_end_line": 28,
        "code_key": "TableName",
        "code_value": "func (ScheduledTask) TableName() string { return \"scheduled_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 69,
        "code_end_line": 73,
        "code_key": "ScheduledTaskGetOneInput",
        "code_value": "type ScheduledTaskGetOneInput struct {\n\tProduct       string `dc:\"业务产品\"`\n\tName          string `dc:\"任务名称\"`\n\tProductRegion string `dc:\"区域\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 136,
        "code_end_line": 149,
        "code_key": "ScheduledSubTaskGetListInput",
        "code_value": "type ScheduledSubTaskGetListInput struct {\n\n\t// TODO 将下面的转换\n\tFilters []basic.Filter\n\n\tProduct        string   `dc:\"业务产品\"`\n\tProductRegion  string   `dc:\"区域\"`\n\tName           string   `dc:\"任务名称\"`\n\tStatuses       []string `dc:\"运行状态\"`\n\tInstanceId     string   `dc:\"模糊搜索:实例Id\"`\n\tOrderBy        string   `dc:\"排序字段\"`\n\tOrderDirection string   `dc:\"排序方式\"`\n\tCommonPaginationInput\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 30,
        "code_end_line": 42,
        "code_key": "ScheduledSubTask",
        "code_value": "type ScheduledSubTask struct {\n\tId         uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tName       string     `db:\"column:name\" json:\"Name\" description:\"任务名称\"`\n\tParams     string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tInstanceId string     `db:\"column:instance_id\" json:\"InstanceId\" description:\"实例Id\"`\n\tTaskId     string     `db:\"column:task_id\" json:\"TaskId\" description:\"Workflow子任务ID\"`\n\tBatchOrder uint64     `db:\"column:batch_order\" json:\"BatchOrder\" description:\"属于哪一个批次\"`\n\tRollback   string     `db:\"column:rollback\" json:\"RollBack\" description:\"任务回滚的参数\"`\n\tStatus     string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Suspending,Suspended,Terminating,Stopping,Succeeded,Failed,Error)\"`\n\tCreateTime *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tIsLock     uint       `db:\"column:is_lock\" json:\"IsLock\" description:\"是否锁定资源\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 45,
        "code_end_line": 45,
        "code_key": "TableName",
        "code_value": "func (ScheduledSubTask) TableName() string { return \"scheduled_sub_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 163,
        "code_end_line": 167,
        "code_key": "ScheduledSubTaskOperateInput",
        "code_value": "type ScheduledSubTaskOperateInput struct {\n\tName       string `dc:\"任务名称\"`\n\tSubTaskId  uint64 `dc:\"子任务Id\"`\n\tInstanceId string `dc:\"实例ID\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/qtty/model/kube_config.go",
        "code_start_line": 22,
        "code_end_line": 25,
        "code_key": "Context",
        "code_value": "type Context struct {\n\tName    string      `json:\"name\" yaml:\"name\"`\n\tContext ContextItem `json:\"context\" yaml:\"context\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 152,
        "code_end_line": 154,
        "code_key": "ScheduledTaskOperateInput",
        "code_value": "type ScheduledTaskOperateInput struct {\n\tName string `dc:\"任务名称\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/csig_tdmq__moss.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/task.go:366:418:TerminateTask",
    "orm_code": "func (s *sScheduledTask) TerminateTask(ctx *gin.Context, in model.ScheduledTaskOperateInput) (err error) {\n\n\tentry := glog.WithContext(ctx)\n\terr = s.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\ttx.Model(&entity.ScheduledTask{}).Where(\" name = ? \", in.Name).Update(\"status\", consts.ScheduledTaskStatusTerminating)\n\t\treturn tx.Error\n\t})\n\n\ttask, err := s.GetTaskOne(ctx, model.ScheduledTaskGetOneInput{\n\t\tName: in.Name,\n\t})\n\tif err != nil {\n\t\treturn\n\t}\n\n\toutSubTask, err := s.GetSubTaskList(ctx, model.ScheduledSubTaskGetListInput{\n\t\tName: in.Name,\n\t\tStatuses: []string{ // 只处理 running  pending 状态\n\t\t\tconsts.ScheduledTaskStatusRunning,\n\t\t\tconsts.ScheduledTaskStatusPending,\n\t\t},\n\t})\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 同一批任务属于一个平台\n\tproductService := product.GetServiceInstance()\n\tpf, err := productService.GetProductPlatformCached(task.Product, task.Region)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tfor _, subTask := range outSubTask.SubTaskSet {\n\t\tif subTask.TaskId == \"\" {\n\t\t\tcontinue\n\t\t}\n\n\t\tgo func(st entity.ScheduledSubTask) {\n\t\t\tentry.Infof(\"Terminating subtask: %d\", st.Id)\n\t\t\tif err := handlers.TaskApiServiceInstance(pf).TerminateTask(ctx, model.ScheduledSubTaskOperateInput{\n\t\t\t\tSubTaskId: st.Id,\n\t\t\t}); err != nil {\n\t\t\t\tmsg := fmt.Sprintf(\"TerminateTask Error : %s\", err.Error())\n\t\t\t\talarm.ReportAlarm(\"TerminateTask Error\", \"\", msg)\n\t\t\t}\n\t\t}(subTask)\n\n\t\ttime.Sleep(time.Microsecond * 50)\n\t}\n\n\treturn\n}",
    "caller": "func (h *Handler) ModifyTaskStatus(ctx *gin.Context) (interface{}, error) {\n\tvar (\n\t\tcReq  = new(model.ScheduledChangeTaskStatusInput)\n\t\tentry = glog.WithContext(ctx)\n\t)\n\n\tentry.Debugf(\"Raw cReq: %+v\", cReq)\n\trspErr := basic.Transfer(cReq, ctx)\n\tif rspErr != nil {\n\t\tentry.Error(rspErr.Error())\n\t\treturn nil, api.NewError(api.InvalidParameter, rspErr.Error())\n\t}\n\n\toutTaskDetailInfoRes, err := task.TaskInstance().GetTaskOne(ctx, model.ScheduledTaskGetOneInput{\n\t\tName: cReq.Name,\n\t})\n\tif err != nil {\n\t\t// 记录日志\n\t\tentry.Error(err.Error())\n\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\n\t}\n\n\t// TODO: validate user has access to the product\n\tswitch cReq.Status {\n\n\t// 启动 audit -> ready\n\tcase consts.ScheduledTaskStatusReady:\n\t\tif outTaskDetailInfoRes.Status != consts.ScheduledTaskStatusAudit {\n\t\t\t// Ready 前置条件是 audit 状态\n\t\t\terr = fmt.Errorf(\"Ready  pre status need   audit \")\n\t\t\tentry.Error(err.Error())\n\t\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t\t}\n\t\tif err := h.db.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\tUpdate(\"status\", cReq.Status).Error; err != nil {\n\t\t\tentry.Error(err)\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\t// 暂停 pause -> running 批次启动操作\n\tcase consts.ScheduledTaskStatusRunning:\n\t\t// 启动，或者从暂停状态恢复（批次启动）\n\t\tswitch outTaskDetailInfoRes.Status {\n\t\tcase consts.ScheduledTaskStatusPause:\n\t\t\toutRes, err := task.TaskInstance().GetSubTaskList(ctx, model.ScheduledSubTaskGetListInput{\n\t\t\t\tName:    cReq.Name,\n\t\t\t\tOrderBy: \"batch_order\",\n\t\t\t})\n\t\t\tif err != nil {\n\t\t\t\tentry.Error(err.Error())\n\t\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t\t}\n\n\t\t\tbatchNum := uint64(0)\n\t\t\tfor _, subTask := range outRes.SubTaskSet {\n\t\t\t\tif subTask.Status == consts.ScheduledTaskStatusPause {\n\t\t\t\t\tbatchNum = subTask.BatchOrder\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif err = h.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\t\t\t// 修改主任务状态\n\t\t\t\torm := tx.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusRunning)\n\t\t\t\tif orm.Error != nil {\n\t\t\t\t\treturn orm.Error\n\t\t\t\t}\n\n\t\t\t\t{\n\t\t\t\t\tvar subTaskList []dao.ScheduledSubTask\n\t\t\t\t\torm = tx.Model(dao.ScheduledSubTask{}).\n\t\t\t\t\t\tWhere(\"name = ? and batch_order = ? \", cReq.Name, batchNum).Find(&subTaskList)\n\t\t\t\t\tif orm.Error != nil {\n\t\t\t\t\t\treturn orm.Error\n\t\t\t\t\t}\n\n\t\t\t\t\ttask.ReportCalendar(outTaskDetailInfoRes.ScheduledTask, subTaskList, zhiyan.CalendarOperationStart,\n\t\t\t\t\t\tzhiyan.CalendarStatusIgnore, task.GetUserID(ctx))\n\t\t\t\t}\n\t\t\t\t// 修改对应批次子任务状态\n\t\t\t\torm = tx.Model(&dao.ScheduledSubTask{}).Where(\"name = ? and batch_order = ? and status != ?\", cReq.Name, batchNum, consts.ScheduledTaskStatusSucceeded).\n\t\t\t\t\tUpdates(map[string]interface{}{\n\t\t\t\t\t\t\"create_time\": time.Now(),\n\t\t\t\t\t\t\"status\":      consts.ScheduledTaskStatusPending,\n\t\t\t\t\t})\n\n\t\t\t\tif orm.Error != nil {\n\t\t\t\t\treturn orm.Error\n\t\t\t\t}\n\n\t\t\t\treturn nil\n\n\t\t\t}); err != nil {\n\t\t\t\tentry.Error(err.Error())\n\t\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t\t}\n\n\t\tcase consts.ScheduledTaskStatusReady:\n\t\t\tif err = h.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\t\t\t// 修改主任务状态\n\t\t\t\torm := tx.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusPending) // 修改对应批次子任务状态\n\t\t\t\tif orm.Error != nil {\n\t\t\t\t\treturn orm.Error\n\t\t\t\t}\n\t\t\t\torm = tx.Model(&dao.ScheduledSubTask{}).Where(\"name = ? and batch_order = ? \", cReq.Name, 1).\n\t\t\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusPending)\n\t\t\t\tif orm.Error != nil {\n\t\t\t\t\treturn orm.Error\n\t\t\t\t}\n\t\t\t\treturn nil\n\t\t\t}); err != nil {\n\t\t\t\tentry.Error(err.Error())\n\t\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t\t}\n\n\t\tcase consts.ScheduledTaskStatusAudit:\n\t\t\tif err = h.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\t\t\t// 修改主任务状态\n\t\t\t\torm := tx.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusPending) // 修改对应批次子任务状态\n\t\t\t\tif orm.Error != nil {\n\t\t\t\t\treturn orm.Error\n\t\t\t\t}\n\n\t\t\t\t// 上报智研日历\n\t\t\t\t{\n\t\t\t\t\tvar subTaskList []dao.ScheduledSubTask\n\n\t\t\t\t\torm = tx.Model(dao.ScheduledSubTask{}).Where(\"name = ? and batch_order = ? \", cReq.Name, 1).Find(&subTaskList)\n\t\t\t\t\tif orm.Error != nil {\n\t\t\t\t\t\treturn orm.Error\n\t\t\t\t\t}\n\t\t\t\t\ttask.ReportCalendar(outTaskDetailInfoRes.ScheduledTask, subTaskList, zhiyan.CalendarOperationStart, zhiyan.CalendarStatusIgnore, task.GetUserID(ctx))\n\t\t\t\t}\n\n\t\t\t\torm = tx.Model(&dao.ScheduledSubTask{}).Where(\"name = ? and batch_order = ? \", cReq.Name, 1).\n\t\t\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusPending)\n\t\t\t\tif orm.Error != nil {\n\t\t\t\t\treturn orm.Error\n\t\t\t\t}\n\t\t\t\treturn nil\n\t\t\t}); err != nil {\n\t\t\t\tentry.Error(err.Error())\n\t\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t\t}\n\t\tdefault:\n\t\t\t// Pause 前置条件是 run 状态\n\t\t\terr = fmt.Errorf(\"%s status can not changed to running\", outTaskDetailInfoRes.Status)\n\t\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\n\t\t}\n\n\t// 暂停 running -> pause\n\tcase consts.ScheduledTaskStatusPause:\n\t\t// 进入暂停状态，批次启动\n\t\tif outTaskDetailInfoRes.Status != consts.ScheduledTaskStatusRunning {\n\t\t\t// Pause 前置条件是 run 状态\n\t\t\terr = fmt.Errorf(\"only running task can be paused\")\n\t\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t\t}\n\t\tif err := h.db.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusPausing).Error; err != nil {\n\t\t\tentry.Error(err)\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\n\t// 终止任务\n\tcase consts.ScheduledTaskStatusTerminated:\n\t\tif outTaskDetailInfoRes.Status != consts.ScheduledTaskStatusRunning &&\n\t\t\toutTaskDetailInfoRes.Status != consts.ScheduledTaskStatusPause &&\n\t\t\toutTaskDetailInfoRes.Status != consts.ScheduledTaskStatusInit &&\n\t\t\toutTaskDetailInfoRes.Status != consts.ScheduledTaskStatusAudit {\n\n\t\t\terr = errors.New(\"only running/pause/init/audit task can be terminated\")\n\t\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t\t}\n\n\t\terr := task.TaskInstance().TerminateTask(ctx, model.ScheduledTaskOperateInput{\n\t\t\tName: cReq.Name,\n\t\t})\n\t\tif err != nil {\n\t\t\tentry.Error(err.Error())\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\n\t\t// 解锁 pause 状态的资源锁\n\t\tif err := h.db.Model(&dao.ScheduledSubTask{}).Where(\"name = ?\", cReq.Name).Where(\"status = ?\", consts.ScheduledTaskStatusPause).\n\t\t\tUpdate(\"is_lock\", consts.SubTaskUnLock).Error; err != nil {\n\t\t\tentry.Error(err)\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\n\t// 重试 failed -> retrying\n\tcase consts.ScheduledTaskStatusRetry:\n\t\tif outTaskDetailInfoRes.Status != consts.ScheduledTaskStatusFailed {\n\t\t\t// Retry 前置条件是 failed 状态\n\t\t\terr = errors.New(\"only failed task can be retried\")\n\t\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t\t}\n\n\t\terr := task.TaskInstance().RetryTask(ctx, model.ScheduledSubTaskOperateInput{\n\t\t\tName: cReq.Name,\n\t\t})\n\t\tif err != nil {\n\t\t\tentry.Error(err.Error())\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\n\t\tif err := h.db.Model(&dao.ScheduledTask{}).Where(\"name = ?\", cReq.Name).\n\t\t\tUpdate(\"status\", consts.ScheduledTaskStatusRetrying).Error; err != nil {\n\t\t\tentry.Error(err)\n\t\t\treturn nil, api.NewError(api.InternalError, err.Error())\n\t\t}\n\tdefault:\n\t\terr = fmt.Errorf(\"invalid operation: \" + cReq.Status)\n\t\treturn nil, api.NewError(api.InvalidParameter, err.Error())\n\t}\n\n\treturn &model.ScheduledChangeTaskStatusOutput{\n\t\tStatus: cReq.Status,\n\t}, nil\n}",
    "sql_statement_list": [
      "UPDATE scheduled_task SET status = ? WHERE name = ?;",
      "SELECT id, product, biz_spec, region, name, type, params, brief, status, batch_num, total_sub_task, error_abort, create_time, update_time, creator, task_name_by_input, zi_yan_url, notify_type FROM scheduled_task WHERE name = ? LIMIT 1;"
    ],
    "sql_types": [
      "UPDATE",
      "SELECT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 6,
        "code_end_line": 25,
        "code_key": "ScheduledTask",
        "code_value": "type ScheduledTask struct {\n\tId              uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tProduct         string     `db:\"column:product\" json:\"Product\" description:\"业务产品\"`\n\tBizSpec         string     `db:\"column:biz_spec\" json:\"BizSpec\" description:\"留给不同平台业务自行解释\"`\n\tRegion          string     `db:\"column:region\" json:\"Region\" description:\"业务所在区\"`\n\tName            string     `db:\"column:name\" json:\"Name\" description:\"任务名称(唯一自动生成)\"`\n\tType            string     `db:\"column:type\" json:\"Type\" description:\"任务类型(UpgradeImage)\"`\n\tParams          string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tBrief           string     `db:\"column:brief\" json:\"Brief\" description:\"任务描述\"`\n\tStatus          string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Terminating,Succeeded,Failed,Error)\"`\n\tBatchNum        uint       `db:\"column:batch_num\" json:\"BatchNum\" description:\"单批次并发限制\"`\n\tTotalSubTask    uint       `db:\"column:total_sub_task\" json:\"TotalSubTask\" description:\"子任务总数\"`\n\tErrorAbort      bool       `db:\"column:error_abort\" json:\"ErrorAbort\" description:\"是否报错中止\"`\n\tCreateTime      *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime      *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tCreator         string     `db:\"column:creator\" json:\"Creator\" description:\"创建者\"`\n\tTaskNameByInput string     `db:\"column:task_name_by_input\" json:\"TaskNameByInput\" description:\"用户输入的名字\"`\n\tZiYanURL        string     `db:\"column:zi_yan_url\" json:\"ZiYanURL\" description:\"自研审批链接\"`\n\tNotifyType      uint       `db:\"column:notify_type\" json:\"NotifyType\" description:\"任务通知类型\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 28,
        "code_end_line": 28,
        "code_key": "TableName",
        "code_value": "func (ScheduledTask) TableName() string { return \"scheduled_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 69,
        "code_end_line": 73,
        "code_key": "ScheduledTaskGetOneInput",
        "code_value": "type ScheduledTaskGetOneInput struct {\n\tProduct       string `dc:\"业务产品\"`\n\tName          string `dc:\"任务名称\"`\n\tProductRegion string `dc:\"区域\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 136,
        "code_end_line": 149,
        "code_key": "ScheduledSubTaskGetListInput",
        "code_value": "type ScheduledSubTaskGetListInput struct {\n\n\t// TODO 将下面的转换\n\tFilters []basic.Filter\n\n\tProduct        string   `dc:\"业务产品\"`\n\tProductRegion  string   `dc:\"区域\"`\n\tName           string   `dc:\"任务名称\"`\n\tStatuses       []string `dc:\"运行状态\"`\n\tInstanceId     string   `dc:\"模糊搜索:实例Id\"`\n\tOrderBy        string   `dc:\"排序字段\"`\n\tOrderDirection string   `dc:\"排序方式\"`\n\tCommonPaginationInput\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 30,
        "code_end_line": 42,
        "code_key": "ScheduledSubTask",
        "code_value": "type ScheduledSubTask struct {\n\tId         uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tName       string     `db:\"column:name\" json:\"Name\" description:\"任务名称\"`\n\tParams     string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tInstanceId string     `db:\"column:instance_id\" json:\"InstanceId\" description:\"实例Id\"`\n\tTaskId     string     `db:\"column:task_id\" json:\"TaskId\" description:\"Workflow子任务ID\"`\n\tBatchOrder uint64     `db:\"column:batch_order\" json:\"BatchOrder\" description:\"属于哪一个批次\"`\n\tRollback   string     `db:\"column:rollback\" json:\"RollBack\" description:\"任务回滚的参数\"`\n\tStatus     string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Suspending,Suspended,Terminating,Stopping,Succeeded,Failed,Error)\"`\n\tCreateTime *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tIsLock     uint       `db:\"column:is_lock\" json:\"IsLock\" description:\"是否锁定资源\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 45,
        "code_end_line": 45,
        "code_key": "TableName",
        "code_value": "func (ScheduledSubTask) TableName() string { return \"scheduled_sub_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 163,
        "code_end_line": 167,
        "code_key": "ScheduledSubTaskOperateInput",
        "code_value": "type ScheduledSubTaskOperateInput struct {\n\tName       string `dc:\"任务名称\"`\n\tSubTaskId  uint64 `dc:\"子任务Id\"`\n\tInstanceId string `dc:\"实例ID\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/qtty/model/kube_config.go",
        "code_start_line": 22,
        "code_end_line": 25,
        "code_key": "Context",
        "code_value": "type Context struct {\n\tName    string      `json:\"name\" yaml:\"name\"`\n\tContext ContextItem `json:\"context\" yaml:\"context\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 152,
        "code_end_line": 154,
        "code_key": "ScheduledTaskOperateInput",
        "code_value": "type ScheduledTaskOperateInput struct {\n\tName string `dc:\"任务名称\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/csig_tdmq__moss.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/task.go:366:418:TerminateTask",
    "orm_code": "func (s *sScheduledTask) TerminateTask(ctx *gin.Context, in model.ScheduledTaskOperateInput) (err error) {\n\n\tentry := glog.WithContext(ctx)\n\terr = s.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\ttx.Model(&entity.ScheduledTask{}).Where(\" name = ? \", in.Name).Update(\"status\", consts.ScheduledTaskStatusTerminating)\n\t\treturn tx.Error\n\t})\n\n\ttask, err := s.GetTaskOne(ctx, model.ScheduledTaskGetOneInput{\n\t\tName: in.Name,\n\t})\n\tif err != nil {\n\t\treturn\n\t}\n\n\toutSubTask, err := s.GetSubTaskList(ctx, model.ScheduledSubTaskGetListInput{\n\t\tName: in.Name,\n\t\tStatuses: []string{ // 只处理 running  pending 状态\n\t\t\tconsts.ScheduledTaskStatusRunning,\n\t\t\tconsts.ScheduledTaskStatusPending,\n\t\t},\n\t})\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 同一批任务属于一个平台\n\tproductService := product.GetServiceInstance()\n\tpf, err := productService.GetProductPlatformCached(task.Product, task.Region)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tfor _, subTask := range outSubTask.SubTaskSet {\n\t\tif subTask.TaskId == \"\" {\n\t\t\tcontinue\n\t\t}\n\n\t\tgo func(st entity.ScheduledSubTask) {\n\t\t\tentry.Infof(\"Terminating subtask: %d\", st.Id)\n\t\t\tif err := handlers.TaskApiServiceInstance(pf).TerminateTask(ctx, model.ScheduledSubTaskOperateInput{\n\t\t\t\tSubTaskId: st.Id,\n\t\t\t}); err != nil {\n\t\t\t\tmsg := fmt.Sprintf(\"TerminateTask Error : %s\", err.Error())\n\t\t\t\talarm.ReportAlarm(\"TerminateTask Error\", \"\", msg)\n\t\t\t}\n\t\t}(subTask)\n\n\t\ttime.Sleep(time.Microsecond * 50)\n\t}\n\n\treturn\n}",
    "caller": "func (s *sScheduledTask) TerminateTask(ctx *gin.Context, in model.ScheduledTaskOperateInput) (err error) {\n\n\tentry := glog.WithContext(ctx)\n\terr = s.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\ttx.Model(&entity.ScheduledTask{}).Where(\" name = ? \", in.Name).Update(\"status\", consts.ScheduledTaskStatusTerminating)\n\t\treturn tx.Error\n\t})\n\n\ttask, err := s.GetTaskOne(ctx, model.ScheduledTaskGetOneInput{\n\t\tName: in.Name,\n\t})\n\tif err != nil {\n\t\treturn\n\t}\n\n\toutSubTask, err := s.GetSubTaskList(ctx, model.ScheduledSubTaskGetListInput{\n\t\tName: in.Name,\n\t\tStatuses: []string{ // 只处理 running  pending 状态\n\t\t\tconsts.ScheduledTaskStatusRunning,\n\t\t\tconsts.ScheduledTaskStatusPending,\n\t\t},\n\t})\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 同一批任务属于一个平台\n\tproductService := product.GetServiceInstance()\n\tpf, err := productService.GetProductPlatformCached(task.Product, task.Region)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tfor _, subTask := range outSubTask.SubTaskSet {\n\t\tif subTask.TaskId == \"\" {\n\t\t\tcontinue\n\t\t}\n\n\t\tgo func(st entity.ScheduledSubTask) {\n\t\t\tentry.Infof(\"Terminating subtask: %d\", st.Id)\n\t\t\tif err := handlers.TaskApiServiceInstance(pf).TerminateTask(ctx, model.ScheduledSubTaskOperateInput{\n\t\t\t\tSubTaskId: st.Id,\n\t\t\t}); err != nil {\n\t\t\t\tmsg := fmt.Sprintf(\"TerminateTask Error : %s\", err.Error())\n\t\t\t\talarm.ReportAlarm(\"TerminateTask Error\", \"\", msg)\n\t\t\t}\n\t\t}(subTask)\n\n\t\ttime.Sleep(time.Microsecond * 50)\n\t}\n\n\treturn\n}",
    "sql_statement_list": [
      "UPDATE scheduled_task SET status = ? WHERE name = ?;"
    ],
    "sql_types": [
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 6,
        "code_end_line": 25,
        "code_key": "ScheduledTask",
        "code_value": "type ScheduledTask struct {\n\tId              uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tProduct         string     `db:\"column:product\" json:\"Product\" description:\"业务产品\"`\n\tBizSpec         string     `db:\"column:biz_spec\" json:\"BizSpec\" description:\"留给不同平台业务自行解释\"`\n\tRegion          string     `db:\"column:region\" json:\"Region\" description:\"业务所在区\"`\n\tName            string     `db:\"column:name\" json:\"Name\" description:\"任务名称(唯一自动生成)\"`\n\tType            string     `db:\"column:type\" json:\"Type\" description:\"任务类型(UpgradeImage)\"`\n\tParams          string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tBrief           string     `db:\"column:brief\" json:\"Brief\" description:\"任务描述\"`\n\tStatus          string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Terminating,Succeeded,Failed,Error)\"`\n\tBatchNum        uint       `db:\"column:batch_num\" json:\"BatchNum\" description:\"单批次并发限制\"`\n\tTotalSubTask    uint       `db:\"column:total_sub_task\" json:\"TotalSubTask\" description:\"子任务总数\"`\n\tErrorAbort      bool       `db:\"column:error_abort\" json:\"ErrorAbort\" description:\"是否报错中止\"`\n\tCreateTime      *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime      *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tCreator         string     `db:\"column:creator\" json:\"Creator\" description:\"创建者\"`\n\tTaskNameByInput string     `db:\"column:task_name_by_input\" json:\"TaskNameByInput\" description:\"用户输入的名字\"`\n\tZiYanURL        string     `db:\"column:zi_yan_url\" json:\"ZiYanURL\" description:\"自研审批链接\"`\n\tNotifyType      uint       `db:\"column:notify_type\" json:\"NotifyType\" description:\"任务通知类型\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 28,
        "code_end_line": 28,
        "code_key": "TableName",
        "code_value": "func (ScheduledTask) TableName() string { return \"scheduled_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 69,
        "code_end_line": 73,
        "code_key": "ScheduledTaskGetOneInput",
        "code_value": "type ScheduledTaskGetOneInput struct {\n\tProduct       string `dc:\"业务产品\"`\n\tName          string `dc:\"任务名称\"`\n\tProductRegion string `dc:\"区域\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 136,
        "code_end_line": 149,
        "code_key": "ScheduledSubTaskGetListInput",
        "code_value": "type ScheduledSubTaskGetListInput struct {\n\n\t// TODO 将下面的转换\n\tFilters []basic.Filter\n\n\tProduct        string   `dc:\"业务产品\"`\n\tProductRegion  string   `dc:\"区域\"`\n\tName           string   `dc:\"任务名称\"`\n\tStatuses       []string `dc:\"运行状态\"`\n\tInstanceId     string   `dc:\"模糊搜索:实例Id\"`\n\tOrderBy        string   `dc:\"排序字段\"`\n\tOrderDirection string   `dc:\"排序方式\"`\n\tCommonPaginationInput\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 30,
        "code_end_line": 42,
        "code_key": "ScheduledSubTask",
        "code_value": "type ScheduledSubTask struct {\n\tId         uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tName       string     `db:\"column:name\" json:\"Name\" description:\"任务名称\"`\n\tParams     string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tInstanceId string     `db:\"column:instance_id\" json:\"InstanceId\" description:\"实例Id\"`\n\tTaskId     string     `db:\"column:task_id\" json:\"TaskId\" description:\"Workflow子任务ID\"`\n\tBatchOrder uint64     `db:\"column:batch_order\" json:\"BatchOrder\" description:\"属于哪一个批次\"`\n\tRollback   string     `db:\"column:rollback\" json:\"RollBack\" description:\"任务回滚的参数\"`\n\tStatus     string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Suspending,Suspended,Terminating,Stopping,Succeeded,Failed,Error)\"`\n\tCreateTime *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tIsLock     uint       `db:\"column:is_lock\" json:\"IsLock\" description:\"是否锁定资源\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 45,
        "code_end_line": 45,
        "code_key": "TableName",
        "code_value": "func (ScheduledSubTask) TableName() string { return \"scheduled_sub_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 163,
        "code_end_line": 167,
        "code_key": "ScheduledSubTaskOperateInput",
        "code_value": "type ScheduledSubTaskOperateInput struct {\n\tName       string `dc:\"任务名称\"`\n\tSubTaskId  uint64 `dc:\"子任务Id\"`\n\tInstanceId string `dc:\"实例ID\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/qtty/model/kube_config.go",
        "code_start_line": 22,
        "code_end_line": 25,
        "code_key": "Context",
        "code_value": "type Context struct {\n\tName    string      `json:\"name\" yaml:\"name\"`\n\tContext ContextItem `json:\"context\" yaml:\"context\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 152,
        "code_end_line": 154,
        "code_key": "ScheduledTaskOperateInput",
        "code_value": "type ScheduledTaskOperateInput struct {\n\tName string `dc:\"任务名称\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/csig_tdmq__moss.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/task.go:366:418:TerminateTask",
    "orm_code": "func (s *sScheduledTask) TerminateTask(ctx *gin.Context, in model.ScheduledTaskOperateInput) (err error) {\n\n\tentry := glog.WithContext(ctx)\n\terr = s.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\ttx.Model(&entity.ScheduledTask{}).Where(\" name = ? \", in.Name).Update(\"status\", consts.ScheduledTaskStatusTerminating)\n\t\treturn tx.Error\n\t})\n\n\ttask, err := s.GetTaskOne(ctx, model.ScheduledTaskGetOneInput{\n\t\tName: in.Name,\n\t})\n\tif err != nil {\n\t\treturn\n\t}\n\n\toutSubTask, err := s.GetSubTaskList(ctx, model.ScheduledSubTaskGetListInput{\n\t\tName: in.Name,\n\t\tStatuses: []string{ // 只处理 running  pending 状态\n\t\t\tconsts.ScheduledTaskStatusRunning,\n\t\t\tconsts.ScheduledTaskStatusPending,\n\t\t},\n\t})\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 同一批任务属于一个平台\n\tproductService := product.GetServiceInstance()\n\tpf, err := productService.GetProductPlatformCached(task.Product, task.Region)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tfor _, subTask := range outSubTask.SubTaskSet {\n\t\tif subTask.TaskId == \"\" {\n\t\t\tcontinue\n\t\t}\n\n\t\tgo func(st entity.ScheduledSubTask) {\n\t\t\tentry.Infof(\"Terminating subtask: %d\", st.Id)\n\t\t\tif err := handlers.TaskApiServiceInstance(pf).TerminateTask(ctx, model.ScheduledSubTaskOperateInput{\n\t\t\t\tSubTaskId: st.Id,\n\t\t\t}); err != nil {\n\t\t\t\tmsg := fmt.Sprintf(\"TerminateTask Error : %s\", err.Error())\n\t\t\t\talarm.ReportAlarm(\"TerminateTask Error\", \"\", msg)\n\t\t\t}\n\t\t}(subTask)\n\n\t\ttime.Sleep(time.Microsecond * 50)\n\t}\n\n\treturn\n}",
    "caller": "func (s *TaskApiService) TerminateTask(ctx context.Context, in model.ScheduledSubTaskOperateInput) (err error) {\n\tif p, ok := HandleInstanceMap[GenPFKey(s.pf)]; ok {\n\t\treturn p.TerminateTask(ctx, in)\n\t}\n\treturn fmt.Errorf(\"no handler for platform %v\", s.pf.PlatformType)\n}",
    "sql_statement_list": [
      "UPDATE scheduled_task SET status = ? WHERE name = ?;"
    ],
    "sql_types": [
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 6,
        "code_end_line": 25,
        "code_key": "ScheduledTask",
        "code_value": "type ScheduledTask struct {\n\tId              uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tProduct         string     `db:\"column:product\" json:\"Product\" description:\"业务产品\"`\n\tBizSpec         string     `db:\"column:biz_spec\" json:\"BizSpec\" description:\"留给不同平台业务自行解释\"`\n\tRegion          string     `db:\"column:region\" json:\"Region\" description:\"业务所在区\"`\n\tName            string     `db:\"column:name\" json:\"Name\" description:\"任务名称(唯一自动生成)\"`\n\tType            string     `db:\"column:type\" json:\"Type\" description:\"任务类型(UpgradeImage)\"`\n\tParams          string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tBrief           string     `db:\"column:brief\" json:\"Brief\" description:\"任务描述\"`\n\tStatus          string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Terminating,Succeeded,Failed,Error)\"`\n\tBatchNum        uint       `db:\"column:batch_num\" json:\"BatchNum\" description:\"单批次并发限制\"`\n\tTotalSubTask    uint       `db:\"column:total_sub_task\" json:\"TotalSubTask\" description:\"子任务总数\"`\n\tErrorAbort      bool       `db:\"column:error_abort\" json:\"ErrorAbort\" description:\"是否报错中止\"`\n\tCreateTime      *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime      *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tCreator         string     `db:\"column:creator\" json:\"Creator\" description:\"创建者\"`\n\tTaskNameByInput string     `db:\"column:task_name_by_input\" json:\"TaskNameByInput\" description:\"用户输入的名字\"`\n\tZiYanURL        string     `db:\"column:zi_yan_url\" json:\"ZiYanURL\" description:\"自研审批链接\"`\n\tNotifyType      uint       `db:\"column:notify_type\" json:\"NotifyType\" description:\"任务通知类型\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 28,
        "code_end_line": 28,
        "code_key": "TableName",
        "code_value": "func (ScheduledTask) TableName() string { return \"scheduled_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 69,
        "code_end_line": 73,
        "code_key": "ScheduledTaskGetOneInput",
        "code_value": "type ScheduledTaskGetOneInput struct {\n\tProduct       string `dc:\"业务产品\"`\n\tName          string `dc:\"任务名称\"`\n\tProductRegion string `dc:\"区域\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 136,
        "code_end_line": 149,
        "code_key": "ScheduledSubTaskGetListInput",
        "code_value": "type ScheduledSubTaskGetListInput struct {\n\n\t// TODO 将下面的转换\n\tFilters []basic.Filter\n\n\tProduct        string   `dc:\"业务产品\"`\n\tProductRegion  string   `dc:\"区域\"`\n\tName           string   `dc:\"任务名称\"`\n\tStatuses       []string `dc:\"运行状态\"`\n\tInstanceId     string   `dc:\"模糊搜索:实例Id\"`\n\tOrderBy        string   `dc:\"排序字段\"`\n\tOrderDirection string   `dc:\"排序方式\"`\n\tCommonPaginationInput\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 30,
        "code_end_line": 42,
        "code_key": "ScheduledSubTask",
        "code_value": "type ScheduledSubTask struct {\n\tId         uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tName       string     `db:\"column:name\" json:\"Name\" description:\"任务名称\"`\n\tParams     string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tInstanceId string     `db:\"column:instance_id\" json:\"InstanceId\" description:\"实例Id\"`\n\tTaskId     string     `db:\"column:task_id\" json:\"TaskId\" description:\"Workflow子任务ID\"`\n\tBatchOrder uint64     `db:\"column:batch_order\" json:\"BatchOrder\" description:\"属于哪一个批次\"`\n\tRollback   string     `db:\"column:rollback\" json:\"RollBack\" description:\"任务回滚的参数\"`\n\tStatus     string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Suspending,Suspended,Terminating,Stopping,Succeeded,Failed,Error)\"`\n\tCreateTime *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tIsLock     uint       `db:\"column:is_lock\" json:\"IsLock\" description:\"是否锁定资源\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 45,
        "code_end_line": 45,
        "code_key": "TableName",
        "code_value": "func (ScheduledSubTask) TableName() string { return \"scheduled_sub_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 163,
        "code_end_line": 167,
        "code_key": "ScheduledSubTaskOperateInput",
        "code_value": "type ScheduledSubTaskOperateInput struct {\n\tName       string `dc:\"任务名称\"`\n\tSubTaskId  uint64 `dc:\"子任务Id\"`\n\tInstanceId string `dc:\"实例ID\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/qtty/model/kube_config.go",
        "code_start_line": 22,
        "code_end_line": 25,
        "code_key": "Context",
        "code_value": "type Context struct {\n\tName    string      `json:\"name\" yaml:\"name\"`\n\tContext ContextItem `json:\"context\" yaml:\"context\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 152,
        "code_end_line": 154,
        "code_key": "ScheduledTaskOperateInput",
        "code_value": "type ScheduledTaskOperateInput struct {\n\tName string `dc:\"任务名称\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/csig_tdmq__moss.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/task.go:366:418:TerminateTask",
    "orm_code": "func (s *sScheduledTask) TerminateTask(ctx *gin.Context, in model.ScheduledTaskOperateInput) (err error) {\n\n\tentry := glog.WithContext(ctx)\n\terr = s.db.Transaction(func(tx *gorm.DB) (err error) {\n\t\ttx.Model(&entity.ScheduledTask{}).Where(\" name = ? \", in.Name).Update(\"status\", consts.ScheduledTaskStatusTerminating)\n\t\treturn tx.Error\n\t})\n\n\ttask, err := s.GetTaskOne(ctx, model.ScheduledTaskGetOneInput{\n\t\tName: in.Name,\n\t})\n\tif err != nil {\n\t\treturn\n\t}\n\n\toutSubTask, err := s.GetSubTaskList(ctx, model.ScheduledSubTaskGetListInput{\n\t\tName: in.Name,\n\t\tStatuses: []string{ // 只处理 running  pending 状态\n\t\t\tconsts.ScheduledTaskStatusRunning,\n\t\t\tconsts.ScheduledTaskStatusPending,\n\t\t},\n\t})\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 同一批任务属于一个平台\n\tproductService := product.GetServiceInstance()\n\tpf, err := productService.GetProductPlatformCached(task.Product, task.Region)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tfor _, subTask := range outSubTask.SubTaskSet {\n\t\tif subTask.TaskId == \"\" {\n\t\t\tcontinue\n\t\t}\n\n\t\tgo func(st entity.ScheduledSubTask) {\n\t\t\tentry.Infof(\"Terminating subtask: %d\", st.Id)\n\t\t\tif err := handlers.TaskApiServiceInstance(pf).TerminateTask(ctx, model.ScheduledSubTaskOperateInput{\n\t\t\t\tSubTaskId: st.Id,\n\t\t\t}); err != nil {\n\t\t\t\tmsg := fmt.Sprintf(\"TerminateTask Error : %s\", err.Error())\n\t\t\t\talarm.ReportAlarm(\"TerminateTask Error\", \"\", msg)\n\t\t\t}\n\t\t}(subTask)\n\n\t\ttime.Sleep(time.Microsecond * 50)\n\t}\n\n\treturn\n}",
    "caller": "func (s *KhaosHandler) TerminateTask(ctx context.Context, in model.ScheduledSubTaskOperateInput) (err error) {\n\tvar subTask entity.ScheduledSubTask\n\torm := s.db.Model(&entity.ScheduledSubTask{}).Where(\"id=?\", in.SubTaskId).Find(&subTask)\n\tif orm.Error != nil {\n\t\treturn orm.Error\n\t}\n\n\tif subTask.Status == consts.WorkflowInstanceStatusTerminating {\n\t\tglog.Warnf(\"task %d is already terminating\", in.SubTaskId)\n\t\treturn\n\t}\n\n\tif subTask.TaskId == \"\" {\n\t\treturn fmt.Errorf(\"subtask %d taskId is empty, cannot be terminated\", in.SubTaskId)\n\t}\n\n\tpf, err := platform.GetPlatform(s.platform)\n\tif err != nil {\n\t\treturn\n\t}\n\n\ti, err := strconv.ParseInt(subTask.TaskId, 10, 64)\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 终止 workflow 任务\n\tglog.Infof(\"terminating khaos workflow %s\", in.Name)\n\tkhaosCli := pf.(*platform.KhaosPlatform).KhaosCli()\n\t_, err = khaosCli.OssService().Task().Terminate(ctx, &ossv1.TaskTerminateReq{\n\t\tId: uint64(i),\n\t})\n\tif err != nil {\n\t\t// 记录错误日志\n\t\treturn\n\t}\n\n\t// TODO: 单独抽象一个 updateSubtaskStatus 方法\n\tglog.Infof(\"update subtask %d status to %s in DB\", in.SubTaskId, consts.WorkflowInstanceStatusTerminating)\n\torm = s.db.Model(&entity.ScheduledSubTask{}).Where(\"id=?\", in.SubTaskId).\n\t\tUpdate(\"status\", consts.WorkflowInstanceStatusTerminating)\n\tif orm.Error != nil {\n\t\treturn orm.Error\n\t}\n\n\treturn\n}",
    "sql_statement_list": [
      "UPDATE scheduled_task SET status = ? WHERE name = ?;"
    ],
    "sql_types": [
      "UPDATE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 6,
        "code_end_line": 25,
        "code_key": "ScheduledTask",
        "code_value": "type ScheduledTask struct {\n\tId              uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tProduct         string     `db:\"column:product\" json:\"Product\" description:\"业务产品\"`\n\tBizSpec         string     `db:\"column:biz_spec\" json:\"BizSpec\" description:\"留给不同平台业务自行解释\"`\n\tRegion          string     `db:\"column:region\" json:\"Region\" description:\"业务所在区\"`\n\tName            string     `db:\"column:name\" json:\"Name\" description:\"任务名称(唯一自动生成)\"`\n\tType            string     `db:\"column:type\" json:\"Type\" description:\"任务类型(UpgradeImage)\"`\n\tParams          string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tBrief           string     `db:\"column:brief\" json:\"Brief\" description:\"任务描述\"`\n\tStatus          string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Terminating,Succeeded,Failed,Error)\"`\n\tBatchNum        uint       `db:\"column:batch_num\" json:\"BatchNum\" description:\"单批次并发限制\"`\n\tTotalSubTask    uint       `db:\"column:total_sub_task\" json:\"TotalSubTask\" description:\"子任务总数\"`\n\tErrorAbort      bool       `db:\"column:error_abort\" json:\"ErrorAbort\" description:\"是否报错中止\"`\n\tCreateTime      *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime      *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tCreator         string     `db:\"column:creator\" json:\"Creator\" description:\"创建者\"`\n\tTaskNameByInput string     `db:\"column:task_name_by_input\" json:\"TaskNameByInput\" description:\"用户输入的名字\"`\n\tZiYanURL        string     `db:\"column:zi_yan_url\" json:\"ZiYanURL\" description:\"自研审批链接\"`\n\tNotifyType      uint       `db:\"column:notify_type\" json:\"NotifyType\" description:\"任务通知类型\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 28,
        "code_end_line": 28,
        "code_key": "TableName",
        "code_value": "func (ScheduledTask) TableName() string { return \"scheduled_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 69,
        "code_end_line": 73,
        "code_key": "ScheduledTaskGetOneInput",
        "code_value": "type ScheduledTaskGetOneInput struct {\n\tProduct       string `dc:\"业务产品\"`\n\tName          string `dc:\"任务名称\"`\n\tProductRegion string `dc:\"区域\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 136,
        "code_end_line": 149,
        "code_key": "ScheduledSubTaskGetListInput",
        "code_value": "type ScheduledSubTaskGetListInput struct {\n\n\t// TODO 将下面的转换\n\tFilters []basic.Filter\n\n\tProduct        string   `dc:\"业务产品\"`\n\tProductRegion  string   `dc:\"区域\"`\n\tName           string   `dc:\"任务名称\"`\n\tStatuses       []string `dc:\"运行状态\"`\n\tInstanceId     string   `dc:\"模糊搜索:实例Id\"`\n\tOrderBy        string   `dc:\"排序字段\"`\n\tOrderDirection string   `dc:\"排序方式\"`\n\tCommonPaginationInput\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 30,
        "code_end_line": 42,
        "code_key": "ScheduledSubTask",
        "code_value": "type ScheduledSubTask struct {\n\tId         uint64     `db:\"column:id;primaryKey\" json:\"Id\" description:\"主键\"`\n\tName       string     `db:\"column:name\" json:\"Name\" description:\"任务名称\"`\n\tParams     string     `db:\"column:params\" json:\"Params\" description:\"任务参数，不同的任务类型参数格式不同\"`\n\tInstanceId string     `db:\"column:instance_id\" json:\"InstanceId\" description:\"实例Id\"`\n\tTaskId     string     `db:\"column:task_id\" json:\"TaskId\" description:\"Workflow子任务ID\"`\n\tBatchOrder uint64     `db:\"column:batch_order\" json:\"BatchOrder\" description:\"属于哪一个批次\"`\n\tRollback   string     `db:\"column:rollback\" json:\"RollBack\" description:\"任务回滚的参数\"`\n\tStatus     string     `db:\"column:status\" json:\"Status\" description:\"运行状态(Pending,Running,Suspending,Suspended,Terminating,Stopping,Succeeded,Failed,Error)\"`\n\tCreateTime *time.Time `db:\"column:create_time\" json:\"CreateTime\" description:\"创建时间\"`\n\tUpdateTime *time.Time `db:\"column:update_time\" json:\"UpdateTime\" description:\"更新时间\"`\n\tIsLock     uint       `db:\"column:is_lock\" json:\"IsLock\" description:\"是否锁定资源\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/dao/models/task.go",
        "code_start_line": 45,
        "code_end_line": 45,
        "code_key": "TableName",
        "code_value": "func (ScheduledSubTask) TableName() string { return \"scheduled_sub_task\" }",
        "code_label": null,
        "code_type": 2,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 163,
        "code_end_line": 167,
        "code_key": "ScheduledSubTaskOperateInput",
        "code_value": "type ScheduledSubTaskOperateInput struct {\n\tName       string `dc:\"任务名称\"`\n\tSubTaskId  uint64 `dc:\"子任务Id\"`\n\tInstanceId string `dc:\"实例ID\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/qtty/model/kube_config.go",
        "code_start_line": 22,
        "code_end_line": 25,
        "code_key": "Context",
        "code_value": "type Context struct {\n\tName    string      `json:\"name\" yaml:\"name\"`\n\tContext ContextItem `json:\"context\" yaml:\"context\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/csig_tdmq__moss/internal/services/task/model/task.go",
        "code_start_line": 152,
        "code_end_line": 154,
        "code_key": "ScheduledTaskOperateInput",
        "code_value": "type ScheduledTaskOperateInput struct {\n\tName string `dc:\"任务名称\"`\n}",
        "code_label": null,
        "code_type": 3,
        "code_version": "75a9d9ab349bd9000c94e24f9467d229dedfd471"
      }
    ],
    "sql_pattern_cnt": 2,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/csig_tdmq__moss.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/instancecache/export.go:381:436:DeleteInstance",
    "orm_code": "func DeleteInstance(ctx context.Context, insID string) error {\n\tctx = context.WithoutCancel(ctx)\n\tstartTime := time.Now()\n\tretCode := 200\n\tvar err error\n\tdefer func() {\n\t\tif err != nil && !errors.Is(err, gorm.ErrRecordNotFound) {\n\t\t\tretCode = 500\n\t\t}\n\t\tlog.TraceReport(\"\", startTime, constants.MySQL, l.dbAddr, constants.ActionDBDelete, retCode)\n\t}()\n\n\tinsIDUpdate := fmt.Sprintf(\"%s = ?\", keyInsID)\n\tlog.G(ctx).Infof(\"DeleteInstance:%s,%s\", insIDUpdate, insID)\n\n\t// Use transaction to ensure atomicity\n\terr = l.DB().Transaction(func(tx *gorm.DB) error {\n\t\t// Delete instance info\n\t\tdb := tx.Table(constants.InstanceInfoTableName).Where(insIDUpdate, insID)\n\t\tvar deleteErr error\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tif config.GetConfig().Common.DisableHardDelete {\n\t\t\t\t// Soft delete (permanent delete will be handled by reconciliation)\n\t\t\t\tdeleteErr = db.Delete(&models.InstanceInfo{}).Error\n\t\t\t} else {\n\t\t\t\t// Hard delete\n\t\t\t\tdeleteErr = db.Unscoped().Delete(&models.InstanceInfo{}).Error\n\t\t\t}\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\n\t\t// Delete user data\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tdeleteErr = tx.Table(constants.InstanceUserDataTableName).Where(insIDUpdate, insID).\n\t\t\t\tDelete(&models.InstanceUserData{}).Error\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\t\treturn deleteErr\n\t})\n\n\treturn err\n}",
    "caller": "",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "软删除模式 - InstanceInfo表",
            "sql": "UPDATE `instance_info_table` SET `deleted_at`=? WHERE ins_id = ? AND `instance_info_table`.`deleted_at` IS NULL;"
          },
          {
            "scenario": "硬删除模式 - InstanceInfo表",
            "sql": "DELETE FROM `instance_info_table` WHERE ins_id = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "软删除模式 - InstanceUserData表",
            "sql": "UPDATE `instance_user_data_table` SET `deleted_at`=? WHERE ins_id = ? AND `instance_user_data_table`.`deleted_at` IS NULL;"
          },
          {
            "scenario": "硬删除模式 - InstanceUserData表",
            "sql": "DELETE FROM `instance_user_data_table` WHERE ins_id = ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 57,
        "code_end_line": 86,
        "code_key": "InstanceInfo",
        "code_value": "type InstanceInfo struct {\n\tgorm.Model\n\tAppID         int    `json:\"AppID\" gorm:\"column:app_id\"`\n\tUin           string `json:\"Uin\" gorm:\"column:uin\"`\n\tSubAccountUin string `json:\"SubAccountUin\" gorm:\"column:subaccount_uin\"`\n\tInsID         string `json:\"InstanceID\" gorm:\"column:ins_id\"` //cube InstanceID eks_xxx\n\tUUID          string `json:\"Uuid\" gorm:\"column:uuid\"`         //cube SandboxID\n\tHostIP        string `json:\"HostIP\" gorm:\"column:host_ip\"`    //裸金属IP\n\tHostID        string `json:\"HostId\" gorm:\"column:host_id\"`\n\tInstanceState string `json:\"InstanceState\" gorm:\"column:ins_state\"`\n\n\tCPU     int64  `json:\"Cpu\" gorm:\"column:cpu\"`          //核*100\n\tMem     int64  `json:\"Mem\" gorm:\"column:mem\"`          //Mi\n\tCPUType string `json:\"CpuType\" gorm:\"column:cpu_type\"` //机型架构\n\tZone    string `json:\"Zone\" gorm:\"column:zone\"`\n\tRegion  string `json:\"Region\" gorm:\"column:region\"`\n\n\tImageID            string `json:\"ImageID\" gorm:\"column:image_id\"`\n\tSystemDisk         string `json:\"SystemDisk\" gorm:\"column:system_disk\"`                  //object ref:SystemDisk\n\tDataDisks          string `json:\"DataDisks\" gorm:\"column:data_disks\"`                    //array object ref:DataDisk\n\tPrivateIPAddresses string `json:\"PrivateIpAddresses\" gorm:\"column:private_ip_addresses\"` //数组\n\tPrivateIP          string `json:\"PrivateIp\" gorm:\"column:private_ip\"`\n\tPrirvateIPCnt      int64  `json:\"PrivateIpCnt\" gorm:\"column:private_ip_cnt\"`\n\tSecurityGroupIDS   string `json:\"SecurityGroupIds\" gorm:\"column:security_ids\"` //数组\n\tVpcID              string `json:\"VpcId\" gorm:\"column:vpc_id\"`\n\tMacAddress         string `json:\"MacAddress\" gorm:\"column:mac_address\"`\n\tSubnetID           string `json:\"SubnetId\" gorm:\"column:subnet_id\"`\n\tDiskState          string `json:\"DiskState\" gorm:\"column:disk_state\"`\n\tFailMsg            string `json:\"FailMsg\" gorm:\"column:fail_msg\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 89,
        "code_end_line": 91,
        "code_key": "TableName",
        "code_value": "func (InstanceInfo) TableName() string {\n\treturn constants.InstanceInfoTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 94,
        "code_end_line": 98,
        "code_key": "InstanceUserData",
        "code_value": "type InstanceUserData struct {\n\tgorm.Model\n\tInsID    string `json:\"InsID\" gorm:\"column:ins_id\"`\n\tUserData string `json:\"UserData\" gorm:\"column:user_data\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 101,
        "code_end_line": 103,
        "code_key": "TableName",
        "code_value": "func (InstanceUserData) TableName() string {\n\treturn constants.InstanceUserDataTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/cube-proj__CubeMaster.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/instancecache/export.go:381:436:DeleteInstance",
    "orm_code": "func DeleteInstance(ctx context.Context, insID string) error {\n\tctx = context.WithoutCancel(ctx)\n\tstartTime := time.Now()\n\tretCode := 200\n\tvar err error\n\tdefer func() {\n\t\tif err != nil && !errors.Is(err, gorm.ErrRecordNotFound) {\n\t\t\tretCode = 500\n\t\t}\n\t\tlog.TraceReport(\"\", startTime, constants.MySQL, l.dbAddr, constants.ActionDBDelete, retCode)\n\t}()\n\n\tinsIDUpdate := fmt.Sprintf(\"%s = ?\", keyInsID)\n\tlog.G(ctx).Infof(\"DeleteInstance:%s,%s\", insIDUpdate, insID)\n\n\t// Use transaction to ensure atomicity\n\terr = l.DB().Transaction(func(tx *gorm.DB) error {\n\t\t// Delete instance info\n\t\tdb := tx.Table(constants.InstanceInfoTableName).Where(insIDUpdate, insID)\n\t\tvar deleteErr error\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tif config.GetConfig().Common.DisableHardDelete {\n\t\t\t\t// Soft delete (permanent delete will be handled by reconciliation)\n\t\t\t\tdeleteErr = db.Delete(&models.InstanceInfo{}).Error\n\t\t\t} else {\n\t\t\t\t// Hard delete\n\t\t\t\tdeleteErr = db.Unscoped().Delete(&models.InstanceInfo{}).Error\n\t\t\t}\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\n\t\t// Delete user data\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tdeleteErr = tx.Table(constants.InstanceUserDataTableName).Where(insIDUpdate, insID).\n\t\t\t\tDelete(&models.InstanceUserData{}).Error\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\t\treturn deleteErr\n\t})\n\n\treturn err\n}",
    "caller": "func (h *DestroySandboxTaskHandler) HandleTask(ctx context.Context, t *Task) error {\n\treq, ok := t.Request.(*cubebox.DestroyCubeSandboxRequest)\n\tif !ok {\n\t\treturn nil\n\t}\n\n\trsp, err := cubelet.Destroy(ctx, t.CallEp, req)\n\tdefer func() {\n\t\tif log.IsDebug() {\n\t\t\tlog.G(ctx).Debugf(\"Destroy_rsp:%+v\", utils.InterfaceToString(rsp))\n\t\t}\n\t}()\n\n\tif err != nil {\n\t\tlog.G(ctx).Errorf(\"Destroy fail:%+v\", err)\n\t\t//借用这个来loop重试\n\t\treturn ret.Errorf(errorcode.ErrorCode_MasterRateLimitedError, err.Error())\n\t}\n\tif rsp.GetRet().GetRetCode() != cubeleterrorcode.ErrorCode_Success &&\n\t\trsp.GetRet().GetRetCode() != cubeleterrorcode.ErrorCode_OK {\n\t\tlog.G(ctx).Errorf(\"Destroy error:%+v\", rsp)\n\t\treturn ret.Errorf(errorcode.MasterCode(rsp.GetRet().GetRetCode()), rsp.GetRet().GetRetMsg())\n\t}\n\n\tif t.InsType() == cubebox.InstanceType_scf.String() {\n\t\terr := localcache.DeleteSandboxProxyMap(ctx, req.SandboxID)\n\t\tif err != nil {\n\t\t\t//借用这个来loop重试\n\t\t\tlog.G(ctx).Errorf(\"DeleteSandboxProxyMap:%+v\", err)\n\t\t\treturn ret.Errorf(errorcode.ErrorCode_MasterRateLimitedError, \"DeleteSandboxProxyMap failed: %s\", err.Error())\n\t\t}\n\t}\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 57,
        "code_end_line": 86,
        "code_key": "InstanceInfo",
        "code_value": "type InstanceInfo struct {\n\tgorm.Model\n\tAppID         int    `json:\"AppID\" gorm:\"column:app_id\"`\n\tUin           string `json:\"Uin\" gorm:\"column:uin\"`\n\tSubAccountUin string `json:\"SubAccountUin\" gorm:\"column:subaccount_uin\"`\n\tInsID         string `json:\"InstanceID\" gorm:\"column:ins_id\"` //cube InstanceID eks_xxx\n\tUUID          string `json:\"Uuid\" gorm:\"column:uuid\"`         //cube SandboxID\n\tHostIP        string `json:\"HostIP\" gorm:\"column:host_ip\"`    //裸金属IP\n\tHostID        string `json:\"HostId\" gorm:\"column:host_id\"`\n\tInstanceState string `json:\"InstanceState\" gorm:\"column:ins_state\"`\n\n\tCPU     int64  `json:\"Cpu\" gorm:\"column:cpu\"`          //核*100\n\tMem     int64  `json:\"Mem\" gorm:\"column:mem\"`          //Mi\n\tCPUType string `json:\"CpuType\" gorm:\"column:cpu_type\"` //机型架构\n\tZone    string `json:\"Zone\" gorm:\"column:zone\"`\n\tRegion  string `json:\"Region\" gorm:\"column:region\"`\n\n\tImageID            string `json:\"ImageID\" gorm:\"column:image_id\"`\n\tSystemDisk         string `json:\"SystemDisk\" gorm:\"column:system_disk\"`                  //object ref:SystemDisk\n\tDataDisks          string `json:\"DataDisks\" gorm:\"column:data_disks\"`                    //array object ref:DataDisk\n\tPrivateIPAddresses string `json:\"PrivateIpAddresses\" gorm:\"column:private_ip_addresses\"` //数组\n\tPrivateIP          string `json:\"PrivateIp\" gorm:\"column:private_ip\"`\n\tPrirvateIPCnt      int64  `json:\"PrivateIpCnt\" gorm:\"column:private_ip_cnt\"`\n\tSecurityGroupIDS   string `json:\"SecurityGroupIds\" gorm:\"column:security_ids\"` //数组\n\tVpcID              string `json:\"VpcId\" gorm:\"column:vpc_id\"`\n\tMacAddress         string `json:\"MacAddress\" gorm:\"column:mac_address\"`\n\tSubnetID           string `json:\"SubnetId\" gorm:\"column:subnet_id\"`\n\tDiskState          string `json:\"DiskState\" gorm:\"column:disk_state\"`\n\tFailMsg            string `json:\"FailMsg\" gorm:\"column:fail_msg\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 89,
        "code_end_line": 91,
        "code_key": "TableName",
        "code_value": "func (InstanceInfo) TableName() string {\n\treturn constants.InstanceInfoTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 94,
        "code_end_line": 98,
        "code_key": "InstanceUserData",
        "code_value": "type InstanceUserData struct {\n\tgorm.Model\n\tInsID    string `json:\"InsID\" gorm:\"column:ins_id\"`\n\tUserData string `json:\"UserData\" gorm:\"column:user_data\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 101,
        "code_end_line": 103,
        "code_key": "TableName",
        "code_value": "func (InstanceUserData) TableName() string {\n\treturn constants.InstanceUserDataTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/cube-proj__CubeMaster.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/instancecache/export.go:381:436:DeleteInstance",
    "orm_code": "func DeleteInstance(ctx context.Context, insID string) error {\n\tctx = context.WithoutCancel(ctx)\n\tstartTime := time.Now()\n\tretCode := 200\n\tvar err error\n\tdefer func() {\n\t\tif err != nil && !errors.Is(err, gorm.ErrRecordNotFound) {\n\t\t\tretCode = 500\n\t\t}\n\t\tlog.TraceReport(\"\", startTime, constants.MySQL, l.dbAddr, constants.ActionDBDelete, retCode)\n\t}()\n\n\tinsIDUpdate := fmt.Sprintf(\"%s = ?\", keyInsID)\n\tlog.G(ctx).Infof(\"DeleteInstance:%s,%s\", insIDUpdate, insID)\n\n\t// Use transaction to ensure atomicity\n\terr = l.DB().Transaction(func(tx *gorm.DB) error {\n\t\t// Delete instance info\n\t\tdb := tx.Table(constants.InstanceInfoTableName).Where(insIDUpdate, insID)\n\t\tvar deleteErr error\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tif config.GetConfig().Common.DisableHardDelete {\n\t\t\t\t// Soft delete (permanent delete will be handled by reconciliation)\n\t\t\t\tdeleteErr = db.Delete(&models.InstanceInfo{}).Error\n\t\t\t} else {\n\t\t\t\t// Hard delete\n\t\t\t\tdeleteErr = db.Unscoped().Delete(&models.InstanceInfo{}).Error\n\t\t\t}\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\n\t\t// Delete user data\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tdeleteErr = tx.Table(constants.InstanceUserDataTableName).Where(insIDUpdate, insID).\n\t\t\t\tDelete(&models.InstanceUserData{}).Error\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\t\treturn deleteErr\n\t})\n\n\treturn err\n}",
    "caller": "func (h *NotifyRunInstancesTaskHandler) HandleTask(ctx context.Context, t *Task) error {\n\treq, ok := t.Request.(*yunapitypes.RunInstancesRequest)\n\tif !ok {\n\t\treturn nil\n\t}\n\tresult, ok := t.RunInstancesResult.(*types.CreateCubeSandboxRes)\n\tif !ok {\n\t\tlog.G(ctx).Fatalf(\"NotifyRunInstancesTaskHandler,invalid RunInstancesResult:%s\",\n\t\t\tutils.InterfaceToString(t.RunInstancesResult))\n\t\treturn nil\n\t}\n\n\tlog.G(ctx).Infof(\"NotifyRunInstancesTaskHandler:%s,result:%v\", utils.InterfaceToString(req.CommonRequest),\n\t\tutils.InterfaceToString(result))\n\tif err := eks.NotifyRunInstance(ctx, req, result); err != nil {\n\t\tlog.G(ctx).Errorf(\"NotifyRunInstancesTaskHandler [%s] fail:%s\", req.InstanceIDS[0], err)\n\t\treturn ret.Errorf(errorcode.ErrorCode_MasterRateLimitedError, \"NotifyRunInstance failed: %s\", err.Error())\n\t}\n\t//set callback flag\n\tinsID := req.InstanceIDS[0]\n\tif result.Ret.RetCode != int(errorcode.ErrorCode_Success) {\n\t\terr := localcache.SetInstanceInfoField(ctx, insID, \"running_callback_flag\",\n\t\t\t\"true\", \"running_fail_msg\", result.Ret.RetMsg)\n\t\tif err != nil {\n\t\t\tlog.G(ctx).Fatalf(\"SetInstanceInfoField:%+v\", err)\n\t\t}\n\t} else {\n\t\tlocalcache.SetInstanceInfoField(ctx, insID, \"running_callback_flag\", \"true\")\n\t}\n\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 57,
        "code_end_line": 86,
        "code_key": "InstanceInfo",
        "code_value": "type InstanceInfo struct {\n\tgorm.Model\n\tAppID         int    `json:\"AppID\" gorm:\"column:app_id\"`\n\tUin           string `json:\"Uin\" gorm:\"column:uin\"`\n\tSubAccountUin string `json:\"SubAccountUin\" gorm:\"column:subaccount_uin\"`\n\tInsID         string `json:\"InstanceID\" gorm:\"column:ins_id\"` //cube InstanceID eks_xxx\n\tUUID          string `json:\"Uuid\" gorm:\"column:uuid\"`         //cube SandboxID\n\tHostIP        string `json:\"HostIP\" gorm:\"column:host_ip\"`    //裸金属IP\n\tHostID        string `json:\"HostId\" gorm:\"column:host_id\"`\n\tInstanceState string `json:\"InstanceState\" gorm:\"column:ins_state\"`\n\n\tCPU     int64  `json:\"Cpu\" gorm:\"column:cpu\"`          //核*100\n\tMem     int64  `json:\"Mem\" gorm:\"column:mem\"`          //Mi\n\tCPUType string `json:\"CpuType\" gorm:\"column:cpu_type\"` //机型架构\n\tZone    string `json:\"Zone\" gorm:\"column:zone\"`\n\tRegion  string `json:\"Region\" gorm:\"column:region\"`\n\n\tImageID            string `json:\"ImageID\" gorm:\"column:image_id\"`\n\tSystemDisk         string `json:\"SystemDisk\" gorm:\"column:system_disk\"`                  //object ref:SystemDisk\n\tDataDisks          string `json:\"DataDisks\" gorm:\"column:data_disks\"`                    //array object ref:DataDisk\n\tPrivateIPAddresses string `json:\"PrivateIpAddresses\" gorm:\"column:private_ip_addresses\"` //数组\n\tPrivateIP          string `json:\"PrivateIp\" gorm:\"column:private_ip\"`\n\tPrirvateIPCnt      int64  `json:\"PrivateIpCnt\" gorm:\"column:private_ip_cnt\"`\n\tSecurityGroupIDS   string `json:\"SecurityGroupIds\" gorm:\"column:security_ids\"` //数组\n\tVpcID              string `json:\"VpcId\" gorm:\"column:vpc_id\"`\n\tMacAddress         string `json:\"MacAddress\" gorm:\"column:mac_address\"`\n\tSubnetID           string `json:\"SubnetId\" gorm:\"column:subnet_id\"`\n\tDiskState          string `json:\"DiskState\" gorm:\"column:disk_state\"`\n\tFailMsg            string `json:\"FailMsg\" gorm:\"column:fail_msg\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 89,
        "code_end_line": 91,
        "code_key": "TableName",
        "code_value": "func (InstanceInfo) TableName() string {\n\treturn constants.InstanceInfoTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 94,
        "code_end_line": 98,
        "code_key": "InstanceUserData",
        "code_value": "type InstanceUserData struct {\n\tgorm.Model\n\tInsID    string `json:\"InsID\" gorm:\"column:ins_id\"`\n\tUserData string `json:\"UserData\" gorm:\"column:user_data\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 101,
        "code_end_line": 103,
        "code_key": "TableName",
        "code_value": "func (InstanceUserData) TableName() string {\n\treturn constants.InstanceUserDataTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/cube-proj__CubeMaster.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/instancecache/export.go:381:436:DeleteInstance",
    "orm_code": "func DeleteInstance(ctx context.Context, insID string) error {\n\tctx = context.WithoutCancel(ctx)\n\tstartTime := time.Now()\n\tretCode := 200\n\tvar err error\n\tdefer func() {\n\t\tif err != nil && !errors.Is(err, gorm.ErrRecordNotFound) {\n\t\t\tretCode = 500\n\t\t}\n\t\tlog.TraceReport(\"\", startTime, constants.MySQL, l.dbAddr, constants.ActionDBDelete, retCode)\n\t}()\n\n\tinsIDUpdate := fmt.Sprintf(\"%s = ?\", keyInsID)\n\tlog.G(ctx).Infof(\"DeleteInstance:%s,%s\", insIDUpdate, insID)\n\n\t// Use transaction to ensure atomicity\n\terr = l.DB().Transaction(func(tx *gorm.DB) error {\n\t\t// Delete instance info\n\t\tdb := tx.Table(constants.InstanceInfoTableName).Where(insIDUpdate, insID)\n\t\tvar deleteErr error\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tif config.GetConfig().Common.DisableHardDelete {\n\t\t\t\t// Soft delete (permanent delete will be handled by reconciliation)\n\t\t\t\tdeleteErr = db.Delete(&models.InstanceInfo{}).Error\n\t\t\t} else {\n\t\t\t\t// Hard delete\n\t\t\t\tdeleteErr = db.Unscoped().Delete(&models.InstanceInfo{}).Error\n\t\t\t}\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\n\t\t// Delete user data\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tdeleteErr = tx.Table(constants.InstanceUserDataTableName).Where(insIDUpdate, insID).\n\t\t\t\tDelete(&models.InstanceUserData{}).Error\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\t\treturn deleteErr\n\t})\n\n\treturn err\n}",
    "caller": "func (h *NotifyTerminateInstanceTaskHandler) HandleTask(ctx context.Context, t *Task) (err error) {\n\treq, ok := t.Request.(*yunapitypes.TerminateInstancesRequest)\n\tif !ok {\n\t\treturn nil\n\t}\n\tinsID := req.InstanceIDS[0]\n\tlog.G(ctx).Infof(\"NotifyTerminateInstanceTaskHandler:%+v\", utils.InterfaceToString(req))\n\t//1.check cubelet destroy result\n\tif t.TerminateInstanceResult != nil {\n\t\t//destroysandbox fail\n\t\tif err := eks.NotifyDelInstance(ctx, req, t.TerminateInstanceResult.(error)); err != nil {\n\t\t\tlog.G(ctx).Errorf(\"NotifyDelInstance [%s] fail:%s\", insID, err)\n\t\t\treturn ret.Errorf(errorcode.ErrorCode_MasterRateLimitedError, \"NotifyDelInstance failed: %s\", err.Error())\n\t\t}\n\t\treturn\n\t}\n\t//2. update instance status to TERMINATED\n\tif err := instancecache.UpdateInstanceStatus(ctx, insID, constants.YUNAPIInstanceStateTerminated); err != nil {\n\t\tlog.G(ctx).Errorf(\"update [%s] instance state fail:%s\", insID, err)\n\t\treturn ret.Errorf(errorcode.ErrorCode_MasterRateLimitedError, \"UpdateInstanceStatus failed: %s\", err.Error())\n\t}\n\n\t//3. callback to eks\n\tif err := eks.NotifyDelInstance(ctx, req, nil); err != nil {\n\t\tlog.G(ctx).Errorf(\"NotifyDelInstance [%s] fail:%s\", insID, err)\n\t\tif er := instancecache.UpdateInstanceStatus(ctx, insID, constants.YUNAPIInstanceStateTerminating); er != nil {\n\t\t\tlog.G(ctx).Errorf(\"UpdateInstanceStatus [%s] fail:%s\", insID, er)\n\t\t}\n\t\treturn ret.Errorf(errorcode.ErrorCode_MasterRateLimitedError, \"NotifyDelInstance failed: %s\", err.Error())\n\t}\n\n\t//3. if succ,delete db record (对账巡检直到通知成功再删除)\n\tif err := instancecache.DeleteInstance(ctx, insID); err != nil {\n\t\tlog.G(ctx).Errorf(\"DeleteInstance [%s] from db fail:%s\", insID, err)\n\t\treturn ret.Errorf(errorcode.ErrorCode_MasterRateLimitedError, \"DeleteInstance failed: %s\", err.Error())\n\t}\n\n\tif err := localcache.DeleteInstanceInfoMap(ctx, insID); err != nil {\n\t\t//借用这个来loop重试\n\t\tlog.G(ctx).Errorf(\"DeleteInstanceInfoMap:%+v\", err)\n\t\treturn ret.Errorf(errorcode.ErrorCode_MasterRateLimitedError, \"DeleteInstanceInfoMap failed: %s\", err.Error())\n\t}\n\treturn nil\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "软删除模式 (DisableHardDelete = true) - 删除实例信息",
            "sql": "UPDATE instance_info SET deleted_at = ? WHERE ins_id = ? AND deleted_at IS NULL;"
          },
          {
            "scenario": "硬删除模式 (DisableHardDelete = false) - 删除实例信息",
            "sql": "DELETE FROM instance_info WHERE ins_id = ?;"
          }
        ]
      },
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "软删除模式 (DisableHardDelete = true) - 删除用户数据",
            "sql": "UPDATE instance_user_data SET deleted_at = ? WHERE ins_id = ? AND deleted_at IS NULL;"
          },
          {
            "scenario": "硬删除模式 (DisableHardDelete = false) - 删除用户数据",
            "sql": "DELETE FROM instance_user_data WHERE ins_id = ?;"
          }
        ]
      }
    ],
    "sql_types": [
      "PARAM_DEPENDENT",
      "PARAM_DEPENDENT"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 57,
        "code_end_line": 86,
        "code_key": "InstanceInfo",
        "code_value": "type InstanceInfo struct {\n\tgorm.Model\n\tAppID         int    `json:\"AppID\" gorm:\"column:app_id\"`\n\tUin           string `json:\"Uin\" gorm:\"column:uin\"`\n\tSubAccountUin string `json:\"SubAccountUin\" gorm:\"column:subaccount_uin\"`\n\tInsID         string `json:\"InstanceID\" gorm:\"column:ins_id\"` //cube InstanceID eks_xxx\n\tUUID          string `json:\"Uuid\" gorm:\"column:uuid\"`         //cube SandboxID\n\tHostIP        string `json:\"HostIP\" gorm:\"column:host_ip\"`    //裸金属IP\n\tHostID        string `json:\"HostId\" gorm:\"column:host_id\"`\n\tInstanceState string `json:\"InstanceState\" gorm:\"column:ins_state\"`\n\n\tCPU     int64  `json:\"Cpu\" gorm:\"column:cpu\"`          //核*100\n\tMem     int64  `json:\"Mem\" gorm:\"column:mem\"`          //Mi\n\tCPUType string `json:\"CpuType\" gorm:\"column:cpu_type\"` //机型架构\n\tZone    string `json:\"Zone\" gorm:\"column:zone\"`\n\tRegion  string `json:\"Region\" gorm:\"column:region\"`\n\n\tImageID            string `json:\"ImageID\" gorm:\"column:image_id\"`\n\tSystemDisk         string `json:\"SystemDisk\" gorm:\"column:system_disk\"`                  //object ref:SystemDisk\n\tDataDisks          string `json:\"DataDisks\" gorm:\"column:data_disks\"`                    //array object ref:DataDisk\n\tPrivateIPAddresses string `json:\"PrivateIpAddresses\" gorm:\"column:private_ip_addresses\"` //数组\n\tPrivateIP          string `json:\"PrivateIp\" gorm:\"column:private_ip\"`\n\tPrirvateIPCnt      int64  `json:\"PrivateIpCnt\" gorm:\"column:private_ip_cnt\"`\n\tSecurityGroupIDS   string `json:\"SecurityGroupIds\" gorm:\"column:security_ids\"` //数组\n\tVpcID              string `json:\"VpcId\" gorm:\"column:vpc_id\"`\n\tMacAddress         string `json:\"MacAddress\" gorm:\"column:mac_address\"`\n\tSubnetID           string `json:\"SubnetId\" gorm:\"column:subnet_id\"`\n\tDiskState          string `json:\"DiskState\" gorm:\"column:disk_state\"`\n\tFailMsg            string `json:\"FailMsg\" gorm:\"column:fail_msg\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 89,
        "code_end_line": 91,
        "code_key": "TableName",
        "code_value": "func (InstanceInfo) TableName() string {\n\treturn constants.InstanceInfoTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 94,
        "code_end_line": 98,
        "code_key": "InstanceUserData",
        "code_value": "type InstanceUserData struct {\n\tgorm.Model\n\tInsID    string `json:\"InsID\" gorm:\"column:ins_id\"`\n\tUserData string `json:\"UserData\" gorm:\"column:user_data\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 101,
        "code_end_line": 103,
        "code_key": "TableName",
        "code_value": "func (InstanceUserData) TableName() string {\n\treturn constants.InstanceUserDataTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/cube-proj__CubeMaster.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/instancecache/export.go:381:436:DeleteInstance",
    "orm_code": "func DeleteInstance(ctx context.Context, insID string) error {\n\tctx = context.WithoutCancel(ctx)\n\tstartTime := time.Now()\n\tretCode := 200\n\tvar err error\n\tdefer func() {\n\t\tif err != nil && !errors.Is(err, gorm.ErrRecordNotFound) {\n\t\t\tretCode = 500\n\t\t}\n\t\tlog.TraceReport(\"\", startTime, constants.MySQL, l.dbAddr, constants.ActionDBDelete, retCode)\n\t}()\n\n\tinsIDUpdate := fmt.Sprintf(\"%s = ?\", keyInsID)\n\tlog.G(ctx).Infof(\"DeleteInstance:%s,%s\", insIDUpdate, insID)\n\n\t// Use transaction to ensure atomicity\n\terr = l.DB().Transaction(func(tx *gorm.DB) error {\n\t\t// Delete instance info\n\t\tdb := tx.Table(constants.InstanceInfoTableName).Where(insIDUpdate, insID)\n\t\tvar deleteErr error\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tif config.GetConfig().Common.DisableHardDelete {\n\t\t\t\t// Soft delete (permanent delete will be handled by reconciliation)\n\t\t\t\tdeleteErr = db.Delete(&models.InstanceInfo{}).Error\n\t\t\t} else {\n\t\t\t\t// Hard delete\n\t\t\t\tdeleteErr = db.Unscoped().Delete(&models.InstanceInfo{}).Error\n\t\t\t}\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\n\t\t// Delete user data\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tdeleteErr = tx.Table(constants.InstanceUserDataTableName).Where(insIDUpdate, insID).\n\t\t\t\tDelete(&models.InstanceUserData{}).Error\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\t\treturn deleteErr\n\t})\n\n\treturn err\n}",
    "caller": "func (h *CreateVolumeTaskHandler) HandleTask(ctx context.Context, t *Task) error {\n\treq, ok := t.Request.(*images.CreateVolumeRequest)\n\tif !ok {\n\t\treturn nil\n\t}\n\trsp, err := cubelet.CreateVolume(ctx, t.CallEp, req)\n\tdefer func() {\n\t\tif log.IsDebug() {\n\t\t\tlog.G(ctx).Debugf(\"CreateVolume_rsp:%+v\", utils.InterfaceToString(rsp))\n\t\t}\n\t}()\n\tif err != nil {\n\t\tlog.G(ctx).Errorf(\"CreateVolume fail:%+v\", err)\n\t\t//借用这个来limit重试\n\t\treturn ret.Errorf(errorcode.ErrorCode_ConnHostFailed, err.Error())\n\t}\n\n\tif rsp.GetRet().GetRetCode() != cubeleterrorcode.ErrorCode_Success &&\n\t\trsp.GetRet().GetRetCode() != cubeleterrorcode.ErrorCode_OK {\n\t\treturn ret.Errorf(errorcode.MasterCode(rsp.GetRet().GetRetCode()), rsp.GetRet().GetRetMsg())\n\t}\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 57,
        "code_end_line": 86,
        "code_key": "InstanceInfo",
        "code_value": "type InstanceInfo struct {\n\tgorm.Model\n\tAppID         int    `json:\"AppID\" gorm:\"column:app_id\"`\n\tUin           string `json:\"Uin\" gorm:\"column:uin\"`\n\tSubAccountUin string `json:\"SubAccountUin\" gorm:\"column:subaccount_uin\"`\n\tInsID         string `json:\"InstanceID\" gorm:\"column:ins_id\"` //cube InstanceID eks_xxx\n\tUUID          string `json:\"Uuid\" gorm:\"column:uuid\"`         //cube SandboxID\n\tHostIP        string `json:\"HostIP\" gorm:\"column:host_ip\"`    //裸金属IP\n\tHostID        string `json:\"HostId\" gorm:\"column:host_id\"`\n\tInstanceState string `json:\"InstanceState\" gorm:\"column:ins_state\"`\n\n\tCPU     int64  `json:\"Cpu\" gorm:\"column:cpu\"`          //核*100\n\tMem     int64  `json:\"Mem\" gorm:\"column:mem\"`          //Mi\n\tCPUType string `json:\"CpuType\" gorm:\"column:cpu_type\"` //机型架构\n\tZone    string `json:\"Zone\" gorm:\"column:zone\"`\n\tRegion  string `json:\"Region\" gorm:\"column:region\"`\n\n\tImageID            string `json:\"ImageID\" gorm:\"column:image_id\"`\n\tSystemDisk         string `json:\"SystemDisk\" gorm:\"column:system_disk\"`                  //object ref:SystemDisk\n\tDataDisks          string `json:\"DataDisks\" gorm:\"column:data_disks\"`                    //array object ref:DataDisk\n\tPrivateIPAddresses string `json:\"PrivateIpAddresses\" gorm:\"column:private_ip_addresses\"` //数组\n\tPrivateIP          string `json:\"PrivateIp\" gorm:\"column:private_ip\"`\n\tPrirvateIPCnt      int64  `json:\"PrivateIpCnt\" gorm:\"column:private_ip_cnt\"`\n\tSecurityGroupIDS   string `json:\"SecurityGroupIds\" gorm:\"column:security_ids\"` //数组\n\tVpcID              string `json:\"VpcId\" gorm:\"column:vpc_id\"`\n\tMacAddress         string `json:\"MacAddress\" gorm:\"column:mac_address\"`\n\tSubnetID           string `json:\"SubnetId\" gorm:\"column:subnet_id\"`\n\tDiskState          string `json:\"DiskState\" gorm:\"column:disk_state\"`\n\tFailMsg            string `json:\"FailMsg\" gorm:\"column:fail_msg\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 89,
        "code_end_line": 91,
        "code_key": "TableName",
        "code_value": "func (InstanceInfo) TableName() string {\n\treturn constants.InstanceInfoTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 94,
        "code_end_line": 98,
        "code_key": "InstanceUserData",
        "code_value": "type InstanceUserData struct {\n\tgorm.Model\n\tInsID    string `json:\"InsID\" gorm:\"column:ins_id\"`\n\tUserData string `json:\"UserData\" gorm:\"column:user_data\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 101,
        "code_end_line": 103,
        "code_key": "TableName",
        "code_value": "func (InstanceUserData) TableName() string {\n\treturn constants.InstanceUserDataTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/cube-proj__CubeMaster.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/instancecache/export.go:381:436:DeleteInstance",
    "orm_code": "func DeleteInstance(ctx context.Context, insID string) error {\n\tctx = context.WithoutCancel(ctx)\n\tstartTime := time.Now()\n\tretCode := 200\n\tvar err error\n\tdefer func() {\n\t\tif err != nil && !errors.Is(err, gorm.ErrRecordNotFound) {\n\t\t\tretCode = 500\n\t\t}\n\t\tlog.TraceReport(\"\", startTime, constants.MySQL, l.dbAddr, constants.ActionDBDelete, retCode)\n\t}()\n\n\tinsIDUpdate := fmt.Sprintf(\"%s = ?\", keyInsID)\n\tlog.G(ctx).Infof(\"DeleteInstance:%s,%s\", insIDUpdate, insID)\n\n\t// Use transaction to ensure atomicity\n\terr = l.DB().Transaction(func(tx *gorm.DB) error {\n\t\t// Delete instance info\n\t\tdb := tx.Table(constants.InstanceInfoTableName).Where(insIDUpdate, insID)\n\t\tvar deleteErr error\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tif config.GetConfig().Common.DisableHardDelete {\n\t\t\t\t// Soft delete (permanent delete will be handled by reconciliation)\n\t\t\t\tdeleteErr = db.Delete(&models.InstanceInfo{}).Error\n\t\t\t} else {\n\t\t\t\t// Hard delete\n\t\t\t\tdeleteErr = db.Unscoped().Delete(&models.InstanceInfo{}).Error\n\t\t\t}\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\n\t\t// Delete user data\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tdeleteErr = tx.Table(constants.InstanceUserDataTableName).Where(insIDUpdate, insID).\n\t\t\t\tDelete(&models.InstanceUserData{}).Error\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\t\treturn deleteErr\n\t})\n\n\treturn err\n}",
    "caller": "func (h *DeleteVolumeTaskHandler) HandleTask(ctx context.Context, t *Task) error {\n\treq, ok := t.Request.(*images.DestroyVolumeRequest)\n\tif !ok {\n\t\treturn nil\n\t}\n\n\trsp, err := cubelet.DeleteVolume(ctx, t.CallEp, req)\n\tdefer func() {\n\t\tif log.IsDebug() {\n\t\t\tlog.G(ctx).Debugf(\"DeleteVolume_rsp:%+v\", utils.InterfaceToString(rsp))\n\t\t}\n\t}()\n\tif err != nil {\n\t\tlog.G(ctx).Errorf(\"DeleteVolume fail:%+v\", err)\n\t\t//借用这个来limit重试\n\t\treturn ret.Errorf(errorcode.ErrorCode_ConnHostFailed, err.Error())\n\t}\n\tif rsp.GetRet().GetRetCode() != cubeleterrorcode.ErrorCode_Success &&\n\t\trsp.GetRet().GetRetCode() != cubeleterrorcode.ErrorCode_OK {\n\t\treturn ret.Errorf(errorcode.MasterCode(rsp.GetRet().GetRetCode()), rsp.GetRet().GetRetMsg())\n\t}\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 57,
        "code_end_line": 86,
        "code_key": "InstanceInfo",
        "code_value": "type InstanceInfo struct {\n\tgorm.Model\n\tAppID         int    `json:\"AppID\" gorm:\"column:app_id\"`\n\tUin           string `json:\"Uin\" gorm:\"column:uin\"`\n\tSubAccountUin string `json:\"SubAccountUin\" gorm:\"column:subaccount_uin\"`\n\tInsID         string `json:\"InstanceID\" gorm:\"column:ins_id\"` //cube InstanceID eks_xxx\n\tUUID          string `json:\"Uuid\" gorm:\"column:uuid\"`         //cube SandboxID\n\tHostIP        string `json:\"HostIP\" gorm:\"column:host_ip\"`    //裸金属IP\n\tHostID        string `json:\"HostId\" gorm:\"column:host_id\"`\n\tInstanceState string `json:\"InstanceState\" gorm:\"column:ins_state\"`\n\n\tCPU     int64  `json:\"Cpu\" gorm:\"column:cpu\"`          //核*100\n\tMem     int64  `json:\"Mem\" gorm:\"column:mem\"`          //Mi\n\tCPUType string `json:\"CpuType\" gorm:\"column:cpu_type\"` //机型架构\n\tZone    string `json:\"Zone\" gorm:\"column:zone\"`\n\tRegion  string `json:\"Region\" gorm:\"column:region\"`\n\n\tImageID            string `json:\"ImageID\" gorm:\"column:image_id\"`\n\tSystemDisk         string `json:\"SystemDisk\" gorm:\"column:system_disk\"`                  //object ref:SystemDisk\n\tDataDisks          string `json:\"DataDisks\" gorm:\"column:data_disks\"`                    //array object ref:DataDisk\n\tPrivateIPAddresses string `json:\"PrivateIpAddresses\" gorm:\"column:private_ip_addresses\"` //数组\n\tPrivateIP          string `json:\"PrivateIp\" gorm:\"column:private_ip\"`\n\tPrirvateIPCnt      int64  `json:\"PrivateIpCnt\" gorm:\"column:private_ip_cnt\"`\n\tSecurityGroupIDS   string `json:\"SecurityGroupIds\" gorm:\"column:security_ids\"` //数组\n\tVpcID              string `json:\"VpcId\" gorm:\"column:vpc_id\"`\n\tMacAddress         string `json:\"MacAddress\" gorm:\"column:mac_address\"`\n\tSubnetID           string `json:\"SubnetId\" gorm:\"column:subnet_id\"`\n\tDiskState          string `json:\"DiskState\" gorm:\"column:disk_state\"`\n\tFailMsg            string `json:\"FailMsg\" gorm:\"column:fail_msg\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 89,
        "code_end_line": 91,
        "code_key": "TableName",
        "code_value": "func (InstanceInfo) TableName() string {\n\treturn constants.InstanceInfoTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 94,
        "code_end_line": 98,
        "code_key": "InstanceUserData",
        "code_value": "type InstanceUserData struct {\n\tgorm.Model\n\tInsID    string `json:\"InsID\" gorm:\"column:ins_id\"`\n\tUserData string `json:\"UserData\" gorm:\"column:user_data\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 101,
        "code_end_line": 103,
        "code_key": "TableName",
        "code_value": "func (InstanceUserData) TableName() string {\n\treturn constants.InstanceUserDataTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/cube-proj__CubeMaster.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/instancecache/export.go:381:436:DeleteInstance",
    "orm_code": "func DeleteInstance(ctx context.Context, insID string) error {\n\tctx = context.WithoutCancel(ctx)\n\tstartTime := time.Now()\n\tretCode := 200\n\tvar err error\n\tdefer func() {\n\t\tif err != nil && !errors.Is(err, gorm.ErrRecordNotFound) {\n\t\t\tretCode = 500\n\t\t}\n\t\tlog.TraceReport(\"\", startTime, constants.MySQL, l.dbAddr, constants.ActionDBDelete, retCode)\n\t}()\n\n\tinsIDUpdate := fmt.Sprintf(\"%s = ?\", keyInsID)\n\tlog.G(ctx).Infof(\"DeleteInstance:%s,%s\", insIDUpdate, insID)\n\n\t// Use transaction to ensure atomicity\n\terr = l.DB().Transaction(func(tx *gorm.DB) error {\n\t\t// Delete instance info\n\t\tdb := tx.Table(constants.InstanceInfoTableName).Where(insIDUpdate, insID)\n\t\tvar deleteErr error\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tif config.GetConfig().Common.DisableHardDelete {\n\t\t\t\t// Soft delete (permanent delete will be handled by reconciliation)\n\t\t\t\tdeleteErr = db.Delete(&models.InstanceInfo{}).Error\n\t\t\t} else {\n\t\t\t\t// Hard delete\n\t\t\t\tdeleteErr = db.Unscoped().Delete(&models.InstanceInfo{}).Error\n\t\t\t}\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\n\t\t// Delete user data\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tdeleteErr = tx.Table(constants.InstanceUserDataTableName).Where(insIDUpdate, insID).\n\t\t\t\tDelete(&models.InstanceUserData{}).Error\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\t\treturn deleteErr\n\t})\n\n\treturn err\n}",
    "caller": "func (h *CreateImageTaskHandler) HandleTask(ctx context.Context, t *Task) error {\n\treq, ok := t.Request.(*images.CreateImageRequest)\n\tif !ok {\n\t\treturn nil\n\t}\n\n\trsp, err := cubelet.CreateImage(ctx, t.CallEp, req)\n\tdefer func() {\n\t\tif log.IsDebug() {\n\t\t\tlog.G(ctx).Debugf(\"CreateImage_rsp:%+v\", utils.InterfaceToString(rsp))\n\t\t}\n\t}()\n\tif err != nil {\n\t\tlog.G(ctx).Errorf(\"CreateImage fail:%+v\", err)\n\t\t//借用这个来limit重试\n\t\treturn ret.Errorf(errorcode.ErrorCode_ConnHostFailed, err.Error())\n\t}\n\tif rsp.GetRet().GetRetCode() != cubeleterrorcode.ErrorCode_Success &&\n\t\trsp.GetRet().GetRetCode() != cubeleterrorcode.ErrorCode_OK {\n\t\treturn ret.Errorf(errorcode.MasterCode(rsp.GetRet().GetRetCode()), rsp.GetRet().GetRetMsg())\n\t}\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 57,
        "code_end_line": 86,
        "code_key": "InstanceInfo",
        "code_value": "type InstanceInfo struct {\n\tgorm.Model\n\tAppID         int    `json:\"AppID\" gorm:\"column:app_id\"`\n\tUin           string `json:\"Uin\" gorm:\"column:uin\"`\n\tSubAccountUin string `json:\"SubAccountUin\" gorm:\"column:subaccount_uin\"`\n\tInsID         string `json:\"InstanceID\" gorm:\"column:ins_id\"` //cube InstanceID eks_xxx\n\tUUID          string `json:\"Uuid\" gorm:\"column:uuid\"`         //cube SandboxID\n\tHostIP        string `json:\"HostIP\" gorm:\"column:host_ip\"`    //裸金属IP\n\tHostID        string `json:\"HostId\" gorm:\"column:host_id\"`\n\tInstanceState string `json:\"InstanceState\" gorm:\"column:ins_state\"`\n\n\tCPU     int64  `json:\"Cpu\" gorm:\"column:cpu\"`          //核*100\n\tMem     int64  `json:\"Mem\" gorm:\"column:mem\"`          //Mi\n\tCPUType string `json:\"CpuType\" gorm:\"column:cpu_type\"` //机型架构\n\tZone    string `json:\"Zone\" gorm:\"column:zone\"`\n\tRegion  string `json:\"Region\" gorm:\"column:region\"`\n\n\tImageID            string `json:\"ImageID\" gorm:\"column:image_id\"`\n\tSystemDisk         string `json:\"SystemDisk\" gorm:\"column:system_disk\"`                  //object ref:SystemDisk\n\tDataDisks          string `json:\"DataDisks\" gorm:\"column:data_disks\"`                    //array object ref:DataDisk\n\tPrivateIPAddresses string `json:\"PrivateIpAddresses\" gorm:\"column:private_ip_addresses\"` //数组\n\tPrivateIP          string `json:\"PrivateIp\" gorm:\"column:private_ip\"`\n\tPrirvateIPCnt      int64  `json:\"PrivateIpCnt\" gorm:\"column:private_ip_cnt\"`\n\tSecurityGroupIDS   string `json:\"SecurityGroupIds\" gorm:\"column:security_ids\"` //数组\n\tVpcID              string `json:\"VpcId\" gorm:\"column:vpc_id\"`\n\tMacAddress         string `json:\"MacAddress\" gorm:\"column:mac_address\"`\n\tSubnetID           string `json:\"SubnetId\" gorm:\"column:subnet_id\"`\n\tDiskState          string `json:\"DiskState\" gorm:\"column:disk_state\"`\n\tFailMsg            string `json:\"FailMsg\" gorm:\"column:fail_msg\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 89,
        "code_end_line": 91,
        "code_key": "TableName",
        "code_value": "func (InstanceInfo) TableName() string {\n\treturn constants.InstanceInfoTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 94,
        "code_end_line": 98,
        "code_key": "InstanceUserData",
        "code_value": "type InstanceUserData struct {\n\tgorm.Model\n\tInsID    string `json:\"InsID\" gorm:\"column:ins_id\"`\n\tUserData string `json:\"UserData\" gorm:\"column:user_data\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 101,
        "code_end_line": 103,
        "code_key": "TableName",
        "code_value": "func (InstanceUserData) TableName() string {\n\treturn constants.InstanceUserDataTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/cube-proj__CubeMaster.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/instancecache/export.go:381:436:DeleteInstance",
    "orm_code": "func DeleteInstance(ctx context.Context, insID string) error {\n\tctx = context.WithoutCancel(ctx)\n\tstartTime := time.Now()\n\tretCode := 200\n\tvar err error\n\tdefer func() {\n\t\tif err != nil && !errors.Is(err, gorm.ErrRecordNotFound) {\n\t\t\tretCode = 500\n\t\t}\n\t\tlog.TraceReport(\"\", startTime, constants.MySQL, l.dbAddr, constants.ActionDBDelete, retCode)\n\t}()\n\n\tinsIDUpdate := fmt.Sprintf(\"%s = ?\", keyInsID)\n\tlog.G(ctx).Infof(\"DeleteInstance:%s,%s\", insIDUpdate, insID)\n\n\t// Use transaction to ensure atomicity\n\terr = l.DB().Transaction(func(tx *gorm.DB) error {\n\t\t// Delete instance info\n\t\tdb := tx.Table(constants.InstanceInfoTableName).Where(insIDUpdate, insID)\n\t\tvar deleteErr error\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tif config.GetConfig().Common.DisableHardDelete {\n\t\t\t\t// Soft delete (permanent delete will be handled by reconciliation)\n\t\t\t\tdeleteErr = db.Delete(&models.InstanceInfo{}).Error\n\t\t\t} else {\n\t\t\t\t// Hard delete\n\t\t\t\tdeleteErr = db.Unscoped().Delete(&models.InstanceInfo{}).Error\n\t\t\t}\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\n\t\t// Delete user data\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tdeleteErr = tx.Table(constants.InstanceUserDataTableName).Where(insIDUpdate, insID).\n\t\t\t\tDelete(&models.InstanceUserData{}).Error\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\t\treturn deleteErr\n\t})\n\n\treturn err\n}",
    "caller": "func (h *DeleteImageTaskHandler) HandleTask(ctx context.Context, t *Task) error {\n\treq, ok := t.Request.(*images.DestroyImageRequest)\n\tif !ok {\n\t\treturn nil\n\t}\n\n\trsp, err := cubelet.DeleteImage(ctx, t.CallEp, req)\n\tdefer func() {\n\t\tif log.IsDebug() {\n\t\t\tlog.G(ctx).Debugf(\"DeleteImage_rsp:%+v\", utils.InterfaceToString(rsp))\n\t\t}\n\t}()\n\tif err != nil {\n\t\tlog.G(ctx).Errorf(\"DeleteImage fail:%+v\", err)\n\t\t//借用这个来limit重试\n\t\treturn ret.Errorf(errorcode.ErrorCode_ConnHostFailed, err.Error())\n\t}\n\n\tif rsp.GetRet().GetRetCode() != cubeleterrorcode.ErrorCode_Success &&\n\t\trsp.GetRet().GetRetCode() != cubeleterrorcode.ErrorCode_OK {\n\t\treturn ret.Errorf(errorcode.MasterCode(rsp.GetRet().GetRetCode()), rsp.GetRet().GetRetMsg())\n\t}\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 57,
        "code_end_line": 86,
        "code_key": "InstanceInfo",
        "code_value": "type InstanceInfo struct {\n\tgorm.Model\n\tAppID         int    `json:\"AppID\" gorm:\"column:app_id\"`\n\tUin           string `json:\"Uin\" gorm:\"column:uin\"`\n\tSubAccountUin string `json:\"SubAccountUin\" gorm:\"column:subaccount_uin\"`\n\tInsID         string `json:\"InstanceID\" gorm:\"column:ins_id\"` //cube InstanceID eks_xxx\n\tUUID          string `json:\"Uuid\" gorm:\"column:uuid\"`         //cube SandboxID\n\tHostIP        string `json:\"HostIP\" gorm:\"column:host_ip\"`    //裸金属IP\n\tHostID        string `json:\"HostId\" gorm:\"column:host_id\"`\n\tInstanceState string `json:\"InstanceState\" gorm:\"column:ins_state\"`\n\n\tCPU     int64  `json:\"Cpu\" gorm:\"column:cpu\"`          //核*100\n\tMem     int64  `json:\"Mem\" gorm:\"column:mem\"`          //Mi\n\tCPUType string `json:\"CpuType\" gorm:\"column:cpu_type\"` //机型架构\n\tZone    string `json:\"Zone\" gorm:\"column:zone\"`\n\tRegion  string `json:\"Region\" gorm:\"column:region\"`\n\n\tImageID            string `json:\"ImageID\" gorm:\"column:image_id\"`\n\tSystemDisk         string `json:\"SystemDisk\" gorm:\"column:system_disk\"`                  //object ref:SystemDisk\n\tDataDisks          string `json:\"DataDisks\" gorm:\"column:data_disks\"`                    //array object ref:DataDisk\n\tPrivateIPAddresses string `json:\"PrivateIpAddresses\" gorm:\"column:private_ip_addresses\"` //数组\n\tPrivateIP          string `json:\"PrivateIp\" gorm:\"column:private_ip\"`\n\tPrirvateIPCnt      int64  `json:\"PrivateIpCnt\" gorm:\"column:private_ip_cnt\"`\n\tSecurityGroupIDS   string `json:\"SecurityGroupIds\" gorm:\"column:security_ids\"` //数组\n\tVpcID              string `json:\"VpcId\" gorm:\"column:vpc_id\"`\n\tMacAddress         string `json:\"MacAddress\" gorm:\"column:mac_address\"`\n\tSubnetID           string `json:\"SubnetId\" gorm:\"column:subnet_id\"`\n\tDiskState          string `json:\"DiskState\" gorm:\"column:disk_state\"`\n\tFailMsg            string `json:\"FailMsg\" gorm:\"column:fail_msg\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 89,
        "code_end_line": 91,
        "code_key": "TableName",
        "code_value": "func (InstanceInfo) TableName() string {\n\treturn constants.InstanceInfoTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 94,
        "code_end_line": 98,
        "code_key": "InstanceUserData",
        "code_value": "type InstanceUserData struct {\n\tgorm.Model\n\tInsID    string `json:\"InsID\" gorm:\"column:ins_id\"`\n\tUserData string `json:\"UserData\" gorm:\"column:user_data\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 101,
        "code_end_line": 103,
        "code_key": "TableName",
        "code_value": "func (InstanceUserData) TableName() string {\n\treturn constants.InstanceUserDataTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/cube-proj__CubeMaster.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/instancecache/export.go:381:436:DeleteInstance",
    "orm_code": "func DeleteInstance(ctx context.Context, insID string) error {\n\tctx = context.WithoutCancel(ctx)\n\tstartTime := time.Now()\n\tretCode := 200\n\tvar err error\n\tdefer func() {\n\t\tif err != nil && !errors.Is(err, gorm.ErrRecordNotFound) {\n\t\t\tretCode = 500\n\t\t}\n\t\tlog.TraceReport(\"\", startTime, constants.MySQL, l.dbAddr, constants.ActionDBDelete, retCode)\n\t}()\n\n\tinsIDUpdate := fmt.Sprintf(\"%s = ?\", keyInsID)\n\tlog.G(ctx).Infof(\"DeleteInstance:%s,%s\", insIDUpdate, insID)\n\n\t// Use transaction to ensure atomicity\n\terr = l.DB().Transaction(func(tx *gorm.DB) error {\n\t\t// Delete instance info\n\t\tdb := tx.Table(constants.InstanceInfoTableName).Where(insIDUpdate, insID)\n\t\tvar deleteErr error\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tif config.GetConfig().Common.DisableHardDelete {\n\t\t\t\t// Soft delete (permanent delete will be handled by reconciliation)\n\t\t\t\tdeleteErr = db.Delete(&models.InstanceInfo{}).Error\n\t\t\t} else {\n\t\t\t\t// Hard delete\n\t\t\t\tdeleteErr = db.Unscoped().Delete(&models.InstanceInfo{}).Error\n\t\t\t}\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\n\t\t// Delete user data\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tdeleteErr = tx.Table(constants.InstanceUserDataTableName).Where(insIDUpdate, insID).\n\t\t\t\tDelete(&models.InstanceUserData{}).Error\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\t\treturn deleteErr\n\t})\n\n\treturn err\n}",
    "caller": "func (h *UpdateSandboxTaskHandler) HandleTask(ctx context.Context, t *Task) error {\n\treq, ok := t.Request.(*cubebox.UpdateCubeSandboxRequest)\n\tif !ok {\n\t\treturn nil\n\t}\n\t//检查实例状态\n\tins, err := instancecache.GetInstandesByInsID(ctx, t.InstanceID)\n\tif err != nil {\n\t\tif err == instancecache.ErrorKeyNotFound {\n\t\t\treturn ret.Errorf(errorcode.ErrorCode_NotFund, err.Error())\n\t\t}\n\t\treturn ret.Errorf(errorcode.ErrorCode_ConnHostFailed, err.Error())\n\t}\n\t//如果非running异步任务里继续检查实例状态是否合法\n\tif ins.InstanceState == constants.YUNAPIInstanceStatePending {\n\t\t//借用这个来loop重试，等待实例ready\n\t\treturn ret.Errorf(errorcode.ErrorCode_MasterRateLimitedError, \"InstanceState is valid:[%s]\", ins.InstanceState)\n\t}\n\n\tif ins.InstanceState != constants.YUNAPIInstanceStatePending &&\n\t\tins.InstanceState != constants.YUNAPIInstanceStateRunning {\n\t\treturn ret.Errorf(errorcode.ErrorCode_Unknown, \"InstanceState is valid,[%s]\", ins.FailMsg)\n\t}\n\n\trsp, err := cubelet.Update(ctx, t.CallEp, req)\n\tdefer func() {\n\t\tif log.IsDebug() {\n\t\t\tlog.G(ctx).Debugf(\"Update_rsp:%+v\", utils.InterfaceToString(rsp))\n\t\t}\n\t}()\n\tif err != nil {\n\t\tlog.G(ctx).Errorf(\"Update fail:%+v\", err)\n\t\t//借用这个来limit重试\n\t\treturn ret.Errorf(errorcode.ErrorCode_ConnHostFailed, err.Error())\n\t}\n\n\tif rsp.GetRet().GetRetCode() != cubeleterrorcode.ErrorCode_Success &&\n\t\trsp.GetRet().GetRetCode() != cubeleterrorcode.ErrorCode_OK {\n\t\treturn ret.Errorf(errorcode.MasterCode(rsp.GetRet().GetRetCode()), rsp.GetRet().GetRetMsg())\n\t}\n\treturn nil\n}",
    "sql_statement_list": [],
    "sql_types": [],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 57,
        "code_end_line": 86,
        "code_key": "InstanceInfo",
        "code_value": "type InstanceInfo struct {\n\tgorm.Model\n\tAppID         int    `json:\"AppID\" gorm:\"column:app_id\"`\n\tUin           string `json:\"Uin\" gorm:\"column:uin\"`\n\tSubAccountUin string `json:\"SubAccountUin\" gorm:\"column:subaccount_uin\"`\n\tInsID         string `json:\"InstanceID\" gorm:\"column:ins_id\"` //cube InstanceID eks_xxx\n\tUUID          string `json:\"Uuid\" gorm:\"column:uuid\"`         //cube SandboxID\n\tHostIP        string `json:\"HostIP\" gorm:\"column:host_ip\"`    //裸金属IP\n\tHostID        string `json:\"HostId\" gorm:\"column:host_id\"`\n\tInstanceState string `json:\"InstanceState\" gorm:\"column:ins_state\"`\n\n\tCPU     int64  `json:\"Cpu\" gorm:\"column:cpu\"`          //核*100\n\tMem     int64  `json:\"Mem\" gorm:\"column:mem\"`          //Mi\n\tCPUType string `json:\"CpuType\" gorm:\"column:cpu_type\"` //机型架构\n\tZone    string `json:\"Zone\" gorm:\"column:zone\"`\n\tRegion  string `json:\"Region\" gorm:\"column:region\"`\n\n\tImageID            string `json:\"ImageID\" gorm:\"column:image_id\"`\n\tSystemDisk         string `json:\"SystemDisk\" gorm:\"column:system_disk\"`                  //object ref:SystemDisk\n\tDataDisks          string `json:\"DataDisks\" gorm:\"column:data_disks\"`                    //array object ref:DataDisk\n\tPrivateIPAddresses string `json:\"PrivateIpAddresses\" gorm:\"column:private_ip_addresses\"` //数组\n\tPrivateIP          string `json:\"PrivateIp\" gorm:\"column:private_ip\"`\n\tPrirvateIPCnt      int64  `json:\"PrivateIpCnt\" gorm:\"column:private_ip_cnt\"`\n\tSecurityGroupIDS   string `json:\"SecurityGroupIds\" gorm:\"column:security_ids\"` //数组\n\tVpcID              string `json:\"VpcId\" gorm:\"column:vpc_id\"`\n\tMacAddress         string `json:\"MacAddress\" gorm:\"column:mac_address\"`\n\tSubnetID           string `json:\"SubnetId\" gorm:\"column:subnet_id\"`\n\tDiskState          string `json:\"DiskState\" gorm:\"column:disk_state\"`\n\tFailMsg            string `json:\"FailMsg\" gorm:\"column:fail_msg\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 89,
        "code_end_line": 91,
        "code_key": "TableName",
        "code_value": "func (InstanceInfo) TableName() string {\n\treturn constants.InstanceInfoTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 94,
        "code_end_line": 98,
        "code_key": "InstanceUserData",
        "code_value": "type InstanceUserData struct {\n\tgorm.Model\n\tInsID    string `json:\"InsID\" gorm:\"column:ins_id\"`\n\tUserData string `json:\"UserData\" gorm:\"column:user_data\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 101,
        "code_end_line": 103,
        "code_key": "TableName",
        "code_value": "func (InstanceUserData) TableName() string {\n\treturn constants.InstanceUserDataTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/cube-proj__CubeMaster.json",
    "matched_keywords": [
      "Transaction"
    ]
  },
  {
    "function_name": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/instancecache/export.go:381:436:DeleteInstance",
    "orm_code": "func DeleteInstance(ctx context.Context, insID string) error {\n\tctx = context.WithoutCancel(ctx)\n\tstartTime := time.Now()\n\tretCode := 200\n\tvar err error\n\tdefer func() {\n\t\tif err != nil && !errors.Is(err, gorm.ErrRecordNotFound) {\n\t\t\tretCode = 500\n\t\t}\n\t\tlog.TraceReport(\"\", startTime, constants.MySQL, l.dbAddr, constants.ActionDBDelete, retCode)\n\t}()\n\n\tinsIDUpdate := fmt.Sprintf(\"%s = ?\", keyInsID)\n\tlog.G(ctx).Infof(\"DeleteInstance:%s,%s\", insIDUpdate, insID)\n\n\t// Use transaction to ensure atomicity\n\terr = l.DB().Transaction(func(tx *gorm.DB) error {\n\t\t// Delete instance info\n\t\tdb := tx.Table(constants.InstanceInfoTableName).Where(insIDUpdate, insID)\n\t\tvar deleteErr error\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tif config.GetConfig().Common.DisableHardDelete {\n\t\t\t\t// Soft delete (permanent delete will be handled by reconciliation)\n\t\t\t\tdeleteErr = db.Delete(&models.InstanceInfo{}).Error\n\t\t\t} else {\n\t\t\t\t// Hard delete\n\t\t\t\tdeleteErr = db.Unscoped().Delete(&models.InstanceInfo{}).Error\n\t\t\t}\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\n\t\t// Delete user data\n\t\tfor range config.GetConfig().Common.DbMaxRetryCount {\n\t\t\tdeleteErr = tx.Table(constants.InstanceUserDataTableName).Where(insIDUpdate, insID).\n\t\t\t\tDelete(&models.InstanceUserData{}).Error\n\t\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\t\ttime.Sleep(config.GetConfig().Common.DbRetryInterval)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tbreak\n\t\t}\n\t\tif deleteErr != nil && !errors.Is(deleteErr, gorm.ErrRecordNotFound) {\n\t\t\treturn deleteErr\n\t\t}\n\t\treturn deleteErr\n\t})\n\n\treturn err\n}",
    "caller": "func failoverTerminateInstance(ctx context.Context, request *yunapitypes.RunInstancesRequest, rsp *types.CreateCubeSandboxRes) error {\n\tinsID := request.InstanceIDS[0]\n\n\t//just remove record after run instance fail\n\tif err := instancecache.DeleteInstance(ctx, insID); err != nil {\n\t\treturn err\n\t}\n\tif err := localcache.DeleteInstanceInfoMap(ctx, insID); err != nil {\n\t\treturn err\n\t}\n\tif rsp.SandboxID == \"\" && rsp.HostIP == \"\" {\n\t\treturn nil\n\t}\n\n\t//cubelet 已经生产实例出来，但是master这里处理失败了(比如持久化db的时候失败)，需要把cubelet 的实例删除掉\n\treq := &types.DeleteCubeSandboxReq{\n\t\tRequestID:    request.RequestId,\n\t\tSandboxID:    rsp.SandboxID,\n\t\tHostIP:       rsp.HostIP,\n\t\tInstanceType: cubebox.InstanceType_eks.String(),\n\t\tAnnotations:  make(map[string]string),\n\t\tFilter: &types.CubeSandboxFilter{\n\t\t\tLabelSelector: map[string]string{constants.CubeAnnotationsInsID: insID},\n\t\t},\n\t}\n\n\treq.Annotations[constants.CubeAnnotationsAPPID] = strconv.Itoa(request.AppID)\n\treq.Annotations[constants.CubeAnnotationsOwnerUIN] = request.Uin\n\tif request.SubAccountUin != \"\" {\n\t\treq.Annotations[constants.CubeAnnotationsSubUIN] = request.SubAccountUin\n\t}\n\tif request.Region != \"\" {\n\t\treq.Annotations[constants.CubeAnnotationsInsRegion] = request.Region\n\t}\n\n\tn, exist := localcache.GetNodesByIp(rsp.HostIP)\n\tif !exist {\n\t\tlog.G(ctx).Warnf(\"node %s not found in cache when detaching disk of instance %s\", rsp.HostIP, insID)\n\t\treturn nil\n\t}\n\t// for cbs detach if needed\n\treq.Annotations[constants.CubeAnnotationsInsHostUUID] = n.UUID\n\treq.Annotations[constants.CubeAnnotationsInsHostIP] = n.MachineHostIP\n\treq.Annotations[constants.CubeAnnotationsInsHostCpuTotal] = strconv.Itoa(n.CpuTotal * 100)\n\treq.Annotations[constants.CubeAnnotationsInsHostVirtualQuotaArray] = utils.InterfaceToString(n.VirtualNodeQuotaArray)\n\tctx = constants.WithHostIP(ctx, rsp.HostIP)\n\tctx = constants.WithPodID(ctx, rsp.SandboxID)\n\tcubeRsp := sandbox.DestroySandbox(ctx, req)\n\tif cubeRsp.Ret.RetCode != int(errorcode.ErrorCode_Success) {\n\t\treturn fmt.Errorf(\"failoverTerminateInstance [%s.%s] fail:%+v\", rsp.SandboxID, insID, cubeRsp.Ret)\n\t}\n\treturn nil\n}",
    "sql_statement_list": [
      {
        "type": "param_dependent",
        "variants": [
          {
            "scenario": "软删除模式 - 删除InstanceInfo记录",
            "sql": "UPDATE `instance_info_table` SET `deleted_at`=? WHERE ins_id = ? AND `instance_info_table`.`deleted_at` IS NULL;"
          },
          {
            "scenario": "硬删除模式 - 删除InstanceInfo记录",
            "sql": "DELETE FROM `instance_info_table` WHERE ins_id = ?;"
          }
        ]
      },
      "DELETE FROM `instance_user_data_table` WHERE ins_id = ?;"
    ],
    "sql_types": [
      "PARAM_DEPENDENT",
      "DELETE"
    ],
    "code_meta_data": [
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 57,
        "code_end_line": 86,
        "code_key": "InstanceInfo",
        "code_value": "type InstanceInfo struct {\n\tgorm.Model\n\tAppID         int    `json:\"AppID\" gorm:\"column:app_id\"`\n\tUin           string `json:\"Uin\" gorm:\"column:uin\"`\n\tSubAccountUin string `json:\"SubAccountUin\" gorm:\"column:subaccount_uin\"`\n\tInsID         string `json:\"InstanceID\" gorm:\"column:ins_id\"` //cube InstanceID eks_xxx\n\tUUID          string `json:\"Uuid\" gorm:\"column:uuid\"`         //cube SandboxID\n\tHostIP        string `json:\"HostIP\" gorm:\"column:host_ip\"`    //裸金属IP\n\tHostID        string `json:\"HostId\" gorm:\"column:host_id\"`\n\tInstanceState string `json:\"InstanceState\" gorm:\"column:ins_state\"`\n\n\tCPU     int64  `json:\"Cpu\" gorm:\"column:cpu\"`          //核*100\n\tMem     int64  `json:\"Mem\" gorm:\"column:mem\"`          //Mi\n\tCPUType string `json:\"CpuType\" gorm:\"column:cpu_type\"` //机型架构\n\tZone    string `json:\"Zone\" gorm:\"column:zone\"`\n\tRegion  string `json:\"Region\" gorm:\"column:region\"`\n\n\tImageID            string `json:\"ImageID\" gorm:\"column:image_id\"`\n\tSystemDisk         string `json:\"SystemDisk\" gorm:\"column:system_disk\"`                  //object ref:SystemDisk\n\tDataDisks          string `json:\"DataDisks\" gorm:\"column:data_disks\"`                    //array object ref:DataDisk\n\tPrivateIPAddresses string `json:\"PrivateIpAddresses\" gorm:\"column:private_ip_addresses\"` //数组\n\tPrivateIP          string `json:\"PrivateIp\" gorm:\"column:private_ip\"`\n\tPrirvateIPCnt      int64  `json:\"PrivateIpCnt\" gorm:\"column:private_ip_cnt\"`\n\tSecurityGroupIDS   string `json:\"SecurityGroupIds\" gorm:\"column:security_ids\"` //数组\n\tVpcID              string `json:\"VpcId\" gorm:\"column:vpc_id\"`\n\tMacAddress         string `json:\"MacAddress\" gorm:\"column:mac_address\"`\n\tSubnetID           string `json:\"SubnetId\" gorm:\"column:subnet_id\"`\n\tDiskState          string `json:\"DiskState\" gorm:\"column:disk_state\"`\n\tFailMsg            string `json:\"FailMsg\" gorm:\"column:fail_msg\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 89,
        "code_end_line": 91,
        "code_key": "TableName",
        "code_value": "func (InstanceInfo) TableName() string {\n\treturn constants.InstanceInfoTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 94,
        "code_end_line": 98,
        "code_key": "InstanceUserData",
        "code_value": "type InstanceUserData struct {\n\tgorm.Model\n\tInsID    string `json:\"InsID\" gorm:\"column:ins_id\"`\n\tUserData string `json:\"UserData\" gorm:\"column:user_data\"`\n}",
        "code_label": 3,
        "code_type": 3,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      },
      {
        "code_file": "/Users/ymhuan/code/git-development/aid-main/aid/risk_sql/code/scripts/cube-proj__CubeMaster/pkg/base/db/models/hostinfo.go",
        "code_start_line": 101,
        "code_end_line": 103,
        "code_key": "TableName",
        "code_value": "func (InstanceUserData) TableName() string {\n\treturn constants.InstanceUserDataTableName\n}",
        "code_label": null,
        "code_type": 2,
        "code_version": "b357d82b81254b6b48956ef7c78da213794ec3ea"
      }
    ],
    "sql_pattern_cnt": 4,
    "source_file": "/data/shawn/venus_api/orm2sql/gorm_orm_code/cube-proj__CubeMaster.json",
    "matched_keywords": [
      "Transaction"
    ]
  }
]